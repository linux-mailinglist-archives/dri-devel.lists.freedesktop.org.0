Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id DE9A2105CB
	for <lists+dri-devel@lfdr.de>; Wed,  1 May 2019 09:19:16 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id CD1118936B;
	Wed,  1 May 2019 07:19:08 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from bhuna.collabora.co.uk (bhuna.collabora.co.uk
 [IPv6:2a00:1098:0:82:1000:25:2eeb:e3e3])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A618D8915B
 for <dri-devel@lists.freedesktop.org>; Tue, 30 Apr 2019 18:05:44 +0000 (UTC)
Received: from [127.0.0.1] (localhost [127.0.0.1])
 (Authenticated sender: gportay) with ESMTPSA id D746728335F
From: =?UTF-8?q?Ga=C3=ABl=20PORTAY?= <gael.portay@collabora.com>
To: Rob Herring <robh+dt@kernel.org>, Mark Rutland <mark.rutland@arm.com>,
 Heiko Stuebner <heiko@sntech.de>,
 Michael Turquette <mturquette@baylibre.com>,
 Stephen Boyd <sboyd@kernel.org>, MyungJoo Ham <myungjoo.ham@samsung.com>,
 Kyungmin Park <kyungmin.park@samsung.com>,
 Chanwoo Choi <cw00.choi@samsung.com>, Sandy Huang <hjc@rock-chips.com>,
 David Airlie <airlied@linux.ie>, Daniel Vetter <daniel@ffwll.ch>,
 =?UTF-8?q?Ga=C3=ABl=20PORTAY?= <gael.portay@collabora.com>,
 devicetree@vger.kernel.org, linux-arm-kernel@lists.infradead.org,
 linux-rockchip@lists.infradead.org, linux-kernel@vger.kernel.org,
 linux-clk@vger.kernel.org, linux-pm@vger.kernel.org,
 dri-devel@lists.freedesktop.org
Subject: [RFC 2/4] drm: rockchip: Add DDR devfreq support.
Date: Tue, 30 Apr 2019 14:05:22 -0400
Message-Id: <20190430180524.22710-3-gael.portay@collabora.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190430180524.22710-1-gael.portay@collabora.com>
References: <20190430180524.22710-1-gael.portay@collabora.com>
MIME-Version: 1.0
X-Mailman-Approved-At: Wed, 01 May 2019 07:18:43 +0000
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Lin Huang <hl@rock-chips.com>, Derek Basehore <dbasehore@chromium.org>,
 Douglas Anderson <dianders@chromium.org>, Matthias Kaehlcke <mka@chromium.org>,
 Boris Brezillon <boris.brezillon@collabora.com>,
 Enric Balletbo i Serra <enric.balletbo@collabora.com>, kernel@collabora.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBjb21taXQgYWRkcyB0aGUgc3VwcG9ydCBmb3IgZGV2ZnJlcSB0byBjb250cm9sIHRoZSBE
RFIgZnJlcXVlbmN5CmR5bmFtaWNhbGx5LgoKR2xpdGNoZXMgYWZmZWN0IHRoZSBkaXNwbGF5IHdo
ZW4gdGhlIERNQyBkZXZmcmVxIGRldmljZSBjaGFuZ2VzIHRoZSBERFIKZnJlcXVlbmN5IGR1cmlu
ZyB0aGUgc2Nhbm91dC4gVGhlIERSTSBkcml2ZXIgc3luY2hyb25pemVzIHRoZSByYXRlCmNoYW5n
ZSB3aXRoaW4gdGhlIFZCTEFOSy4KClRoZSBWT1AgbG9ja3MgdGhlIERNQyBkZXZmcmVxIGRldmlj
ZSB0aGF0IGNhdXNlcyBpdCB0byBub3RpZmllZCB3aGVuIGEKcmF0ZSBjaGFuZ2UgaXMgd2FudGVk
LiBUaGVuLCB0aGUgVk9QIGVuYWJsZXMgdGhlIFZCTEFOSyBpbnRlcnJ1cHQsCnJlbGVhc2VzIHRo
ZSBsb2NrIHdoZW4gdGhlIGludGVycnVwdCBhcmlzZXMgYW5kIGxvY2tzIHRoZSBkZXZmcmVxIGRl
dmljZQphZ2FpbiBhZnRlciB0aGUgdmJsYW5rIHB1bHNlIGVuZHMgdXNpbmcgYSB0aW1lci4KClRo
ZSBEUk0gZHJpdmVyIGRpc2FibGVzIHRoZSBkZXZmcmVxIGRldmljZSBpZiBtb3JlIHRoYW4gb25l
IENSVEMgYmVjb21lcwphY3RpdmUuCgpTaWduZWQtb2ZmLWJ5OiBHYcOrbCBQT1JUQVkgPGdhZWwu
cG9ydGF5QGNvbGxhYm9yYS5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL3JvY2tjaGlwL3JvY2tj
aGlwX2RybV9kcnYuYyB8ICA1MSArKysrKy0KIGRyaXZlcnMvZ3B1L2RybS9yb2NrY2hpcC9yb2Nr
Y2hpcF9kcm1fZHJ2LmggfCAgIDYgKwogZHJpdmVycy9ncHUvZHJtL3JvY2tjaGlwL3JvY2tjaGlw
X2RybV9mYi5jICB8IDE3NyArKysrKysrKysrKysrKysrKysrLQogZHJpdmVycy9ncHUvZHJtL3Jv
Y2tjaGlwL3JvY2tjaGlwX2RybV9mYi5oICB8ICAgMyArLQogZHJpdmVycy9ncHUvZHJtL3JvY2tj
aGlwL3JvY2tjaGlwX2RybV92b3AuYyB8ICA4MiArKysrKysrKysKIDUgZmlsZXMgY2hhbmdlZCwg
MzE1IGluc2VydGlvbnMoKyksIDQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL3JvY2tjaGlwL3JvY2tjaGlwX2RybV9kcnYuYyBiL2RyaXZlcnMvZ3B1L2RybS9yb2Nr
Y2hpcC9yb2NrY2hpcF9kcm1fZHJ2LmMKaW5kZXggZDdmYTE3ZjEyNzY5Li5lZjg0MzU2OGE3Zjgg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fZHJ2LmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL3JvY2tjaGlwL3JvY2tjaGlwX2RybV9kcnYuYwpAQCAtMTks
NiArMTksOCBAQAogI2luY2x1ZGUgPGRybS9kcm1fZ2VtX2NtYV9oZWxwZXIuaD4KICNpbmNsdWRl
IDxkcm0vZHJtX29mLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9wcm9iZV9oZWxwZXIuaD4KKyNpbmNs
dWRlIDxsaW51eC9kZXZmcmVxLmg+CisjaW5jbHVkZSA8bGludXgvZGV2ZnJlcS1ldmVudC5oPgog
I2luY2x1ZGUgPGxpbnV4L2RtYS1tYXBwaW5nLmg+CiAjaW5jbHVkZSA8bGludXgvZG1hLWlvbW11
Lmg+CiAjaW5jbHVkZSA8bGludXgvcG1fcnVudGltZS5oPgpAQCAtNzgsNiArODAsNDYgQEAgdm9p
ZCByb2NrY2hpcF9kcm1fZG1hX2RldGFjaF9kZXZpY2Uoc3RydWN0IGRybV9kZXZpY2UgKmRybV9k
ZXYsCiAJaW9tbXVfZGV0YWNoX2RldmljZShkb21haW4sIGRldik7CiB9CiAKKyNpZiBJU19FTkFC
TEVEKENPTkZJR19BUk1fUkszMzk5X0RNQ19ERVZGUkVRKQorc3RhdGljIGludCByb2NrY2hpcF9k
cm1faW5pdF9kZXZmcmVxKHN0cnVjdCBkZXZpY2UgKmRldiwKKwkJCQkgICAgIHN0cnVjdCByb2Nr
Y2hpcF9kcm1fcHJpdmF0ZSAqcHJpdikKK3sKKwlzdHJ1Y3QgZGV2ZnJlcSAqZGV2ZnJlcTsKKwlz
dHJ1Y3QgZGV2ZnJlcV9ldmVudF9kZXYgKmVkZXY7CisJaW50IHJldDsKKworCWRldmZyZXEgPSBk
ZXZmcmVxX2dldF9kZXZmcmVxX2J5X3BoYW5kbGUoZGV2LCAwKTsKKwlpZiAoSVNfRVJSKGRldmZy
ZXEpKSB7CisJCXJldCA9IFBUUl9FUlIoZGV2ZnJlcSk7CisJCWlmIChyZXQgPT0gLUVOT0RFVikg
eworCQkJRFJNX0RFVl9JTkZPKGRldiwgImRldmZyZXEgbWlzc2luZywgc2tpcFxuIik7CisJCQly
ZXR1cm4gMDsKKwkJfQorCQlyZXR1cm4gcmV0OworCX0KKworCWVkZXYgPSBkZXZmcmVxX2V2ZW50
X2dldF9lZGV2X2J5X3BoYW5kbGUoZGV2ZnJlcS0+ZGV2LnBhcmVudCwgMCk7CisJaWYgKElTX0VS
UihlZGV2KSkgeworCQlyZXQgPSBQVFJfRVJSKGVkZXYpOworCQlpZiAocmV0ID09IC1FTk9ERVYp
IHsKKwkJCURSTV9ERVZfSU5GTyhkZXYsICJkZXZmcmVxIGVkZXYgbWlzc2luZywgc2tpcFxuIik7
CisJCQlyZXR1cm4gMDsKKwkJfQorCQlyZXR1cm4gcmV0OworCX0KKworCXByaXYtPmRldmZyZXEg
PSBkZXZmcmVxOworCXByaXYtPmRldmZyZXFfZXZlbnRfZGV2ID0gZWRldjsKKwlyZXR1cm4gMDsK
K30KKyNlbHNlCitzdGF0aWMgaW50IHJvY2tjaGlwX2RybV9pbml0X2RldmZyZXEoc3RydWN0IGRl
dmljZSAqZGV2LAorCQkJCSAgICAgc3RydWN0IHJvY2tjaGlwX2RybV9wcml2YXRlICpwcml2KQor
eworCXJldHVybiAwOworfQorI2VuZGlmCisKIHN0YXRpYyBpbnQgcm9ja2NoaXBfZHJtX2luaXRf
aW9tbXUoc3RydWN0IGRybV9kZXZpY2UgKmRybV9kZXYpCiB7CiAJc3RydWN0IHJvY2tjaGlwX2Ry
bV9wcml2YXRlICpwcml2YXRlID0gZHJtX2Rldi0+ZGV2X3ByaXZhdGU7CkBAIC0xMzcsMTMgKzE3
OSwxOSBAQCBzdGF0aWMgaW50IHJvY2tjaGlwX2RybV9iaW5kKHN0cnVjdCBkZXZpY2UgKmRldikK
IAlJTklUX0xJU1RfSEVBRCgmcHJpdmF0ZS0+cHNyX2xpc3QpOwogCW11dGV4X2luaXQoJnByaXZh
dGUtPnBzcl9saXN0X2xvY2spOwogCisJcmV0ID0gcm9ja2NoaXBfZHJtX2luaXRfZGV2ZnJlcShk
ZXYsIHByaXZhdGUpOworCWlmIChyZXQpCisJCWdvdG8gZXJyX2ZyZWU7CisKIAlyZXQgPSByb2Nr
Y2hpcF9kcm1faW5pdF9pb21tdShkcm1fZGV2KTsKIAlpZiAocmV0KQogCQlnb3RvIGVycl9mcmVl
OwogCiAJZHJtX21vZGVfY29uZmlnX2luaXQoZHJtX2Rldik7CiAKLQlyb2NrY2hpcF9kcm1fbW9k
ZV9jb25maWdfaW5pdChkcm1fZGV2KTsKKwlyZXQgPSByb2NrY2hpcF9kcm1fbW9kZV9jb25maWdf
aW5pdChkcm1fZGV2KTsKKwlpZiAocmV0KQorCQlnb3RvIGVycl9mcmVlOwogCiAJLyogVHJ5IHRv
IGJpbmQgYWxsIHN1YiBkcml2ZXJzLiAqLwogCXJldCA9IGNvbXBvbmVudF9iaW5kX2FsbChkZXYs
IGRybV9kZXYpOwpAQCAtMjAxLDYgKzI0OSw3IEBAIHN0YXRpYyB2b2lkIHJvY2tjaGlwX2RybV91
bmJpbmQoc3RydWN0IGRldmljZSAqZGV2KQogCWRybV9hdG9taWNfaGVscGVyX3NodXRkb3duKGRy
bV9kZXYpOwogCWNvbXBvbmVudF91bmJpbmRfYWxsKGRldiwgZHJtX2Rldik7CiAJZHJtX21vZGVf
Y29uZmlnX2NsZWFudXAoZHJtX2Rldik7CisJcm9ja2NoaXBfZHJtX21vZGVfY29uZmlnX2Zpbmko
ZHJtX2Rldik7CiAJcm9ja2NoaXBfaW9tbXVfY2xlYW51cChkcm1fZGV2KTsKIAogCWRybV9kZXYt
PmRldl9wcml2YXRlID0gTlVMTDsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9yb2NrY2hp
cC9yb2NrY2hpcF9kcm1fZHJ2LmggYi9kcml2ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBf
ZHJtX2Rydi5oCmluZGV4IGNlNDg1NjhlYzhhMC4uMGFjN2UzMWI1NjA1IDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBfZHJtX2Rydi5oCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fZHJ2LmgKQEAgLTE4LDYgKzE4LDcgQEAKICNk
ZWZpbmUgX1JPQ0tDSElQX0RSTV9EUlZfSAogCiAjaW5jbHVkZSA8ZHJtL2RybV9mYl9oZWxwZXIu
aD4KKyNpbmNsdWRlIDxkcm0vZHJtX2F0b21pYy5oPgogI2luY2x1ZGUgPGRybS9kcm1fYXRvbWlj
X2hlbHBlci5oPgogI2luY2x1ZGUgPGRybS9kcm1fZ2VtLmg+CiAKQEAgLTU3LDYgKzU4LDEwIEBA
IHN0cnVjdCByb2NrY2hpcF9kcm1fcHJpdmF0ZSB7CiAJc3RydWN0IGRybV9tbSBtbTsKIAlzdHJ1
Y3QgbGlzdF9oZWFkIHBzcl9saXN0OwogCXN0cnVjdCBtdXRleCBwc3JfbGlzdF9sb2NrOworCisJ
c3RydWN0IGRldmZyZXEgKmRldmZyZXE7CisJc3RydWN0IGRldmZyZXFfZXZlbnRfZGV2ICpkZXZm
cmVxX2V2ZW50X2RldjsKKwlzdHJ1Y3QgZHJtX3ByaXZhdGVfb2JqIGRkcmZyZXFfbG9ja19tYW5h
Z2VyOwogfTsKIAogaW50IHJvY2tjaGlwX2RybV9kbWFfYXR0YWNoX2RldmljZShzdHJ1Y3QgZHJt
X2RldmljZSAqZHJtX2RldiwKQEAgLTY2LDYgKzcxLDcgQEAgdm9pZCByb2NrY2hpcF9kcm1fZG1h
X2RldGFjaF9kZXZpY2Uoc3RydWN0IGRybV9kZXZpY2UgKmRybV9kZXYsCiBpbnQgcm9ja2NoaXBf
ZHJtX3dhaXRfdmFjdF9lbmQoc3RydWN0IGRybV9jcnRjICpjcnRjLCB1bnNpZ25lZCBpbnQgbXN0
aW1lb3V0KTsKIAogaW50IHJvY2tjaGlwX2RybV9lbmRwb2ludF9pc19zdWJkcml2ZXIoc3RydWN0
IGRldmljZV9ub2RlICplcCk7Cit1aW50MzJfdCByb2NrY2hpcF9kcm1fZ2V0X3ZibGFua19ucyhz
dHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqbW9kZSk7CiBleHRlcm4gc3RydWN0IHBsYXRmb3JtX2Ry
aXZlciBjZG5fZHBfZHJpdmVyOwogZXh0ZXJuIHN0cnVjdCBwbGF0Zm9ybV9kcml2ZXIgZHdfaGRt
aV9yb2NrY2hpcF9wbHRmbV9kcml2ZXI7CiBleHRlcm4gc3RydWN0IHBsYXRmb3JtX2RyaXZlciBk
d19taXBpX2RzaV9yb2NrY2hpcF9kcml2ZXI7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0v
cm9ja2NoaXAvcm9ja2NoaXBfZHJtX2ZiLmMgYi9kcml2ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9j
a2NoaXBfZHJtX2ZiLmMKaW5kZXggOTc0MzhiYmJlMzg5Li42MTNhOTljMjBlZDMgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvZ3B1L2RybS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fZmIuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBfZHJtX2ZiLmMKQEAgLTEzLDYgKzEzLDcgQEAK
ICAqLwogCiAjaW5jbHVkZSA8bGludXgva2VybmVsLmg+CisjaW5jbHVkZSA8bGludXgvZGV2ZnJl
cS5oPgogI2luY2x1ZGUgPGRybS9kcm0uaD4KICNpbmNsdWRlIDxkcm0vZHJtUC5oPgogI2luY2x1
ZGUgPGRybS9kcm1fYXRvbWljLmg+CkBAIC0yNSw2ICsyNiw1NiBAQAogI2luY2x1ZGUgInJvY2tj
aGlwX2RybV9nZW0uaCIKICNpbmNsdWRlICJyb2NrY2hpcF9kcm1fcHNyLmgiCiAKK3N0cnVjdCBy
b2NrY2hpcF9kZHJmcmVxX2xvY2tfc3RhdGUgeworCXN0cnVjdCBkcm1fcHJpdmF0ZV9zdGF0ZSBi
YXNlOworCWludCBsb2NrX2NvdW50ZXI7Cit9OworCisjZGVmaW5lIHRvX2RkcmZyZXFfbG9ja19z
dGF0ZSh4KSBjb250YWluZXJfb2YoeCwgXAorCQkJCSAgICAgICBzdHJ1Y3Qgcm9ja2NoaXBfZGRy
ZnJlcV9sb2NrX3N0YXRlLCBiYXNlKQorCitzdHJ1Y3QgZHJtX3ByaXZhdGVfc3RhdGUgKnJvY2tj
aGlwX2F0b21pY19kdXBsaWNhdGVfZGRyZnJlcV9sb2NrX3N0YXRlKAorCQkJCQkJICAgIHN0cnVj
dCBkcm1fcHJpdmF0ZV9vYmogKm9iaikKK3sKKwlzdHJ1Y3Qgcm9ja2NoaXBfZGRyZnJlcV9sb2Nr
X3N0YXRlICpkZHJmcmVxX2xvY2tfc3RhdGU7CisKKwlkZHJmcmVxX2xvY2tfc3RhdGUgPSBrbWVt
ZHVwKG9iai0+c3RhdGUsIHNpemVvZigqZGRyZnJlcV9sb2NrX3N0YXRlKSwKKwkJCQkgICAgIEdG
UF9LRVJORUwpOworCWlmICghZGRyZnJlcV9sb2NrX3N0YXRlKQorCQlyZXR1cm4gTlVMTDsKKwor
CV9fZHJtX2F0b21pY19oZWxwZXJfcHJpdmF0ZV9vYmpfZHVwbGljYXRlX3N0YXRlKG9iaiwKKwkJ
CQkJCSAgICAgJmRkcmZyZXFfbG9ja19zdGF0ZS0+YmFzZSk7CisKKwlyZXR1cm4gJmRkcmZyZXFf
bG9ja19zdGF0ZS0+YmFzZTsKK30KKwordm9pZCByb2NrY2hpcF9hdG9taWNfZGVzdHJveV9kZHJm
cmVxX2xvY2tfc3RhdGUoc3RydWN0IGRybV9wcml2YXRlX29iaiAqb2JqLAorCQkJCQkJc3RydWN0
IGRybV9wcml2YXRlX3N0YXRlICpzdGF0ZSkKK3sKKwlzdHJ1Y3Qgcm9ja2NoaXBfZGRyZnJlcV9s
b2NrX3N0YXRlICpkZHJmcmVxX2xvY2tfc3RhdGUgPQorCQkJCQkJICAgdG9fZGRyZnJlcV9sb2Nr
X3N0YXRlKHN0YXRlKTsKKworCWtmcmVlKGRkcmZyZXFfbG9ja19zdGF0ZSk7Cit9CisKK3N0cnVj
dCBkcm1fcHJpdmF0ZV9zdGF0ZV9mdW5jcyByb2NrY2hpcF9kZHJmcmVxX2xvY2tfc3RhdGVfZnVu
Y3MgPSB7CisJLmF0b21pY19kdXBsaWNhdGVfc3RhdGUgPSByb2NrY2hpcF9hdG9taWNfZHVwbGlj
YXRlX2RkcmZyZXFfbG9ja19zdGF0ZSwKKwkuYXRvbWljX2Rlc3Ryb3lfc3RhdGUgPSByb2NrY2hp
cF9hdG9taWNfZGVzdHJveV9kZHJmcmVxX2xvY2tfc3RhdGUsCit9OworCitzdGF0aWMgc3RydWN0
IHJvY2tjaGlwX2RkcmZyZXFfbG9ja19zdGF0ZSAqcm9ja2NoaXBfZ2V0X2RkcmZyZXFfbG9ja19z
dGF0ZSgKKwkJICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSwgc3RydWN0IGRybV9w
cml2YXRlX29iaiAqb2JqKQoreworCXN0cnVjdCBkcm1fcHJpdmF0ZV9zdGF0ZSAqcHJpdl9zdGF0
ZTsKKworCXByaXZfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9wcml2YXRlX29ial9zdGF0ZShzdGF0
ZSwgb2JqKTsKKwlpZiAoSVNfRVJSKHByaXZfc3RhdGUpKQorCQlyZXR1cm4gRVJSX0NBU1QocHJp
dl9zdGF0ZSk7CisKKwlyZXR1cm4gdG9fZGRyZnJlcV9sb2NrX3N0YXRlKHByaXZfc3RhdGUpOwor
fQorCiBzdGF0aWMgaW50IHJvY2tjaGlwX2RybV9mYl9kaXJ0eShzdHJ1Y3QgZHJtX2ZyYW1lYnVm
ZmVyICpmYiwKIAkJCQkgc3RydWN0IGRybV9maWxlICpmaWxlLAogCQkJCSB1bnNpZ25lZCBpbnQg
ZmxhZ3MsIHVuc2lnbmVkIGludCBjb2xvciwKQEAgLTEyNywxMCArMTc4LDgwIEBAIHJvY2tjaGlw
X3VzZXJfZmJfY3JlYXRlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHN0cnVjdCBkcm1fZmlsZSAq
ZmlsZV9wcml2LAogCXJldHVybiBFUlJfUFRSKHJldCk7CiB9CiAKK3N0YXRpYyB2b2lkCityb2Nr
Y2hpcF9kcm1fcHNyX2luaGliaXRfZ2V0X3N0YXRlKHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpz
dGF0ZSkKK3sKKwlzdHJ1Y3QgZHJtX2NydGMgKmNydGM7CisJc3RydWN0IGRybV9jcnRjX3N0YXRl
ICpjcnRjX3N0YXRlOworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcjsKKwl1MzIgZW5jb2Rl
cl9tYXNrID0gMDsKKwlpbnQgaTsKKworCWZvcl9lYWNoX29sZF9jcnRjX2luX3N0YXRlKHN0YXRl
LCBjcnRjLCBjcnRjX3N0YXRlLCBpKSB7CisJCWVuY29kZXJfbWFzayB8PSBjcnRjX3N0YXRlLT5l
bmNvZGVyX21hc2s7CisJCWVuY29kZXJfbWFzayB8PSBjcnRjLT5zdGF0ZS0+ZW5jb2Rlcl9tYXNr
OworCX0KKworCWRybV9mb3JfZWFjaF9lbmNvZGVyX21hc2soZW5jb2Rlciwgc3RhdGUtPmRldiwg
ZW5jb2Rlcl9tYXNrKQorCQlyb2NrY2hpcF9kcm1fcHNyX2luaGliaXRfZ2V0KGVuY29kZXIpOwor
fQorCit1aW50MzJfdCByb2NrY2hpcF9kcm1fZ2V0X3ZibGFua19ucyhzdHJ1Y3QgZHJtX2Rpc3Bs
YXlfbW9kZSAqbW9kZSkKK3sKKwl1aW50NjRfdCB2YmxhbmtfdGltZSA9IG1vZGUtPnZ0b3RhbCAt
IG1vZGUtPnZkaXNwbGF5OworCisJdmJsYW5rX3RpbWUgKj0gKHVpbnQ2NF90KU5TRUNfUEVSX1NF
QyAqIG1vZGUtPmh0b3RhbDsKKwlkb19kaXYodmJsYW5rX3RpbWUsIG1vZGUtPmNsb2NrICogMTAw
MCk7CisKKwlyZXR1cm4gdmJsYW5rX3RpbWU7Cit9CisKK3N0YXRpYyB2b2lkCityb2NrY2hpcF9k
cm1fcHNyX2luaGliaXRfcHV0X3N0YXRlKHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkK
K3sKKwlzdHJ1Y3QgZHJtX2NydGMgKmNydGM7CisJc3RydWN0IGRybV9jcnRjX3N0YXRlICpjcnRj
X3N0YXRlOworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcjsKKwl1MzIgZW5jb2Rlcl9tYXNr
ID0gMDsKKwlpbnQgaTsKKworCWZvcl9lYWNoX29sZF9jcnRjX2luX3N0YXRlKHN0YXRlLCBjcnRj
LCBjcnRjX3N0YXRlLCBpKSB7CisJCWVuY29kZXJfbWFzayB8PSBjcnRjX3N0YXRlLT5lbmNvZGVy
X21hc2s7CisJCWVuY29kZXJfbWFzayB8PSBjcnRjLT5zdGF0ZS0+ZW5jb2Rlcl9tYXNrOworCX0K
KworCWRybV9mb3JfZWFjaF9lbmNvZGVyX21hc2soZW5jb2Rlciwgc3RhdGUtPmRldiwgZW5jb2Rl
cl9tYXNrKQorCQlyb2NrY2hpcF9kcm1fcHNyX2luaGliaXRfcHV0KGVuY29kZXIpOworfQorCiBz
dGF0aWMgdm9pZAogcm9ja2NoaXBfYXRvbWljX2hlbHBlcl9jb21taXRfdGFpbF9ycG0oc3RydWN0
IGRybV9hdG9taWNfc3RhdGUgKm9sZF9zdGF0ZSkKIHsKIAlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2
ID0gb2xkX3N0YXRlLT5kZXY7CisJc3RydWN0IHJvY2tjaGlwX2RybV9wcml2YXRlICpwcml2ID0g
ZGV2LT5kZXZfcHJpdmF0ZTsKKwlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUgKm9sZF9jcnRjX3N0YXRl
LCAqbmV3X2NydGNfc3RhdGU7CisJc3RydWN0IHJvY2tjaGlwX2RkcmZyZXFfbG9ja19zdGF0ZSAq
ZGRyZnJlcV9sb2NrX3N0YXRlOworCXN0cnVjdCBkcm1fY3J0YyAqY3J0YzsKKwlpbnQgaTsKKwor
CWZvcl9lYWNoX29sZG5ld19jcnRjX2luX3N0YXRlKG9sZF9zdGF0ZSwgY3J0Yywgb2xkX2NydGNf
c3RhdGUsCisJCQkJICAgICAgbmV3X2NydGNfc3RhdGUsIGkpIHsKKwkJaWYgKG9sZF9jcnRjX3N0
YXRlLT5lbmFibGUgPT0gbmV3X2NydGNfc3RhdGUtPmVuYWJsZSkKKwkJCWNvbnRpbnVlOworCisJ
CWRkcmZyZXFfbG9ja19zdGF0ZSA9IHJvY2tjaGlwX2dldF9kZHJmcmVxX2xvY2tfc3RhdGUob2xk
X3N0YXRlLAorCQkJCQkJICAgJnByaXYtPmRkcmZyZXFfbG9ja19tYW5hZ2VyKTsKKwkJaWYgKElT
X0VSUihkZHJmcmVxX2xvY2tfc3RhdGUpKQorCQkJYnJlYWs7CisKKwkJLyogVE9ETyBUaGlzIGxv
Z2ljIGJhc2VkIG9uIHRoZSBwcmV2aW91cyBzdGF0ZSBsb29rcyB3ZWlyZCA6LyAqLworCQlpZiAo
b2xkX2NydGNfc3RhdGUtPmVuYWJsZSAmJgorCQkgICAgZGRyZnJlcV9sb2NrX3N0YXRlLT5sb2Nr
X2NvdW50ZXIgPT0gMikKKwkJCWRldmZyZXFfcmVzdW1lX2RldmljZShwcml2LT5kZXZmcmVxKTsK
KwkJZWxzZSBpZiAoIW9sZF9jcnRjX3N0YXRlLT5lbmFibGUgJiYKKwkJCSBkZHJmcmVxX2xvY2tf
c3RhdGUtPmxvY2tfY291bnRlciA9PSAxKQorCQkJZGV2ZnJlcV9zdXNwZW5kX2RldmljZShwcml2
LT5kZXZmcmVxKTsKKwl9CiAKIAlyb2NrY2hpcF9kcm1fcHNyX2luaGliaXRfZ2V0X3N0YXRlKG9s
ZF9zdGF0ZSk7CiAKQEAgLTE1NCwxMCArMjc1LDQxIEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3QgZHJt
X21vZGVfY29uZmlnX2hlbHBlcl9mdW5jcyByb2NrY2hpcF9tb2RlX2NvbmZpZ19oZWxwZXJzID0K
IAkuYXRvbWljX2NvbW1pdF90YWlsID0gcm9ja2NoaXBfYXRvbWljX2hlbHBlcl9jb21taXRfdGFp
bF9ycG0sCiB9OwogCitzdGF0aWMgaW50IHJvY2tjaGlwX2RybV9hdG9taWNfY2hlY2soc3RydWN0
IGRybV9kZXZpY2UgKmRldiwKKwkJCQkgICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0
ZSkKK3sKKwlzdHJ1Y3Qgcm9ja2NoaXBfZHJtX3ByaXZhdGUgKnByaXYgPSBkZXYtPmRldl9wcml2
YXRlOworCXN0cnVjdCByb2NrY2hpcF9kZHJmcmVxX2xvY2tfc3RhdGUgKmRkcmZyZXFfbG9ja19z
dGF0ZTsKKwlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUgKmNydGNfc3RhdGU7CisJc3RydWN0IGRybV9j
cnRjICpjcnRjOworCWludCByZXQ7CisJaW50IGk7CisKKwlyZXQgPSBkcm1fYXRvbWljX2hlbHBl
cl9jaGVjayhkZXYsIHN0YXRlKTsKKwlpZiAocmV0ID09IDApIHsKKwkJZm9yX2VhY2hfbmV3X2Ny
dGNfaW5fc3RhdGUoc3RhdGUsIGNydGMsIGNydGNfc3RhdGUsIGkpIHsKKwkJCWlmICghY3J0Y19z
dGF0ZS0+YWN0aXZlX2NoYW5nZWQpCisJCQkJY29udGludWU7CisKKwkJCWRkcmZyZXFfbG9ja19z
dGF0ZSA9IHJvY2tjaGlwX2dldF9kZHJmcmVxX2xvY2tfc3RhdGUoCisJCQkJCSAgICBzdGF0ZSwg
JnByaXYtPmRkcmZyZXFfbG9ja19tYW5hZ2VyKTsKKwkJCWlmIChJU19FUlIoZGRyZnJlcV9sb2Nr
X3N0YXRlKSkKKwkJCQlyZXR1cm4gUFRSX0VSUihkZHJmcmVxX2xvY2tfc3RhdGUpOworCisJCQlp
ZiAoY3J0Y19zdGF0ZS0+ZW5hYmxlKQorCQkJCWRkcmZyZXFfbG9ja19zdGF0ZS0+bG9ja19jb3Vu
dGVyKys7CisJCQllbHNlCisJCQkJZGRyZnJlcV9sb2NrX3N0YXRlLT5sb2NrX2NvdW50ZXItLTsK
KwkJfQorCX0KKworCXJldHVybiByZXQ7Cit9CisKIHN0YXRpYyBjb25zdCBzdHJ1Y3QgZHJtX21v
ZGVfY29uZmlnX2Z1bmNzIHJvY2tjaGlwX2RybV9tb2RlX2NvbmZpZ19mdW5jcyA9IHsKIAkuZmJf
Y3JlYXRlID0gcm9ja2NoaXBfdXNlcl9mYl9jcmVhdGUsCiAJLm91dHB1dF9wb2xsX2NoYW5nZWQg
PSBkcm1fZmJfaGVscGVyX291dHB1dF9wb2xsX2NoYW5nZWQsCi0JLmF0b21pY19jaGVjayA9IGRy
bV9hdG9taWNfaGVscGVyX2NoZWNrLAorCS5hdG9taWNfY2hlY2sgPSByb2NrY2hpcF9kcm1fYXRv
bWljX2NoZWNrLAogCS5hdG9taWNfY29tbWl0ID0gZHJtX2F0b21pY19oZWxwZXJfY29tbWl0LAog
fTsKIApAQCAtMTc1LDggKzMyNywxMSBAQCByb2NrY2hpcF9kcm1fZnJhbWVidWZmZXJfaW5pdChz
dHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogCXJldHVybiBmYjsKIH0KIAotdm9pZCByb2NrY2hpcF9k
cm1fbW9kZV9jb25maWdfaW5pdChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2KQoraW50IHJvY2tjaGlw
X2RybV9tb2RlX2NvbmZpZ19pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpCiB7CisJc3RydWN0
IHJvY2tjaGlwX2RybV9wcml2YXRlICpwcml2ID0gZGV2LT5kZXZfcHJpdmF0ZTsKKwlzdHJ1Y3Qg
cm9ja2NoaXBfZGRyZnJlcV9sb2NrX3N0YXRlICpkZHJmcmVxX2xvY2tfc3RhdGU7CisKIAlkZXYt
Pm1vZGVfY29uZmlnLm1pbl93aWR0aCA9IDA7CiAJZGV2LT5tb2RlX2NvbmZpZy5taW5faGVpZ2h0
ID0gMDsKIApAQCAtMTkwLDQgKzM0NSwyMiBAQCB2b2lkIHJvY2tjaGlwX2RybV9tb2RlX2NvbmZp
Z19pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpCiAKIAlkZXYtPm1vZGVfY29uZmlnLmZ1bmNz
ID0gJnJvY2tjaGlwX2RybV9tb2RlX2NvbmZpZ19mdW5jczsKIAlkZXYtPm1vZGVfY29uZmlnLmhl
bHBlcl9wcml2YXRlID0gJnJvY2tjaGlwX21vZGVfY29uZmlnX2hlbHBlcnM7CisKKwlkZHJmcmVx
X2xvY2tfc3RhdGUgPSBremFsbG9jKHNpemVvZigqZGRyZnJlcV9sb2NrX3N0YXRlKSwKKwkJCQkg
ICAgIEdGUF9LRVJORUwpOworCWlmICghZGRyZnJlcV9sb2NrX3N0YXRlKQorCQlyZXR1cm4gLUVO
T01FTTsKKworCWRybV9hdG9taWNfcHJpdmF0ZV9vYmpfaW5pdCgmcHJpdi0+ZGRyZnJlcV9sb2Nr
X21hbmFnZXIsCisJCQkJICAgICZkZHJmcmVxX2xvY2tfc3RhdGUtPmJhc2UsCisJCQkJICAgICZy
b2NrY2hpcF9kZHJmcmVxX2xvY2tfc3RhdGVfZnVuY3MpOworCisJcmV0dXJuIDA7Cit9CisKK3Zv
aWQgcm9ja2NoaXBfZHJtX21vZGVfY29uZmlnX2Zpbmkoc3RydWN0IGRybV9kZXZpY2UgKmRldikK
K3sKKwlzdHJ1Y3Qgcm9ja2NoaXBfZHJtX3ByaXZhdGUgKnByaXYgPSBkZXYtPmRldl9wcml2YXRl
OworCisJZHJtX2F0b21pY19wcml2YXRlX29ial9maW5pKCZwcml2LT5kZHJmcmVxX2xvY2tfbWFu
YWdlcik7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBf
ZHJtX2ZiLmggYi9kcml2ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBfZHJtX2ZiLmgKaW5k
ZXggZjEyNjVjYjFhZWU4Li5hODFkZjRlZjhiMzUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fZmIuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vcm9ja2No
aXAvcm9ja2NoaXBfZHJtX2ZiLmgKQEAgLTIxLDUgKzIxLDYgQEAgcm9ja2NoaXBfZHJtX2ZyYW1l
YnVmZmVyX2luaXQoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAkJCSAgICAgIHN0cnVjdCBkcm1f
Z2VtX29iamVjdCAqb2JqKTsKIHZvaWQgcm9ja2NoaXBfZHJtX2ZyYW1lYnVmZmVyX2Zpbmkoc3Ry
dWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIpOwogCi12b2lkIHJvY2tjaGlwX2RybV9tb2RlX2NvbmZp
Z19pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpOworaW50IHJvY2tjaGlwX2RybV9tb2RlX2Nv
bmZpZ19pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpOwordm9pZCByb2NrY2hpcF9kcm1fbW9k
ZV9jb25maWdfZmluaShzdHJ1Y3QgZHJtX2RldmljZSAqZGV2KTsKICNlbmRpZiAvKiBfUk9DS0NI
SVBfRFJNX0ZCX0ggKi8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9yb2NrY2hpcC9yb2Nr
Y2hpcF9kcm1fdm9wLmMgYi9kcml2ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBfZHJtX3Zv
cC5jCmluZGV4IDBkNGFkZTlkNDcyMi4uZTc2YTY4YWUzOTkxIDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBfZHJtX3ZvcC5jCisrKyBiL2RyaXZlcnMvZ3B1L2Ry
bS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fdm9wLmMKQEAgLTM2LDYgKzM2LDggQEAKICNpbmNsdWRl
IDxsaW51eC9jb21wb25lbnQuaD4KICNpbmNsdWRlIDxsaW51eC9vdmVyZmxvdy5oPgogCisjaW5j
bHVkZSA8bGludXgvZGV2ZnJlcS5oPgorCiAjaW5jbHVkZSA8bGludXgvcmVzZXQuaD4KICNpbmNs
dWRlIDxsaW51eC9kZWxheS5oPgogCkBAIC0xNDEsNiArMTQzLDEyIEBAIHN0cnVjdCB2b3Agewog
CiAJc3RydWN0IGNvbXBsZXRpb24gbGluZV9mbGFnX2NvbXBsZXRpb247CiAKKwkvKiBkZXZmcmVx
IGxvY2tpbmcgKi8KKwlzcGlubG9ja190IGRldmZyZXFfbG9jazsKKwlib29sIHdhbnRfdG9fY2hh
bmdlX3JhdGU7CisJc3RydWN0IGRldmZyZXFfZGV2X3VzZXJsb2NrIGRldmZyZXFfdXNlcmxvY2s7
CisJc3RydWN0IGhydGltZXIgdmJsYW5rX3RpbWVyOworCiAJY29uc3Qgc3RydWN0IHZvcF9kYXRh
ICpkYXRhOwogCiAJdWludDMyX3QgKnJlZ3NiYWs7CkBAIC02MzIsOSArNjQwLDEyIEBAIHN0YXRp
YyB2b2lkIHZvcF9jcnRjX2F0b21pY19kaXNhYmxlKHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKIAkJ
CQkgICAgc3RydWN0IGRybV9jcnRjX3N0YXRlICpvbGRfc3RhdGUpCiB7CiAJc3RydWN0IHZvcCAq
dm9wID0gdG9fdm9wKGNydGMpOworCXN0cnVjdCByb2NrY2hpcF9kcm1fcHJpdmF0ZSAqcHJpdiA9
IHZvcC0+Y3J0Yy5kZXYtPmRldl9wcml2YXRlOwogCiAJV0FSTl9PTih2b3AtPmV2ZW50KTsKIAor
CWRldmZyZXFfdW5sb2NrX2RldmljZShwcml2LT5kZXZmcmVxLCAmdm9wLT5kZXZmcmVxX3VzZXJs
b2NrLCAwKTsKKwogCW11dGV4X2xvY2soJnZvcC0+dm9wX2xvY2spOwogCWRybV9jcnRjX3ZibGFu
a19vZmYoY3J0Yyk7CiAKQEAgLTEwMjgsNiArMTAzOSw3IEBAIHN0YXRpYyB2b2lkIHZvcF9jcnRj
X2F0b21pY19lbmFibGUoc3RydWN0IGRybV9jcnRjICpjcnRjLAogewogCXN0cnVjdCB2b3AgKnZv
cCA9IHRvX3ZvcChjcnRjKTsKIAljb25zdCBzdHJ1Y3Qgdm9wX2RhdGEgKnZvcF9kYXRhID0gdm9w
LT5kYXRhOworCXN0cnVjdCByb2NrY2hpcF9kcm1fcHJpdmF0ZSAqcHJpdiA9IHZvcC0+Y3J0Yy5k
ZXYtPmRldl9wcml2YXRlOwogCXN0cnVjdCByb2NrY2hpcF9jcnRjX3N0YXRlICpzID0gdG9fcm9j
a2NoaXBfY3J0Y19zdGF0ZShjcnRjLT5zdGF0ZSk7CiAJc3RydWN0IGRybV9kaXNwbGF5X21vZGUg
KmFkanVzdGVkX21vZGUgPSAmY3J0Yy0+c3RhdGUtPmFkanVzdGVkX21vZGU7CiAJdTE2IGhzeW5j
X2xlbiA9IGFkanVzdGVkX21vZGUtPmhzeW5jX2VuZCAtIGFkanVzdGVkX21vZGUtPmhzeW5jX3N0
YXJ0OwpAQCAtMTEyMyw2ICsxMTM1LDExIEBAIHN0YXRpYyB2b2lkIHZvcF9jcnRjX2F0b21pY19l
bmFibGUoc3RydWN0IGRybV9jcnRjICpjcnRjLAogCiAJVk9QX1JFR19TRVQodm9wLCBjb21tb24s
IHN0YW5kYnksIDApOwogCW11dGV4X3VubG9jaygmdm9wLT52b3BfbG9jayk7CisKKwlyZXQgPSBk
ZXZmcmVxX2xvY2tfZGV2aWNlKHByaXYtPmRldmZyZXEsICZ2b3AtPmRldmZyZXFfdXNlcmxvY2sp
OworCWlmIChyZXQpCisJCURSTV9ERVZfRVJST1Iodm9wLT5kZXYsCisJCQkgICAgICAiY2Fubm90
IGxvY2sgZGV2ZnJlcSAtIGVyciAlZFxuIiwgcmV0KTsKIH0KIAogc3RhdGljIGJvb2wgdm9wX2Zz
X2lycV9pc19wZW5kaW5nKHN0cnVjdCB2b3AgKnZvcCkKQEAgLTEzNDksMTAgKzEzNjYsNDQgQEAg
c3RhdGljIHZvaWQgdm9wX2hhbmRsZV92Ymxhbmsoc3RydWN0IHZvcCAqdm9wKQogCQlkcm1fZmxp
cF93b3JrX2NvbW1pdCgmdm9wLT5mYl91bnJlZl93b3JrLCBzeXN0ZW1fdW5ib3VuZF93cSk7CiB9
CiAKK3N0YXRpYyBlbnVtIGhydGltZXJfcmVzdGFydCB2YmxhbmtfdGltZXJfZnVuY3Rpb24oc3Ry
dWN0IGhydGltZXIgKnRpbWVyKQoreworCXN0cnVjdCB2b3AgKnZvcCA9IGNvbnRhaW5lcl9vZih0
aW1lciwgc3RydWN0IHZvcCwgdmJsYW5rX3RpbWVyKTsKKwlzdHJ1Y3Qgcm9ja2NoaXBfZHJtX3By
aXZhdGUgKnByaXYgPSB2b3AtPmNydGMuZGV2LT5kZXZfcHJpdmF0ZTsKKwlzdHJ1Y3QgZGV2ZnJl
cSAqZGV2ZnJlcSA9IHByaXYtPmRldmZyZXE7CisKKwlkcm1fY3J0Y192YmxhbmtfcHV0KCZ2b3At
PmNydGMpOworCisJZGV2ZnJlcV9sb2NrX2RldmljZShkZXZmcmVxLCAmdm9wLT5kZXZmcmVxX3Vz
ZXJsb2NrKTsKKworCXNwaW5fbG9jaygmdm9wLT5kZXZmcmVxX2xvY2spOworCXZvcC0+d2FudF90
b19jaGFuZ2VfcmF0ZSA9IGZhbHNlOworCXNwaW5fdW5sb2NrKCZ2b3AtPmRldmZyZXFfbG9jayk7
CisKKwlyZXR1cm4gSFJUSU1FUl9OT1JFU1RBUlQ7Cit9CisKK3N0YXRpYyB2b2lkIHdhbnRfdG9f
Y2hhbmdlX3JhdGUoc3RydWN0IGRldmZyZXFfZGV2X3VzZXJsb2NrICp1c2VybG9jaywKKwkJCQlz
dHJ1Y3QgZGV2ZnJlcSAqZGV2ZnJlcSkKK3sKKwlzdHJ1Y3Qgdm9wICp2b3AgPSBjb250YWluZXJf
b2YodXNlcmxvY2ssIHN0cnVjdCB2b3AsIGRldmZyZXFfdXNlcmxvY2spOworCWludCBlcnI7CisK
KwlzcGluX2xvY2soJnZvcC0+ZGV2ZnJlcV9sb2NrKTsKKwl2b3AtPndhbnRfdG9fY2hhbmdlX3Jh
dGUgPSB0cnVlOworCXNwaW5fdW5sb2NrKCZ2b3AtPmRldmZyZXFfbG9jayk7CisKKwllcnIgPSBk
cm1fY3J0Y192YmxhbmtfZ2V0KCZ2b3AtPmNydGMpOworCWlmIChlcnIpCisJCURSTV9ERVZfRVJS
T1Iodm9wLT5kZXYsICJjb3VsZG4ndCBnZXQgdmJsYW5rICVkXG4iLCBlcnIpOworfQorCiBzdGF0
aWMgaXJxcmV0dXJuX3Qgdm9wX2lzcihpbnQgaXJxLCB2b2lkICpkYXRhKQogewogCXN0cnVjdCB2
b3AgKnZvcCA9IGRhdGE7CiAJc3RydWN0IGRybV9jcnRjICpjcnRjID0gJnZvcC0+Y3J0YzsKKwlz
dHJ1Y3Qgcm9ja2NoaXBfZHJtX3ByaXZhdGUgKnByaXYgPSBjcnRjLT5kZXYtPmRldl9wcml2YXRl
OworCWt0aW1lX3QgdmJsYW5rX3RpbWVvdXQ7CiAJdWludDMyX3QgYWN0aXZlX2lycXM7CiAJaW50
IHJldCA9IElSUV9OT05FOwogCkBAIC0xMzk4LDYgKzE0NDksMTkgQEAgc3RhdGljIGlycXJldHVy
bl90IHZvcF9pc3IoaW50IGlycSwgdm9pZCAqZGF0YSkKIAl9CiAKIAlpZiAoYWN0aXZlX2lycXMg
JiBGU19JTlRSKSB7CisJCXNwaW5fbG9jaygmdm9wLT5kZXZmcmVxX2xvY2spOworCQlpZiAodm9w
LT53YW50X3RvX2NoYW5nZV9yYXRlKSB7CisJCQl2b3AtPndhbnRfdG9fY2hhbmdlX3JhdGUgPSBm
YWxzZTsKKwkJCXZibGFua190aW1lb3V0ID0ga3RpbWVfYWRkX25zKGt0aW1lX2dldCgpLAorCQkJ
CSAgICAgICByb2NrY2hpcF9kcm1fZ2V0X3ZibGFua19ucygmY3J0Yy0+bW9kZSkpOworCQkJaHJ0
aW1lcl9zdGFydCgmdm9wLT52YmxhbmtfdGltZXIsIHZibGFua190aW1lb3V0LAorCQkJCSAgICAg
IEhSVElNRVJfTU9ERV9BQlMpOworCQkJZGV2ZnJlcV91bmxvY2tfZGV2aWNlKHByaXYtPmRldmZy
ZXEsCisJCQkJCSAgICAgICZ2b3AtPmRldmZyZXFfdXNlcmxvY2ssCisJCQkJCSAgICAgIHZibGFu
a190aW1lb3V0KTsKKwkJfQorCQlzcGluX3VubG9jaygmdm9wLT5kZXZmcmVxX2xvY2spOworCiAJ
CWRybV9jcnRjX2hhbmRsZV92YmxhbmsoY3J0Yyk7CiAJCXZvcF9oYW5kbGVfdmJsYW5rKHZvcCk7
CiAJCWFjdGl2ZV9pcnFzICY9IH5GU19JTlRSOwpAQCAtMTc0Niw2ICsxODEwLDcgQEAgc3RhdGlj
IGludCB2b3BfYmluZChzdHJ1Y3QgZGV2aWNlICpkZXYsIHN0cnVjdCBkZXZpY2UgKm1hc3Rlciwg
dm9pZCAqZGF0YSkKIHsKIAlzdHJ1Y3QgcGxhdGZvcm1fZGV2aWNlICpwZGV2ID0gdG9fcGxhdGZv
cm1fZGV2aWNlKGRldik7CiAJY29uc3Qgc3RydWN0IHZvcF9kYXRhICp2b3BfZGF0YTsKKwlzdHJ1
Y3Qgcm9ja2NoaXBfZHJtX3ByaXZhdGUgKnByaXY7CiAJc3RydWN0IGRybV9kZXZpY2UgKmRybV9k
ZXYgPSBkYXRhOwogCXN0cnVjdCB2b3AgKnZvcDsKIAlzdHJ1Y3QgcmVzb3VyY2UgKnJlczsKQEAg
LTE4MTUsNiArMTg4MCwyMCBAQCBzdGF0aWMgaW50IHZvcF9iaW5kKHN0cnVjdCBkZXZpY2UgKmRl
diwgc3RydWN0IGRldmljZSAqbWFzdGVyLCB2b2lkICpkYXRhKQogCQl9CiAJfQogCisJaHJ0aW1l
cl9pbml0KCZ2b3AtPnZibGFua190aW1lciwgQ0xPQ0tfTU9OT1RPTklDLCBIUlRJTUVSX01PREVf
QUJTKTsKKwl2b3AtPnZibGFua190aW1lci5mdW5jdGlvbiA9IHZibGFua190aW1lcl9mdW5jdGlv
bjsKKworCUlOSVRfTElTVF9IRUFEKCZ2b3AtPmRldmZyZXFfdXNlcmxvY2subm9kZSk7CisJdm9w
LT5kZXZmcmVxX3VzZXJsb2NrLndhbnRfdG9fY2hhbmdlX3JhdGUgPSB3YW50X3RvX2NoYW5nZV9y
YXRlOworCisJcHJpdiA9IHZvcC0+Y3J0Yy5kZXYtPmRldl9wcml2YXRlOworCXJldCA9IGRldmZy
ZXFfcmVnaXN0ZXJfZGV2X3VzZXJfbG9jaygmdm9wLT5kZXZmcmVxX3VzZXJsb2NrLAorCQkJCQkg
ICAgIHByaXYtPmRldmZyZXEpOworCWlmIChyZXQpCisJCURSTV9ERVZfRVJST1IoJnBkZXYtPmRl
diwKKwkJCSAgICAgICJjYW5ub3QgcmVnaXN0ZXIgdG8gZGV2ZnJlcSB1c2VyIGxvY2sgLSBlcnIg
JWRcbiIsCisJCQkgICAgICByZXQpOworCiAJcmV0dXJuIDA7CiAKIGVycl9kaXNhYmxlX3BtX3J1
bnRpbWU6CkBAIC0xODI2LDYgKzE5MDUsOSBAQCBzdGF0aWMgaW50IHZvcF9iaW5kKHN0cnVjdCBk
ZXZpY2UgKmRldiwgc3RydWN0IGRldmljZSAqbWFzdGVyLCB2b2lkICpkYXRhKQogc3RhdGljIHZv
aWQgdm9wX3VuYmluZChzdHJ1Y3QgZGV2aWNlICpkZXYsIHN0cnVjdCBkZXZpY2UgKm1hc3Rlciwg
dm9pZCAqZGF0YSkKIHsKIAlzdHJ1Y3Qgdm9wICp2b3AgPSBkZXZfZ2V0X2RydmRhdGEoZGV2KTsK
KwlzdHJ1Y3Qgcm9ja2NoaXBfZHJtX3ByaXZhdGUgKnByaXYgPSB2b3AtPmNydGMuZGV2LT5kZXZf
cHJpdmF0ZTsKKworCWRldmZyZXFfdW5yZWdpc3Rlcl9kZXZfdXNlcl9sb2NrKCZ2b3AtPmRldmZy
ZXFfdXNlcmxvY2ssIHByaXYtPmRldmZyZXEpOwogCiAJaWYgKHZvcC0+cmdiKQogCQlyb2NrY2hp
cF9yZ2JfZmluaSh2b3AtPnJnYik7Ci0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVs
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
