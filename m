Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E1F6CA1618
	for <lists+dri-devel@lfdr.de>; Thu, 29 Aug 2019 12:33:42 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 956D46E0B7;
	Thu, 29 Aug 2019 10:33:37 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 36D066E0A8
 for <dri-devel@lists.freedesktop.org>; Thu, 29 Aug 2019 10:33:13 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
 [10.5.11.14])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 855D07FDE9;
 Thu, 29 Aug 2019 10:33:12 +0000 (UTC)
Received: from sirius.home.kraxel.org (ovpn-116-95.ams2.redhat.com
 [10.36.116.95])
 by smtp.corp.redhat.com (Postfix) with ESMTP id E58415D9E2;
 Thu, 29 Aug 2019 10:33:06 +0000 (UTC)
Received: by sirius.home.kraxel.org (Postfix, from userid 1000)
 id 2B3F631EFC; Thu, 29 Aug 2019 12:33:03 +0200 (CEST)
From: Gerd Hoffmann <kraxel@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v9 09/18] drm/virtio: rework virtio_gpu_object_create fencing
Date: Thu, 29 Aug 2019 12:32:52 +0200
Message-Id: <20190829103301.3539-10-kraxel@redhat.com>
In-Reply-To: <20190829103301.3539-1-kraxel@redhat.com>
References: <20190829103301.3539-1-kraxel@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.27]); Thu, 29 Aug 2019 10:33:12 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, open list <linux-kernel@vger.kernel.org>,
 "open list:VIRTIO GPU DRIVER" <virtualization@lists.linux-foundation.org>,
 Gerd Hoffmann <kraxel@redhat.com>, gurchetansingh@chromium.org
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

UmV3b3JrIGZlbmNpbmcgd29ya2Zsb3cuICBTdG9wIHVzaW5nIHR0bSBoZWxwZXJzLCB1c2UgdGhl
CnZpcnRpb19ncHVfYXJyYXlfKiBoZWxwZXJzIGluc3RlYWQuCgpEdWUgdG8gdXNpbmcgdGhlIGdl
bSByZXNlcnZhdGlvbiBvYmplY3QgaXQgaXMgaW5pdGlhbGl6ZWQgYW5kIHJlYWR5IGZvcgp1c2Ug
YmVmb3JlIGNhbGxpbmcgdHRtX2JvX2luaXQuICBTbyB3ZSBjYW4gc2ltcGx5IHVzZSB0aGUgc3Rh
bmRhcmQKZmVuY2luZyB3b3JrZmxvdyBhbmQgZHJvcCB0aGUgdHJpY2t5IGxvZ2ljIHdoaWNoIGNo
ZWNrcyB3aGVuZXZlciB0aGUKY29tbWFuZCBpcyBpbiBmbGlnaHQgc3RpbGwuCgp2NjogcmV3cml0
ZSBtb3N0IG9mIHRoZSBwYXRjaC4KClNpZ25lZC1vZmYtYnk6IEdlcmQgSG9mZm1hbm4gPGtyYXhl
bEByZWRoYXQuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaCAg
ICB8ICAyICsKIGRyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9vYmplY3QuYyB8IDc0ICsr
KysrKysrKysrLS0tLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92
cS5jICAgICB8ICA0ICsrCiAzIGZpbGVzIGNoYW5nZWQsIDM3IGluc2VydGlvbnMoKyksIDQzIGRl
bGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9k
cnYuaCBiL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaAppbmRleCBmNGY4NDNh
ZWMxOGEuLmM2ZWE2NWY2NTA3ZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92
aXJ0Z3B1X2Rydi5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaApA
QCAtMjc0LDYgKzI3NCw3IEBAIHZvaWQgdmlydGlvX2dwdV9mcmVlX3ZidWZzKHN0cnVjdCB2aXJ0
aW9fZ3B1X2RldmljZSAqdmdkZXYpOwogdm9pZCB2aXJ0aW9fZ3B1X2NtZF9jcmVhdGVfcmVzb3Vy
Y2Uoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKIAkJCQkgICAgc3RydWN0IHZpcnRp
b19ncHVfb2JqZWN0ICpibywKIAkJCQkgICAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0X3BhcmFt
cyAqcGFyYW1zLAorCQkJCSAgICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3RfYXJyYXkgKm9ianMs
CiAJCQkJICAgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSk7CiB2b2lkIHZpcnRpb19n
cHVfY21kX3VucmVmX3Jlc291cmNlKHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAJ
CQkJICAgdWludDMyX3QgcmVzb3VyY2VfaWQpOwpAQCAtMzM2LDYgKzMzNyw3IEBAIHZvaWQKIHZp
cnRpb19ncHVfY21kX3Jlc291cmNlX2NyZWF0ZV8zZChzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2Ug
KnZnZGV2LAogCQkJCSAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0ICpibywKIAkJCQkgIHN0cnVj
dCB2aXJ0aW9fZ3B1X29iamVjdF9wYXJhbXMgKnBhcmFtcywKKwkJCQkgIHN0cnVjdCB2aXJ0aW9f
Z3B1X29iamVjdF9hcnJheSAqb2JqcywKIAkJCQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpm
ZW5jZSk7CiB2b2lkIHZpcnRpb19ncHVfY3RybF9hY2soc3RydWN0IHZpcnRxdWV1ZSAqdnEpOwog
dm9pZCB2aXJ0aW9fZ3B1X2N1cnNvcl9hY2soc3RydWN0IHZpcnRxdWV1ZSAqdnEpOwpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jIGIvZHJpdmVycy9n
cHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jCmluZGV4IGFkMjE2ZDA2MjUwNy4uNmFmMjg2
MmM5YTczIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfb2JqZWN0
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jCkBAIC0xMDMs
NiArMTAzLDcgQEAgaW50IHZpcnRpb19ncHVfb2JqZWN0X2NyZWF0ZShzdHJ1Y3QgdmlydGlvX2dw
dV9kZXZpY2UgKnZnZGV2LAogCQkJICAgICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3QgKipib19w
dHIsCiAJCQkgICAgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSkKIHsKKwlzdHJ1Y3Qg
dmlydGlvX2dwdV9vYmplY3RfYXJyYXkgKm9ianMgPSBOVUxMOwogCXN0cnVjdCB2aXJ0aW9fZ3B1
X29iamVjdCAqYm87CiAJc2l6ZV90IGFjY19zaXplOwogCWludCByZXQ7CkBAIC0xMTYsMjMgKzEx
NywzNCBAQCBpbnQgdmlydGlvX2dwdV9vYmplY3RfY3JlYXRlKHN0cnVjdCB2aXJ0aW9fZ3B1X2Rl
dmljZSAqdmdkZXYsCiAJaWYgKGJvID09IE5VTEwpCiAJCXJldHVybiAtRU5PTUVNOwogCXJldCA9
IHZpcnRpb19ncHVfcmVzb3VyY2VfaWRfZ2V0KHZnZGV2LCAmYm8tPmh3X3Jlc19oYW5kbGUpOwot
CWlmIChyZXQgPCAwKSB7Ci0JCWtmcmVlKGJvKTsKLQkJcmV0dXJuIHJldDsKLQl9CisJaWYgKHJl
dCA8IDApCisJCWdvdG8gZXJyX2ZyZWVfZ2VtOworCiAJcGFyYW1zLT5zaXplID0gcm91bmR1cChw
YXJhbXMtPnNpemUsIFBBR0VfU0laRSk7CiAJcmV0ID0gZHJtX2dlbV9vYmplY3RfaW5pdCh2Z2Rl
di0+ZGRldiwgJmJvLT5nZW1fYmFzZSwgcGFyYW1zLT5zaXplKTsKLQlpZiAocmV0ICE9IDApIHsK
LQkJdmlydGlvX2dwdV9yZXNvdXJjZV9pZF9wdXQodmdkZXYsIGJvLT5od19yZXNfaGFuZGxlKTsK
LQkJa2ZyZWUoYm8pOwotCQlyZXR1cm4gcmV0OwotCX0KKwlpZiAocmV0ICE9IDApCisJCWdvdG8g
ZXJyX3B1dF9pZDsKKwogCWJvLT5kdW1iID0gcGFyYW1zLT5kdW1iOwogCisJaWYgKGZlbmNlKSB7
CisJCXJldCA9IC1FTk9NRU07CisJCW9ianMgPSB2aXJ0aW9fZ3B1X2FycmF5X2FsbG9jKDEpOwor
CQlpZiAoIW9ianMpCisJCQlnb3RvIGVycl9wdXRfaWQ7CisJCXZpcnRpb19ncHVfYXJyYXlfYWRk
X29iaihvYmpzLCAmYm8tPmdlbV9iYXNlKTsKKworCQlyZXQgPSB2aXJ0aW9fZ3B1X2FycmF5X2xv
Y2tfcmVzdihvYmpzKTsKKwkJaWYgKHJldCAhPSAwKQorCQkJZ290byBlcnJfcHV0X29ianM7CisJ
fQorCiAJaWYgKHBhcmFtcy0+dmlyZ2wpIHsKLQkJdmlydGlvX2dwdV9jbWRfcmVzb3VyY2VfY3Jl
YXRlXzNkKHZnZGV2LCBibywgcGFyYW1zLCBmZW5jZSk7CisJCXZpcnRpb19ncHVfY21kX3Jlc291
cmNlX2NyZWF0ZV8zZCh2Z2RldiwgYm8sIHBhcmFtcywKKwkJCQkJCSAgb2JqcywgZmVuY2UpOwog
CX0gZWxzZSB7Ci0JCXZpcnRpb19ncHVfY21kX2NyZWF0ZV9yZXNvdXJjZSh2Z2RldiwgYm8sIHBh
cmFtcywgZmVuY2UpOworCQl2aXJ0aW9fZ3B1X2NtZF9jcmVhdGVfcmVzb3VyY2UodmdkZXYsIGJv
LCBwYXJhbXMsCisJCQkJCSAgICAgICBvYmpzLCBmZW5jZSk7CiAJfQogCiAJdmlydGlvX2dwdV9p
bml0X3R0bV9wbGFjZW1lbnQoYm8pOwpAQCAtMTQ1LDQwICsxNTcsMTYgQEAgaW50IHZpcnRpb19n
cHVfb2JqZWN0X2NyZWF0ZShzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogCWlmIChy
ZXQgIT0gMCkKIAkJcmV0dXJuIHJldDsKIAotCWlmIChmZW5jZSkgewotCQlzdHJ1Y3QgdmlydGlv
X2dwdV9mZW5jZV9kcml2ZXIgKmRydiA9ICZ2Z2Rldi0+ZmVuY2VfZHJ2OwotCQlzdHJ1Y3QgbGlz
dF9oZWFkIHZhbGlkYXRlX2xpc3Q7Ci0JCXN0cnVjdCB0dG1fdmFsaWRhdGVfYnVmZmVyIG1haW5i
dWY7Ci0JCXN0cnVjdCB3d19hY3F1aXJlX2N0eCB0aWNrZXQ7Ci0JCXVuc2lnbmVkIGxvbmcgaXJx
X2ZsYWdzOwotCQlib29sIHNpZ25hbGVkOwotCi0JCUlOSVRfTElTVF9IRUFEKCZ2YWxpZGF0ZV9s
aXN0KTsKLQkJbWVtc2V0KCZtYWluYnVmLCAwLCBzaXplb2Yoc3RydWN0IHR0bV92YWxpZGF0ZV9i
dWZmZXIpKTsKLQotCQkvKiB1c2UgYSBnZW0gcmVmZXJlbmNlIHNpbmNlIHVucmVmIGxpc3QgdW5k
b2VzIHRoZW0gKi8KLQkJZHJtX2dlbV9vYmplY3RfZ2V0KCZiby0+Z2VtX2Jhc2UpOwotCQltYWlu
YnVmLmJvID0gJmJvLT50Ym87Ci0JCWxpc3RfYWRkKCZtYWluYnVmLmhlYWQsICZ2YWxpZGF0ZV9s
aXN0KTsKLQotCQlyZXQgPSB2aXJ0aW9fZ3B1X29iamVjdF9saXN0X3ZhbGlkYXRlKCZ0aWNrZXQs
ICZ2YWxpZGF0ZV9saXN0KTsKLQkJaWYgKHJldCA9PSAwKSB7Ci0JCQlzcGluX2xvY2tfaXJxc2F2
ZSgmZHJ2LT5sb2NrLCBpcnFfZmxhZ3MpOwotCQkJc2lnbmFsZWQgPSB2aXJ0aW9fZmVuY2Vfc2ln
bmFsZWQoJmZlbmNlLT5mKTsKLQkJCWlmICghc2lnbmFsZWQpCi0JCQkJLyogdmlydGlvIGNyZWF0
ZSBjb21tYW5kIHN0aWxsIGluIGZsaWdodCAqLwotCQkJCXR0bV9ldV9mZW5jZV9idWZmZXJfb2Jq
ZWN0cygmdGlja2V0LCAmdmFsaWRhdGVfbGlzdCwKLQkJCQkJCQkgICAgJmZlbmNlLT5mKTsKLQkJ
CXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmRydi0+bG9jaywgaXJxX2ZsYWdzKTsKLQkJCWlmIChz
aWduYWxlZCkKLQkJCQkvKiB2aXJ0aW8gY3JlYXRlIGNvbW1hbmQgZmluaXNoZWQgKi8KLQkJCQl0
dG1fZXVfYmFja29mZl9yZXNlcnZhdGlvbigmdGlja2V0LCAmdmFsaWRhdGVfbGlzdCk7Ci0JCX0K
LQkJdmlydGlvX2dwdV91bnJlZl9saXN0KCZ2YWxpZGF0ZV9saXN0KTsKLQl9Ci0KIAkqYm9fcHRy
ID0gYm87CiAJcmV0dXJuIDA7CisKK2Vycl9wdXRfb2JqczoKKwl2aXJ0aW9fZ3B1X2FycmF5X3B1
dF9mcmVlKG9ianMpOworZXJyX3B1dF9pZDoKKwl2aXJ0aW9fZ3B1X3Jlc291cmNlX2lkX3B1dCh2
Z2RldiwgYm8tPmh3X3Jlc19oYW5kbGUpOworZXJyX2ZyZWVfZ2VtOgorCWtmcmVlKGJvKTsKKwly
ZXR1cm4gcmV0OwogfQogCiB2b2lkIHZpcnRpb19ncHVfb2JqZWN0X2t1bm1hcChzdHJ1Y3Qgdmly
dGlvX2dwdV9vYmplY3QgKmJvKQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92
aXJ0Z3B1X3ZxLmMgYi9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfdnEuYwppbmRleCA1
MTM3ZGNmMTFkMzEuLjc1MDk0MjRhN2I5MiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3Zp
cnRpby92aXJ0Z3B1X3ZxLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X3Zx
LmMKQEAgLTM5Niw2ICszOTYsNyBAQCBzdGF0aWMgdm9pZCB2aXJ0aW9fZ3B1X3F1ZXVlX2N1cnNv
cihzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogdm9pZCB2aXJ0aW9fZ3B1X2NtZF9j
cmVhdGVfcmVzb3VyY2Uoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKIAkJCQkgICAg
c3RydWN0IHZpcnRpb19ncHVfb2JqZWN0ICpibywKIAkJCQkgICAgc3RydWN0IHZpcnRpb19ncHVf
b2JqZWN0X3BhcmFtcyAqcGFyYW1zLAorCQkJCSAgICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3Rf
YXJyYXkgKm9ianMsCiAJCQkJICAgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSkKIHsK
IAlzdHJ1Y3QgdmlydGlvX2dwdV9yZXNvdXJjZV9jcmVhdGVfMmQgKmNtZF9wOwpAQCAtNDAzLDYg
KzQwNCw3IEBAIHZvaWQgdmlydGlvX2dwdV9jbWRfY3JlYXRlX3Jlc291cmNlKHN0cnVjdCB2aXJ0
aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAKIAljbWRfcCA9IHZpcnRpb19ncHVfYWxsb2NfY21kKHZn
ZGV2LCAmdmJ1Ziwgc2l6ZW9mKCpjbWRfcCkpOwogCW1lbXNldChjbWRfcCwgMCwgc2l6ZW9mKCpj
bWRfcCkpOworCXZidWYtPm9ianMgPSBvYmpzOwogCiAJY21kX3AtPmhkci50eXBlID0gY3B1X3Rv
X2xlMzIoVklSVElPX0dQVV9DTURfUkVTT1VSQ0VfQ1JFQVRFXzJEKTsKIAljbWRfcC0+cmVzb3Vy
Y2VfaWQgPSBjcHVfdG9fbGUzMihiby0+aHdfcmVzX2hhbmRsZSk7CkBAIC04NjksNiArODcxLDcg
QEAgdm9pZAogdmlydGlvX2dwdV9jbWRfcmVzb3VyY2VfY3JlYXRlXzNkKHN0cnVjdCB2aXJ0aW9f
Z3B1X2RldmljZSAqdmdkZXYsCiAJCQkJICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3QgKmJvLAog
CQkJCSAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0X3BhcmFtcyAqcGFyYW1zLAorCQkJCSAgc3Ry
dWN0IHZpcnRpb19ncHVfb2JqZWN0X2FycmF5ICpvYmpzLAogCQkJCSAgc3RydWN0IHZpcnRpb19n
cHVfZmVuY2UgKmZlbmNlKQogewogCXN0cnVjdCB2aXJ0aW9fZ3B1X3Jlc291cmNlX2NyZWF0ZV8z
ZCAqY21kX3A7CkBAIC04NzYsNiArODc5LDcgQEAgdmlydGlvX2dwdV9jbWRfcmVzb3VyY2VfY3Jl
YXRlXzNkKHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAKIAljbWRfcCA9IHZpcnRp
b19ncHVfYWxsb2NfY21kKHZnZGV2LCAmdmJ1Ziwgc2l6ZW9mKCpjbWRfcCkpOwogCW1lbXNldChj
bWRfcCwgMCwgc2l6ZW9mKCpjbWRfcCkpOworCXZidWYtPm9ianMgPSBvYmpzOwogCiAJY21kX3At
Pmhkci50eXBlID0gY3B1X3RvX2xlMzIoVklSVElPX0dQVV9DTURfUkVTT1VSQ0VfQ1JFQVRFXzNE
KTsKIAljbWRfcC0+cmVzb3VyY2VfaWQgPSBjcHVfdG9fbGUzMihiby0+aHdfcmVzX2hhbmRsZSk7
Ci0tIAoyLjE4LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9y
ZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZl
bA==
