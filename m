Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id BE9A2D9039
	for <lists+dri-devel@lfdr.de>; Wed, 16 Oct 2019 13:59:35 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8D2F86E955;
	Wed, 16 Oct 2019 11:59:31 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wm1-x344.google.com (mail-wm1-x344.google.com
 [IPv6:2a00:1450:4864:20::344])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2BBC66E952
 for <dri-devel@lists.freedesktop.org>; Wed, 16 Oct 2019 11:59:27 +0000 (UTC)
Received: by mail-wm1-x344.google.com with SMTP id p7so2601924wmp.4
 for <dri-devel@lists.freedesktop.org>; Wed, 16 Oct 2019 04:59:27 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=p+D4uhaelqukiSJFoBgIs3xWgRBrX60LgMxJcjnSOSs=;
 b=EdpdsUob6vz6ReEqyKhbSDFiwFUlgWsV42ZlL9VyuRFt16MV/YQFGOPtrryNr78k8V
 +lZOi00hdOeWSy3OqWa4I5/7UjpdreH/ASYkAPpz/xm2vyJXvWzox4vb0KOXZqU/tNjN
 203uX9DlrhQIDIVZxlHH4Vg7+hsaaF016VsGyXQIe3lvAwDsl4dDJkoQ02A96nM0a/oW
 T6SF0G201ERzPOhG7GW3TCGzYMzRFX6LhdFWPCJDJYPEYuWPuTMjKj6P0xoSKhuySBdC
 xAFLva1IOnE8rLWpAIJ6mnfAS/mBrZ+X/84E7v5jAr9TPEVvVrREtkhbhsCdUnylpb1i
 ByRA==
X-Gm-Message-State: APjAAAV/cXB2QxeF30b+INsB0bOIo91DI+wU8+xZZjok9TAbZBS7QpSO
 tvP8uh/WaCuupmbQjxKvby8=
X-Google-Smtp-Source: APXvYqzRUGxDcp7LWWmdWGph1uiXiblMz981jNsxK16gU4VflPBXtPUaX7qhH81GVn+j+daDV2zUjw==
X-Received: by 2002:a7b:c775:: with SMTP id x21mr3253109wmk.52.1571227165283; 
 Wed, 16 Oct 2019 04:59:25 -0700 (PDT)
Received: from localhost (p2E5BE2CE.dip0.t-ipconnect.de. [46.91.226.206])
 by smtp.gmail.com with ESMTPSA id f143sm3892448wme.40.2019.10.16.04.59.24
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Wed, 16 Oct 2019 04:59:24 -0700 (PDT)
From: Thierry Reding <thierry.reding@gmail.com>
To: Thierry Reding <thierry.reding@gmail.com>
Subject: [PATCH 4/8] gpu: host1x: Set DMA mask based on IOMMU setup
Date: Wed, 16 Oct 2019 13:59:12 +0200
Message-Id: <20191016115916.1769133-4-thierry.reding@gmail.com>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191016115916.1769133-1-thierry.reding@gmail.com>
References: <20191016115916.1769133-1-thierry.reding@gmail.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=p+D4uhaelqukiSJFoBgIs3xWgRBrX60LgMxJcjnSOSs=;
 b=IduVgptCmf9YNqd92wwi+BS/zpgwmOt6fcGIZEREbguHJtPnhJ/KnNdHjfeGD59X9D
 OOzS1SxkJ1msvOeOpNPnsWRPUC4UdjAlLjD2bGDWOQ7bUVqLQ33Fz+oeZASpxbdHl0AT
 h/esgCVOmkMXKfgZd7qsmvOweR7PytYO9QRlbP/1xIaacXUS9FK4/0vQ3UloOm04vfEY
 aj3fOcXbWaJCgkKlDJNFl5EBnSh+ZdCbZxjr8TvenA8liebjGFxGTKdX94prPwo16ekW
 C70AC4ut/fWewmOD1NAZnr4Wudnj+m585Wkdm7eX4DgQsENfec/SaZ5ZE+WaUByLOq3z
 1PDQ==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: linux-tegra@vger.kernel.org, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogVGhpZXJyeSBSZWRpbmcgPHRyZWRpbmdAbnZpZGlhLmNvbT4KCklmIHRoZSBUZWdyYSBE
Uk0gY2xpZW50cyBhcmUgYmFja2VkIGJ5IGFuIElPTU1VLCBwdXNoIGJ1ZmZlcnMgYXJlIGxpa2Vs
eQp0byBiZSBhbGxvY2F0ZWQgYmV5b25kIHRoZSAzMi1iaXQgYm91bmRhcnkgaWYgc3VmZmljaWVu
dCBzeXN0ZW0gbWVtb3J5CmlzIGF2YWlsYWJsZS4gVGhpcyBpcyBwcm9ibGVtYXRpYyBvbiBlYXJs
aWVyIGdlbmVyYXRpb25zIG9mIFRlZ3JhIHdoZXJlCmhvc3QxeCBzdXBwb3J0cyBhIG1heGltdW0g
b2YgMzIgYWRkcmVzcyBiaXRzIGZvciB0aGUgR0FUSEVSIG9wY29kZS4gTW9yZQpyZWNlbnQgdmVy
c2lvbnMgb2YgVGVncmEgKFRlZ3JhMTg2IGFuZCBsYXRlcikgaGF2ZSBhIHdpZGUgdmFyaWFudCBv
ZiB0aGUKR0FUSEVSIG9wY29kZSwgd2hpY2ggYWxsb3dzIGFkZHJlc3NpbmcgdXAgdG8gNjQgYml0
cyBvZiBtZW1vcnkuCgpJZiBob3N0MXggaXRzZWxmIGlzIGJlaGluZCBhbiBJT01NVSBhcyB3ZWxs
IHRoaXMgZG9lc24ndCBtYXR0ZXIgYmVjYXVzZQp0aGUgSU9NTVUncyBpbnB1dCBhZGRyZXNzIHNw
YWNlIGlzIHJlc3RyaWN0ZWQgdG8gMzIgYml0cyBvbiBnZW5lcmF0aW9ucwp3aXRob3V0IHN1cHBv
cnQgZm9yIHdpZGUgR0FUSEVSIG9wY29kZXMuCgpIb3dldmVyLCBpZiBob3N0MXggaXMgbm90IGJl
aGluZCBhbiBJT01NVSwgaXQgd29uJ3QgYmUgYWJsZSB0byBwcm9jZXNzCnB1c2ggYnVmZmVycyBi
ZXlvbmQgdGhlIDMyLWJpdCBib3VuZGFyeSBvbiBUZWdyYSBnZW5lcmF0aW9ucyB0aGF0IGRvbid0
CnN1cHBvcnQgd2lkZSBHQVRIRVIgb3Bjb2Rlcy4gUmVzdHJpY3QgdGhlIERNQSBtYXNrIHRvIDMy
IGJpdHMgb24gdGhlc2UKZ2VuZXJhdGlvbnMgcHJldmVudHMgYnVmZmVycyBmcm9tIGJlaW5nIGFs
bG9jYXRlZCBmcm9tIGJleW9uZCB0aGUgMzItYml0CmJvdW5kYXJ5LgoKU2lnbmVkLW9mZi1ieTog
VGhpZXJyeSBSZWRpbmcgPHRyZWRpbmdAbnZpZGlhLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9ob3N0
MXgvZGV2LmMgfCAyMTQgKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tCiBk
cml2ZXJzL2dwdS9ob3N0MXgvZGV2LmggfCAgIDEgKwogMiBmaWxlcyBjaGFuZ2VkLCAxMzYgaW5z
ZXJ0aW9ucygrKSwgNzkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvaG9z
dDF4L2Rldi5jIGIvZHJpdmVycy9ncHUvaG9zdDF4L2Rldi5jCmluZGV4IDE4YjZmYzVlNWIyZS4u
YTg2NDc4NTA4YzkxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9ob3N0MXgvZGV2LmMKKysrIGIv
ZHJpdmVycy9ncHUvaG9zdDF4L2Rldi5jCkBAIC03Myw2ICs3Myw3IEBAIHN0YXRpYyBjb25zdCBz
dHJ1Y3QgaG9zdDF4X2luZm8gaG9zdDF4MDFfaW5mbyA9IHsKIAkuaW5pdCA9IGhvc3QxeDAxX2lu
aXQsCiAJLnN5bmNfb2Zmc2V0ID0gMHgzMDAwLAogCS5kbWFfbWFzayA9IERNQV9CSVRfTUFTSygz
MiksCisJLmhhc193aWRlX2dhdGhlciA9IGZhbHNlLAogCS5oYXNfaHlwZXJ2aXNvciA9IGZhbHNl
LAogCS5udW1fc2lkX2VudHJpZXMgPSAwLAogCS5zaWRfdGFibGUgPSBOVUxMLApAQCAtODYsNiAr
ODcsNyBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IGhvc3QxeF9pbmZvIGhvc3QxeDAyX2luZm8gPSB7
CiAJLmluaXQgPSBob3N0MXgwMl9pbml0LAogCS5zeW5jX29mZnNldCA9IDB4MzAwMCwKIAkuZG1h
X21hc2sgPSBETUFfQklUX01BU0soMzIpLAorCS5oYXNfd2lkZV9nYXRoZXIgPSBmYWxzZSwKIAku
aGFzX2h5cGVydmlzb3IgPSBmYWxzZSwKIAkubnVtX3NpZF9lbnRyaWVzID0gMCwKIAkuc2lkX3Rh
YmxlID0gTlVMTCwKQEAgLTk5LDYgKzEwMSw3IEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3QgaG9zdDF4
X2luZm8gaG9zdDF4MDRfaW5mbyA9IHsKIAkuaW5pdCA9IGhvc3QxeDA0X2luaXQsCiAJLnN5bmNf
b2Zmc2V0ID0gMHgyMTAwLAogCS5kbWFfbWFzayA9IERNQV9CSVRfTUFTSygzNCksCisJLmhhc193
aWRlX2dhdGhlciA9IGZhbHNlLAogCS5oYXNfaHlwZXJ2aXNvciA9IGZhbHNlLAogCS5udW1fc2lk
X2VudHJpZXMgPSAwLAogCS5zaWRfdGFibGUgPSBOVUxMLApAQCAtMTEyLDYgKzExNSw3IEBAIHN0
YXRpYyBjb25zdCBzdHJ1Y3QgaG9zdDF4X2luZm8gaG9zdDF4MDVfaW5mbyA9IHsKIAkuaW5pdCA9
IGhvc3QxeDA1X2luaXQsCiAJLnN5bmNfb2Zmc2V0ID0gMHgyMTAwLAogCS5kbWFfbWFzayA9IERN
QV9CSVRfTUFTSygzNCksCisJLmhhc193aWRlX2dhdGhlciA9IGZhbHNlLAogCS5oYXNfaHlwZXJ2
aXNvciA9IGZhbHNlLAogCS5udW1fc2lkX2VudHJpZXMgPSAwLAogCS5zaWRfdGFibGUgPSBOVUxM
LApAQCAtMTM0LDYgKzEzOCw3IEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3QgaG9zdDF4X2luZm8gaG9z
dDF4MDZfaW5mbyA9IHsKIAkuaW5pdCA9IGhvc3QxeDA2X2luaXQsCiAJLnN5bmNfb2Zmc2V0ID0g
MHgwLAogCS5kbWFfbWFzayA9IERNQV9CSVRfTUFTSyg0MCksCisJLmhhc193aWRlX2dhdGhlciA9
IHRydWUsCiAJLmhhc19oeXBlcnZpc29yID0gdHJ1ZSwKIAkubnVtX3NpZF9lbnRyaWVzID0gQVJS
QVlfU0laRSh0ZWdyYTE4Nl9zaWRfdGFibGUpLAogCS5zaWRfdGFibGUgPSB0ZWdyYTE4Nl9zaWRf
dGFibGUsCkBAIC0xNTYsNiArMTYxLDcgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBob3N0MXhfaW5m
byBob3N0MXgwN19pbmZvID0gewogCS5pbml0ID0gaG9zdDF4MDdfaW5pdCwKIAkuc3luY19vZmZz
ZXQgPSAweDAsCiAJLmRtYV9tYXNrID0gRE1BX0JJVF9NQVNLKDQwKSwKKwkuaGFzX3dpZGVfZ2F0
aGVyID0gdHJ1ZSwKIAkuaGFzX2h5cGVydmlzb3IgPSB0cnVlLAogCS5udW1fc2lkX2VudHJpZXMg
PSBBUlJBWV9TSVpFKHRlZ3JhMTk0X3NpZF90YWJsZSksCiAJLnNpZF90YWJsZSA9IHRlZ3JhMTk0
X3NpZF90YWJsZSwKQEAgLTE4Niw2ICsxOTIsMTE3IEBAIHN0YXRpYyB2b2lkIGhvc3QxeF9zZXR1
cF9zaWRfdGFibGUoc3RydWN0IGhvc3QxeCAqaG9zdCkKIAl9CiB9CiAKK3N0YXRpYyBzdHJ1Y3Qg
aW9tbXVfZG9tYWluICpob3N0MXhfaW9tbXVfYXR0YWNoKHN0cnVjdCBob3N0MXggKmhvc3QpCit7
CisJc3RydWN0IGlvbW11X2RvbWFpbiAqZG9tYWluID0gaW9tbXVfZ2V0X2RvbWFpbl9mb3JfZGV2
KGhvc3QtPmRldik7CisJaW50IGVycjsKKworCS8qCisJICogSWYgdGhlIGhvc3QxeCBmaXJld2Fs
bCBpcyBlbmFibGVkLCB0aGVyZSdzIG5vIG5lZWQgdG8gZW5hYmxlIElPTU1VCisJICogc3VwcG9y
dC4gU2ltaWxhcmx5LCBpZiBob3N0MXggaXMgYWxyZWFkeSBhdHRhY2hlZCB0byBhbiBJT01NVSAo
dmlhCisJICogdGhlIERNQSBBUEkpLCBkb24ndCB0cnkgdG8gYXR0YWNoIGFnYWluLgorCSAqLwor
CWlmIChJU19FTkFCTEVEKENPTkZJR19URUdSQV9IT1NUMVhfRklSRVdBTEwpIHx8IGRvbWFpbikK
KwkJcmV0dXJuIGRvbWFpbjsKKworCWhvc3QtPmdyb3VwID0gaW9tbXVfZ3JvdXBfZ2V0KGhvc3Qt
PmRldik7CisJaWYgKGhvc3QtPmdyb3VwKSB7CisJCXN0cnVjdCBpb21tdV9kb21haW5fZ2VvbWV0
cnkgKmdlb21ldHJ5OworCQlkbWFfYWRkcl90IHN0YXJ0LCBlbmQ7CisJCXVuc2lnbmVkIGxvbmcg
b3JkZXI7CisKKwkJZXJyID0gaW92YV9jYWNoZV9nZXQoKTsKKwkJaWYgKGVyciA8IDApCisJCQln
b3RvIHB1dF9ncm91cDsKKworCQlob3N0LT5kb21haW4gPSBpb21tdV9kb21haW5fYWxsb2MoJnBs
YXRmb3JtX2J1c190eXBlKTsKKwkJaWYgKCFob3N0LT5kb21haW4pIHsKKwkJCWVyciA9IC1FTk9N
RU07CisJCQlnb3RvIHB1dF9jYWNoZTsKKwkJfQorCisJCWVyciA9IGlvbW11X2F0dGFjaF9ncm91
cChob3N0LT5kb21haW4sIGhvc3QtPmdyb3VwKTsKKwkJaWYgKGVycikgeworCQkJaWYgKGVyciA9
PSAtRU5PREVWKQorCQkJCWVyciA9IDA7CisKKwkJCWdvdG8gZnJlZV9kb21haW47CisJCX0KKwor
CQlnZW9tZXRyeSA9ICZob3N0LT5kb21haW4tPmdlb21ldHJ5OworCQlzdGFydCA9IGdlb21ldHJ5
LT5hcGVydHVyZV9zdGFydCAmIGhvc3QtPmluZm8tPmRtYV9tYXNrOworCQllbmQgPSBnZW9tZXRy
eS0+YXBlcnR1cmVfZW5kICYgaG9zdC0+aW5mby0+ZG1hX21hc2s7CisKKwkJb3JkZXIgPSBfX2Zm
cyhob3N0LT5kb21haW4tPnBnc2l6ZV9iaXRtYXApOworCQlpbml0X2lvdmFfZG9tYWluKCZob3N0
LT5pb3ZhLCAxVUwgPDwgb3JkZXIsIHN0YXJ0ID4+IG9yZGVyKTsKKwkJaG9zdC0+aW92YV9lbmQg
PSBlbmQ7CisKKwkJZG9tYWluID0gaG9zdC0+ZG9tYWluOworCX0KKworCXJldHVybiBkb21haW47
CisKK2ZyZWVfZG9tYWluOgorCWlvbW11X2RvbWFpbl9mcmVlKGhvc3QtPmRvbWFpbik7CisJaG9z
dC0+ZG9tYWluID0gTlVMTDsKK3B1dF9jYWNoZToKKwlpb3ZhX2NhY2hlX3B1dCgpOworcHV0X2dy
b3VwOgorCWlvbW11X2dyb3VwX3B1dChob3N0LT5ncm91cCk7CisJaG9zdC0+Z3JvdXAgPSBOVUxM
OworCisJcmV0dXJuIEVSUl9QVFIoZXJyKTsKK30KKworc3RhdGljIGludCBob3N0MXhfaW9tbXVf
aW5pdChzdHJ1Y3QgaG9zdDF4ICpob3N0KQoreworCXU2NCBtYXNrID0gaG9zdC0+aW5mby0+ZG1h
X21hc2s7CisJc3RydWN0IGlvbW11X2RvbWFpbiAqZG9tYWluOworCWludCBlcnI7CisKKwlkb21h
aW4gPSBob3N0MXhfaW9tbXVfYXR0YWNoKGhvc3QpOworCWlmIChJU19FUlIoZG9tYWluKSkgewor
CQllcnIgPSBQVFJfRVJSKGRvbWFpbik7CisJCWRldl9lcnIoaG9zdC0+ZGV2LCAiZmFpbGVkIHRv
IGF0dGFjaCB0byBJT01NVTogJWRcbiIsIGVycik7CisJCXJldHVybiBlcnI7CisJfQorCisJLyoK
KwkgKiBJZiB3ZSdyZSBub3QgYmVoaW5kIGFuIElPTU1VIG1ha2Ugc3VyZSB3ZSBkb24ndCBnZXQg
cHVzaCBidWZmZXJzCisJICogdGhhdCBhcmUgYWxsb2NhdGVkIG91dHNpZGUgb2YgdGhlIHJhbmdl
IGFkZHJlc3NhYmxlIGJ5IHRoZSBHQVRIRVIKKwkgKiBvcGNvZGUuCisJICoKKwkgKiBOZXdlciBn
ZW5lcmF0aW9ucyBvZiBUZWdyYSAoVGVncmExODYgYW5kIGxhdGVyKSBzdXBwb3J0IGEgd2lkZQor
CSAqIHZhcmlhbnQgb2YgdGhlIEdBVEhFUiBvcGNvZGUgdGhhdCBhbGxvd3MgYWRkcmVzc2luZyBt
b3JlIGJpdHMuCisJICovCisJaWYgKCFkb21haW4gJiYgIWhvc3QtPmluZm8tPmhhc193aWRlX2dh
dGhlcikKKwkJbWFzayA9IERNQV9CSVRfTUFTSygzMik7CisKKwllcnIgPSBkbWFfY29lcmNlX21h
c2tfYW5kX2NvaGVyZW50KGhvc3QtPmRldiwgbWFzayk7CisJaWYgKGVyciA8IDApIHsKKwkJZGV2
X2Vycihob3N0LT5kZXYsICJmYWlsZWQgdG8gc2V0IERNQSBtYXNrOiAlZFxuIiwgZXJyKTsKKwkJ
cmV0dXJuIGVycjsKKwl9CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIHZvaWQgaG9zdDF4X2lv
bW11X2V4aXQoc3RydWN0IGhvc3QxeCAqaG9zdCkKK3sKKwlpZiAoaG9zdC0+ZG9tYWluKSB7CisJ
CXB1dF9pb3ZhX2RvbWFpbigmaG9zdC0+aW92YSk7CisJCWlvbW11X2RldGFjaF9ncm91cChob3N0
LT5kb21haW4sIGhvc3QtPmdyb3VwKTsKKworCQlpb21tdV9kb21haW5fZnJlZShob3N0LT5kb21h
aW4pOworCQlob3N0LT5kb21haW4gPSBOVUxMOworCisJCWlvdmFfY2FjaGVfcHV0KCk7CisKKwkJ
aW9tbXVfZ3JvdXBfcHV0KGhvc3QtPmdyb3VwKTsKKwkJaG9zdC0+Z3JvdXAgPSBOVUxMOworCX0K
K30KKwogc3RhdGljIGludCBob3N0MXhfcHJvYmUoc3RydWN0IHBsYXRmb3JtX2RldmljZSAqcGRl
dikKIHsKIAlzdHJ1Y3QgaG9zdDF4ICpob3N0OwpAQCAtMjQ1LDggKzM2Miw2IEBAIHN0YXRpYyBp
bnQgaG9zdDF4X3Byb2JlKHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYpCiAJCQlyZXR1cm4g
UFRSX0VSUihob3N0LT5odl9yZWdzKTsKIAl9CiAKLQlkbWFfc2V0X21hc2tfYW5kX2NvaGVyZW50
KGhvc3QtPmRldiwgaG9zdC0+aW5mby0+ZG1hX21hc2spOwotCiAJaWYgKGhvc3QtPmluZm8tPmlu
aXQpIHsKIAkJZXJyID0gaG9zdC0+aW5mby0+aW5pdChob3N0KTsKIAkJaWYgKGVycikKQEAgLTI3
MCw4MiArMzg1LDQxIEBAIHN0YXRpYyBpbnQgaG9zdDF4X3Byb2JlKHN0cnVjdCBwbGF0Zm9ybV9k
ZXZpY2UgKnBkZXYpCiAJCXJldHVybiBlcnI7CiAJfQogCi0JaWYgKElTX0VOQUJMRUQoQ09ORklH
X1RFR1JBX0hPU1QxWF9GSVJFV0FMTCkpCi0JCWdvdG8gc2tpcF9pb21tdTsKLQotCWlmIChpb21t
dV9nZXRfZG9tYWluX2Zvcl9kZXYoJnBkZXYtPmRldikpCi0JCWdvdG8gc2tpcF9pb21tdTsKLQot
CWhvc3QtPmdyb3VwID0gaW9tbXVfZ3JvdXBfZ2V0KCZwZGV2LT5kZXYpOwotCWlmIChob3N0LT5n
cm91cCkgewotCQlzdHJ1Y3QgaW9tbXVfZG9tYWluX2dlb21ldHJ5ICpnZW9tZXRyeTsKLQkJdTY0
IG1hc2sgPSBkbWFfZ2V0X21hc2soaG9zdC0+ZGV2KTsKLQkJZG1hX2FkZHJfdCBzdGFydCwgZW5k
OwotCQl1bnNpZ25lZCBsb25nIG9yZGVyOwotCi0JCWVyciA9IGlvdmFfY2FjaGVfZ2V0KCk7Ci0J
CWlmIChlcnIgPCAwKQotCQkJZ290byBwdXRfZ3JvdXA7Ci0KLQkJaG9zdC0+ZG9tYWluID0gaW9t
bXVfZG9tYWluX2FsbG9jKCZwbGF0Zm9ybV9idXNfdHlwZSk7Ci0JCWlmICghaG9zdC0+ZG9tYWlu
KSB7Ci0JCQllcnIgPSAtRU5PTUVNOwotCQkJZ290byBwdXRfY2FjaGU7Ci0JCX0KLQotCQllcnIg
PSBpb21tdV9hdHRhY2hfZ3JvdXAoaG9zdC0+ZG9tYWluLCBob3N0LT5ncm91cCk7Ci0JCWlmIChl
cnIpIHsKLQkJCWlmIChlcnIgPT0gLUVOT0RFVikgewotCQkJCWlvbW11X2RvbWFpbl9mcmVlKGhv
c3QtPmRvbWFpbik7Ci0JCQkJaG9zdC0+ZG9tYWluID0gTlVMTDsKLQkJCQlpb3ZhX2NhY2hlX3B1
dCgpOwotCQkJCWlvbW11X2dyb3VwX3B1dChob3N0LT5ncm91cCk7Ci0JCQkJaG9zdC0+Z3JvdXAg
PSBOVUxMOwotCQkJCWdvdG8gc2tpcF9pb21tdTsKLQkJCX0KLQotCQkJZ290byBmYWlsX2ZyZWVf
ZG9tYWluOwotCQl9Ci0KLQkJZ2VvbWV0cnkgPSAmaG9zdC0+ZG9tYWluLT5nZW9tZXRyeTsKLQkJ
c3RhcnQgPSBnZW9tZXRyeS0+YXBlcnR1cmVfc3RhcnQgJiBtYXNrOwotCQllbmQgPSBnZW9tZXRy
eS0+YXBlcnR1cmVfZW5kICYgbWFzazsKLQotCQlvcmRlciA9IF9fZmZzKGhvc3QtPmRvbWFpbi0+
cGdzaXplX2JpdG1hcCk7Ci0JCWluaXRfaW92YV9kb21haW4oJmhvc3QtPmlvdmEsIDFVTCA8PCBv
cmRlciwgc3RhcnQgPj4gb3JkZXIpOwotCQlob3N0LT5pb3ZhX2VuZCA9IGVuZDsKKwllcnIgPSBo
b3N0MXhfaW9tbXVfaW5pdChob3N0KTsKKwlpZiAoZXJyIDwgMCkgeworCQlkZXZfZXJyKCZwZGV2
LT5kZXYsICJmYWlsZWQgdG8gc2V0dXAgSU9NTVU6ICVkXG4iLCBlcnIpOworCQlyZXR1cm4gZXJy
OwogCX0KIAotc2tpcF9pb21tdToKIAllcnIgPSBob3N0MXhfY2hhbm5lbF9saXN0X2luaXQoJmhv
c3QtPmNoYW5uZWxfbGlzdCwKIAkJCQkgICAgICAgaG9zdC0+aW5mby0+bmJfY2hhbm5lbHMpOwog
CWlmIChlcnIpIHsKIAkJZGV2X2VycigmcGRldi0+ZGV2LCAiZmFpbGVkIHRvIGluaXRpYWxpemUg
Y2hhbm5lbCBsaXN0XG4iKTsKLQkJZ290byBmYWlsX2RldGFjaF9kZXZpY2U7CisJCWdvdG8gaW9t
bXVfZXhpdDsKIAl9CiAKIAllcnIgPSBjbGtfcHJlcGFyZV9lbmFibGUoaG9zdC0+Y2xrKTsKIAlp
ZiAoZXJyIDwgMCkgewogCQlkZXZfZXJyKCZwZGV2LT5kZXYsICJmYWlsZWQgdG8gZW5hYmxlIGNs
b2NrXG4iKTsKLQkJZ290byBmYWlsX2ZyZWVfY2hhbm5lbHM7CisJCWdvdG8gZnJlZV9jaGFubmVs
czsKIAl9CiAKIAllcnIgPSByZXNldF9jb250cm9sX2RlYXNzZXJ0KGhvc3QtPnJzdCk7CiAJaWYg
KGVyciA8IDApIHsKIAkJZGV2X2VycigmcGRldi0+ZGV2LCAiZmFpbGVkIHRvIGRlYXNzZXJ0IHJl
c2V0OiAlZFxuIiwgZXJyKTsKLQkJZ290byBmYWlsX3VucHJlcGFyZV9kaXNhYmxlOworCQlnb3Rv
IHVucHJlcGFyZV9kaXNhYmxlOwogCX0KIAogCWVyciA9IGhvc3QxeF9zeW5jcHRfaW5pdChob3N0
KTsKIAlpZiAoZXJyKSB7CiAJCWRldl9lcnIoJnBkZXYtPmRldiwgImZhaWxlZCB0byBpbml0aWFs
aXplIHN5bmNwdHNcbiIpOwotCQlnb3RvIGZhaWxfcmVzZXRfYXNzZXJ0OworCQlnb3RvIHJlc2V0
X2Fzc2VydDsKIAl9CiAKIAllcnIgPSBob3N0MXhfaW50cl9pbml0KGhvc3QsIHN5bmNwdF9pcnEp
OwogCWlmIChlcnIpIHsKIAkJZGV2X2VycigmcGRldi0+ZGV2LCAiZmFpbGVkIHRvIGluaXRpYWxp
emUgaW50ZXJydXB0c1xuIik7Ci0JCWdvdG8gZmFpbF9kZWluaXRfc3luY3B0OworCQlnb3RvIGRl
aW5pdF9zeW5jcHQ7CiAJfQogCiAJaG9zdDF4X2RlYnVnX2luaXQoaG9zdCk7CkBAIC0zNTUsMzMg
KzQyOSwyMiBAQCBzdGF0aWMgaW50IGhvc3QxeF9wcm9iZShzdHJ1Y3QgcGxhdGZvcm1fZGV2aWNl
ICpwZGV2KQogCiAJZXJyID0gaG9zdDF4X3JlZ2lzdGVyKGhvc3QpOwogCWlmIChlcnIgPCAwKQot
CQlnb3RvIGZhaWxfZGVpbml0X2ludHI7CisJCWdvdG8gZGVpbml0X2ludHI7CiAKIAlyZXR1cm4g
MDsKIAotZmFpbF9kZWluaXRfaW50cjoKK2RlaW5pdF9pbnRyOgogCWhvc3QxeF9pbnRyX2RlaW5p
dChob3N0KTsKLWZhaWxfZGVpbml0X3N5bmNwdDoKK2RlaW5pdF9zeW5jcHQ6CiAJaG9zdDF4X3N5
bmNwdF9kZWluaXQoaG9zdCk7Ci1mYWlsX3Jlc2V0X2Fzc2VydDoKK3Jlc2V0X2Fzc2VydDoKIAly
ZXNldF9jb250cm9sX2Fzc2VydChob3N0LT5yc3QpOwotZmFpbF91bnByZXBhcmVfZGlzYWJsZToK
K3VucHJlcGFyZV9kaXNhYmxlOgogCWNsa19kaXNhYmxlX3VucHJlcGFyZShob3N0LT5jbGspOwot
ZmFpbF9mcmVlX2NoYW5uZWxzOgorZnJlZV9jaGFubmVsczoKIAlob3N0MXhfY2hhbm5lbF9saXN0
X2ZyZWUoJmhvc3QtPmNoYW5uZWxfbGlzdCk7Ci1mYWlsX2RldGFjaF9kZXZpY2U6Ci0JaWYgKGhv
c3QtPmdyb3VwICYmIGhvc3QtPmRvbWFpbikgewotCQlwdXRfaW92YV9kb21haW4oJmhvc3QtPmlv
dmEpOwotCQlpb21tdV9kZXRhY2hfZ3JvdXAoaG9zdC0+ZG9tYWluLCBob3N0LT5ncm91cCk7Ci0J
fQotZmFpbF9mcmVlX2RvbWFpbjoKLQlpZiAoaG9zdC0+ZG9tYWluKQotCQlpb21tdV9kb21haW5f
ZnJlZShob3N0LT5kb21haW4pOwotcHV0X2NhY2hlOgotCWlmIChob3N0LT5ncm91cCkKLQkJaW92
YV9jYWNoZV9wdXQoKTsKLXB1dF9ncm91cDoKLQlpb21tdV9ncm91cF9wdXQoaG9zdC0+Z3JvdXAp
OworaW9tbXVfZXhpdDoKKwlob3N0MXhfaW9tbXVfZXhpdChob3N0KTsKIAogCXJldHVybiBlcnI7
CiB9CkBAIC0zOTUsMTQgKzQ1OCw3IEBAIHN0YXRpYyBpbnQgaG9zdDF4X3JlbW92ZShzdHJ1Y3Qg
cGxhdGZvcm1fZGV2aWNlICpwZGV2KQogCWhvc3QxeF9zeW5jcHRfZGVpbml0KGhvc3QpOwogCXJl
c2V0X2NvbnRyb2xfYXNzZXJ0KGhvc3QtPnJzdCk7CiAJY2xrX2Rpc2FibGVfdW5wcmVwYXJlKGhv
c3QtPmNsayk7Ci0KLQlpZiAoaG9zdC0+ZG9tYWluKSB7Ci0JCXB1dF9pb3ZhX2RvbWFpbigmaG9z
dC0+aW92YSk7Ci0JCWlvbW11X2RldGFjaF9ncm91cChob3N0LT5kb21haW4sIGhvc3QtPmdyb3Vw
KTsKLQkJaW9tbXVfZG9tYWluX2ZyZWUoaG9zdC0+ZG9tYWluKTsKLQkJaW92YV9jYWNoZV9wdXQo
KTsKLQkJaW9tbXVfZ3JvdXBfcHV0KGhvc3QtPmdyb3VwKTsKLQl9CisJaG9zdDF4X2lvbW11X2V4
aXQoaG9zdCk7CiAKIAlyZXR1cm4gMDsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2hvc3Qx
eC9kZXYuaCBiL2RyaXZlcnMvZ3B1L2hvc3QxeC9kZXYuaAppbmRleCBmZjU2ZjVlMjNhMDIuLmUy
ZjFlMDU4M2IxYiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvaG9zdDF4L2Rldi5oCisrKyBiL2Ry
aXZlcnMvZ3B1L2hvc3QxeC9kZXYuaApAQCAtOTcsNiArOTcsNyBAQCBzdHJ1Y3QgaG9zdDF4X2lu
Zm8gewogCWludCAoKmluaXQpKHN0cnVjdCBob3N0MXggKmhvc3QxeCk7IC8qIGluaXRpYWxpemUg
cGVyIFNvQyBvcHMgKi8KIAl1bnNpZ25lZCBpbnQgc3luY19vZmZzZXQ7IC8qIG9mZnNldCBvZiBz
eW5jcG9pbnQgcmVnaXN0ZXJzICovCiAJdTY0IGRtYV9tYXNrOyAvKiBtYXNrIG9mIGFkZHJlc3Nh
YmxlIG1lbW9yeSAqLworCWJvb2wgaGFzX3dpZGVfZ2F0aGVyOyAvKiBzdXBwb3J0cyBHQVRIRVJf
VyBvcGNvZGUgKi8KIAlib29sIGhhc19oeXBlcnZpc29yOyAvKiBoYXMgaHlwZXJ2aXNvciByZWdp
c3RlcnMgKi8KIAl1bnNpZ25lZCBpbnQgbnVtX3NpZF9lbnRyaWVzOwogCWNvbnN0IHN0cnVjdCBo
b3N0MXhfc2lkX2VudHJ5ICpzaWRfdGFibGU7Ci0tIAoyLjIzLjAKCl9fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJp
LWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
