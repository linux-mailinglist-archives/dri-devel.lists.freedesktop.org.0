Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 225807DBBB
	for <lists+dri-devel@lfdr.de>; Thu,  1 Aug 2019 14:45:14 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 436876E5C4;
	Thu,  1 Aug 2019 12:45:11 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1828C6E5C0;
 Thu,  1 Aug 2019 12:45:08 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 17788111-1500050 
 for multiple; Thu, 01 Aug 2019 13:45:00 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Subject: [PATCH] Revert "drm/vgem: fix cache synchronization on arm/arm64"
Date: Thu,  1 Aug 2019 13:44:58 +0100
Message-Id: <20190801124458.24949-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc0
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Rob Clark <robdclark@chromium.org>, Daniel Vetter <daniel.vetter@ffwll.ch>,
 Sean Paul <seanpaul@chromium.org>, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

Y29tbWl0IDdlOWU1ZWFkNTViZSAoImRybS92Z2VtOiBmaXggY2FjaGUgc3luY2hyb25pemF0aW9u
IG9uIGFybS9hcm02NCIpCmJyb2tlIGFsbCBvZiB0aGUgIWxsYyBpOTE1LXZnZW0gY29oZXJlbmN5
IHRlc3RzIGluIENJLCBhbmQgbGVmdCB0aGUgSFcKdmVyeSwgdmVyeSB1bmhhcHB5ICh3aGljaCBp
cyBldmVuIG1vcmUgc2NhcnkpLgoKRml4ZXM6IDdlOWU1ZWFkNTViZSAoImRybS92Z2VtOiBmaXgg
Y2FjaGUgc3luY2hyb25pemF0aW9uIG9uIGFybS9hcm02NCIpClNpZ25lZC1vZmYtYnk6IENocmlz
IFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogRGFuaWVsIFZldHRlciA8ZGFu
aWVsLnZldHRlckBmZndsbC5jaD4KQ2M6IFJvYiBDbGFyayA8cm9iZGNsYXJrQGNocm9taXVtLm9y
Zz4KQ2M6IFNlYW4gUGF1bCA8c2VhbnBhdWxAY2hyb21pdW0ub3JnPgotLS0KIGRyaXZlcnMvZ3B1
L2RybS92Z2VtL3ZnZW1fZHJ2LmMgfCAxMzAgKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0t
LS0KIDEgZmlsZSBjaGFuZ2VkLCA0NyBpbnNlcnRpb25zKCspLCA4MyBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdmdlbS92Z2VtX2Rydi5jIGIvZHJpdmVycy9ncHUv
ZHJtL3ZnZW0vdmdlbV9kcnYuYwppbmRleCBiOTg2ODlmYjBkNWQuLjViZDYwZGVkM2Q4MSAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZnZW0vdmdlbV9kcnYuYworKysgYi9kcml2ZXJzL2dw
dS9kcm0vdmdlbS92Z2VtX2Rydi5jCkBAIC01NCwxNiArNTQsMTAgQEAgc3RhdGljIHN0cnVjdCB2
Z2VtX2RldmljZSB7CiAJc3RydWN0IHBsYXRmb3JtX2RldmljZSAqcGxhdGZvcm07CiB9ICp2Z2Vt
X2RldmljZTsKIAotc3RhdGljIHZvaWQgc3luY19hbmRfdW5waW4oc3RydWN0IGRybV92Z2VtX2dl
bV9vYmplY3QgKmJvKTsKLXN0YXRpYyBzdHJ1Y3QgcGFnZSAqKnBpbl9hbmRfc3luYyhzdHJ1Y3Qg
ZHJtX3ZnZW1fZ2VtX29iamVjdCAqYm8pOwotCiBzdGF0aWMgdm9pZCB2Z2VtX2dlbV9mcmVlX29i
amVjdChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaikKIHsKIAlzdHJ1Y3QgZHJtX3ZnZW1fZ2Vt
X29iamVjdCAqdmdlbV9vYmogPSB0b192Z2VtX2JvKG9iaik7CiAKLQlpZiAoIW9iai0+aW1wb3J0
X2F0dGFjaCkKLQkJc3luY19hbmRfdW5waW4odmdlbV9vYmopOwotCiAJa3ZmcmVlKHZnZW1fb2Jq
LT5wYWdlcyk7CiAJbXV0ZXhfZGVzdHJveSgmdmdlbV9vYmotPnBhZ2VzX2xvY2spOwogCkBAIC05
MSwxNSArODUsNDAgQEAgc3RhdGljIHZtX2ZhdWx0X3QgdmdlbV9nZW1fZmF1bHQoc3RydWN0IHZt
X2ZhdWx0ICp2bWYpCiAJCXJldHVybiBWTV9GQVVMVF9TSUdCVVM7CiAKIAltdXRleF9sb2NrKCZv
YmotPnBhZ2VzX2xvY2spOwotCWlmICghb2JqLT5wYWdlcykKLQkJcGluX2FuZF9zeW5jKG9iaik7
CiAJaWYgKG9iai0+cGFnZXMpIHsKIAkJZ2V0X3BhZ2Uob2JqLT5wYWdlc1twYWdlX29mZnNldF0p
OwogCQl2bWYtPnBhZ2UgPSBvYmotPnBhZ2VzW3BhZ2Vfb2Zmc2V0XTsKIAkJcmV0ID0gMDsKIAl9
CiAJbXV0ZXhfdW5sb2NrKCZvYmotPnBhZ2VzX2xvY2spOworCWlmIChyZXQpIHsKKwkJc3RydWN0
IHBhZ2UgKnBhZ2U7CisKKwkJcGFnZSA9IHNobWVtX3JlYWRfbWFwcGluZ19wYWdlKAorCQkJCQlm
aWxlX2lub2RlKG9iai0+YmFzZS5maWxwKS0+aV9tYXBwaW5nLAorCQkJCQlwYWdlX29mZnNldCk7
CisJCWlmICghSVNfRVJSKHBhZ2UpKSB7CisJCQl2bWYtPnBhZ2UgPSBwYWdlOworCQkJcmV0ID0g
MDsKKwkJfSBlbHNlIHN3aXRjaCAoUFRSX0VSUihwYWdlKSkgeworCQkJY2FzZSAtRU5PU1BDOgor
CQkJY2FzZSAtRU5PTUVNOgorCQkJCXJldCA9IFZNX0ZBVUxUX09PTTsKKwkJCQlicmVhazsKKwkJ
CWNhc2UgLUVCVVNZOgorCQkJCXJldCA9IFZNX0ZBVUxUX1JFVFJZOworCQkJCWJyZWFrOworCQkJ
Y2FzZSAtRUZBVUxUOgorCQkJY2FzZSAtRUlOVkFMOgorCQkJCXJldCA9IFZNX0ZBVUxUX1NJR0JV
UzsKKwkJCQlicmVhazsKKwkJCWRlZmF1bHQ6CisJCQkJV0FSTl9PTihQVFJfRVJSKHBhZ2UpKTsK
KwkJCQlyZXQgPSBWTV9GQVVMVF9TSUdCVVM7CisJCQkJYnJlYWs7CisJCX0KIAorCX0KIAlyZXR1
cm4gcmV0OwogfQogCkBAIC0yNjUsOTMgKzI4NCwzMiBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IGZp
bGVfb3BlcmF0aW9ucyB2Z2VtX2RyaXZlcl9mb3BzID0gewogCS5yZWxlYXNlCT0gZHJtX3JlbGVh
c2UsCiB9OwogCi0vKiBDYWxsZWQgdW5kZXIgcGFnZXNfbG9jaywgZXhjZXB0IGluIGZyZWUgcGF0
aCAod2hlcmUgaXQgY2FuJ3QgcmFjZSk6ICovCi1zdGF0aWMgdm9pZCBzeW5jX2FuZF91bnBpbihz
dHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqYm8pCi17Ci0Jc3RydWN0IGRybV9kZXZpY2UgKmRl
diA9IGJvLT5iYXNlLmRldjsKLQotCWlmIChiby0+dGFibGUpIHsKLQkJZG1hX3N5bmNfc2dfZm9y
X2NwdShkZXYtPmRldiwgYm8tPnRhYmxlLT5zZ2wsCi0JCQkJYm8tPnRhYmxlLT5uZW50cywgRE1B
X0JJRElSRUNUSU9OQUwpOwotCQlzZ19mcmVlX3RhYmxlKGJvLT50YWJsZSk7Ci0JCWtmcmVlKGJv
LT50YWJsZSk7Ci0JCWJvLT50YWJsZSA9IE5VTEw7Ci0JfQotCi0JaWYgKGJvLT5wYWdlcykgewot
CQlkcm1fZ2VtX3B1dF9wYWdlcygmYm8tPmJhc2UsIGJvLT5wYWdlcywgdHJ1ZSwgdHJ1ZSk7Ci0J
CWJvLT5wYWdlcyA9IE5VTEw7Ci0JfQotfQotCi1zdGF0aWMgc3RydWN0IHBhZ2UgKipwaW5fYW5k
X3N5bmMoc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvKQotewotCXN0cnVjdCBkcm1fZGV2
aWNlICpkZXYgPSBiby0+YmFzZS5kZXY7Ci0JaW50IG5wYWdlcyA9IGJvLT5iYXNlLnNpemUgPj4g
UEFHRV9TSElGVDsKLQlzdHJ1Y3QgcGFnZSAqKnBhZ2VzOwotCXN0cnVjdCBzZ190YWJsZSAqc2d0
OwotCi0JV0FSTl9PTighbXV0ZXhfaXNfbG9ja2VkKCZiby0+cGFnZXNfbG9jaykpOwotCi0JcGFn
ZXMgPSBkcm1fZ2VtX2dldF9wYWdlcygmYm8tPmJhc2UpOwotCWlmIChJU19FUlIocGFnZXMpKSB7
Ci0JCWJvLT5wYWdlc19waW5fY291bnQtLTsKLQkJbXV0ZXhfdW5sb2NrKCZiby0+cGFnZXNfbG9j
ayk7Ci0JCXJldHVybiBwYWdlczsKLQl9Ci0KLQlzZ3QgPSBkcm1fcHJpbWVfcGFnZXNfdG9fc2co
cGFnZXMsIG5wYWdlcyk7Ci0JaWYgKElTX0VSUihzZ3QpKSB7Ci0JCWRldl9lcnIoZGV2LT5kZXYs
Ci0JCQkiZmFpbGVkIHRvIGFsbG9jYXRlIHNndDogJWxkXG4iLAotCQkJUFRSX0VSUihiby0+dGFi
bGUpKTsKLQkJZHJtX2dlbV9wdXRfcGFnZXMoJmJvLT5iYXNlLCBwYWdlcywgZmFsc2UsIGZhbHNl
KTsKLQkJbXV0ZXhfdW5sb2NrKCZiby0+cGFnZXNfbG9jayk7Ci0JCXJldHVybiBFUlJfQ0FTVChi
by0+dGFibGUpOwotCX0KLQotCS8qCi0JICogRmx1c2ggdGhlIG9iamVjdCBmcm9tIHRoZSBDUFUg
Y2FjaGUgc28gdGhhdCBpbXBvcnRlcnMKLQkgKiBjYW4gcmVseSBvbiBjb2hlcmVudCBpbmRpcmVj
dCBhY2Nlc3MgdmlhIHRoZSBleHBvcnRlZAotCSAqIGRtYS1hZGRyZXNzLgotCSAqLwotCWRtYV9z
eW5jX3NnX2Zvcl9kZXZpY2UoZGV2LT5kZXYsIHNndC0+c2dsLAotCQkJc2d0LT5uZW50cywgRE1B
X0JJRElSRUNUSU9OQUwpOwotCi0JYm8tPnBhZ2VzID0gcGFnZXM7Ci0JYm8tPnRhYmxlID0gc2d0
OwotCi0JcmV0dXJuIHBhZ2VzOwotfQotCiBzdGF0aWMgc3RydWN0IHBhZ2UgKip2Z2VtX3Bpbl9w
YWdlcyhzdHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqYm8pCiB7Ci0Jc3RydWN0IHBhZ2UgKipw
YWdlczsKLQogCW11dGV4X2xvY2soJmJvLT5wYWdlc19sb2NrKTsKLQlpZiAoYm8tPnBhZ2VzX3Bp
bl9jb3VudCsrID09IDAgJiYgIWJvLT5wYWdlcykgewotCQlwYWdlcyA9IHBpbl9hbmRfc3luYyhi
byk7Ci0JfSBlbHNlIHsKLQkJV0FSTl9PTighYm8tPnBhZ2VzKTsKLQkJcGFnZXMgPSBiby0+cGFn
ZXM7CisJaWYgKGJvLT5wYWdlc19waW5fY291bnQrKyA9PSAwKSB7CisJCXN0cnVjdCBwYWdlICoq
cGFnZXM7CisKKwkJcGFnZXMgPSBkcm1fZ2VtX2dldF9wYWdlcygmYm8tPmJhc2UpOworCQlpZiAo
SVNfRVJSKHBhZ2VzKSkgeworCQkJYm8tPnBhZ2VzX3Bpbl9jb3VudC0tOworCQkJbXV0ZXhfdW5s
b2NrKCZiby0+cGFnZXNfbG9jayk7CisJCQlyZXR1cm4gcGFnZXM7CisJCX0KKworCQliby0+cGFn
ZXMgPSBwYWdlczsKIAl9CiAJbXV0ZXhfdW5sb2NrKCZiby0+cGFnZXNfbG9jayk7CiAKLQlyZXR1
cm4gcGFnZXM7CisJcmV0dXJuIGJvLT5wYWdlczsKIH0KIAogc3RhdGljIHZvaWQgdmdlbV91bnBp
bl9wYWdlcyhzdHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqYm8pCiB7Ci0JLyoKLQkgKiBXZSBz
aG91bGRuJ3QgaGl0IHRoaXMgZm9yIGltcG9ydGVkIGJvJ3MuLiBpbiB0aGUgaW1wb3J0Ci0JICog
Y2FzZSB3ZSBkb24ndCBvd24gdGhlIHNjYXR0ZXItdGFibGUKLQkgKi8KLQlXQVJOX09OKGJvLT5i
YXNlLmltcG9ydF9hdHRhY2gpOwotCiAJbXV0ZXhfbG9jaygmYm8tPnBhZ2VzX2xvY2spOwogCWlm
ICgtLWJvLT5wYWdlc19waW5fY291bnQgPT0gMCkgewotCQlXQVJOX09OKCFiby0+dGFibGUpOwot
CQlzeW5jX2FuZF91bnBpbihibyk7CisJCWRybV9nZW1fcHV0X3BhZ2VzKCZiby0+YmFzZSwgYm8t
PnBhZ2VzLCB0cnVlLCB0cnVlKTsKKwkJYm8tPnBhZ2VzID0gTlVMTDsKIAl9CiAJbXV0ZXhfdW5s
b2NrKCZiby0+cGFnZXNfbG9jayk7CiB9CkBAIC0zNTksMTIgKzMxNywxOCBAQCBzdGF0aWMgdm9p
ZCB2Z2VtX3VucGluX3BhZ2VzKHN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0ICpibykKIHN0YXRp
YyBpbnQgdmdlbV9wcmltZV9waW4oc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmopCiB7CiAJc3Ry
dWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvID0gdG9fdmdlbV9ibyhvYmopOworCWxvbmcgbl9w
YWdlcyA9IG9iai0+c2l6ZSA+PiBQQUdFX1NISUZUOwogCXN0cnVjdCBwYWdlICoqcGFnZXM7CiAK
IAlwYWdlcyA9IHZnZW1fcGluX3BhZ2VzKGJvKTsKIAlpZiAoSVNfRVJSKHBhZ2VzKSkKIAkJcmV0
dXJuIFBUUl9FUlIocGFnZXMpOwogCisJLyogRmx1c2ggdGhlIG9iamVjdCBmcm9tIHRoZSBDUFUg
Y2FjaGUgc28gdGhhdCBpbXBvcnRlcnMgY2FuIHJlbHkKKwkgKiBvbiBjb2hlcmVudCBpbmRpcmVj
dCBhY2Nlc3MgdmlhIHRoZSBleHBvcnRlZCBkbWEtYWRkcmVzcy4KKwkgKi8KKwlkcm1fY2xmbHVz
aF9wYWdlcyhwYWdlcywgbl9wYWdlcyk7CisKIAlyZXR1cm4gMDsKIH0KIAotLSAKMi4yMy4wLnJj
MAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRl
dmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
