Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 660637F80D
	for <lists+dri-devel@lfdr.de>; Fri,  2 Aug 2019 15:12:42 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 008C96EE12;
	Fri,  2 Aug 2019 13:12:34 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D99936EE0C
 for <dri-devel@lists.freedesktop.org>; Fri,  2 Aug 2019 13:12:31 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 5D01F3082132;
 Fri,  2 Aug 2019 13:12:31 +0000 (UTC)
Received: from sirius.home.kraxel.org (ovpn-116-81.ams2.redhat.com
 [10.36.116.81])
 by smtp.corp.redhat.com (Postfix) with ESMTP id CC0C05D704;
 Fri,  2 Aug 2019 13:12:30 +0000 (UTC)
Received: by sirius.home.kraxel.org (Postfix, from userid 1000)
 id 200EC9D11; Fri,  2 Aug 2019 15:12:27 +0200 (CEST)
From: Gerd Hoffmann <kraxel@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v7 09/18] drm/virtio: rework virtio_gpu_object_create fencing
Date: Fri,  2 Aug 2019 15:12:16 +0200
Message-Id: <20190802131225.17760-10-kraxel@redhat.com>
In-Reply-To: <20190802131225.17760-1-kraxel@redhat.com>
References: <20190802131225.17760-1-kraxel@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.42]); Fri, 02 Aug 2019 13:12:31 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, open list <linux-kernel@vger.kernel.org>,
 "open list:VIRTIO GPU DRIVER" <virtualization@lists.linux-foundation.org>,
 Gerd Hoffmann <kraxel@redhat.com>, gurchetansingh@chromium.org
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

UmV3b3JrIGZlbmNpbmcgd29ya2Zsb3cuICBTdG9wIHVzaW5nIHR0bSBoZWxwZXJzLCB1c2UgdGhl
CnZpcnRpb19ncHVfYXJyYXlfKiBoZWxwZXJzIGluc3RlYWQuCgpEdWUgdG8gdXNpbmcgdGhlIGdl
bSByZXNlcnZhdGlvbiBvYmplY3QgaXQgaXMgaW5pdGlhbGl6ZWQgYW5kIHJlYWR5IGZvcgp1c2Ug
YmVmb3JlIGNhbGxpbmcgdHRtX2JvX2luaXQuICBTbyB3ZSBjYW4gc2ltcGx5IHVzZSB0aGUgc3Rh
bmRhcmQKZmVuY2luZyB3b3JrZmxvdyBhbmQgZHJvcCB0aGUgdHJpY2t5IGxvZ2ljIHdoaWNoIGNo
ZWNrcyB3aGVuZXZlciB0aGUKY29tbWFuZCBpcyBpbiBmbGlnaHQgc3RpbGwuCgp2NjogcmV3cml0
ZSBtb3N0IG9mIHRoZSBwYXRjaC4KClNpZ25lZC1vZmYtYnk6IEdlcmQgSG9mZm1hbm4gPGtyYXhl
bEByZWRoYXQuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaCAg
ICB8ICAyICsKIGRyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9vYmplY3QuYyB8IDc0ICsr
KysrKysrKysrLS0tLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92
cS5jICAgICB8ICA0ICsrCiAzIGZpbGVzIGNoYW5nZWQsIDM3IGluc2VydGlvbnMoKyksIDQzIGRl
bGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9k
cnYuaCBiL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaAppbmRleCA2ZTAyZjZm
N2NiNWEuLmU1ZDg1YzEwNGJkMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92
aXJ0Z3B1X2Rydi5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaApA
QCAtMjc0LDYgKzI3NCw3IEBAIHZvaWQgdmlydGlvX2dwdV9mcmVlX3ZidWZzKHN0cnVjdCB2aXJ0
aW9fZ3B1X2RldmljZSAqdmdkZXYpOwogdm9pZCB2aXJ0aW9fZ3B1X2NtZF9jcmVhdGVfcmVzb3Vy
Y2Uoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKIAkJCQkgICAgc3RydWN0IHZpcnRp
b19ncHVfb2JqZWN0ICpibywKIAkJCQkgICAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0X3BhcmFt
cyAqcGFyYW1zLAorCQkJCSAgICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3RfYXJyYXkgKm9ianMs
CiAJCQkJICAgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSk7CiB2b2lkIHZpcnRpb19n
cHVfY21kX3VucmVmX3Jlc291cmNlKHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAJ
CQkJICAgdWludDMyX3QgcmVzb3VyY2VfaWQpOwpAQCAtMzM2LDYgKzMzNyw3IEBAIHZvaWQKIHZp
cnRpb19ncHVfY21kX3Jlc291cmNlX2NyZWF0ZV8zZChzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2Ug
KnZnZGV2LAogCQkJCSAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0ICpibywKIAkJCQkgIHN0cnVj
dCB2aXJ0aW9fZ3B1X29iamVjdF9wYXJhbXMgKnBhcmFtcywKKwkJCQkgIHN0cnVjdCB2aXJ0aW9f
Z3B1X29iamVjdF9hcnJheSAqb2JqcywKIAkJCQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpm
ZW5jZSk7CiB2b2lkIHZpcnRpb19ncHVfY3RybF9hY2soc3RydWN0IHZpcnRxdWV1ZSAqdnEpOwog
dm9pZCB2aXJ0aW9fZ3B1X2N1cnNvcl9hY2soc3RydWN0IHZpcnRxdWV1ZSAqdnEpOwpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jIGIvZHJpdmVycy9n
cHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jCmluZGV4IDgyYmZiZjk4M2ZkMi4uMjkwMjQ4
N2YwNTFhIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfb2JqZWN0
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jCkBAIC05Nyw2
ICs5Nyw3IEBAIGludCB2aXJ0aW9fZ3B1X29iamVjdF9jcmVhdGUoc3RydWN0IHZpcnRpb19ncHVf
ZGV2aWNlICp2Z2RldiwKIAkJCSAgICAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0ICoqYm9fcHRy
LAogCQkJICAgICBzdHJ1Y3QgdmlydGlvX2dwdV9mZW5jZSAqZmVuY2UpCiB7CisJc3RydWN0IHZp
cnRpb19ncHVfb2JqZWN0X2FycmF5ICpvYmpzID0gTlVMTDsKIAlzdHJ1Y3QgdmlydGlvX2dwdV9v
YmplY3QgKmJvOwogCXNpemVfdCBhY2Nfc2l6ZTsKIAlpbnQgcmV0OwpAQCAtMTEwLDIzICsxMTEs
MzQgQEAgaW50IHZpcnRpb19ncHVfb2JqZWN0X2NyZWF0ZShzdHJ1Y3QgdmlydGlvX2dwdV9kZXZp
Y2UgKnZnZGV2LAogCWlmIChibyA9PSBOVUxMKQogCQlyZXR1cm4gLUVOT01FTTsKIAlyZXQgPSB2
aXJ0aW9fZ3B1X3Jlc291cmNlX2lkX2dldCh2Z2RldiwgJmJvLT5od19yZXNfaGFuZGxlKTsKLQlp
ZiAocmV0IDwgMCkgewotCQlrZnJlZShibyk7Ci0JCXJldHVybiByZXQ7Ci0JfQorCWlmIChyZXQg
PCAwKQorCQlnb3RvIGVycl9mcmVlX2dlbTsKKwogCXBhcmFtcy0+c2l6ZSA9IHJvdW5kdXAocGFy
YW1zLT5zaXplLCBQQUdFX1NJWkUpOwogCXJldCA9IGRybV9nZW1fb2JqZWN0X2luaXQodmdkZXYt
PmRkZXYsICZiby0+Z2VtX2Jhc2UsIHBhcmFtcy0+c2l6ZSk7Ci0JaWYgKHJldCAhPSAwKSB7Ci0J
CXZpcnRpb19ncHVfcmVzb3VyY2VfaWRfcHV0KHZnZGV2LCBiby0+aHdfcmVzX2hhbmRsZSk7Ci0J
CWtmcmVlKGJvKTsKLQkJcmV0dXJuIHJldDsKLQl9CisJaWYgKHJldCAhPSAwKQorCQlnb3RvIGVy
cl9wdXRfaWQ7CisKIAliby0+ZHVtYiA9IHBhcmFtcy0+ZHVtYjsKIAorCWlmIChmZW5jZSkgewor
CQlyZXQgPSAtRU5PTUVNOworCQlvYmpzID0gdmlydGlvX2dwdV9hcnJheV9hbGxvYygxKTsKKwkJ
aWYgKCFvYmpzKQorCQkJZ290byBlcnJfcHV0X2lkOworCQl2aXJ0aW9fZ3B1X2FycmF5X2FkZF9v
Ymoob2JqcywgJmJvLT5nZW1fYmFzZSk7CisKKwkJcmV0ID0gdmlydGlvX2dwdV9hcnJheV9sb2Nr
X3Jlc3Yob2Jqcyk7CisJCWlmIChyZXQgIT0gMCkKKwkJCWdvdG8gZXJyX3B1dF9vYmpzOworCX0K
KwogCWlmIChwYXJhbXMtPnZpcmdsKSB7Ci0JCXZpcnRpb19ncHVfY21kX3Jlc291cmNlX2NyZWF0
ZV8zZCh2Z2RldiwgYm8sIHBhcmFtcywgZmVuY2UpOworCQl2aXJ0aW9fZ3B1X2NtZF9yZXNvdXJj
ZV9jcmVhdGVfM2QodmdkZXYsIGJvLCBwYXJhbXMsCisJCQkJCQkgIG9ianMsIGZlbmNlKTsKIAl9
IGVsc2UgewotCQl2aXJ0aW9fZ3B1X2NtZF9jcmVhdGVfcmVzb3VyY2UodmdkZXYsIGJvLCBwYXJh
bXMsIGZlbmNlKTsKKwkJdmlydGlvX2dwdV9jbWRfY3JlYXRlX3Jlc291cmNlKHZnZGV2LCBibywg
cGFyYW1zLAorCQkJCQkgICAgICAgb2JqcywgZmVuY2UpOwogCX0KIAogCXZpcnRpb19ncHVfaW5p
dF90dG1fcGxhY2VtZW50KGJvKTsKQEAgLTEzOSw0MCArMTUxLDE2IEBAIGludCB2aXJ0aW9fZ3B1
X29iamVjdF9jcmVhdGUoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKIAlpZiAocmV0
ICE9IDApCiAJCXJldHVybiByZXQ7CiAKLQlpZiAoZmVuY2UpIHsKLQkJc3RydWN0IHZpcnRpb19n
cHVfZmVuY2VfZHJpdmVyICpkcnYgPSAmdmdkZXYtPmZlbmNlX2RydjsKLQkJc3RydWN0IGxpc3Rf
aGVhZCB2YWxpZGF0ZV9saXN0OwotCQlzdHJ1Y3QgdHRtX3ZhbGlkYXRlX2J1ZmZlciBtYWluYnVm
OwotCQlzdHJ1Y3Qgd3dfYWNxdWlyZV9jdHggdGlja2V0OwotCQl1bnNpZ25lZCBsb25nIGlycV9m
bGFnczsKLQkJYm9vbCBzaWduYWxlZDsKLQotCQlJTklUX0xJU1RfSEVBRCgmdmFsaWRhdGVfbGlz
dCk7Ci0JCW1lbXNldCgmbWFpbmJ1ZiwgMCwgc2l6ZW9mKHN0cnVjdCB0dG1fdmFsaWRhdGVfYnVm
ZmVyKSk7Ci0KLQkJLyogdXNlIGEgZ2VtIHJlZmVyZW5jZSBzaW5jZSB1bnJlZiBsaXN0IHVuZG9l
cyB0aGVtICovCi0JCWRybV9nZW1fb2JqZWN0X2dldCgmYm8tPmdlbV9iYXNlKTsKLQkJbWFpbmJ1
Zi5ibyA9ICZiby0+dGJvOwotCQlsaXN0X2FkZCgmbWFpbmJ1Zi5oZWFkLCAmdmFsaWRhdGVfbGlz
dCk7Ci0KLQkJcmV0ID0gdmlydGlvX2dwdV9vYmplY3RfbGlzdF92YWxpZGF0ZSgmdGlja2V0LCAm
dmFsaWRhdGVfbGlzdCk7Ci0JCWlmIChyZXQgPT0gMCkgewotCQkJc3Bpbl9sb2NrX2lycXNhdmUo
JmRydi0+bG9jaywgaXJxX2ZsYWdzKTsKLQkJCXNpZ25hbGVkID0gdmlydGlvX2ZlbmNlX3NpZ25h
bGVkKCZmZW5jZS0+Zik7Ci0JCQlpZiAoIXNpZ25hbGVkKQotCQkJCS8qIHZpcnRpbyBjcmVhdGUg
Y29tbWFuZCBzdGlsbCBpbiBmbGlnaHQgKi8KLQkJCQl0dG1fZXVfZmVuY2VfYnVmZmVyX29iamVj
dHMoJnRpY2tldCwgJnZhbGlkYXRlX2xpc3QsCi0JCQkJCQkJICAgICZmZW5jZS0+Zik7Ci0JCQlz
cGluX3VubG9ja19pcnFyZXN0b3JlKCZkcnYtPmxvY2ssIGlycV9mbGFncyk7Ci0JCQlpZiAoc2ln
bmFsZWQpCi0JCQkJLyogdmlydGlvIGNyZWF0ZSBjb21tYW5kIGZpbmlzaGVkICovCi0JCQkJdHRt
X2V1X2JhY2tvZmZfcmVzZXJ2YXRpb24oJnRpY2tldCwgJnZhbGlkYXRlX2xpc3QpOwotCQl9Ci0J
CXZpcnRpb19ncHVfdW5yZWZfbGlzdCgmdmFsaWRhdGVfbGlzdCk7Ci0JfQotCiAJKmJvX3B0ciA9
IGJvOwogCXJldHVybiAwOworCitlcnJfcHV0X29ianM6CisJdmlydGlvX2dwdV9hcnJheV9wdXRf
ZnJlZShvYmpzKTsKK2Vycl9wdXRfaWQ6CisJdmlydGlvX2dwdV9yZXNvdXJjZV9pZF9wdXQodmdk
ZXYsIGJvLT5od19yZXNfaGFuZGxlKTsKK2Vycl9mcmVlX2dlbToKKwlrZnJlZShibyk7CisJcmV0
dXJuIHJldDsKIH0KIAogdm9pZCB2aXJ0aW9fZ3B1X29iamVjdF9rdW5tYXAoc3RydWN0IHZpcnRp
b19ncHVfb2JqZWN0ICpibykKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmly
dGdwdV92cS5jIGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X3ZxLmMKaW5kZXggMjQy
NDVjMzdkNjlmLi4wNzk5MDdlOGE1OTYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS92aXJ0
aW8vdmlydGdwdV92cS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92cS5j
CkBAIC0zOTYsNiArMzk2LDcgQEAgc3RhdGljIGludCB2aXJ0aW9fZ3B1X3F1ZXVlX2N1cnNvcihz
dHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogdm9pZCB2aXJ0aW9fZ3B1X2NtZF9jcmVh
dGVfcmVzb3VyY2Uoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKIAkJCQkgICAgc3Ry
dWN0IHZpcnRpb19ncHVfb2JqZWN0ICpibywKIAkJCQkgICAgc3RydWN0IHZpcnRpb19ncHVfb2Jq
ZWN0X3BhcmFtcyAqcGFyYW1zLAorCQkJCSAgICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3RfYXJy
YXkgKm9ianMsCiAJCQkJICAgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSkKIHsKIAlz
dHJ1Y3QgdmlydGlvX2dwdV9yZXNvdXJjZV9jcmVhdGVfMmQgKmNtZF9wOwpAQCAtNDAzLDYgKzQw
NCw3IEBAIHZvaWQgdmlydGlvX2dwdV9jbWRfY3JlYXRlX3Jlc291cmNlKHN0cnVjdCB2aXJ0aW9f
Z3B1X2RldmljZSAqdmdkZXYsCiAKIAljbWRfcCA9IHZpcnRpb19ncHVfYWxsb2NfY21kKHZnZGV2
LCAmdmJ1Ziwgc2l6ZW9mKCpjbWRfcCkpOwogCW1lbXNldChjbWRfcCwgMCwgc2l6ZW9mKCpjbWRf
cCkpOworCXZidWYtPm9ianMgPSBvYmpzOwogCiAJY21kX3AtPmhkci50eXBlID0gY3B1X3RvX2xl
MzIoVklSVElPX0dQVV9DTURfUkVTT1VSQ0VfQ1JFQVRFXzJEKTsKIAljbWRfcC0+cmVzb3VyY2Vf
aWQgPSBjcHVfdG9fbGUzMihiby0+aHdfcmVzX2hhbmRsZSk7CkBAIC04NjksNiArODcxLDcgQEAg
dm9pZAogdmlydGlvX2dwdV9jbWRfcmVzb3VyY2VfY3JlYXRlXzNkKHN0cnVjdCB2aXJ0aW9fZ3B1
X2RldmljZSAqdmdkZXYsCiAJCQkJICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3QgKmJvLAogCQkJ
CSAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0X3BhcmFtcyAqcGFyYW1zLAorCQkJCSAgc3RydWN0
IHZpcnRpb19ncHVfb2JqZWN0X2FycmF5ICpvYmpzLAogCQkJCSAgc3RydWN0IHZpcnRpb19ncHVf
ZmVuY2UgKmZlbmNlKQogewogCXN0cnVjdCB2aXJ0aW9fZ3B1X3Jlc291cmNlX2NyZWF0ZV8zZCAq
Y21kX3A7CkBAIC04NzYsNiArODc5LDcgQEAgdmlydGlvX2dwdV9jbWRfcmVzb3VyY2VfY3JlYXRl
XzNkKHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAKIAljbWRfcCA9IHZpcnRpb19n
cHVfYWxsb2NfY21kKHZnZGV2LCAmdmJ1Ziwgc2l6ZW9mKCpjbWRfcCkpOwogCW1lbXNldChjbWRf
cCwgMCwgc2l6ZW9mKCpjbWRfcCkpOworCXZidWYtPm9ianMgPSBvYmpzOwogCiAJY21kX3AtPmhk
ci50eXBlID0gY3B1X3RvX2xlMzIoVklSVElPX0dQVV9DTURfUkVTT1VSQ0VfQ1JFQVRFXzNEKTsK
IAljbWRfcC0+cmVzb3VyY2VfaWQgPSBjcHVfdG9fbGUzMihiby0+aHdfcmVzX2hhbmRsZSk7Ci0t
IAoyLjE4LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
CmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpo
dHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
