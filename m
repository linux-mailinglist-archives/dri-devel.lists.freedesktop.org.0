Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id ECC7B9D92D
	for <lists+dri-devel@lfdr.de>; Tue, 27 Aug 2019 00:33:31 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 49BFC6E313;
	Mon, 26 Aug 2019 22:33:25 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-ot1-f65.google.com (mail-ot1-f65.google.com
 [209.85.210.65])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C8F8289C98
 for <dri-devel@lists.freedesktop.org>; Mon, 26 Aug 2019 22:33:21 +0000 (UTC)
Received: by mail-ot1-f65.google.com with SMTP id p23so12628407oto.0
 for <dri-devel@lists.freedesktop.org>; Mon, 26 Aug 2019 15:33:21 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=ydH/HKcY64Hq0IwbCZKPNFDl6+x8s7JlVAmM1kUc43k=;
 b=eklt/d7jhlyRGu5arZgVztXRpqI4zMWCCzqIYX4uw9xqa0yJawftZH6l1TJnh1KPWZ
 XzP/kB5XwIYAOKmQXScbzqSanJ1nDAIHN4P3aRsGsV30gnaqq6HgIxKCCQHi0ozyrDaQ
 pxlGlqFn1AS5qLSB+58osLCQDlVTxsq7hAACnK/eZ/IC+VDlGyVPYzYbBkAbtxZyWuKo
 Y7wR6fqOtDoBZ9wgQJo30fggtpx2oprctdnzJ2PLAuZXza0EX/dC+4HVRznjBpjWO6m0
 3gbGesuy+DgZ8XtiIxcCkHAqqC6DLku1glt+YjIXkEpxxP9RQa0xnTZtfVQhrBsug37m
 5HHQ==
X-Gm-Message-State: APjAAAWDXOri4qtrPFeIt9oult/bCBsQ9XPYqf5Wh4atVQD7RDRuNFr4
 Yfo1ePvBuo/gdrgfeIzYgrPXazs=
X-Google-Smtp-Source: APXvYqzk5WRMZlZULKgBteyQvJ5hJgEGNjGBs+Rh/voxpPt4nk4RIdfKo+lhlf9j6c7FKA+EVpHnig==
X-Received: by 2002:a05:6830:14e:: with SMTP id
 j14mr16501668otp.246.1566858800749; 
 Mon, 26 Aug 2019 15:33:20 -0700 (PDT)
Received: from xps15.herring.priv (24-155-109-49.dyn.grandenetworks.net.
 [24.155.109.49])
 by smtp.googlemail.com with ESMTPSA id e22sm3668959oii.7.2019.08.26.15.33.19
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 26 Aug 2019 15:33:20 -0700 (PDT)
From: Rob Herring <robh@kernel.org>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v3 2/8] drm/panfrost: Hold runtime PM reference until jobs
 complete
Date: Mon, 26 Aug 2019 17:33:11 -0500
Message-Id: <20190826223317.28509-3-robh@kernel.org>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190826223317.28509-1-robh@kernel.org>
References: <20190826223317.28509-1-robh@kernel.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Tomeu Vizoso <tomeu.vizoso@collabora.com>, David Airlie <airlied@linux.ie>,
 Steven Price <steven.price@arm.com>,
 Alyssa Rosenzweig <alyssa.rosenzweig@collabora.com>,
 Robin Murphy <robin.murphy@arm.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RG9pbmcgYSBwbV9ydW50aW1lX3B1dCBhcyBzb29uIGFzIGEgam9iIGlzIHN1Ym1pdHRlZCBpcyB3
cm9uZyBhcyBpdCBzaG91bGQKbm90IGhhcHBlbiB1bnRpbCB0aGUgam9iIGNvbXBsZXRlcy4gSXQg
d29ya3MgY3VycmVudGx5IGJlY2F1c2Ugd2UgYXJlCnJlbHlpbmcgb24gdGhlIGF1dG9zdXNwZW5k
IHRpbWVvdXQgdG8ga2VlcCB0aGUgaC93IGVuYWJsZWQuCgpGaXhlczogZjNiYTkxMjI4ZThlICgi
ZHJtL3BhbmZyb3N0OiBBZGQgaW5pdGlhbCBwYW5mcm9zdCBkcml2ZXIiKQpDYzogVG9tZXUgVml6
b3NvIDx0b21ldS52aXpvc29AY29sbGFib3JhLmNvbT4KQ2M6IFN0ZXZlbiBQcmljZSA8c3RldmVu
LnByaWNlQGFybS5jb20+CkNjOiBBbHlzc2EgUm9zZW56d2VpZyA8YWx5c3NhLnJvc2VuendlaWdA
Y29sbGFib3JhLmNvbT4KQ2M6IERhdmlkIEFpcmxpZSA8YWlybGllZEBsaW51eC5pZT4KQ2M6IERh
bmllbCBWZXR0ZXIgPGRhbmllbEBmZndsbC5jaD4KU2lnbmVkLW9mZi1ieTogUm9iIEhlcnJpbmcg
PHJvYmhAa2VybmVsLm9yZz4KLS0tCnYzOgogLSBGaXggcmFjZSBiZXR3ZWVuIGNsZWFyaW5nIHBm
ZGV2LT5qb2JzW10gaW4gdGltZW91dCBhbmQgdGhlIElTUiB1c2luZyB0aGUgam9iX2xvY2sKIC0g
TWFpbnRhaW4gcG1fcnVudGltZV9wdXQgaW4gdGhlIHBhbmZyb3N0X2pvYl9od19zdWJtaXQgZXJy
b3IgcGF0aAoKIGRyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9qb2IuYyB8IDM5ICsr
KysrKysrKysrKysrKysrKy0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAyOCBpbnNlcnRpb25zKCsp
LCAxMSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vcGFuZnJvc3Qv
cGFuZnJvc3Rfam9iLmMgYi9kcml2ZXJzL2dwdS9kcm0vcGFuZnJvc3QvcGFuZnJvc3Rfam9iLmMK
aW5kZXggMDVjODVmNDVhMGRlLi4xOGJjYzliYWM2ZDIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9qb2IuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vcGFuZnJv
c3QvcGFuZnJvc3Rfam9iLmMKQEAgLTE1MCw4ICsxNTAsMTAgQEAgc3RhdGljIHZvaWQgcGFuZnJv
c3Rfam9iX2h3X3N1Ym1pdChzdHJ1Y3QgcGFuZnJvc3Rfam9iICpqb2IsIGludCBqcykKIAlpZiAo
cmV0IDwgMCkKIAkJcmV0dXJuOwoKLQlpZiAoV0FSTl9PTihqb2JfcmVhZChwZmRldiwgSlNfQ09N
TUFORF9ORVhUKGpzKSkpKQotCQlnb3RvIGVuZDsKKwlpZiAoV0FSTl9PTihqb2JfcmVhZChwZmRl
diwgSlNfQ09NTUFORF9ORVhUKGpzKSkpKSB7CisJCXBtX3J1bnRpbWVfcHV0X3N5bmNfYXV0b3N1
c3BlbmQocGZkZXYtPmRldik7CisJCXJldHVybjsKKwl9CgogCWNmZyA9IHBhbmZyb3N0X21tdV9h
c19nZXQocGZkZXYsICZqb2ItPmZpbGVfcHJpdi0+bW11KTsKCkBAIC0xODcsMTAgKzE4OSw2IEBA
IHN0YXRpYyB2b2lkIHBhbmZyb3N0X2pvYl9od19zdWJtaXQoc3RydWN0IHBhbmZyb3N0X2pvYiAq
am9iLCBpbnQganMpCiAJam9iX3dyaXRlKHBmZGV2LCBKU19DT01NQU5EX05FWFQoanMpLCBKU19D
T01NQU5EX1NUQVJUKTsKCiAJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmcGZkZXYtPmh3YWNjZXNz
X2xvY2ssIGZsYWdzKTsKLQotZW5kOgotCXBtX3J1bnRpbWVfbWFya19sYXN0X2J1c3kocGZkZXYt
PmRldik7Ci0JcG1fcnVudGltZV9wdXRfYXV0b3N1c3BlbmQocGZkZXYtPmRldik7CiB9Cgogc3Rh
dGljIHZvaWQgcGFuZnJvc3RfYWNxdWlyZV9vYmplY3RfZmVuY2VzKHN0cnVjdCBkcm1fZ2VtX29i
amVjdCAqKmJvcywKQEAgLTM2OSw2ICszNjcsNyBAQCBzdGF0aWMgdm9pZCBwYW5mcm9zdF9qb2Jf
dGltZWRvdXQoc3RydWN0IGRybV9zY2hlZF9qb2IgKnNjaGVkX2pvYikKIAlzdHJ1Y3QgcGFuZnJv
c3Rfam9iICpqb2IgPSB0b19wYW5mcm9zdF9qb2Ioc2NoZWRfam9iKTsKIAlzdHJ1Y3QgcGFuZnJv
c3RfZGV2aWNlICpwZmRldiA9IGpvYi0+cGZkZXY7CiAJaW50IGpzID0gcGFuZnJvc3Rfam9iX2dl
dF9zbG90KGpvYik7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKIAlpbnQgaTsKCiAJLyoKQEAgLTM5
NCw2ICszOTMsMTUgQEAgc3RhdGljIHZvaWQgcGFuZnJvc3Rfam9iX3RpbWVkb3V0KHN0cnVjdCBk
cm1fc2NoZWRfam9iICpzY2hlZF9qb2IpCiAJaWYgKHNjaGVkX2pvYikKIAkJZHJtX3NjaGVkX2lu
Y3JlYXNlX2thcm1hKHNjaGVkX2pvYik7CgorCXNwaW5fbG9ja19pcnFzYXZlKCZwZmRldi0+anMt
PmpvYl9sb2NrLCBmbGFncyk7CisJZm9yIChpID0gMDsgaSA8IE5VTV9KT0JfU0xPVFM7IGkrKykg
eworCQlpZiAocGZkZXYtPmpvYnNbaV0pIHsKKwkJCXBtX3J1bnRpbWVfcHV0X25vaWRsZShwZmRl
di0+ZGV2KTsKKwkJCXBmZGV2LT5qb2JzW2ldID0gTlVMTDsKKwkJfQorCX0KKwlzcGluX3VubG9j
a19pcnFyZXN0b3JlKCZwZmRldi0+anMtPmpvYl9sb2NrLCBmbGFncyk7CisKIAkvKiBwYW5mcm9z
dF9jb3JlX2R1bXAocGZkZXYpOyAqLwoKIAlwYW5mcm9zdF9kZXZmcmVxX3JlY29yZF90cmFuc2l0
aW9uKHBmZGV2LCBqcyk7CkBAIC00NTAsMTIgKzQ1OCwyMSBAQCBzdGF0aWMgaXJxcmV0dXJuX3Qg
cGFuZnJvc3Rfam9iX2lycV9oYW5kbGVyKGludCBpcnEsIHZvaWQgKmRhdGEpCiAJCX0KCiAJCWlm
IChzdGF0dXMgJiBKT0JfSU5UX01BU0tfRE9ORShqKSkgewotCQkJc3RydWN0IHBhbmZyb3N0X2pv
YiAqam9iID0gcGZkZXYtPmpvYnNbal07CisJCQlzdHJ1Y3QgcGFuZnJvc3Rfam9iICpqb2I7CisK
KwkJCXNwaW5fbG9jaygmcGZkZXYtPmpzLT5qb2JfbG9jayk7CisJCQlqb2IgPSBwZmRldi0+am9i
c1tqXTsKKwkJCS8qIE9ubHkgTlVMTCBpZiBqb2IgdGltZW91dCBvY2N1cnJlZCAqLworCQkJaWYg
KGpvYikgeworCQkJCXBmZGV2LT5qb2JzW2pdID0gTlVMTDsKKworCQkJCXBhbmZyb3N0X21tdV9h
c19wdXQocGZkZXYsICZqb2ItPmZpbGVfcHJpdi0+bW11KTsKKwkJCQlwYW5mcm9zdF9kZXZmcmVx
X3JlY29yZF90cmFuc2l0aW9uKHBmZGV2LCBqKTsKCi0JCQlwZmRldi0+am9ic1tqXSA9IE5VTEw7
Ci0JCQlwYW5mcm9zdF9tbXVfYXNfcHV0KHBmZGV2LCAmam9iLT5maWxlX3ByaXYtPm1tdSk7Ci0J
CQlwYW5mcm9zdF9kZXZmcmVxX3JlY29yZF90cmFuc2l0aW9uKHBmZGV2LCBqKTsKLQkJCWRtYV9m
ZW5jZV9zaWduYWwoam9iLT5kb25lX2ZlbmNlKTsKKwkJCQlkbWFfZmVuY2Vfc2lnbmFsX2xvY2tl
ZChqb2ItPmRvbmVfZmVuY2UpOworCQkJCXBtX3J1bnRpbWVfcHV0X2F1dG9zdXNwZW5kKHBmZGV2
LT5kZXYpOworCQkJfQorCQkJc3Bpbl91bmxvY2soJnBmZGV2LT5qcy0+am9iX2xvY2spOwogCQl9
CgogCQlzdGF0dXMgJj0gfm1hc2s7Ci0tCjIuMjAuMQpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBs
aXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1h
bi9saXN0aW5mby9kcmktZGV2ZWw=
