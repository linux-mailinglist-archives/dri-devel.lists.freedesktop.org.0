Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 88624DEA96
	for <lists+dri-devel@lfdr.de>; Mon, 21 Oct 2019 13:15:33 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id DC3BF88FCF;
	Mon, 21 Oct 2019 11:15:30 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x443.google.com (mail-wr1-x443.google.com
 [IPv6:2a00:1450:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A443B88FCF;
 Mon, 21 Oct 2019 11:15:29 +0000 (UTC)
Received: by mail-wr1-x443.google.com with SMTP id c2so8242573wrr.10;
 Mon, 21 Oct 2019 04:15:29 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=l5kZ6eJpVfLJBcQupT4Lazwgm6cKRgHlf0S9bM0ieRc=;
 b=lGaqENTQsB+VaQUl+CCCXu8ykqNo969Q7YgX4MitFcGAFZKBSidtBATaPy0KZrPIaQ
 UrOmfKz9XXzLB6aIgMa+q3Bve7+pTVjSBk5/8qZHSrA24SJw+KXmyemy6ArN0h29b55s
 pg5RbZTUecJeHts9M6qEPnSLSd8iXNnjWoq+RdN4E5NTBGw4Pj30TRWr6Kgji790yaE3
 m605msH1wcO3CNKxQP5XwMazpunP9VVPza7OMcT/tqjdguupeg3bzBugrsoIPllwgeUE
 fskknYl3rLYji+2axnOapy7Y7hDvlGgAMCN4aphPQairW9yTurZCMJAvKrwXD1aftNZp
 V+Lw==
X-Gm-Message-State: APjAAAWMyr8xIYvynsiX1lpsKTBn9ij4zT86qkqPCFxdEf3Q7Qs4cH4P
 /kUd0ZI8/NlJQdRAtk106hjYwhiL
X-Google-Smtp-Source: APXvYqxp/vYKCrkXKrowLtxNRDfzE3ys4U2Kyc5wYjGju0uwFNJlRxpV4IfhX88e08wQ77TlU3so+Q==
X-Received: by 2002:adf:f342:: with SMTP id e2mr20538782wrp.61.1571656527798; 
 Mon, 21 Oct 2019 04:15:27 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:c194:dd41:4bef:70cc])
 by smtp.gmail.com with ESMTPSA id l9sm13152415wme.45.2019.10.21.04.15.25
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 21 Oct 2019 04:15:25 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: dri-devel@lists.freedesktop.org, sumit.semwal@linaro.org,
 linaro-mm-sig@lists.linaro.org, linux-media@vger.kernel.org,
 intel-gfx@lists.freedesktop.org, daniel@ffwll.ch
Subject: [PATCH 1/4] dma-buf: change DMA-buf locking convention v2
Date: Mon, 21 Oct 2019 13:15:21 +0200
Message-Id: <20191021111524.14793-1-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=l5kZ6eJpVfLJBcQupT4Lazwgm6cKRgHlf0S9bM0ieRc=;
 b=pKCfjq9Mt7EK/GAR1x7xlXQqEbq/gJCVmKZnowCqtJaXG7JS+c+DINqiLvath7brjp
 gRRiuSjlKHFdrzyc2uUFV/bB0wWnP+Qedi7ss1Yp7GTXut4sPIwGKoY0K43gPcPcJt+A
 cyZvEDBwDaNdf8X3Eifsqu4/7btnh1NJW56kw5CsCW99ob6cL+ZjVPztd1hIjjGk4DMZ
 1LqYu3zW83JoKIAtlZG4rMx3+19i+uPO3SFXI47dp4E/M005pG+0CDL+c0U6g0HOlNBl
 5PZRzka1rZdHdv0VDO8AcB0YLrOhIRG+i2Pm3xQWDkfzqGsUFOejRaYo/Z9g2rU+828S
 bJug==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBpcyBhIHN0cmlwcGVkIGRvd24gdmVyc2lvbiBvZiB0aGUgbG9ja2luZyBjaGFu
Z2VzCm5lY2Vzc2FyeSB0byBzdXBwb3J0IGR5bmFtaWMgRE1BLWJ1ZiBoYW5kbGluZy4KCkl0IGFk
ZHMgYSBkeW5hbWljIGZsYWcgZm9yIGJvdGggaW1wb3J0ZXJzIGFzIHdlbGwgYXMgZXhwb3J0ZXJz
CnNvIHRoYXQgZHJpdmVycyBjYW4gY2hvb3NlIGlmIHRoZXkgd2FudCB0aGUgcmVzZXJ2YXRpb24g
b2JqZWN0CmxvY2tlZCBvciB1bmxvY2tlZCBkdXJpbmcgbWFwcGluZyBvZiBhdHRhY2htZW50cy4K
CkZvciBjb21wYXRpYmlsaXR5IGJldHdlZW4gZHJpdmVycyB3ZSBjYWNoZSB0aGUgRE1BLWJ1ZiBt
YXBwaW5nCmR1cmluZyBhdHRhY2hpbmcgYW4gaW1wb3J0ZXIgYXMgc29vbiBhcyBleHBvcnRlci9p
bXBvcnRlcgpkaXNhZ3JlZSBvbiB0aGUgZHluYW1pYyBoYW5kbGluZy4KClRoaXMgY2hhbmdlIGhh
cyBnb25lIHRocm91Z2ggYSBsZW5ndGh5IGRpc2N1c3Npb24gb24gZHJpLWRldmVsCmFuZCBvdGhl
ciBtYWlsaW5nIGxpc3RzIHdpdGggYXQgbGVhc3QgMy00IGRpZmZlcmVudCBhdHRlbXB0cyBhbmQK
ZGVhZC1lbmRzIHVudGlsIHdlIHNldHRsZWQgb24gdGhpcyBzb2x1dGlvbi4gUGxlYXNlIHJlZmVy
IHRvIHRoZQptYWlsaW5nIGxpc3RzIGFyY2hpdmVzIGZvciBmdWxsIGJhY2tncm91bmQgb24gdGhl
IGhpc3Rvcnkgb2YKdGhpcyBjaGFuZ2UuCgp2MjogY2xlYW51cCBzZXRfbmFtZSBtZXJnZSwgaW1w
cm92ZSBrZXJuZWxkb2MKClNpZ25lZC1vZmYtYnk6IENocmlzdGlhbiBLw7ZuaWcgPGNocmlzdGlh
bi5rb2VuaWdAYW1kLmNvbT4KLS0tCiBkcml2ZXJzL2RtYS1idWYvZG1hLWJ1Zi5jIHwgMTAyICsr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tCiBpbmNsdWRlL2xpbnV4L2RtYS1i
dWYuaCAgIHwgIDU3ICsrKysrKysrKysrKysrKysrKystLQogMiBmaWxlcyBjaGFuZ2VkLCAxNDMg
aW5zZXJ0aW9ucygrKSwgMTYgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEt
YnVmL2RtYS1idWYuYyBiL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtYnVmLmMKaW5kZXggNDMzZDkxZDcx
MGU0Li43NTNiZTg0YjVmZDYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtYnVmLmMK
KysrIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1idWYuYwpAQCAtNDUsMTAgKzQ1LDEwIEBAIHN0YXRp
YyBjaGFyICpkbWFidWZmc19kbmFtZShzdHJ1Y3QgZGVudHJ5ICpkZW50cnksIGNoYXIgKmJ1ZmZl
ciwgaW50IGJ1ZmxlbikKIAlzaXplX3QgcmV0ID0gMDsKIAogCWRtYWJ1ZiA9IGRlbnRyeS0+ZF9m
c2RhdGE7Ci0JbXV0ZXhfbG9jaygmZG1hYnVmLT5sb2NrKTsKKwlkbWFfcmVzdl9sb2NrKGRtYWJ1
Zi0+cmVzdiwgTlVMTCk7CiAJaWYgKGRtYWJ1Zi0+bmFtZSkKIAkJcmV0ID0gc3RybGNweShuYW1l
LCBkbWFidWYtPm5hbWUsIERNQV9CVUZfTkFNRV9MRU4pOwotCW11dGV4X3VubG9jaygmZG1hYnVm
LT5sb2NrKTsKKwlkbWFfcmVzdl91bmxvY2soZG1hYnVmLT5yZXN2KTsKIAogCXJldHVybiBkeW5h
bWljX2RuYW1lKGRlbnRyeSwgYnVmZmVyLCBidWZsZW4sICIvJXM6JXMiLAogCQkJICAgICBkZW50
cnktPmRfbmFtZS5uYW1lLCByZXQgPiAwID8gbmFtZSA6ICIiKTsKQEAgLTMzNCw3ICszMzQsNyBA
QCBzdGF0aWMgbG9uZyBkbWFfYnVmX3NldF9uYW1lKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsIGNv
bnN0IGNoYXIgX191c2VyICpidWYpCiAJaWYgKElTX0VSUihuYW1lKSkKIAkJcmV0dXJuIFBUUl9F
UlIobmFtZSk7CiAKLQltdXRleF9sb2NrKCZkbWFidWYtPmxvY2spOworCWRtYV9yZXN2X2xvY2so
ZG1hYnVmLT5yZXN2LCBOVUxMKTsKIAlpZiAoIWxpc3RfZW1wdHkoJmRtYWJ1Zi0+YXR0YWNobWVu
dHMpKSB7CiAJCXJldCA9IC1FQlVTWTsKIAkJa2ZyZWUobmFtZSk7CkBAIC0zNDQsNyArMzQ0LDcg
QEAgc3RhdGljIGxvbmcgZG1hX2J1Zl9zZXRfbmFtZShzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLCBj
b25zdCBjaGFyIF9fdXNlciAqYnVmKQogCWRtYWJ1Zi0+bmFtZSA9IG5hbWU7CiAKIG91dF91bmxv
Y2s6Ci0JbXV0ZXhfdW5sb2NrKCZkbWFidWYtPmxvY2spOworCWRtYV9yZXN2X3VubG9jayhkbWFi
dWYtPnJlc3YpOwogCXJldHVybiByZXQ7CiB9CiAKQEAgLTQwMywxMCArNDAzLDEwIEBAIHN0YXRp
YyB2b2lkIGRtYV9idWZfc2hvd19mZGluZm8oc3RydWN0IHNlcV9maWxlICptLCBzdHJ1Y3QgZmls
ZSAqZmlsZSkKIAkvKiBEb24ndCBjb3VudCB0aGUgdGVtcG9yYXJ5IHJlZmVyZW5jZSB0YWtlbiBp
bnNpZGUgcHJvY2ZzIHNlcV9zaG93ICovCiAJc2VxX3ByaW50ZihtLCAiY291bnQ6XHQlbGRcbiIs
IGZpbGVfY291bnQoZG1hYnVmLT5maWxlKSAtIDEpOwogCXNlcV9wcmludGYobSwgImV4cF9uYW1l
Olx0JXNcbiIsIGRtYWJ1Zi0+ZXhwX25hbWUpOwotCW11dGV4X2xvY2soJmRtYWJ1Zi0+bG9jayk7
CisJZG1hX3Jlc3ZfbG9jayhkbWFidWYtPnJlc3YsIE5VTEwpOwogCWlmIChkbWFidWYtPm5hbWUp
CiAJCXNlcV9wcmludGYobSwgIm5hbWU6XHQlc1xuIiwgZG1hYnVmLT5uYW1lKTsKLQltdXRleF91
bmxvY2soJmRtYWJ1Zi0+bG9jayk7CisJZG1hX3Jlc3ZfdW5sb2NrKGRtYWJ1Zi0+cmVzdik7CiB9
CiAKIHN0YXRpYyBjb25zdCBzdHJ1Y3QgZmlsZV9vcGVyYXRpb25zIGRtYV9idWZfZm9wcyA9IHsK
QEAgLTUyNSw2ICs1MjUsMTAgQEAgc3RydWN0IGRtYV9idWYgKmRtYV9idWZfZXhwb3J0KGNvbnN0
IHN0cnVjdCBkbWFfYnVmX2V4cG9ydF9pbmZvICpleHBfaW5mbykKIAkJcmV0dXJuIEVSUl9QVFIo
LUVJTlZBTCk7CiAJfQogCisJaWYgKFdBUk5fT04oZXhwX2luZm8tPm9wcy0+Y2FjaGVfc2d0X21h
cHBpbmcgJiYKKwkJICAgIGV4cF9pbmZvLT5vcHMtPmR5bmFtaWNfbWFwcGluZykpCisJCXJldHVy
biBFUlJfUFRSKC1FSU5WQUwpOworCiAJaWYgKCF0cnlfbW9kdWxlX2dldChleHBfaW5mby0+b3du
ZXIpKQogCQlyZXR1cm4gRVJSX1BUUigtRU5PRU5UKTsKIApAQCAtNjQ1LDEwICs2NDksMTEgQEAg
dm9pZCBkbWFfYnVmX3B1dChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmKQogRVhQT1JUX1NZTUJPTF9H
UEwoZG1hX2J1Zl9wdXQpOwogCiAvKioKLSAqIGRtYV9idWZfYXR0YWNoIC0gQWRkIHRoZSBkZXZp
Y2UgdG8gZG1hX2J1ZidzIGF0dGFjaG1lbnRzIGxpc3Q7IG9wdGlvbmFsbHksCisgKiBkbWFfYnVm
X2R5bmFtaWNfYXR0YWNoIC0gQWRkIHRoZSBkZXZpY2UgdG8gZG1hX2J1ZidzIGF0dGFjaG1lbnRz
IGxpc3Q7IG9wdGlvbmFsbHksCiAgKiBjYWxscyBhdHRhY2goKSBvZiBkbWFfYnVmX29wcyB0byBh
bGxvdyBkZXZpY2Utc3BlY2lmaWMgYXR0YWNoIGZ1bmN0aW9uYWxpdHkKLSAqIEBkbWFidWY6CVtp
bl0JYnVmZmVyIHRvIGF0dGFjaCBkZXZpY2UgdG8uCi0gKiBAZGV2OglbaW5dCWRldmljZSB0byBi
ZSBhdHRhY2hlZC4KKyAqIEBkbWFidWY6CQlbaW5dCWJ1ZmZlciB0byBhdHRhY2ggZGV2aWNlIHRv
LgorICogQGRldjoJCVtpbl0JZGV2aWNlIHRvIGJlIGF0dGFjaGVkLgorICogQGR5bmFtaWNfbWFw
cGluZzoJW2luXQljYWxsaW5nIGNvbnZlbnRpb24gZm9yIG1hcC91bm1hcAogICoKICAqIFJldHVy
bnMgc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCBwb2ludGVyIGZvciB0aGlzIGF0dGFjaG1lbnQu
IEF0dGFjaG1lbnRzCiAgKiBtdXN0IGJlIGNsZWFuZWQgdXAgYnkgY2FsbGluZyBkbWFfYnVmX2Rl
dGFjaCgpLgpAQCAtNjYyLDggKzY2Nyw5IEBAIEVYUE9SVF9TWU1CT0xfR1BMKGRtYV9idWZfcHV0
KTsKICAqIGFjY2Vzc2libGUgdG8gQGRldiwgYW5kIGNhbm5vdCBiZSBtb3ZlZCB0byBhIG1vcmUg
c3VpdGFibGUgcGxhY2UuIFRoaXMgaXMKICAqIGluZGljYXRlZCB3aXRoIHRoZSBlcnJvciBjb2Rl
IC1FQlVTWS4KICAqLwotc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqZG1hX2J1Zl9hdHRhY2go
c3RydWN0IGRtYV9idWYgKmRtYWJ1ZiwKLQkJCQkJICBzdHJ1Y3QgZGV2aWNlICpkZXYpCitzdHJ1
Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICoKK2RtYV9idWZfZHluYW1pY19hdHRhY2goc3RydWN0IGRt
YV9idWYgKmRtYWJ1Ziwgc3RydWN0IGRldmljZSAqZGV2LAorCQkgICAgICAgYm9vbCBkeW5hbWlj
X21hcHBpbmcpCiB7CiAJc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNoOwogCWludCBy
ZXQ7CkBAIC02NzcsNiArNjgzLDcgQEAgc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqZG1hX2J1
Zl9hdHRhY2goc3RydWN0IGRtYV9idWYgKmRtYWJ1ZiwKIAogCWF0dGFjaC0+ZGV2ID0gZGV2Owog
CWF0dGFjaC0+ZG1hYnVmID0gZG1hYnVmOworCWF0dGFjaC0+ZHluYW1pY19tYXBwaW5nID0gZHlu
YW1pY19tYXBwaW5nOwogCiAJbXV0ZXhfbG9jaygmZG1hYnVmLT5sb2NrKTsKIApAQCAtNjg1LDE2
ICs2OTIsNjQgQEAgc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqZG1hX2J1Zl9hdHRhY2goc3Ry
dWN0IGRtYV9idWYgKmRtYWJ1ZiwKIAkJaWYgKHJldCkKIAkJCWdvdG8gZXJyX2F0dGFjaDsKIAl9
CisJZG1hX3Jlc3ZfbG9jayhkbWFidWYtPnJlc3YsIE5VTEwpOwogCWxpc3RfYWRkKCZhdHRhY2gt
Pm5vZGUsICZkbWFidWYtPmF0dGFjaG1lbnRzKTsKKwlkbWFfcmVzdl91bmxvY2soZG1hYnVmLT5y
ZXN2KTsKIAogCW11dGV4X3VubG9jaygmZG1hYnVmLT5sb2NrKTsKIAorCS8qIFdoZW4gZWl0aGVy
IHRoZSBpbXBvcnRlciBvciB0aGUgZXhwb3J0ZXIgY2FuJ3QgaGFuZGxlIGR5bmFtaWMKKwkgKiBt
YXBwaW5ncyB3ZSBjYWNoZSB0aGUgbWFwcGluZyBoZXJlIHRvIGF2b2lkIGlzc3VlcyB3aXRoIHRo
ZQorCSAqIHJlc2VydmF0aW9uIG9iamVjdCBsb2NrLgorCSAqLworCWlmIChkbWFfYnVmX2F0dGFj
aG1lbnRfaXNfZHluYW1pYyhhdHRhY2gpICE9CisJICAgIGRtYV9idWZfaXNfZHluYW1pYyhkbWFi
dWYpKSB7CisJCXN0cnVjdCBzZ190YWJsZSAqc2d0OworCisJCWlmIChkbWFfYnVmX2lzX2R5bmFt
aWMoYXR0YWNoLT5kbWFidWYpKQorCQkJZG1hX3Jlc3ZfbG9jayhhdHRhY2gtPmRtYWJ1Zi0+cmVz
diwgTlVMTCk7CisKKwkJc2d0ID0gZG1hYnVmLT5vcHMtPm1hcF9kbWFfYnVmKGF0dGFjaCwgRE1B
X0JJRElSRUNUSU9OQUwpOworCQlpZiAoIXNndCkKKwkJCXNndCA9IEVSUl9QVFIoLUVOT01FTSk7
CisJCWlmIChJU19FUlIoc2d0KSkgeworCQkJcmV0ID0gUFRSX0VSUihzZ3QpOworCQkJZ290byBl
cnJfdW5sb2NrOworCQl9CisJCWlmIChkbWFfYnVmX2lzX2R5bmFtaWMoYXR0YWNoLT5kbWFidWYp
KQorCQkJZG1hX3Jlc3ZfdW5sb2NrKGF0dGFjaC0+ZG1hYnVmLT5yZXN2KTsKKwkJYXR0YWNoLT5z
Z3QgPSBzZ3Q7CisJCWF0dGFjaC0+ZGlyID0gRE1BX0JJRElSRUNUSU9OQUw7CisJfQorCiAJcmV0
dXJuIGF0dGFjaDsKIAogZXJyX2F0dGFjaDoKIAlrZnJlZShhdHRhY2gpOwogCW11dGV4X3VubG9j
aygmZG1hYnVmLT5sb2NrKTsKIAlyZXR1cm4gRVJSX1BUUihyZXQpOworCitlcnJfdW5sb2NrOgor
CWlmIChkbWFfYnVmX2lzX2R5bmFtaWMoYXR0YWNoLT5kbWFidWYpKQorCQlkbWFfcmVzdl91bmxv
Y2soYXR0YWNoLT5kbWFidWYtPnJlc3YpOworCisJZG1hX2J1Zl9kZXRhY2goZG1hYnVmLCBhdHRh
Y2gpOworCXJldHVybiBFUlJfUFRSKHJldCk7Cit9CitFWFBPUlRfU1lNQk9MX0dQTChkbWFfYnVm
X2R5bmFtaWNfYXR0YWNoKTsKKworLyoqCisgKiBkbWFfYnVmX2F0dGFjaCAtIFdyYXBwZXIgZm9y
IGRtYV9idWZfZHluYW1pY19hdHRhY2gKKyAqIEBkbWFidWY6CVtpbl0JYnVmZmVyIHRvIGF0dGFj
aCBkZXZpY2UgdG8uCisgKiBAZGV2OglbaW5dCWRldmljZSB0byBiZSBhdHRhY2hlZC4KKyAqCisg
KiBXcmFwcGVyIHRvIGNhbGwgZG1hX2J1Zl9keW5hbWljX2F0dGFjaCgpIGZvciBkcml2ZXJzIHdo
aWNoIHN0aWxsIHVzZSBhIHN0YXRpYworICogbWFwcGluZy4KKyAqLworc3RydWN0IGRtYV9idWZf
YXR0YWNobWVudCAqZG1hX2J1Zl9hdHRhY2goc3RydWN0IGRtYV9idWYgKmRtYWJ1ZiwKKwkJCQkJ
ICBzdHJ1Y3QgZGV2aWNlICpkZXYpCit7CisJcmV0dXJuIGRtYV9idWZfZHluYW1pY19hdHRhY2go
ZG1hYnVmLCBkZXYsIGZhbHNlKTsKIH0KIEVYUE9SVF9TWU1CT0xfR1BMKGRtYV9idWZfYXR0YWNo
KTsKIApAQCAtNzExLDExICs3NjYsMjAgQEAgdm9pZCBkbWFfYnVmX2RldGFjaChzdHJ1Y3QgZG1h
X2J1ZiAqZG1hYnVmLCBzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhY2gpCiAJaWYgKFdB
Uk5fT04oIWRtYWJ1ZiB8fCAhYXR0YWNoKSkKIAkJcmV0dXJuOwogCi0JaWYgKGF0dGFjaC0+c2d0
KQorCWlmIChhdHRhY2gtPnNndCkgeworCQlpZiAoZG1hX2J1Zl9pc19keW5hbWljKGF0dGFjaC0+
ZG1hYnVmKSkKKwkJCWRtYV9yZXN2X2xvY2soYXR0YWNoLT5kbWFidWYtPnJlc3YsIE5VTEwpOwor
CiAJCWRtYWJ1Zi0+b3BzLT51bm1hcF9kbWFfYnVmKGF0dGFjaCwgYXR0YWNoLT5zZ3QsIGF0dGFj
aC0+ZGlyKTsKIAorCQlpZiAoZG1hX2J1Zl9pc19keW5hbWljKGF0dGFjaC0+ZG1hYnVmKSkKKwkJ
CWRtYV9yZXN2X3VubG9jayhhdHRhY2gtPmRtYWJ1Zi0+cmVzdik7CisJfQorCiAJbXV0ZXhfbG9j
aygmZG1hYnVmLT5sb2NrKTsKKwlkbWFfcmVzdl9sb2NrKGRtYWJ1Zi0+cmVzdiwgTlVMTCk7CiAJ
bGlzdF9kZWwoJmF0dGFjaC0+bm9kZSk7CisJZG1hX3Jlc3ZfdW5sb2NrKGRtYWJ1Zi0+cmVzdik7
CiAJaWYgKGRtYWJ1Zi0+b3BzLT5kZXRhY2gpCiAJCWRtYWJ1Zi0+b3BzLT5kZXRhY2goZG1hYnVm
LCBhdHRhY2gpOwogCkBAIC03NDksNiArODEzLDkgQEAgc3RydWN0IHNnX3RhYmxlICpkbWFfYnVm
X21hcF9hdHRhY2htZW50KHN0cnVjdCBkbWFfYnVmX2F0dGFjaG1lbnQgKmF0dGFjaCwKIAlpZiAo
V0FSTl9PTighYXR0YWNoIHx8ICFhdHRhY2gtPmRtYWJ1ZikpCiAJCXJldHVybiBFUlJfUFRSKC1F
SU5WQUwpOwogCisJaWYgKGRtYV9idWZfYXR0YWNobWVudF9pc19keW5hbWljKGF0dGFjaCkpCisJ
CWRtYV9yZXN2X2Fzc2VydF9oZWxkKGF0dGFjaC0+ZG1hYnVmLT5yZXN2KTsKKwogCWlmIChhdHRh
Y2gtPnNndCkgewogCQkvKgogCQkgKiBUd28gbWFwcGluZ3Mgd2l0aCBkaWZmZXJlbnQgZGlyZWN0
aW9ucyBmb3IgdGhlIHNhbWUKQEAgLTc2MSw2ICs4MjgsOSBAQCBzdHJ1Y3Qgc2dfdGFibGUgKmRt
YV9idWZfbWFwX2F0dGFjaG1lbnQoc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNoLAog
CQlyZXR1cm4gYXR0YWNoLT5zZ3Q7CiAJfQogCisJaWYgKGRtYV9idWZfaXNfZHluYW1pYyhhdHRh
Y2gtPmRtYWJ1ZikpCisJCWRtYV9yZXN2X2Fzc2VydF9oZWxkKGF0dGFjaC0+ZG1hYnVmLT5yZXN2
KTsKKwogCXNnX3RhYmxlID0gYXR0YWNoLT5kbWFidWYtPm9wcy0+bWFwX2RtYV9idWYoYXR0YWNo
LCBkaXJlY3Rpb24pOwogCWlmICghc2dfdGFibGUpCiAJCXNnX3RhYmxlID0gRVJSX1BUUigtRU5P
TUVNKTsKQEAgLTc5Myw5ICs4NjMsMTUgQEAgdm9pZCBkbWFfYnVmX3VubWFwX2F0dGFjaG1lbnQo
c3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNoLAogCWlmIChXQVJOX09OKCFhdHRhY2gg
fHwgIWF0dGFjaC0+ZG1hYnVmIHx8ICFzZ190YWJsZSkpCiAJCXJldHVybjsKIAorCWlmIChkbWFf
YnVmX2F0dGFjaG1lbnRfaXNfZHluYW1pYyhhdHRhY2gpKQorCQlkbWFfcmVzdl9hc3NlcnRfaGVs
ZChhdHRhY2gtPmRtYWJ1Zi0+cmVzdik7CisKIAlpZiAoYXR0YWNoLT5zZ3QgPT0gc2dfdGFibGUp
CiAJCXJldHVybjsKIAorCWlmIChkbWFfYnVmX2lzX2R5bmFtaWMoYXR0YWNoLT5kbWFidWYpKQor
CQlkbWFfcmVzdl9hc3NlcnRfaGVsZChhdHRhY2gtPmRtYWJ1Zi0+cmVzdik7CisKIAlhdHRhY2gt
PmRtYWJ1Zi0+b3BzLT51bm1hcF9kbWFfYnVmKGF0dGFjaCwgc2dfdGFibGUsIGRpcmVjdGlvbik7
CiB9CiBFWFBPUlRfU1lNQk9MX0dQTChkbWFfYnVmX3VubWFwX2F0dGFjaG1lbnQpOwpAQCAtMTIx
OSwxMCArMTI5NSwxMiBAQCBzdGF0aWMgaW50IGRtYV9idWZfZGVidWdfc2hvdyhzdHJ1Y3Qgc2Vx
X2ZpbGUgKnMsIHZvaWQgKnVudXNlZCkKIAkJc2VxX3B1dHMocywgIlx0QXR0YWNoZWQgRGV2aWNl
czpcbiIpOwogCQlhdHRhY2hfY291bnQgPSAwOwogCisJCWRtYV9yZXN2X2xvY2soYnVmX29iai0+
cmVzdiwgTlVMTCk7CiAJCWxpc3RfZm9yX2VhY2hfZW50cnkoYXR0YWNoX29iaiwgJmJ1Zl9vYmot
PmF0dGFjaG1lbnRzLCBub2RlKSB7CiAJCQlzZXFfcHJpbnRmKHMsICJcdCVzXG4iLCBkZXZfbmFt
ZShhdHRhY2hfb2JqLT5kZXYpKTsKIAkJCWF0dGFjaF9jb3VudCsrOwogCQl9CisJCWRtYV9yZXN2
X3VubG9jayhidWZfb2JqLT5yZXN2KTsKIAogCQlzZXFfcHJpbnRmKHMsICJUb3RhbCAlZCBkZXZp
Y2VzIGF0dGFjaGVkXG5cbiIsCiAJCQkJYXR0YWNoX2NvdW50KTsKZGlmZiAtLWdpdCBhL2luY2x1
ZGUvbGludXgvZG1hLWJ1Zi5oIGIvaW5jbHVkZS9saW51eC9kbWEtYnVmLmgKaW5kZXggZWMyMTJj
YjI3ZmRjLi5iY2MwZjRkMGI2NzggMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvbGludXgvZG1hLWJ1Zi5o
CisrKyBiL2luY2x1ZGUvbGludXgvZG1hLWJ1Zi5oCkBAIC00Miw2ICs0MiwxOCBAQCBzdHJ1Y3Qg
ZG1hX2J1Zl9vcHMgewogCSAgKi8KIAlib29sIGNhY2hlX3NndF9tYXBwaW5nOwogCisJLyoqCisJ
ICogQGR5bmFtaWNfbWFwcGluZzoKKwkgKgorCSAqIElmIHRydWUgdGhlIGZyYW1ld29yayBtYWtl
cyBzdXJlIHRoYXQgdGhlIG1hcC91bm1hcF9kbWFfYnVmCisJICogY2FsbGJhY2tzIGFyZSBhbHdh
eXMgY2FsbGVkIHdpdGggdGhlIGRtYV9yZXN2IG9iamVjdCBsb2NrZWQuCisJICoKKwkgKiBJZiBm
YWxzZSB0aGUgZnJhbWV3b3JrIG1ha2VzIHVyZSB0aGF0IHRoZSBtYXAvdW5tYXBfZG1hX2J1Zgor
CSAqIGNhbGxiYWNrcyBhcmUgYWx3YXlzIGNhbGxlZCB3aXRob3V0IHRoZSBkbWFfcmVzdiBvYmpl
Y3QgbG9ja2VkLgorCSAqIE11dHVhbCBleGNsdXNpdmUgd2l0aCBAY2FjaGVfc2d0X21hcHBpbmcu
CisJICovCisJYm9vbCBkeW5hbWljX21hcHBpbmc7CisKIAkvKioKIAkgKiBAYXR0YWNoOgogCSAq
CkBAIC0xMDksNiArMTIxLDkgQEAgc3RydWN0IGRtYV9idWZfb3BzIHsKIAkgKiBhbnkgb3RoZXIg
a2luZCBvZiBzaGFyaW5nIHRoYXQgdGhlIGV4cG9ydGVyIG1pZ2h0IHdpc2ggdG8gbWFrZQogCSAq
IGF2YWlsYWJsZSB0byBidWZmZXItdXNlcnMuCiAJICoKKwkgKiBUaGlzIGlzIGFsd2F5cyBjYWxs
ZWQgd2l0aCB0aGUgZG1hYnVmLT5yZXN2IG9iamVjdCBsb2NrZWQgd2hlbgorCSAqIHRoZSBkeW5h
bWljX21hcHBpbmcgZmxhZyBpcyB0cnVlLgorCSAqCiAJICogUmV0dXJuczoKIAkgKgogCSAqIEEg
JnNnX3RhYmxlIHNjYXR0ZXIgbGlzdCBvZiBvciB0aGUgYmFja2luZyBzdG9yYWdlIG9mIHRoZSBE
TUEgYnVmZmVyLApAQCAtMjY3LDcgKzI4Miw4IEBAIHN0cnVjdCBkbWFfYnVmX29wcyB7CiAgKiBz
dHJ1Y3QgZG1hX2J1ZiAtIHNoYXJlZCBidWZmZXIgb2JqZWN0CiAgKiBAc2l6ZTogc2l6ZSBvZiB0
aGUgYnVmZmVyCiAgKiBAZmlsZTogZmlsZSBwb2ludGVyIHVzZWQgZm9yIHNoYXJpbmcgYnVmZmVy
cyBhY3Jvc3MsIGFuZCBmb3IgcmVmY291bnRpbmcuCi0gKiBAYXR0YWNobWVudHM6IGxpc3Qgb2Yg
ZG1hX2J1Zl9hdHRhY2htZW50IHRoYXQgZGVub3RlcyBhbGwgZGV2aWNlcyBhdHRhY2hlZC4KKyAq
IEBhdHRhY2htZW50czogbGlzdCBvZiBkbWFfYnVmX2F0dGFjaG1lbnQgdGhhdCBkZW5vdGVzIGFs
bCBkZXZpY2VzIGF0dGFjaGVkLAorICogICAgICAgICAgICAgICBwcm90ZWN0ZWQgYnkgZG1hX3Jl
c3YgbG9jay4KICAqIEBvcHM6IGRtYV9idWZfb3BzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIGJ1ZmZl
ciBvYmplY3QuCiAgKiBAbG9jazogdXNlZCBpbnRlcm5hbGx5IHRvIHNlcmlhbGl6ZSBsaXN0IG1h
bmlwdWxhdGlvbiwgYXR0YWNoL2RldGFjaCBhbmQKICAqICAgICAgICB2bWFwL3VubWFwLCBhbmQg
YWNjZXNzZXMgdG8gbmFtZQpAQCAtMzIzLDEwICszMzksMTIgQEAgc3RydWN0IGRtYV9idWYgewog
ICogc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAtIGhvbGRzIGRldmljZS1idWZmZXIgYXR0YWNo
bWVudCBkYXRhCiAgKiBAZG1hYnVmOiBidWZmZXIgZm9yIHRoaXMgYXR0YWNobWVudC4KICAqIEBk
ZXY6IGRldmljZSBhdHRhY2hlZCB0byB0aGUgYnVmZmVyLgotICogQG5vZGU6IGxpc3Qgb2YgZG1h
X2J1Zl9hdHRhY2htZW50LgorICogQG5vZGU6IGxpc3Qgb2YgZG1hX2J1Zl9hdHRhY2htZW50LCBw
cm90ZWN0ZWQgYnkgZG1hX3Jlc3YgbG9jayBvZiB0aGUgZG1hYnVmLgogICogQHNndDogY2FjaGVk
IG1hcHBpbmcuCiAgKiBAZGlyOiBkaXJlY3Rpb24gb2YgY2FjaGVkIG1hcHBpbmcuCiAgKiBAcHJp
djogZXhwb3J0ZXIgc3BlY2lmaWMgYXR0YWNobWVudCBkYXRhLgorICogQGR5bmFtaWNfbWFwcGlu
ZzogdHJ1ZSBpZiBkbWFfYnVmX21hcC91bm1hcF9hdHRhY2htZW50KCkgaXMgY2FsbGVkIHdpdGgg
dGhlCisgKiBkbWFfcmVzdiBsb2NrIGhlbGQuCiAgKgogICogVGhpcyBzdHJ1Y3R1cmUgaG9sZHMg
dGhlIGF0dGFjaG1lbnQgaW5mb3JtYXRpb24gYmV0d2VlbiB0aGUgZG1hX2J1ZiBidWZmZXIKICAq
IGFuZCBpdHMgdXNlciBkZXZpY2UocykuIFRoZSBsaXN0IGNvbnRhaW5zIG9uZSBhdHRhY2htZW50
IHN0cnVjdCBwZXIgZGV2aWNlCkBAIC0zNDMsNiArMzYxLDcgQEAgc3RydWN0IGRtYV9idWZfYXR0
YWNobWVudCB7CiAJc3RydWN0IGxpc3RfaGVhZCBub2RlOwogCXN0cnVjdCBzZ190YWJsZSAqc2d0
OwogCWVudW0gZG1hX2RhdGFfZGlyZWN0aW9uIGRpcjsKKwlib29sIGR5bmFtaWNfbWFwcGluZzsK
IAl2b2lkICpwcml2OwogfTsKIApAQCAtMzk0LDEwICs0MTMsMzkgQEAgc3RhdGljIGlubGluZSB2
b2lkIGdldF9kbWFfYnVmKHN0cnVjdCBkbWFfYnVmICpkbWFidWYpCiAJZ2V0X2ZpbGUoZG1hYnVm
LT5maWxlKTsKIH0KIAorLyoqCisgKiBkbWFfYnVmX2lzX2R5bmFtaWMgLSBjaGVjayBpZiBhIERN
QS1idWYgdXNlcyBkeW5hbWljIG1hcHBpbmdzLgorICogQGRtYWJ1ZjogdGhlIERNQS1idWYgdG8g
Y2hlY2sKKyAqCisgKiBSZXR1cm5zIHRydWUgaWYgYSBETUEtYnVmIGV4cG9ydGVyIHdhbnRzIHRv
IGJlIGNhbGxlZCB3aXRoIHRoZSBkbWFfcmVzdgorICogbG9ja2VkLCBmYWxzZSBpZiBpdCBkb2Vz
bid0IHdhbnRzIHRvIGJlIGNhbGxlZCB3aXRoIHRoZSBsb2NrIGhlbGQuCisgKi8KK3N0YXRpYyBp
bmxpbmUgYm9vbCBkbWFfYnVmX2lzX2R5bmFtaWMoc3RydWN0IGRtYV9idWYgKmRtYWJ1ZikKK3sK
KwlyZXR1cm4gZG1hYnVmLT5vcHMtPmR5bmFtaWNfbWFwcGluZzsKK30KKworLyoqCisgKiBkbWFf
YnVmX2F0dGFjaG1lbnRfaXNfZHluYW1pYyAtIGNoZWNrIGlmIGEgRE1BLWJ1ZiBhdHRhY2htZW50
IHVzZXMgZHluYW1pYworICogbWFwcGluc2cKKyAqIEBhdHRhY2g6IHRoZSBETUEtYnVmIGF0dGFj
aG1lbnQgdG8gY2hlY2sKKyAqCisgKiBSZXR1cm5zIHRydWUgaWYgYSBETUEtYnVmIGltcG9ydGVy
IHdhbnRzIHRvIGNhbGwgdGhlIG1hcC91bm1hcCBmdW5jdGlvbnMgd2l0aAorICogdGhlIGRtYV9y
ZXN2IGxvY2sgaGVsZC4KKyAqLworc3RhdGljIGlubGluZSBib29sCitkbWFfYnVmX2F0dGFjaG1l
bnRfaXNfZHluYW1pYyhzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhY2gpCit7CisJcmV0
dXJuIGF0dGFjaC0+ZHluYW1pY19tYXBwaW5nOworfQorCiBzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2ht
ZW50ICpkbWFfYnVmX2F0dGFjaChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAotCQkJCQkJCXN0cnVj
dCBkZXZpY2UgKmRldik7CisJCQkJCSAgc3RydWN0IGRldmljZSAqZGV2KTsKK3N0cnVjdCBkbWFf
YnVmX2F0dGFjaG1lbnQgKgorZG1hX2J1Zl9keW5hbWljX2F0dGFjaChzdHJ1Y3QgZG1hX2J1ZiAq
ZG1hYnVmLCBzdHJ1Y3QgZGV2aWNlICpkZXYsCisJCSAgICAgICBib29sIGR5bmFtaWNfbWFwcGlu
Zyk7CiB2b2lkIGRtYV9idWZfZGV0YWNoKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCi0JCQkJc3Ry
dWN0IGRtYV9idWZfYXR0YWNobWVudCAqZG1hYnVmX2F0dGFjaCk7CisJCSAgICBzdHJ1Y3QgZG1h
X2J1Zl9hdHRhY2htZW50ICphdHRhY2gpOwogCiBzdHJ1Y3QgZG1hX2J1ZiAqZG1hX2J1Zl9leHBv
cnQoY29uc3Qgc3RydWN0IGRtYV9idWZfZXhwb3J0X2luZm8gKmV4cF9pbmZvKTsKIApAQCAtNDA5
LDYgKzQ1Nyw3IEBAIHN0cnVjdCBzZ190YWJsZSAqZG1hX2J1Zl9tYXBfYXR0YWNobWVudChzdHJ1
Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICosCiAJCQkJCWVudW0gZG1hX2RhdGFfZGlyZWN0aW9uKTsK
IHZvaWQgZG1hX2J1Zl91bm1hcF9hdHRhY2htZW50KHN0cnVjdCBkbWFfYnVmX2F0dGFjaG1lbnQg
Kiwgc3RydWN0IHNnX3RhYmxlICosCiAJCQkJZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24pOwordm9p
ZCBkbWFfYnVmX21vdmVfbm90aWZ5KHN0cnVjdCBkbWFfYnVmICpkbWFfYnVmKTsKIGludCBkbWFf
YnVmX2JlZ2luX2NwdV9hY2Nlc3Moc3RydWN0IGRtYV9idWYgKmRtYV9idWYsCiAJCQkgICAgIGVu
dW0gZG1hX2RhdGFfZGlyZWN0aW9uIGRpcik7CiBpbnQgZG1hX2J1Zl9lbmRfY3B1X2FjY2Vzcyhz
dHJ1Y3QgZG1hX2J1ZiAqZG1hX2J1ZiwKLS0gCjIuMTcuMQoKX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2
ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21h
aWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
