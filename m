Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 33F2B33FAEA
	for <lists+dri-devel@lfdr.de>; Wed, 17 Mar 2021 23:19:58 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9D1776E047;
	Wed, 17 Mar 2021 22:19:52 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pg1-x535.google.com (mail-pg1-x535.google.com
 [IPv6:2607:f8b0:4864:20::535])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 925F56E048
 for <dri-devel@lists.freedesktop.org>; Wed, 17 Mar 2021 22:19:50 +0000 (UTC)
Received: by mail-pg1-x535.google.com with SMTP id y27so131968pga.9
 for <dri-devel@lists.freedesktop.org>; Wed, 17 Mar 2021 15:19:50 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=jlekstrand-net.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=r9RCUmX1dma+8m+9py1IfH9xn4V00HXuvse/jejKM1I=;
 b=VTbEcR70LUWhphik2UQ5VhtH6Yg3XCmIy/+T65GOkpI2yCTz8wzOCqlvHJC3AS9Rg2
 4pDOM0BeRt/BDxATlEfEd5UQdGt5bLcPEqP4zuUp2BbBcWymKONN2gd7RTKAgcFdOKAH
 Z+kP+mRPcMc3Ec/fiDnup1yi20hWPo+yPHnlr4mE8Yb0yufd5BM0UeRIGsvxH72fkQlR
 f8ND4O95hES8HTQLTnNl4fLRBdSeBFUtgBNN5KlOPmcqrlxCCOXA3AyednKwORh0j4AJ
 SkvjFG6Iu9YZ42LIZz5jaQoydjHC1QXycIKI/WqIvItoYNh/pgopGcdPW7uRuXg2W8qn
 Ormg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=r9RCUmX1dma+8m+9py1IfH9xn4V00HXuvse/jejKM1I=;
 b=LJf0ovW8n+Qp/69Bs+BQ5JqDFj5Hmqwk0C9t8tuY6tS2iYNNSU6LrnB5ES9BWzTIjr
 nIkXJ7wMJdkg99+Y2chxyXYMXuo3AHLY3STrP6YegSS7OmycLMqBQDNKNbCeZrT57wxJ
 yZ+ifwksHKmS06fO84BpbtbmrQhZ+dGePXRY1qD5ldCMaUkDu3tFaWp/8lJsKJoNW2Hx
 EeLN0ZNurtGwLhqw/Px52Vw+AkGH8ch81wPryWp0/CGAvm0ezjOsOLhUOu37S2QdW0OS
 iWBAZDcVsO5+xxA2QGB29LkJ2hVTaPahNJEebpG58Nc2pdS8Z/63ypTLKjNOKXtPOoxL
 gi7A==
X-Gm-Message-State: AOAM531b9nUECeNn9hulPvx6Uv5a8eG3BbcPDA6EbiOipExQQjuIu5Wm
 qESNhJWbdCt05VKQpJHsUzsjryVd5SXQww==
X-Google-Smtp-Source: ABdhPJyN6YHo9Cc4iNfZ2g1PlXhc4k2dpE98aPk8Jev2usbTqDSOiEly7dUiaPGaCHTYq29ge6tyLg==
X-Received: by 2002:a05:6a00:ad1:b029:1ec:c826:55aa with SMTP id
 c17-20020a056a000ad1b02901ecc82655aamr1053928pfl.26.1616019589581; 
 Wed, 17 Mar 2021 15:19:49 -0700 (PDT)
Received: from omlet.lan (jfdmzpr05-ext.jf.intel.com. [134.134.139.74])
 by smtp.gmail.com with ESMTPSA id l19sm117708pjt.16.2021.03.17.15.19.47
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Wed, 17 Mar 2021 15:19:49 -0700 (PDT)
From: Jason Ekstrand <jason@jlekstrand.net>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH 2/3] dma-buf: add dma_resv_get_singleton_rcu (v3)
Date: Wed, 17 Mar 2021 17:19:39 -0500
Message-Id: <20210317221940.2146688-3-jason@jlekstrand.net>
X-Mailer: git-send-email 2.29.2
In-Reply-To: <20210317221940.2146688-1-jason@jlekstrand.net>
References: <20210316045322.2020294-1-jason@jlekstrand.net>
 <20210317221940.2146688-1-jason@jlekstrand.net>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Jason Ekstrand <jason@jlekstrand.net>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

QWRkIGEgaGVscGVyIGZ1bmN0aW9uIHRvIGdldCBhIHNpbmdsZSBmZW5jZSByZXByZXNlbnRpbmcK
YWxsIGZlbmNlcyBpbiBhIGRtYV9yZXN2IG9iamVjdC4KClRoaXMgZmVuY2UgaXMgZWl0aGVyIHRo
ZSBvbmx5IG9uZSBpbiB0aGUgb2JqZWN0IG9yIGFsbCBub3QKc2lnbmFsZWQgZmVuY2VzIG9mIHRo
ZSBvYmplY3QgaW4gYSBmbGF0dGVkIG91dCBkbWFfZmVuY2VfYXJyYXkuCgp2MiAoSmFzb24gRWtz
dHJhbmQpOgogLSBUYWtlIHJlZmVyZW5jZSBvZiBmZW5jZXMgYm90aCBmb3IgY3JlYXRpbmcgdGhl
IGRtYV9mZW5jZV9hcnJheSBhbmQgaW4KICAgdGhlIGNhc2Ugd2hlcmUgd2UgcmV0dXJuIG9uZSBm
ZW5jZS4KIC0gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIGRtYV9yZXN2X2dldF9saXN0KCkgcmV0dXJu
cyBOVUxMCgp2MyAoSmFzb24gRWtzdHJhbmQpOgogLSBBZGQgYW4gX3JjdSBzdWZmaXggYmVjYXVz
ZSBpdCBpcyByZWFkLW9ubHkKIC0gUmV3cml0ZSB0byB1c2UgZG1hX3Jlc3ZfZ2V0X2ZlbmNlc19y
Y3Ugc28gaXQncyBSQ1Utc2FmZQogLSBBZGQgYW4gRVhQT1JUX1NZTUJPTF9HUEwgZGVjbGFyYXRp
b24KIC0gUmUtYXV0aG9yIHRoZSBwYXRjaCB0byBKYXNvbiBzaW5jZSB2ZXJ5IGxpdHRsZSBpcyBs
ZWZ0IG9mIENocmlzdGlhbgogICBLw7ZuaWcncyBvcmlnaW5hbCBwYXRjaAoKU2lnbmVkLW9mZi1i
eTogSmFzb24gRWtzdHJhbmQgPGphc29uQGpsZWtzdHJhbmQubmV0PgotLS0KIGRyaXZlcnMvZG1h
LWJ1Zi9kbWEtcmVzdi5jIHwgMTA0ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysKIGluY2x1ZGUvbGludXgvZG1hLXJlc3YuaCAgIHwgICAyICsKIDIgZmlsZXMgY2hhbmdlZCwg
MTA2IGluc2VydGlvbnMoKykKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvZG1hLXJlc3Yu
YyBiL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtcmVzdi5jCmluZGV4IDZkZGJlYjVkZmJmNjUuLjVkZDRj
MzhiZDljYjQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtcmVzdi5jCisrKyBiL2Ry
aXZlcnMvZG1hLWJ1Zi9kbWEtcmVzdi5jCkBAIC0zMyw2ICszMyw4IEBACiAgKi8KIAogI2luY2x1
ZGUgPGxpbnV4L2RtYS1yZXN2Lmg+CisjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLWNoYWluLmg+
CisjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLWFycmF5Lmg+CiAjaW5jbHVkZSA8bGludXgvZXhw
b3J0Lmg+CiAjaW5jbHVkZSA8bGludXgvbW0uaD4KICNpbmNsdWRlIDxsaW51eC9zY2hlZC9tbS5o
PgpAQCAtNDksNiArNTEsMTkgQEAKICAqIHdyaXRlLXNpZGUgdXBkYXRlcy4KICAqLwogCisvKioK
KyAqIGRtYV9mZW5jZV9kZWVwX2RpdmVfZm9yX2VhY2ggLSBkZWVwIGRpdmUgaW50byB0aGUgZmVu
Y2UgY29udGFpbmVycworICogQGZlbmNlOiByZXN1bHRpbmcgZmVuY2UKKyAqIEBjaGFpbjogdmFy
aWFibGUgZm9yIGEgZG1hX2ZlbmNlX2NoYWluCisgKiBAaW5kZXg6IGluZGV4IGludG8gYSBkbWFf
ZmVuY2VfYXJyYXkKKyAqIEBoZWFkOiBzdGFydGluZyBwb2ludAorICoKKyAqIEhlbHBlciB0byBk
ZWVwIGRpdmUgaW50byB0aGUgZmVuY2UgY29udGFpbmVycyBmb3IgZmxhdHRlbmluZyB0aGVtLgor
ICovCisjZGVmaW5lIGRtYV9mZW5jZV9kZWVwX2RpdmVfZm9yX2VhY2goZmVuY2UsIGNoYWluLCBp
bmRleCwgaGVhZCkJXAorCWRtYV9mZW5jZV9jaGFpbl9mb3JfZWFjaChjaGFpbiwgaGVhZCkJCQlc
CisJCWRtYV9mZW5jZV9hcnJheV9mb3JfZWFjaChmZW5jZSwgaW5kZXgsIGNoYWluKQorCiBERUZJ
TkVfV0RfQ0xBU1MocmVzZXJ2YXRpb25fd3dfY2xhc3MpOwogRVhQT1JUX1NZTUJPTChyZXNlcnZh
dGlvbl93d19jbGFzcyk7CiAKQEAgLTUxNyw2ICs1MzIsOTUgQEAgaW50IGRtYV9yZXN2X2dldF9m
ZW5jZXNfcmN1KHN0cnVjdCBkbWFfcmVzdiAqb2JqLAogfQogRVhQT1JUX1NZTUJPTF9HUEwoZG1h
X3Jlc3ZfZ2V0X2ZlbmNlc19yY3UpOwogCisvKioKKyAqIGRtYV9yZXN2X2dldF9zaW5nbGV0b24g
LSBnZXQgYSBzaW5nbGUgZmVuY2UgZm9yIHRoZSBkbWFfcmVzdiBvYmplY3QKKyAqIEBvYmo6IHRo
ZSByZXNlcnZhdGlvbiBvYmplY3QKKyAqIEBleHRyYTogZXh0cmEgZmVuY2UgdG8gYWRkIHRvIHRo
ZSByZXN1bHRpbmcgYXJyYXkKKyAqIEByZXN1bHQ6IHJlc3VsdGluZyBkbWFfZmVuY2UKKyAqCisg
KiBHZXQgYSBzaW5nbGUgZmVuY2UgcmVwcmVzZW50aW5nIGFsbCB1bnNpZ25hbGVkIGZlbmNlcyBp
biB0aGUgZG1hX3Jlc3Ygb2JqZWN0CisgKiBwbHVzIHRoZSBnaXZlbiBleHRyYSBmZW5jZS4gSWYg
d2UgZ290IG9ubHkgb25lIGZlbmNlIHJldHVybiBhIG5ldworICogcmVmZXJlbmNlIHRvIHRoYXQs
IG90aGVyd2lzZSByZXR1cm4gYSBkbWFfZmVuY2VfYXJyYXkgb2JqZWN0LgorICoKKyAqIFJFVFVS
TlMKKyAqIFJldHVybnMgLU5PTUVNIGlmIGFsbG9jYXRpb25zIGZhaWwsIHplcm8gb3RoZXJ3aXNl
LgorICovCitpbnQgZG1hX3Jlc3ZfZ2V0X3NpbmdsZXRvbl9yY3Uoc3RydWN0IGRtYV9yZXN2ICpv
YmosIHN0cnVjdCBkbWFfZmVuY2UgKipyZXN1bHQpCit7CisJc3RydWN0IGRtYV9mZW5jZSAqKnJl
c3ZfZmVuY2VzLCAqZmVuY2UsICpjaGFpbiwgKipmZW5jZXM7CisJc3RydWN0IGRtYV9mZW5jZV9h
cnJheSAqYXJyYXk7CisJdW5zaWduZWQgaW50IG51bV9yZXN2X2ZlbmNlcywgbnVtX2ZlbmNlczsK
Kwl1bnNpZ25lZCBpbnQgcmV0LCBpLCBqOworCisJcmV0ID0gZG1hX3Jlc3ZfZ2V0X2ZlbmNlc19y
Y3Uob2JqLCBOVUxMLCAmbnVtX3Jlc3ZfZmVuY2VzLCAmcmVzdl9mZW5jZXMpOworCWlmIChyZXQp
CisJCXJldHVybiByZXQ7CisKKwludW1fZmVuY2VzID0gMDsKKwkqcmVzdWx0ID0gTlVMTDsKKwor
CWlmIChudW1fcmVzdl9mZW5jZXMgPT0gMCkKKwkJcmV0dXJuIDA7CisKKwlmb3IgKGkgPSAwOyBp
IDwgbnVtX3Jlc3ZfZmVuY2VzOyArK2kpIHsKKwkJZG1hX2ZlbmNlX2RlZXBfZGl2ZV9mb3JfZWFj
aChmZW5jZSwgY2hhaW4sIGosIHJlc3ZfZmVuY2VzW2ldKSB7CisJCQlpZiAoZG1hX2ZlbmNlX2lz
X3NpZ25hbGVkKGZlbmNlKSkKKwkJCQljb250aW51ZTsKKworCQkJKnJlc3VsdCA9IGZlbmNlOwor
CQkJKytudW1fZmVuY2VzOworCQl9CisJfQorCisJaWYgKG51bV9mZW5jZXMgPD0gMSkgeworCQkq
cmVzdWx0ID0gZG1hX2ZlbmNlX2dldCgqcmVzdWx0KTsKKwkJZ290byBwdXRfcmVzdl9mZW5jZXM7
CisJfQorCisJZmVuY2VzID0ga21hbGxvY19hcnJheShudW1fZmVuY2VzLCBzaXplb2Yoc3RydWN0
IGRtYV9mZW5jZSopLAorCQkJICAgICAgIEdGUF9LRVJORUwpOworCWlmICghZmVuY2VzKSB7CisJ
CSpyZXN1bHQgPSBOVUxMOworCQlyZXQgPSAtRU5PTUVNOworCQlnb3RvIHB1dF9yZXN2X2ZlbmNl
czsKKwl9CisKKwludW1fZmVuY2VzID0gMDsKKwlmb3IgKGkgPSAwOyBpIDwgbnVtX3Jlc3ZfZmVu
Y2VzOyArK2kpIHsKKwkJZG1hX2ZlbmNlX2RlZXBfZGl2ZV9mb3JfZWFjaChmZW5jZSwgY2hhaW4s
IGosIHJlc3ZfZmVuY2VzW2ldKSB7CisJCQlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZChmZW5j
ZSkpCisJCQkJZmVuY2VzW251bV9mZW5jZXMrK10gPSBkbWFfZmVuY2VfZ2V0KGZlbmNlKTsKKwkJ
fQorCX0KKworCWlmIChudW1fZmVuY2VzIDw9IDEpIHsKKwkJKnJlc3VsdCA9IG51bV9mZW5jZXMg
PyBmZW5jZXNbMF0gOiBOVUxMOworCQlrZnJlZShmZW5jZXMpOworCQlnb3RvIHB1dF9yZXN2X2Zl
bmNlczsKKwl9CisKKwlhcnJheSA9IGRtYV9mZW5jZV9hcnJheV9jcmVhdGUobnVtX2ZlbmNlcywg
ZmVuY2VzLAorCQkJCSAgICAgICBkbWFfZmVuY2VfY29udGV4dF9hbGxvYygxKSwKKwkJCQkgICAg
ICAgMSwgZmFsc2UpOworCWlmIChhcnJheSkgeworCQkqcmVzdWx0ID0gJmFycmF5LT5iYXNlOwor
CX0gZWxzZSB7CisJCSpyZXN1bHQgPSBOVUxMOworCQl3aGlsZSAobnVtX2ZlbmNlcy0tKQorCQkJ
ZG1hX2ZlbmNlX3B1dChmZW5jZXNbbnVtX2ZlbmNlc10pOworCQlrZnJlZShmZW5jZXMpOworCQly
ZXQgPSAtRU5PTUVNOworCX0KKworcHV0X3Jlc3ZfZmVuY2VzOgorCXdoaWxlIChudW1fcmVzdl9m
ZW5jZXMtLSkKKwkJZG1hX2ZlbmNlX3B1dChyZXN2X2ZlbmNlc1tudW1fcmVzdl9mZW5jZXNdKTsK
KwlrZnJlZShyZXN2X2ZlbmNlcyk7CisKKwlyZXR1cm4gcmV0OworfQorRVhQT1JUX1NZTUJPTF9H
UEwoZG1hX3Jlc3ZfZ2V0X3NpbmdsZXRvbl9yY3UpOworCiAvKioKICAqIGRtYV9yZXN2X3dhaXRf
dGltZW91dF9yY3UgLSBXYWl0IG9uIHJlc2VydmF0aW9uJ3Mgb2JqZWN0cwogICogc2hhcmVkIGFu
ZC9vciBleGNsdXNpdmUgZmVuY2VzLgpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9saW51eC9kbWEtcmVz
di5oIGIvaW5jbHVkZS9saW51eC9kbWEtcmVzdi5oCmluZGV4IGQ0NGE3N2U4YTdlMzQuLjVmODI4
OTRmZWQwYjkgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvbGludXgvZG1hLXJlc3YuaAorKysgYi9pbmNs
dWRlL2xpbnV4L2RtYS1yZXN2LmgKQEAgLTI4NSw2ICsyODUsOCBAQCBpbnQgZG1hX3Jlc3ZfZ2V0
X2ZlbmNlc19yY3Uoc3RydWN0IGRtYV9yZXN2ICpvYmosCiAKIGludCBkbWFfcmVzdl9jb3B5X2Zl
bmNlcyhzdHJ1Y3QgZG1hX3Jlc3YgKmRzdCwgc3RydWN0IGRtYV9yZXN2ICpzcmMpOwogCitpbnQg
ZG1hX3Jlc3ZfZ2V0X3NpbmdsZXRvbl9yY3Uoc3RydWN0IGRtYV9yZXN2ICpvYmosIHN0cnVjdCBk
bWFfZmVuY2UgKipyZXN1bHQpOworCiBsb25nIGRtYV9yZXN2X3dhaXRfdGltZW91dF9yY3Uoc3Ry
dWN0IGRtYV9yZXN2ICpvYmosIGJvb2wgd2FpdF9hbGwsIGJvb2wgaW50ciwKIAkJCSAgICAgICB1
bnNpZ25lZCBsb25nIHRpbWVvdXQpOwogCi0tIAoyLjI5LjIKCl9fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRl
dmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9t
YWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
