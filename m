Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 0C96E8DD58
	for <lists+dri-devel@lfdr.de>; Wed, 14 Aug 2019 20:47:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AC2256E7E6;
	Wed, 14 Aug 2019 18:47:30 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pf1-x444.google.com (mail-pf1-x444.google.com
 [IPv6:2607:f8b0:4864:20::444])
 by gabe.freedesktop.org (Postfix) with ESMTPS id DA1D86E7DC
 for <dri-devel@lists.freedesktop.org>; Wed, 14 Aug 2019 18:47:21 +0000 (UTC)
Received: by mail-pf1-x444.google.com with SMTP id f17so50104239pfn.6
 for <dri-devel@lists.freedesktop.org>; Wed, 14 Aug 2019 11:47:21 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=S7G+b/AKW3ZGIOc1Uy5hIvA+emi22Ls1Jq5SWNDVSjE=;
 b=nspqBp8tyL9z7DB1tYYMW7wd+Vr53F3s1oP++y6QrNXEBR1iFeAKgx+3G58IBHHGfw
 aqyMXYlg/hGCF3yTdPz/xDkfbVBcQjBt9XPxgQTHOzjBxo8cT0UL3k/1HoNnFbMRlGw4
 W+3eGO2JjY2mKIZwTs3NGd/5qK1K49KBZBr/VmjowjTx8MWGDUtSELTjE/psPLtnsBLX
 K18hQagElIUH7G43JdHVO5pEVEIpE/AirQRFjIRbcCudyo7HGSkowArt2SVQzzP38bZ9
 LG3NM4E61MX7b9qTVvest1Faqgk3uxB8OzFv2pXQbRBLW3NLW4uEih5pyQauRTmyXnmg
 0N4w==
X-Gm-Message-State: APjAAAXZvOdiwtACePNYikqkW09qKTdwiYb/HyOmiI8ue6Tak0Xzf1QM
 FJBpRx2HstkzjlPVKmcFLXmaswexmro=
X-Google-Smtp-Source: APXvYqycFrgHQDs7Dh4+d+eohgA56r1m5xdvJK1utw9z5PlXMq5ucRmdbzs2NNCTGHKWQ0/rxxINJw==
X-Received: by 2002:a63:4823:: with SMTP id v35mr517107pga.138.1565808440616; 
 Wed, 14 Aug 2019 11:47:20 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 y16sm610855pfc.36.2019.08.14.11.47.19
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Wed, 14 Aug 2019 11:47:19 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [RESEND][PATCH v3 09/26] drm: kirin: Dynamically allocate the hw_ctx
Date: Wed, 14 Aug 2019 18:46:45 +0000
Message-Id: <20190814184702.54275-10-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190814184702.54275-1-john.stultz@linaro.org>
References: <20190814184702.54275-1-john.stultz@linaro.org>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=S7G+b/AKW3ZGIOc1Uy5hIvA+emi22Ls1Jq5SWNDVSjE=;
 b=Nc6VyDeLkp4MAbOVFgNDIEDfMdp0ijLVLpHeDJmme19KqUpqX+fHbwurSw04qnZLL6
 JCH6P0UQRYb7SFDeqHuj41hMixuWPJJFZq02BBnWJHH8Mli44qR+3YT9X8om9y3/SV30
 BMgRd0BMrno37eHclBWeNqb0d5vSye8FVTVoMxjuERMYuFKAlBvlkcpgmZ3N1wrXLVfR
 KmuQCmk7+BYlKXZkuwDxhTVdB1fqRdO1uSGNTOhgpJK8TebqflZTQdMHQ7UL/11w6CIv
 xLO2aOYiJXhRDZc5g5fR9CSuHMv3rSOmlK23rcUWy/cIHjKTlcRVmcojG7tgnCq8cnWb
 dLog==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Xu YiPing <xuyiping@hisilicon.com>, David Airlie <airlied@linux.ie>,
 dri-devel <dri-devel@lists.freedesktop.org>,
 Xinliang Liu <z.liuxinliang@hisilicon.com>,
 Rongrong Zou <zourongrong@gmail.com>, Sam Ravnborg <sam@ravnborg.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogWHUgWWlQaW5nIDx4dXlpcGluZ0BoaXNpbGljb24uY29tPgoKQXMgcGFydCBvZiByZWZh
Y3RvcmluZyB0aGUga2lyaW4gZHJpdmVyIHRvIGJldHRlciBzdXBwb3J0CmRpZmZlcmVudCBoYXJk
d2FyZSByZXZpc2lvbnMsIHRoaXMgcGF0Y2ggbW9kaWZpZXMgdGhlCmluaXRpYWxpemF0aW9uIGZ1
bmN0aW9uIHRvIGR5bmFtaWNhbGx5IGFsbG9jYXRlIHRoZSBhZGVfaHdfY3R4CnN0cnVjdHVyZSBw
cmV2aW91c2x5IGtlcHQgYXMgcGFydCBvZiBzdHJ1Y3QgYWRlX2RhdGEuCgpUaGlzIGlzIGRvbmUg
c28gdGhhdCBsYXRlciB3ZSBjYW4gaGF2ZSB0aGUgaHdfY3R4IHBvaW50IHRvCmhhcmR3YXJlIHJl
dmlzaW9uIHNwZWNpZmljIGN0eCBzdHJ1Y3R1cmVzLgoKQ2M6IFJvbmdyb25nIFpvdSA8em91cm9u
Z3JvbmdAZ21haWwuY29tPgpDYzogWGlubGlhbmcgTGl1IDx6LmxpdXhpbmxpYW5nQGhpc2lsaWNv
bi5jb20+CkNjOiBEYXZpZCBBaXJsaWUgPGFpcmxpZWRAbGludXguaWU+CkNjOiBEYW5pZWwgVmV0
dGVyIDxkYW5pZWxAZmZ3bGwuY2g+CkNjOiBkcmktZGV2ZWwgPGRyaS1kZXZlbEBsaXN0cy5mcmVl
ZGVza3RvcC5vcmc+CkNjOiBTYW0gUmF2bmJvcmcgPHNhbUByYXZuYm9yZy5vcmc+ClJldmlld2Vk
LWJ5OiBTYW0gUmF2bmJvcmcgPHNhbUByYXZuYm9yZy5vcmc+ClNpZ25lZC1vZmYtYnk6IFh1IFlp
UGluZyA8eHV5aXBpbmdAaGlzaWxpY29uLmNvbT4KW2pzdHVsdHo6IHJld29yZGVkIGNvbW1pdCBt
ZXNzYWdlXQpTaWduZWQtb2ZmLWJ5OiBKb2huIFN0dWx0eiA8am9obi5zdHVsdHpAbGluYXJvLm9y
Zz4KLS0tCiAuLi4vZ3B1L2RybS9oaXNpbGljb24va2lyaW4va2lyaW5fZHJtX2FkZS5jICAgfCAz
OSArKysrKysrKysrKystLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMjQgaW5zZXJ0aW9ucygrKSwg
MTUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2hpc2lsaWNvbi9r
aXJpbi9raXJpbl9kcm1fYWRlLmMgYi9kcml2ZXJzL2dwdS9kcm0vaGlzaWxpY29uL2tpcmluL2tp
cmluX2RybV9hZGUuYwppbmRleCBlZTNkYzNkMGY3MzguLmRkY2ZlMGM0MmQ3YyAxMDA2NDQKLS0t
IGEvZHJpdmVycy9ncHUvZHJtL2hpc2lsaWNvbi9raXJpbi9raXJpbl9kcm1fYWRlLmMKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL2hpc2lsaWNvbi9raXJpbi9raXJpbl9kcm1fYWRlLmMKQEAgLTcyLDcg
KzcyLDcgQEAgc3RydWN0IGtpcmluX3BsYW5lIHsKIHN0cnVjdCBhZGVfZGF0YSB7CiAJc3RydWN0
IGtpcmluX2NydGMgY3J0YzsKIAlzdHJ1Y3Qga2lyaW5fcGxhbmUgcGxhbmVzW0FERV9DSF9OVU1d
OwotCXN0cnVjdCBhZGVfaHdfY3R4IGN0eDsKKwlzdHJ1Y3QgYWRlX2h3X2N0eCAqaHdfY3R4Owog
fTsKIAogLyogYWRlLWZvcm1hdCBpbmZvOiAqLwpAQCAtOTUxLDU1ICs5NTEsNjIgQEAgc3RhdGlj
IGludCBhZGVfcGxhbmVfaW5pdChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCBzdHJ1Y3Qga2lyaW5f
cGxhbmUgKmtwbGFuZSwKIAlyZXR1cm4gMDsKIH0KIAotc3RhdGljIGludCBhZGVfZHRzX3BhcnNl
KHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYsIHN0cnVjdCBhZGVfaHdfY3R4ICpjdHgpCitz
dGF0aWMgdm9pZCAqYWRlX2h3X2N0eF9hbGxvYyhzdHJ1Y3QgcGxhdGZvcm1fZGV2aWNlICpwZGV2
KQogewogCXN0cnVjdCByZXNvdXJjZSAqcmVzOwogCXN0cnVjdCBkZXZpY2UgKmRldiA9ICZwZGV2
LT5kZXY7CiAJc3RydWN0IGRldmljZV9ub2RlICpucCA9IHBkZXYtPmRldi5vZl9ub2RlOworCXN0
cnVjdCBhZGVfaHdfY3R4ICpjdHggPSBOVUxMOworCisJY3R4ID0gZGV2bV9remFsbG9jKGRldiwg
c2l6ZW9mKCpjdHgpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWN0eCkgeworCQlEUk1fRVJST1IoImZh
aWxlZCB0byBhbGxvYyBhZGVfaHdfY3R4XG4iKTsKKwkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7
CisJfQogCiAJcmVzID0gcGxhdGZvcm1fZ2V0X3Jlc291cmNlKHBkZXYsIElPUkVTT1VSQ0VfTUVN
LCAwKTsKIAljdHgtPmJhc2UgPSBkZXZtX2lvcmVtYXBfcmVzb3VyY2UoZGV2LCByZXMpOwogCWlm
IChJU19FUlIoY3R4LT5iYXNlKSkgewogCQlEUk1fRVJST1IoImZhaWxlZCB0byByZW1hcCBhZGUg
aW8gYmFzZVxuIik7Ci0JCXJldHVybiAgUFRSX0VSUihjdHgtPmJhc2UpOworCQlyZXR1cm4gRVJS
X1BUUigtRUlPKTsKIAl9CiAKIAljdHgtPnJlc2V0ID0gZGV2bV9yZXNldF9jb250cm9sX2dldChk
ZXYsIE5VTEwpOwogCWlmIChJU19FUlIoY3R4LT5yZXNldCkpCi0JCXJldHVybiBQVFJfRVJSKGN0
eC0+cmVzZXQpOworCQlyZXR1cm4gRVJSX1BUUigtRU5PREVWKTsKIAogCWN0eC0+bm9jX3JlZ21h
cCA9CiAJCXN5c2Nvbl9yZWdtYXBfbG9va3VwX2J5X3BoYW5kbGUobnAsICJoaXNpbGljb24sbm9j
LXN5c2NvbiIpOwogCWlmIChJU19FUlIoY3R4LT5ub2NfcmVnbWFwKSkgewogCQlEUk1fRVJST1Io
ImZhaWxlZCB0byBnZXQgbm9jIHJlZ21hcFxuIik7Ci0JCXJldHVybiBQVFJfRVJSKGN0eC0+bm9j
X3JlZ21hcCk7CisJCXJldHVybiBFUlJfUFRSKC1FTk9ERVYpOwogCX0KIAogCWN0eC0+aXJxID0g
cGxhdGZvcm1fZ2V0X2lycShwZGV2LCAwKTsKIAlpZiAoY3R4LT5pcnEgPCAwKSB7CiAJCURSTV9F
UlJPUigiZmFpbGVkIHRvIGdldCBpcnFcbiIpOwotCQlyZXR1cm4gLUVOT0RFVjsKKwkJcmV0dXJu
IEVSUl9QVFIoLUVOT0RFVik7CiAJfQogCiAJY3R4LT5hZGVfY29yZV9jbGsgPSBkZXZtX2Nsa19n
ZXQoZGV2LCAiY2xrX2FkZV9jb3JlIik7CiAJaWYgKElTX0VSUihjdHgtPmFkZV9jb3JlX2Nsaykp
IHsKIAkJRFJNX0VSUk9SKCJmYWlsZWQgdG8gcGFyc2UgY2xrIEFERV9DT1JFXG4iKTsKLQkJcmV0
dXJuIFBUUl9FUlIoY3R4LT5hZGVfY29yZV9jbGspOworCQlyZXR1cm4gRVJSX1BUUigtRU5PREVW
KTsKIAl9CiAKIAljdHgtPm1lZGlhX25vY19jbGsgPSBkZXZtX2Nsa19nZXQoZGV2LCAiY2xrX2Nv
ZGVjX2pwZWciKTsKIAlpZiAoSVNfRVJSKGN0eC0+bWVkaWFfbm9jX2NsaykpIHsKIAkJRFJNX0VS
Uk9SKCJmYWlsZWQgdG8gcGFyc2UgY2xrIENPREVDX0pQRUdcbiIpOwotCQlyZXR1cm4gUFRSX0VS
UihjdHgtPm1lZGlhX25vY19jbGspOworCQlyZXR1cm4gRVJSX1BUUigtRU5PREVWKTsKIAl9CiAK
IAljdHgtPmFkZV9waXhfY2xrID0gZGV2bV9jbGtfZ2V0KGRldiwgImNsa19hZGVfcGl4Iik7CiAJ
aWYgKElTX0VSUihjdHgtPmFkZV9waXhfY2xrKSkgewogCQlEUk1fRVJST1IoImZhaWxlZCB0byBw
YXJzZSBjbGsgQURFX1BJWFxuIik7Ci0JCXJldHVybiBQVFJfRVJSKGN0eC0+YWRlX3BpeF9jbGsp
OworCQlyZXR1cm4gRVJSX1BUUigtRU5PREVWKTsKIAl9CiAKLQlyZXR1cm4gMDsKKwlyZXR1cm4g
Y3R4OwogfQogCiBzdGF0aWMgaW50IGFkZV9kcm1faW5pdChzdHJ1Y3QgcGxhdGZvcm1fZGV2aWNl
ICpwZGV2KQpAQCAtMTAyMCwxNCArMTAyNywxNiBAQCBzdGF0aWMgaW50IGFkZV9kcm1faW5pdChz
dHJ1Y3QgcGxhdGZvcm1fZGV2aWNlICpwZGV2KQogCX0KIAlwbGF0Zm9ybV9zZXRfZHJ2ZGF0YShw
ZGV2LCBhZGUpOwogCi0JY3R4ID0gJmFkZS0+Y3R4OworCWN0eCA9IGFkZV9od19jdHhfYWxsb2Mo
cGRldik7CisJaWYgKElTX0VSUihjdHgpKSB7CisJCURSTV9FUlJPUigiZmFpbGVkIHRvIGluaXRp
YWxpemUga2lyaW5fcHJpdiBodyBjdHhcbiIpOworCQlyZXR1cm4gLUVJTlZBTDsKKwl9CisJYWRl
LT5od19jdHggPSBjdHg7CisKIAlrY3J0YyA9ICZhZGUtPmNydGM7CiAJa2NydGMtPmh3X2N0eCA9
IGN0eDsKIAotCXJldCA9IGFkZV9kdHNfcGFyc2UocGRldiwgY3R4KTsKLQlpZiAocmV0KQotCQly
ZXR1cm4gcmV0OwotCiAJLyoKIAkgKiBwbGFuZSBpbml0CiAJICogVE9ETzogTm93IG9ubHkgc3Vw
cG9ydCBwcmltYXJ5IHBsYW5lLCBvdmVybGF5IHBsYW5lcwotLSAKMi4xNy4xCgpfX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBs
aXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVz
a3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
