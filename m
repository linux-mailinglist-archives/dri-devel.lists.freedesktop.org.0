Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id F09311C8B3
	for <lists+dri-devel@lfdr.de>; Tue, 14 May 2019 14:31:39 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A4DF1892E0;
	Tue, 14 May 2019 12:31:33 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wm1-x344.google.com (mail-wm1-x344.google.com
 [IPv6:2a00:1450:4864:20::344])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 57CA7892D2;
 Tue, 14 May 2019 12:31:32 +0000 (UTC)
Received: by mail-wm1-x344.google.com with SMTP id y3so2694019wmm.2;
 Tue, 14 May 2019 05:31:32 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=XgxdrGMU62a6/qTxIvfUyALzpjBUtVJoZb5V50Qnty0=;
 b=GM1yXizlilA3p2TqDUMDf5mhOU+rsLZYJ8+bdK5z/fkkbkgrNNzF1VugglAyWUt2R3
 T43cgpj28Mq24zOcQCeoWexi5iBzW3beKIlGh2URAkmCB6lGLsND2XrAM8xTzNkHw4S4
 WJzbn7a4AVuu2jtFxwX0IuU+BcOkDdrr6Xseq7tUH31neN5xLxS+ebXKNzTbtSkT98C4
 9K5s0fiDNtx3IUbIDm1a44gnF0B5uH2HbTx2sUr+QqYwpY64btM6fZkOs2aGhABHXvkt
 aBM+22EnEbQ4o2pb5UJfSPlpMPOaFj8UDe46E0xZwENvtnihgFMZQSKszwcrC6KQlZTz
 BX1A==
X-Gm-Message-State: APjAAAXky8t3bEHeKi07h+NRXUPNuC8UwRBOXkAa7pLm+2q0sN3qe74+
 l6Ck3ec9EZiwhWKLuQwYx6UhWBo2
X-Google-Smtp-Source: APXvYqy4HhK/90eB8vHXsD+LZlvQkLJy8iVkaCIJ933kzd0mTdPAjnypRIefeHD8OAsioQWhh7ZHog==
X-Received: by 2002:a1c:3104:: with SMTP id x4mr14765773wmx.23.1557837091002; 
 Tue, 14 May 2019 05:31:31 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:7d94:f6f9:368b:5a3b])
 by smtp.gmail.com with ESMTPSA id n4sm6128704wmb.22.2019.05.14.05.31.29
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
 Tue, 14 May 2019 05:31:30 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: Marek.Olsak@amd.com, David1.Zhou@amd.com, Prike.Liang@amd.com,
 dri-devel@lists.freedesktop.org, amd-gfx@lists.freedesktop.org
Subject: [PATCH 02/11] drm/ttm: fix busy memory to fail other user v8
Date: Tue, 14 May 2019 14:31:18 +0200
Message-Id: <20190514123127.1650-2-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190514123127.1650-1-christian.koenig@amd.com>
References: <20190514123127.1650-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references:mime-version
 :content-transfer-encoding;
 bh=XgxdrGMU62a6/qTxIvfUyALzpjBUtVJoZb5V50Qnty0=;
 b=XXNxje5PWQqz5vTE8jDPvjGI0DvQc8fZdQ80yfo1ENfAdFMngpPlykbLtGxNd3yrBo
 jei/46Ajfnk9ADqhZXvjKnPNCjAbRWRdo68jjpiBWcKaS0JmB7/qptN/zncKPKe6mQTS
 pgTiT7DUukYdhTLqRKRcnlE8Vs8YNU7HqP89AJFxQ+giiF39pwCF3EMHItj4C4RZGfsz
 +gOVGaZLYf1WaJ+u+NOCIGxk7DgCaRw4FTx0xxA5hXITEftwjc8tVAJ+9TQ9CaAYr5Ey
 M3ZvwlQtvr3ZwOEvJNn5h6X4xZ+YWYQshUolFr2bB86U8YU0O40nOYuv1z3ielrs0rks
 6cjA==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogQ2h1bm1pbmcgWmhvdSA8ZGF2aWQxLnpob3VAYW1kLmNvbT4KCmhlYXZ5IGdwdSBqb2Ig
Y291bGQgb2NjdXB5IG1lbW9yeSBsb25nIHRpbWUsIHdoaWNoIGxlYWQgb3RoZXIgdXNlciBmYWls
IHRvIGdldCBtZW1vcnkuCgpiYXNpY2FsbHkgcGljayB1cCBDaHJpc3RpYW4gaWRlYToKCjEuIFJl
c2VydmUgdGhlIEJPIGluIERDIHVzaW5nIGEgd3dfbXV0ZXggdGlja2V0ICh0cml2aWFsKS4KMi4g
SWYgd2UgdGhlbiBydW4gaW50byB0aGlzIEVCVVNZIGNvbmRpdGlvbiBpbiBUVE0gY2hlY2sgaWYg
dGhlIEJPIHdlIG5lZWQgbWVtb3J5IGZvciAob3IgcmF0aGVyIHRoZSB3d19tdXRleCBvZiBpdHMg
cmVzZXJ2YXRpb24gb2JqZWN0KSBoYXMgYSB0aWNrZXQgYXNzaWduZWQuCjMuIElmIHdlIGhhdmUg
YSB0aWNrZXQgd2UgZ3JhYiBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgQk8gb24gdGhlIExSVSwg
ZHJvcCB0aGUgTFJVIGxvY2sgYW5kIHRyeSB0byBncmFiIHRoZSByZXNlcnZhdGlvbiBsb2NrIHdp
dGggdGhlIHRpY2tldC4KNC4gSWYgZ2V0dGluZyB0aGUgcmVzZXJ2YXRpb24gbG9jayB3aXRoIHRo
ZSB0aWNrZXQgc3VjY2VlZGVkIHdlIGNoZWNrIGlmIHRoZSBCTyBpcyBzdGlsbCB0aGUgZmlyc3Qg
b25lIG9uIHRoZSBMUlUgaW4gcXVlc3Rpb24gKHRoZSBCTyBjb3VsZCBoYXZlIG1vdmVkKS4KNS4g
SWYgdGhlIEJPIGlzIHN0aWxsIHRoZSBmaXJzdCBvbmUgb24gdGhlIExSVSBpbiBxdWVzdGlvbiB3
ZSB0cnkgdG8gZXZpY3QgaXQgYXMgd2Ugd291bGQgZXZpY3QgYW55IG90aGVyIEJPLgo2LiBJZiBh
bnkgb2YgdGhlICJJZidzIiBhYm92ZSBmYWlsIHdlIGp1c3QgYmFjayBvZmYgYW5kIHJldHVybiAt
RUJVU1kuCgp2MjogZml4IHNvbWUgbWlub3IgY2hlY2sKdjM6IGFkZHJlc3MgQ2hyaXN0aWFuIHYy
IGNvbW1lbnRzLgp2NDogZml4IHNvbWUgbWlzc2luZwp2NTogaGFuZGxlIGZpcnN0X2JvIHVubG9j
ayBhbmQgYm9fZ2V0L3B1dAp2NjogYWJzdHJhY3QgdW5pZmllZCBpdGVyYXRlIGZ1bmN0aW9uLCBh
bmQgaGFuZGxlIGFsbCBwb3NzaWJsZSB1c2VjYXNlIG5vdCBvbmx5IHBpbm5lZCBiby4Kdjc6IHBh
c3MgcmVxdWVzdCBiby0+cmVzdiB0byB0dG1fYm9fZXZpY3RfZmlyc3QKdjggKGNoayk6IG1pbmlt
YWwgY29kaW5nIHN0eWxlIGZpeAoKQ2hhbmdlLUlkOiBJMjE0MjNmYjkyMmY4ODU0NjVmMTM4MzNj
NDFkZjFlMTM0MzY0YThlNwpTaWduZWQtb2ZmLWJ5OiBDaHVubWluZyBaaG91IDxkYXZpZDEuemhv
dUBhbWQuY29tPgpSZXZpZXdlZC1ieTogQ2hyaXN0aWFuIEvDtm5pZyA8Y2hyaXN0aWFuLmtvZW5p
Z0BhbWQuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvLmMgfCAxMTMgKysrKysr
KysrKysrKysrKysrKysrKysrKysrKystLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA5NiBpbnNlcnRp
b25zKCspLCAxNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdHRt
L3R0bV9iby5jIGIvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8uYwppbmRleCAyODQ1ZmNlYjJm
YmQuLmU2MzRkM2EzNjkyMyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8u
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9iby5jCkBAIC03NjYsMTEgKzc2NiwxMyBA
QCBFWFBPUlRfU1lNQk9MKHR0bV9ib19ldmljdGlvbl92YWx1YWJsZSk7CiAgKiBiLiBPdGhlcndp
c2UsIHRyeWxvY2sgaXQuCiAgKi8KIHN0YXRpYyBib29sIHR0bV9ib19ldmljdF9zd2Fwb3V0X2Fs
bG93YWJsZShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAotCQkJc3RydWN0IHR0bV9vcGVy
YXRpb25fY3R4ICpjdHgsIGJvb2wgKmxvY2tlZCkKKwkJCXN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0
eCAqY3R4LCBib29sICpsb2NrZWQsIGJvb2wgKmJ1c3kpCiB7CiAJYm9vbCByZXQgPSBmYWxzZTsK
IAogCSpsb2NrZWQgPSBmYWxzZTsKKwlpZiAoYnVzeSkKKwkJKmJ1c3kgPSBmYWxzZTsKIAlpZiAo
Ym8tPnJlc3YgPT0gY3R4LT5yZXN2KSB7CiAJCXJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVs
ZChiby0+cmVzdik7CiAJCWlmIChjdHgtPmZsYWdzICYgVFRNX09QVF9GTEFHX0FMTE9XX1JFU19F
VklDVApAQCAtNzc5LDM1ICs3ODEsNDYgQEAgc3RhdGljIGJvb2wgdHRtX2JvX2V2aWN0X3N3YXBv
dXRfYWxsb3dhYmxlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJfSBlbHNlIHsKIAkJ
KmxvY2tlZCA9IHJlc2VydmF0aW9uX29iamVjdF90cnlsb2NrKGJvLT5yZXN2KTsKIAkJcmV0ID0g
KmxvY2tlZDsKKwkJaWYgKCFyZXQgJiYgYnVzeSkKKwkJCSpidXN5ID0gdHJ1ZTsKIAl9CiAKIAly
ZXR1cm4gcmV0OwogfQogCi1zdGF0aWMgaW50IHR0bV9tZW1fZXZpY3RfZmlyc3Qoc3RydWN0IHR0
bV9ib19kZXZpY2UgKmJkZXYsCi0JCQkgICAgICAgdWludDMyX3QgbWVtX3R5cGUsCi0JCQkgICAg
ICAgY29uc3Qgc3RydWN0IHR0bV9wbGFjZSAqcGxhY2UsCi0JCQkgICAgICAgc3RydWN0IHR0bV9v
cGVyYXRpb25fY3R4ICpjdHgpCitzdGF0aWMgc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0KgordHRt
X21lbV9maW5kX2V2aXRhYmxlX2JvKHN0cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAorCQkJIHN0
cnVjdCB0dG1fbWVtX3R5cGVfbWFuYWdlciAqbWFuLAorCQkJIGNvbnN0IHN0cnVjdCB0dG1fcGxh
Y2UgKnBsYWNlLAorCQkJIHN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4LAorCQkJIHN0cnVj
dCB0dG1fYnVmZmVyX29iamVjdCAqKmZpcnN0X2JvLAorCQkJIGJvb2wgKmxvY2tlZCkKIHsKLQlz
dHJ1Y3QgdHRtX2JvX2dsb2JhbCAqZ2xvYiA9IGJkZXYtPmdsb2I7Ci0Jc3RydWN0IHR0bV9tZW1f
dHlwZV9tYW5hZ2VyICptYW4gPSAmYmRldi0+bWFuW21lbV90eXBlXTsKIAlzdHJ1Y3QgdHRtX2J1
ZmZlcl9vYmplY3QgKmJvID0gTlVMTDsKLQlib29sIGxvY2tlZCA9IGZhbHNlOwotCXVuc2lnbmVk
IGk7Ci0JaW50IHJldDsKKwlpbnQgaTsKIAotCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xvY2spOwor
CWlmIChmaXJzdF9ibykKKwkJKmZpcnN0X2JvID0gTlVMTDsKIAlmb3IgKGkgPSAwOyBpIDwgVFRN
X01BWF9CT19QUklPUklUWTsgKytpKSB7CiAJCWxpc3RfZm9yX2VhY2hfZW50cnkoYm8sICZtYW4t
PmxydVtpXSwgbHJ1KSB7Ci0JCQlpZiAoIXR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZShi
bywgY3R4LCAmbG9ja2VkKSkKKwkJCWJvb2wgYnVzeSA9IGZhbHNlOworCisJCQlpZiAoIXR0bV9i
b19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZShibywgY3R4LCBsb2NrZWQsCisJCQkJCQkJICAgICZi
dXN5KSkgeworCQkJCWlmIChmaXJzdF9ibyAmJiAhKCpmaXJzdF9ibykgJiYgYnVzeSkgeworCQkJ
CQl0dG1fYm9fZ2V0KGJvKTsKKwkJCQkJKmZpcnN0X2JvID0gYm87CisJCQkJfQogCQkJCWNvbnRp
bnVlOworCQkJfQogCiAJCQlpZiAocGxhY2UgJiYgIWJkZXYtPmRyaXZlci0+ZXZpY3Rpb25fdmFs
dWFibGUoYm8sCiAJCQkJCQkJCSAgICAgIHBsYWNlKSkgewotCQkJCWlmIChsb2NrZWQpCisJCQkJ
aWYgKCpsb2NrZWQpCiAJCQkJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2soYm8tPnJlc3YpOwog
CQkJCWNvbnRpbnVlOwogCQkJfQorCiAJCQlicmVhazsKIAkJfQogCkBAIC04MTgsOSArODMxLDY5
IEBAIHN0YXRpYyBpbnQgdHRtX21lbV9ldmljdF9maXJzdChzdHJ1Y3QgdHRtX2JvX2RldmljZSAq
YmRldiwKIAkJYm8gPSBOVUxMOwogCX0KIAorCXJldHVybiBibzsKK30KKworc3RhdGljIGludCB0
dG1fbWVtX2V2aWN0X2ZpcnN0KHN0cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAorCQkJICAgICAg
IHVpbnQzMl90IG1lbV90eXBlLAorCQkJICAgICAgIGNvbnN0IHN0cnVjdCB0dG1fcGxhY2UgKnBs
YWNlLAorCQkJICAgICAgIHN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4LAorCQkJICAgICAg
IHN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3QgKnJlcXVlc3RfcmVzdikKK3sKKwlzdHJ1Y3QgdHRt
X2JvX2dsb2JhbCAqZ2xvYiA9IGJkZXYtPmdsb2I7CisJc3RydWN0IHR0bV9tZW1fdHlwZV9tYW5h
Z2VyICptYW4gPSAmYmRldi0+bWFuW21lbV90eXBlXTsKKwlzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmpl
Y3QgKmJvID0gTlVMTCwgKmZpcnN0X2JvID0gTlVMTDsKKwlib29sIGxvY2tlZCA9IGZhbHNlOwor
CWludCByZXQ7CisKKwlzcGluX2xvY2soJmdsb2ItPmxydV9sb2NrKTsKKwlibyA9IHR0bV9tZW1f
ZmluZF9ldml0YWJsZV9ibyhiZGV2LCBtYW4sIHBsYWNlLCBjdHgsICZmaXJzdF9ibywKKwkJCQkg
ICAgICAmbG9ja2VkKTsKIAlpZiAoIWJvKSB7CisJCXN0cnVjdCB3d19hY3F1aXJlX2N0eCAqYWNx
dWlyZV9jdHggPSByZXF1ZXN0X3Jlc3YtPmxvY2suY3R4OworCQlzdHJ1Y3QgdHRtX29wZXJhdGlv
bl9jdHggYnVzeV9jdHg7CisKIAkJc3Bpbl91bmxvY2soJmdsb2ItPmxydV9sb2NrKTsKLQkJcmV0
dXJuIC1FQlVTWTsKKwkJLyogY2hlY2sgaWYgb3RoZXIgdXNlciBvY2N1cHkgbWVtb3J5IHRvbyBs
b25nIHRpbWUgKi8KKwkJaWYgKCFmaXJzdF9ibyB8fCAhcmVxdWVzdF9yZXN2IHx8ICFyZXF1ZXN0
X3Jlc3YtPmxvY2suY3R4KSB7CisJCQlpZiAoZmlyc3RfYm8pCisJCQkJdHRtX2JvX3B1dChmaXJz
dF9ibyk7CisJCQlyZXR1cm4gLUVCVVNZOworCQl9CisJCWlmIChmaXJzdF9iby0+cmVzdiA9PSBy
ZXF1ZXN0X3Jlc3YpIHsKKwkJCXR0bV9ib19wdXQoZmlyc3RfYm8pOworCQkJcmV0dXJuIC1FQlVT
WTsKKwkJfQorCQlpZiAoY3R4LT5pbnRlcnJ1cHRpYmxlKQorCQkJcmV0ID0gd3dfbXV0ZXhfbG9j
a19pbnRlcnJ1cHRpYmxlKCZmaXJzdF9iby0+cmVzdi0+bG9jaywKKwkJCQkJCQkgIGFjcXVpcmVf
Y3R4KTsKKwkJZWxzZQorCQkJcmV0ID0gd3dfbXV0ZXhfbG9jaygmZmlyc3RfYm8tPnJlc3YtPmxv
Y2ssCisJCQkJCSAgICBhY3F1aXJlX2N0eCk7CisJCWlmIChyZXQpIHsKKwkJCXR0bV9ib19wdXQo
Zmlyc3RfYm8pOworCQkJcmV0dXJuIHJldDsKKwkJfQorCQlzcGluX2xvY2soJmdsb2ItPmxydV9s
b2NrKTsKKwkJLyogcHJldmlvdXMgYnVzeSByZXN2IGxvY2sgaXMgaGVsZCBieSBhYm92ZSwgaWRs
ZSBub3csCisJCSAqIHNvIGxldCB0aGVtIGV2aWN0YWJsZS4KKwkJICovCisJCWJ1c3lfY3R4Lmlu
dGVycnVwdGlibGUgPSBjdHgtPmludGVycnVwdGlibGU7CisJCWJ1c3lfY3R4Lm5vX3dhaXRfZ3B1
ICAgPSBjdHgtPm5vX3dhaXRfZ3B1OworCQlidXN5X2N0eC5yZXN2CSAgICAgICA9IGZpcnN0X2Jv
LT5yZXN2OworCQlidXN5X2N0eC5mbGFncwkgICAgICAgPSBUVE1fT1BUX0ZMQUdfQUxMT1dfUkVT
X0VWSUNUOworCisJCWJvID0gdHRtX21lbV9maW5kX2V2aXRhYmxlX2JvKGJkZXYsIG1hbiwgcGxh
Y2UsICZidXN5X2N0eCwgTlVMTCwKKwkJCQkJICAgICAgJmxvY2tlZCk7CisJCWlmIChibyAmJiAo
Ym8tPnJlc3YgPT0gZmlyc3RfYm8tPnJlc3YpKQorCQkJbG9ja2VkID0gdHJ1ZTsKKwkJZWxzZSBp
ZiAoYm8pCisJCQl3d19tdXRleF91bmxvY2soJmZpcnN0X2JvLT5yZXN2LT5sb2NrKTsKKwkJaWYg
KCFibykgeworCQkJc3Bpbl91bmxvY2soJmdsb2ItPmxydV9sb2NrKTsKKwkJCXR0bV9ib19wdXQo
Zmlyc3RfYm8pOworCQkJcmV0dXJuIC1FQlVTWTsKKwkJfQogCX0KIAogCWtyZWZfZ2V0KCZiby0+
bGlzdF9rcmVmKTsKQEAgLTgyOSwxMSArOTAyLDE1IEBAIHN0YXRpYyBpbnQgdHRtX21lbV9ldmlj
dF9maXJzdChzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiwKIAkJcmV0ID0gdHRtX2JvX2NsZWFu
dXBfcmVmcyhibywgY3R4LT5pbnRlcnJ1cHRpYmxlLAogCQkJCQkgIGN0eC0+bm9fd2FpdF9ncHUs
IGxvY2tlZCk7CiAJCWtyZWZfcHV0KCZiby0+bGlzdF9rcmVmLCB0dG1fYm9fcmVsZWFzZV9saXN0
KTsKKwkJaWYgKGZpcnN0X2JvKQorCQkJdHRtX2JvX3B1dChmaXJzdF9ibyk7CiAJCXJldHVybiBy
ZXQ7CiAJfQogCiAJdHRtX2JvX2RlbF9mcm9tX2xydShibyk7CiAJc3Bpbl91bmxvY2soJmdsb2It
PmxydV9sb2NrKTsKKwlpZiAoZmlyc3RfYm8pCisJCXR0bV9ib19wdXQoZmlyc3RfYm8pOwogCiAJ
cmV0ID0gdHRtX2JvX2V2aWN0KGJvLCBjdHgpOwogCWlmIChsb2NrZWQpIHsKQEAgLTkwNyw3ICs5
ODQsNyBAQCBzdGF0aWMgaW50IHR0bV9ib19tZW1fZm9yY2Vfc3BhY2Uoc3RydWN0IHR0bV9idWZm
ZXJfb2JqZWN0ICpibywKIAkJCXJldHVybiByZXQ7CiAJCWlmIChtZW0tPm1tX25vZGUpCiAJCQli
cmVhazsKLQkJcmV0ID0gdHRtX21lbV9ldmljdF9maXJzdChiZGV2LCBtZW1fdHlwZSwgcGxhY2Us
IGN0eCk7CisJCXJldCA9IHR0bV9tZW1fZXZpY3RfZmlyc3QoYmRldiwgbWVtX3R5cGUsIHBsYWNl
LCBjdHgsIGJvLT5yZXN2KTsKIAkJaWYgKHVubGlrZWx5KHJldCAhPSAwKSkKIAkJCXJldHVybiBy
ZXQ7CiAJfSB3aGlsZSAoMSk7CkBAIC0xNDAxLDcgKzE0NzgsOCBAQCBzdGF0aWMgaW50IHR0bV9i
b19mb3JjZV9saXN0X2NsZWFuKHN0cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAogCWZvciAoaSA9
IDA7IGkgPCBUVE1fTUFYX0JPX1BSSU9SSVRZOyArK2kpIHsKIAkJd2hpbGUgKCFsaXN0X2VtcHR5
KCZtYW4tPmxydVtpXSkpIHsKIAkJCXNwaW5fdW5sb2NrKCZnbG9iLT5scnVfbG9jayk7Ci0JCQly
ZXQgPSB0dG1fbWVtX2V2aWN0X2ZpcnN0KGJkZXYsIG1lbV90eXBlLCBOVUxMLCAmY3R4KTsKKwkJ
CXJldCA9IHR0bV9tZW1fZXZpY3RfZmlyc3QoYmRldiwgbWVtX3R5cGUsIE5VTEwsICZjdHgsCisJ
CQkJCQkgIE5VTEwpOwogCQkJaWYgKHJldCkKIAkJCQlyZXR1cm4gcmV0OwogCQkJc3Bpbl9sb2Nr
KCZnbG9iLT5scnVfbG9jayk7CkBAIC0xNzcyLDcgKzE4NTAsOCBAQCBpbnQgdHRtX2JvX3N3YXBv
dXQoc3RydWN0IHR0bV9ib19nbG9iYWwgKmdsb2IsIHN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAq
Y3R4KQogCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xvY2spOwogCWZvciAoaSA9IDA7IGkgPCBUVE1f
TUFYX0JPX1BSSU9SSVRZOyArK2kpIHsKIAkJbGlzdF9mb3JfZWFjaF9lbnRyeShibywgJmdsb2It
PnN3YXBfbHJ1W2ldLCBzd2FwKSB7Ci0JCQlpZiAodHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dh
YmxlKGJvLCBjdHgsICZsb2NrZWQpKSB7CisJCQlpZiAodHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxs
b3dhYmxlKGJvLCBjdHgsICZsb2NrZWQsCisJCQkJCQkJICAgTlVMTCkpIHsKIAkJCQlyZXQgPSAw
OwogCQkJCWJyZWFrOwogCQkJfQotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBs
aXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1h
bi9saXN0aW5mby9kcmktZGV2ZWw=
