Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 717CCE37D2
	for <lists+dri-devel@lfdr.de>; Thu, 24 Oct 2019 18:25:26 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7E8B76E471;
	Thu, 24 Oct 2019 16:25:23 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from foss.arm.com (unknown [217.140.110.172])
 by gabe.freedesktop.org (Postfix) with ESMTP id 5DF126E47E
 for <dri-devel@lists.freedesktop.org>; Thu, 24 Oct 2019 16:25:22 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
 by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id EBE51328;
 Thu, 24 Oct 2019 09:25:11 -0700 (PDT)
Received: from e112269-lin.cambridge.arm.com (e112269-lin.cambridge.arm.com
 [10.1.194.43])
 by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id 7A4993F71F;
 Thu, 24 Oct 2019 09:25:10 -0700 (PDT)
From: Steven Price <steven.price@arm.com>
To: Daniel Vetter <daniel@ffwll.ch>,
	David Airlie <airlied@linux.ie>
Subject: [RESEND PATCH v4] drm: Don't free jobs in wait_event_interruptible()
Date: Thu, 24 Oct 2019 17:24:24 +0100
Message-Id: <20191024162424.38548-1-steven.price@arm.com>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sharat Masetty <smasetty@codeaurora.org>, linux-kernel@vger.kernel.org,
 dri-devel@lists.freedesktop.org, Steven Price <steven.price@arm.com>,
 Alex Deucher <alexander.deucher@amd.com>, Sam Ravnborg <sam@ravnborg.org>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>,
 Erico Nunes <nunes.erico@gmail.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

ZHJtX3NjaGVkX2NsZWFudXBfam9icygpIGF0dGVtcHRzIHRvIGZyZWUgZmluaXNoZWQgam9icywg
aG93ZXZlciBiZWNhdXNlCml0IGlzIGNhbGxlZCBhcyB0aGUgY29uZGl0aW9uIG9mIHdhaXRfZXZl
bnRfaW50ZXJydXB0aWJsZSgpIGl0IG11c3Qgbm90CnNsZWVwLiBVbmZvcnR1YW50bHkgc29tZSBm
cmVlIGNhbGxiYWNrcyAobm90aWJseSBmb3IgUGFuZnJvc3QpIGRvIHNsZWVwLgoKSW5zdGVhZCBs
ZXQncyByZW5hbWUgZHJtX3NjaGVkX2NsZWFudXBfam9icygpIHRvCmRybV9zY2hlZF9nZXRfY2xl
YW51cF9qb2IoKSBhbmQgc2ltcGx5IHJldHVybiBhIGpvYiBmb3IgcHJvY2Vzc2luZyBpZgp0aGVy
ZSBpcyBvbmUuIFRoZSBjYWxsZXIgY2FuIHRoZW4gY2FsbCB0aGUgZnJlZV9qb2IoKSBjYWxsYmFj
ayBvdXRzaWRlCnRoZSB3YWl0X2V2ZW50X2ludGVycnVwdGlibGUoKSB3aGVyZSBzbGVlcGluZyBp
cyBwb3NzaWJsZSBiZWZvcmUKcmUtY2hlY2tpbmcgYW5kIHJldHVybmluZyB0byBzbGVlcCBpZiBu
ZWNlc3NhcnkuCgpTaWduZWQtb2ZmLWJ5OiBTdGV2ZW4gUHJpY2UgPHN0ZXZlbi5wcmljZUBhcm0u
Y29tPgotLS0KUHJldmlvdXMgcG9zdGluZzogaHR0cHM6Ly9sb3JlLmtlcm5lbC5vcmcvbGttbC8y
MDE5MDkyNjE0MTYzMC4xNDI1OC0xLXN0ZXZlbi5wcmljZUBhcm0uY29tLwoKIGRyaXZlcnMvZ3B1
L2RybS9zY2hlZHVsZXIvc2NoZWRfbWFpbi5jIHwgNDUgKysrKysrKysrKysrKysrLS0tLS0tLS0t
LS0KIDEgZmlsZSBjaGFuZ2VkLCAyNiBpbnNlcnRpb25zKCspLCAxOSBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vc2NoZWR1bGVyL3NjaGVkX21haW4uYyBiL2RyaXZl
cnMvZ3B1L2RybS9zY2hlZHVsZXIvc2NoZWRfbWFpbi5jCmluZGV4IDlhMGVlNzRkODJkYy4uMTQ4
NDY4NDQ3YmE5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vc2NoZWR1bGVyL3NjaGVkX21h
aW4uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vc2NoZWR1bGVyL3NjaGVkX21haW4uYwpAQCAtNjIy
LDQzICs2MjIsNDEgQEAgc3RhdGljIHZvaWQgZHJtX3NjaGVkX3Byb2Nlc3Nfam9iKHN0cnVjdCBk
bWFfZmVuY2UgKmYsIHN0cnVjdCBkbWFfZmVuY2VfY2IgKmNiKQogfQogCiAvKioKLSAqIGRybV9z
Y2hlZF9jbGVhbnVwX2pvYnMgLSBkZXN0cm95IGZpbmlzaGVkIGpvYnMKKyAqIGRybV9zY2hlZF9n
ZXRfY2xlYW51cF9qb2IgLSBmZXRjaCB0aGUgbmV4dCBmaW5pc2hlZCBqb2IgdG8gYmUgZGVzdHJv
eWVkCiAgKgogICogQHNjaGVkOiBzY2hlZHVsZXIgaW5zdGFuY2UKICAqCi0gKiBSZW1vdmUgYWxs
IGZpbmlzaGVkIGpvYnMgZnJvbSB0aGUgbWlycm9yIGxpc3QgYW5kIGRlc3Ryb3kgdGhlbS4KKyAq
IFJldHVybnMgdGhlIG5leHQgZmluaXNoZWQgam9iIGZyb20gdGhlIG1pcnJvciBsaXN0IChpZiB0
aGVyZSBpcyBvbmUpCisgKiByZWFkeSBmb3IgaXQgdG8gYmUgZGVzdHJveWVkLgogICovCi1zdGF0
aWMgdm9pZCBkcm1fc2NoZWRfY2xlYW51cF9qb2JzKHN0cnVjdCBkcm1fZ3B1X3NjaGVkdWxlciAq
c2NoZWQpCitzdGF0aWMgc3RydWN0IGRybV9zY2hlZF9qb2IgKgorZHJtX3NjaGVkX2dldF9jbGVh
bnVwX2pvYihzdHJ1Y3QgZHJtX2dwdV9zY2hlZHVsZXIgKnNjaGVkKQogeworCXN0cnVjdCBkcm1f
c2NoZWRfam9iICpqb2IgPSBOVUxMOwogCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAKIAkvKiBEb24n
dCBkZXN0cm95IGpvYnMgd2hpbGUgdGhlIHRpbWVvdXQgd29ya2VyIGlzIHJ1bm5pbmcgKi8KIAlp
ZiAoc2NoZWQtPnRpbWVvdXQgIT0gTUFYX1NDSEVEVUxFX1RJTUVPVVQgJiYKIAkgICAgIWNhbmNl
bF9kZWxheWVkX3dvcmsoJnNjaGVkLT53b3JrX3RkcikpCi0JCXJldHVybjsKLQorCQlyZXR1cm4g
TlVMTDsKIAotCXdoaWxlICghbGlzdF9lbXB0eSgmc2NoZWQtPnJpbmdfbWlycm9yX2xpc3QpKSB7
Ci0JCXN0cnVjdCBkcm1fc2NoZWRfam9iICpqb2I7CisJc3Bpbl9sb2NrX2lycXNhdmUoJnNjaGVk
LT5qb2JfbGlzdF9sb2NrLCBmbGFncyk7CiAKLQkJam9iID0gbGlzdF9maXJzdF9lbnRyeSgmc2No
ZWQtPnJpbmdfbWlycm9yX2xpc3QsCisJam9iID0gbGlzdF9maXJzdF9lbnRyeV9vcl9udWxsKCZz
Y2hlZC0+cmluZ19taXJyb3JfbGlzdCwKIAkJCQkgICAgICAgc3RydWN0IGRybV9zY2hlZF9qb2Is
IG5vZGUpOwotCQlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZCgmam9iLT5zX2ZlbmNlLT5maW5p
c2hlZCkpCi0JCQlicmVhazsKIAotCQlzcGluX2xvY2tfaXJxc2F2ZSgmc2NoZWQtPmpvYl9saXN0
X2xvY2ssIGZsYWdzKTsKKwlpZiAoam9iICYmIGRtYV9mZW5jZV9pc19zaWduYWxlZCgmam9iLT5z
X2ZlbmNlLT5maW5pc2hlZCkpIHsKIAkJLyogcmVtb3ZlIGpvYiBmcm9tIHJpbmdfbWlycm9yX2xp
c3QgKi8KIAkJbGlzdF9kZWxfaW5pdCgmam9iLT5ub2RlKTsKLQkJc3Bpbl91bmxvY2tfaXJxcmVz
dG9yZSgmc2NoZWQtPmpvYl9saXN0X2xvY2ssIGZsYWdzKTsKLQotCQlzY2hlZC0+b3BzLT5mcmVl
X2pvYihqb2IpOworCX0gZWxzZSB7CisJCWpvYiA9IE5VTEw7CisJCS8qIHF1ZXVlIHRpbWVvdXQg
Zm9yIG5leHQgam9iICovCisJCWRybV9zY2hlZF9zdGFydF90aW1lb3V0KHNjaGVkKTsKIAl9CiAK
LQkvKiBxdWV1ZSB0aW1lb3V0IGZvciBuZXh0IGpvYiAqLwotCXNwaW5fbG9ja19pcnFzYXZlKCZz
Y2hlZC0+am9iX2xpc3RfbG9jaywgZmxhZ3MpOwotCWRybV9zY2hlZF9zdGFydF90aW1lb3V0KHNj
aGVkKTsKIAlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZzY2hlZC0+am9iX2xpc3RfbG9jaywgZmxh
Z3MpOwogCisJcmV0dXJuIGpvYjsKIH0KIAogLyoqCkBAIC02OTgsMTIgKzY5NiwyMSBAQCBzdGF0
aWMgaW50IGRybV9zY2hlZF9tYWluKHZvaWQgKnBhcmFtKQogCQlzdHJ1Y3QgZHJtX3NjaGVkX2Zl
bmNlICpzX2ZlbmNlOwogCQlzdHJ1Y3QgZHJtX3NjaGVkX2pvYiAqc2NoZWRfam9iOwogCQlzdHJ1
Y3QgZG1hX2ZlbmNlICpmZW5jZTsKKwkJc3RydWN0IGRybV9zY2hlZF9qb2IgKmNsZWFudXBfam9i
ID0gTlVMTDsKIAogCQl3YWl0X2V2ZW50X2ludGVycnVwdGlibGUoc2NoZWQtPndha2VfdXBfd29y
a2VyLAotCQkJCQkgKGRybV9zY2hlZF9jbGVhbnVwX2pvYnMoc2NoZWQpLAorCQkJCQkgKGNsZWFu
dXBfam9iID0gZHJtX3NjaGVkX2dldF9jbGVhbnVwX2pvYihzY2hlZCkpIHx8CiAJCQkJCSAoIWRy
bV9zY2hlZF9ibG9ja2VkKHNjaGVkKSAmJgogCQkJCQkgIChlbnRpdHkgPSBkcm1fc2NoZWRfc2Vs
ZWN0X2VudGl0eShzY2hlZCkpKSB8fAotCQkJCQkga3RocmVhZF9zaG91bGRfc3RvcCgpKSk7CisJ
CQkJCSBrdGhyZWFkX3Nob3VsZF9zdG9wKCkpOworCisJCXdoaWxlIChjbGVhbnVwX2pvYikgewor
CQkJc2NoZWQtPm9wcy0+ZnJlZV9qb2IoY2xlYW51cF9qb2IpOworCQkJLyogcXVldWUgdGltZW91
dCBmb3IgbmV4dCBqb2IgKi8KKwkJCWRybV9zY2hlZF9zdGFydF90aW1lb3V0KHNjaGVkKTsKKwor
CQkJY2xlYW51cF9qb2IgPSBkcm1fc2NoZWRfZ2V0X2NsZWFudXBfam9iKHNjaGVkKTsKKwkJfQog
CiAJCWlmICghZW50aXR5KQogCQkJY29udGludWU7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QK
ZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9w
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
