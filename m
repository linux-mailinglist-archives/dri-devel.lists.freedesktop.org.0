Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 6EB3421F64A
	for <lists+dri-devel@lfdr.de>; Tue, 14 Jul 2020 17:41:48 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AAAD46E8A7;
	Tue, 14 Jul 2020 15:41:44 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-ed1-x541.google.com (mail-ed1-x541.google.com
 [IPv6:2a00:1450:4864:20::541])
 by gabe.freedesktop.org (Postfix) with ESMTPS id F29A16E8A7
 for <dri-devel@lists.freedesktop.org>; Tue, 14 Jul 2020 15:41:42 +0000 (UTC)
Received: by mail-ed1-x541.google.com with SMTP id g20so17728497edm.4
 for <dri-devel@lists.freedesktop.org>; Tue, 14 Jul 2020 08:41:42 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=basnieuwenhuizen-nl.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=fPc2Ss/8lpvcY2mROIad4+yzm0HXN/Mn6E5P50MZh+g=;
 b=At4gkRUItDv2bTs0xNUQM6klkWzkjBtcD5o50Y2SJAnx+zKx8I5H//b36vyamjzR/A
 RZzwpBJDvYsTOZz/Ai/RIUmNFK/bDWapx2VMd67/9AC5ekcX5ckzxokHGZ6ahFWqa6ye
 ctoxBjYJVT26gEdpOdAovQJpd0IAG9rgZbuNQ3nj7b1Lyw0PihmVFTpagYxhP9OxM1Tv
 9eMBXwsHA80WDrXTeDiTm12HJxzRet/p1RioqNg1ChFmKyP3MfQvWi2CQMD9J7hyHFqR
 /UpNGM5Fbv+sTgtTo9KLx9NzTjA+DMIAjGbmJfePiyTuSCBqSvjRLxH9aSq94Yi/25G6
 uFQw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=fPc2Ss/8lpvcY2mROIad4+yzm0HXN/Mn6E5P50MZh+g=;
 b=D97uOVOSpGQ5CIc/OxDcHgSEDSBDqv72ig8JfRKZ4v0XKQ2aFza45KvVmM8Kq4jV7v
 5UEN8jfCi3EEgHEu9F0mbenQmxcTQ4Q/QiiL93n0PI4P69OFeRhaiWeFlphLdV3D5GR1
 TefTyHnSD0E0wwzc/JQMx7TUYXdL+XImapu6WctAGvNP9R+HZPK5/SmAjsIWV0ufHp7n
 I6j6rIK7lwQKqESGipPM2Px06S1Tl8fpuRnAQeuxOuFXpXUc/2Vf5LDm70sYe7p7EQHZ
 a/5/T/yfCK/mCQVJqkRAucMg5/SxWGKkwtWjcTWgidoFFy/tI3590QCOQzNJi627RuA0
 xfuQ==
X-Gm-Message-State: AOAM530OwhRuEnjcR4yvWcFQkoZtWWr0EjYOa+lPkHwYgIrQzW71Xw8N
 5VizyU+gJnj48t8QiIkJ975y9X1gkhETNg==
X-Google-Smtp-Source: ABdhPJwZObsEu8F5INUsvjQ8cz1MKDyRzRFpaBjGfKgiWcqbuSEzB2QfIMzWZgTdyKXSf+zp7gasYw==
X-Received: by 2002:a05:6402:559:: with SMTP id
 i25mr4994902edx.35.1594741301264; 
 Tue, 14 Jul 2020 08:41:41 -0700 (PDT)
Received: from localhost.localdomain (31-10-158-161.cgn.dynamic.upc.ch.
 [31.10.158.161])
 by smtp.gmail.com with ESMTPSA id s7sm15200482edr.57.2020.07.14.08.41.39
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 14 Jul 2020 08:41:40 -0700 (PDT)
From: Bas Nieuwenhuizen <bas@basnieuwenhuizen.nl>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH] dma-buf/sw_sync: Avoid recursive lock during fence signal.
Date: Tue, 14 Jul 2020 17:41:02 +0200
Message-Id: <20200714154102.450826-1-bas@basnieuwenhuizen.nl>
X-Mailer: git-send-email 2.27.0
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Gustavo Padovan <gustavo@padovan.org>, stable@vger.kernel.org,
 Chris Wilson <chris@chris-wilson.co.uk>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

Q2FsbHRyZWU6CiAgdGltZWxpbmVfZmVuY2VfcmVsZWFzZQogIGRybV9zY2hlZF9lbnRpdHlfd2Fr
ZXVwCiAgZG1hX2ZlbmNlX3NpZ25hbF9sb2NrZWQKICBzeW5jX3RpbWVsaW5lX3NpZ25hbAogIHN3
X3N5bmNfaW9jdGwKClJlbGVhc2luZyB0aGUgcmVmZXJlbmNlIHRvIHRoZSBmZW5jZSBpbiB0aGUg
ZmVuY2Ugc2lnbmFsIGNhbGxiYWNrCnNlZW1zIHJlYXNvbmFibGUgdG8gbWUsIHNvIHRoaXMgcGF0
Y2ggYXZvaWRzIHRoZSBsb2NraW5nIGlzc3VlIGluCnN3X3N5bmMuCgpkMzg2MmU0NGRhYTcgKCJk
bWEtYnVmL3N3LXN5bmM6IEZpeCBsb2NraW5nIGFyb3VuZCBzeW5jX3RpbWVsaW5lIGxpc3RzIikK
Zml4ZWQgdGhlIHJlY3Vyc2l2ZSBsb2NraW5nIGlzc3VlIGJ1dCBjYXVzZWQgYW4gdXNlLWFmdGVy
LWZyZWUuIExhdGVyCmQzYzZkZDFmYjMwZCAoImRtYS1idWYvc3dfc3luYzogU3luY2hyb25pemUg
c2lnbmFsIHZzIHN5bmNwdCBmcmVlIikKZml4ZWQgdGhlIHVzZS1hZnRlci1mcmVlIGJ1dCByZWlu
dHJvZHVjZWQgdGhlIHJlY3Vyc2l2ZSBsb2NraW5nIGlzc3VlLgoKSW4gdGhpcyBhdHRlbXB0IHdl
IGF2b2lkIHRoZSB1c2UtYWZ0ZXItZnJlZSBzdGlsbCBiZWNhdXNlIHRoZSByZWxlYXNlCmZ1bmN0
aW9uIHN0aWxsIGFsd2F5cyBsb2NrcywgYW5kIG91dHNpZGUgb2YgdGhlIGxvY2tpbmcgcmVnaW9u
IGluIHRoZQpzaWduYWwgZnVuY3Rpb24gd2UgaGF2ZSBwcm9wZXJseSByZWZjb3VudGVkIHJlZmVy
ZW5jZXMuCgpXZSBmdXJ0aGVybW9yZSBhbHNvIGF2b2lkIHRoZSByZWN1cml2ZSBsb2NrIGJ5IG1h
a2luZyBzdXJlIHRoYXQgZWl0aGVyOgoKMSkgV2UgaGF2ZSBhIHByb3Blcmx5IHJlZmNvdW50ZWQg
cmVmZXJlbmNlLCBwcmV2ZW50aW5nIHRoZSBzaWduYWwgZnJvbQogICB0cmlnZ2VyaW5nIHRoZSBy
ZWxlYXNlIGZ1bmN0aW9uIGluc2lkZSB0aGUgbG9ja2VkIHJlZ2lvbi4KMikgVGhlIHJlZmNvdW50
IHdhcyBhbHJlYWR5IHplcm8sIGFuZCBoZW5jZSBub2JvZHkgd2lsbCBiZSBhYmxlIHRvIHRyaWdn
ZXIKICAgdGhlIHJlbGVhc2UgZnVuY3Rpb24gZnJvbSB0aGUgc2lnbmFsIGZ1bmN0aW9uLgoKRml4
ZXM6IGQzYzZkZDFmYjMwZCAoImRtYS1idWYvc3dfc3luYzogU3luY2hyb25pemUgc2lnbmFsIHZz
IHN5bmNwdCBmcmVlIikKQ2M6IFN1bWl0IFNlbXdhbCA8c3VtaXQuc2Vtd2FsQGxpbmFyby5vcmc+
CkNjOiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KQ2M6IEd1c3Rhdm8g
UGFkb3ZhbiA8Z3VzdGF2b0BwYWRvdmFuLm9yZz4KQ2M6IENocmlzdGlhbiBLw7ZuaWcgPGNocmlz
dGlhbi5rb2VuaWdAYW1kLmNvbT4KQ2M6IDxzdGFibGVAdmdlci5rZXJuZWwub3JnPgpTaWduZWQt
b2ZmLWJ5OiBCYXMgTmlldXdlbmh1aXplbiA8YmFzQGJhc25pZXV3ZW5odWl6ZW4ubmw+Ci0tLQog
ZHJpdmVycy9kbWEtYnVmL3N3X3N5bmMuYyB8IDI4ICsrKysrKysrKysrKysrKysrKysrLS0tLS0t
LS0KIDEgZmlsZSBjaGFuZ2VkLCAyMCBpbnNlcnRpb25zKCspLCA4IGRlbGV0aW9ucygtKQoKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9zd19zeW5jLmMgYi9kcml2ZXJzL2RtYS1idWYvc3df
c3luYy5jCmluZGV4IDM0OGIzYTkxNzBmYS4uMzBhNDgyZjc1ZDU2IDEwMDY0NAotLS0gYS9kcml2
ZXJzL2RtYS1idWYvc3dfc3luYy5jCisrKyBiL2RyaXZlcnMvZG1hLWJ1Zi9zd19zeW5jLmMKQEAg
LTE5Miw5ICsxOTIsMTIgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfZmVuY2Vfb3BzIHRpbWVs
aW5lX2ZlbmNlX29wcyA9IHsKIHN0YXRpYyB2b2lkIHN5bmNfdGltZWxpbmVfc2lnbmFsKHN0cnVj
dCBzeW5jX3RpbWVsaW5lICpvYmosIHVuc2lnbmVkIGludCBpbmMpCiB7CiAJc3RydWN0IHN5bmNf
cHQgKnB0LCAqbmV4dDsKKwlzdHJ1Y3QgbGlzdF9oZWFkIHJlZl9saXN0OwogCiAJdHJhY2Vfc3lu
Y190aW1lbGluZShvYmopOwogCisJSU5JVF9MSVNUX0hFQUQoJnJlZl9saXN0KTsKKwogCXNwaW5f
bG9ja19pcnEoJm9iai0+bG9jayk7CiAKIAlvYmotPnZhbHVlICs9IGluYzsKQEAgLTIwNiwxOCAr
MjA5LDI3IEBAIHN0YXRpYyB2b2lkIHN5bmNfdGltZWxpbmVfc2lnbmFsKHN0cnVjdCBzeW5jX3Rp
bWVsaW5lICpvYmosIHVuc2lnbmVkIGludCBpbmMpCiAJCWxpc3RfZGVsX2luaXQoJnB0LT5saW5r
KTsKIAkJcmJfZXJhc2UoJnB0LT5ub2RlLCAmb2JqLT5wdF90cmVlKTsKIAotCQkvKgotCQkgKiBB
IHNpZ25hbCBjYWxsYmFjayBtYXkgcmVsZWFzZSB0aGUgbGFzdCByZWZlcmVuY2UgdG8gdGhpcwot
CQkgKiBmZW5jZSwgY2F1c2luZyBpdCB0byBiZSBmcmVlZC4gVGhhdCBvcGVyYXRpb24gaGFzIHRv
IGJlCi0JCSAqIGxhc3QgdG8gYXZvaWQgYSB1c2UgYWZ0ZXIgZnJlZSBpbnNpZGUgdGhpcyBsb29w
LCBhbmQgbXVzdAotCQkgKiBiZSBhZnRlciB3ZSByZW1vdmUgdGhlIGZlbmNlIGZyb20gdGhlIHRp
bWVsaW5lIGluIG9yZGVyIHRvCi0JCSAqIHByZXZlbnQgZGVhZGxvY2tpbmcgb24gdGltZWxpbmUt
PmxvY2sgaW5zaWRlCi0JCSAqIHRpbWVsaW5lX2ZlbmNlX3JlbGVhc2UoKS4KLQkJICovCisJCS8q
IFdlIG5lZWQgdG8gdGFrZSBhIHJlZmVyZW5jZSB0byBhdm9pZCBhIHJlbGVhc2UgZHVyaW5nCisJ
CSAqIHNpZ25hbGxpbmcgKHdoaWNoIGNhbiBjYXVzZSBhIHJlY3Vyc2l2ZSBsb2NrIG9mIG9iai0+
bG9jaykuCisJCSAqIElmIHJlZmNvdW50IHdhcyBhbHJlYWR5IHplcm8sIGFub3RoZXIgdGhyZWFk
IGlzIGFscmVhZHkgdGFraW5nCisJCSAqIGNhcmUgb2YgZGVzdHJ1Y3RpbmcgdGhlIGZlbmNlLCBz
byB0aGUgc2lnbmFsIGNhbm5vdCByZWxlYXNlCisJCSAqIGl0IGFnYWluIGFuZCB3ZSBoZW5jZSB3
aWxsIG5vdCBoYXZlIHRoZSByZWN1cnNpdmUgbG9jay4gKi8KKwkJaWYgKGRtYV9mZW5jZV9nZXRf
cmN1KCZwdC0+YmFzZSkpCisJCQlsaXN0X2FkZF90YWlsKCZwdC0+bGluaywgJnJlZl9saXN0KTsK
KwogCQlkbWFfZmVuY2Vfc2lnbmFsX2xvY2tlZCgmcHQtPmJhc2UpOwogCX0KIAogCXNwaW5fdW5s
b2NrX2lycSgmb2JqLT5sb2NrKTsKKworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShwdCwgbmV4
dCwgJnJlZl9saXN0LCBsaW5rKSB7CisJCS8qIFRoaXMgbmVlZHMgdG8gYmUgY2xlYXJlZCBiZWZv
cmUgcmVsZWFzZSwgb3RoZXJ3aXNlIHRoZQorCQkgKiB0aW1lbGluZV9mZW5jZV9yZWxlYXNlIGZ1
bmN0aW9uIGdldHMgY29uZnVzZWQgYWJvdXQgYWxzbworCQkgKiByZW1vdmluZyB0aGUgZmVuY2Ug
ZnJvbSB0aGUgcHRfdHJlZS4gKi8KKwkJbGlzdF9kZWxfaW5pdCgmcHQtPmxpbmspOworCisJCWRt
YV9mZW5jZV9wdXQoJnB0LT5iYXNlKTsKKwl9CiB9CiAKIC8qKgotLSAKMi4yNy4wCgpfX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGlu
ZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVl
ZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
