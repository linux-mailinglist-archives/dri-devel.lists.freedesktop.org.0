Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 0A86C1299F
	for <lists+dri-devel@lfdr.de>; Fri,  3 May 2019 10:13:21 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B5571898A4;
	Fri,  3 May 2019 08:13:17 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from relay7-d.mail.gandi.net (relay7-d.mail.gandi.net
 [217.70.183.200])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 74D828989F
 for <dri-devel@lists.freedesktop.org>; Fri,  3 May 2019 08:13:15 +0000 (UTC)
X-Originating-IP: 90.88.149.145
Received: from localhost.localdomain
 (aaubervilliers-681-1-29-145.w90-88.abo.wanadoo.fr [90.88.149.145])
 (Authenticated sender: paul.kocialkowski@bootlin.com)
 by relay7-d.mail.gandi.net (Postfix) with ESMTPSA id A6B5820006;
 Fri,  3 May 2019 08:13:12 +0000 (UTC)
From: Paul Kocialkowski <paul.kocialkowski@bootlin.com>
To: dri-devel@lists.freedesktop.org,
	linux-kernel@vger.kernel.org
Subject: [PATCH v8 4/4] drm/vc4: Allocate binner bo when starting to use the
 V3D
Date: Fri,  3 May 2019 10:12:42 +0200
Message-Id: <20190503081242.29039-5-paul.kocialkowski@bootlin.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190503081242.29039-1-paul.kocialkowski@bootlin.com>
References: <20190503081242.29039-1-paul.kocialkowski@bootlin.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Maxime Ripard <maxime.ripard@bootlin.com>,
 Eben Upton <eben@raspberrypi.org>, David Airlie <airlied@linux.ie>,
 Paul Kocialkowski <paul.kocialkowski@bootlin.com>,
 Thomas Petazzoni <thomas.petazzoni@bootlin.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhlIGJpbm5lciBCTyBpcyBub3QgcmVxdWlyZWQgdW50aWwgdGhlIFYzRCBpcyBpbiB1c2UsIHNv
IGF2b2lkCmFsbG9jYXRpbmcgaXQgYXQgcHJvYmUgYW5kIGRvIGl0IG9uIHRoZSBmaXJzdCBub24t
ZHVtYiBCTyBhbGxvY2F0aW9uLgoKS2VlcCB0cmFjayBvZiB3aGljaCBjbGllbnRzIGFyZSB1c2lu
ZyB0aGUgVjNEIGFuZCBsaWJlcmF0ZSB0aGUgYnVmZmVyCndoZW4gdGhlcmUgaXMgbm9uZSBsZWZ0
LCB1c2luZyBhIGtyZWYuIFByb3RlY3QgdGhlIGxvZ2ljIHdpdGggYQptdXRleCB0byBhdm9pZCBy
YWNlIGNvbmRpdGlvbnMuCgpUaGUgYmlubmVyIEJPIGlzIGNyZWF0ZWQgYXQgdGhlIHRpbWUgb2Yg
dGhlIGZpcnN0IHJlbmRlciBpb2N0bCBhbmQgaXMKZGVzdHJveWVkIHdoZW4gdGhlcmUgaXMgbm8g
Y2xpZW50IGFuZCBubyBleGVjIGpvYiB1c2luZyBpdCBsZWZ0LgoKVGhlIE91dC1PZi1NZW1vcnkg
KE9PTSkgaW50ZXJydXB0IGFsc28gZ2V0cyBzb21lIHR3ZWFraW5nLCB0byBhdm9pZAplbmFibGlu
ZyBpdCBiZWZvcmUgaGF2aW5nIGFsbG9jYXRlZCBhIGJpbm5lciBiby4KCldlIGFsc28gd2FudCB0
byBrZWVwIHRoZSBCTyBhbGl2ZSBkdXJpbmcgcnVudGltZSBzdXNwZW5kL3Jlc3VtZSB0byBhdm9p
ZApmYWlsaW5nIHRvIGFsbG9jYXRlIGl0IGF0IHJlc3VtZS4gVGhpcyBoYXBwZW5zIHdoZW4gdGhl
IENNQSBwb29sIGlzCmZ1bGwgYXQgdGhhdCBwb2ludCBhbmQgcmVzdWx0cyBpbiBhIGhhcmQgY3Jh
c2guCgpTaWduZWQtb2ZmLWJ5OiBQYXVsIEtvY2lhbGtvd3NraSA8cGF1bC5rb2NpYWxrb3dza2lA
Ym9vdGxpbi5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfYm8uYyAgfCAzMSArKysr
KysrKysrKysrKysrLQogZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2LmMgfCAgNiArKysrCiBk
cml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9kcnYuaCB8IDE0ICsrKysrKysrCiBkcml2ZXJzL2dwdS9k
cm0vdmM0L3ZjNF9nZW0uYyB8IDExICsrKysrKwogZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfaXJx
LmMgfCAyMSArKysrKysrKy0tLS0KIGRyaXZlcnMvZ3B1L2RybS92YzQvdmM0X3YzZC5jIHwgNjQg
KysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0KIDYgZmlsZXMgY2hhbmdlZCwgMTI3
IGluc2VydGlvbnMoKyksIDIwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS92YzQvdmM0X2JvLmMgYi9kcml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9iby5jCmluZGV4IDg4
ZWJkNjgxZDdlYi4uMTQzNGJiODI5MjY3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmM0
L3ZjNF9iby5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2JvLmMKQEAgLTc5OSwxMyAr
Nzk5LDM2IEBAIHZjNF9wcmltZV9pbXBvcnRfc2dfdGFibGUoc3RydWN0IGRybV9kZXZpY2UgKmRl
diwKIAlyZXR1cm4gb2JqOwogfQogCitzdGF0aWMgaW50IHZjNF9ncmFiX2Jpbl9ibyhzdHJ1Y3Qg
dmM0X2RldiAqdmM0LCBzdHJ1Y3QgdmM0X2ZpbGUgKnZjNGZpbGUpCit7CisJaW50IHJldDsKKwor
CWlmICghdmM0LT52M2QpCisJCXJldHVybiAtRU5PREVWOworCisJaWYgKHZjNGZpbGUtPmJpbl9i
b191c2VkKQorCQlyZXR1cm4gMDsKKworCXJldCA9IHZjNF92M2RfYmluX2JvX2dldCh2YzQsICZ2
YzRmaWxlLT5iaW5fYm9fdXNlZCk7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKworCXJldHVy
biAwOworfQorCiBpbnQgdmM0X2NyZWF0ZV9ib19pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2
LCB2b2lkICpkYXRhLAogCQkJc3RydWN0IGRybV9maWxlICpmaWxlX3ByaXYpCiB7CiAJc3RydWN0
IGRybV92YzRfY3JlYXRlX2JvICphcmdzID0gZGF0YTsKKwlzdHJ1Y3QgdmM0X2ZpbGUgKnZjNGZp
bGUgPSBmaWxlX3ByaXYtPmRyaXZlcl9wcml2OworCXN0cnVjdCB2YzRfZGV2ICp2YzQgPSB0b192
YzRfZGV2KGRldik7CiAJc3RydWN0IHZjNF9ibyAqYm8gPSBOVUxMOwogCWludCByZXQ7CiAKKwly
ZXQgPSB2YzRfZ3JhYl9iaW5fYm8odmM0LCB2YzRmaWxlKTsKKwlpZiAocmV0KQorCQlyZXR1cm4g
cmV0OworCiAJLyoKIAkgKiBXZSBjYW4ndCBhbGxvY2F0ZSBmcm9tIHRoZSBCTyBjYWNoZSwgYmVj
YXVzZSB0aGUgQk9zIGRvbid0CiAJICogZ2V0IHplcm9lZCwgYW5kIHRoYXQgbWlnaHQgbGVhayBk
YXRhIGJldHdlZW4gdXNlcnMuCkBAIC04NDYsNiArODY5LDggQEAgdmM0X2NyZWF0ZV9zaGFkZXJf
Ym9faW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJCSAgIHN0cnVj
dCBkcm1fZmlsZSAqZmlsZV9wcml2KQogewogCXN0cnVjdCBkcm1fdmM0X2NyZWF0ZV9zaGFkZXJf
Ym8gKmFyZ3MgPSBkYXRhOworCXN0cnVjdCB2YzRfZmlsZSAqdmM0ZmlsZSA9IGZpbGVfcHJpdi0+
ZHJpdmVyX3ByaXY7CisJc3RydWN0IHZjNF9kZXYgKnZjNCA9IHRvX3ZjNF9kZXYoZGV2KTsKIAlz
dHJ1Y3QgdmM0X2JvICpibyA9IE5VTEw7CiAJaW50IHJldDsKIApAQCAtODY1LDYgKzg5MCwxMCBA
QCB2YzRfY3JlYXRlX3NoYWRlcl9ib19pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lk
ICpkYXRhLAogCQlyZXR1cm4gLUVJTlZBTDsKIAl9CiAKKwlyZXQgPSB2YzRfZ3JhYl9iaW5fYm8o
dmM0LCB2YzRmaWxlKTsKKwlpZiAocmV0KQorCQlyZXR1cm4gcmV0OworCiAJYm8gPSB2YzRfYm9f
Y3JlYXRlKGRldiwgYXJncy0+c2l6ZSwgdHJ1ZSwgVkM0X0JPX1RZUEVfVjNEX1NIQURFUik7CiAJ
aWYgKElTX0VSUihibykpCiAJCXJldHVybiBQVFJfRVJSKGJvKTsKQEAgLTg5NCw3ICs5MjMsNyBA
QCB2YzRfY3JlYXRlX3NoYWRlcl9ib19pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lk
ICpkYXRhLAogCSAqLwogCXJldCA9IGRybV9nZW1faGFuZGxlX2NyZWF0ZShmaWxlX3ByaXYsICZi
by0+YmFzZS5iYXNlLCAmYXJncy0+aGFuZGxlKTsKIAotIGZhaWw6CitmYWlsOgogCWRybV9nZW1f
b2JqZWN0X3B1dF91bmxvY2tlZCgmYm8tPmJhc2UuYmFzZSk7CiAKIAlyZXR1cm4gcmV0OwpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2LmMgYi9kcml2ZXJzL2dwdS9kcm0v
dmM0L3ZjNF9kcnYuYwppbmRleCA2ZDliZTIwYTMyYmUuLjBmOTlhZDAzNjE0ZSAxMDA2NDQKLS0t
IGEvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3Zj
NC92YzRfZHJ2LmMKQEAgLTEyOCw4ICsxMjgsMTIgQEAgc3RhdGljIGludCB2YzRfb3BlbihzdHJ1
Y3QgZHJtX2RldmljZSAqZGV2LCBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGUpCiAKIHN0YXRpYyB2b2lk
IHZjNF9jbG9zZShzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGUp
CiB7CisJc3RydWN0IHZjNF9kZXYgKnZjNCA9IHRvX3ZjNF9kZXYoZGV2KTsKIAlzdHJ1Y3QgdmM0
X2ZpbGUgKnZjNGZpbGUgPSBmaWxlLT5kcml2ZXJfcHJpdjsKIAorCWlmICh2YzRmaWxlLT5iaW5f
Ym9fdXNlZCkKKwkJdmM0X3YzZF9iaW5fYm9fcHV0KHZjNCk7CisKIAl2YzRfcGVyZm1vbl9jbG9z
ZV9maWxlKHZjNGZpbGUpOwogCWtmcmVlKHZjNGZpbGUpOwogfQpAQCAtMjc0LDYgKzI3OCw4IEBA
IHN0YXRpYyBpbnQgdmM0X2RybV9iaW5kKHN0cnVjdCBkZXZpY2UgKmRldikKIAlkcm0tPmRldl9w
cml2YXRlID0gdmM0OwogCUlOSVRfTElTVF9IRUFEKCZ2YzQtPmRlYnVnZnNfbGlzdCk7CiAKKwlt
dXRleF9pbml0KCZ2YzQtPmJpbl9ib19sb2NrKTsKKwogCXJldCA9IHZjNF9ib19jYWNoZV9pbml0
KGRybSk7CiAJaWYgKHJldCkKIAkJZ290byBkZXZfcHV0OwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL3ZjNC92YzRfZHJ2LmggYi9kcml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9kcnYuaAppbmRl
eCA0ZjEzZjYyNjI0OTEuLjkxNzBhMjRlYzVmNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJt
L3ZjNC92YzRfZHJ2LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2LmgKQEAgLTIx
Niw2ICsyMTYsMTEgQEAgc3RydWN0IHZjNF9kZXYgewogCSAqIHRoZSBtaW5vciBpcyBhdmFpbGFi
bGUgKGFmdGVyIGRybV9kZXZfcmVnaXN0ZXIoKSkuCiAJICovCiAJc3RydWN0IGxpc3RfaGVhZCBk
ZWJ1Z2ZzX2xpc3Q7CisKKwkvKiBNdXRleCBmb3IgYmlubmVyIGJvIGFsbG9jYXRpb24uICovCisJ
c3RydWN0IG11dGV4IGJpbl9ib19sb2NrOworCS8qIFJlZmVyZW5jZSBjb3VudCBmb3Igb3VyIGJp
bm5lciBiby4gKi8KKwlzdHJ1Y3Qga3JlZiBiaW5fYm9fa3JlZjsKIH07CiAKIHN0YXRpYyBpbmxp
bmUgc3RydWN0IHZjNF9kZXYgKgpAQCAtNTg0LDYgKzU4OSwxMSBAQCBzdHJ1Y3QgdmM0X2V4ZWNf
aW5mbyB7CiAJICogTlVMTCBvdGhlcndpc2UuCiAJICovCiAJc3RydWN0IHZjNF9wZXJmbW9uICpw
ZXJmbW9uOworCisJLyogV2hldGhlciB0aGUgZXhlYyBoYXMgdGFrZW4gYSByZWZlcmVuY2UgdG8g
dGhlIGJpbm5lciBCTywgd2hpY2ggc2hvdWxkCisJICogaGFwcGVuIHdpdGggYSBWQzRfUEFDS0VU
X1RJTEVfQklOTklOR19NT0RFX0NPTkZJRyBwYWNrZXQuCisJICovCisJYm9vbCBiaW5fYm9fdXNl
ZDsKIH07CiAKIC8qIFBlci1vcGVuIGZpbGUgcHJpdmF0ZSBkYXRhLiBBbnkgZHJpdmVyLXNwZWNp
ZmljIHJlc291cmNlIHRoYXQgaGFzIHRvIGJlCkBAIC01OTQsNiArNjA0LDggQEAgc3RydWN0IHZj
NF9maWxlIHsKIAkJc3RydWN0IGlkciBpZHI7CiAJCXN0cnVjdCBtdXRleCBsb2NrOwogCX0gcGVy
Zm1vbjsKKworCWJvb2wgYmluX2JvX3VzZWQ7CiB9OwogCiBzdGF0aWMgaW5saW5lIHN0cnVjdCB2
YzRfZXhlY19pbmZvICoKQEAgLTgzMyw2ICs4NDUsOCBAQCB2b2lkIHZjNF9wbGFuZV9hc3luY19z
ZXRfZmIoc3RydWN0IGRybV9wbGFuZSAqcGxhbmUsCiBleHRlcm4gc3RydWN0IHBsYXRmb3JtX2Ry
aXZlciB2YzRfdjNkX2RyaXZlcjsKIGV4dGVybiBjb25zdCBzdHJ1Y3Qgb2ZfZGV2aWNlX2lkIHZj
NF92M2RfZHRfbWF0Y2hbXTsKIGludCB2YzRfdjNkX2dldF9iaW5fc2xvdChzdHJ1Y3QgdmM0X2Rl
diAqdmM0KTsKK2ludCB2YzRfdjNkX2Jpbl9ib19nZXQoc3RydWN0IHZjNF9kZXYgKnZjNCwgYm9v
bCAqdXNlZCk7Cit2b2lkIHZjNF92M2RfYmluX2JvX3B1dChzdHJ1Y3QgdmM0X2RldiAqdmM0KTsK
IGludCB2YzRfdjNkX3BtX2dldChzdHJ1Y3QgdmM0X2RldiAqdmM0KTsKIHZvaWQgdmM0X3YzZF9w
bV9wdXQoc3RydWN0IHZjNF9kZXYgKnZjNCk7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS92YzQvdmM0X2dlbS5jIGIvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZ2VtLmMKaW5kZXggZDkz
MTFiZTMyYTRmLi44NDc5NWQ5MjhmMjAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS92YzQv
dmM0X2dlbS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2dlbS5jCkBAIC04MjAsNiAr
ODIwLDcgQEAgc3RhdGljIGludAogdmM0X2dldF9iY2woc3RydWN0IGRybV9kZXZpY2UgKmRldiwg
c3RydWN0IHZjNF9leGVjX2luZm8gKmV4ZWMpCiB7CiAJc3RydWN0IGRybV92YzRfc3VibWl0X2Ns
ICphcmdzID0gZXhlYy0+YXJnczsKKwlzdHJ1Y3QgdmM0X2RldiAqdmM0ID0gdG9fdmM0X2Rldihk
ZXYpOwogCXZvaWQgKnRlbXAgPSBOVUxMOwogCXZvaWQgKmJpbjsKIAlpbnQgcmV0ID0gMDsKQEAg
LTkxOCw2ICs5MTksMTIgQEAgdmM0X2dldF9iY2woc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3Ry
dWN0IHZjNF9leGVjX2luZm8gKmV4ZWMpCiAJaWYgKHJldCkKIAkJZ290byBmYWlsOwogCisJaWYg
KGV4ZWMtPmZvdW5kX3RpbGVfYmlubmluZ19tb2RlX2NvbmZpZ19wYWNrZXQpIHsKKwkJcmV0ID0g
dmM0X3YzZF9iaW5fYm9fZ2V0KHZjNCwgJmV4ZWMtPmJpbl9ib191c2VkKTsKKwkJaWYgKHJldCkK
KwkJCWdvdG8gZmFpbDsKKwl9CisKIAkvKiBCbG9jayB3YWl0aW5nIG9uIGFueSBwcmV2aW91cyBy
ZW5kZXJpbmcgaW50byB0aGUgQ1MncyBWQk8sCiAJICogSUIsIG9yIHRleHR1cmVzLCBzbyB0aGF0
IHBpeGVscyBhcmUgYWN0dWFsbHkgd3JpdHRlbiBieSB0aGUKIAkgKiB0aW1lIHdlIHRyeSB0byBy
ZWFkIHRoZW0uCkBAIC05NjYsNiArOTczLDEwIEBAIHZjNF9jb21wbGV0ZV9leGVjKHN0cnVjdCBk
cm1fZGV2aWNlICpkZXYsIHN0cnVjdCB2YzRfZXhlY19pbmZvICpleGVjKQogCXZjNC0+YmluX2Fs
bG9jX3VzZWQgJj0gfmV4ZWMtPmJpbl9zbG90czsKIAlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZ2
YzQtPmpvYl9sb2NrLCBpcnFmbGFncyk7CiAKKwkvKiBSZWxlYXNlIHRoZSByZWZlcmVuY2Ugb24g
dGhlIGJpbm5lciBCTyBpZiBuZWVkZWQuICovCisJaWYgKGV4ZWMtPmJpbl9ib191c2VkKQorCQl2
YzRfdjNkX2Jpbl9ib19wdXQodmM0KTsKKwogCS8qIFJlbGVhc2UgdGhlIHJlZmVyZW5jZSB3ZSBo
YWQgb24gdGhlIHBlcmYgbW9uaXRvci4gKi8KIAl2YzRfcGVyZm1vbl9wdXQoZXhlYy0+cGVyZm1v
bik7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2lycS5jIGIvZHJpdmVy
cy9ncHUvZHJtL3ZjNC92YzRfaXJxLmMKaW5kZXggNzIzZGM4NmI0NTExLi5lMjI2YzI0ZTU0M2Yg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2lycS5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS92YzQvdmM0X2lycS5jCkBAIC01OSwxOCArNTksMjIgQEAgdmM0X292ZXJmbG93X21l
bV93b3JrKHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykKIHsKIAlzdHJ1Y3QgdmM0X2RldiAqdmM0
ID0KIAkJY29udGFpbmVyX29mKHdvcmssIHN0cnVjdCB2YzRfZGV2LCBvdmVyZmxvd19tZW1fd29y
ayk7Ci0Jc3RydWN0IHZjNF9ibyAqYm8gPSB2YzQtPmJpbl9ibzsKKwlzdHJ1Y3QgdmM0X2JvICpi
bzsKIAlpbnQgYmluX2JvX3Nsb3Q7CiAJc3RydWN0IHZjNF9leGVjX2luZm8gKmV4ZWM7CiAJdW5z
aWduZWQgbG9uZyBpcnFmbGFnczsKIAotCWlmICghYm8pCi0JCXJldHVybjsKKwltdXRleF9sb2Nr
KCZ2YzQtPmJpbl9ib19sb2NrKTsKKworCWlmICghdmM0LT5iaW5fYm8pCisJCWdvdG8gY29tcGxl
dGU7CisKKwlibyA9IHZjNC0+YmluX2JvOwogCiAJYmluX2JvX3Nsb3QgPSB2YzRfdjNkX2dldF9i
aW5fc2xvdCh2YzQpOwogCWlmIChiaW5fYm9fc2xvdCA8IDApIHsKIAkJRFJNX0VSUk9SKCJDb3Vs
ZG4ndCBhbGxvY2F0ZSBiaW5uZXIgb3ZlcmZsb3cgbWVtXG4iKTsKLQkJcmV0dXJuOworCQlnb3Rv
IGNvbXBsZXRlOwogCX0KIAogCXNwaW5fbG9ja19pcnFzYXZlKCZ2YzQtPmpvYl9sb2NrLCBpcnFm
bGFncyk7CkBAIC0xMDEsNiArMTA1LDkgQEAgdmM0X292ZXJmbG93X21lbV93b3JrKHN0cnVjdCB3
b3JrX3N0cnVjdCAqd29yaykKIAlWM0RfV1JJVEUoVjNEX0lOVENUTCwgVjNEX0lOVF9PVVRPTUVN
KTsKIAlWM0RfV1JJVEUoVjNEX0lOVEVOQSwgVjNEX0lOVF9PVVRPTUVNKTsKIAlzcGluX3VubG9j
a19pcnFyZXN0b3JlKCZ2YzQtPmpvYl9sb2NrLCBpcnFmbGFncyk7CisKK2NvbXBsZXRlOgorCW11
dGV4X3VubG9jaygmdmM0LT5iaW5fYm9fbG9jayk7CiB9CiAKIHN0YXRpYyB2b2lkCkBAIC0yNTIs
OCArMjU5LDEwIEBAIHZjNF9pcnFfcG9zdGluc3RhbGwoc3RydWN0IGRybV9kZXZpY2UgKmRldikK
IAlpZiAoIXZjNC0+djNkKQogCQlyZXR1cm4gMDsKIAotCS8qIEVuYWJsZSBib3RoIHRoZSByZW5k
ZXIgZG9uZSBhbmQgb3V0IG9mIG1lbW9yeSBpbnRlcnJ1cHRzLiAqLwotCVYzRF9XUklURShWM0Rf
SU5URU5BLCBWM0RfRFJJVkVSX0lSUVMpOworCS8qIEVuYWJsZSB0aGUgcmVuZGVyIGRvbmUgaW50
ZXJydXB0cy4gVGhlIG91dC1vZi1tZW1vcnkgaW50ZXJydXB0IGlzCisJICogZW5hYmxlZCBhcyBz
b29uIGFzIHdlIGhhdmUgYSBiaW5uZXIgQk8gYWxsb2NhdGVkLgorCSAqLworCVYzRF9XUklURShW
M0RfSU5URU5BLCBWM0RfSU5UX0ZMRE9ORSB8IFYzRF9JTlRfRlJET05FKTsKIAogCXJldHVybiAw
OwogfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfdjNkLmMgYi9kcml2ZXJz
L2dwdS9kcm0vdmM0L3ZjNF92M2QuYwppbmRleCBjMTZkYjQ2NjVhZjYuLjdkZjcxNzI0MWExMCAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfdjNkLmMKKysrIGIvZHJpdmVycy9n
cHUvZHJtL3ZjNC92YzRfdjNkLmMKQEAgLTI5NCw2ICsyOTQsMTQgQEAgc3RhdGljIGludCBiaW5f
Ym9fYWxsb2Moc3RydWN0IHZjNF9kZXYgKnZjNCkKIAkJCVdBUk5fT05fT05DRShzaXplb2YodmM0
LT5iaW5fYWxsb2NfdXNlZCkgKiA4ICE9CiAJCQkJICAgICBiby0+YmFzZS5iYXNlLnNpemUgLyB2
YzQtPmJpbl9hbGxvY19zaXplKTsKIAorCQkJa3JlZl9pbml0KCZ2YzQtPmJpbl9ib19rcmVmKTsK
KworCQkJLyogRW5hYmxlIHRoZSBvdXQtb2YtbWVtb3J5IGludGVycnVwdCB0byBzZXQgb3VyCisJ
CQkgKiBuZXdseS1hbGxvY2F0ZWQgYmlubmVyIEJPLCBwb3RlbnRpYWxseSBmcm9tIGFuCisJCQkg
KiBhbHJlYWR5LXBlbmRpbmctYnV0LW1hc2tlZCBpbnRlcnVwdC4KKwkJCSAqLworCQkJVjNEX1dS
SVRFKFYzRF9JTlRFTkEsIFYzRF9JTlRfT1VUT01FTSk7CisKIAkJCWJyZWFrOwogCQl9CiAKQEAg
LTMxMyw2ICszMjEsNDkgQEAgc3RhdGljIGludCBiaW5fYm9fYWxsb2Moc3RydWN0IHZjNF9kZXYg
KnZjNCkKIAlyZXR1cm4gcmV0OwogfQogCitpbnQgdmM0X3YzZF9iaW5fYm9fZ2V0KHN0cnVjdCB2
YzRfZGV2ICp2YzQsIGJvb2wgKnVzZWQpCit7CisJaW50IHJldCA9IDA7CisKKwltdXRleF9sb2Nr
KCZ2YzQtPmJpbl9ib19sb2NrKTsKKworCWlmICh1c2VkICYmICp1c2VkKQorCQlnb3RvIGNvbXBs
ZXRlOworCisJaWYgKHVzZWQpCisJCSp1c2VkID0gdHJ1ZTsKKworCWlmICh2YzQtPmJpbl9ibykg
eworCQlrcmVmX2dldCgmdmM0LT5iaW5fYm9fa3JlZik7CisJCWdvdG8gY29tcGxldGU7CisJfQor
CisJcmV0ID0gYmluX2JvX2FsbG9jKHZjNCk7CisKK2NvbXBsZXRlOgorCW11dGV4X3VubG9jaygm
dmM0LT5iaW5fYm9fbG9jayk7CisKKwlyZXR1cm4gcmV0OworfQorCitzdGF0aWMgdm9pZCBiaW5f
Ym9fcmVsZWFzZShzdHJ1Y3Qga3JlZiAqcmVmKQoreworCXN0cnVjdCB2YzRfZGV2ICp2YzQgPSBj
b250YWluZXJfb2YocmVmLCBzdHJ1Y3QgdmM0X2RldiwgYmluX2JvX2tyZWYpOworCisJaWYgKFdB
Uk5fT05fT05DRSghdmM0LT5iaW5fYm8pKQorCQlyZXR1cm47CisKKwlkcm1fZ2VtX29iamVjdF9w
dXRfdW5sb2NrZWQoJnZjNC0+YmluX2JvLT5iYXNlLmJhc2UpOworCXZjNC0+YmluX2JvID0gTlVM
TDsKK30KKwordm9pZCB2YzRfdjNkX2Jpbl9ib19wdXQoc3RydWN0IHZjNF9kZXYgKnZjNCkKK3sK
KwltdXRleF9sb2NrKCZ2YzQtPmJpbl9ib19sb2NrKTsKKwlrcmVmX3B1dCgmdmM0LT5iaW5fYm9f
a3JlZiwgYmluX2JvX3JlbGVhc2UpOworCW11dGV4X3VubG9jaygmdmM0LT5iaW5fYm9fbG9jayk7
Cit9CisKICNpZmRlZiBDT05GSUdfUE0KIHN0YXRpYyBpbnQgdmM0X3YzZF9ydW50aW1lX3N1c3Bl
bmQoc3RydWN0IGRldmljZSAqZGV2KQogewpAQCAtMzIxLDkgKzM3Miw2IEBAIHN0YXRpYyBpbnQg
dmM0X3YzZF9ydW50aW1lX3N1c3BlbmQoc3RydWN0IGRldmljZSAqZGV2KQogCiAJdmM0X2lycV91
bmluc3RhbGwodmM0LT5kZXYpOwogCi0JZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKCZ2YzQt
PmJpbl9iby0+YmFzZS5iYXNlKTsKLQl2YzQtPmJpbl9ibyA9IE5VTEw7Ci0KIAljbGtfZGlzYWJs
ZV91bnByZXBhcmUodjNkLT5jbGspOwogCiAJcmV0dXJuIDA7CkBAIC0zMzUsMTAgKzM4Myw2IEBA
IHN0YXRpYyBpbnQgdmM0X3YzZF9ydW50aW1lX3Jlc3VtZShzdHJ1Y3QgZGV2aWNlICpkZXYpCiAJ
c3RydWN0IHZjNF9kZXYgKnZjNCA9IHYzZC0+dmM0OwogCWludCByZXQ7CiAKLQlyZXQgPSBiaW5f
Ym9fYWxsb2ModmM0KTsKLQlpZiAocmV0KQotCQlyZXR1cm4gcmV0OwotCiAJcmV0ID0gY2xrX3By
ZXBhcmVfZW5hYmxlKHYzZC0+Y2xrKTsKIAlpZiAocmV0ICE9IDApCiAJCXJldHVybiByZXQ7CkBA
IC00MDUsMTIgKzQ0OSw2IEBAIHN0YXRpYyBpbnQgdmM0X3YzZF9iaW5kKHN0cnVjdCBkZXZpY2Ug
KmRldiwgc3RydWN0IGRldmljZSAqbWFzdGVyLCB2b2lkICpkYXRhKQogCWlmIChyZXQgIT0gMCkK
IAkJcmV0dXJuIHJldDsKIAotCXJldCA9IGJpbl9ib19hbGxvYyh2YzQpOwotCWlmIChyZXQpIHsK
LQkJY2xrX2Rpc2FibGVfdW5wcmVwYXJlKHYzZC0+Y2xrKTsKLQkJcmV0dXJuIHJldDsKLQl9Ci0K
IAkvKiBSZXNldCB0aGUgYmlubmVyIG92ZXJmbG93IGFkZHJlc3Mvc2l6ZSBhdCBzZXR1cCwgdG8g
YmUgc3VyZQogCSAqIHdlIGRvbid0IHJldXNlIGFuIG9sZCBvbmUuCiAJICovCi0tIAoyLjIxLjAK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZl
bCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
