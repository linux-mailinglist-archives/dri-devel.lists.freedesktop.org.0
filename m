Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E4C1491160
	for <lists+dri-devel@lfdr.de>; Sat, 17 Aug 2019 17:25:44 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A3C406EAF3;
	Sat, 17 Aug 2019 15:24:35 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from foss.arm.com (foss.arm.com [217.140.110.172])
 by gabe.freedesktop.org (Postfix) with ESMTP id C76276E14B
 for <dri-devel@lists.freedesktop.org>; Fri, 16 Aug 2019 09:31:14 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
 by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 8D7C7360;
 Fri, 16 Aug 2019 02:31:14 -0700 (PDT)
Received: from e112269-lin.arm.com (e112269-lin.cambridge.arm.com
 [10.1.196.133])
 by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id C07A43F706;
 Fri, 16 Aug 2019 02:31:13 -0700 (PDT)
From: Steven Price <steven.price@arm.com>
To: Rob Herring <robh@kernel.org>,
	Tomeu Vizoso <tomeu.vizoso@collabora.com>
Subject: [PATCH] drm/panfrost: Queue jobs on the hardware
Date: Fri, 16 Aug 2019 10:31:06 +0100
Message-Id: <20190816093107.30518-2-steven.price@arm.com>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
X-Mailman-Approved-At: Sat, 17 Aug 2019 15:24:21 +0000
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 Steven Price <steven.price@arm.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhlIGhhcmR3YXJlIGhhcyBhIHNldCBvZiAnX05FWFQnIHJlZ2lzdGVycyB0aGF0IGNhbiBob2xk
IGEgc2Vjb25kIGpvYgp3aGlsZSB0aGUgZmlyc3QgaXMgZXhlY3V0aW5nLiBNYWtlIHVzZSBvZiB0
aGVzZSByZWdpc3RlcnMgdG8gZW5xdWV1ZSBhCnNlY29uZCBqb2IgcGVyIHNsb3QuCgpTaWduZWQt
b2ZmLWJ5OiBTdGV2ZW4gUHJpY2UgPHN0ZXZlbi5wcmljZUBhcm0uY29tPgotLS0KTm90ZSB0aGF0
IHRoaXMgaXMgYmFzZWQgb24gdG9wIG9mIFJvYiBIZXJyaW5nJ3MgInBlciBGRCBhZGRyZXNzIHNw
YWNlIgpwYXRjaFsxXS4KClsxXSBodHRwczovL21hcmMuaW5mby8/aT0yMDE5MDgxMzE1MDExNS4z
MDMzOC0xLXJvYmglMjAoKSUyMGtlcm5lbCUyMCElMjBvcmcKCiBkcml2ZXJzL2dwdS9kcm0vcGFu
ZnJvc3QvcGFuZnJvc3RfZGV2aWNlLmggfCAgNCArLQogZHJpdmVycy9ncHUvZHJtL3BhbmZyb3N0
L3BhbmZyb3N0X2pvYi5jICAgIHwgNzYgKysrKysrKysrKysrKysrKysrLS0tLQogZHJpdmVycy9n
cHUvZHJtL3BhbmZyb3N0L3BhbmZyb3N0X21tdS5jICAgIHwgIDIgKy0KIDMgZmlsZXMgY2hhbmdl
ZCwgNjcgaW5zZXJ0aW9ucygrKSwgMTUgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL3BhbmZyb3N0L3BhbmZyb3N0X2RldmljZS5oIGIvZHJpdmVycy9ncHUvZHJtL3Bh
bmZyb3N0L3BhbmZyb3N0X2RldmljZS5oCmluZGV4IGY1MDNjNTY2ZTk5Zi4uMDE1M2RlZmQ2MDg1
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vcGFuZnJvc3QvcGFuZnJvc3RfZGV2aWNlLmgK
KysrIGIvZHJpdmVycy9ncHUvZHJtL3BhbmZyb3N0L3BhbmZyb3N0X2RldmljZS5oCkBAIC01NSw3
ICs1NSw3IEBAIHN0cnVjdCBwYW5mcm9zdF9kZXZmcmVxX3Nsb3QgewogCWt0aW1lX3QgYnVzeV90
aW1lOwogCWt0aW1lX3QgaWRsZV90aW1lOwogCWt0aW1lX3QgdGltZV9sYXN0X3VwZGF0ZTsKLQli
b29sIGJ1c3k7CisJaW50IGJ1c3k7CiB9OwogCiBzdHJ1Y3QgcGFuZnJvc3RfZGV2aWNlIHsKQEAg
LTgwLDcgKzgwLDcgQEAgc3RydWN0IHBhbmZyb3N0X2RldmljZSB7CiAKIAlzdHJ1Y3QgcGFuZnJv
c3Rfam9iX3Nsb3QgKmpzOwogCi0Jc3RydWN0IHBhbmZyb3N0X2pvYiAqam9ic1tOVU1fSk9CX1NM
T1RTXTsKKwlzdHJ1Y3QgcGFuZnJvc3Rfam9iICpqb2JzW05VTV9KT0JfU0xPVFNdWzJdOwogCXN0
cnVjdCBsaXN0X2hlYWQgc2NoZWR1bGVkX2pvYnM7CiAKIAlzdHJ1Y3QgcGFuZnJvc3RfcGVyZmNu
dCAqcGVyZmNudDsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9z
dF9qb2IuYyBiL2RyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9qb2IuYwppbmRleCAw
NWM4NWY0NWEwZGUuLmIyYjUwMjdhZjk3NiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3Bh
bmZyb3N0L3BhbmZyb3N0X2pvYi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5m
cm9zdF9qb2IuYwpAQCAtMTM4LDYgKzEzOCwzNyBAQCBzdGF0aWMgdm9pZCBwYW5mcm9zdF9qb2Jf
d3JpdGVfYWZmaW5pdHkoc3RydWN0IHBhbmZyb3N0X2RldmljZSAqcGZkZXYsCiAJam9iX3dyaXRl
KHBmZGV2LCBKU19BRkZJTklUWV9ORVhUX0hJKGpzKSwgYWZmaW5pdHkgPj4gMzIpOwogfQogCitz
dGF0aWMgaW50IHBhbmZyb3N0X2pvYl9jb3VudChzdHJ1Y3QgcGFuZnJvc3RfZGV2aWNlICpwZmRl
diwgaW50IHNsb3QpCit7CisJaWYgKHBmZGV2LT5qb2JzW3Nsb3RdWzBdID09IE5VTEwpCisJCXJl
dHVybiAwOworCWlmIChwZmRldi0+am9ic1tzbG90XVsxXSA9PSBOVUxMKQorCQlyZXR1cm4gMTsK
KwlyZXR1cm4gMjsKK30KKworc3RhdGljIHN0cnVjdCBwYW5mcm9zdF9qb2IgKnBhbmZyb3N0X2Rl
cXVldWVfam9iKAorCQlzdHJ1Y3QgcGFuZnJvc3RfZGV2aWNlICpwZmRldiwgaW50IHNsb3QpCit7
CisJc3RydWN0IHBhbmZyb3N0X2pvYiAqam9iID0gcGZkZXYtPmpvYnNbc2xvdF1bMF07CisKKwlw
ZmRldi0+am9ic1tzbG90XVswXSA9IHBmZGV2LT5qb2JzW3Nsb3RdWzFdOworCXBmZGV2LT5qb2Jz
W3Nsb3RdWzFdID0gTlVMTDsKKworCXJldHVybiBqb2I7Cit9CisKK3N0YXRpYyB2b2lkIHBhbmZy
b3N0X2VucXVldWVfam9iKHN0cnVjdCBwYW5mcm9zdF9kZXZpY2UgKnBmZGV2LCBpbnQgc2xvdCwK
KwkJCQkgc3RydWN0IHBhbmZyb3N0X2pvYiAqam9iKQoreworCWlmIChwZmRldi0+am9ic1tzbG90
XVswXSA9PSBOVUxMKSB7CisJCXBmZGV2LT5qb2JzW3Nsb3RdWzBdID0gam9iOworCQlyZXR1cm47
CisJfQorCVdBUk5fT04ocGZkZXYtPmpvYnNbc2xvdF1bMV0gIT0gTlVMTCk7CisJcGZkZXYtPmpv
YnNbc2xvdF1bMV0gPSBqb2I7Cit9CisKIHN0YXRpYyB2b2lkIHBhbmZyb3N0X2pvYl9od19zdWJt
aXQoc3RydWN0IHBhbmZyb3N0X2pvYiAqam9iLCBpbnQganMpCiB7CiAJc3RydWN0IHBhbmZyb3N0
X2RldmljZSAqcGZkZXYgPSBqb2ItPnBmZGV2OwpAQCAtMTUwLDEzICsxODEsMTYgQEAgc3RhdGlj
IHZvaWQgcGFuZnJvc3Rfam9iX2h3X3N1Ym1pdChzdHJ1Y3QgcGFuZnJvc3Rfam9iICpqb2IsIGlu
dCBqcykKIAlpZiAocmV0IDwgMCkKIAkJcmV0dXJuOwogCi0JaWYgKFdBUk5fT04oam9iX3JlYWQo
cGZkZXYsIEpTX0NPTU1BTkRfTkVYVChqcykpKSkKLQkJZ290byBlbmQ7Ci0KIAljZmcgPSBwYW5m
cm9zdF9tbXVfYXNfZ2V0KHBmZGV2LCAmam9iLT5maWxlX3ByaXYtPm1tdSk7CiAKLQlwYW5mcm9z
dF9kZXZmcmVxX3JlY29yZF90cmFuc2l0aW9uKHBmZGV2LCBqcyk7CiAJc3Bpbl9sb2NrX2lycXNh
dmUoJnBmZGV2LT5od2FjY2Vzc19sb2NrLCBmbGFncyk7CisJcGFuZnJvc3RfZW5xdWV1ZV9qb2Io
cGZkZXYsIGpzLCBqb2IpOworCisJaWYgKFdBUk5fT04oam9iX3JlYWQocGZkZXYsIEpTX0NPTU1B
TkRfTkVYVChqcykpKSkKKwkJZ290byBlbmQ7CisKKwlpZiAocGFuZnJvc3Rfam9iX2NvdW50KHBm
ZGV2LCBqcykgPT0gMSkKKwkJcGFuZnJvc3RfZGV2ZnJlcV9yZWNvcmRfdHJhbnNpdGlvbihwZmRl
diwganMpOwogCiAJam9iX3dyaXRlKHBmZGV2LCBKU19IRUFEX05FWFRfTE8oanMpLCBqY19oZWFk
ICYgMHhGRkZGRkZGRik7CiAJam9iX3dyaXRlKHBmZGV2LCBKU19IRUFEX05FWFRfSEkoanMpLCBq
Y19oZWFkID4+IDMyKTsKQEAgLTE4Niw5ICsyMjAsOSBAQCBzdGF0aWMgdm9pZCBwYW5mcm9zdF9q
b2JfaHdfc3VibWl0KHN0cnVjdCBwYW5mcm9zdF9qb2IgKmpvYiwgaW50IGpzKQogCiAJam9iX3dy
aXRlKHBmZGV2LCBKU19DT01NQU5EX05FWFQoanMpLCBKU19DT01NQU5EX1NUQVJUKTsKIAorZW5k
OgogCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnBmZGV2LT5od2FjY2Vzc19sb2NrLCBmbGFncyk7
CiAKLWVuZDoKIAlwbV9ydW50aW1lX21hcmtfbGFzdF9idXN5KHBmZGV2LT5kZXYpOwogCXBtX3J1
bnRpbWVfcHV0X2F1dG9zdXNwZW5kKHBmZGV2LT5kZXYpOwogfQpAQCAtMzM2LDggKzM3MCw2IEBA
IHN0YXRpYyBzdHJ1Y3QgZG1hX2ZlbmNlICpwYW5mcm9zdF9qb2JfcnVuKHN0cnVjdCBkcm1fc2No
ZWRfam9iICpzY2hlZF9qb2IpCiAJaWYgKHVubGlrZWx5KGpvYi0+YmFzZS5zX2ZlbmNlLT5maW5p
c2hlZC5lcnJvcikpCiAJCXJldHVybiBOVUxMOwogCi0JcGZkZXYtPmpvYnNbc2xvdF0gPSBqb2I7
Ci0KIAlmZW5jZSA9IHBhbmZyb3N0X2ZlbmNlX2NyZWF0ZShwZmRldiwgc2xvdCk7CiAJaWYgKElT
X0VSUihmZW5jZSkpCiAJCXJldHVybiBOVUxMOwpAQCAtNDIxLDIxICs0NTMsMzYgQEAgc3RhdGlj
IGlycXJldHVybl90IHBhbmZyb3N0X2pvYl9pcnFfaGFuZGxlcihpbnQgaXJxLCB2b2lkICpkYXRh
KQogCXN0cnVjdCBwYW5mcm9zdF9kZXZpY2UgKnBmZGV2ID0gZGF0YTsKIAl1MzIgc3RhdHVzID0g
am9iX3JlYWQocGZkZXYsIEpPQl9JTlRfU1RBVCk7CiAJaW50IGo7CisJdW5zaWduZWQgbG9uZyBm
bGFnczsKIAogCWRldl9kYmcocGZkZXYtPmRldiwgImpvYnNsb3QgaXJxIHN0YXR1cz0leFxuIiwg
c3RhdHVzKTsKIAogCWlmICghc3RhdHVzKQogCQlyZXR1cm4gSVJRX05PTkU7CiAKKwlzcGluX2xv
Y2tfaXJxc2F2ZSgmcGZkZXYtPmh3YWNjZXNzX2xvY2ssIGZsYWdzKTsKKwogCXBtX3J1bnRpbWVf
bWFya19sYXN0X2J1c3kocGZkZXYtPmRldik7CiAKIAlmb3IgKGogPSAwOyBzdGF0dXM7IGorKykg
ewogCQl1MzIgbWFzayA9IE1LX0pTX01BU0soaik7CisJCWludCBqb2JzID0gcGFuZnJvc3Rfam9i
X2NvdW50KHBmZGV2LCBqKTsKKwkJaW50IGFjdGl2ZTsKIAogCQlpZiAoIShzdGF0dXMgJiBtYXNr
KSkKIAkJCWNvbnRpbnVlOwogCiAJCWpvYl93cml0ZShwZmRldiwgSk9CX0lOVF9DTEVBUiwgbWFz
ayk7CisJCWFjdGl2ZSA9IChqb2JfcmVhZChwZmRldiwgSk9CX0lOVF9KU19TVEFURSkgJgorCQkJ
ICBKT0JfSU5UX01BU0tfRE9ORShqKSkgPyAxIDogMDsKKworCQlpZiAoIShzdGF0dXMgJiBKT0Jf
SU5UX01BU0tfRVJSKGopKSkgeworCQkJLyogUmVjaGVjayBSQVdTVEFUIHRvIGNoZWNrIGlmIHRo
ZXJlJ3MgYSBuZXdseQorCQkJICogZmFpbGVkIGpvYiAoc2luY2UgSk9CX0lOVF9TVEFUIHdhcyBy
ZWFkKQorCQkJICovCisJCQlzdGF0dXMgfD0gam9iX3JlYWQocGZkZXYsIEpPQl9JTlRfUkFXU1RB
VCkgJgorCQkJCUpPQl9JTlRfTUFTS19FUlIoaik7CisJCX0KIAogCQlpZiAoc3RhdHVzICYgSk9C
X0lOVF9NQVNLX0VSUihqKSkgewogCQkJam9iX3dyaXRlKHBmZGV2LCBKU19DT01NQU5EX05FWFQo
aiksIEpTX0NPTU1BTkRfTk9QKTsKQEAgLTQ0NywyMCArNDk0LDI1IEBAIHN0YXRpYyBpcnFyZXR1
cm5fdCBwYW5mcm9zdF9qb2JfaXJxX2hhbmRsZXIoaW50IGlycSwgdm9pZCAqZGF0YSkKIAkJCQlq
b2JfcmVhZChwZmRldiwgSlNfVEFJTF9MTyhqKSkpOwogCiAJCQlkcm1fc2NoZWRfZmF1bHQoJnBm
ZGV2LT5qcy0+cXVldWVbal0uc2NoZWQpOworCQkJam9icyAtLTsKIAkJfQogCi0JCWlmIChzdGF0
dXMgJiBKT0JfSU5UX01BU0tfRE9ORShqKSkgewotCQkJc3RydWN0IHBhbmZyb3N0X2pvYiAqam9i
ID0gcGZkZXYtPmpvYnNbal07CisJCXdoaWxlIChqb2JzIC0tID4gYWN0aXZlKSB7CisJCQlzdHJ1
Y3QgcGFuZnJvc3Rfam9iICpqb2IgPQorCQkJCXBhbmZyb3N0X2RlcXVldWVfam9iKHBmZGV2LCBq
KTsKIAotCQkJcGZkZXYtPmpvYnNbal0gPSBOVUxMOwogCQkJcGFuZnJvc3RfbW11X2FzX3B1dChw
ZmRldiwgJmpvYi0+ZmlsZV9wcml2LT5tbXUpOwotCQkJcGFuZnJvc3RfZGV2ZnJlcV9yZWNvcmRf
dHJhbnNpdGlvbihwZmRldiwgaik7CiAJCQlkbWFfZmVuY2Vfc2lnbmFsKGpvYi0+ZG9uZV9mZW5j
ZSk7CiAJCX0KIAorCQlpZiAoIWFjdGl2ZSkKKwkJCXBhbmZyb3N0X2RldmZyZXFfcmVjb3JkX3Ry
YW5zaXRpb24ocGZkZXYsIGopOworCiAJCXN0YXR1cyAmPSB+bWFzazsKIAl9CiAKKwlzcGluX3Vu
bG9ja19pcnFyZXN0b3JlKCZwZmRldi0+aHdhY2Nlc3NfbG9jaywgZmxhZ3MpOworCiAJcmV0dXJu
IElSUV9IQU5ETEVEOwogfQogCkBAIC00OTEsNyArNTQzLDcgQEAgaW50IHBhbmZyb3N0X2pvYl9p
bml0KHN0cnVjdCBwYW5mcm9zdF9kZXZpY2UgKnBmZGV2KQogCiAJCXJldCA9IGRybV9zY2hlZF9p
bml0KCZqcy0+cXVldWVbal0uc2NoZWQsCiAJCQkJICAgICAmcGFuZnJvc3Rfc2NoZWRfb3BzLAot
CQkJCSAgICAgMSwgMCwgbXNlY3NfdG9famlmZmllcyg1MDApLAorCQkJCSAgICAgMiwgMCwgbXNl
Y3NfdG9famlmZmllcyg1MDApLAogCQkJCSAgICAgInBhbl9qcyIpOwogCQlpZiAocmV0KSB7CiAJ
CQlkZXZfZXJyKHBmZGV2LT5kZXYsICJGYWlsZWQgdG8gY3JlYXRlIHNjaGVkdWxlcjogJWQuIiwg
cmV0KTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9tbXUu
YyBiL2RyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9tbXUuYwppbmRleCBmMjJkOGYw
MjU2OGQuLmMyNWZkODhlZjQzNyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3BhbmZyb3N0
L3BhbmZyb3N0X21tdS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9t
bXUuYwpAQCAtMTQ3LDcgKzE0Nyw3IEBAIHUzMiBwYW5mcm9zdF9tbXVfYXNfZ2V0KHN0cnVjdCBw
YW5mcm9zdF9kZXZpY2UgKnBmZGV2LCBzdHJ1Y3QgcGFuZnJvc3RfbW11ICptbXUpCiAJYXMgPSBt
bXUtPmFzOwogCWlmIChhcyA+PSAwKSB7CiAJCWludCBlbiA9IGF0b21pY19pbmNfcmV0dXJuKCZt
bXUtPmFzX2NvdW50KTsKLQkJV0FSTl9PTihlbiA+PSBOVU1fSk9CX1NMT1RTKTsKKwkJV0FSTl9P
TihlbiA+PSBOVU1fSk9CX1NMT1RTKjIpOwogCiAJCWxpc3RfbW92ZSgmbW11LT5saXN0LCAmcGZk
ZXYtPmFzX2xydV9saXN0KTsKIAkJZ290byBvdXQ7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QK
ZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9w
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
