Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 2FA5516307
	for <lists+dri-devel@lfdr.de>; Tue,  7 May 2019 13:45:44 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 88C176E7B5;
	Tue,  7 May 2019 11:45:41 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from NAM05-BY2-obe.outbound.protection.outlook.com
 (mail-eopbgr710083.outbound.protection.outlook.com [40.107.71.83])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 14D6E6E7B5
 for <dri-devel@lists.freedesktop.org>; Tue,  7 May 2019 11:45:40 +0000 (UTC)
Received: from DM5PR12CA0024.namprd12.prod.outlook.com (10.172.32.162) by
 BN6PR12MB1140.namprd12.prod.outlook.com (10.168.225.142) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.1856.11; Tue, 7 May 2019 11:45:38 +0000
Received: from CO1NAM03FT005.eop-NAM03.prod.protection.outlook.com
 (2a01:111:f400:7e48::205) by DM5PR12CA0024.outlook.office365.com
 (2603:10b6:4:1::34) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id 15.20.1856.10 via Frontend
 Transport; Tue, 7 May 2019 11:45:37 +0000
Received-SPF: None (protection.outlook.com: amd.com does not designate
 permitted sender hosts)
Received: from SATLEXCHOV02.amd.com (165.204.84.17) by
 CO1NAM03FT005.mail.protection.outlook.com (10.152.80.156) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384) id
 15.20.1856.11 via Frontend Transport; Tue, 7 May 2019 11:45:37 +0000
Received: from zhoucm1.amd.com (10.34.1.3) by SATLEXCHOV02.amd.com
 (10.181.40.72) with Microsoft SMTP Server id 14.3.389.1; Tue, 7 May 2019
 06:45:35 -0500
From: Chunming Zhou <david1.zhou@amd.com>
To: <Christian.Koenig@amd.com>, <Prike.Liang@amd.com>,
 <dri-devel@lists.freedesktop.org>
Subject: [PATCH 1/2] drm/ttm: fix busy memory to fail other user v7
Date: Tue, 7 May 2019 19:45:30 +0800
Message-ID: <20190507114531.26089-1-david1.zhou@amd.com>
X-Mailer: git-send-email 2.17.1
MIME-Version: 1.0
X-EOPAttributedMessage: 0
X-MS-Office365-Filtering-HT: Tenant
X-Forefront-Antispam-Report: CIP:165.204.84.17; IPV:NLI; CTRY:US; EFV:NLI;
 SFV:NSPM;
 SFS:(10009020)(136003)(396003)(376002)(346002)(39860400002)(2980300002)(428003)(199004)(189003)(4326008)(356004)(77096007)(426003)(53936002)(48376002)(50466002)(51416003)(7696005)(16586007)(336012)(316002)(26005)(110136005)(2906002)(186003)(2201001)(53416004)(8676002)(86362001)(5660300002)(305945005)(81166006)(81156014)(36756003)(1076003)(68736007)(8936002)(6666004)(476003)(478600001)(70586007)(126002)(47776003)(70206006)(50226002)(14444005)(486006)(72206003)(2616005);
 DIR:OUT; SFP:1101; SCL:1; SRVR:BN6PR12MB1140; H:SATLEXCHOV02.amd.com; FPR:;
 SPF:None; LANG:en; PTR:InfoDomainNonexistent; A:1; MX:1; 
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 840ebedc-fe05-41e3-2a46-08d6d2e185ff
X-Microsoft-Antispam: BCL:0; PCL:0;
 RULEID:(2390118)(7020095)(4652040)(8989299)(4534185)(4627221)(201703031133081)(201702281549075)(8990200)(5600141)(711020)(4605104)(2017052603328);
 SRVR:BN6PR12MB1140; 
X-MS-TrafficTypeDiagnostic: BN6PR12MB1140:
X-Microsoft-Antispam-PRVS: <BN6PR12MB11401C95F5E47F26491E1E92B4310@BN6PR12MB1140.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:8882;
X-Forefront-PRVS: 0030839EEE
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam-Message-Info: RstO/N8kyBJKpuFFimIKWy2IMfTwcIAgqaquiPd4qUKrT9BTWluoRWsGopDF+lJk7vRdharkFeYlIPomciGm6aU3+7urLqkRKws6KpZ0uirYvF8LmfOfHBWr/qjHC3p9sBj4BWGsux+6sK0TI7Wb3EO/nNbNkMxJmH0MKbutV97gn0Nvs+ymjLePCmesrMJtBAeLWvlC0EVSSvE+bWevLMCrAYRSdWvsNxjSCtdD+2CyZ+GFgcCVkdz59VsbHvcxZ+QR8EWDE1346pOxyKZgvL1FiTybI9rYEXnLAEpBfxJI+tdkD4tZcqwnrij77TOU7F8XbxvasKBpZFt53C/6D8wy8r7yaslFaUJ+B8c26Hpfor1unrglaC4CiIzssvqRlFTL0s8vBNm15ZT9oaIv1W1QJ6tZYOSAI8oTMgKfftw=
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 07 May 2019 11:45:37.4858 (UTC)
X-MS-Exchange-CrossTenant-Network-Message-Id: 840ebedc-fe05-41e3-2a46-08d6d2e185ff
X-MS-Exchange-CrossTenant-Id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-CrossTenant-OriginalAttributedTenantConnectingIp: TenantId=3dd8961f-e488-4e60-8e11-a82d994e183d; Ip=[165.204.84.17];
 Helo=[SATLEXCHOV02.amd.com]
X-MS-Exchange-CrossTenant-FromEntityHeader: HybridOnPrem
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BN6PR12MB1140
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=amdcloud.onmicrosoft.com; s=selector1-amd-com;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=DNR7HYH4jj8+HtHULoseTe72bDZBlfBgH5F6lIMFzK8=;
 b=TVzWldwBUl9ycr2ZltnaEzE6Es77xNeB/zblZLIXz77fM2Aq4cAEq9VOyb8gXYYdYoVlZz/sg3Af3enKsUp6s2/7rRE3c/Xs3g4hLeeIbtNmurAEDXFXJ53mzyJ4IwlbQ0tAqicVSv/ihSFlmorPSQNrDD0CUU34Mu4OtXYMc7E=
X-Mailman-Original-Authentication-Results: spf=none (sender IP is
 165.204.84.17)
 smtp.mailfrom=amd.com; lists.freedesktop.org; dkim=none (message not signed)
 header.d=none;lists.freedesktop.org; dmarc=permerror action=none
 header.from=amd.com;
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

aGVhdnkgZ3B1IGpvYiBjb3VsZCBvY2N1cHkgbWVtb3J5IGxvbmcgdGltZSwgd2hpY2ggbGVhZCBv
dGhlciB1c2VyIGZhaWwgdG8gZ2V0IG1lbW9yeS4KCmJhc2ljYWxseSBwaWNrIHVwIENocmlzdGlh
biBpZGVhOgoKMS4gUmVzZXJ2ZSB0aGUgQk8gaW4gREMgdXNpbmcgYSB3d19tdXRleCB0aWNrZXQg
KHRyaXZpYWwpLgoyLiBJZiB3ZSB0aGVuIHJ1biBpbnRvIHRoaXMgRUJVU1kgY29uZGl0aW9uIGlu
IFRUTSBjaGVjayBpZiB0aGUgQk8gd2UgbmVlZCBtZW1vcnkgZm9yIChvciByYXRoZXIgdGhlIHd3
X211dGV4IG9mIGl0cyByZXNlcnZhdGlvbiBvYmplY3QpIGhhcyBhIHRpY2tldCBhc3NpZ25lZC4K
My4gSWYgd2UgaGF2ZSBhIHRpY2tldCB3ZSBncmFiIGEgcmVmZXJlbmNlIHRvIHRoZSBmaXJzdCBC
TyBvbiB0aGUgTFJVLCBkcm9wIHRoZSBMUlUgbG9jayBhbmQgdHJ5IHRvIGdyYWIgdGhlIHJlc2Vy
dmF0aW9uIGxvY2sgd2l0aCB0aGUgdGlja2V0Lgo0LiBJZiBnZXR0aW5nIHRoZSByZXNlcnZhdGlv
biBsb2NrIHdpdGggdGhlIHRpY2tldCBzdWNjZWVkZWQgd2UgY2hlY2sgaWYgdGhlIEJPIGlzIHN0
aWxsIHRoZSBmaXJzdCBvbmUgb24gdGhlIExSVSBpbiBxdWVzdGlvbiAodGhlIEJPIGNvdWxkIGhh
dmUgbW92ZWQpLgo1LiBJZiB0aGUgQk8gaXMgc3RpbGwgdGhlIGZpcnN0IG9uZSBvbiB0aGUgTFJV
IGluIHF1ZXN0aW9uIHdlIHRyeSB0byBldmljdCBpdCBhcyB3ZSB3b3VsZCBldmljdCBhbnkgb3Ro
ZXIgQk8uCjYuIElmIGFueSBvZiB0aGUgIklmJ3MiIGFib3ZlIGZhaWwgd2UganVzdCBiYWNrIG9m
ZiBhbmQgcmV0dXJuIC1FQlVTWS4KCnYyOiBmaXggc29tZSBtaW5vciBjaGVjawp2MzogYWRkcmVz
cyBDaHJpc3RpYW4gdjIgY29tbWVudHMuCnY0OiBmaXggc29tZSBtaXNzaW5nCnY1OiBoYW5kbGUg
Zmlyc3RfYm8gdW5sb2NrIGFuZCBib19nZXQvcHV0CnY2OiBhYnN0cmFjdCB1bmlmaWVkIGl0ZXJh
dGUgZnVuY3Rpb24sIGFuZCBoYW5kbGUgYWxsIHBvc3NpYmxlIHVzZWNhc2Ugbm90IG9ubHkgcGlu
bmVkIGJvLgp2NzogcGFzcyByZXF1ZXN0IGJvLT5yZXN2IHRvIHR0bV9ib19ldmljdF9maXJzdAoK
Q2hhbmdlLUlkOiBJMjE0MjNmYjkyMmY4ODU0NjVmMTM4MzNjNDFkZjFlMTM0MzY0YThlNwpTaWdu
ZWQtb2ZmLWJ5OiBDaHVubWluZyBaaG91IDxkYXZpZDEuemhvdUBhbWQuY29tPgotLS0KIGRyaXZl
cnMvZ3B1L2RybS90dG0vdHRtX2JvLmMgfCAxMTEgKysrKysrKysrKysrKysrKysrKysrKysrKysr
KystLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA5NCBpbnNlcnRpb25zKCspLCAxNyBkZWxldGlvbnMo
LSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9iby5jIGIvZHJpdmVycy9n
cHUvZHJtL3R0bS90dG1fYm8uYwppbmRleCA4NTAyYjNlZDJkODguLmY1ZTYzMjhlNGE1NyAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8uYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vdHRtL3R0bV9iby5jCkBAIC03NjYsMTEgKzc2NiwxMyBAQCBFWFBPUlRfU1lNQk9MKHR0bV9i
b19ldmljdGlvbl92YWx1YWJsZSk7CiAgKiBiLiBPdGhlcndpc2UsIHRyeWxvY2sgaXQuCiAgKi8K
IHN0YXRpYyBib29sIHR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZShzdHJ1Y3QgdHRtX2J1
ZmZlcl9vYmplY3QgKmJvLAotCQkJc3RydWN0IHR0bV9vcGVyYXRpb25fY3R4ICpjdHgsIGJvb2wg
KmxvY2tlZCkKKwkJCXN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4LCBib29sICpsb2NrZWQs
IGJvb2wgKmJ1c3kpCiB7CiAJYm9vbCByZXQgPSBmYWxzZTsKIAogCSpsb2NrZWQgPSBmYWxzZTsK
KwlpZiAoYnVzeSkKKwkJKmJ1c3kgPSBmYWxzZTsKIAlpZiAoYm8tPnJlc3YgPT0gY3R4LT5yZXN2
KSB7CiAJCXJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChiby0+cmVzdik7CiAJCWlmIChj
dHgtPmZsYWdzICYgVFRNX09QVF9GTEFHX0FMTE9XX1JFU19FVklDVApAQCAtNzc5LDM1ICs3ODEs
NDYgQEAgc3RhdGljIGJvb2wgdHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dhYmxlKHN0cnVjdCB0
dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJfSBlbHNlIHsKIAkJKmxvY2tlZCA9IHJlc2VydmF0aW9u
X29iamVjdF90cnlsb2NrKGJvLT5yZXN2KTsKIAkJcmV0ID0gKmxvY2tlZDsKKwkJaWYgKCFyZXQg
JiYgYnVzeSkKKwkJCSpidXN5ID0gdHJ1ZTsKIAl9CiAKIAlyZXR1cm4gcmV0OwogfQogCi1zdGF0
aWMgaW50IHR0bV9tZW1fZXZpY3RfZmlyc3Qoc3RydWN0IHR0bV9ib19kZXZpY2UgKmJkZXYsCi0J
CQkgICAgICAgdWludDMyX3QgbWVtX3R5cGUsCi0JCQkgICAgICAgY29uc3Qgc3RydWN0IHR0bV9w
bGFjZSAqcGxhY2UsCi0JCQkgICAgICAgc3RydWN0IHR0bV9vcGVyYXRpb25fY3R4ICpjdHgpCitz
dGF0aWMgc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0KgordHRtX21lbV9maW5kX2V2aXRhYmxlX2Jv
KHN0cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAorCQkJIHN0cnVjdCB0dG1fbWVtX3R5cGVfbWFu
YWdlciAqbWFuLAorCQkJIGNvbnN0IHN0cnVjdCB0dG1fcGxhY2UgKnBsYWNlLAorCQkJIHN0cnVj
dCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4LAorCQkJIHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAq
KmZpcnN0X2JvLAorCQkJIGJvb2wgKmxvY2tlZCkKIHsKLQlzdHJ1Y3QgdHRtX2JvX2dsb2JhbCAq
Z2xvYiA9IGJkZXYtPmdsb2I7Ci0Jc3RydWN0IHR0bV9tZW1fdHlwZV9tYW5hZ2VyICptYW4gPSAm
YmRldi0+bWFuW21lbV90eXBlXTsKIAlzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvID0gTlVM
TDsKLQlib29sIGxvY2tlZCA9IGZhbHNlOwotCXVuc2lnbmVkIGk7Ci0JaW50IHJldDsKKwlpbnQg
aTsKIAotCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xvY2spOworCWlmIChmaXJzdF9ibykKKwkJKmZp
cnN0X2JvID0gTlVMTDsKIAlmb3IgKGkgPSAwOyBpIDwgVFRNX01BWF9CT19QUklPUklUWTsgKytp
KSB7CiAJCWxpc3RfZm9yX2VhY2hfZW50cnkoYm8sICZtYW4tPmxydVtpXSwgbHJ1KSB7Ci0JCQlp
ZiAoIXR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZShibywgY3R4LCAmbG9ja2VkKSkKKwkJ
CWJvb2wgYnVzeSA9IGZhbHNlOworCisJCQlpZiAoIXR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93
YWJsZShibywgY3R4LCBsb2NrZWQsCisJCQkJCQkJICAgICZidXN5KSkgeworCQkJCWlmIChmaXJz
dF9ibyAmJiAhKCpmaXJzdF9ibykgJiYgYnVzeSkgeworCQkJCQl0dG1fYm9fZ2V0KGJvKTsKKwkJ
CQkJKmZpcnN0X2JvID0gYm87CisJCQkJfQogCQkJCWNvbnRpbnVlOworCQkJfQogCiAJCQlpZiAo
cGxhY2UgJiYgIWJkZXYtPmRyaXZlci0+ZXZpY3Rpb25fdmFsdWFibGUoYm8sCiAJCQkJCQkJCSAg
ICAgIHBsYWNlKSkgewotCQkJCWlmIChsb2NrZWQpCisJCQkJaWYgKCpsb2NrZWQpCiAJCQkJCXJl
c2VydmF0aW9uX29iamVjdF91bmxvY2soYm8tPnJlc3YpOwogCQkJCWNvbnRpbnVlOwogCQkJfQor
CiAJCQlicmVhazsKIAkJfQogCkBAIC04MTgsOSArODMxLDY3IEBAIHN0YXRpYyBpbnQgdHRtX21l
bV9ldmljdF9maXJzdChzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiwKIAkJYm8gPSBOVUxMOwog
CX0KIAorCXJldHVybiBibzsKK30KKworc3RhdGljIGludCB0dG1fbWVtX2V2aWN0X2ZpcnN0KHN0
cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAorCQkJICAgICAgIHVpbnQzMl90IG1lbV90eXBlLAor
CQkJICAgICAgIGNvbnN0IHN0cnVjdCB0dG1fcGxhY2UgKnBsYWNlLAorCQkJICAgICAgIHN0cnVj
dCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4LAorCQkJICAgICAgIHN0cnVjdCByZXNlcnZhdGlvbl9v
YmplY3QgKnJlcXVlc3RfcmVzdikKK3sKKwlzdHJ1Y3QgdHRtX2JvX2dsb2JhbCAqZ2xvYiA9IGJk
ZXYtPmdsb2I7CisJc3RydWN0IHR0bV9tZW1fdHlwZV9tYW5hZ2VyICptYW4gPSAmYmRldi0+bWFu
W21lbV90eXBlXTsKKwlzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvID0gTlVMTCwgKmZpcnN0
X2JvID0gTlVMTDsKKwlib29sIGxvY2tlZCA9IGZhbHNlOworCWludCByZXQ7CisKKwlzcGluX2xv
Y2soJmdsb2ItPmxydV9sb2NrKTsKKwlibyA9IHR0bV9tZW1fZmluZF9ldml0YWJsZV9ibyhiZGV2
LCBtYW4sIHBsYWNlLCBjdHgsICZmaXJzdF9ibywKKwkJCQkgICAgICAmbG9ja2VkKTsKIAlpZiAo
IWJvKSB7CisJCXN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCBidXN5X2N0eDsKKwogCQlzcGluX3Vu
bG9jaygmZ2xvYi0+bHJ1X2xvY2spOwotCQlyZXR1cm4gLUVCVVNZOworCQkvKiBjaGVjayBpZiBv
dGhlciB1c2VyIG9jY3VweSBtZW1vcnkgdG9vIGxvbmcgdGltZSAqLworCQlpZiAoIWZpcnN0X2Jv
IHx8ICFyZXF1ZXN0X3Jlc3YgfHwgIXJlcXVlc3RfcmVzdi0+bG9jay5jdHgpIHsKKwkJCWlmIChm
aXJzdF9ibykKKwkJCQl0dG1fYm9fcHV0KGZpcnN0X2JvKTsKKwkJCXJldHVybiAtRUJVU1k7CisJ
CX0KKwkJaWYgKGZpcnN0X2JvLT5yZXN2ID09IHJlcXVlc3RfcmVzdikgeworCQkJdHRtX2JvX3B1
dChmaXJzdF9ibyk7CisJCQlyZXR1cm4gLUVCVVNZOworCQl9CisJCWlmIChjdHgtPmludGVycnVw
dGlibGUpCisJCQlyZXQgPSB3d19tdXRleF9sb2NrX2ludGVycnVwdGlibGUoJmZpcnN0X2JvLT5y
ZXN2LT5sb2NrLAorCQkJCQkJCSAgcmVxdWVzdF9yZXN2LT5sb2NrLmN0eCk7CisJCWVsc2UKKwkJ
CXJldCA9IHd3X211dGV4X2xvY2soJmZpcnN0X2JvLT5yZXN2LT5sb2NrLCByZXF1ZXN0X3Jlc3Yt
PmxvY2suY3R4KTsKKwkJaWYgKHJldCkgeworCQkJdHRtX2JvX3B1dChmaXJzdF9ibyk7CisJCQly
ZXR1cm4gcmV0OworCQl9CisJCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xvY2spOworCQkvKiBwcmV2
aW91cyBidXN5IHJlc3YgbG9jayBpcyBoZWxkIGJ5IGFib3ZlLCBpZGxlIG5vdywKKwkJICogc28g
bGV0IHRoZW0gZXZpY3RhYmxlLgorCQkgKi8KKwkJYnVzeV9jdHguaW50ZXJydXB0aWJsZSA9IGN0
eC0+aW50ZXJydXB0aWJsZTsKKwkJYnVzeV9jdHgubm9fd2FpdF9ncHUgICA9IGN0eC0+bm9fd2Fp
dF9ncHU7CisJCWJ1c3lfY3R4LnJlc3YJICAgICAgID0gZmlyc3RfYm8tPnJlc3Y7CisJCWJ1c3lf
Y3R4LmZsYWdzCSAgICAgICA9IFRUTV9PUFRfRkxBR19BTExPV19SRVNfRVZJQ1Q7CisKKwkJYm8g
PSB0dG1fbWVtX2ZpbmRfZXZpdGFibGVfYm8oYmRldiwgbWFuLCBwbGFjZSwgJmJ1c3lfY3R4LCBO
VUxMLAorCQkJCQkgICAgICAmbG9ja2VkKTsKKwkJaWYgKGJvICYmIChiby0+cmVzdiA9PSBmaXJz
dF9iby0+cmVzdikpCisJCQlsb2NrZWQgPSB0cnVlOworCQllbHNlIGlmIChibykKKwkJCXd3X211
dGV4X3VubG9jaygmZmlyc3RfYm8tPnJlc3YtPmxvY2spOworCQlpZiAoIWJvKSB7CisJCQlzcGlu
X3VubG9jaygmZ2xvYi0+bHJ1X2xvY2spOworCQkJdHRtX2JvX3B1dChmaXJzdF9ibyk7CisJCQly
ZXR1cm4gLUVCVVNZOworCQl9CiAJfQogCiAJa3JlZl9nZXQoJmJvLT5saXN0X2tyZWYpOwpAQCAt
ODI5LDExICs5MDAsMTUgQEAgc3RhdGljIGludCB0dG1fbWVtX2V2aWN0X2ZpcnN0KHN0cnVjdCB0
dG1fYm9fZGV2aWNlICpiZGV2LAogCQlyZXQgPSB0dG1fYm9fY2xlYW51cF9yZWZzKGJvLCBjdHgt
PmludGVycnVwdGlibGUsCiAJCQkJCSAgY3R4LT5ub193YWl0X2dwdSwgbG9ja2VkKTsKIAkJa3Jl
Zl9wdXQoJmJvLT5saXN0X2tyZWYsIHR0bV9ib19yZWxlYXNlX2xpc3QpOworCQlpZiAoZmlyc3Rf
Ym8pCisJCQl0dG1fYm9fcHV0KGZpcnN0X2JvKTsKIAkJcmV0dXJuIHJldDsKIAl9CiAKIAl0dG1f
Ym9fZGVsX2Zyb21fbHJ1KGJvKTsKIAlzcGluX3VubG9jaygmZ2xvYi0+bHJ1X2xvY2spOworCWlm
IChmaXJzdF9ibykKKwkJdHRtX2JvX3B1dChmaXJzdF9ibyk7CiAKIAlyZXQgPSB0dG1fYm9fZXZp
Y3QoYm8sIGN0eCk7CiAJaWYgKGxvY2tlZCkgewpAQCAtOTA3LDcgKzk4Miw3IEBAIHN0YXRpYyBp
bnQgdHRtX2JvX21lbV9mb3JjZV9zcGFjZShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAog
CQkJcmV0dXJuIHJldDsKIAkJaWYgKG1lbS0+bW1fbm9kZSkKIAkJCWJyZWFrOwotCQlyZXQgPSB0
dG1fbWVtX2V2aWN0X2ZpcnN0KGJkZXYsIG1lbV90eXBlLCBwbGFjZSwgY3R4KTsKKwkJcmV0ID0g
dHRtX21lbV9ldmljdF9maXJzdChiZGV2LCBtZW1fdHlwZSwgcGxhY2UsIGN0eCwgYm8tPnJlc3Yp
OwogCQlpZiAodW5saWtlbHkocmV0ICE9IDApKQogCQkJcmV0dXJuIHJldDsKIAl9IHdoaWxlICgx
KTsKQEAgLTE0MTMsNyArMTQ4OCw4IEBAIHN0YXRpYyBpbnQgdHRtX2JvX2ZvcmNlX2xpc3RfY2xl
YW4oc3RydWN0IHR0bV9ib19kZXZpY2UgKmJkZXYsCiAJZm9yIChpID0gMDsgaSA8IFRUTV9NQVhf
Qk9fUFJJT1JJVFk7ICsraSkgewogCQl3aGlsZSAoIWxpc3RfZW1wdHkoJm1hbi0+bHJ1W2ldKSkg
ewogCQkJc3Bpbl91bmxvY2soJmdsb2ItPmxydV9sb2NrKTsKLQkJCXJldCA9IHR0bV9tZW1fZXZp
Y3RfZmlyc3QoYmRldiwgbWVtX3R5cGUsIE5VTEwsICZjdHgpOworCQkJcmV0ID0gdHRtX21lbV9l
dmljdF9maXJzdChiZGV2LCBtZW1fdHlwZSwgTlVMTCwgJmN0eCwKKwkJCQkJCSAgTlVMTCk7CiAJ
CQlpZiAocmV0KQogCQkJCXJldHVybiByZXQ7CiAJCQlzcGluX2xvY2soJmdsb2ItPmxydV9sb2Nr
KTsKQEAgLTE3ODQsNyArMTg2MCw4IEBAIGludCB0dG1fYm9fc3dhcG91dChzdHJ1Y3QgdHRtX2Jv
X2dsb2JhbCAqZ2xvYiwgc3RydWN0IHR0bV9vcGVyYXRpb25fY3R4ICpjdHgpCiAJc3Bpbl9sb2Nr
KCZnbG9iLT5scnVfbG9jayk7CiAJZm9yIChpID0gMDsgaSA8IFRUTV9NQVhfQk9fUFJJT1JJVFk7
ICsraSkgewogCQlsaXN0X2Zvcl9lYWNoX2VudHJ5KGJvLCAmZ2xvYi0+c3dhcF9scnVbaV0sIHN3
YXApIHsKLQkJCWlmICh0dG1fYm9fZXZpY3Rfc3dhcG91dF9hbGxvd2FibGUoYm8sIGN0eCwgJmxv
Y2tlZCkpIHsKKwkJCWlmICh0dG1fYm9fZXZpY3Rfc3dhcG91dF9hbGxvd2FibGUoYm8sIGN0eCwg
JmxvY2tlZCwKKwkJCQkJCQkgICBOVUxMKSkgewogCQkJCXJldCA9IDA7CiAJCQkJYnJlYWs7CiAJ
CQl9Ci0tIAoyLjE3LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9w
Lm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1k
ZXZlbA==
