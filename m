Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B50B8C9F5B
	for <lists+dri-devel@lfdr.de>; Thu,  3 Oct 2019 15:24:32 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3BD0F6E9CE;
	Thu,  3 Oct 2019 13:24:30 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4E2F26E9CE;
 Thu,  3 Oct 2019 13:24:28 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18707603-1500050 
 for multiple; Thu, 03 Oct 2019 14:24:24 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: intel-gfx@lists.freedesktop.org
Subject: [PATCH v3] dma-fence: Serialise signal enabling
 (dma_fence_enable_sw_signaling)
Date: Thu,  3 Oct 2019 14:24:22 +0100
Message-Id: <20191003132422.32730-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191003093639.10186-2-chris@chris-wilson.co.uk>
References: <20191003093639.10186-2-chris@chris-wilson.co.uk>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

TWFrZSBkbWFfZmVuY2VfZW5hYmxlX3N3X3NpZ25hbGluZygpIGJlaGF2ZSBsaWtlIGl0cwpkbWFf
ZmVuY2VfYWRkX2NhbGxiYWNrKCkgYW5kIGRtYV9mZW5jZV9kZWZhdWx0X3dhaXQoKSBjb3VudGVy
cGFydHMgYW5kCnBlcmZvcm0gdGhlIHRlc3QgdG8gZW5hYmxlIHNpZ25hbGluZyB1bmRlciB0aGUg
ZmVuY2UtPmxvY2ssIGFsb25nIHdpdGgKdGhlIGFjdGlvbiB0byBkbyBzby4gVGhpcyBlbnN1cmUg
dGhhdCBzaG91bGQgYW4gaW1wbGVtZW50YXRpb24gYmUgdHJ5aW5nCnRvIGZsdXNoIHRoZSBjYl9s
aXN0IChieSBzaWduYWxpbmcpIG9uIHJldGlyZW1lbnQgYmVmb3JlIGZyZWVpbmcgdGhlCmZlbmNl
LCBpdCBjYW4gZG8gc28gaW4gYSByYWNlLWZyZWUgbWFubmVyLgoKU2VlIGFsc28gMGZjODliNjgw
MmJhICgiZG1hLWZlbmNlOiBTaW1wbHkgd3JhcCBkbWFfZmVuY2Vfc2lnbmFsX2xvY2tlZAp3aXRo
IGRtYV9mZW5jZV9zaWduYWwiKS4KCnYyOiBSZWZhY3RvciBhbGwgMyBlbmFibGVfc2lnbmFsaW5n
IHBhdGhzIHRvIHVzZSBhIGNvbW1vbiBmdW5jdGlvbi4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdp
bHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgotLS0KUmV0dXJuIGZhbHNlIGZvciAiY291
bGQgbm90IF9lbmFibGVfIHNpZ25hbGluZyBhcyBpdCB3YXMgYWxyZWFkeQpzaWduYWxlZCIKLS0t
CiBkcml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLmMgfCA3OCArKysrKysrKysrKysrKysrKy0tLS0t
LS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMzUgaW5zZXJ0aW9ucygrKSwgNDMgZGVs
ZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL2RtYS1mZW5jZS5jIGIvZHJp
dmVycy9kbWEtYnVmL2RtYS1mZW5jZS5jCmluZGV4IDJjMTM2YWVlM2U3OS4uYjU4NTI4YzFjYzlk
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2RtYS1idWYvZG1hLWZlbmNlLmMKKysrIGIvZHJpdmVycy9k
bWEtYnVmL2RtYS1mZW5jZS5jCkBAIC0yNzMsNiArMjczLDMwIEBAIHZvaWQgZG1hX2ZlbmNlX2Zy
ZWUoc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UpCiB9CiBFWFBPUlRfU1lNQk9MKGRtYV9mZW5jZV9m
cmVlKTsKIAorc3RhdGljIGJvb2wgX19kbWFfZmVuY2VfZW5hYmxlX3NpZ25hbGluZyhzdHJ1Y3Qg
ZG1hX2ZlbmNlICpmZW5jZSkKK3sKKwlib29sIHdhc19zZXQ7CisKKwlsb2NrZGVwX2Fzc2VydF9o
ZWxkKGZlbmNlLT5sb2NrKTsKKworCXdhc19zZXQgPSB0ZXN0X2FuZF9zZXRfYml0KERNQV9GRU5D
RV9GTEFHX0VOQUJMRV9TSUdOQUxfQklULAorCQkJCSAgICZmZW5jZS0+ZmxhZ3MpOworCisJaWYg
KHRlc3RfYml0KERNQV9GRU5DRV9GTEFHX1NJR05BTEVEX0JJVCwgJmZlbmNlLT5mbGFncykpCisJ
CXJldHVybiBmYWxzZTsKKworCWlmICghd2FzX3NldCAmJiBmZW5jZS0+b3BzLT5lbmFibGVfc2ln
bmFsaW5nKSB7CisJCWlmICghZmVuY2UtPm9wcy0+ZW5hYmxlX3NpZ25hbGluZyhmZW5jZSkpIHsK
KwkJCWRtYV9mZW5jZV9zaWduYWxfbG9ja2VkKGZlbmNlKTsKKwkJCXJldHVybiBmYWxzZTsKKwkJ
fQorCisJCXRyYWNlX2RtYV9mZW5jZV9lbmFibGVfc2lnbmFsKGZlbmNlKTsKKwl9CisKKwlyZXR1
cm4gdHJ1ZTsKK30KKwogLyoqCiAgKiBkbWFfZmVuY2VfZW5hYmxlX3N3X3NpZ25hbGluZyAtIGVu
YWJsZSBzaWduYWxpbmcgb24gZmVuY2UKICAqIEBmZW5jZTogdGhlIGZlbmNlIHRvIGVuYWJsZQpA
QCAtMjg1LDE5ICszMDksMTIgQEAgdm9pZCBkbWFfZmVuY2VfZW5hYmxlX3N3X3NpZ25hbGluZyhz
dHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSkKIHsKIAl1bnNpZ25lZCBsb25nIGZsYWdzOwogCi0JaWYg
KCF0ZXN0X2FuZF9zZXRfYml0KERNQV9GRU5DRV9GTEFHX0VOQUJMRV9TSUdOQUxfQklULAotCQkJ
ICAgICAgJmZlbmNlLT5mbGFncykgJiYKLQkgICAgIXRlc3RfYml0KERNQV9GRU5DRV9GTEFHX1NJ
R05BTEVEX0JJVCwgJmZlbmNlLT5mbGFncykgJiYKLQkgICAgZmVuY2UtPm9wcy0+ZW5hYmxlX3Np
Z25hbGluZykgewotCQl0cmFjZV9kbWFfZmVuY2VfZW5hYmxlX3NpZ25hbChmZW5jZSk7Ci0KLQkJ
c3Bpbl9sb2NrX2lycXNhdmUoZmVuY2UtPmxvY2ssIGZsYWdzKTsKLQotCQlpZiAoIWZlbmNlLT5v
cHMtPmVuYWJsZV9zaWduYWxpbmcoZmVuY2UpKQotCQkJZG1hX2ZlbmNlX3NpZ25hbF9sb2NrZWQo
ZmVuY2UpOworCWlmICh0ZXN0X2JpdChETUFfRkVOQ0VfRkxBR19TSUdOQUxFRF9CSVQsICZmZW5j
ZS0+ZmxhZ3MpKQorCQlyZXR1cm47CiAKLQkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZShmZW5jZS0+
bG9jaywgZmxhZ3MpOwotCX0KKwlzcGluX2xvY2tfaXJxc2F2ZShmZW5jZS0+bG9jaywgZmxhZ3Mp
OworCV9fZG1hX2ZlbmNlX2VuYWJsZV9zaWduYWxpbmcoZmVuY2UpOworCXNwaW5fdW5sb2NrX2ly
cXJlc3RvcmUoZmVuY2UtPmxvY2ssIGZsYWdzKTsKIH0KIEVYUE9SVF9TWU1CT0woZG1hX2ZlbmNl
X2VuYWJsZV9zd19zaWduYWxpbmcpOwogCkBAIC0zMzEsNyArMzQ4LDYgQEAgaW50IGRtYV9mZW5j
ZV9hZGRfY2FsbGJhY2soc3RydWN0IGRtYV9mZW5jZSAqZmVuY2UsIHN0cnVjdCBkbWFfZmVuY2Vf
Y2IgKmNiLAogewogCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CiAJaW50IHJldCA9IDA7Ci0JYm9vbCB3
YXNfc2V0OwogCiAJaWYgKFdBUk5fT04oIWZlbmNlIHx8ICFmdW5jKSkKIAkJcmV0dXJuIC1FSU5W
QUw7CkBAIC0zNDMsMjUgKzM1OSwxNCBAQCBpbnQgZG1hX2ZlbmNlX2FkZF9jYWxsYmFjayhzdHJ1
Y3QgZG1hX2ZlbmNlICpmZW5jZSwgc3RydWN0IGRtYV9mZW5jZV9jYiAqY2IsCiAKIAlzcGluX2xv
Y2tfaXJxc2F2ZShmZW5jZS0+bG9jaywgZmxhZ3MpOwogCi0Jd2FzX3NldCA9IHRlc3RfYW5kX3Nl
dF9iaXQoRE1BX0ZFTkNFX0ZMQUdfRU5BQkxFX1NJR05BTF9CSVQsCi0JCQkJICAgJmZlbmNlLT5m
bGFncyk7Ci0KLQlpZiAodGVzdF9iaXQoRE1BX0ZFTkNFX0ZMQUdfU0lHTkFMRURfQklULCAmZmVu
Y2UtPmZsYWdzKSkKLQkJcmV0ID0gLUVOT0VOVDsKLQllbHNlIGlmICghd2FzX3NldCAmJiBmZW5j
ZS0+b3BzLT5lbmFibGVfc2lnbmFsaW5nKSB7Ci0JCXRyYWNlX2RtYV9mZW5jZV9lbmFibGVfc2ln
bmFsKGZlbmNlKTsKLQotCQlpZiAoIWZlbmNlLT5vcHMtPmVuYWJsZV9zaWduYWxpbmcoZmVuY2Up
KSB7Ci0JCQlkbWFfZmVuY2Vfc2lnbmFsX2xvY2tlZChmZW5jZSk7Ci0JCQlyZXQgPSAtRU5PRU5U
OwotCQl9Ci0JfQotCi0JaWYgKCFyZXQpIHsKKwlpZiAoX19kbWFfZmVuY2VfZW5hYmxlX3NpZ25h
bGluZyhmZW5jZSkpIHsKIAkJY2ItPmZ1bmMgPSBmdW5jOwogCQlsaXN0X2FkZF90YWlsKCZjYi0+
bm9kZSwgJmZlbmNlLT5jYl9saXN0KTsKLQl9IGVsc2UKKwl9IGVsc2UgewogCQlJTklUX0xJU1Rf
SEVBRCgmY2ItPm5vZGUpOworCQlyZXQgPSAtRU5PRU5UOworCX0KKwogCXNwaW5fdW5sb2NrX2ly
cXJlc3RvcmUoZmVuY2UtPmxvY2ssIGZsYWdzKTsKIAogCXJldHVybiByZXQ7CkBAIC00NjEsNyAr
NDY2LDYgQEAgZG1hX2ZlbmNlX2RlZmF1bHRfd2FpdChzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZSwg
Ym9vbCBpbnRyLCBzaWduZWQgbG9uZyB0aW1lb3V0KQogCXN0cnVjdCBkZWZhdWx0X3dhaXRfY2Ig
Y2I7CiAJdW5zaWduZWQgbG9uZyBmbGFnczsKIAlzaWduZWQgbG9uZyByZXQgPSB0aW1lb3V0ID8g
dGltZW91dCA6IDE7Ci0JYm9vbCB3YXNfc2V0OwogCiAJaWYgKHRlc3RfYml0KERNQV9GRU5DRV9G
TEFHX1NJR05BTEVEX0JJVCwgJmZlbmNlLT5mbGFncykpCiAJCXJldHVybiByZXQ7CkBAIC00NzMs
MjEgKzQ3Nyw5IEBAIGRtYV9mZW5jZV9kZWZhdWx0X3dhaXQoc3RydWN0IGRtYV9mZW5jZSAqZmVu
Y2UsIGJvb2wgaW50ciwgc2lnbmVkIGxvbmcgdGltZW91dCkKIAkJZ290byBvdXQ7CiAJfQogCi0J
d2FzX3NldCA9IHRlc3RfYW5kX3NldF9iaXQoRE1BX0ZFTkNFX0ZMQUdfRU5BQkxFX1NJR05BTF9C
SVQsCi0JCQkJICAgJmZlbmNlLT5mbGFncyk7Ci0KLQlpZiAodGVzdF9iaXQoRE1BX0ZFTkNFX0ZM
QUdfU0lHTkFMRURfQklULCAmZmVuY2UtPmZsYWdzKSkKKwlpZiAoIV9fZG1hX2ZlbmNlX2VuYWJs
ZV9zaWduYWxpbmcoZmVuY2UpKQogCQlnb3RvIG91dDsKIAotCWlmICghd2FzX3NldCAmJiBmZW5j
ZS0+b3BzLT5lbmFibGVfc2lnbmFsaW5nKSB7Ci0JCXRyYWNlX2RtYV9mZW5jZV9lbmFibGVfc2ln
bmFsKGZlbmNlKTsKLQotCQlpZiAoIWZlbmNlLT5vcHMtPmVuYWJsZV9zaWduYWxpbmcoZmVuY2Up
KSB7Ci0JCQlkbWFfZmVuY2Vfc2lnbmFsX2xvY2tlZChmZW5jZSk7Ci0JCQlnb3RvIG91dDsKLQkJ
fQotCX0KLQogCWlmICghdGltZW91dCkgewogCQlyZXQgPSAwOwogCQlnb3RvIG91dDsKLS0gCjIu
MjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJp
LWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBz
Oi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
