Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 12B62920D5
	for <lists+dri-devel@lfdr.de>; Mon, 19 Aug 2019 11:59:39 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 822356E0E9;
	Mon, 19 Aug 2019 09:59:36 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3EF516E0E9;
 Mon, 19 Aug 2019 09:59:35 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18186723-1500050 
 for multiple; Mon, 19 Aug 2019 10:59:29 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH 2/3] dma-buf: Add selftests for dma-fence
Date: Mon, 19 Aug 2019 10:59:27 +0100
Message-Id: <20190819095928.32091-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190819095928.32091-1-chris@chris-wilson.co.uk>
References: <20190819095928.32091-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>, intel-gfx@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RXhlcmNpc2UgdGhlIGRtYS1mZW5jZSBBUEkgZXhwb3J0ZWQgdG8gZHJpdmVycy4KClNpZ25lZC1v
ZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogRGFuaWVs
IFZldHRlciA8ZGFuaWVsLnZldHRlckBmZndsbC5jaD4KLS0tCiBkcml2ZXJzL2RtYS1idWYvTWFr
ZWZpbGUgICAgICAgfCAgIDUgKy0KIGRyaXZlcnMvZG1hLWJ1Zi9zZWxmdGVzdHMuaCAgICB8ICAg
MSArCiBkcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLmMgfCA1NzEgKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDU3NiBpbnNlcnRpb25zKCspLCAx
IGRlbGV0aW9uKC0pCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy9kbWEtYnVmL3N0LWRtYS1m
ZW5jZS5jCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlIGIvZHJpdmVycy9k
bWEtYnVmL01ha2VmaWxlCmluZGV4IGI1YWUxMjJhOTM0OS4uMDM0NzlkYTA2NDIyIDEwMDY0NAot
LS0gYS9kcml2ZXJzL2RtYS1idWYvTWFrZWZpbGUKKysrIGIvZHJpdmVycy9kbWEtYnVmL01ha2Vm
aWxlCkBAIC01LDUgKzUsOCBAQCBvYmotJChDT05GSUdfU1lOQ19GSUxFKQkJKz0gc3luY19maWxl
Lm8KIG9iai0kKENPTkZJR19TV19TWU5DKQkJKz0gc3dfc3luYy5vIHN5bmNfZGVidWcubwogb2Jq
LSQoQ09ORklHX1VETUFCVUYpCQkrPSB1ZG1hYnVmLm8KIAotZG1hYnVmX3NlbGZ0ZXN0cy15IDo9
IHNlbGZ0ZXN0Lm8KK2RtYWJ1Zl9zZWxmdGVzdHMteSA6PSBcCisJc2VsZnRlc3QubyBcCisJc3Qt
ZG1hLWZlbmNlLm8KKwogb2JqLSQoQ09ORklHX0RNQUJVRl9TRUxGVEVTVFMpCSs9IGRtYWJ1Zl9z
ZWxmdGVzdHMubwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL3NlbGZ0ZXN0cy5oIGIvZHJp
dmVycy9kbWEtYnVmL3NlbGZ0ZXN0cy5oCmluZGV4IDQ0YjQ0MzkwZDIzYS4uNTMyMDM4NmYwMmU1
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2RtYS1idWYvc2VsZnRlc3RzLmgKKysrIGIvZHJpdmVycy9k
bWEtYnVmL3NlbGZ0ZXN0cy5oCkBAIC0xMCwzICsxMCw0IEBACiAgKiBUZXN0cyBhcmUgZXhlY3V0
ZWQgaW4gb3JkZXIgYnkgaWd0L2RtYWJ1Zl9zZWxmdGVzdAogICovCiBzZWxmdGVzdChzYW5pdHlj
aGVjaywgX19zYW5pdHljaGVja19fKSAvKiBrZWVwIGZpcnN0IChpZ3Qgc2VsZmNoZWNrKSAqLwor
c2VsZnRlc3QoZG1hX2ZlbmNlLCBkbWFfZmVuY2UpCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1i
dWYvc3QtZG1hLWZlbmNlLmMgYi9kcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLmMKbmV3IGZp
bGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAwMDAwLi5hMzY1ZGM3NDQwZTUKLS0tIC9kZXYv
bnVsbAorKysgYi9kcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLmMKQEAgLTAsMCArMSw1NzEg
QEAKKy8qIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQgKi8KKworLyoKKyAqIENvcHlyaWdo
dCDCqSAyMDE5IEludGVsIENvcnBvcmF0aW9uCisgKi8KKworI2luY2x1ZGUgPGxpbnV4L2RlbGF5
Lmg+CisjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLmg+CisjaW5jbHVkZSA8bGludXgva2VybmVs
Lmg+CisjaW5jbHVkZSA8bGludXgva3RocmVhZC5oPgorI2luY2x1ZGUgPGxpbnV4L3NjaGVkL3Np
Z25hbC5oPgorI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxsaW51eC9zcGlubG9j
ay5oPgorCisjaW5jbHVkZSAic2VsZnRlc3QuaCIKKworc3RhdGljIHN0cnVjdCBrbWVtX2NhY2hl
ICpzbGFiX2ZlbmNlczsKKworc3RhdGljIHN0cnVjdCBtb2NrX2ZlbmNlIHsKKwlzdHJ1Y3QgZG1h
X2ZlbmNlIGJhc2U7CisJc3RydWN0IHNwaW5sb2NrIGxvY2s7Cit9ICp0b19tb2NrX2ZlbmNlKHN0
cnVjdCBkbWFfZmVuY2UgKmYpIHsKKwlyZXR1cm4gY29udGFpbmVyX29mKGYsIHN0cnVjdCBtb2Nr
X2ZlbmNlLCBiYXNlKTsKK30KKworc3RhdGljIGNvbnN0IGNoYXIgKm1vY2tfbmFtZShzdHJ1Y3Qg
ZG1hX2ZlbmNlICpmKQoreworCXJldHVybiAibW9jayI7Cit9CisKK3N0YXRpYyB2b2lkIG1vY2tf
ZmVuY2VfcmVsZWFzZShzdHJ1Y3QgZG1hX2ZlbmNlICpmKQoreworCWttZW1fY2FjaGVfZnJlZShz
bGFiX2ZlbmNlcywgdG9fbW9ja19mZW5jZShmKSk7Cit9CisKK3N0cnVjdCB3YWl0X2NiIHsKKwlz
dHJ1Y3QgZG1hX2ZlbmNlX2NiIGNiOworCXN0cnVjdCB0YXNrX3N0cnVjdCAqdGFzazsKK307CisK
K3N0YXRpYyB2b2lkIG1vY2tfd2FrZXVwKHN0cnVjdCBkbWFfZmVuY2UgKmYsIHN0cnVjdCBkbWFf
ZmVuY2VfY2IgKmNiKQoreworCXdha2VfdXBfcHJvY2Vzcyhjb250YWluZXJfb2YoY2IsIHN0cnVj
dCB3YWl0X2NiLCBjYiktPnRhc2spOworfQorCitzdGF0aWMgbG9uZyBtb2NrX3dhaXQoc3RydWN0
IGRtYV9mZW5jZSAqZiwgYm9vbCBpbnRyLCBsb25nIHRpbWVvdXQpCit7CisJY29uc3QgaW50IHN0
YXRlID0gaW50ciA/IFRBU0tfSU5URVJSVVBUSUJMRSA6IFRBU0tfVU5JTlRFUlJVUFRJQkxFOwor
CXN0cnVjdCB3YWl0X2NiIGNiID0geyAudGFzayA9IGN1cnJlbnQgfTsKKworCWlmIChkbWFfZmVu
Y2VfYWRkX2NhbGxiYWNrKGYsICZjYi5jYiwgbW9ja193YWtldXApKQorCQlyZXR1cm4gdGltZW91
dDsKKworCXdoaWxlICh0aW1lb3V0KSB7CisJCXNldF9jdXJyZW50X3N0YXRlKHN0YXRlKTsKKwor
CQlpZiAodGVzdF9iaXQoRE1BX0ZFTkNFX0ZMQUdfU0lHTkFMRURfQklULCAmZi0+ZmxhZ3MpKQor
CQkJYnJlYWs7CisKKwkJaWYgKHNpZ25hbF9wZW5kaW5nX3N0YXRlKHN0YXRlLCBjdXJyZW50KSkK
KwkJCWJyZWFrOworCisJCXRpbWVvdXQgPSBzY2hlZHVsZV90aW1lb3V0KHRpbWVvdXQpOworCX0K
KwlfX3NldF9jdXJyZW50X3N0YXRlKFRBU0tfUlVOTklORyk7CisKKwlpZiAoIWRtYV9mZW5jZV9y
ZW1vdmVfY2FsbGJhY2soZiwgJmNiLmNiKSkKKwkJcmV0dXJuIHRpbWVvdXQ7CisKKwlpZiAoc2ln
bmFsX3BlbmRpbmdfc3RhdGUoc3RhdGUsIGN1cnJlbnQpKQorCQlyZXR1cm4gLUVSRVNUQVJUU1lT
OworCisJcmV0dXJuIC1FVElNRTsKK30KKworc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfZmVuY2Vf
b3BzIG1vY2tfb3BzID0geworCS5nZXRfZHJpdmVyX25hbWUgPSBtb2NrX25hbWUsCisJLmdldF90
aW1lbGluZV9uYW1lID0gbW9ja19uYW1lLAorCS53YWl0ID0gbW9ja193YWl0LAorCS5yZWxlYXNl
ID0gbW9ja19mZW5jZV9yZWxlYXNlLAorfTsKKworc3RhdGljIHN0cnVjdCBkbWFfZmVuY2UgKm1v
Y2tfZmVuY2Uodm9pZCkKK3sKKwlzdHJ1Y3QgbW9ja19mZW5jZSAqZjsKKworCWYgPSBrbWVtX2Nh
Y2hlX2FsbG9jKHNsYWJfZmVuY2VzLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWYpCisJCXJldHVybiBO
VUxMOworCisJc3Bpbl9sb2NrX2luaXQoJmYtPmxvY2spOworCWRtYV9mZW5jZV9pbml0KCZmLT5i
YXNlLCAmbW9ja19vcHMsICZmLT5sb2NrLCAwLCAwKTsKKworCXJldHVybiAmZi0+YmFzZTsKK30K
Kworc3RhdGljIGludCBzYW5pdHljaGVjayh2b2lkICphcmcpCit7CisJc3RydWN0IGRtYV9mZW5j
ZSAqZjsKKworCWYgPSBtb2NrX2ZlbmNlKCk7CisJaWYgKCFmKQorCQlyZXR1cm4gLUVOT01FTTsK
KworCWRtYV9mZW5jZV9zaWduYWwoZik7CisJZG1hX2ZlbmNlX3B1dChmKTsKKworCXJldHVybiAw
OworfQorCitzdGF0aWMgaW50IHRlc3Rfc2lnbmFsaW5nKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qg
ZG1hX2ZlbmNlICpmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJZiA9IG1vY2tfZmVuY2UoKTsK
KwlpZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9mZW5jZV9pc19zaWduYWxl
ZChmKSkgeworCQlwcl9lcnIoIkZlbmNlIHVuZXhwZWN0ZWRseSBzaWduYWxlZCBvbiBjcmVhdGlv
blxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJaWYgKGRtYV9mZW5jZV9zaWduYWwoZikp
IHsKKwkJcHJfZXJyKCJGZW5jZSByZXBvcnRlZCBiZWluZyBhbHJlYWR5IHNpZ25hbGVkXG4iKTsK
KwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZChmKSkg
eworCQlwcl9lcnIoIkZlbmNlIG5vdCByZXBvcnRpbmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVy
cl9mcmVlOworCX0KKworCWlmICghZG1hX2ZlbmNlX3NpZ25hbChmKSkgeworCQlwcl9lcnIoIkZl
bmNlIHJlcG9ydGVkIG5vdCBiZWluZyBhbHJlYWR5IHNpZ25hbGVkXG4iKTsKKwkJZ290byBlcnJf
ZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZG1hX2ZlbmNlX3B1dChmKTsKKwly
ZXR1cm4gZXJyOworfQorCitzdHJ1Y3Qgc2ltcGxlX2NiIHsKKwlzdHJ1Y3QgZG1hX2ZlbmNlX2Ni
IGNiOworCWJvb2wgc2VlbjsKK307CisKK3N0YXRpYyB2b2lkIHNpbXBsZV9jYWxsYmFjayhzdHJ1
Y3QgZG1hX2ZlbmNlICpmLCBzdHJ1Y3QgZG1hX2ZlbmNlX2NiICpjYikKK3sKKwlzbXBfc3RvcmVf
bWIoY29udGFpbmVyX29mKGNiLCBzdHJ1Y3Qgc2ltcGxlX2NiLCBjYiktPnNlZW4sIHRydWUpOwor
fQorCitzdGF0aWMgaW50IHRlc3RfYWRkX2NhbGxiYWNrKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qg
c2ltcGxlX2NiIGNiID0ge307CisJc3RydWN0IGRtYV9mZW5jZSAqZjsKKwlpbnQgZXJyID0gLUVJ
TlZBTDsKKworCWYgPSBtb2NrX2ZlbmNlKCk7CisJaWYgKCFmKQorCQlyZXR1cm4gLUVOT01FTTsK
KworCWlmIChkbWFfZmVuY2VfYWRkX2NhbGxiYWNrKGYsICZjYi5jYiwgc2ltcGxlX2NhbGxiYWNr
KSkgeworCQlwcl9lcnIoIkZhaWxlZCB0byBhZGQgY2FsbGJhY2ssIGZlbmNlIGFscmVhZHkgc2ln
bmFsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYp
OworCWlmICghY2Iuc2VlbikgeworCQlwcl9lcnIoIkNhbGxiYWNrIGZhaWxlZCFcbiIpOworCQln
b3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlkbWFfZmVuY2VfcHV0
KGYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgdGVzdF9sYXRlX2FkZF9jYWxsYmFj
ayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0cnVjdCBkbWFf
ZmVuY2UgKmY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlmID0gbW9ja19mZW5jZSgpOworCWlm
ICghZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCisJaWYg
KCFkbWFfZmVuY2VfYWRkX2NhbGxiYWNrKGYsICZjYi5jYiwgc2ltcGxlX2NhbGxiYWNrKSkgewor
CQlwcl9lcnIoIkFkZGVkIGNhbGxiYWNrLCBidXQgZmVuY2Ugd2FzIGFscmVhZHkgc2lnbmFsZWQh
XG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCWlm
IChjYi5zZWVuKSB7CisJCXByX2VycigiQ2FsbGJhY2sgY2FsbGVkIGFmdGVyIGZhaWxlZCBhdHRh
Y2htZW50ICFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJl
ZToKKwlkbWFfZmVuY2VfcHV0KGYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgdGVz
dF9ybV9jYWxsYmFjayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9Owor
CXN0cnVjdCBkbWFfZmVuY2UgKmY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlmID0gbW9ja19m
ZW5jZSgpOworCWlmICghZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2Fk
ZF9jYWxsYmFjayhmLCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWls
ZWQgdG8gYWRkIGNhbGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJaWYgKCFkbWFfZmVuY2VfcmVtb3ZlX2NhbGxiYWNrKGYsICZjYi5j
YikpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gcmVtb3ZlIGNhbGxiYWNrIVxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmKTsKKwlpZiAoY2Iuc2Vlbikgewor
CQlwcl9lcnIoIkNhbGxiYWNrIHN0aWxsIHNpZ25hbGVkIGFmdGVyIHJlbW92YWwhXG4iKTsKKwkJ
Z290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZG1hX2ZlbmNlX3B1
dChmKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IHRlc3RfbGF0ZV9ybV9jYWxsYmFj
ayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0cnVjdCBkbWFf
ZmVuY2UgKmY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlmID0gbW9ja19mZW5jZSgpOworCWlm
ICghZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2FkZF9jYWxsYmFjayhm
LCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gYWRkIGNh
bGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJ
fQorCisJZG1hX2ZlbmNlX3NpZ25hbChmKTsKKwlpZiAoIWNiLnNlZW4pIHsKKwkJcHJfZXJyKCJD
YWxsYmFjayBmYWlsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlpZiAoZG1hX2Zl
bmNlX3JlbW92ZV9jYWxsYmFjayhmLCAmY2IuY2IpKSB7CisJCXByX2VycigiQ2FsbGJhY2sgcmVt
b3ZhbCBzdWNjZWVkIGFmdGVyIGJlaW5nIGV4ZWN1dGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7
CisJfQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWRtYV9mZW5jZV9wdXQoZik7CisJcmV0dXJu
IGVycjsKK30KKworc3RhdGljIGludCB0ZXN0X3N0YXR1cyh2b2lkICphcmcpCit7CisJc3RydWN0
IGRtYV9mZW5jZSAqZjsKKwlpbnQgZXJyID0gLUVJTlZBTDsKKworCWYgPSBtb2NrX2ZlbmNlKCk7
CisJaWYgKCFmKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlmIChkbWFfZmVuY2VfZ2V0X3N0YXR1
cyhmKSkgeworCQlwcl9lcnIoIkZlbmNlIHVuZXhwZWN0ZWRseSBoYXMgc2lnbmFsZWQgc3RhdHVz
IG9uIGNyZWF0aW9uXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2ln
bmFsKGYpOworCWlmICghZG1hX2ZlbmNlX2dldF9zdGF0dXMoZikpIHsKKwkJcHJfZXJyKCJGZW5j
ZSBub3QgcmVwb3J0aW5nIHNpZ25hbGVkIHN0YXR1c1xuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJ
fQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWRtYV9mZW5jZV9wdXQoZik7CisJcmV0dXJuIGVy
cjsKK30KKworc3RhdGljIGludCB0ZXN0X2Vycm9yKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1h
X2ZlbmNlICpmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJZiA9IG1vY2tfZmVuY2UoKTsKKwlp
ZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJZG1hX2ZlbmNlX3NldF9lcnJvcihmLCAtRUlP
KTsKKworCWlmIChkbWFfZmVuY2VfZ2V0X3N0YXR1cyhmKSkgeworCQlwcl9lcnIoIkZlbmNlIHVu
ZXhwZWN0ZWRseSBoYXMgZXJyb3Igc3RhdHVzIGJlZm9yZSBzaWduYWxcbiIpOworCQlnb3RvIGVy
cl9mcmVlOworCX0KKworCWRtYV9mZW5jZV9zaWduYWwoZik7CisJaWYgKGRtYV9mZW5jZV9nZXRf
c3RhdHVzKGYpICE9IC1FSU8pIHsKKwkJcHJfZXJyKCJGZW5jZSBub3QgcmVwb3J0aW5nIGVycm9y
IHN0YXR1cywgZ290ICVkXG4iLAorCQkgICAgICAgZG1hX2ZlbmNlX2dldF9zdGF0dXMoZikpOwor
CQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlkbWFfZmVuY2Vf
cHV0KGYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgdGVzdF93YWl0KHZvaWQgKmFy
ZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJZiA9
IG1vY2tfZmVuY2UoKTsKKwlpZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9m
ZW5jZV93YWl0X3RpbWVvdXQoZiwgZmFsc2UsIDApICE9IC1FVElNRSkgeworCQlwcl9lcnIoIldh
aXQgcmVwb3J0ZWQgY29tcGxldGUgYmVmb3JlIGJlaW5nIHNpZ25hbGVkXG4iKTsKKwkJZ290byBl
cnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCisJaWYgKGRtYV9mZW5jZV93
YWl0X3RpbWVvdXQoZiwgZmFsc2UsIDApICE9IDApIHsKKwkJcHJfZXJyKCJXYWl0IHJlcG9ydGVk
IGluY29tcGxldGUgYWZ0ZXIgYmVpbmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVycl9mcmVlOwor
CX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCWRtYV9m
ZW5jZV9wdXQoZik7CisJcmV0dXJuIGVycjsKK30KKworc3RydWN0IHdhaXRfdGltZXIgeworCXN0
cnVjdCB0aW1lcl9saXN0IHRpbWVyOworCXN0cnVjdCBkbWFfZmVuY2UgKmY7Cit9OworCitzdGF0
aWMgdm9pZCB3YWl0X3RpbWVyKHN0cnVjdCB0aW1lcl9saXN0ICp0aW1lcikKK3sKKwlzdHJ1Y3Qg
d2FpdF90aW1lciAqd3QgPSBmcm9tX3RpbWVyKHd0LCB0aW1lciwgdGltZXIpOworCisJZG1hX2Zl
bmNlX3NpZ25hbCh3dC0+Zik7Cit9CisKK3N0YXRpYyBpbnQgdGVzdF93YWl0X3RpbWVvdXQodm9p
ZCAqYXJnKQoreworCXN0cnVjdCB3YWl0X3RpbWVyIHd0OworCWludCBlcnIgPSAtRUlOVkFMOwor
CisJdGltZXJfc2V0dXAoJnd0LnRpbWVyLCB3YWl0X3RpbWVyLCAwKTsKKworCXd0LmYgPSBtb2Nr
X2ZlbmNlKCk7CisJaWYgKCF3dC5mKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlmIChkbWFfZmVu
Y2Vfd2FpdF90aW1lb3V0KHd0LmYsIGZhbHNlLCAxKSAhPSAtRVRJTUUpIHsKKwkJcHJfZXJyKCJX
YWl0IHJlcG9ydGVkIGNvbXBsZXRlIGJlZm9yZSBiZWluZyBzaWduYWxlZFxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJbW9kX3RpbWVyKCZ3dC50aW1lciwgamlmZmllcyArIDEpOworCisJ
aWYgKGRtYV9mZW5jZV93YWl0X3RpbWVvdXQod3QuZiwgZmFsc2UsIDIpID09IC1FVElNRSkgewor
CQlpZiAodGltZXJfcGVuZGluZygmd3QudGltZXIpKSB7CisJCQlwcl9ub3RpY2UoIlRpbWVyIGRp
ZCBub3QgZmlyZSB3aXRoaW4gdGhlIGppZmZpZSFcbiIpOworCQkJZXJyID0gMDsgLyogbm90IG91
ciBmYXVsdCEgKi8KKwkJfSBlbHNlIHsKKwkJCXByX2VycigiV2FpdCByZXBvcnRlZCBpbmNvbXBs
ZXRlIGFmdGVyIHRpbWVvdXRcbiIpOworCQl9CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJZXJy
ID0gMDsKK2Vycl9mcmVlOgorCWRlbF90aW1lcl9zeW5jKCZ3dC50aW1lcik7CisJZG1hX2ZlbmNl
X3NpZ25hbCh3dC5mKTsKKwlkbWFfZmVuY2VfcHV0KHd0LmYpOworCXJldHVybiBlcnI7Cit9CisK
K3N0YXRpYyBpbnQgdGVzdF9zdHViKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpm
WzY0XTsKKwlpbnQgZXJyID0gLUVJTlZBTDsKKwlpbnQgaTsKKworCWZvciAoaSA9IDA7IGkgPCBB
UlJBWV9TSVpFKGYpOyBpKyspIHsKKwkJZltpXSA9IGRtYV9mZW5jZV9nZXRfc3R1YigpOworCQlp
ZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZChmW2ldKSkgeworCQkJcHJfZXJyKCJPYnRhaW5lZCB1
bnNpZ25hbGVkIHN0dWIgZmVuY2UhXG4iKTsKKwkJCWdvdG8gZXJyOworCQl9CisJfQorCisJZXJy
ID0gMDsKK2VycjoKKwl3aGlsZSAoaS0tKQorCQlkbWFfZmVuY2VfcHV0KGZbaV0pOworCXJldHVy
biBlcnI7Cit9CisKKy8qIE5vdyBvZmYgdG8gdGhlIHJhY2VzISAqLworCitzdHJ1Y3QgcmFjZV90
aHJlYWQgeworCXN0cnVjdCBkbWFfZmVuY2UgX19yY3UgKipmZW5jZXM7CisJc3RydWN0IHRhc2tf
c3RydWN0ICp0YXNrOworCWJvb2wgYmVmb3JlOworCWludCBpZDsKK307CisKK3N0YXRpYyB2b2lk
IF9fd2FpdF9mb3JfY2FsbGJhY2tzKHN0cnVjdCBkbWFfZmVuY2UgKmYpCit7CisJc3Bpbl9sb2Nr
X2lycShmLT5sb2NrKTsKKwlzcGluX3VubG9ja19pcnEoZi0+bG9jayk7Cit9CisKK3N0YXRpYyBp
bnQgdGhyZWFkX3NpZ25hbF9jYWxsYmFjayh2b2lkICphcmcpCit7CisJY29uc3Qgc3RydWN0IHJh
Y2VfdGhyZWFkICp0ID0gYXJnOworCXVuc2lnbmVkIGxvbmcgcGFzcyA9IDA7CisJdW5zaWduZWQg
bG9uZyBtaXNzID0gMDsKKwlpbnQgZXJyID0gMDsKKworCXdoaWxlICghZXJyICYmICFrdGhyZWFk
X3Nob3VsZF9zdG9wKCkpIHsKKwkJc3RydWN0IGRtYV9mZW5jZSAqZjEsICpmMjsKKwkJc3RydWN0
IHNpbXBsZV9jYiBjYjsKKworCQlmMSA9IG1vY2tfZmVuY2UoKTsKKwkJaWYgKCFmMSkgeworCQkJ
ZXJyID0gLUVOT01FTTsKKwkJCWJyZWFrOworCQl9CisKKwkJcmN1X2Fzc2lnbl9wb2ludGVyKHQt
PmZlbmNlc1t0LT5pZF0sIGYxKTsKKwkJc21wX3dtYigpOworCisJCXJjdV9yZWFkX2xvY2soKTsK
KwkJZG8geworCQkJZjIgPSBkbWFfZmVuY2VfZ2V0X3JjdV9zYWZlKCZ0LT5mZW5jZXNbIXQtPmlk
XSk7CisJCX0gd2hpbGUgKCFmMiAmJiAha3RocmVhZF9zaG91bGRfc3RvcCgpKTsKKwkJcmN1X3Jl
YWRfdW5sb2NrKCk7CisKKwkJaWYgKHQtPmJlZm9yZSkKKwkJCWRtYV9mZW5jZV9zaWduYWwoZjEp
OworCisJCXNtcF9zdG9yZV9tYihjYi5zZWVuLCBmYWxzZSk7CisJCWlmICghZjIgfHwgZG1hX2Zl
bmNlX2FkZF9jYWxsYmFjayhmMiwgJmNiLmNiLCBzaW1wbGVfY2FsbGJhY2spKQorCQkJbWlzcysr
LCBjYi5zZWVuID0gdHJ1ZTsKKworCQlpZiAoIXQtPmJlZm9yZSkKKwkJCWRtYV9mZW5jZV9zaWdu
YWwoZjEpOworCisJCWlmICghY2Iuc2VlbikgeworCQkJZG1hX2ZlbmNlX3dhaXQoZjIsIGZhbHNl
KTsKKwkJCV9fd2FpdF9mb3JfY2FsbGJhY2tzKGYyKTsKKwkJfQorCisJCWlmICghUkVBRF9PTkNF
KGNiLnNlZW4pKSB7CisJCQlwcl9lcnIoIkNhbGxiYWNrIG5vdCBzZWVuIG9uIHRocmVhZCAlZCwg
cGFzcyAlbHUgKCVsdSBtaXNzZXMpLCBzaWduYWxpbmcgJXMgYWRkX2NhbGxiYWNrOyBmZW5jZSBz
aWduYWxlZD8gJXNcbiIsCisJCQkgICAgICAgdC0+aWQsIHBhc3MsIG1pc3MsCisJCQkgICAgICAg
dC0+YmVmb3JlID8gImJlZm9yZSIgOiAiYWZ0ZXIiLAorCQkJICAgICAgIGRtYV9mZW5jZV9pc19z
aWduYWxlZChmMikgPyAieWVzIiA6ICJubyIpOworCQkJZXJyID0gLUVJTlZBTDsKKwkJfQorCisJ
CWRtYV9mZW5jZV9wdXQoZjIpOworCisJCXJjdV9hc3NpZ25fcG9pbnRlcih0LT5mZW5jZXNbdC0+
aWRdLCBOVUxMKTsKKwkJc21wX3dtYigpOworCisJCWRtYV9mZW5jZV9wdXQoZjEpOworCisJCXBh
c3MrKzsKKwl9CisKKwlwcl9pbmZvKCIlc1slZF0gY29tcGxldGVkICVsdSBwYXNzZXMsICVsdSBt
aXNzZXNcbiIsCisJCV9fZnVuY19fLCB0LT5pZCwgcGFzcywgbWlzcyk7CisJcmV0dXJuIGVycjsK
K30KKworc3RhdGljIGludCByYWNlX3NpZ25hbF9jYWxsYmFjayh2b2lkICphcmcpCit7CisJc3Ry
dWN0IGRtYV9mZW5jZSBfX3JjdSAqZlsyXSA9IHt9OworCWludCByZXQgPSAwOworCWludCBwYXNz
OworCisJZm9yIChwYXNzID0gMDsgIXJldCAmJiBwYXNzIDw9IDE7IHBhc3MrKykgeworCQlzdHJ1
Y3QgcmFjZV90aHJlYWQgdFsyXTsKKwkJaW50IGk7CisKKwkJZm9yIChpID0gMDsgaSA8IEFSUkFZ
X1NJWkUodCk7IGkrKykgeworCQkJdFtpXS5mZW5jZXMgPSBmOworCQkJdFtpXS5pZCA9IGk7CisJ
CQl0W2ldLmJlZm9yZSA9IHBhc3M7CisJCQl0W2ldLnRhc2sgPSBrdGhyZWFkX3J1bih0aHJlYWRf
c2lnbmFsX2NhbGxiYWNrLCAmdFtpXSwKKwkJCQkJCSJkbWEtZmVuY2U6JWQiLCBpKTsKKwkJCWdl
dF90YXNrX3N0cnVjdCh0W2ldLnRhc2spOworCQl9CisKKwkJbXNsZWVwKDUwKTsKKworCQlmb3Ig
KGkgPSAwOyBpIDwgQVJSQVlfU0laRSh0KTsgaSsrKSB7CisJCQlpbnQgZXJyOworCisJCQllcnIg
PSBrdGhyZWFkX3N0b3AodFtpXS50YXNrKTsKKwkJCWlmIChlcnIgJiYgIXJldCkKKwkJCQlyZXQg
PSBlcnI7CisKKwkJCXB1dF90YXNrX3N0cnVjdCh0W2ldLnRhc2spOworCQl9CisJfQorCisJcmV0
dXJuIHJldDsKK30KKworaW50IGRtYV9mZW5jZSh2b2lkKQoreworCXN0YXRpYyBjb25zdCBzdHJ1
Y3Qgc3VidGVzdCB0ZXN0c1tdID0geworCQlTVUJURVNUKHNhbml0eWNoZWNrKSwKKwkJU1VCVEVT
VCh0ZXN0X3NpZ25hbGluZyksCisJCVNVQlRFU1QodGVzdF9hZGRfY2FsbGJhY2spLAorCQlTVUJU
RVNUKHRlc3RfbGF0ZV9hZGRfY2FsbGJhY2spLAorCQlTVUJURVNUKHRlc3Rfcm1fY2FsbGJhY2sp
LAorCQlTVUJURVNUKHRlc3RfbGF0ZV9ybV9jYWxsYmFjayksCisJCVNVQlRFU1QodGVzdF9zdGF0
dXMpLAorCQlTVUJURVNUKHRlc3RfZXJyb3IpLAorCQlTVUJURVNUKHRlc3Rfd2FpdCksCisJCVNV
QlRFU1QodGVzdF93YWl0X3RpbWVvdXQpLAorCQlTVUJURVNUKHRlc3Rfc3R1YiksCisJCVNVQlRF
U1QocmFjZV9zaWduYWxfY2FsbGJhY2spLAorCX07CisJaW50IHJldDsKKworCXByX2luZm8oInNp
emVvZihkbWFfZmVuY2UpPSVsdVxuIiwgc2l6ZW9mKHN0cnVjdCBkbWFfZmVuY2UpKTsKKworCXNs
YWJfZmVuY2VzID0gS01FTV9DQUNIRShtb2NrX2ZlbmNlLAorCQkJCSBTTEFCX1RZUEVTQUZFX0JZ
X1JDVSB8CisJCQkJIFNMQUJfSFdDQUNIRV9BTElHTik7CisKKwlyZXQgPSBzdWJ0ZXN0cyh0ZXN0
cywgTlVMTCk7CisKKwlrbWVtX2NhY2hlX2Rlc3Ryb3koc2xhYl9mZW5jZXMpOworCisJcmV0dXJu
IHJldDsKK30KLS0gCjIuMjMuMC5yYzEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2RyaS1kZXZlbA==
