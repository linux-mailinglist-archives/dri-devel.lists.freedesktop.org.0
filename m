Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id AEED83356E
	for <lists+dri-devel@lfdr.de>; Mon,  3 Jun 2019 18:56:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B021B892AA;
	Mon,  3 Jun 2019 16:56:39 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from bhuna.collabora.co.uk (bhuna.collabora.co.uk
 [IPv6:2a00:1098:0:82:1000:25:2eeb:e3e3])
 by gabe.freedesktop.org (Postfix) with ESMTPS id ECA3B892AA
 for <dri-devel@lists.freedesktop.org>; Mon,  3 Jun 2019 16:56:37 +0000 (UTC)
Received: from [127.0.0.1] (localhost [127.0.0.1])
 (Authenticated sender: koike) with ESMTPSA id 57A39284AA2
From: Helen Koike <helen.koike@collabora.com>
To: dri-devel@lists.freedesktop.org,
	nicholas.kazlauskas@amd.com
Subject: [PATCH v4 1/5] drm/rockchip: fix fb references in async update
Date: Mon,  3 Jun 2019 13:56:06 -0300
Message-Id: <20190603165610.24614-2-helen.koike@collabora.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190603165610.24614-1-helen.koike@collabora.com>
References: <20190603165610.24614-1-helen.koike@collabora.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?St=C3=A9phane=20Marchesin?= <marcheu@google.com>,
 Sean Paul <seanpaul@google.com>, David Airlie <airlied@linux.ie>,
 daniel.vetter@ffwll.ch, linux-kernel@vger.kernel.org,
 Tomasz Figa <tfiga@chromium.org>, linux-rockchip@lists.infradead.org,
 Helen Koike <helen.koike@collabora.com>, boris.brezillon@collabora.com,
 kernel@collabora.com, linux-arm-kernel@lists.infradead.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

SW4gdGhlIGNhc2Ugb2YgYXN5bmMgdXBkYXRlLCBtb2RpZmljYXRpb25zIGFyZSBkb25lIGluIHBs
YWNlLCBpLmUuIGluIHRoZQpjdXJyZW50IHBsYW5lIHN0YXRlLCBzbyB0aGUgbmV3X3N0YXRlIGlz
IHByZXBhcmVkIGFuZCB0aGUgbmV3X3N0YXRlIGlzCmNsZWFuZWQgdXAgKGluc3RlYWQgb2YgdGhl
IG9sZF9zdGF0ZSwgdW5saWtlIHdoYXQgaGFwcGVucyBpbiBhCm5vcm1hbCBzeW5jIHVwZGF0ZSku
ClRvIGNsZWFudXAgdGhlIG9sZF9mYiBwcm9wZXJseSwgaXQgbmVlZHMgdG8gYmUgcGxhY2VkIGlu
IHRoZSBuZXdfc3RhdGUKaW4gdGhlIGVuZCBvZiBhc3luY191cGRhdGUsIHNvIGNsZWFudXAgY2Fs
bCB3aWxsIHVucmVmZXJlbmNlIHRoZSBvbGRfZmIKY29ycmVjdGx5LgoKQWxzbywgdGhlIHByZXZp
b3VzIGNvZGUgaGFkIGE6CgoJcGxhbmVfc3RhdGUgPSBwbGFuZS0+ZnVuY3MtPmF0b21pY19kdXBs
aWNhdGVfc3RhdGUocGxhbmUpOwoJLi4uCglzd2FwKHBsYW5lX3N0YXRlLCBwbGFuZS0+c3RhdGUp
OwoKCWlmIChwbGFuZS0+c3RhdGUtPmZiICYmIHBsYW5lLT5zdGF0ZS0+ZmIgIT0gbmV3X3N0YXRl
LT5mYikgewoJLi4uCgl9CgpXaGljaCB3YXMgd3JvbmcsIGFzIHRoZSBmYiB3ZXJlIGp1c3QgYXNz
aWduZWQgdG8gYmUgZXF1YWwsIHNvIHRoaXMgaWYKc3RhdGVtZW50IG5ldmVycyBldmFsdWF0ZXMg
dG8gdHJ1ZS4KCkFub3RoZXIgZGV0YWlscyBpcyB0aGF0IHRoZSBmdW5jdGlvbiBkcm1fY3J0Y192
YmxhbmtfZ2V0KCkgY2FuIG9ubHkgYmUKY2FsbGVkIHdoZW4gdm9wLT5pc19lbmFibGVkIGlzIHRy
dWUsIG90aGVyd2lzZSBpdCBoYXMgbm8gZWZmZWN0IGFuZAp0cm93cyBhIFdBUk5fT04oKS4KCkNh
bGxpbmcgZHJtX2F0b21pY19zZXRfZmJfZm9yX3BsYW5lKCkgKHdoaWNoIGdldCBhIHJlZmVyZW50
IG9mIHRoZSBuZXcKZmIgYW5kIHB1cyB0aGUgb2xkIGZiKSBpcyBub3QgcmVxdWlyZWQsIGFzIGl0
IGlzIHRha2VuIGNhcmUgYnkKZHJtX21vZGVfY3Vyc29yX3VuaXZlcnNhbCgpIHdoZW4gY2FsbGlu
Zwpkcm1fYXRvbWljX2hlbHBlcl91cGRhdGVfcGxhbmUoKS4KClNpZ25lZC1vZmYtYnk6IEhlbGVu
IEtvaWtlIDxoZWxlbi5rb2lrZUBjb2xsYWJvcmEuY29tPgoKLS0tCkhlbGxvLAoKSSB0ZXN0ZWQg
b24gdGhlIHJvY2tjaGlwIGZpY3VzIHYxLjEgdXNpbmcgaWd0IHBsYW5lX2N1cnNvcl9sZWdhY3kg
YW5kCmttc19jdXJzb3JfbGVnYWN5IGFuZCBJIGRpZG4ndCBzZWUgYW55IHJlZ3Jlc3Npb25zLgoK
Q2hhbmdlcyBpbiB2NDogTm9uZQpDaGFuZ2VzIGluIHYzOgotIHVzZSBzd2FwKCkgdG8gc3dhcCBv
bGQgYW5kIG5ldyBmcmFtZWJ1ZmZlcnMgaW4gYXN5bmNfdXBkYXRlCi0gZ2V0IHRoZSByZWZlcmVu
Y2UgdG8gb2xkX2ZiIGFuZCBzZXQgdGhlIHdvcmtlciBhZnRlciB2b3BfcGxhbmVfYXRvbWljX3Vw
ZGF0ZSgpCi0gYWRkIGEgRklYTUUgdGFnIGZvciB3aGVuIHdlIGhhdmUgbXVsdGlwbGUgZmJzIHRv
IGJlIHJlbGVhc2VkIHdoZW4KdmJsYW5rIGhhcHBlbnMuCi0gdXBkYXRlIGNvbW1pdCBtZXNzYWdl
CgpDaGFuZ2VzIGluIHYyOiBOb25lCgogZHJpdmVycy9ncHUvZHJtL3JvY2tjaGlwL3JvY2tjaGlw
X2RybV92b3AuYyB8IDUxICsrKysrKysrKysrLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDI2
IGluc2VydGlvbnMoKyksIDI1IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fdm9wLmMgYi9kcml2ZXJzL2dwdS9kcm0vcm9ja2No
aXAvcm9ja2NoaXBfZHJtX3ZvcC5jCmluZGV4IDQxODljYTE3ZjM4MS4uYjdjNDdkMTE1M2M2IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vcm9ja2NoaXAvcm9ja2NoaXBfZHJtX3ZvcC5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fdm9wLmMKQEAgLTkxOSwy
OSArOTE5LDE3IEBAIHN0YXRpYyB2b2lkIHZvcF9wbGFuZV9hdG9taWNfYXN5bmNfdXBkYXRlKHN0
cnVjdCBkcm1fcGxhbmUgKnBsYW5lLAogCQkJCQkgIHN0cnVjdCBkcm1fcGxhbmVfc3RhdGUgKm5l
d19zdGF0ZSkKIHsKIAlzdHJ1Y3Qgdm9wICp2b3AgPSB0b192b3AocGxhbmUtPnN0YXRlLT5jcnRj
KTsKLQlzdHJ1Y3QgZHJtX3BsYW5lX3N0YXRlICpwbGFuZV9zdGF0ZTsKLQotCXBsYW5lX3N0YXRl
ID0gcGxhbmUtPmZ1bmNzLT5hdG9taWNfZHVwbGljYXRlX3N0YXRlKHBsYW5lKTsKLQlwbGFuZV9z
dGF0ZS0+Y3J0Y194ID0gbmV3X3N0YXRlLT5jcnRjX3g7Ci0JcGxhbmVfc3RhdGUtPmNydGNfeSA9
IG5ld19zdGF0ZS0+Y3J0Y195OwotCXBsYW5lX3N0YXRlLT5jcnRjX2ggPSBuZXdfc3RhdGUtPmNy
dGNfaDsKLQlwbGFuZV9zdGF0ZS0+Y3J0Y193ID0gbmV3X3N0YXRlLT5jcnRjX3c7Ci0JcGxhbmVf
c3RhdGUtPnNyY194ID0gbmV3X3N0YXRlLT5zcmNfeDsKLQlwbGFuZV9zdGF0ZS0+c3JjX3kgPSBu
ZXdfc3RhdGUtPnNyY195OwotCXBsYW5lX3N0YXRlLT5zcmNfaCA9IG5ld19zdGF0ZS0+c3JjX2g7
Ci0JcGxhbmVfc3RhdGUtPnNyY193ID0gbmV3X3N0YXRlLT5zcmNfdzsKLQotCWlmIChwbGFuZV9z
dGF0ZS0+ZmIgIT0gbmV3X3N0YXRlLT5mYikKLQkJZHJtX2F0b21pY19zZXRfZmJfZm9yX3BsYW5l
KHBsYW5lX3N0YXRlLCBuZXdfc3RhdGUtPmZiKTsKLQotCXN3YXAocGxhbmVfc3RhdGUsIHBsYW5l
LT5zdGF0ZSk7Ci0KLQlpZiAocGxhbmUtPnN0YXRlLT5mYiAmJiBwbGFuZS0+c3RhdGUtPmZiICE9
IG5ld19zdGF0ZS0+ZmIpIHsKLQkJZHJtX2ZyYW1lYnVmZmVyX2dldChwbGFuZS0+c3RhdGUtPmZi
KTsKLQkJV0FSTl9PTihkcm1fY3J0Y192YmxhbmtfZ2V0KHBsYW5lLT5zdGF0ZS0+Y3J0YykgIT0g
MCk7Ci0JCWRybV9mbGlwX3dvcmtfcXVldWUoJnZvcC0+ZmJfdW5yZWZfd29yaywgcGxhbmUtPnN0
YXRlLT5mYik7Ci0JCXNldF9iaXQoVk9QX1BFTkRJTkdfRkJfVU5SRUYsICZ2b3AtPnBlbmRpbmcp
OwotCX0KKwlzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpvbGRfZmIgPSBwbGFuZS0+c3RhdGUtPmZi
OworCisJcGxhbmUtPnN0YXRlLT5jcnRjX3ggPSBuZXdfc3RhdGUtPmNydGNfeDsKKwlwbGFuZS0+
c3RhdGUtPmNydGNfeSA9IG5ld19zdGF0ZS0+Y3J0Y195OworCXBsYW5lLT5zdGF0ZS0+Y3J0Y19o
ID0gbmV3X3N0YXRlLT5jcnRjX2g7CisJcGxhbmUtPnN0YXRlLT5jcnRjX3cgPSBuZXdfc3RhdGUt
PmNydGNfdzsKKwlwbGFuZS0+c3RhdGUtPnNyY194ID0gbmV3X3N0YXRlLT5zcmNfeDsKKwlwbGFu
ZS0+c3RhdGUtPnNyY195ID0gbmV3X3N0YXRlLT5zcmNfeTsKKwlwbGFuZS0+c3RhdGUtPnNyY19o
ID0gbmV3X3N0YXRlLT5zcmNfaDsKKwlwbGFuZS0+c3RhdGUtPnNyY193ID0gbmV3X3N0YXRlLT5z
cmNfdzsKKwlzd2FwKHBsYW5lLT5zdGF0ZS0+ZmIsIG5ld19zdGF0ZS0+ZmIpOwogCiAJaWYgKHZv
cC0+aXNfZW5hYmxlZCkgewogCQlyb2NrY2hpcF9kcm1fcHNyX2luaGliaXRfZ2V0X3N0YXRlKG5l
d19zdGF0ZS0+c3RhdGUpOwpAQCAtOTUwLDkgKzkzOCwyMiBAQCBzdGF0aWMgdm9pZCB2b3BfcGxh
bmVfYXRvbWljX2FzeW5jX3VwZGF0ZShzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZSwKIAkJdm9wX2Nm
Z19kb25lKHZvcCk7CiAJCXNwaW5fdW5sb2NrKCZ2b3AtPnJlZ19sb2NrKTsKIAkJcm9ja2NoaXBf
ZHJtX3Bzcl9pbmhpYml0X3B1dF9zdGF0ZShuZXdfc3RhdGUtPnN0YXRlKTsKLQl9CiAKLQlwbGFu
ZS0+ZnVuY3MtPmF0b21pY19kZXN0cm95X3N0YXRlKHBsYW5lLCBwbGFuZV9zdGF0ZSk7CisJCS8q
CisJCSAqIEEgc2Nhbm91dCBjYW4gc3RpbGwgYmUgb2NjdXJyaW5nLCBzbyB3ZSBjYW4ndCBkcm9w
IHRoZQorCQkgKiByZWZlcmVuY2UgdG8gdGhlIG9sZCBmcmFtZWJ1ZmZlci4gVG8gc29sdmUgdGhp
cyB3ZSBnZXQgYQorCQkgKiByZWZlcmVuY2UgdG8gb2xkX2ZiIGFuZCBzZXQgYSB3b3JrZXIgdG8g
cmVsZWFzZSBpdCBsYXRlci4KKwkJICogRklYTUU6IGlmIHdlIHBlcmZvcm0gNTAwIGFzeW5jX3Vw
ZGF0ZSBjYWxscyBiZWZvcmUgdGhlCisJCSAqIHZibGFuaywgdGhlbiB3ZSBjYW4gaGF2ZSA1MDAg
ZGlmZmVyZW50IGZyYW1lYnVmZmVycyB3YWl0aW5nCisJCSAqIHRvIGJlIHJlbGVhc2VkLgorCQkg
Ki8KKwkJaWYgKG9sZF9mYiAmJiBwbGFuZS0+c3RhdGUtPmZiICE9IG9sZF9mYikgeworCQkJZHJt
X2ZyYW1lYnVmZmVyX2dldChvbGRfZmIpOworCQkJV0FSTl9PTihkcm1fY3J0Y192YmxhbmtfZ2V0
KHBsYW5lLT5zdGF0ZS0+Y3J0YykgIT0gMCk7CisJCQlkcm1fZmxpcF93b3JrX3F1ZXVlKCZ2b3At
PmZiX3VucmVmX3dvcmssIG9sZF9mYik7CisJCQlzZXRfYml0KFZPUF9QRU5ESU5HX0ZCX1VOUkVG
LCAmdm9wLT5wZW5kaW5nKTsKKwkJfQorCX0KIH0KIAogc3RhdGljIGNvbnN0IHN0cnVjdCBkcm1f
cGxhbmVfaGVscGVyX2Z1bmNzIHBsYW5lX2hlbHBlcl9mdW5jcyA9IHsKLS0gCjIuMjAuMQoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1h
aWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
