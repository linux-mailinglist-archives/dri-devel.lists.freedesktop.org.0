Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 6CAB0B1AD5
	for <lists+dri-devel@lfdr.de>; Fri, 13 Sep 2019 11:32:52 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id CD2106EEF6;
	Fri, 13 Sep 2019 09:32:46 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from pio-pvt-msa2.bahnhof.se (pio-pvt-msa2.bahnhof.se [79.136.2.41])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D6D6A6EEF2
 for <dri-devel@lists.freedesktop.org>; Fri, 13 Sep 2019 09:32:40 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by pio-pvt-msa2.bahnhof.se (Postfix) with ESMTP id D65743F712;
 Fri, 13 Sep 2019 11:32:33 +0200 (CEST)
X-Virus-Scanned: Debian amavisd-new at bahnhof.se
X-Spam-Flag: NO
X-Spam-Score: -2.099
X-Spam-Level: 
X-Spam-Status: No, score=-2.099 tagged_above=-999 required=6.31
 tests=[BAYES_00=-1.9, DKIM_SIGNED=0.1, DKIM_VALID=-0.1,
 DKIM_VALID_AU=-0.1, DKIM_VALID_EF=-0.1, URIBL_BLOCKED=0.001]
 autolearn=ham autolearn_force=no
Received: from pio-pvt-msa2.bahnhof.se ([127.0.0.1])
 by localhost (pio-pvt-msa2.bahnhof.se [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id dDA1F9XuZwPV; Fri, 13 Sep 2019 11:32:30 +0200 (CEST)
Received: from mail1.shipmail.org (h-205-35.A357.priv.bahnhof.se
 [155.4.205.35]) (Authenticated sender: mb878879)
 by pio-pvt-msa2.bahnhof.se (Postfix) with ESMTPA id 5AD1C3F21C;
 Fri, 13 Sep 2019 11:32:28 +0200 (CEST)
Received: from localhost.localdomain.localdomain
 (h-205-35.A357.priv.bahnhof.se [155.4.205.35])
 by mail1.shipmail.org (Postfix) with ESMTPSA id AD27F360248;
 Fri, 13 Sep 2019 11:32:27 +0200 (CEST)
From: =?UTF-8?q?Thomas=20Hellstr=C3=B6m=20=28VMware=29?=
 <thomas_os@shipmail.org>
To: linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 linux-mm@kvack.org
Subject: [RFC PATCH 3/7] drm/ttm: TTM fault handler helpers
Date: Fri, 13 Sep 2019 11:32:09 +0200
Message-Id: <20190913093213.27254-4-thomas_os@shipmail.org>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190913093213.27254-1-thomas_os@shipmail.org>
References: <20190913093213.27254-1-thomas_os@shipmail.org>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=simple/simple;
 d=shipmail.org; s=mail; 
 t=1568367147; bh=O7CkVSfbqrZbq1k5SqaS6g94hqbxrwcsGFU1Ild1cks=;
 h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
 b=E6BAZgR+y6UMLcc92a5xk+hww9ed0cP2nftJGTFhB5/uZ4mxev50mo58VXDwlP7kP
 h7xCIv6GyIwo+nZ6cw6bTKPqxgbLF4Y/qaxpOhuN2olO29/h0XCXQCacDcaR386n7s
 U7vJ1QYfj1LvkeRmFX0vK+Ghef0RvN5SIEnld42Q=
X-Mailman-Original-Authentication-Results: pio-pvt-msa2.bahnhof.se;
 dkim=pass (1024-bit key;
 unprotected) header.d=shipmail.org header.i=@shipmail.org header.b=E6BAZgR+; 
 dkim-atps=neutral
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Thomas Hellstrom <thellstrom@vmware.com>, Michal Hocko <mhocko@suse.com>,
 Rik van Riel <riel@surriel.com>, pv-drivers@vmware.com,
 Minchan Kim <minchan@kernel.org>, Will Deacon <will.deacon@arm.com>,
 Matthew Wilcox <willy@infradead.org>, Christoph Hellwig <hch@infradead.org>,
 Peter Zijlstra <peterz@infradead.org>,
 =?UTF-8?q?J=C3=A9r=C3=B4me=20Glisse?= <jglisse@redhat.com>,
 linux-graphics-maintainer@vmware.com, Souptick Joarder <jrdr.linux@gmail.com>,
 Huang Ying <ying.huang@intel.com>, Andrew Morton <akpm@linux-foundation.org>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogVGhvbWFzIEhlbGxzdHJvbSA8dGhlbGxzdHJvbUB2bXdhcmUuY29tPgoKV2l0aCB0aGUg
dm13Z2Z4IGRpcnR5IHRyYWNraW5nLCB0aGUgZGVmYXVsdCBUVE0gZmF1bHQgaGFuZGxlciBpcyBu
b3QKY29tcGxldGVseSBzdWZmaWNpZW50ICh2bXdnZnggbmVlZCB0byBtb2RpZnkgdGhlIHZtYS0+
dm1fZmxhZ3MgbWVtYmVyLAphbmQgYWxzbyBuZWVkcyB0byByZXN0cmljdCB0aGUgbnVtYmVyIG9m
IHByZWZhdWx0cykuCgpXZSBhbHNvIHdhbnQgdG8gcmVwbGljYXRlIHRoZSBuZXcgdHRtX2JvX3Zt
X3Jlc2VydmUoKSBmdW5jdGlvbmFsaXR5CgpTbyBzdGFydCB0dXJuaW5nIHRoZSBUVE0gdm0gY29k
ZSBpbnRvIGhlbHBlcnM6IHR0bV9ib192bV9mYXVsdF9yZXNlcnZlZCgpCmFuZCB0dG1fYm9fdm1f
cmVzZXJ2ZSgpLCBhbmQgcHJvdmlkZSBhIGRlZmF1bHQgVFRNIGZhdWx0IGhhbmRsZXIgZm9yIG90
aGVyCmRyaXZlcnMgdG8gdXNlLgoKQ2M6IEFuZHJldyBNb3J0b24gPGFrcG1AbGludXgtZm91bmRh
dGlvbi5vcmc+CkNjOiBNYXR0aGV3IFdpbGNveCA8d2lsbHlAaW5mcmFkZWFkLm9yZz4KQ2M6IFdp
bGwgRGVhY29uIDx3aWxsLmRlYWNvbkBhcm0uY29tPgpDYzogUGV0ZXIgWmlqbHN0cmEgPHBldGVy
ekBpbmZyYWRlYWQub3JnPgpDYzogUmlrIHZhbiBSaWVsIDxyaWVsQHN1cnJpZWwuY29tPgpDYzog
TWluY2hhbiBLaW0gPG1pbmNoYW5Aa2VybmVsLm9yZz4KQ2M6IE1pY2hhbCBIb2NrbyA8bWhvY2tv
QHN1c2UuY29tPgpDYzogSHVhbmcgWWluZyA8eWluZy5odWFuZ0BpbnRlbC5jb20+CkNjOiBTb3Vw
dGljayBKb2FyZGVyIDxqcmRyLmxpbnV4QGdtYWlsLmNvbT4KQ2M6ICJKw6lyw7RtZSBHbGlzc2Ui
IDxqZ2xpc3NlQHJlZGhhdC5jb20+CkNjOiAiQ2hyaXN0aWFuIEvDtm5pZyIgPGNocmlzdGlhbi5r
b2VuaWdAYW1kLmNvbT4KQ2M6IENocmlzdG9waCBIZWxsd2lnIDxoY2hAaW5mcmFkZWFkLm9yZz4K
U2lnbmVkLW9mZi1ieTogVGhvbWFzIEhlbGxzdHJvbSA8dGhlbGxzdHJvbUB2bXdhcmUuY29tPgpS
ZXZpZXdlZC1ieTogIkNocmlzdGlhbiBLw7ZuaWciIDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+
ICN2MQotLS0KIGRyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvX3ZtLmMgfCAxNzYgKysrKysrKysr
KysrKysrKysrKy0tLS0tLS0tLS0tLS0KIGluY2x1ZGUvZHJtL3R0bS90dG1fYm9fYXBpLmggICAg
fCAgMTAgKysKIDIgZmlsZXMgY2hhbmdlZCwgMTE0IGluc2VydGlvbnMoKyksIDcyIGRlbGV0aW9u
cygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvX3ZtLmMgYi9kcml2
ZXJzL2dwdS9kcm0vdHRtL3R0bV9ib192bS5jCmluZGV4IDAzZjcwMmMyOTZjZi4uNWE1ODBhZGVi
OWQxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9ib192bS5jCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvX3ZtLmMKQEAgLTQyLDggKzQyLDYgQEAKICNpbmNsdWRl
IDxsaW51eC91YWNjZXNzLmg+CiAjaW5jbHVkZSA8bGludXgvbWVtX2VuY3J5cHQuaD4KIAotI2Rl
ZmluZSBUVE1fQk9fVk1fTlVNX1BSRUZBVUxUIDE2Ci0KIHN0YXRpYyB2bV9mYXVsdF90IHR0bV9i
b192bV9mYXVsdF9pZGxlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJCQkJc3RydWN0
IHZtX2ZhdWx0ICp2bWYpCiB7CkBAIC0xMDYsMzEgKzEwNCwzMCBAQCBzdGF0aWMgdW5zaWduZWQg
bG9uZyB0dG1fYm9faW9fbWVtX3BmbihzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAogCQkr
IHBhZ2Vfb2Zmc2V0OwogfQogCi1zdGF0aWMgdm1fZmF1bHRfdCB0dG1fYm9fdm1fZmF1bHQoc3Ry
dWN0IHZtX2ZhdWx0ICp2bWYpCisvKioKKyAqIHR0bV9ib192bV9yZXNlcnZlIC0gUmVzZXJ2ZSBh
IGJ1ZmZlciBvYmplY3QgaW4gYSByZXRyeWFibGUgdm0gY2FsbGJhY2sKKyAqIEBibzogVGhlIGJ1
ZmZlciBvYmplY3QKKyAqIEB2bWY6IFRoZSBmYXVsdCBzdHJ1Y3R1cmUgaGFuZGVkIHRvIHRoZSBj
YWxsYmFjaworICoKKyAqIHZtIGNhbGxiYWNrcyBsaWtlIGZhdWx0KCkgYW5kICpfbWt3cml0ZSgp
IGFsbG93IGZvciB0aGUgbW1fc2VtIHRvIGJlIGRyb3BwZWQKKyAqIGR1cmluZyBsb25nIHdhaXRz
LCBhbmQgYWZ0ZXIgdGhlIHdhaXQgdGhlIGNhbGxiYWNrIHdpbGwgYmUgcmVzdGFydGVkLiBUaGlz
CisgKiBpcyB0byBhbGxvdyBvdGhlciB0aHJlYWRzIHVzaW5nIHRoZSBzYW1lIHZpcnR1YWwgbWVt
b3J5IHNwYWNlIGNvbmN1cnJlbnQKKyAqIGFjY2VzcyB0byBtYXAoKSwgdW5tYXAoKSBjb21wbGV0
ZWx5IHVucmVsYXRlZCBidWZmZXIgb2JqZWN0cy4gVFRNIGJ1ZmZlcgorICogb2JqZWN0IHJlc2Vy
dmF0aW9ucyBzb21ldGltZXMgd2FpdCBmb3IgR1BVIGFuZCBzaG91bGQgdGhlcmVmb3JlIGJlCisg
KiBjb25zaWRlcmVkIGxvbmcgd2FpdHMuIFRoaXMgZnVuY3Rpb24gcmVzZXJ2ZXMgdGhlIGJ1ZmZl
ciBvYmplY3QgaW50ZXJydXB0aWJseQorICogdGFraW5nIHRoaXMgaW50byBhY2NvdW50LiBTdGFy
dmF0aW9uIGlzIGF2b2lkZWQgYnkgdGhlIHZtIHN5c3RlbSBub3QKKyAqIGFsbG93aW5nIHRvbyBt
YW55IHJlcGVhdGVkIHJlc3RhcnRzLgorICogVGhpcyBmdW5jdGlvbiBpcyBpbnRlbmRlZCB0byBi
ZSB1c2VkIGluIGN1c3RvbWl6ZWQgZmF1bHQoKSBhbmQgX21rd3JpdGUoKQorICogaGFuZGxlcnMu
CisgKgorICogUmV0dXJuOgorICogICAgMCBvbiBzdWNjZXNzIGFuZCB0aGUgYm8gd2FzIHJlc2Vy
dmVkLgorICogICAgVk1fRkFVTFRfUkVUUlkgaWYgYmxvY2tpbmcgd2FpdC4KKyAqICAgIFZNX0ZB
VUxUX05PUEFHRSBpZiBibG9ja2luZyB3YWl0IGFuZCByZXRyeWluZyB3YXMgbm90IGFsbG93ZWQu
CisgKi8KK3ZtX2ZhdWx0X3QgdHRtX2JvX3ZtX3Jlc2VydmUoc3RydWN0IHR0bV9idWZmZXJfb2Jq
ZWN0ICpibywKKwkJCSAgICAgc3RydWN0IHZtX2ZhdWx0ICp2bWYpCiB7Ci0Jc3RydWN0IHZtX2Fy
ZWFfc3RydWN0ICp2bWEgPSB2bWYtPnZtYTsKLQlzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJv
ID0gKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqKQotCSAgICB2bWEtPnZtX3ByaXZhdGVfZGF0
YTsKLQlzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiA9IGJvLT5iZGV2OwotCXVuc2lnbmVkIGxv
bmcgcGFnZV9vZmZzZXQ7Ci0JdW5zaWduZWQgbG9uZyBwYWdlX2xhc3Q7Ci0JdW5zaWduZWQgbG9u
ZyBwZm47Ci0Jc3RydWN0IHR0bV90dCAqdHRtID0gTlVMTDsKLQlzdHJ1Y3QgcGFnZSAqcGFnZTsK
LQlpbnQgZXJyOwotCWludCBpOwotCXZtX2ZhdWx0X3QgcmV0ID0gVk1fRkFVTFRfTk9QQUdFOwot
CXVuc2lnbmVkIGxvbmcgYWRkcmVzcyA9IHZtZi0+YWRkcmVzczsKLQlzdHJ1Y3QgdHRtX21lbV90
eXBlX21hbmFnZXIgKm1hbiA9Ci0JCSZiZGV2LT5tYW5bYm8tPm1lbS5tZW1fdHlwZV07Ci0Jc3Ry
dWN0IHZtX2FyZWFfc3RydWN0IGN2bWE7Ci0KLQkvKgotCSAqIFdvcmsgYXJvdW5kIGxvY2tpbmcg
b3JkZXIgcmV2ZXJzYWwgaW4gZmF1bHQgLyBub3BmbgotCSAqIGJldHdlZW4gbW1hcF9zZW0gYW5k
IGJvX3Jlc2VydmU6IFBlcmZvcm0gYSB0cnlsb2NrIG9wZXJhdGlvbgotCSAqIGZvciByZXNlcnZl
LCBhbmQgaWYgaXQgZmFpbHMsIHJldHJ5IHRoZSBmYXVsdCBhZnRlciB3YWl0aW5nCi0JICogZm9y
IHRoZSBidWZmZXIgdG8gYmVjb21lIHVucmVzZXJ2ZWQuCi0JICovCiAJaWYgKHVubGlrZWx5KCFk
bWFfcmVzdl90cnlsb2NrKGJvLT5iYXNlLnJlc3YpKSkgewogCQlpZiAodm1mLT5mbGFncyAmIEZB
VUxUX0ZMQUdfQUxMT1dfUkVUUlkpIHsKIAkJCWlmICghKHZtZi0+ZmxhZ3MgJiBGQVVMVF9GTEFH
X1JFVFJZX05PV0FJVCkpIHsKQEAgLTE1MSwxNCArMTQ4LDU1IEBAIHN0YXRpYyB2bV9mYXVsdF90
IHR0bV9ib192bV9mYXVsdChzdHJ1Y3Qgdm1fZmF1bHQgKnZtZikKIAkJcmV0dXJuIFZNX0ZBVUxU
X05PUEFHRTsKIAl9CiAKKwlyZXR1cm4gMDsKK30KK0VYUE9SVF9TWU1CT0wodHRtX2JvX3ZtX3Jl
c2VydmUpOworCisvKioKKyAqIHR0bV9ib192bV9mYXVsdF9yZXNlcnZlZCAtIFRUTSBmYXVsdCBo
ZWxwZXIKKyAqIEB2bWY6IFRoZSBzdHJ1Y3Qgdm1fZmF1bHQgZ2l2ZW4gYXMgYXJndW1lbnQgdG8g
dGhlIGZhdWx0IGNhbGxiYWNrCisgKiBAcHJvdDogVGhlIHBhZ2UgcHJvdGVjdGlvbiB0byBiZSB1
c2VkIGZvciB0aGlzIG1lbW9yeSBhcmVhLgorICogQG51bV9wcmVmYXVsdDogTWF4aW11bSBudW1i
ZXIgb2YgcHJlZmF1bHQgcGFnZXMuIFRoZSBjYWxsZXIgbWF5IHdhbnQgdG8KKyAqIHNwZWNpZnkg
dGhpcyBiYXNlZCBvbiBtYWR2aWNlIHNldHRpbmdzIGFuZCB0aGUgc2l6ZSBvZiB0aGUgR1BVIG9i
amVjdAorICogYmFja2VkIGJ5IHRoZSBtZW1vcnkuCisgKgorICogVGhpcyBmdW5jdGlvbiBpbnNl
cnRzIG9uZSBvciBtb3JlIHBhZ2UgdGFibGUgZW50cmllcyBwb2ludGluZyB0byB0aGUKKyAqIG1l
bW9yeSBiYWNraW5nIHRoZSBidWZmZXIgb2JqZWN0LCBhbmQgdGhlbiByZXR1cm5zIGEgcmV0dXJu
IGNvZGUKKyAqIGluc3RydWN0aW5nIHRoZSBjYWxsZXIgdG8gcmV0cnkgdGhlIHBhZ2UgYWNjZXNz
LgorICoKKyAqIFJldHVybjoKKyAqICAgVk1fRkFVTFRfTk9QQUdFIG9uIHN1Y2Nlc3Mgb3IgcGVu
ZGluZyBzaWduYWwKKyAqICAgVk1fRkFVTFRfU0lHQlVTIG9uIHVuc3BlY2lmaWVkIGVycm9yCisg
KiAgIFZNX0ZBVUxUX09PTSBvbiBvdXQtb2YtbWVtb3J5CisgKiAgIFZNX0ZBVUxUX1JFVFJZIGlm
IHJldHJ5YWJsZSB3YWl0CisgKi8KK3ZtX2ZhdWx0X3QgdHRtX2JvX3ZtX2ZhdWx0X3Jlc2VydmVk
KHN0cnVjdCB2bV9mYXVsdCAqdm1mLAorCQkJCSAgICBwZ3Byb3RfdCBwcm90LAorCQkJCSAgICBw
Z29mZl90IG51bV9wcmVmYXVsdCkKK3sKKwlzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSA9IHZt
Zi0+dm1hOworCXN0cnVjdCB2bV9hcmVhX3N0cnVjdCBjdm1hID0gKnZtYTsKKwlzdHJ1Y3QgdHRt
X2J1ZmZlcl9vYmplY3QgKmJvID0gKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqKQorCSAgICB2
bWEtPnZtX3ByaXZhdGVfZGF0YTsKKwlzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiA9IGJvLT5i
ZGV2OworCXVuc2lnbmVkIGxvbmcgcGFnZV9vZmZzZXQ7CisJdW5zaWduZWQgbG9uZyBwYWdlX2xh
c3Q7CisJdW5zaWduZWQgbG9uZyBwZm47CisJc3RydWN0IHR0bV90dCAqdHRtID0gTlVMTDsKKwlz
dHJ1Y3QgcGFnZSAqcGFnZTsKKwlpbnQgZXJyOworCXBnb2ZmX3QgaTsKKwl2bV9mYXVsdF90IHJl
dCA9IFZNX0ZBVUxUX05PUEFHRTsKKwl1bnNpZ25lZCBsb25nIGFkZHJlc3MgPSB2bWYtPmFkZHJl
c3M7CisJc3RydWN0IHR0bV9tZW1fdHlwZV9tYW5hZ2VyICptYW4gPQorCQkmYmRldi0+bWFuW2Jv
LT5tZW0ubWVtX3R5cGVdOworCiAJLyoKIAkgKiBSZWZ1c2UgdG8gZmF1bHQgaW1wb3J0ZWQgcGFn
ZXMuIFRoaXMgc2hvdWxkIGJlIGhhbmRsZWQKIAkgKiAoaWYgYXQgYWxsKSBieSByZWRpcmVjdGlu
ZyBtbWFwIHRvIHRoZSBleHBvcnRlci4KIAkgKi8KLQlpZiAoYm8tPnR0bSAmJiAoYm8tPnR0bS0+
cGFnZV9mbGFncyAmIFRUTV9QQUdFX0ZMQUdfU0cpKSB7Ci0JCXJldCA9IFZNX0ZBVUxUX1NJR0JV
UzsKLQkJZ290byBvdXRfdW5sb2NrOwotCX0KKwlpZiAoYm8tPnR0bSAmJiAoYm8tPnR0bS0+cGFn
ZV9mbGFncyAmIFRUTV9QQUdFX0ZMQUdfU0cpKQorCQlyZXR1cm4gVk1fRkFVTFRfU0lHQlVTOwog
CiAJaWYgKGJkZXYtPmRyaXZlci0+ZmF1bHRfcmVzZXJ2ZV9ub3RpZnkpIHsKIAkJc3RydWN0IGRt
YV9mZW5jZSAqbW92aW5nID0gZG1hX2ZlbmNlX2dldChiby0+bW92aW5nKTsKQEAgLTE2OSwxMSAr
MjA3LDkgQEAgc3RhdGljIHZtX2ZhdWx0X3QgdHRtX2JvX3ZtX2ZhdWx0KHN0cnVjdCB2bV9mYXVs
dCAqdm1mKQogCQkJYnJlYWs7CiAJCWNhc2UgLUVCVVNZOgogCQljYXNlIC1FUkVTVEFSVFNZUzoK
LQkJCXJldCA9IFZNX0ZBVUxUX05PUEFHRTsKLQkJCWdvdG8gb3V0X3VubG9jazsKKwkJCXJldHVy
biBWTV9GQVVMVF9OT1BBR0U7CiAJCWRlZmF1bHQ6Ci0JCQlyZXQgPSBWTV9GQVVMVF9TSUdCVVM7
Ci0JCQlnb3RvIG91dF91bmxvY2s7CisJCQlyZXR1cm4gVk1fRkFVTFRfU0lHQlVTOwogCQl9CiAK
IAkJaWYgKGJvLT5tb3ZpbmcgIT0gbW92aW5nKSB7CkBAIC0xODksMjYgKzIyNSwxNSBAQCBzdGF0
aWMgdm1fZmF1bHRfdCB0dG1fYm9fdm1fZmF1bHQoc3RydWN0IHZtX2ZhdWx0ICp2bWYpCiAJICog
bW92ZS4KIAkgKi8KIAlyZXQgPSB0dG1fYm9fdm1fZmF1bHRfaWRsZShibywgdm1mKTsKLQlpZiAo
dW5saWtlbHkocmV0ICE9IDApKSB7Ci0JCWlmIChyZXQgPT0gVk1fRkFVTFRfUkVUUlkgJiYKLQkJ
ICAgICEodm1mLT5mbGFncyAmIEZBVUxUX0ZMQUdfUkVUUllfTk9XQUlUKSkgewotCQkJLyogVGhl
IEJPIGhhcyBhbHJlYWR5IGJlZW4gdW5yZXNlcnZlZC4gKi8KLQkJCXJldHVybiByZXQ7Ci0JCX0K
LQotCQlnb3RvIG91dF91bmxvY2s7Ci0JfQorCWlmICh1bmxpa2VseShyZXQgIT0gMCkpCisJCXJl
dHVybiByZXQ7CiAKIAllcnIgPSB0dG1fbWVtX2lvX2xvY2sobWFuLCB0cnVlKTsKLQlpZiAodW5s
aWtlbHkoZXJyICE9IDApKSB7Ci0JCXJldCA9IFZNX0ZBVUxUX05PUEFHRTsKLQkJZ290byBvdXRf
dW5sb2NrOwotCX0KKwlpZiAodW5saWtlbHkoZXJyICE9IDApKQorCQlyZXR1cm4gVk1fRkFVTFRf
Tk9QQUdFOwogCWVyciA9IHR0bV9tZW1faW9fcmVzZXJ2ZV92bShibyk7Ci0JaWYgKHVubGlrZWx5
KGVyciAhPSAwKSkgewotCQlyZXQgPSBWTV9GQVVMVF9TSUdCVVM7Ci0JCWdvdG8gb3V0X2lvX3Vu
bG9jazsKLQl9CisJaWYgKHVubGlrZWx5KGVyciAhPSAwKSkKKwkJcmV0dXJuIFZNX0ZBVUxUX1NJ
R0JVUzsKIAogCXBhZ2Vfb2Zmc2V0ID0gKChhZGRyZXNzIC0gdm1hLT52bV9zdGFydCkgPj4gUEFH
RV9TSElGVCkgKwogCQl2bWEtPnZtX3Bnb2ZmIC0gZHJtX3ZtYV9ub2RlX3N0YXJ0KCZiby0+YmFz
ZS52bWFfbm9kZSk7CkBAIC0yMjAsMTggKzI0NSw4IEBAIHN0YXRpYyB2bV9mYXVsdF90IHR0bV9i
b192bV9mYXVsdChzdHJ1Y3Qgdm1fZmF1bHQgKnZtZikKIAkJZ290byBvdXRfaW9fdW5sb2NrOwog
CX0KIAotCS8qCi0JICogTWFrZSBhIGxvY2FsIHZtYSBjb3B5IHRvIG1vZGlmeSB0aGUgcGFnZV9w
cm90IG1lbWJlcgotCSAqIGFuZCB2bV9mbGFncyBpZiBuZWNlc3NhcnkuIFRoZSB2bWEgcGFyYW1l
dGVyIGlzIHByb3RlY3RlZAotCSAqIGJ5IG1tYXBfc2VtIGluIHdyaXRlIG1vZGUuCi0JICovCi0J
Y3ZtYSA9ICp2bWE7Ci0JY3ZtYS52bV9wYWdlX3Byb3QgPSB2bV9nZXRfcGFnZV9wcm90KGN2bWEu
dm1fZmxhZ3MpOwotCi0JaWYgKGJvLT5tZW0uYnVzLmlzX2lvbWVtKSB7Ci0JCWN2bWEudm1fcGFn
ZV9wcm90ID0gdHRtX2lvX3Byb3QoYm8tPm1lbS5wbGFjZW1lbnQsCi0JCQkJCQljdm1hLnZtX3Bh
Z2VfcHJvdCk7Ci0JfSBlbHNlIHsKKwljdm1hLnZtX3BhZ2VfcHJvdCA9IHR0bV9pb19wcm90KGJv
LT5tZW0ucGxhY2VtZW50LCBwcm90KTsKKwlpZiAoIWJvLT5tZW0uYnVzLmlzX2lvbWVtKSB7CiAJ
CXN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCBjdHggPSB7CiAJCQkuaW50ZXJydXB0aWJsZSA9IGZh
bHNlLAogCQkJLm5vX3dhaXRfZ3B1ID0gZmFsc2UsCkBAIC0yNDAsMjQgKzI1NSwyMSBAQCBzdGF0
aWMgdm1fZmF1bHRfdCB0dG1fYm9fdm1fZmF1bHQoc3RydWN0IHZtX2ZhdWx0ICp2bWYpCiAJCX07
CiAKIAkJdHRtID0gYm8tPnR0bTsKLQkJY3ZtYS52bV9wYWdlX3Byb3QgPSB0dG1faW9fcHJvdChi
by0+bWVtLnBsYWNlbWVudCwKLQkJCQkJCWN2bWEudm1fcGFnZV9wcm90KTsKLQotCQkvKiBBbGxv
Y2F0ZSBhbGwgcGFnZSBhdCBvbmNlLCBtb3N0IGNvbW1vbiB1c2FnZSAqLwotCQlpZiAodHRtX3R0
X3BvcHVsYXRlKHR0bSwgJmN0eCkpIHsKKwkJaWYgKHR0bV90dF9wb3B1bGF0ZShiby0+dHRtLCAm
Y3R4KSkgewogCQkJcmV0ID0gVk1fRkFVTFRfT09NOwogCQkJZ290byBvdXRfaW9fdW5sb2NrOwog
CQl9CisJfSBlbHNlIHsKKwkJLyogSW9tZW0gc2hvdWxkIG5vdCBiZSBtYXJrZWQgZW5jcnlwdGVk
ICovCisJCWN2bWEudm1fcGFnZV9wcm90ID0gcGdwcm90X2RlY3J5cHRlZChjdm1hLnZtX3BhZ2Vf
cHJvdCk7CiAJfQogCiAJLyoKIAkgKiBTcGVjdWxhdGl2ZWx5IHByZWZhdWx0IGEgbnVtYmVyIG9m
IHBhZ2VzLiBPbmx5IGVycm9yIG9uCiAJICogZmlyc3QgcGFnZS4KIAkgKi8KLQlmb3IgKGkgPSAw
OyBpIDwgVFRNX0JPX1ZNX05VTV9QUkVGQVVMVDsgKytpKSB7CisJZm9yIChpID0gMDsgaSA8IG51
bV9wcmVmYXVsdDsgKytpKSB7CiAJCWlmIChiby0+bWVtLmJ1cy5pc19pb21lbSkgewotCQkJLyog
SW9tZW0gc2hvdWxkIG5vdCBiZSBtYXJrZWQgZW5jcnlwdGVkICovCi0JCQljdm1hLnZtX3BhZ2Vf
cHJvdCA9IHBncHJvdF9kZWNyeXB0ZWQoY3ZtYS52bV9wYWdlX3Byb3QpOwogCQkJcGZuID0gdHRt
X2JvX2lvX21lbV9wZm4oYm8sIHBhZ2Vfb2Zmc2V0KTsKIAkJfSBlbHNlIHsKIAkJCXBhZ2UgPSB0
dG0tPnBhZ2VzW3BhZ2Vfb2Zmc2V0XTsKQEAgLTI5NSw4ICszMDcsMjggQEAgc3RhdGljIHZtX2Zh
dWx0X3QgdHRtX2JvX3ZtX2ZhdWx0KHN0cnVjdCB2bV9mYXVsdCAqdm1mKQogCXJldCA9IFZNX0ZB
VUxUX05PUEFHRTsKIG91dF9pb191bmxvY2s6CiAJdHRtX21lbV9pb191bmxvY2sobWFuKTsKLW91
dF91bmxvY2s6CisJcmV0dXJuIHJldDsKK30KK0VYUE9SVF9TWU1CT0wodHRtX2JvX3ZtX2ZhdWx0
X3Jlc2VydmVkKTsKKworc3RhdGljIHZtX2ZhdWx0X3QgdHRtX2JvX3ZtX2ZhdWx0KHN0cnVjdCB2
bV9mYXVsdCAqdm1mKQoreworCXN0cnVjdCB2bV9hcmVhX3N0cnVjdCAqdm1hID0gdm1mLT52bWE7
CisJcGdwcm90X3QgcHJvdDsKKwlzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvID0gdm1hLT52
bV9wcml2YXRlX2RhdGE7CisJdm1fZmF1bHRfdCByZXQ7CisKKwlyZXQgPSB0dG1fYm9fdm1fcmVz
ZXJ2ZShibywgdm1mKTsKKwlpZiAocmV0KQorCQlyZXR1cm4gcmV0OworCisJcHJvdCA9IHZtX2dl
dF9wYWdlX3Byb3Qodm1hLT52bV9mbGFncyk7CisJcmV0ID0gdHRtX2JvX3ZtX2ZhdWx0X3Jlc2Vy
dmVkKHZtZiwgcHJvdCwgVFRNX0JPX1ZNX05VTV9QUkVGQVVMVCk7CisJaWYgKHJldCA9PSBWTV9G
QVVMVF9SRVRSWSAmJiAhKHZtZi0+ZmxhZ3MgJiBGQVVMVF9GTEFHX1JFVFJZX05PV0FJVCkpCisJ
CXJldHVybiByZXQ7CisKIAlkbWFfcmVzdl91bmxvY2soYm8tPmJhc2UucmVzdik7CisKIAlyZXR1
cm4gcmV0OwogfQogCmRpZmYgLS1naXQgYS9pbmNsdWRlL2RybS90dG0vdHRtX2JvX2FwaS5oIGIv
aW5jbHVkZS9kcm0vdHRtL3R0bV9ib19hcGkuaAppbmRleCA0M2M0OTI5YTIxNzEuLmQ3YWQ4NzIx
ZDY0MSAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vdHRtL3R0bV9ib19hcGkuaAorKysgYi9pbmNs
dWRlL2RybS90dG0vdHRtX2JvX2FwaS5oCkBAIC03ODUsNCArNzg1LDE0IEBAIHN0YXRpYyBpbmxp
bmUgYm9vbCB0dG1fYm9fdXNlc19lbWJlZGRlZF9nZW1fb2JqZWN0KHN0cnVjdCB0dG1fYnVmZmVy
X29iamVjdCAqYm8pCiB7CiAJcmV0dXJuIGJvLT5iYXNlLmRldiAhPSBOVUxMOwogfQorCisvKiBE
ZWZhdWx0IG51bWJlciBvZiBwcmUtZmF1bHRlZCBwYWdlcyBpbiB0aGUgVFRNIGZhdWx0IGhhbmRs
ZXIgKi8KKyNkZWZpbmUgVFRNX0JPX1ZNX05VTV9QUkVGQVVMVCAxNgorCit2bV9mYXVsdF90IHR0
bV9ib192bV9yZXNlcnZlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCisJCQkgICAgIHN0
cnVjdCB2bV9mYXVsdCAqdm1mKTsKKwordm1fZmF1bHRfdCB0dG1fYm9fdm1fZmF1bHRfcmVzZXJ2
ZWQoc3RydWN0IHZtX2ZhdWx0ICp2bWYsCisJCQkJICAgIHBncHJvdF90IHByb3QsCisJCQkJICAg
IHBnb2ZmX3QgbnVtX3ByZWZhdWx0KTsKICNlbmRpZgotLSAKMi4yMC4xCgpfX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0
CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3Rv
cC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
