Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C5F1D910E3
	for <lists+dri-devel@lfdr.de>; Sat, 17 Aug 2019 16:48:03 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8940D6E501;
	Sat, 17 Aug 2019 14:47:52 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D07746E4F1;
 Sat, 17 Aug 2019 14:47:50 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18173476-1500050 
 for multiple; Sat, 17 Aug 2019 15:47:38 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH 2/6] dma-buf: Add selftests for dma-fence
Date: Sat, 17 Aug 2019 15:47:32 +0100
Message-Id: <20190817144736.7826-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0.rc1
In-Reply-To: <20190817144736.7826-1-chris@chris-wilson.co.uk>
References: <20190817144736.7826-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>, intel-gfx@lists.freedesktop.org,
 christian.koenig@amd.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RXhlcmNpc2UgdGhlIGRtYS1mZW5jZSBBUEkgZXhwb3J0ZWQgdG8gZHJpdmVycy4KClNpZ25lZC1v
ZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVrPgpDYzogRGFuaWVs
IFZldHRlciA8ZGFuaWVsLnZldHRlckBmZndsbC5jaD4KLS0tCiBkcml2ZXJzL2RtYS1idWYvTWFr
ZWZpbGUgICAgICAgfCAgIDUgKy0KIGRyaXZlcnMvZG1hLWJ1Zi9zZWxmdGVzdHMuaCAgICB8ICAg
MSArCiBkcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLmMgfCA1NzEgKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDU3NiBpbnNlcnRpb25zKCspLCAx
IGRlbGV0aW9uKC0pCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy9kbWEtYnVmL3N0LWRtYS1m
ZW5jZS5jCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlIGIvZHJpdmVycy9k
bWEtYnVmL01ha2VmaWxlCmluZGV4IGI1YWUxMjJhOTM0OS4uMDM0NzlkYTA2NDIyIDEwMDY0NAot
LS0gYS9kcml2ZXJzL2RtYS1idWYvTWFrZWZpbGUKKysrIGIvZHJpdmVycy9kbWEtYnVmL01ha2Vm
aWxlCkBAIC01LDUgKzUsOCBAQCBvYmotJChDT05GSUdfU1lOQ19GSUxFKQkJKz0gc3luY19maWxl
Lm8KIG9iai0kKENPTkZJR19TV19TWU5DKQkJKz0gc3dfc3luYy5vIHN5bmNfZGVidWcubwogb2Jq
LSQoQ09ORklHX1VETUFCVUYpCQkrPSB1ZG1hYnVmLm8KIAotZG1hYnVmX3NlbGZ0ZXN0cy15IDo9
IHNlbGZ0ZXN0Lm8KK2RtYWJ1Zl9zZWxmdGVzdHMteSA6PSBcCisJc2VsZnRlc3QubyBcCisJc3Qt
ZG1hLWZlbmNlLm8KKwogb2JqLSQoQ09ORklHX0RNQUJVRl9TRUxGVEVTVFMpCSs9IGRtYWJ1Zl9z
ZWxmdGVzdHMubwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL3NlbGZ0ZXN0cy5oIGIvZHJp
dmVycy9kbWEtYnVmL3NlbGZ0ZXN0cy5oCmluZGV4IDQ0YjQ0MzkwZDIzYS4uNTMyMDM4NmYwMmU1
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2RtYS1idWYvc2VsZnRlc3RzLmgKKysrIGIvZHJpdmVycy9k
bWEtYnVmL3NlbGZ0ZXN0cy5oCkBAIC0xMCwzICsxMCw0IEBACiAgKiBUZXN0cyBhcmUgZXhlY3V0
ZWQgaW4gb3JkZXIgYnkgaWd0L2RtYWJ1Zl9zZWxmdGVzdAogICovCiBzZWxmdGVzdChzYW5pdHlj
aGVjaywgX19zYW5pdHljaGVja19fKSAvKiBrZWVwIGZpcnN0IChpZ3Qgc2VsZmNoZWNrKSAqLwor
c2VsZnRlc3QoZG1hX2ZlbmNlLCBkbWFfZmVuY2UpCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1i
dWYvc3QtZG1hLWZlbmNlLmMgYi9kcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLmMKbmV3IGZp
bGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAwMDAwLi5kMDUyYmVhNGZiOWYKLS0tIC9kZXYv
bnVsbAorKysgYi9kcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLmMKQEAgLTAsMCArMSw1NzEg
QEAKKy8qIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQgKi8KKworLyoKKyAqIENvcHlyaWdo
dCDCqSAyMDE5IEludGVsIENvcnBvcmF0aW9uCisgKi8KKworI2luY2x1ZGUgPGxpbnV4L2RlbGF5
Lmg+CisjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLmg+CisjaW5jbHVkZSA8bGludXgva2VybmVs
Lmg+CisjaW5jbHVkZSA8bGludXgva3RocmVhZC5oPgorI2luY2x1ZGUgPGxpbnV4L3NjaGVkL3Np
Z25hbC5oPgorI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxsaW51eC9zcGlubG9j
ay5oPgorCisjaW5jbHVkZSAic2VsZnRlc3QuaCIKKworc3RhdGljIHN0cnVjdCBrbWVtX2NhY2hl
ICpzbGFiX2ZlbmNlczsKKworc3RhdGljIHN0cnVjdCBtb2NrX2ZlbmNlIHsKKwlzdHJ1Y3QgZG1h
X2ZlbmNlIGJhc2U7CisJc3RydWN0IHNwaW5sb2NrIGxvY2s7Cit9ICp0b19tb2NrX2ZlbmNlKHN0
cnVjdCBkbWFfZmVuY2UgKmYpIHsKKwlyZXR1cm4gY29udGFpbmVyX29mKGYsIHN0cnVjdCBtb2Nr
X2ZlbmNlLCBiYXNlKTsKK30KKworc3RhdGljIGNvbnN0IGNoYXIgKm1vY2tfbmFtZShzdHJ1Y3Qg
ZG1hX2ZlbmNlICpmKQoreworCXJldHVybiAibW9jayI7Cit9CisKK3N0YXRpYyB2b2lkIG1vY2tf
ZmVuY2VfcmVsZWFzZShzdHJ1Y3QgZG1hX2ZlbmNlICpmKQoreworCWttZW1fY2FjaGVfZnJlZShz
bGFiX2ZlbmNlcywgdG9fbW9ja19mZW5jZShmKSk7Cit9CisKK3N0cnVjdCB3YWl0X2NiIHsKKwlz
dHJ1Y3QgZG1hX2ZlbmNlX2NiIGNiOworCXN0cnVjdCB0YXNrX3N0cnVjdCAqdGFzazsKK307CisK
K3N0YXRpYyB2b2lkIG1vY2tfd2FrZXVwKHN0cnVjdCBkbWFfZmVuY2UgKmYsIHN0cnVjdCBkbWFf
ZmVuY2VfY2IgKmNiKQoreworCXdha2VfdXBfcHJvY2Vzcyhjb250YWluZXJfb2YoY2IsIHN0cnVj
dCB3YWl0X2NiLCBjYiktPnRhc2spOworfQorCitzdGF0aWMgbG9uZyBtb2NrX3dhaXQoc3RydWN0
IGRtYV9mZW5jZSAqZiwgYm9vbCBpbnRyLCBsb25nIHRpbWVvdXQpCit7CisJY29uc3QgaW50IHN0
YXRlID0gaW50ciA/IFRBU0tfSU5URVJSVVBUSUJMRSA6IFRBU0tfVU5JTlRFUlJVUFRJQkxFOwor
CXN0cnVjdCB3YWl0X2NiIGNiID0geyAudGFzayA9IGN1cnJlbnQgfTsKKworCWlmIChkbWFfZmVu
Y2VfYWRkX2NhbGxiYWNrKGYsICZjYi5jYiwgbW9ja193YWtldXApKQorCQlyZXR1cm4gdGltZW91
dDsKKworCXdoaWxlICh0aW1lb3V0KSB7CisJCXNldF9jdXJyZW50X3N0YXRlKHN0YXRlKTsKKwor
CQlpZiAodGVzdF9iaXQoRE1BX0ZFTkNFX0ZMQUdfU0lHTkFMRURfQklULCAmZi0+ZmxhZ3MpKQor
CQkJYnJlYWs7CisKKwkJaWYgKHNpZ25hbF9wZW5kaW5nX3N0YXRlKHN0YXRlLCBjdXJyZW50KSkK
KwkJCWJyZWFrOworCisJCXRpbWVvdXQgPSBzY2hlZHVsZV90aW1lb3V0KHRpbWVvdXQpOworCX0K
KwlfX3NldF9jdXJyZW50X3N0YXRlKFRBU0tfUlVOTklORyk7CisKKwlpZiAoIWRtYV9mZW5jZV9y
ZW1vdmVfY2FsbGJhY2soZiwgJmNiLmNiKSkKKwkJcmV0dXJuIHRpbWVvdXQ7CisKKwlpZiAoc2ln
bmFsX3BlbmRpbmdfc3RhdGUoc3RhdGUsIGN1cnJlbnQpKQorCQlyZXR1cm4gLUVSRVNUQVJUU1lT
OworCisJcmV0dXJuIC1FVElNRTsKK30KKworc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfZmVuY2Vf
b3BzIG1vY2tfb3BzID0geworCS5nZXRfZHJpdmVyX25hbWUgPSBtb2NrX25hbWUsCisJLmdldF90
aW1lbGluZV9uYW1lID0gbW9ja19uYW1lLAorCS53YWl0ID0gbW9ja193YWl0LAorCS5yZWxlYXNl
ID0gbW9ja19mZW5jZV9yZWxlYXNlLAorfTsKKworc3RhdGljIHN0cnVjdCBkbWFfZmVuY2UgKm1v
Y2tfZmVuY2Uodm9pZCkKK3sKKwlzdHJ1Y3QgbW9ja19mZW5jZSAqZjsKKworCWYgPSBrbWVtX2Nh
Y2hlX2FsbG9jKHNsYWJfZmVuY2VzLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWYpCisJCXJldHVybiBO
VUxMOworCisJc3Bpbl9sb2NrX2luaXQoJmYtPmxvY2spOworCWRtYV9mZW5jZV9pbml0KCZmLT5i
YXNlLCAmbW9ja19vcHMsICZmLT5sb2NrLCAwLCAwKTsKKworCXJldHVybiAmZi0+YmFzZTsKK30K
Kworc3RhdGljIGludCBzYW5pdHljaGVjayh2b2lkICphcmcpCit7CisJc3RydWN0IGRtYV9mZW5j
ZSAqZjsKKworCWYgPSBtb2NrX2ZlbmNlKCk7CisJaWYgKCFmKQorCQlyZXR1cm4gLUVOT01FTTsK
KworCWRtYV9mZW5jZV9zaWduYWwoZik7CisJZG1hX2ZlbmNlX3B1dChmKTsKKworCXJldHVybiAw
OworfQorCitzdGF0aWMgaW50IHRlc3Rfc2lnbmFsaW5nKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qg
ZG1hX2ZlbmNlICpmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJZiA9IG1vY2tfZmVuY2UoKTsK
KwlpZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9mZW5jZV9pc19zaWduYWxl
ZChmKSkgeworCQlwcl9lcnIoIkZlbmNlIHVuZXhwZWN0ZWRseSBzaWduYWxlZCBvbiBjcmVhdGlv
blxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJfQorCisJaWYgKGRtYV9mZW5jZV9zaWduYWwoZikp
IHsKKwkJcHJfZXJyKCJGZW5jZSByZXBvcnRlZCBiZWluZyBhbHJlYWR5IHNpZ25hbGVkXG4iKTsK
KwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZChmKSkg
eworCQlwcl9lcnIoIkZlbmNlIG5vdCByZXBvcnRpbmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVy
cl9mcmVlOworCX0KKworCWlmICghZG1hX2ZlbmNlX3NpZ25hbChmKSkgeworCQlwcl9lcnIoIkZl
bmNlIHJlcG9ydGVkIG5vdCBiZWluZyBhbHJlYWR5IHNpZ25hbGVkXG4iKTsKKwkJZ290byBlcnJf
ZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZG1hX2ZlbmNlX3B1dChmKTsKKwly
ZXR1cm4gZXJyOworfQorCitzdHJ1Y3Qgc2ltcGxlX2NiIHsKKwlzdHJ1Y3QgZG1hX2ZlbmNlX2Ni
IGNiOworCWJvb2wgc2VlbjsKK307CisKK3N0YXRpYyB2b2lkIHNpbXBsZV9jYWxsYmFjayhzdHJ1
Y3QgZG1hX2ZlbmNlICpmLCBzdHJ1Y3QgZG1hX2ZlbmNlX2NiICpjYikKK3sKKwlzbXBfc3RvcmVf
bWIoY29udGFpbmVyX29mKGNiLCBzdHJ1Y3Qgc2ltcGxlX2NiLCBjYiktPnNlZW4sIHRydWUpOwor
fQorCitzdGF0aWMgaW50IHRlc3RfYWRkX2NhbGxiYWNrKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3Qg
c2ltcGxlX2NiIGNiID0ge307CisJc3RydWN0IGRtYV9mZW5jZSAqZjsKKwlpbnQgZXJyID0gLUVJ
TlZBTDsKKworCWYgPSBtb2NrX2ZlbmNlKCk7CisJaWYgKCFmKQorCQlyZXR1cm4gLUVOT01FTTsK
KworCWlmIChkbWFfZmVuY2VfYWRkX2NhbGxiYWNrKGYsICZjYi5jYiwgc2ltcGxlX2NhbGxiYWNr
KSkgeworCQlwcl9lcnIoIkZhaWxlZCB0byBhZGQgY2FsbGJhY2ssIGZlbmNlIGFscmVhZHkgc2ln
bmFsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYp
OworCWlmICghY2Iuc2VlbikgeworCQlwcl9lcnIoIkNhbGxiYWNrIGZhaWxlZCFcbiIpOworCQln
b3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlkbWFfZmVuY2VfcHV0
KGYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgdGVzdF9sYXRlX2FkZF9jYWxsYmFj
ayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0cnVjdCBkbWFf
ZmVuY2UgKmY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlmID0gbW9ja19mZW5jZSgpOworCWlm
ICghZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCisJaWYg
KCFkbWFfZmVuY2VfYWRkX2NhbGxiYWNrKGYsICZjYi5jYiwgc2ltcGxlX2NhbGxiYWNrKSkgewor
CQlwcl9lcnIoIkFkZGVkIGNhbGxiYWNrLCBidXQgZmVuY2Ugd2FzIGFscmVhZHkgc2lnbmFsZWQh
XG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCWlm
IChjYi5zZWVuKSB7CisJCXByX2VycigiQ2FsbGJhY2sgY2FsbGVkIGFmdGVyIGZhaWxlZCBhdHRh
Y2htZW50ICFcbiIpOworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJl
ZToKKwlkbWFfZmVuY2VfcHV0KGYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgdGVz
dF9ybV9jYWxsYmFjayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9Owor
CXN0cnVjdCBkbWFfZmVuY2UgKmY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlmID0gbW9ja19m
ZW5jZSgpOworCWlmICghZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2Fk
ZF9jYWxsYmFjayhmLCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWls
ZWQgdG8gYWRkIGNhbGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJaWYgKCFkbWFfZmVuY2VfcmVtb3ZlX2NhbGxiYWNrKGYsICZjYi5j
YikpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gcmVtb3ZlIGNhbGxiYWNrIVxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmKTsKKwlpZiAoY2Iuc2Vlbikgewor
CQlwcl9lcnIoIkNhbGxiYWNrIHN0aWxsIHNpZ25hbGVkIGFmdGVyIHJlbW92YWwhXG4iKTsKKwkJ
Z290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJyX2ZyZWU6CisJZG1hX2ZlbmNlX3B1
dChmKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IHRlc3RfbGF0ZV9ybV9jYWxsYmFj
ayh2b2lkICphcmcpCit7CisJc3RydWN0IHNpbXBsZV9jYiBjYiA9IHt9OworCXN0cnVjdCBkbWFf
ZmVuY2UgKmY7CisJaW50IGVyciA9IC1FSU5WQUw7CisKKwlmID0gbW9ja19mZW5jZSgpOworCWlm
ICghZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoZG1hX2ZlbmNlX2FkZF9jYWxsYmFjayhm
LCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gYWRkIGNh
bGxiYWNrLCBmZW5jZSBhbHJlYWR5IHNpZ25hbGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJ
fQorCisJZG1hX2ZlbmNlX3NpZ25hbChmKTsKKwlpZiAoIWNiLnNlZW4pIHsKKwkJcHJfZXJyKCJD
YWxsYmFjayBmYWlsZWQhXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlpZiAoZG1hX2Zl
bmNlX3JlbW92ZV9jYWxsYmFjayhmLCAmY2IuY2IpKSB7CisJCXByX2VycigiQ2FsbGJhY2sgcmVt
b3ZhbCBzdWNjZWVkIGFmdGVyIGJlaW5nIGV4ZWN1dGVkIVxuIik7CisJCWdvdG8gZXJyX2ZyZWU7
CisJfQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWRtYV9mZW5jZV9wdXQoZik7CisJcmV0dXJu
IGVycjsKK30KKworc3RhdGljIGludCB0ZXN0X3N0YXR1cyh2b2lkICphcmcpCit7CisJc3RydWN0
IGRtYV9mZW5jZSAqZjsKKwlpbnQgZXJyID0gLUVJTlZBTDsKKworCWYgPSBtb2NrX2ZlbmNlKCk7
CisJaWYgKCFmKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlmIChkbWFfZmVuY2VfZ2V0X3N0YXR1
cyhmKSkgeworCQlwcl9lcnIoIkZlbmNlIHVuZXhwZWN0ZWRseSBoYXMgc2lnbmFsZWQgc3RhdHVz
IG9uIGNyZWF0aW9uXG4iKTsKKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2ln
bmFsKGYpOworCWlmICghZG1hX2ZlbmNlX2dldF9zdGF0dXMoZikpIHsKKwkJcHJfZXJyKCJGZW5j
ZSBub3QgcmVwb3J0aW5nIHNpZ25hbGVkIHN0YXR1c1xuIik7CisJCWdvdG8gZXJyX2ZyZWU7CisJ
fQorCisJZXJyID0gMDsKK2Vycl9mcmVlOgorCWRtYV9mZW5jZV9wdXQoZik7CisJcmV0dXJuIGVy
cjsKK30KKworc3RhdGljIGludCB0ZXN0X2Vycm9yKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1h
X2ZlbmNlICpmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJZiA9IG1vY2tfZmVuY2UoKTsKKwlp
ZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJZG1hX2ZlbmNlX3NldF9lcnJvcihmLCAtRUlP
KTsKKworCWlmIChkbWFfZmVuY2VfZ2V0X3N0YXR1cyhmKSkgeworCQlwcl9lcnIoIkZlbmNlIHVu
ZXhwZWN0ZWRseSBoYXMgZXJyb3Igc3RhdHVzIGJlZm9yZSBzaWduYWxcbiIpOworCQlnb3RvIGVy
cl9mcmVlOworCX0KKworCWRtYV9mZW5jZV9zaWduYWwoZik7CisJaWYgKGRtYV9mZW5jZV9nZXRf
c3RhdHVzKGYpICE9IC1FSU8pIHsKKwkJcHJfZXJyKCJGZW5jZSBub3QgcmVwb3J0aW5nIGVycm9y
IHN0YXR1cywgZ290ICVkXG4iLAorCQkgICAgICAgZG1hX2ZlbmNlX2dldF9zdGF0dXMoZikpOwor
CQlnb3RvIGVycl9mcmVlOworCX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlkbWFfZmVuY2Vf
cHV0KGYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgdGVzdF93YWl0KHZvaWQgKmFy
ZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmOworCWludCBlcnIgPSAtRUlOVkFMOworCisJZiA9
IG1vY2tfZmVuY2UoKTsKKwlpZiAoIWYpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKGRtYV9m
ZW5jZV93YWl0X3RpbWVvdXQoZiwgZmFsc2UsIDApICE9IC1FVElNRSkgeworCQlwcl9lcnIoIldh
aXQgcmVwb3J0ZWQgY29tcGxldGUgYmVmb3JlIGJlaW5nIHNpZ25hbGVkXG4iKTsKKwkJZ290byBl
cnJfZnJlZTsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCisJaWYgKGRtYV9mZW5jZV93
YWl0X3RpbWVvdXQoZiwgZmFsc2UsIDApICE9IDApIHsKKwkJcHJfZXJyKCJXYWl0IHJlcG9ydGVk
IGluY29tcGxldGUgYWZ0ZXIgYmVpbmcgc2lnbmFsZWRcbiIpOworCQlnb3RvIGVycl9mcmVlOwor
CX0KKworCWVyciA9IDA7CitlcnJfZnJlZToKKwlkbWFfZmVuY2Vfc2lnbmFsKGYpOworCWRtYV9m
ZW5jZV9wdXQoZik7CisJcmV0dXJuIGVycjsKK30KKworc3RydWN0IHdhaXRfdGltZXIgeworCXN0
cnVjdCB0aW1lcl9saXN0IHRpbWVyOworCXN0cnVjdCBkbWFfZmVuY2UgKmY7Cit9OworCitzdGF0
aWMgdm9pZCB3YWl0X3RpbWVyKHN0cnVjdCB0aW1lcl9saXN0ICp0aW1lcikKK3sKKwlzdHJ1Y3Qg
d2FpdF90aW1lciAqd3QgPSBmcm9tX3RpbWVyKHd0LCB0aW1lciwgdGltZXIpOworCisJZG1hX2Zl
bmNlX3NpZ25hbCh3dC0+Zik7Cit9CisKK3N0YXRpYyBpbnQgdGVzdF93YWl0X3RpbWVvdXQodm9p
ZCAqYXJnKQoreworCXN0cnVjdCB3YWl0X3RpbWVyIHd0OworCWludCBlcnIgPSAtRUlOVkFMOwor
CisJdGltZXJfc2V0dXAoJnd0LnRpbWVyLCB3YWl0X3RpbWVyLCAwKTsKKworCXd0LmYgPSBtb2Nr
X2ZlbmNlKCk7CisJaWYgKCF3dC5mKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlmIChkbWFfZmVu
Y2Vfd2FpdF90aW1lb3V0KHd0LmYsIGZhbHNlLCAxKSAhPSAtRVRJTUUpIHsKKwkJcHJfZXJyKCJX
YWl0IHJlcG9ydGVkIGNvbXBsZXRlIGJlZm9yZSBiZWluZyBzaWduYWxlZFxuIik7CisJCWdvdG8g
ZXJyX2ZyZWU7CisJfQorCisJbW9kX3RpbWVyKCZ3dC50aW1lciwgMSk7CisKKwlpZiAoZG1hX2Zl
bmNlX3dhaXRfdGltZW91dCh3dC5mLCBmYWxzZSwgMikgPT0gLUVUSU1FKSB7CisJCWlmICh0aW1l
cl9wZW5kaW5nKCZ3dC50aW1lcikpIHsKKwkJCXByX25vdGljZSgiVGltZXIgZGlkIG5vdCBmaXJl
IHdpdGhpbiB0aGUgamlmZmllIVxuIik7CisJCQllcnIgPSAwOyAvKiBub3Qgb3VyIGZhdWx0ISAq
LworCQl9IGVsc2UgeworCQkJcHJfZXJyKCJXYWl0IHJlcG9ydGVkIGluY29tcGxldGUgYWZ0ZXIg
dGltZW91dFxuIik7CisJCX0KKwkJZ290byBlcnJfZnJlZTsKKwl9CisKKwllcnIgPSAwOworZXJy
X2ZyZWU6CisJZGVsX3RpbWVyX3N5bmMoJnd0LnRpbWVyKTsKKwlkbWFfZmVuY2Vfc2lnbmFsKHd0
LmYpOworCWRtYV9mZW5jZV9wdXQod3QuZik7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIGlu
dCB0ZXN0X3N0dWIodm9pZCAqYXJnKQoreworCXN0cnVjdCBkbWFfZmVuY2UgKmZbNjRdOworCWlu
dCBlcnIgPSAtRUlOVkFMOworCWludCBpOworCisJZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJWkUo
Zik7IGkrKykgeworCQlmW2ldID0gZG1hX2ZlbmNlX2dldF9zdHViKCk7CisJCWlmICghZG1hX2Zl
bmNlX2lzX3NpZ25hbGVkKGZbaV0pKSB7CisJCQlwcl9lcnIoIk9idGFpbmVkIHVuc2lnbmFsZWQg
c3R1YiBmZW5jZSFcbiIpOworCQkJZ290byBlcnI7CisJCX0KKwl9CisKKwllcnIgPSAwOworZXJy
OgorCXdoaWxlIChpLS0pCisJCWRtYV9mZW5jZV9wdXQoZltpXSk7CisJcmV0dXJuIGVycjsKK30K
KworLyogTm93IG9mZiB0byB0aGUgcmFjZXMhICovCisKK3N0cnVjdCByYWNlX3RocmVhZCB7CisJ
c3RydWN0IGRtYV9mZW5jZSBfX3JjdSAqKmZlbmNlczsKKwlzdHJ1Y3QgdGFza19zdHJ1Y3QgKnRh
c2s7CisJYm9vbCBiZWZvcmU7CisJaW50IGlkOworfTsKKworc3RhdGljIHZvaWQgX193YWl0X2Zv
cl9jYWxsYmFja3Moc3RydWN0IGRtYV9mZW5jZSAqZikKK3sKKwlzcGluX2xvY2tfaXJxKGYtPmxv
Y2spOworCXNwaW5fdW5sb2NrX2lycShmLT5sb2NrKTsKK30KKworc3RhdGljIGludCB0aHJlYWRf
c2lnbmFsX2NhbGxiYWNrKHZvaWQgKmFyZykKK3sKKwljb25zdCBzdHJ1Y3QgcmFjZV90aHJlYWQg
KnQgPSBhcmc7CisJdW5zaWduZWQgbG9uZyBwYXNzID0gMDsKKwl1bnNpZ25lZCBsb25nIG1pc3Mg
PSAwOworCWludCBlcnIgPSAwOworCisJd2hpbGUgKCFlcnIgJiYgIWt0aHJlYWRfc2hvdWxkX3N0
b3AoKSkgeworCQlzdHJ1Y3QgZG1hX2ZlbmNlICpmMSwgKmYyOworCQlzdHJ1Y3Qgc2ltcGxlX2Ni
IGNiOworCisJCWYxID0gbW9ja19mZW5jZSgpOworCQlpZiAoIWYxKSB7CisJCQllcnIgPSAtRU5P
TUVNOworCQkJYnJlYWs7CisJCX0KKworCQlyY3VfYXNzaWduX3BvaW50ZXIodC0+ZmVuY2VzW3Qt
PmlkXSwgZjEpOworCQlzbXBfd21iKCk7CisKKwkJcmN1X3JlYWRfbG9jaygpOworCQlkbyB7CisJ
CQlmMiA9IGRtYV9mZW5jZV9nZXRfcmN1X3NhZmUoJnQtPmZlbmNlc1shdC0+aWRdKTsKKwkJfSB3
aGlsZSAoIWYyICYmICFrdGhyZWFkX3Nob3VsZF9zdG9wKCkpOworCQlyY3VfcmVhZF91bmxvY2so
KTsKKworCQlpZiAodC0+YmVmb3JlKQorCQkJZG1hX2ZlbmNlX3NpZ25hbChmMSk7CisKKwkJc21w
X3N0b3JlX21iKGNiLnNlZW4sIGZhbHNlKTsKKwkJaWYgKCFmMiB8fCBkbWFfZmVuY2VfYWRkX2Nh
bGxiYWNrKGYyLCAmY2IuY2IsIHNpbXBsZV9jYWxsYmFjaykpCisJCQltaXNzKyssIGNiLnNlZW4g
PSB0cnVlOworCisJCWlmICghdC0+YmVmb3JlKQorCQkJZG1hX2ZlbmNlX3NpZ25hbChmMSk7CisK
KwkJaWYgKCFjYi5zZWVuKSB7CisJCQlkbWFfZmVuY2Vfd2FpdChmMiwgZmFsc2UpOworCQkJX193
YWl0X2Zvcl9jYWxsYmFja3MoZjIpOworCQl9CisKKwkJaWYgKCFSRUFEX09OQ0UoY2Iuc2Vlbikp
IHsKKwkJCXByX2VycigiQ2FsbGJhY2sgbm90IHNlZW4gb24gdGhyZWFkICVkLCBwYXNzICVsdSAo
JWx1IG1pc3NlcyksIHNpZ25hbGluZyAlcyBhZGRfY2FsbGJhY2s7IGZlbmNlIHNpZ25hbGVkPyAl
c1xuIiwKKwkJCSAgICAgICB0LT5pZCwgcGFzcywgbWlzcywKKwkJCSAgICAgICB0LT5iZWZvcmUg
PyAiYmVmb3JlIiA6ICJhZnRlciIsCisJCQkgICAgICAgZG1hX2ZlbmNlX2lzX3NpZ25hbGVkKGYy
KSA/ICJ5ZXMiIDogIm5vIik7CisJCQllcnIgPSAtRUlOVkFMOworCQl9CisKKwkJZG1hX2ZlbmNl
X3B1dChmMik7CisKKwkJcmN1X2Fzc2lnbl9wb2ludGVyKHQtPmZlbmNlc1t0LT5pZF0sIE5VTEwp
OworCQlzbXBfd21iKCk7CisKKwkJZG1hX2ZlbmNlX3B1dChmMSk7CisKKwkJcGFzcysrOworCX0K
KworCXByX2luZm8oIiVzWyVkXSBjb21wbGV0ZWQgJWx1IHBhc3NlcywgJWx1IG1pc3Nlc1xuIiwK
KwkJX19mdW5jX18sIHQtPmlkLCBwYXNzLCBtaXNzKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0
aWMgaW50IHJhY2Vfc2lnbmFsX2NhbGxiYWNrKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1hX2Zl
bmNlIF9fcmN1ICpmWzJdID0ge307CisJaW50IHJldCA9IDA7CisJaW50IHBhc3M7CisKKwlmb3Ig
KHBhc3MgPSAwOyAhcmV0ICYmIHBhc3MgPD0gMTsgcGFzcysrKSB7CisJCXN0cnVjdCByYWNlX3Ro
cmVhZCB0WzJdOworCQlpbnQgaTsKKworCQlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRSh0KTsg
aSsrKSB7CisJCQl0W2ldLmZlbmNlcyA9IGY7CisJCQl0W2ldLmlkID0gaTsKKwkJCXRbaV0uYmVm
b3JlID0gcGFzczsKKwkJCXRbaV0udGFzayA9IGt0aHJlYWRfcnVuKHRocmVhZF9zaWduYWxfY2Fs
bGJhY2ssICZ0W2ldLAorCQkJCQkJImRtYS1mZW5jZTolZCIsIGkpOworCQkJZ2V0X3Rhc2tfc3Ry
dWN0KHRbaV0udGFzayk7CisJCX0KKworCQltc2xlZXAoNTApOworCisJCWZvciAoaSA9IDA7IGkg
PCBBUlJBWV9TSVpFKHQpOyBpKyspIHsKKwkJCWludCBlcnI7CisKKwkJCWVyciA9IGt0aHJlYWRf
c3RvcCh0W2ldLnRhc2spOworCQkJaWYgKGVyciAmJiAhcmV0KQorCQkJCXJldCA9IGVycjsKKwor
CQkJcHV0X3Rhc2tfc3RydWN0KHRbaV0udGFzayk7CisJCX0KKwl9CisKKwlyZXR1cm4gcmV0Owor
fQorCitpbnQgZG1hX2ZlbmNlKHZvaWQpCit7CisJc3RhdGljIGNvbnN0IHN0cnVjdCBzdWJ0ZXN0
IHRlc3RzW10gPSB7CisJCVNVQlRFU1Qoc2FuaXR5Y2hlY2spLAorCQlTVUJURVNUKHRlc3Rfc2ln
bmFsaW5nKSwKKwkJU1VCVEVTVCh0ZXN0X2FkZF9jYWxsYmFjayksCisJCVNVQlRFU1QodGVzdF9s
YXRlX2FkZF9jYWxsYmFjayksCisJCVNVQlRFU1QodGVzdF9ybV9jYWxsYmFjayksCisJCVNVQlRF
U1QodGVzdF9sYXRlX3JtX2NhbGxiYWNrKSwKKwkJU1VCVEVTVCh0ZXN0X3N0YXR1cyksCisJCVNV
QlRFU1QodGVzdF9lcnJvciksCisJCVNVQlRFU1QodGVzdF93YWl0KSwKKwkJU1VCVEVTVCh0ZXN0
X3dhaXRfdGltZW91dCksCisJCVNVQlRFU1QodGVzdF9zdHViKSwKKwkJU1VCVEVTVChyYWNlX3Np
Z25hbF9jYWxsYmFjayksCisJfTsKKwlpbnQgcmV0OworCisJcHJfaW5mbygic2l6ZW9mKGRtYV9m
ZW5jZSk9JWx1XG4iLCBzaXplb2Yoc3RydWN0IGRtYV9mZW5jZSkpOworCisJc2xhYl9mZW5jZXMg
PSBLTUVNX0NBQ0hFKG1vY2tfZmVuY2UsCisJCQkJIFNMQUJfVFlQRVNBRkVfQllfUkNVIHwKKwkJ
CQkgU0xBQl9IV0NBQ0hFX0FMSUdOKTsKKworCXJldCA9IHN1YnRlc3RzKHRlc3RzLCBOVUxMKTsK
KworCWttZW1fY2FjaGVfZGVzdHJveShzbGFiX2ZlbmNlcyk7CisKKwlyZXR1cm4gcmV0OworfQot
LSAKMi4yMy4wLnJjMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Au
b3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRl
dmVs
