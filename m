Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 11FECE1FBE
	for <lists+dri-devel@lfdr.de>; Wed, 23 Oct 2019 17:45:30 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E7F81891B3;
	Wed, 23 Oct 2019 15:45:26 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from bhuna.collabora.co.uk (bhuna.collabora.co.uk [46.235.227.227])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6D45B6EB1B
 for <dri-devel@lists.freedesktop.org>; Wed, 23 Oct 2019 15:45:25 +0000 (UTC)
Received: from localhost.localdomain (unknown
 [IPv6:2a01:e0a:2c:6930:5cf4:84a1:2763:fe0d])
 (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
 (No client certificate requested) (Authenticated sender: bbrezillon)
 by bhuna.collabora.co.uk (Postfix) with ESMTPSA id 88DC928F903;
 Wed, 23 Oct 2019 16:45:23 +0100 (BST)
From: Boris Brezillon <boris.brezillon@collabora.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v3 07/21] drm/bridge: Make the bridge chain a double-linked
 list
Date: Wed, 23 Oct 2019 17:44:58 +0200
Message-Id: <20191023154512.9762-8-boris.brezillon@collabora.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20191023154512.9762-1-boris.brezillon@collabora.com>
References: <20191023154512.9762-1-boris.brezillon@collabora.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Mark Rutland <mark.rutland@arm.com>,
 Neil Armstrong <narmstrong@baylibre.com>,
 Thierry Reding <thierry.reding@gmail.com>,
 Laurent Pinchart <Laurent.pinchart@ideasonboard.com>, kernel@collabora.com,
 Sam Ravnborg <sam@ravnborg.org>,
 Nikita Yushchenko <nikita.yoush@cogentembedded.com>,
 Andrey Smirnov <andrew.smirnov@gmail.com>,
 Kyungmin Park <kyungmin.park@samsung.com>, Chris Healy <cphealy@gmail.com>,
 devicetree@vger.kernel.org, Jonas Karlman <jonas@kwiboo.se>,
 Rob Herring <robh+dt@kernel.org>, Jernej Skrabec <jernej.skrabec@siol.net>,
 Seung-Woo Kim <sw0312.kim@samsung.com>,
 Boris Brezillon <boris.brezillon@collabora.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U28gdGhhdCBlYWNoIGVsZW1lbnQgaW4gdGhlIGNoYWluIGNhbiBlYXNpbHkgYWNjZXNzIGl0cyBw
cmVkZWNlc3Nvci4KVGhpcyB3aWxsIGJlIG5lZWRlZCB0byBzdXBwb3J0IGJ1cyBmb3JtYXQgbmVn
b3RpYXRpb24gYmV0d2VlbiBlbGVtZW50cwpvZiB0aGUgYnJpZGdlIGNoYWluLgoKU2lnbmVkLW9m
Zi1ieTogQm9yaXMgQnJlemlsbG9uIDxib3Jpcy5icmV6aWxsb25AY29sbGFib3JhLmNvbT4KLS0t
CkNoYW5nZXMgaW4gdjM6CiogTm9uZQoKQ2hhbmdlcyBpbiB2MjoKKiBBZGp1c3QgdGhpbmdzIHRv
IHRoZSAiZHVtbXkgZW5jb2RlciBicmlkZ2UiIGNoYW5nZSAocGF0Y2ggMiBpbiB0aGlzCiAgc2Vy
aWVzKQotLS0KIGRyaXZlcnMvZ3B1L2RybS9kcm1fYnJpZGdlLmMgIHwgMTcxICsrKysrKysrKysr
KysrKysrKysrKystLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9kcm1fZW5jb2Rlci5jIHwg
IDE2ICstLS0KIGluY2x1ZGUvZHJtL2RybV9icmlkZ2UuaCAgICAgIHwgIDEyICsrLQogaW5jbHVk
ZS9kcm0vZHJtX2VuY29kZXIuaCAgICAgfCAgIDkgKy0KIDQgZmlsZXMgY2hhbmdlZCwgMTM1IGlu
c2VydGlvbnMoKyksIDczIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9kcm1fYnJpZGdlLmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2JyaWRnZS5jCmluZGV4IDU0Yzg3
NDQ5M2M1Ny4uYzVjZjhhOWM0MjM3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2Jy
aWRnZS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fYnJpZGdlLmMKQEAgLTU1LDcgKzU1LDcg
QEAKICAqIGp1c3QgcHJvdmlkZSBhZGRpdGlvbmFsIGhvb2tzIHRvIGdldCB0aGUgZGVzaXJlZCBv
dXRwdXQgYXQgdGhlIGVuZCBvZiB0aGUKICAqIGVuY29kZXIgY2hhaW4uCiAgKgotICogQnJpZGdl
cyBjYW4gYWxzbyBiZSBjaGFpbmVkIHVwIHVzaW5nIHRoZSAmZHJtX2JyaWRnZS5uZXh0IHBvaW50
ZXIuCisgKiBCcmlkZ2VzIGNhbiBhbHNvIGJlIGNoYWluZWQgdXAgdXNpbmcgdGhlICZkcm1fYnJp
ZGdlLmNoYWluX25vZGUgZmllbGQuCiAgKgogICogQm90aCBsZWdhY3kgQ1JUQyBoZWxwZXJzIGFu
ZCB0aGUgbmV3IGF0b21pYyBtb2Rlc2V0IGhlbHBlcnMgc3VwcG9ydCBicmlkZ2VzLgogICovCkBA
IC0xMTQsNiArMTE0LDcgQEAgRVhQT1JUX1NZTUJPTChkcm1fYnJpZGdlX3JlbW92ZSk7CiBpbnQg
ZHJtX2JyaWRnZV9hdHRhY2goc3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVyLCBzdHJ1Y3QgZHJt
X2JyaWRnZSAqYnJpZGdlLAogCQkgICAgICBzdHJ1Y3QgZHJtX2JyaWRnZSAqcHJldmlvdXMpCiB7
CisJTElTVF9IRUFEKHRtcF9saXN0KTsKIAlpbnQgcmV0OwogCiAJaWYgKCFlbmNvZGVyIHx8ICFi
cmlkZ2UpCkBAIC0xMjcsNiArMTI4LDcgQEAgaW50IGRybV9icmlkZ2VfYXR0YWNoKHN0cnVjdCBk
cm1fZW5jb2RlciAqZW5jb2Rlciwgc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKIAogCWJyaWRn
ZS0+ZGV2ID0gZW5jb2Rlci0+ZGV2OwogCWJyaWRnZS0+ZW5jb2RlciA9IGVuY29kZXI7CisJbGlz
dF9hZGRfdGFpbCgmYnJpZGdlLT5jaGFpbl9ub2RlLCAmdG1wX2xpc3QpOwogCiAJaWYgKGJyaWRn
ZS0+ZnVuY3MtPmF0dGFjaCkgewogCQlyZXQgPSBicmlkZ2UtPmZ1bmNzLT5hdHRhY2goYnJpZGdl
KTsKQEAgLTEzOCw5ICsxNDAsOSBAQCBpbnQgZHJtX2JyaWRnZV9hdHRhY2goc3RydWN0IGRybV9l
bmNvZGVyICplbmNvZGVyLCBzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAogCX0KIAogCWlmIChw
cmV2aW91cykKLQkJcHJldmlvdXMtPm5leHQgPSBicmlkZ2U7CisJCWxpc3Rfc3BsaWNlKCZ0bXBf
bGlzdCwgJnByZXZpb3VzLT5jaGFpbl9ub2RlKTsKIAllbHNlCi0JCWVuY29kZXItPmJyaWRnZSA9
IGJyaWRnZTsKKwkJbGlzdF9zcGxpY2UoJnRtcF9saXN0LCAmZW5jb2Rlci0+YnJpZGdlX2NoYWlu
KTsKIAogCXJldHVybiAwOwogfQpAQCAtMTU3LDYgKzE1OSw3IEBAIHZvaWQgZHJtX2JyaWRnZV9k
ZXRhY2goc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSkKIAlpZiAoYnJpZGdlLT5mdW5jcy0+ZGV0
YWNoKQogCQlicmlkZ2UtPmZ1bmNzLT5kZXRhY2goYnJpZGdlKTsKIAorCWxpc3RfZGVsKCZicmlk
Z2UtPmNoYWluX25vZGUpOwogCWJyaWRnZS0+ZGV2ID0gTlVMTDsKIH0KIApAQCAtMTkwLDE4ICsx
OTMsMjIgQEAgYm9vbCBkcm1fYnJpZGdlX2NoYWluX21vZGVfZml4dXAoc3RydWN0IGRybV9icmlk
Z2UgKmJyaWRnZSwKIAkJCQkgY29uc3Qgc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKm1vZGUsCiAJ
CQkJIHN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICphZGp1c3RlZF9tb2RlKQogewotCWJvb2wgcmV0
ID0gdHJ1ZTsKKwlzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29kZXI7CiAKIAlpZiAoIWJyaWRnZSkK
IAkJcmV0dXJuIHRydWU7CiAKLQlpZiAoYnJpZGdlLT5mdW5jcy0+bW9kZV9maXh1cCkKLQkJcmV0
ID0gYnJpZGdlLT5mdW5jcy0+bW9kZV9maXh1cChicmlkZ2UsIG1vZGUsIGFkanVzdGVkX21vZGUp
OworCWVuY29kZXIgPSBicmlkZ2UtPmVuY29kZXI7CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9mcm9t
KGJyaWRnZSwgJmVuY29kZXItPmJyaWRnZV9jaGFpbiwKKwkJCQkgY2hhaW5fbm9kZSkgeworCQlp
ZiAoIWJyaWRnZS0+ZnVuY3MtPm1vZGVfZml4dXApCisJCQljb250aW51ZTsKIAotCXJldCA9IHJl
dCAmJiBkcm1fYnJpZGdlX2NoYWluX21vZGVfZml4dXAoYnJpZGdlLT5uZXh0LCBtb2RlLAotCQkJ
CQkJIGFkanVzdGVkX21vZGUpOworCQlpZiAoIWJyaWRnZS0+ZnVuY3MtPm1vZGVfZml4dXAoYnJp
ZGdlLCBtb2RlLCBhZGp1c3RlZF9tb2RlKSkKKwkJCXJldHVybiBmYWxzZTsKKwl9CiAKLQlyZXR1
cm4gcmV0OworCXJldHVybiB0cnVlOwogfQogRVhQT1JUX1NZTUJPTChkcm1fYnJpZGdlX2NoYWlu
X21vZGVfZml4dXApOwogCkBAIC0yMjQsMTggKzIzMSwyNCBAQCBlbnVtIGRybV9tb2RlX3N0YXR1
cwogZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3ZhbGlkKHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2Us
CiAJCQkgICAgY29uc3Qgc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKm1vZGUpCiB7Ci0JZW51bSBk
cm1fbW9kZV9zdGF0dXMgcmV0ID0gTU9ERV9PSzsKKwlzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29k
ZXI7CiAKIAlpZiAoIWJyaWRnZSkKLQkJcmV0dXJuIHJldDsKKwkJcmV0dXJuIE1PREVfT0s7CisK
KwllbmNvZGVyID0gYnJpZGdlLT5lbmNvZGVyOworCWxpc3RfZm9yX2VhY2hfZW50cnlfZnJvbShi
cmlkZ2UsICZlbmNvZGVyLT5icmlkZ2VfY2hhaW4sIGNoYWluX25vZGUpIHsKKwkJZW51bSBkcm1f
bW9kZV9zdGF0dXMgcmV0OworCisJCWlmICghYnJpZGdlLT5mdW5jcy0+bW9kZV92YWxpZCkKKwkJ
CWNvbnRpbnVlOwogCi0JaWYgKGJyaWRnZS0+ZnVuY3MtPm1vZGVfdmFsaWQpCiAJCXJldCA9IGJy
aWRnZS0+ZnVuY3MtPm1vZGVfdmFsaWQoYnJpZGdlLCBtb2RlKTsKKwkJaWYgKHJldCAhPSBNT0RF
X09LKQorCQkJcmV0dXJuIHJldDsKKwl9CiAKLQlpZiAocmV0ICE9IE1PREVfT0spCi0JCXJldHVy
biByZXQ7Ci0KLQlyZXR1cm4gZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3ZhbGlkKGJyaWRnZS0+bmV4
dCwgbW9kZSk7CisJcmV0dXJuIE1PREVfT0s7CiB9CiBFWFBPUlRfU1lNQk9MKGRybV9icmlkZ2Vf
Y2hhaW5fbW9kZV92YWxpZCk7CiAKQEAgLTI1MSwxMyArMjY0LDIwIEBAIEVYUE9SVF9TWU1CT0wo
ZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3ZhbGlkKTsKICAqLwogdm9pZCBkcm1fYnJpZGdlX2NoYWlu
X2Rpc2FibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSkKIHsKKwlzdHJ1Y3QgZHJtX2VuY29k
ZXIgKmVuY29kZXI7CisJc3RydWN0IGRybV9icmlkZ2UgKml0ZXI7CisKIAlpZiAoIWJyaWRnZSkK
IAkJcmV0dXJuOwogCi0JZHJtX2JyaWRnZV9jaGFpbl9kaXNhYmxlKGJyaWRnZS0+bmV4dCk7CisJ
ZW5jb2RlciA9IGJyaWRnZS0+ZW5jb2RlcjsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3JldmVyc2Uo
aXRlciwgJmVuY29kZXItPmJyaWRnZV9jaGFpbiwgY2hhaW5fbm9kZSkgeworCQlpZiAoaXRlci0+
ZnVuY3MtPmRpc2FibGUpCisJCQlpdGVyLT5mdW5jcy0+ZGlzYWJsZShpdGVyKTsKIAotCWlmIChi
cmlkZ2UtPmZ1bmNzLT5kaXNhYmxlKQotCQlicmlkZ2UtPmZ1bmNzLT5kaXNhYmxlKGJyaWRnZSk7
CisJCWlmIChpdGVyID09IGJyaWRnZSkKKwkJCWJyZWFrOworCX0KIH0KIEVYUE9SVF9TWU1CT0wo
ZHJtX2JyaWRnZV9jaGFpbl9kaXNhYmxlKTsKIApAQCAtMjc0LDEzICsyOTQsMTYgQEAgRVhQT1JU
X1NZTUJPTChkcm1fYnJpZGdlX2NoYWluX2Rpc2FibGUpOwogICovCiB2b2lkIGRybV9icmlkZ2Vf
Y2hhaW5fcG9zdF9kaXNhYmxlKHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UpCiB7CisJc3RydWN0
IGRybV9lbmNvZGVyICplbmNvZGVyOworCiAJaWYgKCFicmlkZ2UpCiAJCXJldHVybjsKIAotCWlm
IChicmlkZ2UtPmZ1bmNzLT5wb3N0X2Rpc2FibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPnBvc3RfZGlz
YWJsZShicmlkZ2UpOwotCi0JZHJtX2JyaWRnZV9jaGFpbl9wb3N0X2Rpc2FibGUoYnJpZGdlLT5u
ZXh0KTsKKwllbmNvZGVyID0gYnJpZGdlLT5lbmNvZGVyOworCWxpc3RfZm9yX2VhY2hfZW50cnlf
ZnJvbShicmlkZ2UsICZlbmNvZGVyLT5icmlkZ2VfY2hhaW4sIGNoYWluX25vZGUpIHsKKwkJaWYg
KGJyaWRnZS0+ZnVuY3MtPnBvc3RfZGlzYWJsZSkKKwkJCWJyaWRnZS0+ZnVuY3MtPnBvc3RfZGlz
YWJsZShicmlkZ2UpOworCX0KIH0KIEVYUE9SVF9TWU1CT0woZHJtX2JyaWRnZV9jaGFpbl9wb3N0
X2Rpc2FibGUpOwogCkBAIC0zMDAsMTMgKzMyMywxNiBAQCB2b2lkIGRybV9icmlkZ2VfY2hhaW5f
bW9kZV9zZXQoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKIAkJCSAgICAgICBjb25zdCBzdHJ1
Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqbW9kZSwKIAkJCSAgICAgICBjb25zdCBzdHJ1Y3QgZHJtX2Rp
c3BsYXlfbW9kZSAqYWRqdXN0ZWRfbW9kZSkKIHsKKwlzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29k
ZXI7CisKIAlpZiAoIWJyaWRnZSkKIAkJcmV0dXJuOwogCi0JaWYgKGJyaWRnZS0+ZnVuY3MtPm1v
ZGVfc2V0KQotCQlicmlkZ2UtPmZ1bmNzLT5tb2RlX3NldChicmlkZ2UsIG1vZGUsIGFkanVzdGVk
X21vZGUpOwotCi0JZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3NldChicmlkZ2UtPm5leHQsIG1vZGUs
IGFkanVzdGVkX21vZGUpOworCWVuY29kZXIgPSBicmlkZ2UtPmVuY29kZXI7CisJbGlzdF9mb3Jf
ZWFjaF9lbnRyeV9mcm9tKGJyaWRnZSwgJmVuY29kZXItPmJyaWRnZV9jaGFpbiwgY2hhaW5fbm9k
ZSkgeworCQlpZiAoYnJpZGdlLT5mdW5jcy0+bW9kZV9zZXQpCisJCQlicmlkZ2UtPmZ1bmNzLT5t
b2RlX3NldChicmlkZ2UsIG1vZGUsIGFkanVzdGVkX21vZGUpOworCX0KIH0KIEVYUE9SVF9TWU1C
T0woZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3NldCk7CiAKQEAgLTMyMywxMyArMzQ5LDE3IEBAIEVY
UE9SVF9TWU1CT0woZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3NldCk7CiAgKi8KIHZvaWQgZHJtX2Jy
aWRnZV9jaGFpbl9wcmVfZW5hYmxlKHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UpCiB7CisJc3Ry
dWN0IGRybV9lbmNvZGVyICplbmNvZGVyOworCXN0cnVjdCBkcm1fYnJpZGdlICppdGVyOworCiAJ
aWYgKCFicmlkZ2UpCiAJCXJldHVybjsKIAotCWRybV9icmlkZ2VfY2hhaW5fcHJlX2VuYWJsZShi
cmlkZ2UtPm5leHQpOwotCi0JaWYgKGJyaWRnZS0+ZnVuY3MtPnByZV9lbmFibGUpCi0JCWJyaWRn
ZS0+ZnVuY3MtPnByZV9lbmFibGUoYnJpZGdlKTsKKwllbmNvZGVyID0gYnJpZGdlLT5lbmNvZGVy
OworCWxpc3RfZm9yX2VhY2hfZW50cnlfcmV2ZXJzZShpdGVyLCAmZW5jb2Rlci0+YnJpZGdlX2No
YWluLCBjaGFpbl9ub2RlKSB7CisJCWlmIChpdGVyLT5mdW5jcy0+cHJlX2VuYWJsZSkKKwkJCWl0
ZXItPmZ1bmNzLT5wcmVfZW5hYmxlKGl0ZXIpOworCX0KIH0KIEVYUE9SVF9TWU1CT0woZHJtX2Jy
aWRnZV9jaGFpbl9wcmVfZW5hYmxlKTsKIApAQCAtMzQ1LDEzICszNzUsMTYgQEAgRVhQT1JUX1NZ
TUJPTChkcm1fYnJpZGdlX2NoYWluX3ByZV9lbmFibGUpOwogICovCiB2b2lkIGRybV9icmlkZ2Vf
Y2hhaW5fZW5hYmxlKHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UpCiB7CisJc3RydWN0IGRybV9l
bmNvZGVyICplbmNvZGVyOworCiAJaWYgKCFicmlkZ2UpCiAJCXJldHVybjsKIAotCWlmIChicmlk
Z2UtPmZ1bmNzLT5lbmFibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPmVuYWJsZShicmlkZ2UpOwotCi0J
ZHJtX2JyaWRnZV9jaGFpbl9lbmFibGUoYnJpZGdlLT5uZXh0KTsKKwllbmNvZGVyID0gYnJpZGdl
LT5lbmNvZGVyOworCWxpc3RfZm9yX2VhY2hfZW50cnlfZnJvbShicmlkZ2UsICZlbmNvZGVyLT5i
cmlkZ2VfY2hhaW4sIGNoYWluX25vZGUpIHsKKwkJaWYgKGJyaWRnZS0+ZnVuY3MtPmVuYWJsZSkK
KwkJCWJyaWRnZS0+ZnVuY3MtPmVuYWJsZShicmlkZ2UpOworCX0KIH0KIEVYUE9SVF9TWU1CT0wo
ZHJtX2JyaWRnZV9jaGFpbl9lbmFibGUpOwogCkBAIC0zNzAsMTUgKzQwMywyMyBAQCBFWFBPUlRf
U1lNQk9MKGRybV9icmlkZ2VfY2hhaW5fZW5hYmxlKTsKIHZvaWQgZHJtX2F0b21pY19icmlkZ2Vf
Y2hhaW5fZGlzYWJsZShzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAogCQkJCSAgICAgc3RydWN0
IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQogeworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2Rl
cjsKKwlzdHJ1Y3QgZHJtX2JyaWRnZSAqaXRlcjsKKwogCWlmICghYnJpZGdlKQogCQlyZXR1cm47
CiAKLQlkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9kaXNhYmxlKGJyaWRnZS0+bmV4dCwgc3RhdGUp
OworCWVuY29kZXIgPSBicmlkZ2UtPmVuY29kZXI7CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9yZXZl
cnNlKGl0ZXIsICZlbmNvZGVyLT5icmlkZ2VfY2hhaW4sCisJCQkJICAgIGNoYWluX25vZGUpIHsK
KwkJaWYgKGl0ZXItPmZ1bmNzLT5hdG9taWNfZGlzYWJsZSkKKwkJCWl0ZXItPmZ1bmNzLT5hdG9t
aWNfZGlzYWJsZShpdGVyLCBzdGF0ZSk7CisJCWVsc2UgaWYgKGl0ZXItPmZ1bmNzLT5kaXNhYmxl
KQorCQkJaXRlci0+ZnVuY3MtPmRpc2FibGUoaXRlcik7CiAKLQlpZiAoYnJpZGdlLT5mdW5jcy0+
YXRvbWljX2Rpc2FibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPmF0b21pY19kaXNhYmxlKGJyaWRnZSwg
c3RhdGUpOwotCWVsc2UgaWYgKGJyaWRnZS0+ZnVuY3MtPmRpc2FibGUpCi0JCWJyaWRnZS0+ZnVu
Y3MtPmRpc2FibGUoYnJpZGdlKTsKKwkJaWYgKGl0ZXIgPT0gYnJpZGdlKQorCQkJYnJlYWs7CisJ
fQogfQogRVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9kaXNhYmxlKTsKIApA
QCAtMzk4LDE1ICs0MzksMTkgQEAgRVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFp
bl9kaXNhYmxlKTsKIHZvaWQgZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fcG9zdF9kaXNhYmxlKHN0
cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UsCiAJCQkJCSAgc3RydWN0IGRybV9hdG9taWNfc3RhdGUg
KnN0YXRlKQogeworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcjsKKwogCWlmICghYnJpZGdl
KQogCQlyZXR1cm47CiAKLQlpZiAoYnJpZGdlLT5mdW5jcy0+YXRvbWljX3Bvc3RfZGlzYWJsZSkK
LQkJYnJpZGdlLT5mdW5jcy0+YXRvbWljX3Bvc3RfZGlzYWJsZShicmlkZ2UsIHN0YXRlKTsKLQll
bHNlIGlmIChicmlkZ2UtPmZ1bmNzLT5wb3N0X2Rpc2FibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPnBv
c3RfZGlzYWJsZShicmlkZ2UpOwotCi0JZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fcG9zdF9kaXNh
YmxlKGJyaWRnZS0+bmV4dCwgc3RhdGUpOworCWVuY29kZXIgPSBicmlkZ2UtPmVuY29kZXI7CisJ
bGlzdF9mb3JfZWFjaF9lbnRyeV9mcm9tKGJyaWRnZSwgJmVuY29kZXItPmJyaWRnZV9jaGFpbiwK
KwkJCQkgY2hhaW5fbm9kZSkgeworCQlpZiAoYnJpZGdlLT5mdW5jcy0+YXRvbWljX3Bvc3RfZGlz
YWJsZSkKKwkJCWJyaWRnZS0+ZnVuY3MtPmF0b21pY19wb3N0X2Rpc2FibGUoYnJpZGdlLCBzdGF0
ZSk7CisJCWVsc2UgaWYgKGJyaWRnZS0+ZnVuY3MtPnBvc3RfZGlzYWJsZSkKKwkJCWJyaWRnZS0+
ZnVuY3MtPnBvc3RfZGlzYWJsZShicmlkZ2UpOworCX0KIH0KIEVYUE9SVF9TWU1CT0woZHJtX2F0
b21pY19icmlkZ2VfY2hhaW5fcG9zdF9kaXNhYmxlKTsKIApAQCAtNDI2LDE1ICs0NzEsMjMgQEAg
RVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9wb3N0X2Rpc2FibGUpOwogdm9p
ZCBkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9wcmVfZW5hYmxlKHN0cnVjdCBkcm1fYnJpZGdlICpi
cmlkZ2UsCiAJCQkJCXN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkKIHsKKwlzdHJ1Y3Qg
ZHJtX2VuY29kZXIgKmVuY29kZXI7CisJc3RydWN0IGRybV9icmlkZ2UgKml0ZXI7CisKIAlpZiAo
IWJyaWRnZSkKIAkJcmV0dXJuOwogCi0JZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fcHJlX2VuYWJs
ZShicmlkZ2UtPm5leHQsIHN0YXRlKTsKKwllbmNvZGVyID0gYnJpZGdlLT5lbmNvZGVyOworCWxp
c3RfZm9yX2VhY2hfZW50cnlfcmV2ZXJzZShpdGVyLCAmYnJpZGdlLT5lbmNvZGVyLT5icmlkZ2Vf
Y2hhaW4sCisJCQkJICAgIGNoYWluX25vZGUpIHsKKwkJaWYgKGl0ZXItPmZ1bmNzLT5hdG9taWNf
cHJlX2VuYWJsZSkKKwkJCWl0ZXItPmZ1bmNzLT5hdG9taWNfcHJlX2VuYWJsZShpdGVyLCBzdGF0
ZSk7CisJCWVsc2UgaWYgKGl0ZXItPmZ1bmNzLT5wcmVfZW5hYmxlKQorCQkJaXRlci0+ZnVuY3Mt
PnByZV9lbmFibGUoaXRlcik7CiAKLQlpZiAoYnJpZGdlLT5mdW5jcy0+YXRvbWljX3ByZV9lbmFi
bGUpCi0JCWJyaWRnZS0+ZnVuY3MtPmF0b21pY19wcmVfZW5hYmxlKGJyaWRnZSwgc3RhdGUpOwot
CWVsc2UgaWYgKGJyaWRnZS0+ZnVuY3MtPnByZV9lbmFibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPnBy
ZV9lbmFibGUoYnJpZGdlKTsKKwkJaWYgKGl0ZXIgPT0gYnJpZGdlKQorCQkJYnJlYWs7CisJfQog
fQogRVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9wcmVfZW5hYmxlKTsKIApA
QCAtNDUzLDE1ICs1MDYsMTkgQEAgRVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFp
bl9wcmVfZW5hYmxlKTsKIHZvaWQgZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fZW5hYmxlKHN0cnVj
dCBkcm1fYnJpZGdlICpicmlkZ2UsCiAJCQkJICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpz
dGF0ZSkKIHsKKwlzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29kZXI7CisKIAlpZiAoIWJyaWRnZSkK
IAkJcmV0dXJuOwogCi0JaWYgKGJyaWRnZS0+ZnVuY3MtPmF0b21pY19lbmFibGUpCi0JCWJyaWRn
ZS0+ZnVuY3MtPmF0b21pY19lbmFibGUoYnJpZGdlLCBzdGF0ZSk7Ci0JZWxzZSBpZiAoYnJpZGdl
LT5mdW5jcy0+ZW5hYmxlKQotCQlicmlkZ2UtPmZ1bmNzLT5lbmFibGUoYnJpZGdlKTsKLQotCWRy
bV9hdG9taWNfYnJpZGdlX2NoYWluX2VuYWJsZShicmlkZ2UtPm5leHQsIHN0YXRlKTsKKwllbmNv
ZGVyID0gYnJpZGdlLT5lbmNvZGVyOworCWxpc3RfZm9yX2VhY2hfZW50cnlfZnJvbShicmlkZ2Us
ICZicmlkZ2UtPmVuY29kZXItPmJyaWRnZV9jaGFpbiwKKwkJCQkgY2hhaW5fbm9kZSkgeworCQlp
ZiAoYnJpZGdlLT5mdW5jcy0+YXRvbWljX2VuYWJsZSkKKwkJCWJyaWRnZS0+ZnVuY3MtPmF0b21p
Y19lbmFibGUoYnJpZGdlLCBzdGF0ZSk7CisJCWVsc2UgaWYgKGJyaWRnZS0+ZnVuY3MtPmVuYWJs
ZSkKKwkJCWJyaWRnZS0+ZnVuY3MtPmVuYWJsZShicmlkZ2UpOworCX0KIH0KIEVYUE9SVF9TWU1C
T0woZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fZW5hYmxlKTsKIApkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2RybV9lbmNvZGVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2VuY29kZXIuYwpp
bmRleCA0ZmU5ZTcyM2UyMjcuLmU1NTUyODFmNDNkNCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUv
ZHJtL2RybV9lbmNvZGVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2RybV9lbmNvZGVyLmMKQEAg
LTE0MCw2ICsxNDAsNyBAQCBpbnQgZHJtX2VuY29kZXJfaW5pdChzdHJ1Y3QgZHJtX2RldmljZSAq
ZGV2LAogCQlnb3RvIG91dF9wdXQ7CiAJfQogCisJSU5JVF9MSVNUX0hFQUQoJmVuY29kZXItPmJy
aWRnZV9jaGFpbik7CiAJbGlzdF9hZGRfdGFpbCgmZW5jb2Rlci0+aGVhZCwgJmRldi0+bW9kZV9j
b25maWcuZW5jb2Rlcl9saXN0KTsKIAllbmNvZGVyLT5pbmRleCA9IGRldi0+bW9kZV9jb25maWcu
bnVtX2VuY29kZXIrKzsKIApAQCAtMTYwLDIzICsxNjEsMTYgQEAgRVhQT1JUX1NZTUJPTChkcm1f
ZW5jb2Rlcl9pbml0KTsKIHZvaWQgZHJtX2VuY29kZXJfY2xlYW51cChzdHJ1Y3QgZHJtX2VuY29k
ZXIgKmVuY29kZXIpCiB7CiAJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGVuY29kZXItPmRldjsK
KwlzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLCAqbmV4dDsKIAogCS8qIE5vdGUgdGhhdCB0aGUg
ZW5jb2Rlcl9saXN0IGlzIGNvbnNpZGVyZWQgdG8gYmUgc3RhdGljOyBzaG91bGQgd2UKIAkgKiBy
ZW1vdmUgdGhlIGRybV9lbmNvZGVyIGF0IHJ1bnRpbWUgd2Ugd291bGQgaGF2ZSB0byBkZWNyZW1l
bnQgYWxsCiAJICogdGhlIGluZGljZXMgb24gdGhlIGRybV9lbmNvZGVyIGFmdGVyIHVzIGluIHRo
ZSBlbmNvZGVyX2xpc3QuCiAJICovCiAKLQlpZiAoZW5jb2Rlci0+YnJpZGdlKSB7Ci0JCXN0cnVj
dCBkcm1fYnJpZGdlICpicmlkZ2U7Ci0JCXN0cnVjdCBkcm1fYnJpZGdlICpuZXh0OwotCi0JCWJy
aWRnZSA9IGRybV9icmlkZ2VfY2hhaW5fZ2V0X2ZpcnN0X2JyaWRnZShlbmNvZGVyKTsKLQkJd2hp
bGUgKGJyaWRnZSkgewotCQkJbmV4dCA9IGJyaWRnZS0+bmV4dDsKLQkJCWRybV9icmlkZ2VfZGV0
YWNoKGJyaWRnZSk7Ci0JCQlicmlkZ2UgPSBuZXh0OwotCQl9Ci0JfQorCWxpc3RfZm9yX2VhY2hf
ZW50cnlfc2FmZShicmlkZ2UsIG5leHQsICZlbmNvZGVyLT5icmlkZ2VfY2hhaW4sCisJCQkJIGNo
YWluX25vZGUpCisJCWRybV9icmlkZ2VfZGV0YWNoKGJyaWRnZSk7CiAKIAlkcm1fbW9kZV9vYmpl
Y3RfdW5yZWdpc3RlcihkZXYsICZlbmNvZGVyLT5iYXNlKTsKIAlrZnJlZShlbmNvZGVyLT5uYW1l
KTsKZGlmZiAtLWdpdCBhL2luY2x1ZGUvZHJtL2RybV9icmlkZ2UuaCBiL2luY2x1ZGUvZHJtL2Ry
bV9icmlkZ2UuaAppbmRleCAyN2VlZjYzY2UwZmYuLjNhYjE2Yzk1ZTU5ZSAxMDA2NDQKLS0tIGEv
aW5jbHVkZS9kcm0vZHJtX2JyaWRnZS5oCisrKyBiL2luY2x1ZGUvZHJtL2RybV9icmlkZ2UuaApA
QCAtMzg0LDggKzM4NCw4IEBAIHN0cnVjdCBkcm1fYnJpZGdlIHsKIAlzdHJ1Y3QgZHJtX2Rldmlj
ZSAqZGV2OwogCS8qKiBAZW5jb2RlcjogZW5jb2RlciB0byB3aGljaCB0aGlzIGJyaWRnZSBpcyBj
b25uZWN0ZWQgKi8KIAlzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29kZXI7Ci0JLyoqIEBuZXh0OiB0
aGUgbmV4dCBicmlkZ2UgaW4gdGhlIGVuY29kZXIgY2hhaW4gKi8KLQlzdHJ1Y3QgZHJtX2JyaWRn
ZSAqbmV4dDsKKwkvKiogQGNoYWluX25vZGU6IHVzZWQgdG8gZm9ybSBhIGJyaWRnZSBjaGFpbiAq
LworCXN0cnVjdCBsaXN0X2hlYWQgY2hhaW5fbm9kZTsKICNpZmRlZiBDT05GSUdfT0YKIAkvKiog
QG9mX25vZGU6IGRldmljZSBub2RlIHBvaW50ZXIgdG8gdGhlIGJyaWRnZSAqLwogCXN0cnVjdCBk
ZXZpY2Vfbm9kZSAqb2Zfbm9kZTsKQEAgLTQyMCw3ICs0MjAsMTAgQEAgaW50IGRybV9icmlkZ2Vf
YXR0YWNoKHN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2Rlciwgc3RydWN0IGRybV9icmlkZ2UgKmJy
aWRnZSwKIHN0YXRpYyBpbmxpbmUgc3RydWN0IGRybV9icmlkZ2UgKgogZHJtX2JyaWRnZV9jaGFp
bl9nZXRfbmV4dF9icmlkZ2Uoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSkKIHsKLQlyZXR1cm4g
YnJpZGdlLT5uZXh0OworCWlmIChsaXN0X2lzX2xhc3QoJmJyaWRnZS0+Y2hhaW5fbm9kZSwgJmJy
aWRnZS0+ZW5jb2Rlci0+YnJpZGdlX2NoYWluKSkKKwkJcmV0dXJuIE5VTEw7CisKKwlyZXR1cm4g
bGlzdF9uZXh0X2VudHJ5KGJyaWRnZSwgY2hhaW5fbm9kZSk7CiB9CiAKIC8qKgpAQCAtNDM0LDcg
KzQzNyw4IEBAIGRybV9icmlkZ2VfY2hhaW5fZ2V0X25leHRfYnJpZGdlKHN0cnVjdCBkcm1fYnJp
ZGdlICpicmlkZ2UpCiBzdGF0aWMgaW5saW5lIHN0cnVjdCBkcm1fYnJpZGdlICoKIGRybV9icmlk
Z2VfY2hhaW5fZ2V0X2ZpcnN0X2JyaWRnZShzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29kZXIpCiB7
Ci0JcmV0dXJuIGVuY29kZXItPmJyaWRnZTsKKwlyZXR1cm4gbGlzdF9maXJzdF9lbnRyeV9vcl9u
dWxsKCZlbmNvZGVyLT5icmlkZ2VfY2hhaW4sCisJCQkJCXN0cnVjdCBkcm1fYnJpZGdlLCBjaGFp
bl9ub2RlKTsKIH0KIAogYm9vbCBkcm1fYnJpZGdlX2NoYWluX21vZGVfZml4dXAoc3RydWN0IGRy
bV9icmlkZ2UgKmJyaWRnZSwKZGlmZiAtLWdpdCBhL2luY2x1ZGUvZHJtL2RybV9lbmNvZGVyLmgg
Yi9pbmNsdWRlL2RybS9kcm1fZW5jb2Rlci5oCmluZGV4IGYwNjE2NGY0NGVmZS4uOWIzZGRlMTc3
YzgxIDEwMDY0NAotLS0gYS9pbmNsdWRlL2RybS9kcm1fZW5jb2Rlci5oCisrKyBiL2luY2x1ZGUv
ZHJtL2RybV9lbmNvZGVyLmgKQEAgLTE3Miw3ICsxNzIsMTQgQEAgc3RydWN0IGRybV9lbmNvZGVy
IHsKIAkgKiAmZHJtX2Nvbm5lY3Rvcl9zdGF0ZS5jcnRjLgogCSAqLwogCXN0cnVjdCBkcm1fY3J0
YyAqY3J0YzsKLQlzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlOworCisJLyoqCisJICogQGJyaWRn
ZV9jaGFpbjogQnJpZGdlcyBhdHRhY2hlZCB0byB0aGlzIGVuY29kZXIuIFRoZSBmaXJzdCBlbnRy
eSBvZgorCSAqIHRoaXMgbGlzdCBpcyBhbHdheXMgJmRybV9lbmNvZGVyLmJyaWRnZS4gSXQgbWF5
IGJlIGZvbGxvd2VkIGJ5IG90aGVyCisJICogYnJpZGdlIGVudGl0aWVzLgorCSAqLworCXN0cnVj
dCBsaXN0X2hlYWQgYnJpZGdlX2NoYWluOworCiAJY29uc3Qgc3RydWN0IGRybV9lbmNvZGVyX2Z1
bmNzICpmdW5jczsKIAljb25zdCBzdHJ1Y3QgZHJtX2VuY29kZXJfaGVscGVyX2Z1bmNzICpoZWxw
ZXJfcHJpdmF0ZTsKIH07Ci0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3Rz
LmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xp
c3RpbmZvL2RyaS1kZXZlbA==
