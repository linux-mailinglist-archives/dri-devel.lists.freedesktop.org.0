Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C27F55D171
	for <lists+dri-devel@lfdr.de>; Tue,  2 Jul 2019 16:19:38 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 35E2789F77;
	Tue,  2 Jul 2019 14:19:24 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E10AA89F77
 for <dri-devel@lists.freedesktop.org>; Tue,  2 Jul 2019 14:19:20 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com
 [10.5.11.16])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 7208958569;
 Tue,  2 Jul 2019 14:19:15 +0000 (UTC)
Received: from sirius.home.kraxel.org (ovpn-116-96.ams2.redhat.com
 [10.36.116.96])
 by smtp.corp.redhat.com (Postfix) with ESMTP id A0D7961498;
 Tue,  2 Jul 2019 14:19:10 +0000 (UTC)
Received: by sirius.home.kraxel.org (Postfix, from userid 1000)
 id DECF49D77; Tue,  2 Jul 2019 16:19:05 +0200 (CEST)
From: Gerd Hoffmann <kraxel@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v6 14/18] drm/virtio: rework
 virtio_gpu_transfer_from_host_ioctl fencing
Date: Tue,  2 Jul 2019 16:18:59 +0200
Message-Id: <20190702141903.1131-15-kraxel@redhat.com>
In-Reply-To: <20190702141903.1131-1-kraxel@redhat.com>
References: <20190702141903.1131-1-kraxel@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.39]); Tue, 02 Jul 2019 14:19:20 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, open list <linux-kernel@vger.kernel.org>,
 "open list:VIRTIO GPU DRIVER" <virtualization@lists.linux-foundation.org>,
 Gerd Hoffmann <kraxel@redhat.com>, gurchetansingh@chromium.org
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U3dpdGNoIHRvIHRoZSB2aXJ0aW9fZ3B1X2FycmF5XyogaGVscGVyIHdvcmtmbG93LgoKU2lnbmVk
LW9mZi1ieTogR2VyZCBIb2ZmbWFubiA8a3JheGVsQHJlZGhhdC5jb20+Ci0tLQogZHJpdmVycy9n
cHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2Rydi5oICAgfCAgMyArKy0KIGRyaXZlcnMvZ3B1L2RybS92
aXJ0aW8vdmlydGdwdV9pb2N0bC5jIHwgMzUgKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0KIGRy
aXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92cS5jICAgIHwgIDggKysrKy0tCiAzIGZpbGVz
IGNoYW5nZWQsIDIzIGluc2VydGlvbnMoKyksIDIzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaCBiL2RyaXZlcnMvZ3B1L2RybS92
aXJ0aW8vdmlydGdwdV9kcnYuaAppbmRleCA3OGRjNWExOWEzNTguLjRkZjc2MGJhMDE4ZSAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2Rydi5oCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaApAQCAtMzAyLDkgKzMwMiwxMCBAQCB2b2lk
IHZpcnRpb19ncHVfY21kX3N1Ym1pdChzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAog
CQkJICAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0X2FycmF5ICpvYmpzLAogCQkJICAgc3RydWN0
IHZpcnRpb19ncHVfZmVuY2UgKmZlbmNlKTsKIHZvaWQgdmlydGlvX2dwdV9jbWRfdHJhbnNmZXJf
ZnJvbV9ob3N0XzNkKHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCi0JCQkJCSAgdWlu
dDMyX3QgcmVzb3VyY2VfaWQsIHVpbnQzMl90IGN0eF9pZCwKKwkJCQkJICB1aW50MzJfdCBjdHhf
aWQsCiAJCQkJCSAgdWludDY0X3Qgb2Zmc2V0LCB1aW50MzJfdCBsZXZlbCwKIAkJCQkJICBzdHJ1
Y3QgdmlydGlvX2dwdV9ib3ggKmJveCwKKwkJCQkJICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3Rf
YXJyYXkgKm9ianMsCiAJCQkJCSAgc3RydWN0IHZpcnRpb19ncHVfZmVuY2UgKmZlbmNlKTsKIHZv
aWQgdmlydGlvX2dwdV9jbWRfdHJhbnNmZXJfdG9faG9zdF8zZChzdHJ1Y3QgdmlydGlvX2dwdV9k
ZXZpY2UgKnZnZGV2LAogCQkJCQlzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3QgKmJvLApkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2lvY3RsLmMgYi9kcml2ZXJzL2dw
dS9kcm0vdmlydGlvL3ZpcnRncHVfaW9jdGwuYwppbmRleCAwZDBhY2YwYjg1ZWQuLjU2MTgyYWJk
YmYzNiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2lvY3RsLmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2lvY3RsLmMKQEAgLTI5OCw4ICsy
OTgsNyBAQCBzdGF0aWMgaW50IHZpcnRpb19ncHVfdHJhbnNmZXJfZnJvbV9ob3N0X2lvY3RsKHN0
cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiA9
IGRldi0+ZGV2X3ByaXZhdGU7CiAJc3RydWN0IHZpcnRpb19ncHVfZnByaXYgKnZmcHJpdiA9IGZp
bGUtPmRyaXZlcl9wcml2OwogCXN0cnVjdCBkcm1fdmlydGdwdV8zZF90cmFuc2Zlcl9mcm9tX2hv
c3QgKmFyZ3MgPSBkYXRhOwotCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAqZ29iaiA9IE5VTEw7Ci0J
c3RydWN0IHZpcnRpb19ncHVfb2JqZWN0ICpxb2JqID0gTlVMTDsKKwlzdHJ1Y3QgdmlydGlvX2dw
dV9vYmplY3RfYXJyYXkgKm9ianM7CiAJc3RydWN0IHZpcnRpb19ncHVfZmVuY2UgKmZlbmNlOwog
CWludCByZXQ7CiAJdTMyIG9mZnNldCA9IGFyZ3MtPm9mZnNldDsKQEAgLTMwOCwzNSArMzA3LDMx
IEBAIHN0YXRpYyBpbnQgdmlydGlvX2dwdV90cmFuc2Zlcl9mcm9tX2hvc3RfaW9jdGwoc3RydWN0
IGRybV9kZXZpY2UgKmRldiwKIAlpZiAodmdkZXYtPmhhc192aXJnbF8zZCA9PSBmYWxzZSkKIAkJ
cmV0dXJuIC1FTk9TWVM7CiAKLQlnb2JqID0gZHJtX2dlbV9vYmplY3RfbG9va3VwKGZpbGUsIGFy
Z3MtPmJvX2hhbmRsZSk7Ci0JaWYgKGdvYmogPT0gTlVMTCkKKwlvYmpzID0gdmlydGlvX2dwdV9h
cnJheV9mcm9tX2hhbmRsZXMoZmlsZSwgJmFyZ3MtPmJvX2hhbmRsZSwgMSk7CisJaWYgKG9ianMg
PT0gTlVMTCkKIAkJcmV0dXJuIC1FTk9FTlQ7CiAKLQlxb2JqID0gZ2VtX3RvX3ZpcnRpb19ncHVf
b2JqKGdvYmopOwotCi0JcmV0ID0gdmlydGlvX2dwdV9vYmplY3RfcmVzZXJ2ZShxb2JqKTsKLQlp
ZiAocmV0KQotCQlnb3RvIG91dDsKKwlyZXQgPSB2aXJ0aW9fZ3B1X2FycmF5X2xvY2tfcmVzdihv
YmpzKTsKKwlpZiAocmV0ICE9IDApCisJCWdvdG8gZXJyX3B1dF9mcmVlOwogCiAJY29udmVydF90
b19od19ib3goJmJveCwgJmFyZ3MtPmJveCk7CiAKIAlmZW5jZSA9IHZpcnRpb19ncHVfZmVuY2Vf
YWxsb2ModmdkZXYpOwogCWlmICghZmVuY2UpIHsKIAkJcmV0ID0gLUVOT01FTTsKLQkJZ290byBv
dXRfdW5yZXM7CisJCWdvdG8gZXJyX3VubG9jazsKIAl9CiAJdmlydGlvX2dwdV9jbWRfdHJhbnNm
ZXJfZnJvbV9ob3N0XzNkCi0JCSh2Z2RldiwgcW9iai0+aHdfcmVzX2hhbmRsZSwKLQkJIHZmcHJp
di0+Y3R4X2lkLCBvZmZzZXQsIGFyZ3MtPmxldmVsLAotCQkgJmJveCwgZmVuY2UpOwotCXJlc2Vy
dmF0aW9uX29iamVjdF9hZGRfZXhjbF9mZW5jZShxb2JqLT5iYXNlLmJhc2UucmVzdiwKLQkJCQkJ
ICAmZmVuY2UtPmYpOwotCisJCSh2Z2RldiwgdmZwcml2LT5jdHhfaWQsIG9mZnNldCwgYXJncy0+
bGV2ZWwsCisJCSAmYm94LCBvYmpzLCBmZW5jZSk7CiAJZG1hX2ZlbmNlX3B1dCgmZmVuY2UtPmYp
Owotb3V0X3VucmVzOgotCXZpcnRpb19ncHVfb2JqZWN0X3VucmVzZXJ2ZShxb2JqKTsKLW91dDoK
LQlkcm1fZ2VtX29iamVjdF9wdXRfdW5sb2NrZWQoZ29iaik7CisJcmV0dXJuIDA7CisKK2Vycl91
bmxvY2s6CisJdmlydGlvX2dwdV9hcnJheV91bmxvY2tfcmVzdihvYmpzKTsKK2Vycl9wdXRfZnJl
ZToKKwl2aXJ0aW9fZ3B1X2FycmF5X3B1dF9mcmVlKG9ianMpOwogCXJldHVybiByZXQ7CiB9CiAK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92cS5jIGIvZHJpdmVy
cy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X3ZxLmMKaW5kZXggZmM5MDhkNWNiMjE3Li5iZWY3MDM2
ZjQ1MDggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92cS5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92cS5jCkBAIC05MjgsMjAgKzkyOCwy
NCBAQCB2b2lkIHZpcnRpb19ncHVfY21kX3RyYW5zZmVyX3RvX2hvc3RfM2Qoc3RydWN0IHZpcnRp
b19ncHVfZGV2aWNlICp2Z2RldiwKIH0KIAogdm9pZCB2aXJ0aW9fZ3B1X2NtZF90cmFuc2Zlcl9m
cm9tX2hvc3RfM2Qoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKLQkJCQkJICB1aW50
MzJfdCByZXNvdXJjZV9pZCwgdWludDMyX3QgY3R4X2lkLAorCQkJCQkgIHVpbnQzMl90IGN0eF9p
ZCwKIAkJCQkJICB1aW50NjRfdCBvZmZzZXQsIHVpbnQzMl90IGxldmVsLAogCQkJCQkgIHN0cnVj
dCB2aXJ0aW9fZ3B1X2JveCAqYm94LAorCQkJCQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X29iamVjdF9h
cnJheSAqb2JqcywKIAkJCQkJICBzdHJ1Y3QgdmlydGlvX2dwdV9mZW5jZSAqZmVuY2UpCiB7CisJ
c3RydWN0IHZpcnRpb19ncHVfb2JqZWN0ICpibyA9IGdlbV90b192aXJ0aW9fZ3B1X29iaihvYmpz
LT5vYmpzWzBdKTsKIAlzdHJ1Y3QgdmlydGlvX2dwdV90cmFuc2Zlcl9ob3N0XzNkICpjbWRfcDsK
IAlzdHJ1Y3QgdmlydGlvX2dwdV92YnVmZmVyICp2YnVmOwogCiAJY21kX3AgPSB2aXJ0aW9fZ3B1
X2FsbG9jX2NtZCh2Z2RldiwgJnZidWYsIHNpemVvZigqY21kX3ApKTsKIAltZW1zZXQoY21kX3As
IDAsIHNpemVvZigqY21kX3ApKTsKIAorCXZidWYtPm9ianMgPSBvYmpzOworCiAJY21kX3AtPmhk
ci50eXBlID0gY3B1X3RvX2xlMzIoVklSVElPX0dQVV9DTURfVFJBTlNGRVJfRlJPTV9IT1NUXzNE
KTsKIAljbWRfcC0+aGRyLmN0eF9pZCA9IGNwdV90b19sZTMyKGN0eF9pZCk7Ci0JY21kX3AtPnJl
c291cmNlX2lkID0gY3B1X3RvX2xlMzIocmVzb3VyY2VfaWQpOworCWNtZF9wLT5yZXNvdXJjZV9p
ZCA9IGNwdV90b19sZTMyKGJvLT5od19yZXNfaGFuZGxlKTsKIAljbWRfcC0+Ym94ID0gKmJveDsK
IAljbWRfcC0+b2Zmc2V0ID0gY3B1X3RvX2xlNjQob2Zmc2V0KTsKIAljbWRfcC0+bGV2ZWwgPSBj
cHVfdG9fbGUzMihsZXZlbCk7Ci0tIAoyLjE4LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxp
c3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFu
L2xpc3RpbmZvL2RyaS1kZXZlbA==
