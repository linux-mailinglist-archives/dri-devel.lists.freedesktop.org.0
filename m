Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id DA4A02820E9
	for <lists+dri-devel@lfdr.de>; Sat,  3 Oct 2020 06:03:13 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 10E5F6EA33;
	Sat,  3 Oct 2020 04:03:09 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pj1-x1041.google.com (mail-pj1-x1041.google.com
 [IPv6:2607:f8b0:4864:20::1041])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 78C1E6EA33
 for <dri-devel@lists.freedesktop.org>; Sat,  3 Oct 2020 04:03:08 +0000 (UTC)
Received: by mail-pj1-x1041.google.com with SMTP id a17so1585673pju.1
 for <dri-devel@lists.freedesktop.org>; Fri, 02 Oct 2020 21:03:08 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=qDmdA3E3k0WcvEKJL539r8KYOExUff4XTLceLBQuupY=;
 b=a0cf+nPLMpMjpQI82SemGlUIWrWmLb94fhl7q68tkPZtczXIePaAoqkriup1tEyOaX
 k1SAv+BOBuCC6K6t7KKxKgS45ZA42laRzhJ/qD5LX9w9Ez31ERIUvyFyk2qCt9RBrNWz
 XhLFReMWTBDViftARAVq1zBh0Ao1/qQGJLSZUGABcSWoWzf87UfGtzDAH1Rty4XuXvxy
 WoBmF95j9EHyZCWTpfq6+Dvf+sdh1bk4GsiDumRhkFnJIRcF8Z4fczhRbOI7jnC9FvVM
 28yFnq+zs2WTnSaC+9wtp08RPCdBtlBKVUAtOfai3pn3yBlQkFN2UbudGt32Ja+dYQZT
 CBUA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=qDmdA3E3k0WcvEKJL539r8KYOExUff4XTLceLBQuupY=;
 b=gcJAl1DDVypOsgq+WZdSfTwFi/A2uMufipHNKlokDQ0gGpJ0YNAW15ToUVB21ReWG6
 FeFv3NNV2VrP4lDJe7UDwd47x9POsYHG/npzeksZ1xgXBMl06RxHNGlMN0SfIjeCSPXk
 KbH1mS4zlLOuNEFhZUzevuLSN2tOKQj/mVvVgokhHlXX2j8zWhfdTwcoaZ6RuaYaelVC
 TyItTx6rI0aHMYDIKJCgpSPTJGe5UjLpcWGXMQ7hLR3u1PmefV3ElMpGATZabICLasPZ
 bD7uXLJQo2dawsTUHAx+2udE8+xYNaoDDIiSKUmyQNLXL1o/1/QFFMw+JNTZOMJnHMHz
 QXUw==
X-Gm-Message-State: AOAM5322JvR68cuMkGs97TK+YO8XnWBnHdHjfkKG7qaBSlayMd9J/nUC
 jQTXVn5Stnbgh3fta1ROGspvZA==
X-Google-Smtp-Source: ABdhPJwni5E7y6nissv8Ogs+irApUo4wFV4n6mqH2ximcudDbsXjewVZdnIDC7B9NIUSCJz8OUEDxw==
X-Received: by 2002:a17:90a:ab8f:: with SMTP id
 n15mr5821518pjq.139.1601697788005; 
 Fri, 02 Oct 2020 21:03:08 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 190sm3909290pfy.22.2020.10.02.21.03.05
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 02 Oct 2020 21:03:07 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v3 2/7] dma-buf: heaps: Move heap-helper logic into the
 cma_heap implementation
Date: Sat,  3 Oct 2020 04:02:52 +0000
Message-Id: <20201003040257.62768-3-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20201003040257.62768-1-john.stultz@linaro.org>
References: <20201003040257.62768-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sandeep Patil <sspatil@google.com>, dri-devel@lists.freedesktop.org,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Chris Goldsworthy <cgoldswo@codeaurora.org>,
 Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 linux-media@vger.kernel.org, Suren Baghdasaryan <surenb@google.com>,
 Daniel Mentz <danielmentz@google.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2UgdGhlIGhlYXAtaGVscGVycyBsb2dpYyBlbmRlZCB1cCBub3QgYmVpbmcgYXMgZ2VuZXJp
YyBhcwpob3BlZCwgbW92ZSB0aGUgaGVhcC1oZWxwZXJzIGRtYV9idWZfb3BzIGltcGxlbWVudGF0
aW9ucyBpbnRvCnRoZSBjbWFfaGVhcCBkaXJlY3RseS4KClRoaXMgd2lsbCBhbGxvdyB1cyB0byBy
ZW1vdmUgdGhlIGhlYXBfaGVscGVycyBjb2RlIGluIGEgZm9sbG93aW5nCnBhdGNoLgoKQ2M6IFN1
bWl0IFNlbXdhbCA8c3VtaXQuc2Vtd2FsQGxpbmFyby5vcmc+CkNjOiBMaWFtIE1hcmsgPGxtYXJr
QGNvZGVhdXJvcmEub3JnPgpDYzogTGF1cmEgQWJib3R0IDxsYWJib3R0QGtlcm5lbC5vcmc+CkNj
OiBCcmlhbiBTdGFya2V5IDxCcmlhbi5TdGFya2V5QGFybS5jb20+CkNjOiBIcmlkeWEgVmFsc2Fy
YWp1IDxocmlkeWFAZ29vZ2xlLmNvbT4KQ2M6IFN1cmVuIEJhZ2hkYXNhcnlhbiA8c3VyZW5iQGdv
b2dsZS5jb20+CkNjOiBTYW5kZWVwIFBhdGlsIDxzc3BhdGlsQGdvb2dsZS5jb20+CkNjOiBEYW5p
ZWwgTWVudHogPGRhbmllbG1lbnR6QGdvb2dsZS5jb20+CkNjOiBDaHJpcyBHb2xkc3dvcnRoeSA8
Y2dvbGRzd29AY29kZWF1cm9yYS5vcmc+CkNjOiDDmHJqYW4gRWlkZSA8b3JqYW4uZWlkZUBhcm0u
Y29tPgpDYzogUm9iaW4gTXVycGh5IDxyb2Jpbi5tdXJwaHlAYXJtLmNvbT4KQ2M6IEV6ZXF1aWVs
IEdhcmNpYSA8ZXplcXVpZWxAY29sbGFib3JhLmNvbT4KQ2M6IFNpbW9uIFNlciA8Y29udGFjdEBl
bWVyc2lvbi5mcj4KQ2M6IEphbWVzIEpvbmVzIDxqYWpvbmVzQG52aWRpYS5jb20+CkNjOiBsaW51
eC1tZWRpYUB2Z2VyLmtlcm5lbC5vcmcKQ2M6IGRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5v
cmcKU2lnbmVkLW9mZi1ieTogSm9obiBTdHVsdHogPGpvaG4uc3R1bHR6QGxpbmFyby5vcmc+Ci0t
LQp2MjoKKiBGaXggdW51c2VkIHJldHVybiB2YWx1ZSBhbmQgbG9ja2luZyBpc3N1ZSBSZXBvcnRl
ZC1ieToKICAgIGtlcm5lbCB0ZXN0IHJvYm90IDxsa3BAaW50ZWwuY29tPgogICAgSnVsaWEgTGF3
YWxsIDxqdWxpYS5sYXdhbGxAaW5yaWEuZnI+CiogTWFrZSBjbWFfaGVhcF9idWZfb3BzIHN0YXRp
YyBzdWdnZXN0ZWQgYnkKICAgIGtlcm5lbCB0ZXN0IHJvYm90IDxsa3BAaW50ZWwuY29tPgoqIEZp
eCB1bmluaXRpYWxpemVkIHJldHVybiBpbiBjbWEgUmVwb3J0ZWQtYnk6CiAgICBrZXJuZWwgdGVz
dCByb2JvdCA8bGtwQGludGVsLmNvbT4KKiBNaW5vciBjbGVhbnVwcwp2MzoKKiBVc2UgdGhlIG5l
dyBzZ3RhYmxlIG1hcHBpbmcgZnVuY3Rpb25zLCBhcyBTdWdnZXN0ZWQtYnk6CiAgICAgRGFuaWVs
IE1lbnR6IDxkYW5pZWxtZW50ekBnb29nbGUuY29tPgotLS0KIGRyaXZlcnMvZG1hLWJ1Zi9oZWFw
cy9jbWFfaGVhcC5jIHwgMzE3ICsrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0KIDEgZmls
ZSBjaGFuZ2VkLCAyNjcgaW5zZXJ0aW9ucygrKSwgNTAgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9kbWEtYnVmL2hlYXBzL2NtYV9oZWFwLmMgYi9kcml2ZXJzL2RtYS1idWYvaGVh
cHMvY21hX2hlYXAuYwppbmRleCA2MjZjZjdmZDAzM2EuLjM2Njk2M2I5NGM3MiAxMDA2NDQKLS0t
IGEvZHJpdmVycy9kbWEtYnVmL2hlYXBzL2NtYV9oZWFwLmMKKysrIGIvZHJpdmVycy9kbWEtYnVm
L2hlYXBzL2NtYV9oZWFwLmMKQEAgLTIsNzYgKzIsMjkxIEBACiAvKgogICogRE1BQlVGIENNQSBo
ZWFwIGV4cG9ydGVyCiAgKgotICogQ29weXJpZ2h0IChDKSAyMDEyLCAyMDE5IExpbmFybyBMdGQu
CisgKiBDb3B5cmlnaHQgKEMpIDIwMTIsIDIwMTksIDIwMjAgTGluYXJvIEx0ZC4KICAqIEF1dGhv
cjogPGJlbmphbWluLmdhaWduYXJkQGxpbmFyby5vcmc+IGZvciBTVC1Fcmljc3Nvbi4KKyAqCisg
KiBBbHNvIHV0aWxpemluZyBwYXJ0cyBvZiBBbmRyZXcgRGF2aXMnIFNSQU0gaGVhcDoKKyAqIENv
cHlyaWdodCAoQykgMjAxOSBUZXhhcyBJbnN0cnVtZW50cyBJbmNvcnBvcmF0ZWQgLSBodHRwOi8v
d3d3LnRpLmNvbS8KKyAqCUFuZHJldyBGLiBEYXZpcyA8YWZkQHRpLmNvbT4KICAqLwotCiAjaW5j
bHVkZSA8bGludXgvY21hLmg+Ci0jaW5jbHVkZSA8bGludXgvZGV2aWNlLmg+CiAjaW5jbHVkZSA8
bGludXgvZG1hLWJ1Zi5oPgotI2luY2x1ZGUgPGxpbnV4L2RtYS1oZWFwLmg+CiAjaW5jbHVkZSA8
bGludXgvZG1hLWNvbnRpZ3VvdXMuaD4KKyNpbmNsdWRlIDxsaW51eC9kbWEtaGVhcC5oPgorI2lu
Y2x1ZGUgPGxpbnV4L2RtYS1tYXBwaW5nLmg+CiAjaW5jbHVkZSA8bGludXgvZXJyLmg+Ci0jaW5j
bHVkZSA8bGludXgvZXJybm8uaD4KICNpbmNsdWRlIDxsaW51eC9oaWdobWVtLmg+CisjaW5jbHVk
ZSA8bGludXgvaW8uaD4KKyNpbmNsdWRlIDxsaW51eC9tbS5oPgogI2luY2x1ZGUgPGxpbnV4L21v
ZHVsZS5oPgotI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KICNpbmNsdWRlIDxsaW51eC9zY2F0dGVy
bGlzdC5oPgotI2luY2x1ZGUgPGxpbnV4L3NjaGVkL3NpZ25hbC5oPgorI2luY2x1ZGUgPGxpbnV4
L3NsYWIuaD4KIAotI2luY2x1ZGUgImhlYXAtaGVscGVycy5oIgogCiBzdHJ1Y3QgY21hX2hlYXAg
ewogCXN0cnVjdCBkbWFfaGVhcCAqaGVhcDsKIAlzdHJ1Y3QgY21hICpjbWE7CiB9OwogCi1zdGF0
aWMgdm9pZCBjbWFfaGVhcF9mcmVlKHN0cnVjdCBoZWFwX2hlbHBlcl9idWZmZXIgKmJ1ZmZlcikK
K3N0cnVjdCBjbWFfaGVhcF9idWZmZXIgeworCXN0cnVjdCBjbWFfaGVhcCAqaGVhcDsKKwlzdHJ1
Y3QgbGlzdF9oZWFkIGF0dGFjaG1lbnRzOworCXN0cnVjdCBtdXRleCBsb2NrOworCXVuc2lnbmVk
IGxvbmcgbGVuOworCXN0cnVjdCBwYWdlICpjbWFfcGFnZXM7CisJc3RydWN0IHBhZ2UgKipwYWdl
czsKKwlwZ29mZl90IHBhZ2Vjb3VudDsKKwlpbnQgdm1hcF9jbnQ7CisJdm9pZCAqdmFkZHI7Cit9
OworCitzdHJ1Y3QgZG1hX2hlYXBfYXR0YWNobWVudCB7CisJc3RydWN0IGRldmljZSAqZGV2Owor
CXN0cnVjdCBzZ190YWJsZSB0YWJsZTsKKwlzdHJ1Y3QgbGlzdF9oZWFkIGxpc3Q7Cit9OworCitz
dGF0aWMgaW50IGNtYV9oZWFwX2F0dGFjaChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAorCQkJICAg
c3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNobWVudCkKIHsKLQlzdHJ1Y3QgY21hX2hl
YXAgKmNtYV9oZWFwID0gZG1hX2hlYXBfZ2V0X2RydmRhdGEoYnVmZmVyLT5oZWFwKTsKLQl1bnNp
Z25lZCBsb25nIG5yX3BhZ2VzID0gYnVmZmVyLT5wYWdlY291bnQ7Ci0Jc3RydWN0IHBhZ2UgKmNt
YV9wYWdlcyA9IGJ1ZmZlci0+cHJpdl92aXJ0OworCXN0cnVjdCBjbWFfaGVhcF9idWZmZXIgKmJ1
ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKKwlzdHJ1Y3QgZG1hX2hlYXBfYXR0YWNobWVudCAqYTsKKwlp
bnQgcmV0OwogCi0JLyogZnJlZSBwYWdlIGxpc3QgKi8KLQlrZnJlZShidWZmZXItPnBhZ2VzKTsK
LQkvKiByZWxlYXNlIG1lbW9yeSAqLwotCWNtYV9yZWxlYXNlKGNtYV9oZWFwLT5jbWEsIGNtYV9w
YWdlcywgbnJfcGFnZXMpOworCWEgPSBremFsbG9jKHNpemVvZigqYSksIEdGUF9LRVJORUwpOwor
CWlmICghYSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlyZXQgPSBzZ19hbGxvY190YWJsZV9mcm9t
X3BhZ2VzKCZhLT50YWJsZSwgYnVmZmVyLT5wYWdlcywKKwkJCQkJYnVmZmVyLT5wYWdlY291bnQs
IDAsCisJCQkJCWJ1ZmZlci0+cGFnZWNvdW50IDw8IFBBR0VfU0hJRlQsCisJCQkJCUdGUF9LRVJO
RUwpOworCWlmIChyZXQpIHsKKwkJa2ZyZWUoYSk7CisJCXJldHVybiByZXQ7CisJfQorCisJYS0+
ZGV2ID0gYXR0YWNobWVudC0+ZGV2OworCUlOSVRfTElTVF9IRUFEKCZhLT5saXN0KTsKKworCWF0
dGFjaG1lbnQtPnByaXYgPSBhOworCisJbXV0ZXhfbG9jaygmYnVmZmVyLT5sb2NrKTsKKwlsaXN0
X2FkZCgmYS0+bGlzdCwgJmJ1ZmZlci0+YXR0YWNobWVudHMpOworCW11dGV4X3VubG9jaygmYnVm
ZmVyLT5sb2NrKTsKKworCXJldHVybiAwOworfQorCitzdGF0aWMgdm9pZCBjbWFfaGVhcF9kZXRh
dGNoKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCisJCQkgICAgIHN0cnVjdCBkbWFfYnVmX2F0dGFj
aG1lbnQgKmF0dGFjaG1lbnQpCit7CisJc3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyID0g
ZG1hYnVmLT5wcml2OworCXN0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50ICphID0gYXR0YWNobWVu
dC0+cHJpdjsKKworCW11dGV4X2xvY2soJmJ1ZmZlci0+bG9jayk7CisJbGlzdF9kZWwoJmEtPmxp
c3QpOworCW11dGV4X3VubG9jaygmYnVmZmVyLT5sb2NrKTsKKworCXNnX2ZyZWVfdGFibGUoJmEt
PnRhYmxlKTsKKwlrZnJlZShhKTsKK30KKworc3RhdGljIHN0cnVjdCBzZ190YWJsZSAqY21hX2hl
YXBfbWFwX2RtYV9idWYoc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNobWVudCwKKwkJ
CQkJICAgICBlbnVtIGRtYV9kYXRhX2RpcmVjdGlvbiBkaXJlY3Rpb24pCit7CisJc3RydWN0IGRt
YV9oZWFwX2F0dGFjaG1lbnQgKmEgPSBhdHRhY2htZW50LT5wcml2OworCXN0cnVjdCBzZ190YWJs
ZSAqdGFibGUgPSAmYS0+dGFibGU7CisJaW50IHJldDsKKworCXJldCA9IGRtYV9tYXBfc2d0YWJs
ZShhdHRhY2htZW50LT5kZXYsIHRhYmxlLCBkaXJlY3Rpb24sIDApOworCWlmIChyZXQpCisJCXJl
dHVybiBFUlJfUFRSKC1FTk9NRU0pOworCXJldHVybiB0YWJsZTsKK30KKworc3RhdGljIHZvaWQg
Y21hX2hlYXBfdW5tYXBfZG1hX2J1ZihzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhY2ht
ZW50LAorCQkJCSAgIHN0cnVjdCBzZ190YWJsZSAqdGFibGUsCisJCQkJICAgZW51bSBkbWFfZGF0
YV9kaXJlY3Rpb24gZGlyZWN0aW9uKQoreworCWRtYV91bm1hcF9zZ3RhYmxlKGF0dGFjaG1lbnQt
PmRldiwgdGFibGUsIGRpcmVjdGlvbiwgMCk7Cit9CisKK3N0YXRpYyBpbnQgY21hX2hlYXBfZG1h
X2J1Zl9iZWdpbl9jcHVfYWNjZXNzKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCisJCQkJCSAgICAg
ZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24gZGlyZWN0aW9uKQoreworCXN0cnVjdCBjbWFfaGVhcF9i
dWZmZXIgKmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKKwlzdHJ1Y3QgZG1hX2hlYXBfYXR0YWNobWVu
dCAqYTsKKworCWlmIChidWZmZXItPnZtYXBfY250KQorCQlpbnZhbGlkYXRlX2tlcm5lbF92bWFw
X3JhbmdlKGJ1ZmZlci0+dmFkZHIsIGJ1ZmZlci0+bGVuKTsKKworCW11dGV4X2xvY2soJmJ1ZmZl
ci0+bG9jayk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShhLCAmYnVmZmVyLT5hdHRhY2htZW50cywg
bGlzdCkgeworCQlkbWFfc3luY19zZ3RhYmxlX2Zvcl9jcHUoYS0+ZGV2LCAmYS0+dGFibGUsIGRp
cmVjdGlvbik7CisJfQorCW11dGV4X3VubG9jaygmYnVmZmVyLT5sb2NrKTsKKworCXJldHVybiAw
OworfQorCitzdGF0aWMgaW50IGNtYV9oZWFwX2RtYV9idWZfZW5kX2NwdV9hY2Nlc3Moc3RydWN0
IGRtYV9idWYgKmRtYWJ1ZiwKKwkJCQkJICAgZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24gZGlyZWN0
aW9uKQoreworCXN0cnVjdCBjbWFfaGVhcF9idWZmZXIgKmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsK
KwlzdHJ1Y3QgZG1hX2hlYXBfYXR0YWNobWVudCAqYTsKKworCWlmIChidWZmZXItPnZtYXBfY250
KQorCQlmbHVzaF9rZXJuZWxfdm1hcF9yYW5nZShidWZmZXItPnZhZGRyLCBidWZmZXItPmxlbik7
CisKKwltdXRleF9sb2NrKCZidWZmZXItPmxvY2spOworCWxpc3RfZm9yX2VhY2hfZW50cnkoYSwg
JmJ1ZmZlci0+YXR0YWNobWVudHMsIGxpc3QpIHsKKwkJZG1hX3N5bmNfc2d0YWJsZV9mb3JfZGV2
aWNlKGEtPmRldiwgJmEtPnRhYmxlLCBkaXJlY3Rpb24pOworCX0KKwltdXRleF91bmxvY2soJmJ1
ZmZlci0+bG9jayk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIHZtX2ZhdWx0X3QgY21hX2hl
YXBfdm1fZmF1bHQoc3RydWN0IHZtX2ZhdWx0ICp2bWYpCit7CisJc3RydWN0IHZtX2FyZWFfc3Ry
dWN0ICp2bWEgPSB2bWYtPnZtYTsKKwlzdHJ1Y3QgY21hX2hlYXBfYnVmZmVyICpidWZmZXIgPSB2
bWEtPnZtX3ByaXZhdGVfZGF0YTsKKworCWlmICh2bWYtPnBnb2ZmID4gYnVmZmVyLT5wYWdlY291
bnQpCisJCXJldHVybiBWTV9GQVVMVF9TSUdCVVM7CisKKwl2bWYtPnBhZ2UgPSBidWZmZXItPnBh
Z2VzW3ZtZi0+cGdvZmZdOworCWdldF9wYWdlKHZtZi0+cGFnZSk7CisKKwlyZXR1cm4gMDsKK30K
Kworc3RhdGljIGNvbnN0IHN0cnVjdCB2bV9vcGVyYXRpb25zX3N0cnVjdCBkbWFfaGVhcF92bV9v
cHMgPSB7CisJLmZhdWx0ID0gY21hX2hlYXBfdm1fZmF1bHQsCit9OworCitzdGF0aWMgaW50IGNt
YV9oZWFwX21tYXAoc3RydWN0IGRtYV9idWYgKmRtYWJ1Ziwgc3RydWN0IHZtX2FyZWFfc3RydWN0
ICp2bWEpCit7CisJc3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyID0gZG1hYnVmLT5wcml2
OworCisJaWYgKCh2bWEtPnZtX2ZsYWdzICYgKFZNX1NIQVJFRCB8IFZNX01BWVNIQVJFKSkgPT0g
MCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwl2bWEtPnZtX29wcyA9ICZkbWFfaGVhcF92bV9vcHM7
CisJdm1hLT52bV9wcml2YXRlX2RhdGEgPSBidWZmZXI7CisKKwlyZXR1cm4gMDsKK30KKworc3Rh
dGljIHZvaWQgKmNtYV9oZWFwX2RvX3ZtYXAoc3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVy
KQoreworCXZvaWQgKnZhZGRyOworCisJdmFkZHIgPSB2bWFwKGJ1ZmZlci0+cGFnZXMsIGJ1ZmZl
ci0+cGFnZWNvdW50LCBWTV9NQVAsIFBBR0VfS0VSTkVMKTsKKwlpZiAoIXZhZGRyKQorCQlyZXR1
cm4gRVJSX1BUUigtRU5PTUVNKTsKKworCXJldHVybiB2YWRkcjsKK30KKworc3RhdGljIHZvaWQg
KmNtYV9oZWFwX3ZtYXAoc3RydWN0IGRtYV9idWYgKmRtYWJ1ZikKK3sKKwlzdHJ1Y3QgY21hX2hl
YXBfYnVmZmVyICpidWZmZXIgPSBkbWFidWYtPnByaXY7CisJdm9pZCAqdmFkZHI7CisKKwltdXRl
eF9sb2NrKCZidWZmZXItPmxvY2spOworCWlmIChidWZmZXItPnZtYXBfY250KSB7CisJCWJ1ZmZl
ci0+dm1hcF9jbnQrKzsKKwkJdmFkZHIgPSBidWZmZXItPnZhZGRyOworCQlnb3RvIG91dDsKKwl9
CisKKwl2YWRkciA9IGNtYV9oZWFwX2RvX3ZtYXAoYnVmZmVyKTsKKwlpZiAoSVNfRVJSKHZhZGRy
KSkKKwkJZ290byBvdXQ7CisKKwlidWZmZXItPnZhZGRyID0gdmFkZHI7CisJYnVmZmVyLT52bWFw
X2NudCsrOworb3V0OgorCW11dGV4X3VubG9jaygmYnVmZmVyLT5sb2NrKTsKKworCXJldHVybiB2
YWRkcjsKK30KKworc3RhdGljIHZvaWQgY21hX2hlYXBfdnVubWFwKHN0cnVjdCBkbWFfYnVmICpk
bWFidWYsIHZvaWQgKnZhZGRyKQoreworCXN0cnVjdCBjbWFfaGVhcF9idWZmZXIgKmJ1ZmZlciA9
IGRtYWJ1Zi0+cHJpdjsKKworCW11dGV4X2xvY2soJmJ1ZmZlci0+bG9jayk7CisJaWYgKCEtLWJ1
ZmZlci0+dm1hcF9jbnQpIHsKKwkJdnVubWFwKGJ1ZmZlci0+dmFkZHIpOworCQlidWZmZXItPnZh
ZGRyID0gTlVMTDsKKwl9CisJbXV0ZXhfdW5sb2NrKCZidWZmZXItPmxvY2spOworfQorCitzdGF0
aWMgdm9pZCBjbWFfaGVhcF9kbWFfYnVmX3JlbGVhc2Uoc3RydWN0IGRtYV9idWYgKmRtYWJ1ZikK
K3sKKwlzdHJ1Y3QgY21hX2hlYXBfYnVmZmVyICpidWZmZXIgPSBkbWFidWYtPnByaXY7CisJc3Ry
dWN0IGNtYV9oZWFwICpjbWFfaGVhcCA9IGJ1ZmZlci0+aGVhcDsKKworCWlmIChidWZmZXItPnZt
YXBfY250ID4gMCkgeworCQlXQVJOKDEsICIlczogYnVmZmVyIHN0aWxsIG1hcHBlZCBpbiB0aGUg
a2VybmVsXG4iLCBfX2Z1bmNfXyk7CisJCXZ1bm1hcChidWZmZXItPnZhZGRyKTsKKwl9CisKKwlj
bWFfcmVsZWFzZShjbWFfaGVhcC0+Y21hLCBidWZmZXItPmNtYV9wYWdlcywgYnVmZmVyLT5wYWdl
Y291bnQpOwogCWtmcmVlKGJ1ZmZlcik7CiB9CiAKLS8qIGRtYWJ1ZiBoZWFwIENNQSBvcGVyYXRp
b25zIGZ1bmN0aW9ucyAqLworc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfYnVmX29wcyBjbWFfaGVh
cF9idWZfb3BzID0geworCS5hdHRhY2ggPSBjbWFfaGVhcF9hdHRhY2gsCisJLmRldGFjaCA9IGNt
YV9oZWFwX2RldGF0Y2gsCisJLm1hcF9kbWFfYnVmID0gY21hX2hlYXBfbWFwX2RtYV9idWYsCisJ
LnVubWFwX2RtYV9idWYgPSBjbWFfaGVhcF91bm1hcF9kbWFfYnVmLAorCS5iZWdpbl9jcHVfYWNj
ZXNzID0gY21hX2hlYXBfZG1hX2J1Zl9iZWdpbl9jcHVfYWNjZXNzLAorCS5lbmRfY3B1X2FjY2Vz
cyA9IGNtYV9oZWFwX2RtYV9idWZfZW5kX2NwdV9hY2Nlc3MsCisJLm1tYXAgPSBjbWFfaGVhcF9t
bWFwLAorCS52bWFwID0gY21hX2hlYXBfdm1hcCwKKwkudnVubWFwID0gY21hX2hlYXBfdnVubWFw
LAorCS5yZWxlYXNlID0gY21hX2hlYXBfZG1hX2J1Zl9yZWxlYXNlLAorfTsKKwogc3RhdGljIGlu
dCBjbWFfaGVhcF9hbGxvY2F0ZShzdHJ1Y3QgZG1hX2hlYXAgKmhlYXAsCi0JCQkgICAgIHVuc2ln
bmVkIGxvbmcgbGVuLAotCQkJICAgICB1bnNpZ25lZCBsb25nIGZkX2ZsYWdzLAotCQkJICAgICB1
bnNpZ25lZCBsb25nIGhlYXBfZmxhZ3MpCisJCQkJICB1bnNpZ25lZCBsb25nIGxlbiwKKwkJCQkg
IHVuc2lnbmVkIGxvbmcgZmRfZmxhZ3MsCisJCQkJICB1bnNpZ25lZCBsb25nIGhlYXBfZmxhZ3Mp
CiB7CiAJc3RydWN0IGNtYV9oZWFwICpjbWFfaGVhcCA9IGRtYV9oZWFwX2dldF9kcnZkYXRhKGhl
YXApOwotCXN0cnVjdCBoZWFwX2hlbHBlcl9idWZmZXIgKmhlbHBlcl9idWZmZXI7Ci0Jc3RydWN0
IHBhZ2UgKmNtYV9wYWdlczsKKwlzdHJ1Y3QgY21hX2hlYXBfYnVmZmVyICpidWZmZXI7CisJREVG
SU5FX0RNQV9CVUZfRVhQT1JUX0lORk8oZXhwX2luZm8pOwogCXNpemVfdCBzaXplID0gUEFHRV9B
TElHTihsZW4pOwotCXVuc2lnbmVkIGxvbmcgbnJfcGFnZXMgPSBzaXplID4+IFBBR0VfU0hJRlQ7
CisJcGdvZmZfdCBwYWdlY291bnQgPSBzaXplID4+IFBBR0VfU0hJRlQ7CiAJdW5zaWduZWQgbG9u
ZyBhbGlnbiA9IGdldF9vcmRlcihzaXplKTsKKwlzdHJ1Y3QgcGFnZSAqY21hX3BhZ2VzOwogCXN0
cnVjdCBkbWFfYnVmICpkbWFidWY7CiAJaW50IHJldCA9IC1FTk9NRU07CiAJcGdvZmZfdCBwZzsK
IAotCWlmIChhbGlnbiA+IENPTkZJR19DTUFfQUxJR05NRU5UKQotCQlhbGlnbiA9IENPTkZJR19D
TUFfQUxJR05NRU5UOwotCi0JaGVscGVyX2J1ZmZlciA9IGt6YWxsb2Moc2l6ZW9mKCpoZWxwZXJf
YnVmZmVyKSwgR0ZQX0tFUk5FTCk7Ci0JaWYgKCFoZWxwZXJfYnVmZmVyKQorCWJ1ZmZlciA9IGt6
YWxsb2Moc2l6ZW9mKCpidWZmZXIpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWJ1ZmZlcikKIAkJcmV0
dXJuIC1FTk9NRU07CiAKLQlpbml0X2hlYXBfaGVscGVyX2J1ZmZlcihoZWxwZXJfYnVmZmVyLCBj
bWFfaGVhcF9mcmVlKTsKLQloZWxwZXJfYnVmZmVyLT5oZWFwID0gaGVhcDsKLQloZWxwZXJfYnVm
ZmVyLT5zaXplID0gbGVuOworCUlOSVRfTElTVF9IRUFEKCZidWZmZXItPmF0dGFjaG1lbnRzKTsK
KwltdXRleF9pbml0KCZidWZmZXItPmxvY2spOworCWJ1ZmZlci0+bGVuID0gc2l6ZTsKKworCWlm
IChhbGlnbiA+IENPTkZJR19DTUFfQUxJR05NRU5UKQorCQlhbGlnbiA9IENPTkZJR19DTUFfQUxJ
R05NRU5UOwogCi0JY21hX3BhZ2VzID0gY21hX2FsbG9jKGNtYV9oZWFwLT5jbWEsIG5yX3BhZ2Vz
LCBhbGlnbiwgZmFsc2UpOworCWNtYV9wYWdlcyA9IGNtYV9hbGxvYyhjbWFfaGVhcC0+Y21hLCBw
YWdlY291bnQsIGFsaWduLCBmYWxzZSk7CiAJaWYgKCFjbWFfcGFnZXMpCi0JCWdvdG8gZnJlZV9i
dWY7CisJCWdvdG8gZnJlZV9idWZmZXI7CiAKKwkvKiBDbGVhciB0aGUgY21hIHBhZ2VzICovCiAJ
aWYgKFBhZ2VIaWdoTWVtKGNtYV9wYWdlcykpIHsKLQkJdW5zaWduZWQgbG9uZyBucl9jbGVhcl9w
YWdlcyA9IG5yX3BhZ2VzOworCQl1bnNpZ25lZCBsb25nIG5yX2NsZWFyX3BhZ2VzID0gcGFnZWNv
dW50OwogCQlzdHJ1Y3QgcGFnZSAqcGFnZSA9IGNtYV9wYWdlczsKIAogCQl3aGlsZSAobnJfY2xl
YXJfcGFnZXMgPiAwKSB7CkBAIC04NSw3ICszMDAsNiBAQCBzdGF0aWMgaW50IGNtYV9oZWFwX2Fs
bG9jYXRlKHN0cnVjdCBkbWFfaGVhcCAqaGVhcCwKIAkJCSAqLwogCQkJaWYgKGZhdGFsX3NpZ25h
bF9wZW5kaW5nKGN1cnJlbnQpKQogCQkJCWdvdG8gZnJlZV9jbWE7Ci0KIAkJCXBhZ2UrKzsKIAkJ
CW5yX2NsZWFyX3BhZ2VzLS07CiAJCX0KQEAgLTkzLDI4ICszMDcsMzAgQEAgc3RhdGljIGludCBj
bWFfaGVhcF9hbGxvY2F0ZShzdHJ1Y3QgZG1hX2hlYXAgKmhlYXAsCiAJCW1lbXNldChwYWdlX2Fk
ZHJlc3MoY21hX3BhZ2VzKSwgMCwgc2l6ZSk7CiAJfQogCi0JaGVscGVyX2J1ZmZlci0+cGFnZWNv
dW50ID0gbnJfcGFnZXM7Ci0JaGVscGVyX2J1ZmZlci0+cGFnZXMgPSBrbWFsbG9jX2FycmF5KGhl
bHBlcl9idWZmZXItPnBhZ2Vjb3VudCwKLQkJCQkJICAgICBzaXplb2YoKmhlbHBlcl9idWZmZXIt
PnBhZ2VzKSwKLQkJCQkJICAgICBHRlBfS0VSTkVMKTsKLQlpZiAoIWhlbHBlcl9idWZmZXItPnBh
Z2VzKSB7CisJYnVmZmVyLT5wYWdlcyA9IGttYWxsb2NfYXJyYXkocGFnZWNvdW50LCBzaXplb2Yo
KmJ1ZmZlci0+cGFnZXMpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWJ1ZmZlci0+cGFnZXMpIHsKIAkJ
cmV0ID0gLUVOT01FTTsKIAkJZ290byBmcmVlX2NtYTsKIAl9CiAKLQlmb3IgKHBnID0gMDsgcGcg
PCBoZWxwZXJfYnVmZmVyLT5wYWdlY291bnQ7IHBnKyspCi0JCWhlbHBlcl9idWZmZXItPnBhZ2Vz
W3BnXSA9ICZjbWFfcGFnZXNbcGddOworCWZvciAocGcgPSAwOyBwZyA8IHBhZ2Vjb3VudDsgcGcr
KykKKwkJYnVmZmVyLT5wYWdlc1twZ10gPSAmY21hX3BhZ2VzW3BnXTsKKworCWJ1ZmZlci0+Y21h
X3BhZ2VzID0gY21hX3BhZ2VzOworCWJ1ZmZlci0+aGVhcCA9IGNtYV9oZWFwOworCWJ1ZmZlci0+
cGFnZWNvdW50ID0gcGFnZWNvdW50OwogCiAJLyogY3JlYXRlIHRoZSBkbWFidWYgKi8KLQlkbWFi
dWYgPSBoZWFwX2hlbHBlcl9leHBvcnRfZG1hYnVmKGhlbHBlcl9idWZmZXIsIGZkX2ZsYWdzKTsK
KwlleHBfaW5mby5vcHMgPSAmY21hX2hlYXBfYnVmX29wczsKKwlleHBfaW5mby5zaXplID0gYnVm
ZmVyLT5sZW47CisJZXhwX2luZm8uZmxhZ3MgPSBmZF9mbGFnczsKKwlleHBfaW5mby5wcml2ID0g
YnVmZmVyOworCWRtYWJ1ZiA9IGRtYV9idWZfZXhwb3J0KCZleHBfaW5mbyk7CiAJaWYgKElTX0VS
UihkbWFidWYpKSB7CiAJCXJldCA9IFBUUl9FUlIoZG1hYnVmKTsKIAkJZ290byBmcmVlX3BhZ2Vz
OwogCX0KIAotCWhlbHBlcl9idWZmZXItPmRtYWJ1ZiA9IGRtYWJ1ZjsKLQloZWxwZXJfYnVmZmVy
LT5wcml2X3ZpcnQgPSBjbWFfcGFnZXM7Ci0KIAlyZXQgPSBkbWFfYnVmX2ZkKGRtYWJ1ZiwgZmRf
ZmxhZ3MpOwogCWlmIChyZXQgPCAwKSB7CiAJCWRtYV9idWZfcHV0KGRtYWJ1Zik7CkBAIC0xMjUs
MTEgKzM0MSwxMiBAQCBzdGF0aWMgaW50IGNtYV9oZWFwX2FsbG9jYXRlKHN0cnVjdCBkbWFfaGVh
cCAqaGVhcCwKIAlyZXR1cm4gcmV0OwogCiBmcmVlX3BhZ2VzOgotCWtmcmVlKGhlbHBlcl9idWZm
ZXItPnBhZ2VzKTsKKwlrZnJlZShidWZmZXItPnBhZ2VzKTsKIGZyZWVfY21hOgotCWNtYV9yZWxl
YXNlKGNtYV9oZWFwLT5jbWEsIGNtYV9wYWdlcywgbnJfcGFnZXMpOwotZnJlZV9idWY6Ci0Ja2Zy
ZWUoaGVscGVyX2J1ZmZlcik7CisJY21hX3JlbGVhc2UoY21hX2hlYXAtPmNtYSwgY21hX3BhZ2Vz
LCBwYWdlY291bnQpOworZnJlZV9idWZmZXI6CisJa2ZyZWUoYnVmZmVyKTsKKwogCXJldHVybiBy
ZXQ7CiB9CiAKLS0gCjIuMTcuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRl
c2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8v
ZHJpLWRldmVsCg==
