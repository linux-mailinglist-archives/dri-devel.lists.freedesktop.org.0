Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 9E8214B48E
	for <lists+dri-devel@lfdr.de>; Wed, 19 Jun 2019 11:04:56 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A7AF36E330;
	Wed, 19 Jun 2019 09:04:53 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A68E36E329
 for <dri-devel@lists.freedesktop.org>; Wed, 19 Jun 2019 09:04:29 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 467427FDF0;
 Wed, 19 Jun 2019 09:04:29 +0000 (UTC)
Received: from sirius.home.kraxel.org (ovpn-116-86.ams2.redhat.com
 [10.36.116.86])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 279BA5D70D;
 Wed, 19 Jun 2019 09:04:26 +0000 (UTC)
Received: by sirius.home.kraxel.org (Postfix, from userid 1000)
 id 1914E17536; Wed, 19 Jun 2019 11:04:22 +0200 (CEST)
From: Gerd Hoffmann <kraxel@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v3 09/12] drm/virtio: rework virtio_gpu_object_create fencing
Date: Wed, 19 Jun 2019 11:04:17 +0200
Message-Id: <20190619090420.6667-10-kraxel@redhat.com>
In-Reply-To: <20190619090420.6667-1-kraxel@redhat.com>
References: <20190619090420.6667-1-kraxel@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.27]); Wed, 19 Jun 2019 09:04:29 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, open list <linux-kernel@vger.kernel.org>,
 Gerd Hoffmann <kraxel@redhat.com>,
 "open list:VIRTIO GPU DRIVER" <virtualization@lists.linux-foundation.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VXNlIGdlbSByZXNlcnZhdGlvbiBoZWxwZXJzIGFuZCBkaXJlY3QgcmVzZXJ2YXRpb25fb2JqZWN0
XyogY2FsbHMKaW5zdGVhZCBvZiB0dG0uCgp2MzogRHVlIHRvIHVzaW5nIHRoZSBnZW0gcmVzZXJ2
YXRpb24gb2JqZWN0IGl0IGlzIGluaXRpYWxpemVkIGFuZCByZWFkeQpmb3IgdXNlIGJlZm9yZSBj
YWxsaW5nIHR0bV9ib19pbml0LCBzbyB3ZSBjYW4gYWxzbyBkcm9wIHRoZSB0cmlja3kgZmVuY2UK
bG9naWMgd2hpY2ggY2hlY2tzIHdoZW5ldmVyIHRoZSBjb21tYW5kIGlzIGluIGZsaWdodCBzdGls
bC4gIFdlIGNhbgpzaW1wbHkgZmVuY2Ugb3VyIG9iamVjdCBiZWZvcmUgc3VibWl0dGluZyB0aGUg
dmlydGlvIGNvbW1hbmQgYW5kIGJlIGRvbmUKd2l0aCBpdC4KClNpZ25lZC1vZmYtYnk6IEdlcmQg
SG9mZm1hbm4gPGtyYXhlbEByZWRoYXQuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS92aXJ0aW8v
dmlydGdwdV9kcnYuaCAgICB8ICA2ICsrLQogZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1
X29iamVjdC5jIHwgNTQgKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLQogZHJpdmVycy9ncHUvZHJt
L3ZpcnRpby92aXJ0Z3B1X3ZxLmMgICAgIHwgIDggKysrLQogMyBmaWxlcyBjaGFuZ2VkLCAzMCBp
bnNlcnRpb25zKCspLCAzOCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vdmlydGlvL3ZpcnRncHVfZHJ2LmggYi9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVf
ZHJ2LmgKaW5kZXggNTczMTczYzM1YzQ4Li44MzRjZjcxMzZjNzggMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV9kcnYuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vdmly
dGlvL3ZpcnRncHVfZHJ2LmgKQEAgLTI1OCw3ICsyNTgsOCBAQCB2b2lkIHZpcnRpb19ncHVfZnJl
ZV92YnVmcyhzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2KTsKIHZvaWQgdmlydGlvX2dw
dV9jbWRfY3JlYXRlX3Jlc291cmNlKHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAJ
CQkJICAgIHN0cnVjdCB2aXJ0aW9fZ3B1X29iamVjdCAqYm8sCiAJCQkJICAgIHN0cnVjdCB2aXJ0
aW9fZ3B1X29iamVjdF9wYXJhbXMgKnBhcmFtcywKLQkJCQkgICAgc3RydWN0IHZpcnRpb19ncHVf
ZmVuY2UgKmZlbmNlKTsKKwkJCQkgICAgc3RydWN0IHZpcnRpb19ncHVfZmVuY2UgKmZlbmNlLAor
CQkJCSAgICBzdHJ1Y3QgZHJtX2dlbV9vYmplY3RfYXJyYXkgKm9ianMpOwogdm9pZCB2aXJ0aW9f
Z3B1X2NtZF91bnJlZl9yZXNvdXJjZShzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAog
CQkJCSAgIHVpbnQzMl90IHJlc291cmNlX2lkKTsKIHZvaWQgdmlydGlvX2dwdV9jbWRfdHJhbnNm
ZXJfdG9faG9zdF8yZChzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LApAQCAtMzE5LDcg
KzMyMCw4IEBAIHZvaWQKIHZpcnRpb19ncHVfY21kX3Jlc291cmNlX2NyZWF0ZV8zZChzdHJ1Y3Qg
dmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogCQkJCSAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0
ICpibywKIAkJCQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X29iamVjdF9wYXJhbXMgKnBhcmFtcywKLQkJ
CQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSk7CisJCQkJICBzdHJ1Y3QgdmlydGlv
X2dwdV9mZW5jZSAqZmVuY2UsCisJCQkJICBzdHJ1Y3QgZHJtX2dlbV9vYmplY3RfYXJyYXkgKm9i
anMpOwogdm9pZCB2aXJ0aW9fZ3B1X2N0cmxfYWNrKHN0cnVjdCB2aXJ0cXVldWUgKnZxKTsKIHZv
aWQgdmlydGlvX2dwdV9jdXJzb3JfYWNrKHN0cnVjdCB2aXJ0cXVldWUgKnZxKTsKIHZvaWQgdmly
dGlvX2dwdV9mZW5jZV9hY2soc3RydWN0IHZpcnRxdWV1ZSAqdnEpOwpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jIGIvZHJpdmVycy9ncHUvZHJtL3Zp
cnRpby92aXJ0Z3B1X29iamVjdC5jCmluZGV4IDgyYmZiZjk4M2ZkMi4uY2UzM2ZmYTQ1MDc2IDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfb2JqZWN0LmMKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X29iamVjdC5jCkBAIC05OCw2ICs5OCw3IEBA
IGludCB2aXJ0aW9fZ3B1X29iamVjdF9jcmVhdGUoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2
Z2RldiwKIAkJCSAgICAgc3RydWN0IHZpcnRpb19ncHVfZmVuY2UgKmZlbmNlKQogewogCXN0cnVj
dCB2aXJ0aW9fZ3B1X29iamVjdCAqYm87CisJc3RydWN0IGRybV9nZW1fb2JqZWN0X2FycmF5ICpv
YmpzID0gTlVMTDsKIAlzaXplX3QgYWNjX3NpemU7CiAJaW50IHJldDsKIApAQCAtMTIzLDEwICsx
MjQsMjcgQEAgaW50IHZpcnRpb19ncHVfb2JqZWN0X2NyZWF0ZShzdHJ1Y3QgdmlydGlvX2dwdV9k
ZXZpY2UgKnZnZGV2LAogCX0KIAliby0+ZHVtYiA9IHBhcmFtcy0+ZHVtYjsKIAorCWlmIChmZW5j
ZSkgeworCQlzdHJ1Y3Qgd3dfYWNxdWlyZV9jdHggdGlja2V0OworCisJCW9ianMgPSBkcm1fZ2Vt
X2FycmF5X2FsbG9jKDEpOworCQlvYmpzLT5vYmpzWzBdID0gJmJvLT5nZW1fYmFzZTsKKwkJZHJt
X2dlbV9vYmplY3RfZ2V0KG9ianMtPm9ianNbMF0pOworCisJCXJldCA9IGRybV9nZW1fbG9ja19y
ZXNlcnZhdGlvbnMob2Jqcy0+b2Jqcywgb2Jqcy0+bmVudHMsCisJCQkJCQkmdGlja2V0KTsKKwkJ
aWYgKHJldCA9PSAwKQorCQkJcmVzZXJ2YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKG9ianMt
Pm9ianNbMF0tPnJlc3YsCisJCQkJCQkJICAmZmVuY2UtPmYpOworCQlkcm1fZ2VtX3VubG9ja19y
ZXNlcnZhdGlvbnMob2Jqcy0+b2Jqcywgb2Jqcy0+bmVudHMsICZ0aWNrZXQpOworCX0KKwogCWlm
IChwYXJhbXMtPnZpcmdsKSB7Ci0JCXZpcnRpb19ncHVfY21kX3Jlc291cmNlX2NyZWF0ZV8zZCh2
Z2RldiwgYm8sIHBhcmFtcywgZmVuY2UpOworCQl2aXJ0aW9fZ3B1X2NtZF9yZXNvdXJjZV9jcmVh
dGVfM2QodmdkZXYsIGJvLCBwYXJhbXMsCisJCQkJCQkgIGZlbmNlLCBvYmpzKTsKIAl9IGVsc2Ug
ewotCQl2aXJ0aW9fZ3B1X2NtZF9jcmVhdGVfcmVzb3VyY2UodmdkZXYsIGJvLCBwYXJhbXMsIGZl
bmNlKTsKKwkJdmlydGlvX2dwdV9jbWRfY3JlYXRlX3Jlc291cmNlKHZnZGV2LCBibywgcGFyYW1z
LAorCQkJCQkgICAgICAgZmVuY2UsIG9ianMpOwogCX0KIAogCXZpcnRpb19ncHVfaW5pdF90dG1f
cGxhY2VtZW50KGJvKTsKQEAgLTEzOSwzOCArMTU3LDYgQEAgaW50IHZpcnRpb19ncHVfb2JqZWN0
X2NyZWF0ZShzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogCWlmIChyZXQgIT0gMCkK
IAkJcmV0dXJuIHJldDsKIAotCWlmIChmZW5jZSkgewotCQlzdHJ1Y3QgdmlydGlvX2dwdV9mZW5j
ZV9kcml2ZXIgKmRydiA9ICZ2Z2Rldi0+ZmVuY2VfZHJ2OwotCQlzdHJ1Y3QgbGlzdF9oZWFkIHZh
bGlkYXRlX2xpc3Q7Ci0JCXN0cnVjdCB0dG1fdmFsaWRhdGVfYnVmZmVyIG1haW5idWY7Ci0JCXN0
cnVjdCB3d19hY3F1aXJlX2N0eCB0aWNrZXQ7Ci0JCXVuc2lnbmVkIGxvbmcgaXJxX2ZsYWdzOwot
CQlib29sIHNpZ25hbGVkOwotCi0JCUlOSVRfTElTVF9IRUFEKCZ2YWxpZGF0ZV9saXN0KTsKLQkJ
bWVtc2V0KCZtYWluYnVmLCAwLCBzaXplb2Yoc3RydWN0IHR0bV92YWxpZGF0ZV9idWZmZXIpKTsK
LQotCQkvKiB1c2UgYSBnZW0gcmVmZXJlbmNlIHNpbmNlIHVucmVmIGxpc3QgdW5kb2VzIHRoZW0g
Ki8KLQkJZHJtX2dlbV9vYmplY3RfZ2V0KCZiby0+Z2VtX2Jhc2UpOwotCQltYWluYnVmLmJvID0g
JmJvLT50Ym87Ci0JCWxpc3RfYWRkKCZtYWluYnVmLmhlYWQsICZ2YWxpZGF0ZV9saXN0KTsKLQot
CQlyZXQgPSB2aXJ0aW9fZ3B1X29iamVjdF9saXN0X3ZhbGlkYXRlKCZ0aWNrZXQsICZ2YWxpZGF0
ZV9saXN0KTsKLQkJaWYgKHJldCA9PSAwKSB7Ci0JCQlzcGluX2xvY2tfaXJxc2F2ZSgmZHJ2LT5s
b2NrLCBpcnFfZmxhZ3MpOwotCQkJc2lnbmFsZWQgPSB2aXJ0aW9fZmVuY2Vfc2lnbmFsZWQoJmZl
bmNlLT5mKTsKLQkJCWlmICghc2lnbmFsZWQpCi0JCQkJLyogdmlydGlvIGNyZWF0ZSBjb21tYW5k
IHN0aWxsIGluIGZsaWdodCAqLwotCQkJCXR0bV9ldV9mZW5jZV9idWZmZXJfb2JqZWN0cygmdGlj
a2V0LCAmdmFsaWRhdGVfbGlzdCwKLQkJCQkJCQkgICAgJmZlbmNlLT5mKTsKLQkJCXNwaW5fdW5s
b2NrX2lycXJlc3RvcmUoJmRydi0+bG9jaywgaXJxX2ZsYWdzKTsKLQkJCWlmIChzaWduYWxlZCkK
LQkJCQkvKiB2aXJ0aW8gY3JlYXRlIGNvbW1hbmQgZmluaXNoZWQgKi8KLQkJCQl0dG1fZXVfYmFj
a29mZl9yZXNlcnZhdGlvbigmdGlja2V0LCAmdmFsaWRhdGVfbGlzdCk7Ci0JCX0KLQkJdmlydGlv
X2dwdV91bnJlZl9saXN0KCZ2YWxpZGF0ZV9saXN0KTsKLQl9Ci0KIAkqYm9fcHRyID0gYm87CiAJ
cmV0dXJuIDA7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVf
dnEuYyBiL2RyaXZlcnMvZ3B1L2RybS92aXJ0aW8vdmlydGdwdV92cS5jCmluZGV4IDZlZmVhNGZj
YTAxMi4uZjA2MDliMDdmODU5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3Zp
cnRncHVfdnEuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfdnEuYwpAQCAt
MzkxLDEzICszOTEsMTUgQEAgc3RhdGljIGludCB2aXJ0aW9fZ3B1X3F1ZXVlX2N1cnNvcihzdHJ1
Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogdm9pZCB2aXJ0aW9fZ3B1X2NtZF9jcmVhdGVf
cmVzb3VyY2Uoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKIAkJCQkgICAgc3RydWN0
IHZpcnRpb19ncHVfb2JqZWN0ICpibywKIAkJCQkgICAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0
X3BhcmFtcyAqcGFyYW1zLAotCQkJCSAgICBzdHJ1Y3QgdmlydGlvX2dwdV9mZW5jZSAqZmVuY2Up
CisJCQkJICAgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSwKKwkJCQkgICAgc3RydWN0
IGRybV9nZW1fb2JqZWN0X2FycmF5ICpvYmpzKQogewogCXN0cnVjdCB2aXJ0aW9fZ3B1X3Jlc291
cmNlX2NyZWF0ZV8yZCAqY21kX3A7CiAJc3RydWN0IHZpcnRpb19ncHVfdmJ1ZmZlciAqdmJ1ZjsK
IAogCWNtZF9wID0gdmlydGlvX2dwdV9hbGxvY19jbWQodmdkZXYsICZ2YnVmLCBzaXplb2YoKmNt
ZF9wKSk7CiAJbWVtc2V0KGNtZF9wLCAwLCBzaXplb2YoKmNtZF9wKSk7CisJdmJ1Zi0+b2JqcyA9
IG9ianM7CiAKIAljbWRfcC0+aGRyLnR5cGUgPSBjcHVfdG9fbGUzMihWSVJUSU9fR1BVX0NNRF9S
RVNPVVJDRV9DUkVBVEVfMkQpOwogCWNtZF9wLT5yZXNvdXJjZV9pZCA9IGNwdV90b19sZTMyKGJv
LT5od19yZXNfaGFuZGxlKTsKQEAgLTg2NCwxMyArODY2LDE1IEBAIHZvaWQKIHZpcnRpb19ncHVf
Y21kX3Jlc291cmNlX2NyZWF0ZV8zZChzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAog
CQkJCSAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0ICpibywKIAkJCQkgIHN0cnVjdCB2aXJ0aW9f
Z3B1X29iamVjdF9wYXJhbXMgKnBhcmFtcywKLQkJCQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNl
ICpmZW5jZSkKKwkJCQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSwKKwkJCQkgIHN0
cnVjdCBkcm1fZ2VtX29iamVjdF9hcnJheSAqb2JqcykKIHsKIAlzdHJ1Y3QgdmlydGlvX2dwdV9y
ZXNvdXJjZV9jcmVhdGVfM2QgKmNtZF9wOwogCXN0cnVjdCB2aXJ0aW9fZ3B1X3ZidWZmZXIgKnZi
dWY7CiAKIAljbWRfcCA9IHZpcnRpb19ncHVfYWxsb2NfY21kKHZnZGV2LCAmdmJ1Ziwgc2l6ZW9m
KCpjbWRfcCkpOwogCW1lbXNldChjbWRfcCwgMCwgc2l6ZW9mKCpjbWRfcCkpOworCXZidWYtPm9i
anMgPSBvYmpzOwogCiAJY21kX3AtPmhkci50eXBlID0gY3B1X3RvX2xlMzIoVklSVElPX0dQVV9D
TURfUkVTT1VSQ0VfQ1JFQVRFXzNEKTsKIAljbWRfcC0+cmVzb3VyY2VfaWQgPSBjcHVfdG9fbGUz
Mihiby0+aHdfcmVzX2hhbmRsZSk7Ci0tIAoyLjE4LjEKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVs
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
