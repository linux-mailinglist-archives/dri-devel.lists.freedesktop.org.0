Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 2AC2095148
	for <lists+dri-devel@lfdr.de>; Tue, 20 Aug 2019 01:03:52 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A324F6E468;
	Mon, 19 Aug 2019 23:03:46 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pf1-x441.google.com (mail-pf1-x441.google.com
 [IPv6:2607:f8b0:4864:20::441])
 by gabe.freedesktop.org (Postfix) with ESMTPS id DB70A6E45B
 for <dri-devel@lists.freedesktop.org>; Mon, 19 Aug 2019 23:03:37 +0000 (UTC)
Received: by mail-pf1-x441.google.com with SMTP id v12so2070613pfn.10
 for <dri-devel@lists.freedesktop.org>; Mon, 19 Aug 2019 16:03:37 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=JD7m4tZwO+IDa1xgX/FwZAd/NdHORHjMi+i9qNb5uKs=;
 b=WlxVWENjhwnQrIACXoMwnvT2f+y6TPpMvwDzZMd0aJE0x+m76Fh95234gKHE5xVa6H
 02x0tUg8KL76dnBs8Dc1AgWGNlpGgELBfBBbGX+6yK0UDUwVygJ4mq8NBg2TzVI6E0OP
 tUPwH1gFLtnVxjdeZr39d4NeYCp6y1Q2tijv/2DpKj7n35dc0ozQUCXpDy0JhhWOr1xk
 6QcdzJWnkBTZZIQ8S5ufKdTtuQ2IUkrhK6uCJAwPQdMZNGQX6VeqxZL3ZsVxMpkxo6c4
 G4Bzo+VVKEPMdQW5rt/u/c88zcxUAMIqAVAqOlwRkdMfqFxHnNEfmRvL0KwbEzs3NeZu
 RH0A==
X-Gm-Message-State: APjAAAUVh8USlNYqIBf0tuezgvf70mw+YKhMa64lGlwpd7tcMCpjxkbV
 U128fZBof38yiOKOk6a5aKufGQ==
X-Google-Smtp-Source: APXvYqyqpP1PwbnaQJr6HO5/U9c9TYoGinZSl4NN8syYf4BdEDDa9pVcGA6gwkSAMsFc948LLVbWTQ==
X-Received: by 2002:a62:83c9:: with SMTP id h192mr26119646pfe.57.1566255817313; 
 Mon, 19 Aug 2019 16:03:37 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 j15sm17256509pfr.146.2019.08.19.16.03.35
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 19 Aug 2019 16:03:36 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v4 08/25] drm: kirin: Dynamically allocate the hw_ctx
Date: Mon, 19 Aug 2019 23:03:04 +0000
Message-Id: <20190819230321.56480-9-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190819230321.56480-1-john.stultz@linaro.org>
References: <20190819230321.56480-1-john.stultz@linaro.org>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=JD7m4tZwO+IDa1xgX/FwZAd/NdHORHjMi+i9qNb5uKs=;
 b=K8UBp8pFTBCLS2af/ixfreNcrk0g7xTA0YI6qqiBVZtEfdhK+Ayf3sDdZ3ha3RVNzs
 MOq+rEP5I4yPMf1Jfbi4kDCsCkDVDbxLFnpbEIwdegzvs42kZPhm7l+/f1H4qgWj2TAD
 rgO7v7U5Z25QFpzo7q8f3cG/2uSP20a/P0mP0V/I55s18uALYAZUXMMG1dSjVNNlPPp+
 ULIwvEi9955TpK1QayL6VVQyXfjs9CwOxA6LZsLA1QJ1W9YCQ6Qjo6+nVuiYdOhE629W
 jMwbc02cMB2VVM99ZOpbwLrTY7ykc6ngFn3+jR/Wo9K3Jew7CKF0Mhnpwil/kkl5eVuo
 5L1w==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Xu YiPing <xuyiping@hisilicon.com>, David Airlie <airlied@linux.ie>,
 dri-devel <dri-devel@lists.freedesktop.org>,
 Xinliang Liu <z.liuxinliang@hisilicon.com>,
 Rongrong Zou <zourongrong@gmail.com>, Sam Ravnborg <sam@ravnborg.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogWHUgWWlQaW5nIDx4dXlpcGluZ0BoaXNpbGljb24uY29tPgoKQXMgcGFydCBvZiByZWZh
Y3RvcmluZyB0aGUga2lyaW4gZHJpdmVyIHRvIGJldHRlciBzdXBwb3J0CmRpZmZlcmVudCBoYXJk
d2FyZSByZXZpc2lvbnMsIHRoaXMgcGF0Y2ggbW9kaWZpZXMgdGhlCmluaXRpYWxpemF0aW9uIGZ1
bmN0aW9uIHRvIGR5bmFtaWNhbGx5IGFsbG9jYXRlIHRoZSBhZGVfaHdfY3R4CnN0cnVjdHVyZSBw
cmV2aW91c2x5IGtlcHQgYXMgcGFydCBvZiBzdHJ1Y3QgYWRlX2RhdGEuCgpUaGlzIGlzIGRvbmUg
c28gdGhhdCBsYXRlciB3ZSBjYW4gaGF2ZSB0aGUgaHdfY3R4IHBvaW50IHRvCmhhcmR3YXJlIHJl
dmlzaW9uIHNwZWNpZmljIGN0eCBzdHJ1Y3R1cmVzLgoKQ2M6IFJvbmdyb25nIFpvdSA8em91cm9u
Z3JvbmdAZ21haWwuY29tPgpDYzogWGlubGlhbmcgTGl1IDx6LmxpdXhpbmxpYW5nQGhpc2lsaWNv
bi5jb20+CkNjOiBEYXZpZCBBaXJsaWUgPGFpcmxpZWRAbGludXguaWU+CkNjOiBEYW5pZWwgVmV0
dGVyIDxkYW5pZWxAZmZ3bGwuY2g+CkNjOiBkcmktZGV2ZWwgPGRyaS1kZXZlbEBsaXN0cy5mcmVl
ZGVza3RvcC5vcmc+CkNjOiBTYW0gUmF2bmJvcmcgPHNhbUByYXZuYm9yZy5vcmc+CkFja2VkLWJ5
OiBYaW5saWFuZyBMaXUgPHoubGl1eGlubGlhbmdAaGlzaWxpY29uLmNvbT4KUmV2aWV3ZWQtYnk6
IFNhbSBSYXZuYm9yZyA8c2FtQHJhdm5ib3JnLm9yZz4KU2lnbmVkLW9mZi1ieTogWHUgWWlQaW5n
IDx4dXlpcGluZ0BoaXNpbGljb24uY29tPgpbanN0dWx0ejogcmV3b3JkZWQgY29tbWl0IG1lc3Nh
Z2VdClNpZ25lZC1vZmYtYnk6IEpvaG4gU3R1bHR6IDxqb2huLnN0dWx0ekBsaW5hcm8ub3JnPgot
LS0KIC4uLi9ncHUvZHJtL2hpc2lsaWNvbi9raXJpbi9raXJpbl9kcm1fYWRlLmMgICB8IDM5ICsr
KysrKysrKysrKy0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAyNCBpbnNlcnRpb25zKCspLCAxNSBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaGlzaWxpY29uL2tpcmlu
L2tpcmluX2RybV9hZGUuYyBiL2RyaXZlcnMvZ3B1L2RybS9oaXNpbGljb24va2lyaW4va2lyaW5f
ZHJtX2FkZS5jCmluZGV4IGZjZTM3NGVjNjllOC4uZWNiNTA3OTg1ZmVhIDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vaGlzaWxpY29uL2tpcmluL2tpcmluX2RybV9hZGUuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vaGlzaWxpY29uL2tpcmluL2tpcmluX2RybV9hZGUuYwpAQCAtNzIsNyArNzIs
NyBAQCBzdHJ1Y3Qga2lyaW5fcGxhbmUgewogc3RydWN0IGFkZV9kYXRhIHsKIAlzdHJ1Y3Qga2ly
aW5fY3J0YyBjcnRjOwogCXN0cnVjdCBraXJpbl9wbGFuZSBwbGFuZXNbQURFX0NIX05VTV07Ci0J
c3RydWN0IGFkZV9od19jdHggY3R4OworCXN0cnVjdCBhZGVfaHdfY3R4ICpod19jdHg7CiB9Owog
CiAvKiBhZGUtZm9ybWF0IGluZm86ICovCkBAIC05NTEsNTUgKzk1MSw2MiBAQCBzdGF0aWMgaW50
IGFkZV9wbGFuZV9pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHN0cnVjdCBraXJpbl9wbGFu
ZSAqa3BsYW5lLAogCXJldHVybiAwOwogfQogCi1zdGF0aWMgaW50IGFkZV9kdHNfcGFyc2Uoc3Ry
dWN0IHBsYXRmb3JtX2RldmljZSAqcGRldiwgc3RydWN0IGFkZV9od19jdHggKmN0eCkKK3N0YXRp
YyB2b2lkICphZGVfaHdfY3R4X2FsbG9jKHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYpCiB7
CiAJc3RydWN0IHJlc291cmNlICpyZXM7CiAJc3RydWN0IGRldmljZSAqZGV2ID0gJnBkZXYtPmRl
djsKIAlzdHJ1Y3QgZGV2aWNlX25vZGUgKm5wID0gcGRldi0+ZGV2Lm9mX25vZGU7CisJc3RydWN0
IGFkZV9od19jdHggKmN0eCA9IE5VTEw7CisKKwljdHggPSBkZXZtX2t6YWxsb2MoZGV2LCBzaXpl
b2YoKmN0eCksIEdGUF9LRVJORUwpOworCWlmICghY3R4KSB7CisJCURSTV9FUlJPUigiZmFpbGVk
IHRvIGFsbG9jIGFkZV9od19jdHhcbiIpOworCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKKwl9
CiAKIAlyZXMgPSBwbGF0Zm9ybV9nZXRfcmVzb3VyY2UocGRldiwgSU9SRVNPVVJDRV9NRU0sIDAp
OwogCWN0eC0+YmFzZSA9IGRldm1faW9yZW1hcF9yZXNvdXJjZShkZXYsIHJlcyk7CiAJaWYgKElT
X0VSUihjdHgtPmJhc2UpKSB7CiAJCURSTV9FUlJPUigiZmFpbGVkIHRvIHJlbWFwIGFkZSBpbyBi
YXNlXG4iKTsKLQkJcmV0dXJuICBQVFJfRVJSKGN0eC0+YmFzZSk7CisJCXJldHVybiBFUlJfUFRS
KC1FSU8pOwogCX0KIAogCWN0eC0+cmVzZXQgPSBkZXZtX3Jlc2V0X2NvbnRyb2xfZ2V0KGRldiwg
TlVMTCk7CiAJaWYgKElTX0VSUihjdHgtPnJlc2V0KSkKLQkJcmV0dXJuIFBUUl9FUlIoY3R4LT5y
ZXNldCk7CisJCXJldHVybiBFUlJfUFRSKC1FTk9ERVYpOwogCiAJY3R4LT5ub2NfcmVnbWFwID0K
IAkJc3lzY29uX3JlZ21hcF9sb29rdXBfYnlfcGhhbmRsZShucCwgImhpc2lsaWNvbixub2Mtc3lz
Y29uIik7CiAJaWYgKElTX0VSUihjdHgtPm5vY19yZWdtYXApKSB7CiAJCURSTV9FUlJPUigiZmFp
bGVkIHRvIGdldCBub2MgcmVnbWFwXG4iKTsKLQkJcmV0dXJuIFBUUl9FUlIoY3R4LT5ub2NfcmVn
bWFwKTsKKwkJcmV0dXJuIEVSUl9QVFIoLUVOT0RFVik7CiAJfQogCiAJY3R4LT5pcnEgPSBwbGF0
Zm9ybV9nZXRfaXJxKHBkZXYsIDApOwogCWlmIChjdHgtPmlycSA8IDApIHsKIAkJRFJNX0VSUk9S
KCJmYWlsZWQgdG8gZ2V0IGlycVxuIik7Ci0JCXJldHVybiAtRU5PREVWOworCQlyZXR1cm4gRVJS
X1BUUigtRU5PREVWKTsKIAl9CiAKIAljdHgtPmFkZV9jb3JlX2NsayA9IGRldm1fY2xrX2dldChk
ZXYsICJjbGtfYWRlX2NvcmUiKTsKIAlpZiAoSVNfRVJSKGN0eC0+YWRlX2NvcmVfY2xrKSkgewog
CQlEUk1fRVJST1IoImZhaWxlZCB0byBwYXJzZSBjbGsgQURFX0NPUkVcbiIpOwotCQlyZXR1cm4g
UFRSX0VSUihjdHgtPmFkZV9jb3JlX2Nsayk7CisJCXJldHVybiBFUlJfUFRSKC1FTk9ERVYpOwog
CX0KIAogCWN0eC0+bWVkaWFfbm9jX2NsayA9IGRldm1fY2xrX2dldChkZXYsICJjbGtfY29kZWNf
anBlZyIpOwogCWlmIChJU19FUlIoY3R4LT5tZWRpYV9ub2NfY2xrKSkgewogCQlEUk1fRVJST1Io
ImZhaWxlZCB0byBwYXJzZSBjbGsgQ09ERUNfSlBFR1xuIik7Ci0JCXJldHVybiBQVFJfRVJSKGN0
eC0+bWVkaWFfbm9jX2Nsayk7CisJCXJldHVybiBFUlJfUFRSKC1FTk9ERVYpOwogCX0KIAogCWN0
eC0+YWRlX3BpeF9jbGsgPSBkZXZtX2Nsa19nZXQoZGV2LCAiY2xrX2FkZV9waXgiKTsKIAlpZiAo
SVNfRVJSKGN0eC0+YWRlX3BpeF9jbGspKSB7CiAJCURSTV9FUlJPUigiZmFpbGVkIHRvIHBhcnNl
IGNsayBBREVfUElYXG4iKTsKLQkJcmV0dXJuIFBUUl9FUlIoY3R4LT5hZGVfcGl4X2Nsayk7CisJ
CXJldHVybiBFUlJfUFRSKC1FTk9ERVYpOwogCX0KIAotCXJldHVybiAwOworCXJldHVybiBjdHg7
CiB9CiAKIHN0YXRpYyBpbnQgYWRlX2RybV9pbml0KHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBk
ZXYpCkBAIC0xMDIwLDE0ICsxMDI3LDE2IEBAIHN0YXRpYyBpbnQgYWRlX2RybV9pbml0KHN0cnVj
dCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYpCiAJfQogCXBsYXRmb3JtX3NldF9kcnZkYXRhKHBkZXYs
IGFkZSk7CiAKLQljdHggPSAmYWRlLT5jdHg7CisJY3R4ID0gYWRlX2h3X2N0eF9hbGxvYyhwZGV2
KTsKKwlpZiAoSVNfRVJSKGN0eCkpIHsKKwkJRFJNX0VSUk9SKCJmYWlsZWQgdG8gaW5pdGlhbGl6
ZSBraXJpbl9wcml2IGh3IGN0eFxuIik7CisJCXJldHVybiAtRUlOVkFMOworCX0KKwlhZGUtPmh3
X2N0eCA9IGN0eDsKKwogCWtjcnRjID0gJmFkZS0+Y3J0YzsKIAlrY3J0Yy0+aHdfY3R4ID0gY3R4
OwogCi0JcmV0ID0gYWRlX2R0c19wYXJzZShwZGV2LCBjdHgpOwotCWlmIChyZXQpCi0JCXJldHVy
biByZXQ7Ci0KIAkvKgogCSAqIHBsYW5lIGluaXQKIAkgKiBUT0RPOiBOb3cgb25seSBzdXBwb3J0
IHByaW1hcnkgcGxhbmUsIG92ZXJsYXkgcGxhbmVzCi0tIAoyLjE3LjEKCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QK
ZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9w
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
