Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B4A36F1011
	for <lists+dri-devel@lfdr.de>; Wed,  6 Nov 2019 08:14:27 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id CCF546EC0D;
	Wed,  6 Nov 2019 07:14:24 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from us-smtp-1.mimecast.com (us-smtp-delivery-1.mimecast.com
 [205.139.110.120])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1D6526EC14
 for <dri-devel@lists.freedesktop.org>; Wed,  6 Nov 2019 07:14:24 +0000 (UTC)
Received: from mimecast-mx01.redhat.com (mimecast-mx01.redhat.com
 [209.132.183.4]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-88-YSb2ObhtMtej5K6Kghc6SQ-1; Wed, 06 Nov 2019 02:14:19 -0500
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mimecast-mx01.redhat.com (Postfix) with ESMTPS id 79447477;
 Wed,  6 Nov 2019 07:14:15 +0000 (UTC)
Received: from jason-ThinkPad-X1-Carbon-6th.redhat.com
 (ovpn-12-193.pek2.redhat.com [10.72.12.193])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 4E2961001B00;
 Wed,  6 Nov 2019 07:12:27 +0000 (UTC)
From: Jason Wang <jasowang@redhat.com>
To: kvm@vger.kernel.org, linux-s390@vger.kernel.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 intel-gfx@lists.freedesktop.org, intel-gvt-dev@lists.freedesktop.org,
 kwankhede@nvidia.com, alex.williamson@redhat.com, mst@redhat.com,
 tiwei.bie@intel.com
Subject: [PATCH V9 5/6] virtio: introduce a mdev based transport
Date: Wed,  6 Nov 2019 15:05:47 +0800
Message-Id: <20191106070548.18980-6-jasowang@redhat.com>
In-Reply-To: <20191106070548.18980-1-jasowang@redhat.com>
References: <20191106070548.18980-1-jasowang@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-MC-Unique: YSb2ObhtMtej5K6Kghc6SQ-1
X-Mimecast-Spam-Score: 0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=redhat.com; 
 s=mimecast20190719; t=1573024463;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=ZIJAtuaeC/flAgfyNCJGB/oqkTsDq4tzC/SAiq6v5f0=;
 b=RK7ibLMnKPP7VdQlHjb0AQCvGE9CDK8M673ZdfDZ5leTHhjVIyR4KzI/Yekvp2Zqt743ad
 Mx7TCeWOBJUWIGRN+FtrxaSNL1fsAb5aFmQQleSgK+a7SR5gT4+SP+66N6LMFD368uZ6RL
 PxgKN6q+fX86oFHeDbpqxyh7OfnBrJY=
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: christophe.de.dinechin@gmail.com, sebott@linux.ibm.com, airlied@linux.ie,
 Jason Wang <jasowang@redhat.com>, heiko.carstens@de.ibm.com,
 kevin.tian@intel.com, virtualization@lists.linux-foundation.org,
 rob.miller@broadcom.com, lulu@redhat.com, eperezma@redhat.com,
 pasic@linux.ibm.com, borntraeger@de.ibm.com, haotian.wang@sifive.com,
 zhi.a.wang@intel.com, farman@linux.ibm.com, idos@mellanox.com,
 gor@linux.ibm.com, cunming.liang@intel.com, rodrigo.vivi@intel.com,
 xiao.w.wang@intel.com, freude@linux.ibm.com, parav@mellanox.com,
 zhihong.wang@intel.com, stefanha@redhat.com, akrowiak@linux.ibm.com,
 netdev@vger.kernel.org, cohuck@redhat.com, oberpar@linux.ibm.com,
 maxime.coquelin@redhat.com, lingshan.zhu@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBpbnRyb2R1Y2VzIGEgbmV3IG1kZXYgdHJhbnNwb3J0IGZvciB2aXJ0aW8uIFRo
aXMgaXMgdXNlZCB0bwp1c2Uga2VybmVsIHZpcnRpbyBkcml2ZXIgdG8gZHJpdmUgdGhlIG1lZGlh
dGVkIGRldmljZSB0aGF0IGlzIGNhcGFibGUKb2YgcG9wdWxhdGluZyB2aXJ0cXVldWUgZGlyZWN0
bHkuCgpBIG5ldyB2aXJ0aW8tbWRldiBkcml2ZXIgd2lsbCBiZSByZWdpc3RlcmVkIHRvIHRoZSBt
ZGV2IGJ1cywgd2hlbiBhCm5ldyB2aXJ0aW8tbWRldiBkZXZpY2UgaXMgcHJvYmVkLCBpdCB3aWxs
IHJlZ2lzdGVyIHRoZSBkZXZpY2Ugd2l0aAptZGV2IGJhc2VkIGNvbmZpZyBvcHMuIFRoaXMgbWVh
bnMgaXQgaXMgYSBzb2Z0d2FyZSB0cmFuc3BvcnQgYmV0d2VlbgptZGV2IGRyaXZlciBhbmQgbWRl
diBkZXZpY2UuIFRoZSB0cmFuc3BvcnQgd2FzIGltcGxlbWVudGVkIHRocm91Z2gKZGV2aWNlIHNw
ZWNpZmljIG9wcyB3aGljaCBpcyBhIHBhcnQgb2YgbWRldl9wYXJlbnRfb3BzIG5vdy4KClNpZ25l
ZC1vZmYtYnk6IEphc29uIFdhbmcgPGphc293YW5nQHJlZGhhdC5jb20+Ci0tLQogZHJpdmVycy92
aXJ0aW8vS2NvbmZpZyAgICAgICB8ICAxMyArKwogZHJpdmVycy92aXJ0aW8vTWFrZWZpbGUgICAg
ICB8ICAgMSArCiBkcml2ZXJzL3ZpcnRpby92aXJ0aW9fbWRldi5jIHwgNDA2ICsrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDQyMCBpbnNlcnRpb25z
KCspCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy92aXJ0aW8vdmlydGlvX21kZXYuYwoKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvdmlydGlvL0tjb25maWcgYi9kcml2ZXJzL3ZpcnRpby9LY29uZmln
CmluZGV4IDA3ODYxNWNmMmFmYy4uNTU4YWM2MDdkMTA3IDEwMDY0NAotLS0gYS9kcml2ZXJzL3Zp
cnRpby9LY29uZmlnCisrKyBiL2RyaXZlcnMvdmlydGlvL0tjb25maWcKQEAgLTQzLDYgKzQzLDE5
IEBAIGNvbmZpZyBWSVJUSU9fUENJX0xFR0FDWQogCiAJICBJZiB1bnN1cmUsIHNheSBZLgogCitj
b25maWcgVklSVElPX01ERVYKKwl0cmlzdGF0ZSAiTURFViBkcml2ZXIgZm9yIHZpcnRpbyBkZXZp
Y2VzIgorCWRlcGVuZHMgb24gVkZJT19NREVWICYmIFZJUlRJTworCWRlZmF1bHQgbgorCWhlbHAK
KwkgIFRoaXMgZHJpdmVyIHByb3ZpZGVzIHN1cHBvcnQgZm9yIHZpcnRpbyBiYXNlZCBwYXJhdmly
dHVhbAorCSAgZGV2aWNlIGRyaXZlciBvdmVyIE1ERVYgYnVzLiBUaGlzIHJlcXVpcmVzIHlvdXIg
ZW52aXJvbmVtbnQKKwkgIGhhcyBhcHByb3ByaWF0ZSB2aXJ0aW8gbWRldiBkZXZpY2UgaW1wbGVt
ZW50YXRpb24gd2hpY2ggbWF5CisJICBvcGVyYXRlIG9uIHRoZSBwaHlzaWNhbCBkZXZpY2UgdGhh
dCB0aGUgZGF0YXBhdGggb2YgdmlydGlvCisJICBjb3VsZCBiZSBvZmZsb2FkZWQgdG8gaGFyZHdh
cmUuCisKKwkgIElmIHVuc3VyZSwgc2F5IE0KKwogY29uZmlnIFZJUlRJT19QTUVNCiAJdHJpc3Rh
dGUgIlN1cHBvcnQgZm9yIHZpcnRpbyBwbWVtIGRyaXZlciIKIAlkZXBlbmRzIG9uIFZJUlRJTwpk
aWZmIC0tZ2l0IGEvZHJpdmVycy92aXJ0aW8vTWFrZWZpbGUgYi9kcml2ZXJzL3ZpcnRpby9NYWtl
ZmlsZQppbmRleCAzYTJiNWM1ZGNmNDYuLmYyOTk3YjZjODEyZiAxMDA2NDQKLS0tIGEvZHJpdmVy
cy92aXJ0aW8vTWFrZWZpbGUKKysrIGIvZHJpdmVycy92aXJ0aW8vTWFrZWZpbGUKQEAgLTYsMyAr
Niw0IEBAIHZpcnRpb19wY2kteSA6PSB2aXJ0aW9fcGNpX21vZGVybi5vIHZpcnRpb19wY2lfY29t
bW9uLm8KIHZpcnRpb19wY2ktJChDT05GSUdfVklSVElPX1BDSV9MRUdBQ1kpICs9IHZpcnRpb19w
Y2lfbGVnYWN5Lm8KIG9iai0kKENPTkZJR19WSVJUSU9fQkFMTE9PTikgKz0gdmlydGlvX2JhbGxv
b24ubwogb2JqLSQoQ09ORklHX1ZJUlRJT19JTlBVVCkgKz0gdmlydGlvX2lucHV0Lm8KK29iai0k
KENPTkZJR19WSVJUSU9fTURFVikgKz0gdmlydGlvX21kZXYubwpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy92aXJ0aW8vdmlydGlvX21kZXYuYyBiL2RyaXZlcnMvdmlydGlvL3ZpcnRpb19tZGV2LmMKbmV3
IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAwMDAwLi45ZTEyZWYyNDA0OTMKLS0tIC9k
ZXYvbnVsbAorKysgYi9kcml2ZXJzL3ZpcnRpby92aXJ0aW9fbWRldi5jCkBAIC0wLDAgKzEsNDA2
IEBACisvLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogR1BMLTIuMC1vbmx5CisvKgorICogVklS
VElPIGJhc2VkIGRyaXZlciBmb3IgTWVkaWF0ZWQgZGV2aWNlCisgKgorICogQ29weXJpZ2h0IChj
KSAyMDE5LCBSZWQgSGF0LiBBbGwgcmlnaHRzIHJlc2VydmVkLgorICogICAgIEF1dGhvcjogSmFz
b24gV2FuZyA8amFzb3dhbmdAcmVkaGF0LmNvbT4KKyAqCisgKi8KKworI2luY2x1ZGUgPGxpbnV4
L2luaXQuaD4KKyNpbmNsdWRlIDxsaW51eC9tb2R1bGUuaD4KKyNpbmNsdWRlIDxsaW51eC9kZXZp
Y2UuaD4KKyNpbmNsdWRlIDxsaW51eC9rZXJuZWwuaD4KKyNpbmNsdWRlIDxsaW51eC9zbGFiLmg+
CisjaW5jbHVkZSA8bGludXgvdXVpZC5oPgorI2luY2x1ZGUgPGxpbnV4L21kZXYuaD4KKyNpbmNs
dWRlIDxsaW51eC9tZGV2X3ZpcnRpb19vcHMuaD4KKyNpbmNsdWRlIDxsaW51eC92aXJ0aW8uaD4K
KyNpbmNsdWRlIDxsaW51eC92aXJ0aW9fY29uZmlnLmg+CisjaW5jbHVkZSA8bGludXgvdmlydGlv
X3JpbmcuaD4KKworI2RlZmluZSBEUklWRVJfVkVSU0lPTiAgIjAuMSIKKyNkZWZpbmUgRFJJVkVS
X0FVVEhPUiAgICJSZWQgSGF0IENvcnBvcmF0aW9uIgorI2RlZmluZSBEUklWRVJfREVTQyAgICAg
IlZJUlRJTyBiYXNlZCBkcml2ZXIgZm9yIE1lZGlhdGVkIGRldmljZSIKKworI2RlZmluZSB0b192
aXJ0aW9fbWRldl9kZXZpY2UoZGV2KSBcCisJY29udGFpbmVyX29mKGRldiwgc3RydWN0IHZpcnRp
b19tZGV2X2RldmljZSwgdmRldikKKworc3RydWN0IHZpcnRpb19tZGV2X2RldmljZSB7CisJc3Ry
dWN0IHZpcnRpb19kZXZpY2UgdmRldjsKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXY7CisJdTY0
IGZlYXR1cmVzOworCisJLyogVGhlIGxvY2sgdG8gcHJvdGVjdCB2aXJ0cXVldWUgbGlzdCAqLwor
CXNwaW5sb2NrX3QgbG9jazsKKwkvKiBMaXN0IG9mIHZpcnRpb19tZGV2X3ZxX2luZm8gKi8KKwlz
dHJ1Y3QgbGlzdF9oZWFkIHZpcnRxdWV1ZXM7Cit9OworCitzdHJ1Y3QgdmlydGlvX21kZXZfdnFf
aW5mbyB7CisJLyogdGhlIGFjdHVhbCB2aXJ0cXVldWUgKi8KKwlzdHJ1Y3QgdmlydHF1ZXVlICp2
cTsKKworCS8qIHRoZSBsaXN0IG5vZGUgZm9yIHRoZSB2aXJ0cXVldWVzIGxpc3QgKi8KKwlzdHJ1
Y3QgbGlzdF9oZWFkIG5vZGU7Cit9OworCitzdGF0aWMgc3RydWN0IG1kZXZfZGV2aWNlICp2bV9n
ZXRfbWRldihzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldikKK3sKKwlzdHJ1Y3QgdmlydGlvX21k
ZXZfZGV2aWNlICp2bV9kZXYgPSB0b192aXJ0aW9fbWRldl9kZXZpY2UodmRldik7CisJc3RydWN0
IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZGV2LT5tZGV2OworCisJcmV0dXJuIG1kZXY7Cit9CisK
K3N0YXRpYyB2b2lkIHZpcnRpb19tZGV2X2dldChzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldiwg
dW5zaWduZWQgb2Zmc2V0LAorCQkJICAgIHZvaWQgKmJ1ZiwgdW5zaWduZWQgbGVuKQoreworCXN0
cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVj
dCBtZGV2X3ZpcnRpb19kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92aXJ0aW9fb3BzKG1kZXYp
OworCisJb3BzLT5nZXRfY29uZmlnKG1kZXYsIG9mZnNldCwgYnVmLCBsZW4pOworfQorCitzdGF0
aWMgdm9pZCB2aXJ0aW9fbWRldl9zZXQoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYsIHVuc2ln
bmVkIG9mZnNldCwKKwkJCSAgICBjb25zdCB2b2lkICpidWYsIHVuc2lnbmVkIGxlbikKK3sKKwlz
dHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9nZXRfbWRldih2ZGV2KTsKKwljb25zdCBzdHJ1
Y3QgbWRldl92aXJ0aW9fZGV2aWNlX29wcyAqb3BzID0gbWRldl9nZXRfdmlydGlvX29wcyhtZGV2
KTsKKworCW9wcy0+c2V0X2NvbmZpZyhtZGV2LCBvZmZzZXQsIGJ1ZiwgbGVuKTsKK30KKworc3Rh
dGljIHUzMiB2aXJ0aW9fbWRldl9nZW5lcmF0aW9uKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2
KQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNv
bnN0IHN0cnVjdCBtZGV2X3ZpcnRpb19kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92aXJ0aW9f
b3BzKG1kZXYpOworCisJaWYgKG9wcy0+Z2V0X2dlbmVyYXRpb24pCisJCXJldHVybiBvcHMtPmdl
dF9nZW5lcmF0aW9uKG1kZXYpOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyB1OCB2aXJ0aW9f
bWRldl9nZXRfc3RhdHVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCBt
ZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCBtZGV2
X3ZpcnRpb19kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92aXJ0aW9fb3BzKG1kZXYpOworCisJ
cmV0dXJuIG9wcy0+Z2V0X3N0YXR1cyhtZGV2KTsKK30KKworc3RhdGljIHZvaWQgdmlydGlvX21k
ZXZfc2V0X3N0YXR1cyhzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldiwgdTggc3RhdHVzKQorewor
CXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0
cnVjdCBtZGV2X3ZpcnRpb19kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92aXJ0aW9fb3BzKG1k
ZXYpOworCisJcmV0dXJuIG9wcy0+c2V0X3N0YXR1cyhtZGV2LCBzdGF0dXMpOworfQorCitzdGF0
aWMgdm9pZCB2aXJ0aW9fbWRldl9yZXNldChzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldikKK3sK
KwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9nZXRfbWRldih2ZGV2KTsKKwljb25zdCBz
dHJ1Y3QgbWRldl92aXJ0aW9fZGV2aWNlX29wcyAqb3BzID0gbWRldl9nZXRfdmlydGlvX29wcyht
ZGV2KTsKKworCXJldHVybiBvcHMtPnNldF9zdGF0dXMobWRldiwgMCk7Cit9CisKK3N0YXRpYyBi
b29sIHZpcnRpb19tZGV2X25vdGlmeShzdHJ1Y3QgdmlydHF1ZXVlICp2cSkKK3sKKwlzdHJ1Y3Qg
bWRldl9kZXZpY2UgKm1kZXYgPSB2bV9nZXRfbWRldih2cS0+dmRldik7CisJY29uc3Qgc3RydWN0
IG1kZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRpb19vcHMobWRldik7
CisKKwlvcHMtPmtpY2tfdnEobWRldiwgdnEtPmluZGV4KTsKKworCXJldHVybiB0cnVlOworfQor
CitzdGF0aWMgaXJxcmV0dXJuX3QgdmlydGlvX21kZXZfY29uZmlnX2NiKHZvaWQgKnByaXZhdGUp
Cit7CisJc3RydWN0IHZpcnRpb19tZGV2X2RldmljZSAqdm1fZGV2ID0gcHJpdmF0ZTsKKworCXZp
cnRpb19jb25maWdfY2hhbmdlZCgmdm1fZGV2LT52ZGV2KTsKKworCXJldHVybiBJUlFfSEFORExF
RDsKK30KKworc3RhdGljIGlycXJldHVybl90IHZpcnRpb19tZGV2X3ZpcnRxdWV1ZV9jYih2b2lk
ICpwcml2YXRlKQoreworCXN0cnVjdCB2aXJ0aW9fbWRldl92cV9pbmZvICppbmZvID0gcHJpdmF0
ZTsKKworCXJldHVybiB2cmluZ19pbnRlcnJ1cHQoMCwgaW5mby0+dnEpOworfQorCitzdGF0aWMg
c3RydWN0IHZpcnRxdWV1ZSAqCit2aXJ0aW9fbWRldl9zZXR1cF92cShzdHJ1Y3QgdmlydGlvX2Rl
dmljZSAqdmRldiwgdW5zaWduZWQgaW50IGluZGV4LAorCQkgICAgIHZvaWQgKCpjYWxsYmFjayko
c3RydWN0IHZpcnRxdWV1ZSAqdnEpLAorCQkgICAgIGNvbnN0IGNoYXIgKm5hbWUsIGJvb2wgY3R4
KQoreworCXN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2RldiA9IHRvX3ZpcnRpb19tZGV2
X2RldmljZSh2ZGV2KTsKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9nZXRfbWRldih2
ZGV2KTsKKwljb25zdCBzdHJ1Y3QgbWRldl92aXJ0aW9fZGV2aWNlX29wcyAqb3BzID0gbWRldl9n
ZXRfdmlydGlvX29wcyhtZGV2KTsKKwlzdHJ1Y3QgdmlydGlvX21kZXZfdnFfaW5mbyAqaW5mbzsK
KwlzdHJ1Y3QgdmlydGlvX21kZXZfY2FsbGJhY2sgY2I7CisJc3RydWN0IHZpcnRxdWV1ZSAqdnE7
CisJdTY0IGRlc2NfYWRkciwgZHJpdmVyX2FkZHIsIGRldmljZV9hZGRyOworCXVuc2lnbmVkIGxv
bmcgZmxhZ3M7CisJdTMyIGFsaWduLCBudW07CisJaW50IGVycjsKKworCWlmICghbmFtZSkKKwkJ
cmV0dXJuIE5VTEw7CisKKwkvKiBRdWV1ZSBzaG91bGRuJ3QgYWxyZWFkeSBiZSBzZXQgdXAuICov
CisJaWYgKG9wcy0+Z2V0X3ZxX3JlYWR5KG1kZXYsIGluZGV4KSkKKwkJcmV0dXJuIEVSUl9QVFIo
LUVOT0VOVCk7CisKKwkvKiBBbGxvY2F0ZSBhbmQgZmlsbCBvdXQgb3VyIGFjdGl2ZSBxdWV1ZSBk
ZXNjcmlwdGlvbiAqLworCWluZm8gPSBrbWFsbG9jKHNpemVvZigqaW5mbyksIEdGUF9LRVJORUwp
OworCWlmICghaW5mbykKKwkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7CisKKwludW0gPSBvcHMt
PmdldF92cV9udW1fbWF4KG1kZXYpOworCWlmIChudW0gPT0gMCkgeworCQllcnIgPSAtRU5PRU5U
OworCQlnb3RvIGVycm9yX25ld192aXJ0cXVldWU7CisJfQorCisJLyogQ3JlYXRlIHRoZSB2cmlu
ZyAqLworCWFsaWduID0gb3BzLT5nZXRfdnFfYWxpZ24obWRldik7CisJdnEgPSB2cmluZ19jcmVh
dGVfdmlydHF1ZXVlKGluZGV4LCBudW0sIGFsaWduLCB2ZGV2LAorCQkJCSAgICB0cnVlLCB0cnVl
LCBjdHgsCisJCQkJICAgIHZpcnRpb19tZGV2X25vdGlmeSwgY2FsbGJhY2ssIG5hbWUpOworCWlm
ICghdnEpIHsKKwkJZXJyID0gLUVOT01FTTsKKwkJZ290byBlcnJvcl9uZXdfdmlydHF1ZXVlOwor
CX0KKworCS8qIFNldHVwIHZpcnRxdWV1ZSBjYWxsYmFjayAqLworCWNiLmNhbGxiYWNrID0gdmly
dGlvX21kZXZfdmlydHF1ZXVlX2NiOworCWNiLnByaXZhdGUgPSBpbmZvOworCW9wcy0+c2V0X3Zx
X2NiKG1kZXYsIGluZGV4LCAmY2IpOworCW9wcy0+c2V0X3ZxX251bShtZGV2LCBpbmRleCwgdmly
dHF1ZXVlX2dldF92cmluZ19zaXplKHZxKSk7CisKKwlkZXNjX2FkZHIgPSB2aXJ0cXVldWVfZ2V0
X2Rlc2NfYWRkcih2cSk7CisJZHJpdmVyX2FkZHIgPSB2aXJ0cXVldWVfZ2V0X2F2YWlsX2FkZHIo
dnEpOworCWRldmljZV9hZGRyID0gdmlydHF1ZXVlX2dldF91c2VkX2FkZHIodnEpOworCisJaWYg
KG9wcy0+c2V0X3ZxX2FkZHJlc3MobWRldiwgaW5kZXgsCisJCQkJZGVzY19hZGRyLCBkcml2ZXJf
YWRkciwKKwkJCQlkZXZpY2VfYWRkcikpIHsKKwkJZXJyID0gLUVJTlZBTDsKKwkJZ290byBlcnJf
dnE7CisJfQorCisJb3BzLT5zZXRfdnFfcmVhZHkobWRldiwgaW5kZXgsIDEpOworCisJdnEtPnBy
aXYgPSBpbmZvOworCWluZm8tPnZxID0gdnE7CisKKwlzcGluX2xvY2tfaXJxc2F2ZSgmdm1fZGV2
LT5sb2NrLCBmbGFncyk7CisJbGlzdF9hZGQoJmluZm8tPm5vZGUsICZ2bV9kZXYtPnZpcnRxdWV1
ZXMpOworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnZtX2Rldi0+bG9jaywgZmxhZ3MpOworCisJ
cmV0dXJuIHZxOworCitlcnJfdnE6CisJdnJpbmdfZGVsX3ZpcnRxdWV1ZSh2cSk7CitlcnJvcl9u
ZXdfdmlydHF1ZXVlOgorCW9wcy0+c2V0X3ZxX3JlYWR5KG1kZXYsIGluZGV4LCAwKTsKKwlXQVJO
X09OKG9wcy0+Z2V0X3ZxX3JlYWR5KG1kZXYsIGluZGV4KSk7CisJa2ZyZWUoaW5mbyk7CisJcmV0
dXJuIEVSUl9QVFIoZXJyKTsKK30KKworc3RhdGljIHZvaWQgdmlydGlvX21kZXZfZGVsX3ZxKHN0
cnVjdCB2aXJ0cXVldWUgKnZxKQoreworCXN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2Rl
diA9IHRvX3ZpcnRpb19tZGV2X2RldmljZSh2cS0+dmRldik7CisJc3RydWN0IG1kZXZfZGV2aWNl
ICptZGV2ID0gdm1fZGV2LT5tZGV2OworCWNvbnN0IHN0cnVjdCBtZGV2X3ZpcnRpb19kZXZpY2Vf
b3BzICpvcHMgPSBtZGV2X2dldF92aXJ0aW9fb3BzKG1kZXYpOworCXN0cnVjdCB2aXJ0aW9fbWRl
dl92cV9pbmZvICppbmZvID0gdnEtPnByaXY7CisJdW5zaWduZWQgaW50IGluZGV4ID0gdnEtPmlu
ZGV4OworCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisKKwlzcGluX2xvY2tfaXJxc2F2ZSgmdm1fZGV2
LT5sb2NrLCBmbGFncyk7CisJbGlzdF9kZWwoJmluZm8tPm5vZGUpOworCXNwaW5fdW5sb2NrX2ly
cXJlc3RvcmUoJnZtX2Rldi0+bG9jaywgZmxhZ3MpOworCisJLyogU2VsZWN0IGFuZCBkZWFjdGl2
YXRlIHRoZSBxdWV1ZSAqLworCW9wcy0+c2V0X3ZxX3JlYWR5KG1kZXYsIGluZGV4LCAwKTsKKwlX
QVJOX09OKG9wcy0+Z2V0X3ZxX3JlYWR5KG1kZXYsIGluZGV4KSk7CisKKwl2cmluZ19kZWxfdmly
dHF1ZXVlKHZxKTsKKworCWtmcmVlKGluZm8pOworfQorCitzdGF0aWMgdm9pZCB2aXJ0aW9fbWRl
dl9kZWxfdnFzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCB2aXJ0cXVl
dWUgKnZxLCAqbjsKKworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZSh2cSwgbiwgJnZkZXYtPnZx
cywgbGlzdCkKKwkJdmlydGlvX21kZXZfZGVsX3ZxKHZxKTsKK30KKworc3RhdGljIGludCB2aXJ0
aW9fbWRldl9maW5kX3ZxcyhzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldiwgdW5zaWduZWQgbnZx
cywKKwkJCQlzdHJ1Y3QgdmlydHF1ZXVlICp2cXNbXSwKKwkJCQl2cV9jYWxsYmFja190ICpjYWxs
YmFja3NbXSwKKwkJCQljb25zdCBjaGFyICogY29uc3QgbmFtZXNbXSwKKwkJCQljb25zdCBib29s
ICpjdHgsCisJCQkJc3RydWN0IGlycV9hZmZpbml0eSAqZGVzYykKK3sKKwlzdHJ1Y3QgdmlydGlv
X21kZXZfZGV2aWNlICp2bV9kZXYgPSB0b192aXJ0aW9fbWRldl9kZXZpY2UodmRldik7CisJc3Ry
dWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0
IG1kZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRpb19vcHMobWRldik7
CisJc3RydWN0IHZpcnRpb19tZGV2X2NhbGxiYWNrIGNiOworCWludCBpLCBlcnIsIHF1ZXVlX2lk
eCA9IDA7CisKKwlmb3IgKGkgPSAwOyBpIDwgbnZxczsgKytpKSB7CisJCWlmICghbmFtZXNbaV0p
IHsKKwkJCXZxc1tpXSA9IE5VTEw7CisJCQljb250aW51ZTsKKwkJfQorCisJCXZxc1tpXSA9IHZp
cnRpb19tZGV2X3NldHVwX3ZxKHZkZXYsIHF1ZXVlX2lkeCsrLAorCQkJCQkgICAgICBjYWxsYmFj
a3NbaV0sIG5hbWVzW2ldLCBjdHggPworCQkJCQkgICAgICBjdHhbaV0gOiBmYWxzZSk7CisJCWlm
IChJU19FUlIodnFzW2ldKSkgeworCQkJZXJyID0gUFRSX0VSUih2cXNbaV0pOworCQkJZ290byBl
cnJfc2V0dXBfdnE7CisJCX0KKwl9CisKKwljYi5jYWxsYmFjayA9IHZpcnRpb19tZGV2X2NvbmZp
Z19jYjsKKwljYi5wcml2YXRlID0gdm1fZGV2OworCW9wcy0+c2V0X2NvbmZpZ19jYihtZGV2LCAm
Y2IpOworCisJcmV0dXJuIDA7CisKK2Vycl9zZXR1cF92cToKKwl2aXJ0aW9fbWRldl9kZWxfdnFz
KHZkZXYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyB1NjQgdmlydGlvX21kZXZfZ2V0X2Zl
YXR1cmVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCBtZGV2X2Rldmlj
ZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCBtZGV2X3ZpcnRpb19k
ZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92aXJ0aW9fb3BzKG1kZXYpOworCisJcmV0dXJuIG9w
cy0+Z2V0X2ZlYXR1cmVzKG1kZXYpOworfQorCitzdGF0aWMgaW50IHZpcnRpb19tZGV2X2ZpbmFs
aXplX2ZlYXR1cmVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCBtZGV2
X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCBtZGV2X3Zp
cnRpb19kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92aXJ0aW9fb3BzKG1kZXYpOworCisJLyog
R2l2ZSB2aXJ0aW9fcmluZyBhIGNoYW5jZSB0byBhY2NlcHQgZmVhdHVyZXMuICovCisJdnJpbmdf
dHJhbnNwb3J0X2ZlYXR1cmVzKHZkZXYpOworCisJcmV0dXJuIG9wcy0+c2V0X2ZlYXR1cmVzKG1k
ZXYsIHZkZXYtPmZlYXR1cmVzKTsKK30KKworc3RhdGljIGNvbnN0IGNoYXIgKnZpcnRpb19tZGV2
X2J1c19uYW1lKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCB2aXJ0aW9f
bWRldl9kZXZpY2UgKnZtX2RldiA9IHRvX3ZpcnRpb19tZGV2X2RldmljZSh2ZGV2KTsKKwlzdHJ1
Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9kZXYtPm1kZXY7CisKKwlyZXR1cm4gZGV2X25hbWUo
bWRldl9kZXYobWRldikpOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IHZpcnRpb19jb25maWdf
b3BzIHZpcnRpb19tZGV2X2NvbmZpZ19vcHMgPSB7CisJLmdldAkJPSB2aXJ0aW9fbWRldl9nZXQs
CisJLnNldAkJPSB2aXJ0aW9fbWRldl9zZXQsCisJLmdlbmVyYXRpb24JPSB2aXJ0aW9fbWRldl9n
ZW5lcmF0aW9uLAorCS5nZXRfc3RhdHVzCT0gdmlydGlvX21kZXZfZ2V0X3N0YXR1cywKKwkuc2V0
X3N0YXR1cwk9IHZpcnRpb19tZGV2X3NldF9zdGF0dXMsCisJLnJlc2V0CQk9IHZpcnRpb19tZGV2
X3Jlc2V0LAorCS5maW5kX3Zxcwk9IHZpcnRpb19tZGV2X2ZpbmRfdnFzLAorCS5kZWxfdnFzCT0g
dmlydGlvX21kZXZfZGVsX3ZxcywKKwkuZ2V0X2ZlYXR1cmVzCT0gdmlydGlvX21kZXZfZ2V0X2Zl
YXR1cmVzLAorCS5maW5hbGl6ZV9mZWF0dXJlcyA9IHZpcnRpb19tZGV2X2ZpbmFsaXplX2ZlYXR1
cmVzLAorCS5idXNfbmFtZQk9IHZpcnRpb19tZGV2X2J1c19uYW1lLAorfTsKKworc3RhdGljIHZv
aWQgdmlydGlvX21kZXZfcmVsZWFzZV9kZXYoc3RydWN0IGRldmljZSAqX2QpCit7CisJc3RydWN0
IHZpcnRpb19kZXZpY2UgKnZkZXYgPQorCSAgICAgICBjb250YWluZXJfb2YoX2QsIHN0cnVjdCB2
aXJ0aW9fZGV2aWNlLCBkZXYpOworCXN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2RldiA9
CisJICAgICAgIGNvbnRhaW5lcl9vZih2ZGV2LCBzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlLCB2
ZGV2KTsKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9kZXYtPm1kZXY7CisKKwlkZXZt
X2tmcmVlKG1kZXZfZGV2KG1kZXYpLCB2bV9kZXYpOworfQorCitzdGF0aWMgaW50IHZpcnRpb19t
ZGV2X3Byb2JlKHN0cnVjdCBkZXZpY2UgKmRldikKK3sKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1k
ZXYgPSBtZGV2X2Zyb21fZGV2KGRldik7CisJY29uc3Qgc3RydWN0IG1kZXZfdmlydGlvX2Rldmlj
ZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRpb19vcHMobWRldik7CisJc3RydWN0IHZpcnRpb19t
ZGV2X2RldmljZSAqdm1fZGV2OworCWludCByYzsKKworCXZtX2RldiA9IGRldm1fa3phbGxvYyhk
ZXYsIHNpemVvZigqdm1fZGV2KSwgR0ZQX0tFUk5FTCk7CisJaWYgKCF2bV9kZXYpCisJCXJldHVy
biAtRU5PTUVNOworCisJdm1fZGV2LT52ZGV2LmRldi5wYXJlbnQgPSBkZXY7CisJdm1fZGV2LT52
ZGV2LmRldi5yZWxlYXNlID0gdmlydGlvX21kZXZfcmVsZWFzZV9kZXY7CisJdm1fZGV2LT52ZGV2
LmNvbmZpZyA9ICZ2aXJ0aW9fbWRldl9jb25maWdfb3BzOworCXZtX2Rldi0+bWRldiA9IG1kZXY7
CisJSU5JVF9MSVNUX0hFQUQoJnZtX2Rldi0+dmlydHF1ZXVlcyk7CisJc3Bpbl9sb2NrX2luaXQo
JnZtX2Rldi0+bG9jayk7CisKKwl2bV9kZXYtPnZkZXYuaWQuZGV2aWNlID0gb3BzLT5nZXRfZGV2
aWNlX2lkKG1kZXYpOworCWlmICh2bV9kZXYtPnZkZXYuaWQuZGV2aWNlID09IDApCisJCXJldHVy
biAtRU5PREVWOworCisJdm1fZGV2LT52ZGV2LmlkLnZlbmRvciA9IG9wcy0+Z2V0X3ZlbmRvcl9p
ZChtZGV2KTsKKwlyYyA9IHJlZ2lzdGVyX3ZpcnRpb19kZXZpY2UoJnZtX2Rldi0+dmRldik7CisJ
aWYgKHJjKQorCQlwdXRfZGV2aWNlKGRldik7CisJZWxzZQorCQlkZXZfc2V0X2RydmRhdGEoZGV2
LCB2bV9kZXYpOworCisJcmV0dXJuIHJjOworfQorCitzdGF0aWMgdm9pZCB2aXJ0aW9fbWRldl9y
ZW1vdmUoc3RydWN0IGRldmljZSAqZGV2KQoreworCXN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2Ug
KnZtX2RldiA9IGRldl9nZXRfZHJ2ZGF0YShkZXYpOworCisJdW5yZWdpc3Rlcl92aXJ0aW9fZGV2
aWNlKCZ2bV9kZXYtPnZkZXYpOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IG1kZXZfY2xhc3Nf
aWQgdmlydGlvX2lkX3RhYmxlW10gPSB7CisJeyBNREVWX0NMQVNTX0lEX1ZJUlRJTyB9LAorCXsg
MCB9LAorfTsKKworTU9EVUxFX0RFVklDRV9UQUJMRShtZGV2LCB2aXJ0aW9faWRfdGFibGUpOwor
CitzdGF0aWMgc3RydWN0IG1kZXZfZHJpdmVyIHZpcnRpb19tZGV2X2RyaXZlciA9IHsKKwkubmFt
ZQk9ICJ2aXJ0aW9fbWRldiIsCisJLnByb2JlCT0gdmlydGlvX21kZXZfcHJvYmUsCisJLnJlbW92
ZSA9IHZpcnRpb19tZGV2X3JlbW92ZSwKKwkuaWRfdGFibGUgPSB2aXJ0aW9faWRfdGFibGUsCit9
OworCitzdGF0aWMgaW50IF9faW5pdCB2aXJ0aW9fbWRldl9pbml0KHZvaWQpCit7CisJcmV0dXJu
IG1kZXZfcmVnaXN0ZXJfZHJpdmVyKCZ2aXJ0aW9fbWRldl9kcml2ZXIsIFRISVNfTU9EVUxFKTsK
K30KKworc3RhdGljIHZvaWQgX19leGl0IHZpcnRpb19tZGV2X2V4aXQodm9pZCkKK3sKKwltZGV2
X3VucmVnaXN0ZXJfZHJpdmVyKCZ2aXJ0aW9fbWRldl9kcml2ZXIpOworfQorCittb2R1bGVfaW5p
dCh2aXJ0aW9fbWRldl9pbml0KQorbW9kdWxlX2V4aXQodmlydGlvX21kZXZfZXhpdCkKKworTU9E
VUxFX1ZFUlNJT04oRFJJVkVSX1ZFUlNJT04pOworTU9EVUxFX0xJQ0VOU0UoIkdQTCB2MiIpOwor
TU9EVUxFX0FVVEhPUihEUklWRVJfQVVUSE9SKTsKK01PRFVMRV9ERVNDUklQVElPTihEUklWRVJf
REVTQyk7Ci0tIAoyLjE5LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNr
dG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2Ry
aS1kZXZlbA==
