Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E03B0819CF
	for <lists+dri-devel@lfdr.de>; Mon,  5 Aug 2019 14:44:10 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A636A6E45E;
	Mon,  5 Aug 2019 12:43:27 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id AE8EB6E45F;
 Mon,  5 Aug 2019 12:43:19 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 3EB5A3007F59;
 Mon,  5 Aug 2019 12:43:19 +0000 (UTC)
Received: from sirius.home.kraxel.org (ovpn-116-81.ams2.redhat.com
 [10.36.116.81])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 043E45D6C8;
 Mon,  5 Aug 2019 12:43:16 +0000 (UTC)
Received: by sirius.home.kraxel.org (Postfix, from userid 1000)
 id 712519D41; Mon,  5 Aug 2019 14:43:13 +0200 (CEST)
From: Gerd Hoffmann <kraxel@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v5 10/18] drm/ttm: switch ttm core from bo->resv to
 bo->base.resv
Date: Mon,  5 Aug 2019 14:43:02 +0200
Message-Id: <20190805124310.3275-11-kraxel@redhat.com>
In-Reply-To: <20190805124310.3275-1-kraxel@redhat.com>
References: <20190805124310.3275-1-kraxel@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.45]); Mon, 05 Aug 2019 12:43:19 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: thomas@shipmail.org, tzimmermann@suse.de, David Airlie <airlied@linux.ie>,
 ckoenig.leichtzumerken@gmail.com, intel-gfx@lists.freedesktop.org,
 open list <linux-kernel@vger.kernel.org>, Huang Rui <ray.huang@amd.com>,
 bskeggs@redhat.com, Christian Koenig <christian.koenig@amd.com>,
 Gerd Hoffmann <kraxel@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2lnbmVkLW9mZi1ieTogR2VyZCBIb2ZmbWFubiA8a3JheGVsQHJlZGhhdC5jb20+ClJldmlld2Vk
LWJ5OiBDaHJpc3RpYW4gS8O2bmlnIDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+Ci0tLQogaW5j
bHVkZS9kcm0vdHRtL3R0bV9ib19kcml2ZXIuaCAgICAgICAgfCAxMiArKy0tCiBkcml2ZXJzL2dw
dS9kcm0vdHRtL3R0bV9iby5jICAgICAgICAgICB8IDk0ICsrKysrKysrKysrKystLS0tLS0tLS0t
LS0tCiBkcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9ib191dGlsLmMgICAgICB8IDE2ICsrLS0tCiBk
cml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9ib192bS5jICAgICAgICB8ICA2ICstCiBkcml2ZXJzL2dw
dS9kcm0vdHRtL3R0bV9leGVjYnVmX3V0aWwuYyB8IDIwICsrKy0tLQogZHJpdmVycy9ncHUvZHJt
L3R0bS90dG1fdHQuYyAgICAgICAgICAgfCAgMiArLQogNiBmaWxlcyBjaGFuZ2VkLCA3NSBpbnNl
cnRpb25zKCspLCA3NSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9pbmNsdWRlL2RybS90dG0v
dHRtX2JvX2RyaXZlci5oIGIvaW5jbHVkZS9kcm0vdHRtL3R0bV9ib19kcml2ZXIuaAppbmRleCAw
ZTZhMTExYmVkMGIuLjNmMTkzNWMxOWE2NiAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vdHRtL3R0
bV9ib19kcml2ZXIuaAorKysgYi9pbmNsdWRlL2RybS90dG0vdHRtX2JvX2RyaXZlci5oCkBAIC02
NTQsMTQgKzY1NCwxNCBAQCBzdGF0aWMgaW5saW5lIGludCBfX3R0bV9ib19yZXNlcnZlKHN0cnVj
dCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJCWlmIChXQVJOX09OKHRpY2tldCkpCiAJCQlyZXR1
cm4gLUVCVVNZOwogCi0JCXN1Y2Nlc3MgPSByZXNlcnZhdGlvbl9vYmplY3RfdHJ5bG9jayhiby0+
cmVzdik7CisJCXN1Y2Nlc3MgPSByZXNlcnZhdGlvbl9vYmplY3RfdHJ5bG9jayhiby0+YmFzZS5y
ZXN2KTsKIAkJcmV0dXJuIHN1Y2Nlc3MgPyAwIDogLUVCVVNZOwogCX0KIAogCWlmIChpbnRlcnJ1
cHRpYmxlKQotCQlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfbG9ja19pbnRlcnJ1cHRpYmxlKGJv
LT5yZXN2LCB0aWNrZXQpOworCQlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfbG9ja19pbnRlcnJ1
cHRpYmxlKGJvLT5iYXNlLnJlc3YsIHRpY2tldCk7CiAJZWxzZQotCQlyZXQgPSByZXNlcnZhdGlv
bl9vYmplY3RfbG9jayhiby0+cmVzdiwgdGlja2V0KTsKKwkJcmV0ID0gcmVzZXJ2YXRpb25fb2Jq
ZWN0X2xvY2soYm8tPmJhc2UucmVzdiwgdGlja2V0KTsKIAlpZiAocmV0ID09IC1FSU5UUikKIAkJ
cmV0dXJuIC1FUkVTVEFSVFNZUzsKIAlyZXR1cm4gcmV0OwpAQCAtNzQ1LDEwICs3NDUsMTAgQEAg
c3RhdGljIGlubGluZSBpbnQgdHRtX2JvX3Jlc2VydmVfc2xvd3BhdGgoc3RydWN0IHR0bV9idWZm
ZXJfb2JqZWN0ICpibywKIAlXQVJOX09OKCFrcmVmX3JlYWQoJmJvLT5rcmVmKSk7CiAKIAlpZiAo
aW50ZXJydXB0aWJsZSkKLQkJcmV0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X2xvY2tfc2xvd19pbnRl
cnJ1cHRpYmxlKGJvLT5yZXN2LAorCQlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfbG9ja19zbG93
X2ludGVycnVwdGlibGUoYm8tPmJhc2UucmVzdiwKIAkJCQkJCQkJIHRpY2tldCk7CiAJZWxzZQot
CQlyZXNlcnZhdGlvbl9vYmplY3RfbG9ja19zbG93KGJvLT5yZXN2LCB0aWNrZXQpOworCQlyZXNl
cnZhdGlvbl9vYmplY3RfbG9ja19zbG93KGJvLT5iYXNlLnJlc3YsIHRpY2tldCk7CiAKIAlpZiAo
bGlrZWx5KHJldCA9PSAwKSkKIAkJdHRtX2JvX2RlbF9zdWJfZnJvbV9scnUoYm8pOwpAQCAtNzcz
LDcgKzc3Myw3IEBAIHN0YXRpYyBpbmxpbmUgdm9pZCB0dG1fYm9fdW5yZXNlcnZlKHN0cnVjdCB0
dG1fYnVmZmVyX29iamVjdCAqYm8pCiAJZWxzZQogCQl0dG1fYm9fbW92ZV90b19scnVfdGFpbChi
bywgTlVMTCk7CiAJc3Bpbl91bmxvY2soJmJvLT5iZGV2LT5nbG9iLT5scnVfbG9jayk7Ci0JcmVz
ZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+cmVzdik7CisJcmVzZXJ2YXRpb25fb2JqZWN0X3Vu
bG9jayhiby0+YmFzZS5yZXN2KTsKIH0KIAogLyoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS90dG0vdHRtX2JvLmMgYi9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9iby5jCmluZGV4IGNlMWU2
MjIxZTdlYS4uYjNkNjI4YjNmMDM4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0
bV9iby5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvLmMKQEAgLTE3Myw3ICsxNzMs
NyBAQCBzdGF0aWMgdm9pZCB0dG1fYm9fYWRkX21lbV90b19scnUoc3RydWN0IHR0bV9idWZmZXJf
b2JqZWN0ICpibywKIAlzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiA9IGJvLT5iZGV2OwogCXN0
cnVjdCB0dG1fbWVtX3R5cGVfbWFuYWdlciAqbWFuOwogCi0JcmVzZXJ2YXRpb25fb2JqZWN0X2Fz
c2VydF9oZWxkKGJvLT5yZXN2KTsKKwlyZXNlcnZhdGlvbl9vYmplY3RfYXNzZXJ0X2hlbGQoYm8t
PmJhc2UucmVzdik7CiAKIAlpZiAoIWxpc3RfZW1wdHkoJmJvLT5scnUpKQogCQlyZXR1cm47CkBA
IC0yNDQsNyArMjQ0LDcgQEAgc3RhdGljIHZvaWQgdHRtX2JvX2J1bGtfbW92ZV9zZXRfcG9zKHN0
cnVjdCB0dG1fbHJ1X2J1bGtfbW92ZV9wb3MgKnBvcywKIHZvaWQgdHRtX2JvX21vdmVfdG9fbHJ1
X3RhaWwoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKIAkJCSAgICAgc3RydWN0IHR0bV9s
cnVfYnVsa19tb3ZlICpidWxrKQogewotCXJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChi
by0+cmVzdik7CisJcmVzZXJ2YXRpb25fb2JqZWN0X2Fzc2VydF9oZWxkKGJvLT5iYXNlLnJlc3Yp
OwogCiAJdHRtX2JvX2RlbF9mcm9tX2xydShibyk7CiAJdHRtX2JvX2FkZF90b19scnUoYm8pOwpA
QCAtMjc3LDggKzI3Nyw4IEBAIHZvaWQgdHRtX2JvX2J1bGtfbW92ZV9scnVfdGFpbChzdHJ1Y3Qg
dHRtX2xydV9idWxrX21vdmUgKmJ1bGspCiAJCWlmICghcG9zLT5maXJzdCkKIAkJCWNvbnRpbnVl
OwogCi0JCXJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChwb3MtPmZpcnN0LT5yZXN2KTsK
LQkJcmVzZXJ2YXRpb25fb2JqZWN0X2Fzc2VydF9oZWxkKHBvcy0+bGFzdC0+cmVzdik7CisJCXJl
c2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChwb3MtPmZpcnN0LT5iYXNlLnJlc3YpOworCQly
ZXNlcnZhdGlvbl9vYmplY3RfYXNzZXJ0X2hlbGQocG9zLT5sYXN0LT5iYXNlLnJlc3YpOwogCiAJ
CW1hbiA9ICZwb3MtPmZpcnN0LT5iZGV2LT5tYW5bVFRNX1BMX1RUXTsKIAkJbGlzdF9idWxrX21v
dmVfdGFpbCgmbWFuLT5scnVbaV0sICZwb3MtPmZpcnN0LT5scnUsCkBAIC0yOTIsOCArMjkyLDgg
QEAgdm9pZCB0dG1fYm9fYnVsa19tb3ZlX2xydV90YWlsKHN0cnVjdCB0dG1fbHJ1X2J1bGtfbW92
ZSAqYnVsaykKIAkJaWYgKCFwb3MtPmZpcnN0KQogCQkJY29udGludWU7CiAKLQkJcmVzZXJ2YXRp
b25fb2JqZWN0X2Fzc2VydF9oZWxkKHBvcy0+Zmlyc3QtPnJlc3YpOwotCQlyZXNlcnZhdGlvbl9v
YmplY3RfYXNzZXJ0X2hlbGQocG9zLT5sYXN0LT5yZXN2KTsKKwkJcmVzZXJ2YXRpb25fb2JqZWN0
X2Fzc2VydF9oZWxkKHBvcy0+Zmlyc3QtPmJhc2UucmVzdik7CisJCXJlc2VydmF0aW9uX29iamVj
dF9hc3NlcnRfaGVsZChwb3MtPmxhc3QtPmJhc2UucmVzdik7CiAKIAkJbWFuID0gJnBvcy0+Zmly
c3QtPmJkZXYtPm1hbltUVE1fUExfVlJBTV07CiAJCWxpc3RfYnVsa19tb3ZlX3RhaWwoJm1hbi0+
bHJ1W2ldLCAmcG9zLT5maXJzdC0+bHJ1LApAQCAtMzA3LDggKzMwNyw4IEBAIHZvaWQgdHRtX2Jv
X2J1bGtfbW92ZV9scnVfdGFpbChzdHJ1Y3QgdHRtX2xydV9idWxrX21vdmUgKmJ1bGspCiAJCWlm
ICghcG9zLT5maXJzdCkKIAkJCWNvbnRpbnVlOwogCi0JCXJlc2VydmF0aW9uX29iamVjdF9hc3Nl
cnRfaGVsZChwb3MtPmZpcnN0LT5yZXN2KTsKLQkJcmVzZXJ2YXRpb25fb2JqZWN0X2Fzc2VydF9o
ZWxkKHBvcy0+bGFzdC0+cmVzdik7CisJCXJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChw
b3MtPmZpcnN0LT5iYXNlLnJlc3YpOworCQlyZXNlcnZhdGlvbl9vYmplY3RfYXNzZXJ0X2hlbGQo
cG9zLT5sYXN0LT5iYXNlLnJlc3YpOwogCiAJCWxydSA9ICZwb3MtPmZpcnN0LT5iZGV2LT5nbG9i
LT5zd2FwX2xydVtpXTsKIAkJbGlzdF9idWxrX21vdmVfdGFpbChscnUsICZwb3MtPmZpcnN0LT5z
d2FwLCAmcG9zLT5sYXN0LT5zd2FwKTsKQEAgLTQzOSwxMiArNDM5LDEyIEBAIHN0YXRpYyBpbnQg
dHRtX2JvX2luZGl2aWR1YWxpemVfcmVzdihzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvKQog
ewogCWludCByOwogCi0JaWYgKGJvLT5yZXN2ID09ICZiby0+YmFzZS5fcmVzdikKKwlpZiAoYm8t
PmJhc2UucmVzdiA9PSAmYm8tPmJhc2UuX3Jlc3YpCiAJCXJldHVybiAwOwogCiAJQlVHX09OKCFy
ZXNlcnZhdGlvbl9vYmplY3RfdHJ5bG9jaygmYm8tPmJhc2UuX3Jlc3YpKTsKIAotCXIgPSByZXNl
cnZhdGlvbl9vYmplY3RfY29weV9mZW5jZXMoJmJvLT5iYXNlLl9yZXN2LCBiby0+cmVzdik7CisJ
ciA9IHJlc2VydmF0aW9uX29iamVjdF9jb3B5X2ZlbmNlcygmYm8tPmJhc2UuX3Jlc3YsIGJvLT5i
YXNlLnJlc3YpOwogCWlmIChyKQogCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKCZiby0+YmFz
ZS5fcmVzdik7CiAKQEAgLTQ4MiwyMyArNDgyLDIzIEBAIHN0YXRpYyB2b2lkIHR0bV9ib19jbGVh
bnVwX3JlZnNfb3JfcXVldWUoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibykKIAkJLyogTGFz
dCByZXNvcnQsIGlmIHdlIGZhaWwgdG8gYWxsb2NhdGUgbWVtb3J5IGZvciB0aGUKIAkJICogZmVu
Y2VzIGJsb2NrIGZvciB0aGUgQk8gdG8gYmVjb21lIGlkbGUKIAkJICovCi0JCXJlc2VydmF0aW9u
X29iamVjdF93YWl0X3RpbWVvdXRfcmN1KGJvLT5yZXN2LCB0cnVlLCBmYWxzZSwKKwkJcmVzZXJ2
YXRpb25fb2JqZWN0X3dhaXRfdGltZW91dF9yY3UoYm8tPmJhc2UucmVzdiwgdHJ1ZSwgZmFsc2Us
CiAJCQkJCQkgICAgMzAgKiBIWik7CiAJCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xvY2spOwogCQln
b3RvIGVycm9yOwogCX0KIAogCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xvY2spOwotCXJldCA9IHJl
c2VydmF0aW9uX29iamVjdF90cnlsb2NrKGJvLT5yZXN2KSA/IDAgOiAtRUJVU1k7CisJcmV0ID0g
cmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2soYm8tPmJhc2UucmVzdikgPyAwIDogLUVCVVNZOwog
CWlmICghcmV0KSB7CiAJCWlmIChyZXNlcnZhdGlvbl9vYmplY3RfdGVzdF9zaWduYWxlZF9yY3Uo
JmJvLT5iYXNlLl9yZXN2LCB0cnVlKSkgewogCQkJdHRtX2JvX2RlbF9mcm9tX2xydShibyk7CiAJ
CQlzcGluX3VubG9jaygmZ2xvYi0+bHJ1X2xvY2spOwotCQkJaWYgKGJvLT5yZXN2ICE9ICZiby0+
YmFzZS5fcmVzdikKKwkJCWlmIChiby0+YmFzZS5yZXN2ICE9ICZiby0+YmFzZS5fcmVzdikKIAkJ
CQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKCZiby0+YmFzZS5fcmVzdik7CiAKIAkJCXR0bV9i
b19jbGVhbnVwX21lbXR5cGVfdXNlKGJvKTsKLQkJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2so
Ym8tPnJlc3YpOworCQkJcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+YmFzZS5yZXN2KTsK
IAkJCXJldHVybjsKIAkJfQogCkBAIC01MTQsOSArNTE0LDkgQEAgc3RhdGljIHZvaWQgdHRtX2Jv
X2NsZWFudXBfcmVmc19vcl9xdWV1ZShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvKQogCQkJ
dHRtX2JvX2FkZF90b19scnUoYm8pOwogCQl9CiAKLQkJcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9j
ayhiby0+cmVzdik7CisJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2soYm8tPmJhc2UucmVzdik7
CiAJfQotCWlmIChiby0+cmVzdiAhPSAmYm8tPmJhc2UuX3Jlc3YpCisJaWYgKGJvLT5iYXNlLnJl
c3YgIT0gJmJvLT5iYXNlLl9yZXN2KQogCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKCZiby0+
YmFzZS5fcmVzdik7CiAKIGVycm9yOgpAQCAtNTUwLDcgKzU1MCw3IEBAIHN0YXRpYyBpbnQgdHRt
X2JvX2NsZWFudXBfcmVmcyhzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAogCWludCByZXQ7
CiAKIAlpZiAodW5saWtlbHkobGlzdF9lbXB0eSgmYm8tPmRkZXN0cm95KSkpCi0JCXJlc3YgPSBi
by0+cmVzdjsKKwkJcmVzdiA9IGJvLT5iYXNlLnJlc3Y7CiAJZWxzZQogCQlyZXN2ID0gJmJvLT5i
YXNlLl9yZXN2OwogCkBAIC01NjMsNyArNTYzLDcgQEAgc3RhdGljIGludCB0dG1fYm9fY2xlYW51
cF9yZWZzKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJCWxvbmcgbHJldDsKIAogCQlp
ZiAodW5sb2NrX3Jlc3YpCi0JCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKGJvLT5yZXN2KTsK
KwkJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2soYm8tPmJhc2UucmVzdik7CiAJCXNwaW5fdW5s
b2NrKCZnbG9iLT5scnVfbG9jayk7CiAKIAkJbHJldCA9IHJlc2VydmF0aW9uX29iamVjdF93YWl0
X3RpbWVvdXRfcmN1KHJlc3YsIHRydWUsCkBAIC01NzYsNyArNTc2LDcgQEAgc3RhdGljIGludCB0
dG1fYm9fY2xlYW51cF9yZWZzKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJCQlyZXR1
cm4gLUVCVVNZOwogCiAJCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xvY2spOwotCQlpZiAodW5sb2Nr
X3Jlc3YgJiYgIXJlc2VydmF0aW9uX29iamVjdF90cnlsb2NrKGJvLT5yZXN2KSkgeworCQlpZiAo
dW5sb2NrX3Jlc3YgJiYgIXJlc2VydmF0aW9uX29iamVjdF90cnlsb2NrKGJvLT5iYXNlLnJlc3Yp
KSB7CiAJCQkvKgogCQkJICogV2UgcmFjZWQsIGFuZCBsb3N0LCBzb21lb25lIGVsc2UgaG9sZHMg
dGhlIHJlc2VydmF0aW9uIG5vdywKIAkJCSAqIGFuZCBpcyBwcm9iYWJseSBidXN5IGluIHR0bV9i
b19jbGVhbnVwX21lbXR5cGVfdXNlLgpAQCAtNTkzLDcgKzU5Myw3IEBAIHN0YXRpYyBpbnQgdHRt
X2JvX2NsZWFudXBfcmVmcyhzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAogCiAJaWYgKHJl
dCB8fCB1bmxpa2VseShsaXN0X2VtcHR5KCZiby0+ZGRlc3Ryb3kpKSkgewogCQlpZiAodW5sb2Nr
X3Jlc3YpCi0JCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKGJvLT5yZXN2KTsKKwkJCXJlc2Vy
dmF0aW9uX29iamVjdF91bmxvY2soYm8tPmJhc2UucmVzdik7CiAJCXNwaW5fdW5sb2NrKCZnbG9i
LT5scnVfbG9jayk7CiAJCXJldHVybiByZXQ7CiAJfQpAQCAtNjA2LDcgKzYwNiw3IEBAIHN0YXRp
YyBpbnQgdHRtX2JvX2NsZWFudXBfcmVmcyhzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAog
CXR0bV9ib19jbGVhbnVwX21lbXR5cGVfdXNlKGJvKTsKIAogCWlmICh1bmxvY2tfcmVzdikKLQkJ
cmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+cmVzdik7CisJCXJlc2VydmF0aW9uX29iamVj
dF91bmxvY2soYm8tPmJhc2UucmVzdik7CiAKIAlyZXR1cm4gMDsKIH0KQEAgLTYzMiwxNCArNjMy
LDE0IEBAIHN0YXRpYyBib29sIHR0bV9ib19kZWxheWVkX2RlbGV0ZShzdHJ1Y3QgdHRtX2JvX2Rl
dmljZSAqYmRldiwgYm9vbCByZW1vdmVfYWxsKQogCQlrcmVmX2dldCgmYm8tPmxpc3Rfa3JlZik7
CiAJCWxpc3RfbW92ZV90YWlsKCZiby0+ZGRlc3Ryb3ksICZyZW1vdmVkKTsKIAotCQlpZiAocmVt
b3ZlX2FsbCB8fCBiby0+cmVzdiAhPSAmYm8tPmJhc2UuX3Jlc3YpIHsKKwkJaWYgKHJlbW92ZV9h
bGwgfHwgYm8tPmJhc2UucmVzdiAhPSAmYm8tPmJhc2UuX3Jlc3YpIHsKIAkJCXNwaW5fdW5sb2Nr
KCZnbG9iLT5scnVfbG9jayk7Ci0JCQlyZXNlcnZhdGlvbl9vYmplY3RfbG9jayhiby0+cmVzdiwg
TlVMTCk7CisJCQlyZXNlcnZhdGlvbl9vYmplY3RfbG9jayhiby0+YmFzZS5yZXN2LCBOVUxMKTsK
IAogCQkJc3Bpbl9sb2NrKCZnbG9iLT5scnVfbG9jayk7CiAJCQl0dG1fYm9fY2xlYW51cF9yZWZz
KGJvLCBmYWxzZSwgIXJlbW92ZV9hbGwsIHRydWUpOwogCi0JCX0gZWxzZSBpZiAocmVzZXJ2YXRp
b25fb2JqZWN0X3RyeWxvY2soYm8tPnJlc3YpKSB7CisJCX0gZWxzZSBpZiAocmVzZXJ2YXRpb25f
b2JqZWN0X3RyeWxvY2soYm8tPmJhc2UucmVzdikpIHsKIAkJCXR0bV9ib19jbGVhbnVwX3JlZnMo
Ym8sIGZhbHNlLCAhcmVtb3ZlX2FsbCwgdHJ1ZSk7CiAJCX0gZWxzZSB7CiAJCQlzcGluX3VubG9j
aygmZ2xvYi0+bHJ1X2xvY2spOwpAQCAtNzA4LDcgKzcwOCw3IEBAIHN0YXRpYyBpbnQgdHRtX2Jv
X2V2aWN0KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJc3RydWN0IHR0bV9wbGFjZW1l
bnQgcGxhY2VtZW50OwogCWludCByZXQgPSAwOwogCi0JcmVzZXJ2YXRpb25fb2JqZWN0X2Fzc2Vy
dF9oZWxkKGJvLT5yZXN2KTsKKwlyZXNlcnZhdGlvbl9vYmplY3RfYXNzZXJ0X2hlbGQoYm8tPmJh
c2UucmVzdik7CiAKIAlwbGFjZW1lbnQubnVtX3BsYWNlbWVudCA9IDA7CiAJcGxhY2VtZW50Lm51
bV9idXN5X3BsYWNlbWVudCA9IDA7CkBAIC03NzgsOCArNzc4LDggQEAgc3RhdGljIGJvb2wgdHRt
X2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dhYmxlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8s
CiB7CiAJYm9vbCByZXQgPSBmYWxzZTsKIAotCWlmIChiby0+cmVzdiA9PSBjdHgtPnJlc3YpIHsK
LQkJcmVzZXJ2YXRpb25fb2JqZWN0X2Fzc2VydF9oZWxkKGJvLT5yZXN2KTsKKwlpZiAoYm8tPmJh
c2UucmVzdiA9PSBjdHgtPnJlc3YpIHsKKwkJcmVzZXJ2YXRpb25fb2JqZWN0X2Fzc2VydF9oZWxk
KGJvLT5iYXNlLnJlc3YpOwogCQlpZiAoY3R4LT5mbGFncyAmIFRUTV9PUFRfRkxBR19BTExPV19S
RVNfRVZJQ1QKIAkJICAgIHx8ICFsaXN0X2VtcHR5KCZiby0+ZGRlc3Ryb3kpKQogCQkJcmV0ID0g
dHJ1ZTsKQEAgLTc4Nyw3ICs3ODcsNyBAQCBzdGF0aWMgYm9vbCB0dG1fYm9fZXZpY3Rfc3dhcG91
dF9hbGxvd2FibGUoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKIAkJaWYgKGJ1c3kpCiAJ
CQkqYnVzeSA9IGZhbHNlOwogCX0gZWxzZSB7Ci0JCXJldCA9IHJlc2VydmF0aW9uX29iamVjdF90
cnlsb2NrKGJvLT5yZXN2KTsKKwkJcmV0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2soYm8t
PmJhc2UucmVzdik7CiAJCSpsb2NrZWQgPSByZXQ7CiAJCWlmIChidXN5KQogCQkJKmJ1c3kgPSAh
cmV0OwpAQCAtODE1LDEwICs4MTUsMTAgQEAgc3RhdGljIGludCB0dG1fbWVtX2V2aWN0X3dhaXRf
YnVzeShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJ1c3lfYm8sCiAJCXJldHVybiAtRUJVU1k7
CiAKIAlpZiAoY3R4LT5pbnRlcnJ1cHRpYmxlKQotCQlyID0gcmVzZXJ2YXRpb25fb2JqZWN0X2xv
Y2tfaW50ZXJydXB0aWJsZShidXN5X2JvLT5yZXN2LAorCQlyID0gcmVzZXJ2YXRpb25fb2JqZWN0
X2xvY2tfaW50ZXJydXB0aWJsZShidXN5X2JvLT5iYXNlLnJlc3YsCiAJCQkJCQkJICB0aWNrZXQp
OwogCWVsc2UKLQkJciA9IHJlc2VydmF0aW9uX29iamVjdF9sb2NrKGJ1c3lfYm8tPnJlc3YsIHRp
Y2tldCk7CisJCXIgPSByZXNlcnZhdGlvbl9vYmplY3RfbG9jayhidXN5X2JvLT5iYXNlLnJlc3Ys
IHRpY2tldCk7CiAKIAkvKgogCSAqIFRPRE86IEl0IHdvdWxkIGJlIGJldHRlciB0byBrZWVwIHRo
ZSBCTyBsb2NrZWQgdW50aWwgYWxsb2NhdGlvbiBpcyBhdApAQCAtODI2LDcgKzgyNiw3IEBAIHN0
YXRpYyBpbnQgdHRtX21lbV9ldmljdF93YWl0X2J1c3koc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0
ICpidXN5X2JvLAogCSAqIG9mIFRUTS4KIAkgKi8KIAlpZiAoIXIpCi0JCXJlc2VydmF0aW9uX29i
amVjdF91bmxvY2soYnVzeV9iby0+cmVzdik7CisJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2so
YnVzeV9iby0+YmFzZS5yZXN2KTsKIAogCXJldHVybiByID09IC1FREVBRExLID8gLUVCVVNZIDog
cjsKIH0KQEAgLTg1Miw3ICs4NTIsNyBAQCBzdGF0aWMgaW50IHR0bV9tZW1fZXZpY3RfZmlyc3Qo
c3RydWN0IHR0bV9ib19kZXZpY2UgKmJkZXYsCiAJCQlpZiAoIXR0bV9ib19ldmljdF9zd2Fwb3V0
X2FsbG93YWJsZShibywgY3R4LCAmbG9ja2VkLAogCQkJCQkJCSAgICAmYnVzeSkpIHsKIAkJCQlp
ZiAoYnVzeSAmJiAhYnVzeV9ibyAmJiB0aWNrZXQgIT0KLQkJCQkgICAgcmVzZXJ2YXRpb25fb2Jq
ZWN0X2xvY2tpbmdfY3R4KGJvLT5yZXN2KSkKKwkJCQkgICAgcmVzZXJ2YXRpb25fb2JqZWN0X2xv
Y2tpbmdfY3R4KGJvLT5iYXNlLnJlc3YpKQogCQkJCQlidXN5X2JvID0gYm87CiAJCQkJY29udGlu
dWU7CiAJCQl9CkBAIC04NjAsNyArODYwLDcgQEAgc3RhdGljIGludCB0dG1fbWVtX2V2aWN0X2Zp
cnN0KHN0cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAogCQkJaWYgKHBsYWNlICYmICFiZGV2LT5k
cml2ZXItPmV2aWN0aW9uX3ZhbHVhYmxlKGJvLAogCQkJCQkJCQkgICAgICBwbGFjZSkpIHsKIAkJ
CQlpZiAobG9ja2VkKQotCQkJCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKGJvLT5yZXN2KTsK
KwkJCQkJcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+YmFzZS5yZXN2KTsKIAkJCQljb250
aW51ZTsKIAkJCX0KIAkJCWJyZWFrOwpAQCAtOTMyLDkgKzkzMiw5IEBAIHN0YXRpYyBpbnQgdHRt
X2JvX2FkZF9tb3ZlX2ZlbmNlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJc3Bpbl91
bmxvY2soJm1hbi0+bW92ZV9sb2NrKTsKIAogCWlmIChmZW5jZSkgewotCQlyZXNlcnZhdGlvbl9v
YmplY3RfYWRkX3NoYXJlZF9mZW5jZShiby0+cmVzdiwgZmVuY2UpOworCQlyZXNlcnZhdGlvbl9v
YmplY3RfYWRkX3NoYXJlZF9mZW5jZShiby0+YmFzZS5yZXN2LCBmZW5jZSk7CiAKLQkJcmV0ID0g
cmVzZXJ2YXRpb25fb2JqZWN0X3Jlc2VydmVfc2hhcmVkKGJvLT5yZXN2LCAxKTsKKwkJcmV0ID0g
cmVzZXJ2YXRpb25fb2JqZWN0X3Jlc2VydmVfc2hhcmVkKGJvLT5iYXNlLnJlc3YsIDEpOwogCQlp
ZiAodW5saWtlbHkocmV0KSkgewogCQkJZG1hX2ZlbmNlX3B1dChmZW5jZSk7CiAJCQlyZXR1cm4g
cmV0OwpAQCAtMTA5MSw3ICsxMDkxLDcgQEAgaW50IHR0bV9ib19tZW1fc3BhY2Uoc3RydWN0IHR0
bV9idWZmZXJfb2JqZWN0ICpibywKIAlib29sIHR5cGVfZm91bmQgPSBmYWxzZTsKIAlpbnQgaSwg
cmV0OwogCi0JcmV0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X3Jlc2VydmVfc2hhcmVkKGJvLT5yZXN2
LCAxKTsKKwlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfcmVzZXJ2ZV9zaGFyZWQoYm8tPmJhc2Uu
cmVzdiwgMSk7CiAJaWYgKHVubGlrZWx5KHJldCkpCiAJCXJldHVybiByZXQ7CiAKQEAgLTExNzIs
NyArMTE3Miw3IEBAIHN0YXRpYyBpbnQgdHRtX2JvX21vdmVfYnVmZmVyKHN0cnVjdCB0dG1fYnVm
ZmVyX29iamVjdCAqYm8sCiAJaW50IHJldCA9IDA7CiAJc3RydWN0IHR0bV9tZW1fcmVnIG1lbTsK
IAotCXJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChiby0+cmVzdik7CisJcmVzZXJ2YXRp
b25fb2JqZWN0X2Fzc2VydF9oZWxkKGJvLT5iYXNlLnJlc3YpOwogCiAJbWVtLm51bV9wYWdlcyA9
IGJvLT5udW1fcGFnZXM7CiAJbWVtLnNpemUgPSBtZW0ubnVtX3BhZ2VzIDw8IFBBR0VfU0hJRlQ7
CkBAIC0xMjQyLDcgKzEyNDIsNyBAQCBpbnQgdHRtX2JvX3ZhbGlkYXRlKHN0cnVjdCB0dG1fYnVm
ZmVyX29iamVjdCAqYm8sCiAJaW50IHJldDsKIAl1aW50MzJfdCBuZXdfZmxhZ3M7CiAKLQlyZXNl
cnZhdGlvbl9vYmplY3RfYXNzZXJ0X2hlbGQoYm8tPnJlc3YpOworCXJlc2VydmF0aW9uX29iamVj
dF9hc3NlcnRfaGVsZChiby0+YmFzZS5yZXN2KTsKIAkvKgogCSAqIENoZWNrIHdoZXRoZXIgd2Ug
bmVlZCB0byBtb3ZlIGJ1ZmZlci4KIAkgKi8KQEAgLTEzMzQsNyArMTMzNCw3IEBAIGludCB0dG1f
Ym9faW5pdF9yZXNlcnZlZChzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiwKIAlpZiAocmVzdikg
ewogCQliby0+cmVzdiA9IHJlc3Y7CiAJCWJvLT5iYXNlLnJlc3YgPSByZXN2OwotCQlyZXNlcnZh
dGlvbl9vYmplY3RfYXNzZXJ0X2hlbGQoYm8tPnJlc3YpOworCQlyZXNlcnZhdGlvbl9vYmplY3Rf
YXNzZXJ0X2hlbGQoYm8tPmJhc2UucmVzdik7CiAJfSBlbHNlIHsKIAkJYm8tPnJlc3YgPSAmYm8t
PmJhc2UuX3Jlc3Y7CiAJCWJvLT5iYXNlLnJlc3YgPSAmYm8tPmJhc2UuX3Jlc3Y7CkBAIC0xMzYy
LDcgKzEzNjIsNyBAQCBpbnQgdHRtX2JvX2luaXRfcmVzZXJ2ZWQoc3RydWN0IHR0bV9ib19kZXZp
Y2UgKmJkZXYsCiAJICogc2luY2Ugb3RoZXJ3aXNlIGxvY2tkZXAgd2lsbCBiZSBhbmdlcmVkIGlu
IHJhZGVvbi4KIAkgKi8KIAlpZiAoIXJlc3YpIHsKLQkJbG9ja2VkID0gcmVzZXJ2YXRpb25fb2Jq
ZWN0X3RyeWxvY2soYm8tPnJlc3YpOworCQlsb2NrZWQgPSByZXNlcnZhdGlvbl9vYmplY3RfdHJ5
bG9jayhiby0+YmFzZS5yZXN2KTsKIAkJV0FSTl9PTighbG9ja2VkKTsKIAl9CiAKQEAgLTE4MDYs
MTMgKzE4MDYsMTMgQEAgaW50IHR0bV9ib193YWl0KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAq
Ym8sCiAJbG9uZyB0aW1lb3V0ID0gMTUgKiBIWjsKIAogCWlmIChub193YWl0KSB7Ci0JCWlmIChy
ZXNlcnZhdGlvbl9vYmplY3RfdGVzdF9zaWduYWxlZF9yY3UoYm8tPnJlc3YsIHRydWUpKQorCQlp
ZiAocmVzZXJ2YXRpb25fb2JqZWN0X3Rlc3Rfc2lnbmFsZWRfcmN1KGJvLT5iYXNlLnJlc3YsIHRy
dWUpKQogCQkJcmV0dXJuIDA7CiAJCWVsc2UKIAkJCXJldHVybiAtRUJVU1k7CiAJfQogCi0JdGlt
ZW91dCA9IHJlc2VydmF0aW9uX29iamVjdF93YWl0X3RpbWVvdXRfcmN1KGJvLT5yZXN2LCB0cnVl
LAorCXRpbWVvdXQgPSByZXNlcnZhdGlvbl9vYmplY3Rfd2FpdF90aW1lb3V0X3JjdShiby0+YmFz
ZS5yZXN2LCB0cnVlLAogCQkJCQkJICAgICAgaW50ZXJydXB0aWJsZSwgdGltZW91dCk7CiAJaWYg
KHRpbWVvdXQgPCAwKQogCQlyZXR1cm4gdGltZW91dDsKQEAgLTE4MjAsNyArMTgyMCw3IEBAIGlu
dCB0dG1fYm9fd2FpdChzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvLAogCWlmICh0aW1lb3V0
ID09IDApCiAJCXJldHVybiAtRUJVU1k7CiAKLQlyZXNlcnZhdGlvbl9vYmplY3RfYWRkX2V4Y2xf
ZmVuY2UoYm8tPnJlc3YsIE5VTEwpOworCXJlc2VydmF0aW9uX29iamVjdF9hZGRfZXhjbF9mZW5j
ZShiby0+YmFzZS5yZXN2LCBOVUxMKTsKIAlyZXR1cm4gMDsKIH0KIEVYUE9SVF9TWU1CT0wodHRt
X2JvX3dhaXQpOwpAQCAtMTkzNiw3ICsxOTM2LDcgQEAgaW50IHR0bV9ib19zd2Fwb3V0KHN0cnVj
dCB0dG1fYm9fZ2xvYmFsICpnbG9iLCBzdHJ1Y3QgdHRtX29wZXJhdGlvbl9jdHggKmN0eCkKIAkg
KiBhbHJlYWR5IHN3YXBwZWQgYnVmZmVyLgogCSAqLwogCWlmIChsb2NrZWQpCi0JCXJlc2VydmF0
aW9uX29iamVjdF91bmxvY2soYm8tPnJlc3YpOworCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2Nr
KGJvLT5iYXNlLnJlc3YpOwogCWtyZWZfcHV0KCZiby0+bGlzdF9rcmVmLCB0dG1fYm9fcmVsZWFz
ZV9saXN0KTsKIAlyZXR1cm4gcmV0OwogfQpAQCAtMTk3NCwxNCArMTk3NCwxNCBAQCBpbnQgdHRt
X2JvX3dhaXRfdW5yZXNlcnZlZChzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvKQogCXJldCA9
IG11dGV4X2xvY2tfaW50ZXJydXB0aWJsZSgmYm8tPnd1X211dGV4KTsKIAlpZiAodW5saWtlbHko
cmV0ICE9IDApKQogCQlyZXR1cm4gLUVSRVNUQVJUU1lTOwotCWlmICghcmVzZXJ2YXRpb25fb2Jq
ZWN0X2lzX2xvY2tlZChiby0+cmVzdikpCisJaWYgKCFyZXNlcnZhdGlvbl9vYmplY3RfaXNfbG9j
a2VkKGJvLT5iYXNlLnJlc3YpKQogCQlnb3RvIG91dF91bmxvY2s7Ci0JcmV0ID0gcmVzZXJ2YXRp
b25fb2JqZWN0X2xvY2tfaW50ZXJydXB0aWJsZShiby0+cmVzdiwgTlVMTCk7CisJcmV0ID0gcmVz
ZXJ2YXRpb25fb2JqZWN0X2xvY2tfaW50ZXJydXB0aWJsZShiby0+YmFzZS5yZXN2LCBOVUxMKTsK
IAlpZiAocmV0ID09IC1FSU5UUikKIAkJcmV0ID0gLUVSRVNUQVJUU1lTOwogCWlmICh1bmxpa2Vs
eShyZXQgIT0gMCkpCiAJCWdvdG8gb3V0X3VubG9jazsKLQlyZXNlcnZhdGlvbl9vYmplY3RfdW5s
b2NrKGJvLT5yZXN2KTsKKwlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKGJvLT5iYXNlLnJlc3Yp
OwogCiBvdXRfdW5sb2NrOgogCW11dGV4X3VubG9jaygmYm8tPnd1X211dGV4KTsKZGlmZiAtLWdp
dCBhL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvX3V0aWwuYyBiL2RyaXZlcnMvZ3B1L2RybS90
dG0vdHRtX2JvX3V0aWwuYwppbmRleCBmNTAwOWMxYjZhOWMuLjQyNWE2ZDYyN2IzMCAxMDA2NDQK
LS0tIGEvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm9fdXRpbC5jCisrKyBiL2RyaXZlcnMvZ3B1
L2RybS90dG0vdHRtX2JvX3V0aWwuYwpAQCAtNTE3LDkgKzUxNyw5IEBAIHN0YXRpYyBpbnQgdHRt
X2J1ZmZlcl9vYmplY3RfdHJhbnNmZXIoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKIAlr
cmVmX2luaXQoJmZiby0+YmFzZS5rcmVmKTsKIAlmYm8tPmJhc2UuZGVzdHJveSA9ICZ0dG1fdHJh
bnNmZXJlZF9kZXN0cm95OwogCWZiby0+YmFzZS5hY2Nfc2l6ZSA9IDA7Ci0JZmJvLT5iYXNlLnJl
c3YgPSAmZmJvLT5iYXNlLmJhc2UuX3Jlc3Y7Ci0JcmVzZXJ2YXRpb25fb2JqZWN0X2luaXQoZmJv
LT5iYXNlLnJlc3YpOwotCXJldCA9IHJlc2VydmF0aW9uX29iamVjdF90cnlsb2NrKGZiby0+YmFz
ZS5yZXN2KTsKKwlmYm8tPmJhc2UuYmFzZS5yZXN2ID0gJmZiby0+YmFzZS5iYXNlLl9yZXN2Owor
CXJlc2VydmF0aW9uX29iamVjdF9pbml0KGZiby0+YmFzZS5iYXNlLnJlc3YpOworCXJldCA9IHJl
c2VydmF0aW9uX29iamVjdF90cnlsb2NrKGZiby0+YmFzZS5iYXNlLnJlc3YpOwogCVdBUk5fT04o
IXJldCk7CiAKIAkqbmV3X29iaiA9ICZmYm8tPmJhc2U7CkBAIC02ODksNyArNjg5LDcgQEAgaW50
IHR0bV9ib19tb3ZlX2FjY2VsX2NsZWFudXAoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywK
IAlpbnQgcmV0OwogCXN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqZ2hvc3Rfb2JqOwogCi0JcmVz
ZXJ2YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKGJvLT5yZXN2LCBmZW5jZSk7CisJcmVzZXJ2
YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKGJvLT5iYXNlLnJlc3YsIGZlbmNlKTsKIAlpZiAo
ZXZpY3QpIHsKIAkJcmV0ID0gdHRtX2JvX3dhaXQoYm8sIGZhbHNlLCBmYWxzZSk7CiAJCWlmIChy
ZXQpCkBAIC03MTYsNyArNzE2LDcgQEAgaW50IHR0bV9ib19tb3ZlX2FjY2VsX2NsZWFudXAoc3Ry
dWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKIAkJaWYgKHJldCkKIAkJCXJldHVybiByZXQ7CiAK
LQkJcmVzZXJ2YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKGdob3N0X29iai0+cmVzdiwgZmVu
Y2UpOworCQlyZXNlcnZhdGlvbl9vYmplY3RfYWRkX2V4Y2xfZmVuY2UoZ2hvc3Rfb2JqLT5iYXNl
LnJlc3YsIGZlbmNlKTsKIAogCQkvKioKIAkJICogSWYgd2UncmUgbm90IG1vdmluZyB0byBmaXhl
ZCBtZW1vcnksIHRoZSBUVE0gb2JqZWN0CkBAIC03NTIsNyArNzUyLDcgQEAgaW50IHR0bV9ib19w
aXBlbGluZV9tb3ZlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAKIAlpbnQgcmV0Owog
Ci0JcmVzZXJ2YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKGJvLT5yZXN2LCBmZW5jZSk7CisJ
cmVzZXJ2YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKGJvLT5iYXNlLnJlc3YsIGZlbmNlKTsK
IAogCWlmICghZXZpY3QpIHsKIAkJc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpnaG9zdF9vYmo7
CkBAIC03NzIsNyArNzcyLDcgQEAgaW50IHR0bV9ib19waXBlbGluZV9tb3ZlKHN0cnVjdCB0dG1f
YnVmZmVyX29iamVjdCAqYm8sCiAJCWlmIChyZXQpCiAJCQlyZXR1cm4gcmV0OwogCi0JCXJlc2Vy
dmF0aW9uX29iamVjdF9hZGRfZXhjbF9mZW5jZShnaG9zdF9vYmotPnJlc3YsIGZlbmNlKTsKKwkJ
cmVzZXJ2YXRpb25fb2JqZWN0X2FkZF9leGNsX2ZlbmNlKGdob3N0X29iai0+YmFzZS5yZXN2LCBm
ZW5jZSk7CiAKIAkJLyoqCiAJCSAqIElmIHdlJ3JlIG5vdCBtb3ZpbmcgdG8gZml4ZWQgbWVtb3J5
LCB0aGUgVFRNIG9iamVjdApAQCAtODQxLDcgKzg0MSw3IEBAIGludCB0dG1fYm9fcGlwZWxpbmVf
Z3V0dGluZyhzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvKQogCWlmIChyZXQpCiAJCXJldHVy
biByZXQ7CiAKLQlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfY29weV9mZW5jZXMoZ2hvc3QtPnJl
c3YsIGJvLT5yZXN2KTsKKwlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfY29weV9mZW5jZXMoZ2hv
c3QtPmJhc2UucmVzdiwgYm8tPmJhc2UucmVzdik7CiAJLyogTGFzdCByZXNvcnQsIHdhaXQgZm9y
IHRoZSBCTyB0byBiZSBpZGxlIHdoZW4gd2UgYXJlIE9PTSAqLwogCWlmIChyZXQpCiAJCXR0bV9i
b193YWl0KGJvLCBmYWxzZSwgZmFsc2UpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3R0
bS90dG1fYm9fdm0uYyBiL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvX3ZtLmMKaW5kZXggZmI2
ODc1YTc4OWI3Li44NWY1YmNiZTBjNzYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS90dG0v
dHRtX2JvX3ZtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm9fdm0uYwpAQCAtNzEs
NyArNzEsNyBAQCBzdGF0aWMgdm1fZmF1bHRfdCB0dG1fYm9fdm1fZmF1bHRfaWRsZShzdHJ1Y3Qg
dHRtX2J1ZmZlcl9vYmplY3QgKmJvLAogCQl0dG1fYm9fZ2V0KGJvKTsKIAkJdXBfcmVhZCgmdm1m
LT52bWEtPnZtX21tLT5tbWFwX3NlbSk7CiAJCSh2b2lkKSBkbWFfZmVuY2Vfd2FpdChiby0+bW92
aW5nLCB0cnVlKTsKLQkJcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+cmVzdik7CisJCXJl
c2VydmF0aW9uX29iamVjdF91bmxvY2soYm8tPmJhc2UucmVzdik7CiAJCXR0bV9ib19wdXQoYm8p
OwogCQlnb3RvIG91dF91bmxvY2s7CiAJfQpAQCAtMTMxLDcgKzEzMSw3IEBAIHN0YXRpYyB2bV9m
YXVsdF90IHR0bV9ib192bV9mYXVsdChzdHJ1Y3Qgdm1fZmF1bHQgKnZtZikKIAkgKiBmb3IgcmVz
ZXJ2ZSwgYW5kIGlmIGl0IGZhaWxzLCByZXRyeSB0aGUgZmF1bHQgYWZ0ZXIgd2FpdGluZwogCSAq
IGZvciB0aGUgYnVmZmVyIHRvIGJlY29tZSB1bnJlc2VydmVkLgogCSAqLwotCWlmICh1bmxpa2Vs
eSghcmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2soYm8tPnJlc3YpKSkgeworCWlmICh1bmxpa2Vs
eSghcmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2soYm8tPmJhc2UucmVzdikpKSB7CiAJCWlmICh2
bWYtPmZsYWdzICYgRkFVTFRfRkxBR19BTExPV19SRVRSWSkgewogCQkJaWYgKCEodm1mLT5mbGFn
cyAmIEZBVUxUX0ZMQUdfUkVUUllfTk9XQUlUKSkgewogCQkJCXR0bV9ib19nZXQoYm8pOwpAQCAt
Mjk2LDcgKzI5Niw3IEBAIHN0YXRpYyB2bV9mYXVsdF90IHR0bV9ib192bV9mYXVsdChzdHJ1Y3Qg
dm1fZmF1bHQgKnZtZikKIG91dF9pb191bmxvY2s6CiAJdHRtX21lbV9pb191bmxvY2sobWFuKTsK
IG91dF91bmxvY2s6Ci0JcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+cmVzdik7CisJcmVz
ZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+YmFzZS5yZXN2KTsKIAlyZXR1cm4gcmV0OwogfQog
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9leGVjYnVmX3V0aWwuYyBiL2Ry
aXZlcnMvZ3B1L2RybS90dG0vdHRtX2V4ZWNidWZfdXRpbC5jCmluZGV4IDcyM2ZiNTgzZmRkYS4u
M2FlZmU3MmZiNWNiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9leGVjYnVm
X3V0aWwuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9leGVjYnVmX3V0aWwuYwpAQCAt
MzksNyArMzksNyBAQCBzdGF0aWMgdm9pZCB0dG1fZXVfYmFja29mZl9yZXNlcnZhdGlvbl9yZXZl
cnNlKHN0cnVjdCBsaXN0X2hlYWQgKmxpc3QsCiAJbGlzdF9mb3JfZWFjaF9lbnRyeV9jb250aW51
ZV9yZXZlcnNlKGVudHJ5LCBsaXN0LCBoZWFkKSB7CiAJCXN0cnVjdCB0dG1fYnVmZmVyX29iamVj
dCAqYm8gPSBlbnRyeS0+Ym87CiAKLQkJcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+cmVz
dik7CisJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2soYm8tPmJhc2UucmVzdik7CiAJfQogfQog
CkBAIC03MSw3ICs3MSw3IEBAIHZvaWQgdHRtX2V1X2JhY2tvZmZfcmVzZXJ2YXRpb24oc3RydWN0
IHd3X2FjcXVpcmVfY3R4ICp0aWNrZXQsCiAKIAkJaWYgKGxpc3RfZW1wdHkoJmJvLT5scnUpKQog
CQkJdHRtX2JvX2FkZF90b19scnUoYm8pOwotCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKGJv
LT5yZXN2KTsKKwkJcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+YmFzZS5yZXN2KTsKIAl9
CiAJc3Bpbl91bmxvY2soJmdsb2ItPmxydV9sb2NrKTsKIApAQCAtMTE0LDcgKzExNCw3IEBAIGlu
dCB0dG1fZXVfcmVzZXJ2ZV9idWZmZXJzKHN0cnVjdCB3d19hY3F1aXJlX2N0eCAqdGlja2V0LAog
CiAJCXJldCA9IF9fdHRtX2JvX3Jlc2VydmUoYm8sIGludHIsICh0aWNrZXQgPT0gTlVMTCksIHRp
Y2tldCk7CiAJCWlmICghcmV0ICYmIHVubGlrZWx5KGF0b21pY19yZWFkKCZiby0+Y3B1X3dyaXRl
cnMpID4gMCkpIHsKLQkJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2soYm8tPnJlc3YpOworCQkJ
cmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+YmFzZS5yZXN2KTsKIAogCQkJcmV0ID0gLUVC
VVNZOwogCkBAIC0xMzAsNyArMTMwLDcgQEAgaW50IHR0bV9ldV9yZXNlcnZlX2J1ZmZlcnMoc3Ry
dWN0IHd3X2FjcXVpcmVfY3R4ICp0aWNrZXQsCiAJCQlpZiAoIWVudHJ5LT5udW1fc2hhcmVkKQog
CQkJCWNvbnRpbnVlOwogCi0JCQlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfcmVzZXJ2ZV9zaGFy
ZWQoYm8tPnJlc3YsCisJCQlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfcmVzZXJ2ZV9zaGFyZWQo
Ym8tPmJhc2UucmVzdiwKIAkJCQkJCQkJZW50cnktPm51bV9zaGFyZWQpOwogCQkJaWYgKCFyZXQp
CiAJCQkJY29udGludWU7CkBAIC0xNDQsMTYgKzE0NCwxNiBAQCBpbnQgdHRtX2V1X3Jlc2VydmVf
YnVmZmVycyhzdHJ1Y3Qgd3dfYWNxdWlyZV9jdHggKnRpY2tldCwKIAogCQlpZiAocmV0ID09IC1F
REVBRExLKSB7CiAJCQlpZiAoaW50cikgewotCQkJCXJldCA9IHJlc2VydmF0aW9uX29iamVjdF9s
b2NrX3Nsb3dfaW50ZXJydXB0aWJsZShiby0+cmVzdiwKKwkJCQlyZXQgPSByZXNlcnZhdGlvbl9v
YmplY3RfbG9ja19zbG93X2ludGVycnVwdGlibGUoYm8tPmJhc2UucmVzdiwKIAkJCQkJCQkJCQkg
dGlja2V0KTsKIAkJCX0gZWxzZSB7Ci0JCQkJcmVzZXJ2YXRpb25fb2JqZWN0X2xvY2tfc2xvdyhi
by0+cmVzdiwgdGlja2V0KTsKKwkJCQlyZXNlcnZhdGlvbl9vYmplY3RfbG9ja19zbG93KGJvLT5i
YXNlLnJlc3YsIHRpY2tldCk7CiAJCQkJcmV0ID0gMDsKIAkJCX0KIAkJfQogCiAJCWlmICghcmV0
ICYmIGVudHJ5LT5udW1fc2hhcmVkKQotCQkJcmV0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X3Jlc2Vy
dmVfc2hhcmVkKGJvLT5yZXN2LAorCQkJcmV0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X3Jlc2VydmVf
c2hhcmVkKGJvLT5iYXNlLnJlc3YsCiAJCQkJCQkJCWVudHJ5LT5udW1fc2hhcmVkKTsKIAogCQlp
ZiAodW5saWtlbHkocmV0ICE9IDApKSB7CkBAIC0yMDEsMTQgKzIwMSwxNCBAQCB2b2lkIHR0bV9l
dV9mZW5jZV9idWZmZXJfb2JqZWN0cyhzdHJ1Y3Qgd3dfYWNxdWlyZV9jdHggKnRpY2tldCwKIAls
aXN0X2Zvcl9lYWNoX2VudHJ5KGVudHJ5LCBsaXN0LCBoZWFkKSB7CiAJCWJvID0gZW50cnktPmJv
OwogCQlpZiAoZW50cnktPm51bV9zaGFyZWQpCi0JCQlyZXNlcnZhdGlvbl9vYmplY3RfYWRkX3No
YXJlZF9mZW5jZShiby0+cmVzdiwgZmVuY2UpOworCQkJcmVzZXJ2YXRpb25fb2JqZWN0X2FkZF9z
aGFyZWRfZmVuY2UoYm8tPmJhc2UucmVzdiwgZmVuY2UpOwogCQllbHNlCi0JCQlyZXNlcnZhdGlv
bl9vYmplY3RfYWRkX2V4Y2xfZmVuY2UoYm8tPnJlc3YsIGZlbmNlKTsKKwkJCXJlc2VydmF0aW9u
X29iamVjdF9hZGRfZXhjbF9mZW5jZShiby0+YmFzZS5yZXN2LCBmZW5jZSk7CiAJCWlmIChsaXN0
X2VtcHR5KCZiby0+bHJ1KSkKIAkJCXR0bV9ib19hZGRfdG9fbHJ1KGJvKTsKIAkJZWxzZQogCQkJ
dHRtX2JvX21vdmVfdG9fbHJ1X3RhaWwoYm8sIE5VTEwpOwotCQlyZXNlcnZhdGlvbl9vYmplY3Rf
dW5sb2NrKGJvLT5yZXN2KTsKKwkJcmVzZXJ2YXRpb25fb2JqZWN0X3VubG9jayhiby0+YmFzZS5y
ZXN2KTsKIAl9CiAJc3Bpbl91bmxvY2soJmdsb2ItPmxydV9sb2NrKTsKIAlpZiAodGlja2V0KQpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fdHQuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS90dG0vdHRtX3R0LmMKaW5kZXggZTNhMDY5MTU4MmZmLi4wMGI0YTMzMzc4NDAgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX3R0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3R0
bS90dG1fdHQuYwpAQCAtNDgsNyArNDgsNyBAQCBpbnQgdHRtX3R0X2NyZWF0ZShzdHJ1Y3QgdHRt
X2J1ZmZlcl9vYmplY3QgKmJvLCBib29sIHplcm9fYWxsb2MpCiAJc3RydWN0IHR0bV9ib19kZXZp
Y2UgKmJkZXYgPSBiby0+YmRldjsKIAl1aW50MzJfdCBwYWdlX2ZsYWdzID0gMDsKIAotCXJlc2Vy
dmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChiby0+cmVzdik7CisJcmVzZXJ2YXRpb25fb2JqZWN0
X2Fzc2VydF9oZWxkKGJvLT5iYXNlLnJlc3YpOwogCiAJaWYgKGJkZXYtPm5lZWRfZG1hMzIpCiAJ
CXBhZ2VfZmxhZ3MgfD0gVFRNX1BBR0VfRkxBR19ETUEzMjsKLS0gCjIuMTguMQoKX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcg
bGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRl
c2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
