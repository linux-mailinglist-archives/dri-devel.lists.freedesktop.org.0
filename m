Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E232345603
	for <lists+dri-devel@lfdr.de>; Fri, 14 Jun 2019 09:24:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 946C1898BC;
	Fri, 14 Jun 2019 07:22:48 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-qk1-x742.google.com (mail-qk1-x742.google.com
 [IPv6:2607:f8b0:4864:20::742])
 by gabe.freedesktop.org (Postfix) with ESMTPS id AE824892EF
 for <dri-devel@lists.freedesktop.org>; Fri, 14 Jun 2019 00:44:57 +0000 (UTC)
Received: by mail-qk1-x742.google.com with SMTP id i125so624695qkd.6
 for <dri-devel@lists.freedesktop.org>; Thu, 13 Jun 2019 17:44:57 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=vOT/1//lPYO2KnTg7JAYlGe+L6wOGbnqhk1iQ3bfzXA=;
 b=mH9qaVG1xF3p4gbw6U7vqXwBb4ArXM6vTv52Pazs1aSsbX8mzHTha/pfL+/KpaMaHN
 Sl5dlXTCbsSK0cP3h9PS4otNwRs7q/N9iyFaHlWfqP6ZH0Io5OUN/88HJ8RARWw8AnrW
 oN1Xll0MDX0E4exz+XHM1qMp+GJGesWdk5uiEiPscuF/40/KpFFwDqQ3sjJLhIaK3WRd
 /VZbISg7ps5FcPdFvrrFUlguHGrERpfd78z/CNkS0U/9eDtzDhjaNDlc/Mf1206lTtD4
 PpsFvFELz+AInGJIMZH+yD4VnwO/OXbZUYjZ8/PkxQvXb9xwW8DB1LDp4kIciVn8v+Jc
 mROg==
X-Gm-Message-State: APjAAAUaL/buZgVGbftoVgkXtTa/UpDZ+Ru5N8U07ZLXCcBzsBknHuPJ
 xU3DDs3iO9PoZVqt0yHDw2z/dg==
X-Google-Smtp-Source: APXvYqxEi3V4pWZnBZ6Egs6ifesaB2oNEQOI04AD8yR+MI7rsCDs0etSdyPsSPlsZHy2Q2fiQCFnwA==
X-Received: by 2002:a05:620a:1310:: with SMTP id
 o16mr71613012qkj.196.1560473096852; 
 Thu, 13 Jun 2019 17:44:56 -0700 (PDT)
Received: from ziepe.ca
 (hlfxns017vw-156-34-55-100.dhcp-dynamic.fibreop.ns.bellaliant.net.
 [156.34.55.100])
 by smtp.gmail.com with ESMTPSA id z126sm884276qkb.7.2019.06.13.17.44.54
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Thu, 13 Jun 2019 17:44:54 -0700 (PDT)
Received: from jgg by mlx.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1hbaKr-0005K2-Rs; Thu, 13 Jun 2019 21:44:53 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH v3 hmm 06/12] mm/hmm: Hold on to the mmget for the lifetime of
 the range
Date: Thu, 13 Jun 2019 21:44:44 -0300
Message-Id: <20190614004450.20252-7-jgg@ziepe.ca>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190614004450.20252-1-jgg@ziepe.ca>
References: <20190614004450.20252-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Fri, 14 Jun 2019 07:21:24 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=vOT/1//lPYO2KnTg7JAYlGe+L6wOGbnqhk1iQ3bfzXA=;
 b=KUyynqtgRE6EpplNjkgK7xEKW+4i8YtoCdu847R/HKHbJfnzbjofwdI3Ea6k0EuVSe
 1CZaEOJYQRtMq3h0sFFCemgzzSgbiIlR01ffFmvPX9pmujQZhT4dybPJ0azLpv2M3X9+
 6Tb39zktfnoe3oIet0A0akwq1fikYli3gOB8Ej+qnnX38PCI4BOZsTugxauTr9grN1NY
 o/xA6GHrOsOdFk1lM9xdmnpjoyYypBmE2AejoMzAHHaTMtA6L+OhWLo1qhD7nA3VHByF
 jua1HGswi4DoY/NGhXWwkfny9XYjh5QfCt8aiJgJGRL1dZHZMavFJ9hgwEsQQVXXj1WN
 tnCg==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, Philip Yang <Philip.Yang@amd.com>,
 linux-rdma@vger.kernel.org, amd-gfx@lists.freedesktop.org, linux-mm@kvack.org,
 Jason Gunthorpe <jgg@mellanox.com>, dri-devel@lists.freedesktop.org,
 Ben Skeggs <bskeggs@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKUmFuZ2UgZnVuY3Rpb25z
IGxpa2UgaG1tX3JhbmdlX3NuYXBzaG90KCkgYW5kIGhtbV9yYW5nZV9mYXVsdCgpIGNhbGwKZmlu
ZF92bWEsIHdoaWNoIHJlcXVpcmVzIGhvZGxpbmcgdGhlIG1tZ2V0KCkgYW5kIHRoZSBtbWFwX3Nl
bSBmb3IgdGhlIG1tLgoKTWFrZSB0aGlzIHNpbXBsZXIgZm9yIHRoZSBjYWxsZXJzIGJ5IGhvbGRp
bmcgdGhlIG1tZ2V0KCkgaW5zaWRlIHRoZSByYW5nZQpmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBy
YW5nZS4gT3RoZXIgZnVuY3Rpb25zIHRoYXQgYWNjZXB0IGEgcmFuZ2Ugc2hvdWxkCm9ubHkgYmUg
Y2FsbGVkIGlmIHRoZSByYW5nZSBpcyByZWdpc3RlcmVkLgoKVGhpcyBoYXMgdGhlIHNpZGUgZWZm
ZWN0IG9mIGRpcmVjdGx5IHByZXZlbnRpbmcgaG1tX3JlbGVhc2UoKSBmcm9tCmhhcHBlbmluZyB3
aGlsZSBhIHJhbmdlIGlzIHJlZ2lzdGVyZWQuIFRoYXQgbWVhbnMgcmFuZ2UtPmRlYWQgY2Fubm90
IGJlCmZhbHNlIGR1cmluZyB0aGUgbGlmZXRpbWUgb2YgdGhlIHJhbmdlLCBzbyByZW1vdmUgZGVh
ZCBhbmQKaG1tX21pcnJvcl9tbV9pc19hbGl2ZSgpIGVudGlyZWx5LgoKU2lnbmVkLW9mZi1ieTog
SmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgpSZXZpZXdlZC1ieTogSm9obiBIdWJi
YXJkIDxqaHViYmFyZEBudmlkaWEuY29tPgpSZXZpZXdlZC1ieTogUmFscGggQ2FtcGJlbGwgPHJj
YW1wYmVsbEBudmlkaWEuY29tPgpUZXN0ZWQtYnk6IFBoaWxpcCBZYW5nIDxQaGlsaXAuWWFuZ0Bh
bWQuY29tPgotLS0KdjI6CiAtIFVzZSBKZXJvbWUncyBpZGVhIG9mIGp1c3QgaG9sZGluZyB0aGUg
bW1nZXQoKSBmb3IgdGhlIHJhbmdlIGxpZmV0aW1lLAogICByZXdvcmsgdGhlIHBhdGNoIHRvIHVz
ZSB0aGF0IGFzIGFzIHNpbXBsaWZpY2F0aW9uIHRvIHJlbW92ZSBkZWFkIGluCiAgIG9uZSBzdGVw
Ci0tLQogaW5jbHVkZS9saW51eC9obW0uaCB8IDI2IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
CiBtbS9obW0uYyAgICAgICAgICAgIHwgMjggKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLQog
MiBmaWxlcyBjaGFuZ2VkLCAxMCBpbnNlcnRpb25zKCspLCA0NCBkZWxldGlvbnMoLSkKCmRpZmYg
LS1naXQgYS9pbmNsdWRlL2xpbnV4L2htbS5oIGIvaW5jbHVkZS9saW51eC9obW0uaAppbmRleCAy
NmU3YzQ3NzQ5MGM0ZS4uYmYwMTNlOTY1MjU3NzEgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvbGludXgv
aG1tLmgKKysrIGIvaW5jbHVkZS9saW51eC9obW0uaApAQCAtODIsNyArODIsNiBAQAogICogQG1p
cnJvcnNfc2VtOiByZWFkL3dyaXRlIHNlbWFwaG9yZSBwcm90ZWN0aW5nIHRoZSBtaXJyb3JzIGxp
c3QKICAqIEB3cTogd2FpdCBxdWV1ZSBmb3IgdXNlciB3YWl0aW5nIG9uIGEgcmFuZ2UgaW52YWxp
ZGF0aW9uCiAgKiBAbm90aWZpZXJzOiBjb3VudCBvZiBhY3RpdmUgbW11IG5vdGlmaWVycwotICog
QGRlYWQ6IGlzIHRoZSBtbSBkZWFkID8KICAqLwogc3RydWN0IGhtbSB7CiAJc3RydWN0IG1tX3N0
cnVjdAkqbW07CkBAIC05NSw3ICs5NCw2IEBAIHN0cnVjdCBobW0gewogCXdhaXRfcXVldWVfaGVh
ZF90CXdxOwogCXN0cnVjdCByY3VfaGVhZAkJcmN1OwogCWxvbmcJCQlub3RpZmllcnM7Ci0JYm9v
bAkJCWRlYWQ7CiB9OwogCiAvKgpAQCAtNDU5LDMwICs0NTcsNiBAQCBzdHJ1Y3QgaG1tX21pcnJv
ciB7CiBpbnQgaG1tX21pcnJvcl9yZWdpc3RlcihzdHJ1Y3QgaG1tX21pcnJvciAqbWlycm9yLCBz
dHJ1Y3QgbW1fc3RydWN0ICptbSk7CiB2b2lkIGhtbV9taXJyb3JfdW5yZWdpc3RlcihzdHJ1Y3Qg
aG1tX21pcnJvciAqbWlycm9yKTsKIAotLyoKLSAqIGhtbV9taXJyb3JfbW1faXNfYWxpdmUoKSAt
IHRlc3QgaWYgbW0gaXMgc3RpbGwgYWxpdmUKLSAqIEBtaXJyb3I6IHRoZSBITU0gbW0gbWlycm9y
IGZvciB3aGljaCB3ZSB3YW50IHRvIGxvY2sgdGhlIG1tYXBfc2VtCi0gKiBSZXR1cm46IGZhbHNl
IGlmIHRoZSBtbSBpcyBkZWFkLCB0cnVlIG90aGVyd2lzZQotICoKLSAqIFRoaXMgaXMgYW4gb3B0
aW1pemF0aW9uLCBpdCB3aWxsIG5vdCBhbHdheXMgYWNjdXJhdGVseSByZXR1cm4gZmFsc2UgaWYg
dGhlCi0gKiBtbSBpcyBkZWFkOyBpLmUuLCB0aGVyZSBjYW4gYmUgZmFsc2UgbmVnYXRpdmVzIChw
cm9jZXNzIGlzIGJlaW5nIGtpbGxlZCBidXQKLSAqIEhNTSBpcyBub3QgeWV0IGluZm9ybWVkIG9m
IHRoYXQpLiBJdCBpcyBvbmx5IGludGVuZGVkIHRvIGJlIHVzZWQgdG8gb3B0aW1pemUKLSAqIG91
dCBjYXNlcyB3aGVyZSB0aGUgZHJpdmVyIGlzIGFib3V0IHRvIGRvIHNvbWV0aGluZyB0aW1lIGNv
bnN1bWluZyBhbmQgaXQKLSAqIHdvdWxkIGJlIGJldHRlciB0byBza2lwIGl0IGlmIHRoZSBtbSBp
cyBkZWFkLgotICovCi1zdGF0aWMgaW5saW5lIGJvb2wgaG1tX21pcnJvcl9tbV9pc19hbGl2ZShz
dHJ1Y3QgaG1tX21pcnJvciAqbWlycm9yKQotewotCXN0cnVjdCBtbV9zdHJ1Y3QgKm1tOwotCi0J
aWYgKCFtaXJyb3IgfHwgIW1pcnJvci0+aG1tKQotCQlyZXR1cm4gZmFsc2U7Ci0JbW0gPSBSRUFE
X09OQ0UobWlycm9yLT5obW0tPm1tKTsKLQlpZiAobWlycm9yLT5obW0tPmRlYWQgfHwgIW1tKQot
CQlyZXR1cm4gZmFsc2U7Ci0KLQlyZXR1cm4gdHJ1ZTsKLX0KLQogLyoKICAqIFBsZWFzZSBzZWUg
RG9jdW1lbnRhdGlvbi92bS9obW0ucnN0IGZvciBob3cgdG8gdXNlIHRoZSByYW5nZSBBUEkuCiAg
Ki8KZGlmZiAtLWdpdCBhL21tL2htbS5jIGIvbW0vaG1tLmMKaW5kZXggNGM2NGQ0YzMyZjQ4MjUu
LjU4NzEyZDc0ZWRkNTg1IDEwMDY0NAotLS0gYS9tbS9obW0uYworKysgYi9tbS9obW0uYwpAQCAt
NzAsNyArNzAsNiBAQCBzdGF0aWMgc3RydWN0IGhtbSAqaG1tX2dldF9vcl9jcmVhdGUoc3RydWN0
IG1tX3N0cnVjdCAqbW0pCiAJbXV0ZXhfaW5pdCgmaG1tLT5sb2NrKTsKIAlrcmVmX2luaXQoJmht
bS0+a3JlZik7CiAJaG1tLT5ub3RpZmllcnMgPSAwOwotCWhtbS0+ZGVhZCA9IGZhbHNlOwogCWht
bS0+bW0gPSBtbTsKIAogCWhtbS0+bW11X25vdGlmaWVyLm9wcyA9ICZobW1fbW11X25vdGlmaWVy
X29wczsKQEAgLTEyNSwyMCArMTI0LDE3IEBAIHN0YXRpYyB2b2lkIGhtbV9yZWxlYXNlKHN0cnVj
dCBtbXVfbm90aWZpZXIgKm1uLCBzdHJ1Y3QgbW1fc3RydWN0ICptbSkKIHsKIAlzdHJ1Y3QgaG1t
ICpobW0gPSBjb250YWluZXJfb2YobW4sIHN0cnVjdCBobW0sIG1tdV9ub3RpZmllcik7CiAJc3Ry
dWN0IGhtbV9taXJyb3IgKm1pcnJvcjsKLQlzdHJ1Y3QgaG1tX3JhbmdlICpyYW5nZTsKIAogCS8q
IEJhaWwgb3V0IGlmIGhtbSBpcyBpbiB0aGUgcHJvY2VzcyBvZiBiZWluZyBmcmVlZCAqLwogCWlm
ICgha3JlZl9nZXRfdW5sZXNzX3plcm8oJmhtbS0+a3JlZikpCiAJCXJldHVybjsKIAotCS8qIFJl
cG9ydCB0aGlzIEhNTSBhcyBkeWluZy4gKi8KLQlobW0tPmRlYWQgPSB0cnVlOwotCi0JLyogV2Fr
ZS11cCBldmVyeW9uZSB3YWl0aW5nIG9uIGFueSByYW5nZS4gKi8KIAltdXRleF9sb2NrKCZobW0t
PmxvY2spOwotCWxpc3RfZm9yX2VhY2hfZW50cnkocmFuZ2UsICZobW0tPnJhbmdlcywgbGlzdCkK
LQkJcmFuZ2UtPnZhbGlkID0gZmFsc2U7Ci0Jd2FrZV91cF9hbGwoJmhtbS0+d3EpOworCS8qCisJ
ICogU2luY2UgaG1tX3JhbmdlX3JlZ2lzdGVyKCkgaG9sZHMgdGhlIG1tZ2V0KCkgbG9jayBobW1f
cmVsZWFzZSgpIGlzCisJICogcHJldmVudGVkIGFzIGxvbmcgYXMgYSByYW5nZSBleGlzdHMuCisJ
ICovCisJV0FSTl9PTighbGlzdF9lbXB0eSgmaG1tLT5yYW5nZXMpKTsKIAltdXRleF91bmxvY2so
JmhtbS0+bG9jayk7CiAKIAlkb3duX3dyaXRlKCZobW0tPm1pcnJvcnNfc2VtKTsKQEAgLTkwOCw4
ICs5MDQsOCBAQCBpbnQgaG1tX3JhbmdlX3JlZ2lzdGVyKHN0cnVjdCBobW1fcmFuZ2UgKnJhbmdl
LAogCXJhbmdlLT5zdGFydCA9IHN0YXJ0OwogCXJhbmdlLT5lbmQgPSBlbmQ7CiAKLQkvKiBDaGVj
ayBpZiBobW1fbW1fZGVzdHJveSgpIHdhcyBjYWxsLiAqLwotCWlmIChobW0tPm1tID09IE5VTEwg
fHwgaG1tLT5kZWFkKQorCS8qIFByZXZlbnQgaG1tX3JlbGVhc2UoKSBmcm9tIHJ1bm5pbmcgd2hp
bGUgdGhlIHJhbmdlIGlzIHZhbGlkICovCisJaWYgKCFtbWdldF9ub3RfemVybyhobW0tPm1tKSkK
IAkJcmV0dXJuIC1FRkFVTFQ7CiAKIAkvKiBJbml0aWFsaXplIHJhbmdlIHRvIHRyYWNrIENQVSBw
YWdlIHRhYmxlIHVwZGF0ZXMuICovCkBAIC05NTIsNiArOTQ4LDcgQEAgdm9pZCBobW1fcmFuZ2Vf
dW5yZWdpc3RlcihzdHJ1Y3QgaG1tX3JhbmdlICpyYW5nZSkKIAogCS8qIERyb3AgcmVmZXJlbmNl
IHRha2VuIGJ5IGhtbV9yYW5nZV9yZWdpc3RlcigpICovCiAJcmFuZ2UtPnZhbGlkID0gZmFsc2U7
CisJbW1wdXQoaG1tLT5tbSk7CiAJaG1tX3B1dChobW0pOwogCXJhbmdlLT5obW0gPSBOVUxMOwog
fQpAQCAtOTc5LDEwICs5NzYsNyBAQCBsb25nIGhtbV9yYW5nZV9zbmFwc2hvdChzdHJ1Y3QgaG1t
X3JhbmdlICpyYW5nZSkKIAlzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYTsKIAlzdHJ1Y3QgbW1f
d2FsayBtbV93YWxrOwogCi0JLyogQ2hlY2sgaWYgaG1tX21tX2Rlc3Ryb3koKSB3YXMgY2FsbC4g
Ki8KLQlpZiAoaG1tLT5tbSA9PSBOVUxMIHx8IGhtbS0+ZGVhZCkKLQkJcmV0dXJuIC1FRkFVTFQ7
Ci0KKwlsb2NrZGVwX2Fzc2VydF9oZWxkKCZobW0tPm1tLT5tbWFwX3NlbSk7CiAJZG8gewogCQkv
KiBJZiByYW5nZSBpcyBubyBsb25nZXIgdmFsaWQgZm9yY2UgcmV0cnkuICovCiAJCWlmICghcmFu
Z2UtPnZhbGlkKQpAQCAtMTA3Nyw5ICsxMDcxLDcgQEAgbG9uZyBobW1fcmFuZ2VfZmF1bHQoc3Ry
dWN0IGhtbV9yYW5nZSAqcmFuZ2UsIGJvb2wgYmxvY2spCiAJc3RydWN0IG1tX3dhbGsgbW1fd2Fs
azsKIAlpbnQgcmV0OwogCi0JLyogQ2hlY2sgaWYgaG1tX21tX2Rlc3Ryb3koKSB3YXMgY2FsbC4g
Ki8KLQlpZiAoaG1tLT5tbSA9PSBOVUxMIHx8IGhtbS0+ZGVhZCkKLQkJcmV0dXJuIC1FRkFVTFQ7
CisJbG9ja2RlcF9hc3NlcnRfaGVsZCgmaG1tLT5tbS0+bW1hcF9zZW0pOwogCiAJZG8gewogCQkv
KiBJZiByYW5nZSBpcyBubyBsb25nZXIgdmFsaWQgZm9yY2UgcmV0cnkuICovCi0tIAoyLjIxLjAK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZl
bCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
