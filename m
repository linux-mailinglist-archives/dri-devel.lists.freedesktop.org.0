Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 0FBD331063A
	for <lists+dri-devel@lfdr.de>; Fri,  5 Feb 2021 09:06:44 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C27D36F40B;
	Fri,  5 Feb 2021 08:06:41 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pf1-x42e.google.com (mail-pf1-x42e.google.com
 [IPv6:2607:f8b0:4864:20::42e])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0C8D96F40B
 for <dri-devel@lists.freedesktop.org>; Fri,  5 Feb 2021 08:06:39 +0000 (UTC)
Received: by mail-pf1-x42e.google.com with SMTP id o20so3846232pfu.0
 for <dri-devel@lists.freedesktop.org>; Fri, 05 Feb 2021 00:06:39 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=GOndOP8F+BfXNLjrSX9CtfpObuYsc9aU1JNxbRzKav4=;
 b=Nn+MlC5tKBHafRdbSa7S8DmObCjHIWlNYVXwMR2RRmFpY/1YFN/JejT9MseDX0khO/
 Piwh7OqAi92p946kQ+P8IdpWiNbpooftChpefls8Lmv9U8Q7rleVcIwXuOnqu/4BQzC+
 goprUTNEMoRlSmp6To1gKsxWw6vM72Yr5P7HEGj5Yi9M5drA9jSPHpz65qDMqWz+R6RX
 v/NGL7oFcwvXJOVn5S/LHz+ARYcnN5bywATDFLipVqQsms2hfi5V5SGE6jH3LGHk0hhg
 /aqgi5o6SNZzoeZBdlWnAv3EE3rtQ2IxAYedQIia3hiO+oABFCiB/SacNV9a2foTJouk
 GRDA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=GOndOP8F+BfXNLjrSX9CtfpObuYsc9aU1JNxbRzKav4=;
 b=ReuultB+8jCQaeXdNWY0dqtOWDaaX13+T5+xLwMudUWRgKarAJ97t8ruWFUpxrMD4V
 SU/QuSMiBNrSgX5rr2FHgyUMPnrDO14uvmLGO/HTq8BSRiheX5kdCRfxYklXieoYG41g
 BKTJeYHLoosfLUdh6bZbpE+XEHUw64+52uNnHAGtP2IdTgUeOohmLZ5PJLzdPpHRLgVf
 cr9fvvBYrLQOdB5pnSAV9xAFnJ+VdB17OPTn9PxWCNi1iUGIC4WGGOjRdJZF4tswuhkN
 yXcvSvcCwc24T1ajgfrpKQHgw1kU9blKq/n0VD5YK/jNTdN6gyUiw3ifm9tbwI+JEqA3
 F2SQ==
X-Gm-Message-State: AOAM532Hpg3w7AcN4Xf6KpEj6gV/shTgAbqw1zSxscLDXF/nTvMH/upz
 K4nJoD/pwqgd2vBwDQp94Fujmw==
X-Google-Smtp-Source: ABdhPJx+FpGulW/NuF4+mtl7ogJq0jqebiVtB3k4/SZDAmxf9F1Xx8HSTD5aCBfLoqE9Pbnctuk3TQ==
X-Received: by 2002:aa7:9538:0:b029:1d6:ccef:72ad with SMTP id
 c24-20020aa795380000b02901d6ccef72admr3319521pfp.64.1612512399559; 
 Fri, 05 Feb 2021 00:06:39 -0800 (PST)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 32sm9520070pgq.80.2021.02.05.00.06.37
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 05 Feb 2021 00:06:38 -0800 (PST)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [RFC][PATCH v6 7/7] dma-buf: system_heap: Add deferred freeing to the
 system heap
Date: Fri,  5 Feb 2021 08:06:21 +0000
Message-Id: <20210205080621.3102035-8-john.stultz@linaro.org>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210205080621.3102035-1-john.stultz@linaro.org>
References: <20210205080621.3102035-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: dri-devel@lists.freedesktop.org, Sandeep Patil <sspatil@google.com>,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Chris Goldsworthy <cgoldswo@codeaurora.org>,
 Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 linux-media@vger.kernel.org, Suren Baghdasaryan <surenb@google.com>,
 Christian Koenig <christian.koenig@amd.com>,
 Daniel Mentz <danielmentz@google.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VXRpbGl6ZSB0aGUgZGVmZXJyZWQgZnJlZSBoZWxwZXIgbGlicmFyeSBpbiB0aGUgc3lzdGVtIGhl
YXAuCgpUaGlzIHByb3ZpZGVzIGEgbmljZSBwZXJmb3JtYW5jZSBidW1wIGFuZCBwdXRzIHRoZQpz
eXN0ZW0gaGVhcCBwZXJmb3JtYW5jZSBvbiBwYXIgd2l0aCBJT04uCgpDYzogRGFuaWVsIFZldHRl
ciA8ZGFuaWVsQGZmd2xsLmNoPgpDYzogQ2hyaXN0aWFuIEtvZW5pZyA8Y2hyaXN0aWFuLmtvZW5p
Z0BhbWQuY29tPgpDYzogU3VtaXQgU2Vtd2FsIDxzdW1pdC5zZW13YWxAbGluYXJvLm9yZz4KQ2M6
IExpYW0gTWFyayA8bG1hcmtAY29kZWF1cm9yYS5vcmc+CkNjOiBDaHJpcyBHb2xkc3dvcnRoeSA8
Y2dvbGRzd29AY29kZWF1cm9yYS5vcmc+CkNjOiBMYXVyYSBBYmJvdHQgPGxhYmJvdHRAa2VybmVs
Lm9yZz4KQ2M6IEJyaWFuIFN0YXJrZXkgPEJyaWFuLlN0YXJrZXlAYXJtLmNvbT4KQ2M6IEhyaWR5
YSBWYWxzYXJhanUgPGhyaWR5YUBnb29nbGUuY29tPgpDYzogU3VyZW4gQmFnaGRhc2FyeWFuIDxz
dXJlbmJAZ29vZ2xlLmNvbT4KQ2M6IFNhbmRlZXAgUGF0aWwgPHNzcGF0aWxAZ29vZ2xlLmNvbT4K
Q2M6IERhbmllbCBNZW50eiA8ZGFuaWVsbWVudHpAZ29vZ2xlLmNvbT4KQ2M6IMOYcmphbiBFaWRl
IDxvcmphbi5laWRlQGFybS5jb20+CkNjOiBSb2JpbiBNdXJwaHkgPHJvYmluLm11cnBoeUBhcm0u
Y29tPgpDYzogRXplcXVpZWwgR2FyY2lhIDxlemVxdWllbEBjb2xsYWJvcmEuY29tPgpDYzogU2lt
b24gU2VyIDxjb250YWN0QGVtZXJzaW9uLmZyPgpDYzogSmFtZXMgSm9uZXMgPGpham9uZXNAbnZp
ZGlhLmNvbT4KQ2M6IGxpbnV4LW1lZGlhQHZnZXIua2VybmVsLm9yZwpDYzogZHJpLWRldmVsQGxp
c3RzLmZyZWVkZXNrdG9wLm9yZwpTaWduZWQtb2ZmLWJ5OiBKb2huIFN0dWx0eiA8am9obi5zdHVs
dHpAbGluYXJvLm9yZz4KLS0tCnYyOgoqIFJld29yayBkZWZlcnJlZC1mcmVlIGFwaSB0byB1c2Ug
cmVhc29uIGVudW0gYXMgc3VnZ2VzdGVkIGJ5CiAgU3VyZW4gQmFnaGRhc2FyeWFuCi0tLQogZHJp
dmVycy9kbWEtYnVmL2hlYXBzL0tjb25maWcgICAgICAgfCAgMSArCiBkcml2ZXJzL2RtYS1idWYv
aGVhcHMvc3lzdGVtX2hlYXAuYyB8IDMxICsrKysrKysrKysrKysrKysrKysrKystLS0tLS0tCiAy
IGZpbGVzIGNoYW5nZWQsIDI1IGluc2VydGlvbnMoKyksIDcgZGVsZXRpb25zKC0pCgpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9kbWEtYnVmL2hlYXBzL0tjb25maWcgYi9kcml2ZXJzL2RtYS1idWYvaGVh
cHMvS2NvbmZpZwppbmRleCA3ZTI4OTM0ZTBkZWYuLjEwNjMyY2NmYjRhNSAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9kbWEtYnVmL2hlYXBzL0tjb25maWcKKysrIGIvZHJpdmVycy9kbWEtYnVmL2hlYXBz
L0tjb25maWcKQEAgLTUsNiArNSw3IEBAIGNvbmZpZyBETUFCVUZfSEVBUFNfU1lTVEVNCiAJYm9v
bCAiRE1BLUJVRiBTeXN0ZW0gSGVhcCIKIAlkZXBlbmRzIG9uIERNQUJVRl9IRUFQUwogCXNlbGVj
dCBEUk1fUEFHRV9QT09MCisJc2VsZWN0IERNQUJVRl9IRUFQU19ERUZFUlJFRF9GUkVFCiAJaGVs
cAogCSAgQ2hvb3NlIHRoaXMgb3B0aW9uIHRvIGVuYWJsZSB0aGUgc3lzdGVtIGRtYWJ1ZiBoZWFw
LiBUaGUgc3lzdGVtIGhlYXAKIAkgIGlzIGJhY2tlZCBieSBwYWdlcyBmcm9tIHRoZSBidWRkeSBh
bGxvY2F0b3IuIElmIGluIGRvdWJ0LCBzYXkgWS4KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1
Zi9oZWFwcy9zeXN0ZW1faGVhcC5jIGIvZHJpdmVycy9kbWEtYnVmL2hlYXBzL3N5c3RlbV9oZWFw
LmMKaW5kZXggNmQzOWU5ZjMyZTM2Li4wNDIyNDQ0MDdkYjUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
ZG1hLWJ1Zi9oZWFwcy9zeXN0ZW1faGVhcC5jCisrKyBiL2RyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9z
eXN0ZW1faGVhcC5jCkBAIC0yMiw2ICsyMiw3IEBACiAjaW5jbHVkZSA8bGludXgvdm1hbGxvYy5o
PgogCiAjaW5jbHVkZSA8ZHJtL3BhZ2VfcG9vbC5oPgorI2luY2x1ZGUgImRlZmVycmVkLWZyZWUt
aGVscGVyLmgiCiAKIHN0YXRpYyBzdHJ1Y3QgZG1hX2hlYXAgKnN5c19oZWFwOwogCkBAIC0zMyw2
ICszNCw3IEBAIHN0cnVjdCBzeXN0ZW1faGVhcF9idWZmZXIgewogCXN0cnVjdCBzZ190YWJsZSBz
Z190YWJsZTsKIAlpbnQgdm1hcF9jbnQ7CiAJdm9pZCAqdmFkZHI7CisJc3RydWN0IGRlZmVycmVk
X2ZyZWVsaXN0X2l0ZW0gZGVmZXJyZWRfZnJlZTsKIH07CiAKIHN0cnVjdCBkbWFfaGVhcF9hdHRh
Y2htZW50IHsKQEAgLTMwOCwzMCArMzEwLDQ1IEBAIHN0YXRpYyBpbnQgc3lzdGVtX2hlYXBfemVy
b19idWZmZXIoc3RydWN0IHN5c3RlbV9oZWFwX2J1ZmZlciAqYnVmZmVyKQogCXJldHVybiByZXQ7
CiB9CiAKLXN0YXRpYyB2b2lkIHN5c3RlbV9oZWFwX2RtYV9idWZfcmVsZWFzZShzdHJ1Y3QgZG1h
X2J1ZiAqZG1hYnVmKQorc3RhdGljIHZvaWQgc3lzdGVtX2hlYXBfYnVmX2ZyZWUoc3RydWN0IGRl
ZmVycmVkX2ZyZWVsaXN0X2l0ZW0gKml0ZW0sCisJCQkJIGVudW0gZGZfcmVhc29uIHJlYXNvbikK
IHsKLQlzdHJ1Y3Qgc3lzdGVtX2hlYXBfYnVmZmVyICpidWZmZXIgPSBkbWFidWYtPnByaXY7CisJ
c3RydWN0IHN5c3RlbV9oZWFwX2J1ZmZlciAqYnVmZmVyOwogCXN0cnVjdCBzZ190YWJsZSAqdGFi
bGU7CiAJc3RydWN0IHNjYXR0ZXJsaXN0ICpzZzsKIAlpbnQgaSwgajsKIAorCWJ1ZmZlciA9IGNv
bnRhaW5lcl9vZihpdGVtLCBzdHJ1Y3Qgc3lzdGVtX2hlYXBfYnVmZmVyLCBkZWZlcnJlZF9mcmVl
KTsKIAkvKiBaZXJvIHRoZSBidWZmZXIgcGFnZXMgYmVmb3JlIGFkZGluZyBiYWNrIHRvIHRoZSBw
b29sICovCi0Jc3lzdGVtX2hlYXBfemVyb19idWZmZXIoYnVmZmVyKTsKKwlpZiAocmVhc29uID09
IERGX05PUk1BTCkKKwkJaWYgKHN5c3RlbV9oZWFwX3plcm9fYnVmZmVyKGJ1ZmZlcikpCisJCQly
ZWFzb24gPSBERl9VTkRFUl9QUkVTU1VSRTsgLy8gT24gZmFpbHVyZSwganVzdCBmcmVlCiAKIAl0
YWJsZSA9ICZidWZmZXItPnNnX3RhYmxlOwogCWZvcl9lYWNoX3NnKHRhYmxlLT5zZ2wsIHNnLCB0
YWJsZS0+bmVudHMsIGkpIHsKIAkJc3RydWN0IHBhZ2UgKnBhZ2UgPSBzZ19wYWdlKHNnKTsKIAot
CQlmb3IgKGogPSAwOyBqIDwgTlVNX09SREVSUzsgaisrKSB7Ci0JCQlpZiAoY29tcG91bmRfb3Jk
ZXIocGFnZSkgPT0gb3JkZXJzW2pdKQotCQkJCWJyZWFrOworCQlpZiAocmVhc29uID09IERGX1VO
REVSX1BSRVNTVVJFKSB7CisJCQlfX2ZyZWVfcGFnZXMocGFnZSwgY29tcG91bmRfb3JkZXIocGFn
ZSkpOworCQl9IGVsc2UgeworCQkJZm9yIChqID0gMDsgaiA8IE5VTV9PUkRFUlM7IGorKykgewor
CQkJCWlmIChjb21wb3VuZF9vcmRlcihwYWdlKSA9PSBvcmRlcnNbal0pCisJCQkJCWJyZWFrOwor
CQkJfQorCQkJZHJtX3BhZ2VfcG9vbF9hZGQocG9vbHNbal0sIHBhZ2UpOwogCQl9Ci0JCWRybV9w
YWdlX3Bvb2xfYWRkKHBvb2xzW2pdLCBwYWdlKTsKIAl9CiAJc2dfZnJlZV90YWJsZSh0YWJsZSk7
CiAJa2ZyZWUoYnVmZmVyKTsKIH0KIAorc3RhdGljIHZvaWQgc3lzdGVtX2hlYXBfZG1hX2J1Zl9y
ZWxlYXNlKHN0cnVjdCBkbWFfYnVmICpkbWFidWYpCit7CisJc3RydWN0IHN5c3RlbV9oZWFwX2J1
ZmZlciAqYnVmZmVyID0gZG1hYnVmLT5wcml2OworCisJZGVmZXJyZWRfZnJlZSgmYnVmZmVyLT5k
ZWZlcnJlZF9mcmVlLCBzeXN0ZW1faGVhcF9idWZfZnJlZSwgYnVmZmVyLT5sZW4pOworfQorCiBz
dGF0aWMgY29uc3Qgc3RydWN0IGRtYV9idWZfb3BzIHN5c3RlbV9oZWFwX2J1Zl9vcHMgPSB7CiAJ
LmF0dGFjaCA9IHN5c3RlbV9oZWFwX2F0dGFjaCwKIAkuZGV0YWNoID0gc3lzdGVtX2hlYXBfZGV0
YWNoLAotLSAKMi4yNS4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3Rv
cC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmkt
ZGV2ZWwK
