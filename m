Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 19BEF2C6486
	for <lists+dri-devel@lfdr.de>; Fri, 27 Nov 2020 13:09:35 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 4CE776EC55;
	Fri, 27 Nov 2020 12:08:45 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 578FE6EC24;
 Fri, 27 Nov 2020 12:08:16 +0000 (UTC)
IronPort-SDR: 8xqJa38DKyffCvRnNGrYQYT6yr4KtRRrT7PYQ4AGRwk45QbnjzItbMqu67t6hhbrKbk1M3DIjq
 Jcwtm+K/Jv5w==
X-IronPort-AV: E=McAfee;i="6000,8403,9817"; a="168883421"
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="168883421"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga005.jf.intel.com ([10.7.209.41])
 by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:08:16 -0800
IronPort-SDR: q65xF5fu0duJSHiregfdjYy2KgkBhp1v1ffo2oK909YpsygClyffMvcnlIW8AU/TWjjF7BXrI+
 QzhlaG0NCeiA==
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="548028685"
Received: from mjgleeso-mobl.ger.corp.intel.com (HELO
 mwauld-desk1.ger.corp.intel.com) ([10.251.85.2])
 by orsmga005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:08:14 -0800
From: Matthew Auld <matthew.auld@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [RFC PATCH 027/162] drm/i915: Populate logical context during first
 pin.
Date: Fri, 27 Nov 2020 12:05:03 +0000
Message-Id: <20201127120718.454037-28-matthew.auld@intel.com>
X-Mailer: git-send-email 2.26.2
In-Reply-To: <20201127120718.454037-1-matthew.auld@intel.com>
References: <20201127120718.454037-1-matthew.auld@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: dri-devel@lists.freedesktop.org,
 =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNv
bT4KClRoaXMgYWxsb3dzIHVzIHRvIHJlbW92ZSBwaW5fbWFwIGZyb20gc3RhdGUgYWxsb2NhdGlv
biwgd2hpY2ggc2F2ZXMKdXMgYSBmZXcgcmV0cnkgbG9vcHMuIFdlIHdvbid0IG5lZWQgdGhpcyB1
bnRpbCBmaXJzdCBwaW4sIGFueXdheS4KClNpZ25lZC1vZmYtYnk6IE1hYXJ0ZW4gTGFua2hvcnN0
IDxtYWFydGVuLmxhbmtob3JzdEBsaW51eC5pbnRlbC5jb20+CkNjOiBUaG9tYXMgSGVsbHN0csO2
bSA8dGhvbWFzLmhlbGxzdHJvbUBsaW51eC5pbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJt
L2k5MTUvZ3QvaW50ZWxfY29udGV4dF90eXBlcy5oIHwgIDEzICsrLQogLi4uL2RybS9pOTE1L2d0
L2ludGVsX2V4ZWNsaXN0c19zdWJtaXNzaW9uLmMgIHwgMTA3ICsrKysrKysrKy0tLS0tLS0tLQog
MiBmaWxlcyBjaGFuZ2VkLCA2MiBpbnNlcnRpb25zKCspLCA1OCBkZWxldGlvbnMoLSkKCmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmggYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9jb250ZXh0X3R5cGVzLmgKaW5kZXggNTJmYTlj
MTMyNzQ2Li5hNTkzYzk4Mzk4YTcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0
L2ludGVsX2NvbnRleHRfdHlwZXMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9jb250ZXh0X3R5cGVzLmgKQEAgLTgxLDEyICs4MSwxMyBAQCBzdHJ1Y3QgaW50ZWxfY29udGV4
dCB7CiAJdW5zaWduZWQgbG9uZyBmbGFnczsKICNkZWZpbmUgQ09OVEVYVF9CQVJSSUVSX0JJVAkJ
MAogI2RlZmluZSBDT05URVhUX0FMTE9DX0JJVAkJMQotI2RlZmluZSBDT05URVhUX1ZBTElEX0JJ
VAkJMgotI2RlZmluZSBDT05URVhUX0NMT1NFRF9CSVQJCTMKLSNkZWZpbmUgQ09OVEVYVF9VU0Vf
U0VNQVBIT1JFUwkJNAotI2RlZmluZSBDT05URVhUX0JBTk5FRAkJCTUKLSNkZWZpbmUgQ09OVEVY
VF9GT1JDRV9TSU5HTEVfU1VCTUlTU0lPTgk2Ci0jZGVmaW5lIENPTlRFWFRfTk9QUkVFTVBUCQk3
CisjZGVmaW5lIENPTlRFWFRfSU5JVF9CSVQJCTIKKyNkZWZpbmUgQ09OVEVYVF9WQUxJRF9CSVQJ
CTMKKyNkZWZpbmUgQ09OVEVYVF9DTE9TRURfQklUCQk0CisjZGVmaW5lIENPTlRFWFRfVVNFX1NF
TUFQSE9SRVMJCTUKKyNkZWZpbmUgQ09OVEVYVF9CQU5ORUQJCQk2CisjZGVmaW5lIENPTlRFWFRf
Rk9SQ0VfU0lOR0xFX1NVQk1JU1NJT04JNworI2RlZmluZSBDT05URVhUX05PUFJFRU1QVAkJOAog
CiAJdTMyICpscmNfcmVnX3N0YXRlOwogCXVuaW9uIHsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L2d0L2ludGVsX2V4ZWNsaXN0c19zdWJtaXNzaW9uLmMgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9leGVjbGlzdHNfc3VibWlzc2lvbi5jCmluZGV4IDFjYzkzZWE2Yjdm
MC4uN2VlYzQyYjI3YmMxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9leGVjbGlzdHNfc3VibWlzc2lvbi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2lu
dGVsX2V4ZWNsaXN0c19zdWJtaXNzaW9uLmMKQEAgLTM0OTcsOSArMzQ5NywzOSBAQCBfX2V4ZWNs
aXN0c191cGRhdGVfcmVnX3N0YXRlKGNvbnN0IHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKIAl9
CiB9CiAKK3N0YXRpYyB2b2lkIHBvcHVsYXRlX2xyX2NvbnRleHQoc3RydWN0IGludGVsX2NvbnRl
eHQgKmNlLAorCQkJCXN0cnVjdCBpbnRlbF9lbmdpbmVfY3MgKmVuZ2luZSwKKwkJCQl2b2lkICp2
YWRkcikKK3sKKwlib29sIGluaGliaXQgPSB0cnVlOworCXN0cnVjdCBkcm1faTkxNV9nZW1fb2Jq
ZWN0ICpjdHhfb2JqID0gY2UtPnN0YXRlLT5vYmo7CisKKwlzZXRfcmVkem9uZSh2YWRkciwgZW5n
aW5lKTsKKworCWlmIChlbmdpbmUtPmRlZmF1bHRfc3RhdGUpIHsKKwkJc2htZW1fcmVhZChlbmdp
bmUtPmRlZmF1bHRfc3RhdGUsIDAsCisJCQkgICB2YWRkciwgZW5naW5lLT5jb250ZXh0X3NpemUp
OworCQlfX3NldF9iaXQoQ09OVEVYVF9WQUxJRF9CSVQsICZjZS0+ZmxhZ3MpOworCQlpbmhpYml0
ID0gZmFsc2U7CisJfQorCisJLyogQ2xlYXIgdGhlIHBwSFdTUCAoaW5jLiBwZXItY29udGV4dCBj
b3VudGVycykgKi8KKwltZW1zZXQodmFkZHIsIDAsIFBBR0VfU0laRSk7CisKKwkvKgorCSAqIFRo
ZSBzZWNvbmQgcGFnZSBvZiB0aGUgY29udGV4dCBvYmplY3QgY29udGFpbnMgc29tZSByZWdpc3Rl
cnMgd2hpY2gKKwkgKiBtdXN0IGJlIHNldCB1cCBwcmlvciB0byB0aGUgZmlyc3QgZXhlY3V0aW9u
LgorCSAqLworCWV4ZWNsaXN0c19pbml0X3JlZ19zdGF0ZSh2YWRkciArIExSQ19TVEFURV9PRkZT
RVQsCisJCQkJIGNlLCBlbmdpbmUsIGNlLT5yaW5nLCBpbmhpYml0KTsKKworCV9faTkxNV9nZW1f
b2JqZWN0X2ZsdXNoX21hcChjdHhfb2JqLCAwLCBlbmdpbmUtPmNvbnRleHRfc2l6ZSk7Cit9CisK
IHN0YXRpYyBpbnQKLWV4ZWNsaXN0c19jb250ZXh0X3ByZV9waW4oc3RydWN0IGludGVsX2NvbnRl
eHQgKmNlLAotCQkJICBzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4ICp3dywgdm9pZCAqKnZhZGRyKQor
X19leGVjbGlzdHNfY29udGV4dF9wcmVfcGluKHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJ
CSAgICBzdHJ1Y3QgaW50ZWxfZW5naW5lX2NzICplbmdpbmUsCisJCQkgICAgc3RydWN0IGk5MTVf
Z2VtX3d3X2N0eCAqd3csIHZvaWQgKip2YWRkcikKIHsKIAlHRU1fQlVHX09OKCFjZS0+c3RhdGUp
OwogCUdFTV9CVUdfT04oIWk5MTVfdm1hX2lzX3Bpbm5lZChjZS0+c3RhdGUpKTsKQEAgLTM1MDcs
OCArMzUzNywyMCBAQCBleGVjbGlzdHNfY29udGV4dF9wcmVfcGluKHN0cnVjdCBpbnRlbF9jb250
ZXh0ICpjZSwKIAkqdmFkZHIgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChjZS0+c3RhdGUtPm9i
aiwKIAkJCQkJaTkxNV9jb2hlcmVudF9tYXBfdHlwZShjZS0+ZW5naW5lLT5pOTE1KSB8CiAJCQkJ
CUk5MTVfTUFQX09WRVJSSURFKTsKKwlpZiAoSVNfRVJSKCp2YWRkcikpCisJCXJldHVybiBQVFJf
RVJSKCp2YWRkcik7CisKKwlpZiAoIV9fdGVzdF9hbmRfc2V0X2JpdChDT05URVhUX0lOSVRfQklU
LCAmY2UtPmZsYWdzKSkKKwkJcG9wdWxhdGVfbHJfY29udGV4dChjZSwgZW5naW5lLCAqdmFkZHIp
OworCisJcmV0dXJuIDA7Cit9CiAKLQlyZXR1cm4gUFRSX0VSUl9PUl9aRVJPKCp2YWRkcik7Citz
dGF0aWMgaW50CitleGVjbGlzdHNfY29udGV4dF9wcmVfcGluKHN0cnVjdCBpbnRlbF9jb250ZXh0
ICpjZSwKKwkJCSAgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqd3csIHZvaWQgKip2YWRkcikKK3sK
KwlyZXR1cm4gX19leGVjbGlzdHNfY29udGV4dF9wcmVfcGluKGNlLCBjZS0+ZW5naW5lLCB3dywg
dmFkZHIpOwogfQogCiBzdGF0aWMgaW50CkBAIC00NjEwLDQ1ICs0NjUyLDYgQEAgc3RhdGljIHZv
aWQgZXhlY2xpc3RzX2luaXRfcmVnX3N0YXRlKHUzMiAqcmVncywKIAlfX3Jlc2V0X3N0b3Bfcmlu
ZyhyZWdzLCBlbmdpbmUpOwogfQogCi1zdGF0aWMgaW50Ci1wb3B1bGF0ZV9scl9jb250ZXh0KHN0
cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKLQkJICAgIHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpjdHhfb2JqLAotCQkgICAgc3RydWN0IGludGVsX2VuZ2luZV9jcyAqZW5naW5lLAotCQkgICAg
c3RydWN0IGludGVsX3JpbmcgKnJpbmcpCi17Ci0JYm9vbCBpbmhpYml0ID0gdHJ1ZTsKLQl2b2lk
ICp2YWRkcjsKLQotCXZhZGRyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9tYXAoY3R4X29iaiwgSTkx
NV9NQVBfV0IpOwotCWlmIChJU19FUlIodmFkZHIpKSB7Ci0JCWRybV9kYmcoJmVuZ2luZS0+aTkx
NS0+ZHJtLCAiQ291bGQgbm90IG1hcCBvYmplY3QgcGFnZXMhXG4iKTsKLQkJcmV0dXJuIFBUUl9F
UlIodmFkZHIpOwotCX0KLQotCXNldF9yZWR6b25lKHZhZGRyLCBlbmdpbmUpOwotCi0JaWYgKGVu
Z2luZS0+ZGVmYXVsdF9zdGF0ZSkgewotCQlzaG1lbV9yZWFkKGVuZ2luZS0+ZGVmYXVsdF9zdGF0
ZSwgMCwKLQkJCSAgIHZhZGRyLCBlbmdpbmUtPmNvbnRleHRfc2l6ZSk7Ci0JCV9fc2V0X2JpdChD
T05URVhUX1ZBTElEX0JJVCwgJmNlLT5mbGFncyk7Ci0JCWluaGliaXQgPSBmYWxzZTsKLQl9Ci0K
LQkvKiBDbGVhciB0aGUgcHBIV1NQIChpbmMuIHBlci1jb250ZXh0IGNvdW50ZXJzKSAqLwotCW1l
bXNldCh2YWRkciwgMCwgUEFHRV9TSVpFKTsKLQotCS8qCi0JICogVGhlIHNlY29uZCBwYWdlIG9m
IHRoZSBjb250ZXh0IG9iamVjdCBjb250YWlucyBzb21lIHJlZ2lzdGVycyB3aGljaAotCSAqIG11
c3QgYmUgc2V0IHVwIHByaW9yIHRvIHRoZSBmaXJzdCBleGVjdXRpb24uCi0JICovCi0JZXhlY2xp
c3RzX2luaXRfcmVnX3N0YXRlKHZhZGRyICsgTFJDX1NUQVRFX09GRlNFVCwKLQkJCQkgY2UsIGVu
Z2luZSwgcmluZywgaW5oaWJpdCk7Ci0KLQlfX2k5MTVfZ2VtX29iamVjdF9mbHVzaF9tYXAoY3R4
X29iaiwgMCwgZW5naW5lLT5jb250ZXh0X3NpemUpOwotCWk5MTVfZ2VtX29iamVjdF91bnBpbl9t
YXAoY3R4X29iaik7Ci0JcmV0dXJuIDA7Ci19Ci0KIHN0YXRpYyBzdHJ1Y3QgaW50ZWxfdGltZWxp
bmUgKnBpbm5lZF90aW1lbGluZShzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UpCiB7CiAJc3RydWN0
IGludGVsX3RpbWVsaW5lICp0bCA9IGZldGNoX2FuZF96ZXJvKCZjZS0+dGltZWxpbmUpOwpAQCAt
NDcxMiwyMCArNDcxNSwxMSBAQCBzdGF0aWMgaW50IF9fZXhlY2xpc3RzX2NvbnRleHRfYWxsb2Mo
c3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCQlnb3RvIGVycm9yX2RlcmVmX29iajsKIAl9CiAK
LQlyZXQgPSBwb3B1bGF0ZV9scl9jb250ZXh0KGNlLCBjdHhfb2JqLCBlbmdpbmUsIHJpbmcpOwot
CWlmIChyZXQpIHsKLQkJZHJtX2RiZygmZW5naW5lLT5pOTE1LT5kcm0sCi0JCQkiRmFpbGVkIHRv
IHBvcHVsYXRlIExSQzogJWRcbiIsIHJldCk7Ci0JCWdvdG8gZXJyb3JfcmluZ19mcmVlOwotCX0K
LQogCWNlLT5yaW5nID0gcmluZzsKIAljZS0+c3RhdGUgPSB2bWE7CiAKIAlyZXR1cm4gMDsKIAot
ZXJyb3JfcmluZ19mcmVlOgotCWludGVsX3JpbmdfcHV0KHJpbmcpOwogZXJyb3JfZGVyZWZfb2Jq
OgogCWk5MTVfZ2VtX29iamVjdF9wdXQoY3R4X29iaik7CiAJcmV0dXJuIHJldDsKQEAgLTQ4NDks
NiArNDg0MywxNSBAQCBzdGF0aWMgaW50IHZpcnR1YWxfY29udGV4dF9hbGxvYyhzdHJ1Y3QgaW50
ZWxfY29udGV4dCAqY2UpCiAJcmV0dXJuIF9fZXhlY2xpc3RzX2NvbnRleHRfYWxsb2MoY2UsIHZl
LT5zaWJsaW5nc1swXSk7CiB9CiAKK3N0YXRpYyBpbnQKK3ZpcnR1YWxfY29udGV4dF9wcmVfcGlu
KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSwKKwkJCSAgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAq
d3csIHZvaWQgKip2YWRkcikKK3sKKwlzdHJ1Y3QgdmlydHVhbF9lbmdpbmUgKnZlID0gY29udGFp
bmVyX29mKGNlLCB0eXBlb2YoKnZlKSwgY29udGV4dCk7CisKKwlyZXR1cm4gX19leGVjbGlzdHNf
Y29udGV4dF9wcmVfcGluKGNlLCB2ZS0+c2libGluZ3NbMF0sIHd3LCB2YWRkcik7Cit9CisKIHN0
YXRpYyBpbnQgdmlydHVhbF9jb250ZXh0X3BpbihzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsIHZv
aWQgKnZhZGRyKQogewogCXN0cnVjdCB2aXJ0dWFsX2VuZ2luZSAqdmUgPSBjb250YWluZXJfb2Yo
Y2UsIHR5cGVvZigqdmUpLCBjb250ZXh0KTsKQEAgLTQ4ODIsNyArNDg4NSw3IEBAIHN0YXRpYyB2
b2lkIHZpcnR1YWxfY29udGV4dF9leGl0KHN0cnVjdCBpbnRlbF9jb250ZXh0ICpjZSkKIHN0YXRp
YyBjb25zdCBzdHJ1Y3QgaW50ZWxfY29udGV4dF9vcHMgdmlydHVhbF9jb250ZXh0X29wcyA9IHsK
IAkuYWxsb2MgPSB2aXJ0dWFsX2NvbnRleHRfYWxsb2MsCiAKLQkucHJlX3BpbiA9IGV4ZWNsaXN0
c19jb250ZXh0X3ByZV9waW4sCisJLnByZV9waW4gPSB2aXJ0dWFsX2NvbnRleHRfcHJlX3BpbiwK
IAkucGluID0gdmlydHVhbF9jb250ZXh0X3BpbiwKIAkudW5waW4gPSBleGVjbGlzdHNfY29udGV4
dF91bnBpbiwKIAkucG9zdF91bnBpbiA9IGV4ZWNsaXN0c19jb250ZXh0X3Bvc3RfdW5waW4sCi0t
IAoyLjI2LjIKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
CmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpo
dHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
