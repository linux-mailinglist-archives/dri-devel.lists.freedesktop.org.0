Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 16240819A2
	for <lists+dri-devel@lfdr.de>; Mon,  5 Aug 2019 14:43:43 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 173566E452;
	Mon,  5 Aug 2019 12:43:19 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id F3E436E442;
 Mon,  5 Aug 2019 12:43:16 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx08.intmail.prod.int.phx2.redhat.com
 [10.5.11.23])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 8C4C336955;
 Mon,  5 Aug 2019 12:43:16 +0000 (UTC)
Received: from sirius.home.kraxel.org (ovpn-116-81.ams2.redhat.com
 [10.36.116.81])
 by smtp.corp.redhat.com (Postfix) with ESMTP id E50E3194B9;
 Mon,  5 Aug 2019 12:43:15 +0000 (UTC)
Received: by sirius.home.kraxel.org (Postfix, from userid 1000)
 id 873C89DBE; Mon,  5 Aug 2019 14:43:12 +0200 (CEST)
From: Gerd Hoffmann <kraxel@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v5 07/18] drm/ttm: use gem reservation object
Date: Mon,  5 Aug 2019 14:42:59 +0200
Message-Id: <20190805124310.3275-8-kraxel@redhat.com>
In-Reply-To: <20190805124310.3275-1-kraxel@redhat.com>
References: <20190805124310.3275-1-kraxel@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.23
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.30]); Mon, 05 Aug 2019 12:43:16 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: thomas@shipmail.org, tzimmermann@suse.de, David Airlie <airlied@linux.ie>,
 ckoenig.leichtzumerken@gmail.com, intel-gfx@lists.freedesktop.org,
 open list <linux-kernel@vger.kernel.org>, Huang Rui <ray.huang@amd.com>,
 bskeggs@redhat.com, Christian Koenig <christian.koenig@amd.com>,
 Gerd Hoffmann <kraxel@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RHJvcCB0dG1fcmVzdiBmcm9tIHR0bV9idWZmZXJfb2JqZWN0LCB1c2UgdGhlIGdlbSByZXNlcnZh
dGlvbiBvYmplY3QKKGJhc2UuX3Jlc3YpIGluc3RlYWQuCgpTaWduZWQtb2ZmLWJ5OiBHZXJkIEhv
ZmZtYW5uIDxrcmF4ZWxAcmVkaGF0LmNvbT4KUmV2aWV3ZWQtYnk6IENocmlzdGlhbiBLw7ZuaWcg
PGNocmlzdGlhbi5rb2VuaWdAYW1kLmNvbT4KLS0tCiBpbmNsdWRlL2RybS90dG0vdHRtX2JvX2Fw
aS5oICAgICAgfCAgMSAtCiBkcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9iby5jICAgICAgfCAzOSAr
KysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9i
b191dGlsLmMgfCAgMiArLQogMyBmaWxlcyBjaGFuZ2VkLCAyNCBpbnNlcnRpb25zKCspLCAxOCBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9pbmNsdWRlL2RybS90dG0vdHRtX2JvX2FwaS5oIGIv
aW5jbHVkZS9kcm0vdHRtL3R0bV9ib19hcGkuaAppbmRleCAwODI1NTBjYWM5MmMuLmZhMDUwZjAz
MjhhYiAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vdHRtL3R0bV9ib19hcGkuaAorKysgYi9pbmNs
dWRlL2RybS90dG0vdHRtX2JvX2FwaS5oCkBAIC0yMzUsNyArMjM1LDYgQEAgc3RydWN0IHR0bV9i
dWZmZXJfb2JqZWN0IHsKIAlzdHJ1Y3Qgc2dfdGFibGUgKnNnOwogCiAJc3RydWN0IHJlc2VydmF0
aW9uX29iamVjdCAqcmVzdjsKLQlzdHJ1Y3QgcmVzZXJ2YXRpb25fb2JqZWN0IHR0bV9yZXN2Owog
CXN0cnVjdCBtdXRleCB3dV9tdXRleDsKIH07CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS90dG0vdHRtX2JvLmMgYi9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9iby5jCmluZGV4IDQwZDNl
NTQ3Yzc4ZS4uY2VmZjE1M2Y3ZTY4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0
bV9iby5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvLmMKQEAgLTE2MCw3ICsxNjAs
OCBAQCBzdGF0aWMgdm9pZCB0dG1fYm9fcmVsZWFzZV9saXN0KHN0cnVjdCBrcmVmICpsaXN0X2ty
ZWYpCiAJdHRtX3R0X2Rlc3Ryb3koYm8tPnR0bSk7CiAJYXRvbWljX2RlYygmYm8tPmJkZXYtPmds
b2ItPmJvX2NvdW50KTsKIAlkbWFfZmVuY2VfcHV0KGJvLT5tb3ZpbmcpOwotCXJlc2VydmF0aW9u
X29iamVjdF9maW5pKCZiby0+dHRtX3Jlc3YpOworCWlmICghdHRtX2JvX3VzZXNfZW1iZWRkZWRf
Z2VtX29iamVjdChibykpCisJCXJlc2VydmF0aW9uX29iamVjdF9maW5pKCZiby0+YmFzZS5fcmVz
dik7CiAJbXV0ZXhfZGVzdHJveSgmYm8tPnd1X211dGV4KTsKIAliby0+ZGVzdHJveShibyk7CiAJ
dHRtX21lbV9nbG9iYWxfZnJlZShiZGV2LT5nbG9iLT5tZW1fZ2xvYiwgYWNjX3NpemUpOwpAQCAt
NDM4LDE0ICs0MzksMTQgQEAgc3RhdGljIGludCB0dG1fYm9faW5kaXZpZHVhbGl6ZV9yZXN2KHN0
cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8pCiB7CiAJaW50IHI7CiAKLQlpZiAoYm8tPnJlc3Yg
PT0gJmJvLT50dG1fcmVzdikKKwlpZiAoYm8tPnJlc3YgPT0gJmJvLT5iYXNlLl9yZXN2KQogCQly
ZXR1cm4gMDsKIAotCUJVR19PTighcmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2soJmJvLT50dG1f
cmVzdikpOworCUJVR19PTighcmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2soJmJvLT5iYXNlLl9y
ZXN2KSk7CiAKLQlyID0gcmVzZXJ2YXRpb25fb2JqZWN0X2NvcHlfZmVuY2VzKCZiby0+dHRtX3Jl
c3YsIGJvLT5yZXN2KTsKKwlyID0gcmVzZXJ2YXRpb25fb2JqZWN0X2NvcHlfZmVuY2VzKCZiby0+
YmFzZS5fcmVzdiwgYm8tPnJlc3YpOwogCWlmIChyKQotCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5s
b2NrKCZiby0+dHRtX3Jlc3YpOworCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKCZiby0+YmFz
ZS5fcmVzdik7CiAKIAlyZXR1cm4gcjsKIH0KQEAgLTQ1Niw4ICs0NTcsOCBAQCBzdGF0aWMgdm9p
ZCB0dG1fYm9fZmx1c2hfYWxsX2ZlbmNlcyhzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvKQog
CXN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlOwogCWludCBpOwogCi0JZm9iaiA9IHJlc2VydmF0aW9u
X29iamVjdF9nZXRfbGlzdCgmYm8tPnR0bV9yZXN2KTsKLQlmZW5jZSA9IHJlc2VydmF0aW9uX29i
amVjdF9nZXRfZXhjbCgmYm8tPnR0bV9yZXN2KTsKKwlmb2JqID0gcmVzZXJ2YXRpb25fb2JqZWN0
X2dldF9saXN0KCZiby0+YmFzZS5fcmVzdik7CisJZmVuY2UgPSByZXNlcnZhdGlvbl9vYmplY3Rf
Z2V0X2V4Y2woJmJvLT5iYXNlLl9yZXN2KTsKIAlpZiAoZmVuY2UgJiYgIWZlbmNlLT5vcHMtPnNp
Z25hbGVkKQogCQlkbWFfZmVuY2VfZW5hYmxlX3N3X3NpZ25hbGluZyhmZW5jZSk7CiAKQEAgLTQ5
MCwxMSArNDkxLDExIEBAIHN0YXRpYyB2b2lkIHR0bV9ib19jbGVhbnVwX3JlZnNfb3JfcXVldWUo
c3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibykKIAlzcGluX2xvY2soJmdsb2ItPmxydV9sb2Nr
KTsKIAlyZXQgPSByZXNlcnZhdGlvbl9vYmplY3RfdHJ5bG9jayhiby0+cmVzdikgPyAwIDogLUVC
VVNZOwogCWlmICghcmV0KSB7Ci0JCWlmIChyZXNlcnZhdGlvbl9vYmplY3RfdGVzdF9zaWduYWxl
ZF9yY3UoJmJvLT50dG1fcmVzdiwgdHJ1ZSkpIHsKKwkJaWYgKHJlc2VydmF0aW9uX29iamVjdF90
ZXN0X3NpZ25hbGVkX3JjdSgmYm8tPmJhc2UuX3Jlc3YsIHRydWUpKSB7CiAJCQl0dG1fYm9fZGVs
X2Zyb21fbHJ1KGJvKTsKIAkJCXNwaW5fdW5sb2NrKCZnbG9iLT5scnVfbG9jayk7Ci0JCQlpZiAo
Ym8tPnJlc3YgIT0gJmJvLT50dG1fcmVzdikKLQkJCQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2Nr
KCZiby0+dHRtX3Jlc3YpOworCQkJaWYgKGJvLT5yZXN2ICE9ICZiby0+YmFzZS5fcmVzdikKKwkJ
CQlyZXNlcnZhdGlvbl9vYmplY3RfdW5sb2NrKCZiby0+YmFzZS5fcmVzdik7CiAKIAkJCXR0bV9i
b19jbGVhbnVwX21lbXR5cGVfdXNlKGJvKTsKIAkJCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2so
Ym8tPnJlc3YpOwpAQCAtNTE1LDggKzUxNiw4IEBAIHN0YXRpYyB2b2lkIHR0bV9ib19jbGVhbnVw
X3JlZnNfb3JfcXVldWUoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibykKIAogCQlyZXNlcnZh
dGlvbl9vYmplY3RfdW5sb2NrKGJvLT5yZXN2KTsKIAl9Ci0JaWYgKGJvLT5yZXN2ICE9ICZiby0+
dHRtX3Jlc3YpCi0JCXJlc2VydmF0aW9uX29iamVjdF91bmxvY2soJmJvLT50dG1fcmVzdik7CisJ
aWYgKGJvLT5yZXN2ICE9ICZiby0+YmFzZS5fcmVzdikKKwkJcmVzZXJ2YXRpb25fb2JqZWN0X3Vu
bG9jaygmYm8tPmJhc2UuX3Jlc3YpOwogCiBlcnJvcjoKIAlrcmVmX2dldCgmYm8tPmxpc3Rfa3Jl
Zik7CkBAIC01NTEsNyArNTUyLDcgQEAgc3RhdGljIGludCB0dG1fYm9fY2xlYW51cF9yZWZzKHN0
cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJaWYgKHVubGlrZWx5KGxpc3RfZW1wdHkoJmJv
LT5kZGVzdHJveSkpKQogCQlyZXN2ID0gYm8tPnJlc3Y7CiAJZWxzZQotCQlyZXN2ID0gJmJvLT50
dG1fcmVzdjsKKwkJcmVzdiA9ICZiby0+YmFzZS5fcmVzdjsKIAogCWlmIChyZXNlcnZhdGlvbl9v
YmplY3RfdGVzdF9zaWduYWxlZF9yY3UocmVzdiwgdHJ1ZSkpCiAJCXJldCA9IDA7CkBAIC02MzEs
NyArNjMyLDcgQEAgc3RhdGljIGJvb2wgdHRtX2JvX2RlbGF5ZWRfZGVsZXRlKHN0cnVjdCB0dG1f
Ym9fZGV2aWNlICpiZGV2LCBib29sIHJlbW92ZV9hbGwpCiAJCWtyZWZfZ2V0KCZiby0+bGlzdF9r
cmVmKTsKIAkJbGlzdF9tb3ZlX3RhaWwoJmJvLT5kZGVzdHJveSwgJnJlbW92ZWQpOwogCi0JCWlm
IChyZW1vdmVfYWxsIHx8IGJvLT5yZXN2ICE9ICZiby0+dHRtX3Jlc3YpIHsKKwkJaWYgKHJlbW92
ZV9hbGwgfHwgYm8tPnJlc3YgIT0gJmJvLT5iYXNlLl9yZXN2KSB7CiAJCQlzcGluX3VubG9jaygm
Z2xvYi0+bHJ1X2xvY2spOwogCQkJcmVzZXJ2YXRpb25fb2JqZWN0X2xvY2soYm8tPnJlc3YsIE5V
TEwpOwogCkBAIC0xMzM0LDkgKzEzMzUsMTUgQEAgaW50IHR0bV9ib19pbml0X3Jlc2VydmVkKHN0
cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAogCQliby0+cmVzdiA9IHJlc3Y7CiAJCXJlc2VydmF0
aW9uX29iamVjdF9hc3NlcnRfaGVsZChiby0+cmVzdik7CiAJfSBlbHNlIHsKLQkJYm8tPnJlc3Yg
PSAmYm8tPnR0bV9yZXN2OworCQliby0+cmVzdiA9ICZiby0+YmFzZS5fcmVzdjsKKwl9CisJaWYg
KCF0dG1fYm9fdXNlc19lbWJlZGRlZF9nZW1fb2JqZWN0KGJvKSkgeworCQkvKgorCQkgKiBiby5n
ZW0gaXMgbm90IGluaXRpYWxpemVkLCBzbyB3ZSBoYXZlIHRvIHNldHVwIHRoZQorCQkgKiBzdHJ1
Y3QgZWxlbWVudHMgd2Ugd2FudCB1c2UgcmVnYXJkbGVzcy4KKwkJICovCisJCXJlc2VydmF0aW9u
X29iamVjdF9pbml0KCZiby0+YmFzZS5fcmVzdik7CiAJfQotCXJlc2VydmF0aW9uX29iamVjdF9p
bml0KCZiby0+dHRtX3Jlc3YpOwogCWF0b21pY19pbmMoJmJvLT5iZGV2LT5nbG9iLT5ib19jb3Vu
dCk7CiAJZHJtX3ZtYV9ub2RlX3Jlc2V0KCZiby0+dm1hX25vZGUpOwogCmRpZmYgLS1naXQgYS9k
cml2ZXJzL2dwdS9kcm0vdHRtL3R0bV9ib191dGlsLmMgYi9kcml2ZXJzL2dwdS9kcm0vdHRtL3R0
bV9ib191dGlsLmMKaW5kZXggOWY5MThiOTkyZjdlLi4wNWZiY2FmNmEzZjIgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvX3V0aWwuYworKysgYi9kcml2ZXJzL2dwdS9kcm0v
dHRtL3R0bV9ib191dGlsLmMKQEAgLTUxNyw3ICs1MTcsNyBAQCBzdGF0aWMgaW50IHR0bV9idWZm
ZXJfb2JqZWN0X3RyYW5zZmVyKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJa3JlZl9p
bml0KCZmYm8tPmJhc2Uua3JlZik7CiAJZmJvLT5iYXNlLmRlc3Ryb3kgPSAmdHRtX3RyYW5zZmVy
ZWRfZGVzdHJveTsKIAlmYm8tPmJhc2UuYWNjX3NpemUgPSAwOwotCWZiby0+YmFzZS5yZXN2ID0g
JmZiby0+YmFzZS50dG1fcmVzdjsKKwlmYm8tPmJhc2UucmVzdiA9ICZmYm8tPmJhc2UuYmFzZS5f
cmVzdjsKIAlyZXNlcnZhdGlvbl9vYmplY3RfaW5pdChmYm8tPmJhc2UucmVzdik7CiAJcmV0ID0g
cmVzZXJ2YXRpb25fb2JqZWN0X3RyeWxvY2soZmJvLT5iYXNlLnJlc3YpOwogCVdBUk5fT04oIXJl
dCk7Ci0tIAoyLjE4LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9w
Lm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1k
ZXZlbA==
