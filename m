Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 56E3F49CFA
	for <lists+dri-devel@lfdr.de>; Tue, 18 Jun 2019 11:20:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3A11F6E122;
	Tue, 18 Jun 2019 09:20:51 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-ed1-x543.google.com (mail-ed1-x543.google.com
 [IPv6:2a00:1450:4864:20::543])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 734E96E122
 for <dri-devel@lists.freedesktop.org>; Tue, 18 Jun 2019 09:20:49 +0000 (UTC)
Received: by mail-ed1-x543.google.com with SMTP id z25so20622943edq.9
 for <dri-devel@lists.freedesktop.org>; Tue, 18 Jun 2019 02:20:49 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=OE5DfO9i4fWqQbByvhYYVhTzhOMH8+nsqL24gWjvvDg=;
 b=HLh71BNe64KjrlzmeETvSC2z5dHqAYR1mehZk/hoYEKt3d61smBvovKids/lMoCJR2
 oHFkzbcXtpqn7sbcSxjsY/BEfuRTIP3OwwlFqqNvokSQ8wKnT9dVxsuwQfFzf7+0WbYW
 PdQyHEaGxvE29Xl6s7YpevaT+q2YFDLPnxYY4qqqMePi4FQ1GjlyZblWZwa/Z0o1ixEw
 xfWjwkQzudG7GwoMA01Q2YTkCn6YyLSYmtI12zDcL5+654NPfwiJjngRmmIXGhNZAS2O
 6PrVmbVEvIqt4G+QT1C5z89FHI2NfwLN1VbKeTnEufJfTXyJpT3W587uNnQC7kIbnaTE
 T6Yw==
X-Gm-Message-State: APjAAAUrs1qo10RKhyjo7rKRNZzDHiz9dYbLdYdpRSmzYqCMIcYem3Vt
 nVvg2QRDRuLHjmgEcXJxxYMEBz0d968=
X-Google-Smtp-Source: APXvYqyQKYDcwHDNdmMfToz+Ej5Acdh8h80Y4hF1tzmYu8w0BJiRUM9YoiyFS+eNiANNXfxD4vPImg==
X-Received: by 2002:a17:906:69c4:: with SMTP id
 g4mr12033568ejs.9.1560849647697; 
 Tue, 18 Jun 2019 02:20:47 -0700 (PDT)
Received: from phenom.ffwll.local ([2a02:168:569e:0:3106:d637:d723:e855])
 by smtp.gmail.com with ESMTPSA id s5sm711323ejk.36.2019.06.18.02.20.46
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Tue, 18 Jun 2019 02:20:46 -0700 (PDT)
From: Daniel Vetter <daniel.vetter@ffwll.ch>
To: DRI Development <dri-devel@lists.freedesktop.org>
Subject: [PATCH 1/2] drm/prime: Shuffle functions.
Date: Tue, 18 Jun 2019 11:20:37 +0200
Message-Id: <20190618092038.17929-1-daniel.vetter@ffwll.ch>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190614203615.12639-4-daniel.vetter@ffwll.ch>
References: <20190614203615.12639-4-daniel.vetter@ffwll.ch>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ffwll.ch; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=OE5DfO9i4fWqQbByvhYYVhTzhOMH8+nsqL24gWjvvDg=;
 b=AwBgAy+vhFeaCscO/PKvv7UA4UsLSdv05/fxsALTfoNczXa1pqoWUWua7qAviNZgsB
 bgSXSf6t6Cx4Ho5t1KQwux8778/w5TPw9QJNehCoalibRq6Z+sIifd7RrL1PrcgxCf7a
 YQLs9f7/TuGEZqmpGJFIspOKit7lY5iButOL0=
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>,
 Intel Graphics Development <intel-gfx@lists.freedesktop.org>,
 Emil Velikov <emil.l.velikov@gmail.com>,
 Daniel Vetter <daniel.vetter@intel.com>, Sam Ravnborg <sam@ravnborg.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

UmVvcmRlciBhbGwgdGhlIGZ1bmN0aW9ucyBpbiBkcm1fcHJpbWUuW2hjXSBpbnRvIHRocmVlIGdy
b3VwczogY29yZSwKZXhwb3J0IGhlbHBlcnMsIGltcG9ydCBoZWxwZXJzLgoKTm90IG90aGVyIGNo
YW5nZXMgYmV5b25kIG1vdmluZyB0aGUgZnVuY3Rpb25zIGFuZCB0aGVpciB1bmNoYW5nZWQKa2Vy
bmVsZG9jIGFyb3VuZCBpbiBoZXJlLgoKQ2M6IFNhbSBSYXZuYm9yZyA8c2FtQHJhdm5ib3JnLm9y
Zz4KQ2M6IEVyaWMgQW5ob2x0IDxlcmljQGFuaG9sdC5uZXQ+CkNjOiBFbWlsIFZlbGlrb3YgPGVt
aWwubC52ZWxpa292QGdtYWlsLmNvbT4KU2lnbmVkLW9mZi1ieTogRGFuaWVsIFZldHRlciA8ZGFu
aWVsLnZldHRlckBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2RybV9wcmltZS5jIHwg
NzcwICsrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tLQogaW5jbHVkZS9kcm0vZHJt
X3ByaW1lLmggICAgIHwgIDQyICstCiAyIGZpbGVzIGNoYW5nZWQsIDQwOSBpbnNlcnRpb25zKCsp
LCA0MDMgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2RybV9wcmlt
ZS5jIGIvZHJpdmVycy9ncHUvZHJtL2RybV9wcmltZS5jCmluZGV4IGQwYzAxMzE4MDc2Yi4uNjhi
NGRlODUzNzBjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vZHJtX3ByaW1lLmMKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL2RybV9wcmltZS5jCkBAIC0xODEsNDIgKzE4MSw2IEBAIHN0YXRpYyBp
bnQgZHJtX3ByaW1lX2xvb2t1cF9idWZfaGFuZGxlKHN0cnVjdCBkcm1fcHJpbWVfZmlsZV9wcml2
YXRlICpwcmltZV9mcHJpCiAJcmV0dXJuIC1FTk9FTlQ7CiB9CiAKLS8qKgotICogZHJtX2dlbV9t
YXBfYXR0YWNoIC0gZG1hX2J1ZiBhdHRhY2ggaW1wbGVtZW50YXRpb24gZm9yIEdFTQotICogQGRt
YV9idWY6IGJ1ZmZlciB0byBhdHRhY2ggZGV2aWNlIHRvCi0gKiBAYXR0YWNoOiBidWZmZXIgYXR0
YWNobWVudCBkYXRhCi0gKgotICogQ2FsbHMgJmRybV9kcml2ZXIuZ2VtX3ByaW1lX3BpbiBmb3Ig
ZGV2aWNlIHNwZWNpZmljIGhhbmRsaW5nLiBUaGlzIGNhbiBiZQotICogdXNlZCBhcyB0aGUgJmRt
YV9idWZfb3BzLmF0dGFjaCBjYWxsYmFjay4KLSAqCi0gKiBSZXR1cm5zIDAgb24gc3VjY2Vzcywg
bmVnYXRpdmUgZXJyb3IgY29kZSBvbiBmYWlsdXJlLgotICovCi1pbnQgZHJtX2dlbV9tYXBfYXR0
YWNoKHN0cnVjdCBkbWFfYnVmICpkbWFfYnVmLAotCQkgICAgICAgc3RydWN0IGRtYV9idWZfYXR0
YWNobWVudCAqYXR0YWNoKQotewotCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqID0gZG1hX2J1
Zi0+cHJpdjsKLQotCXJldHVybiBkcm1fZ2VtX3BpbihvYmopOwotfQotRVhQT1JUX1NZTUJPTChk
cm1fZ2VtX21hcF9hdHRhY2gpOwotCi0vKioKLSAqIGRybV9nZW1fbWFwX2RldGFjaCAtIGRtYV9i
dWYgZGV0YWNoIGltcGxlbWVudGF0aW9uIGZvciBHRU0KLSAqIEBkbWFfYnVmOiBidWZmZXIgdG8g
ZGV0YWNoIGZyb20KLSAqIEBhdHRhY2g6IGF0dGFjaG1lbnQgdG8gYmUgZGV0YWNoZWQKLSAqCi0g
KiBDbGVhbnMgdXAgJmRtYV9idWZfYXR0YWNobWVudC4gVGhpcyBjYW4gYmUgdXNlZCBhcyB0aGUg
JmRtYV9idWZfb3BzLmRldGFjaAotICogY2FsbGJhY2suCi0gKi8KLXZvaWQgZHJtX2dlbV9tYXBf
ZGV0YWNoKHN0cnVjdCBkbWFfYnVmICpkbWFfYnVmLAotCQkJc3RydWN0IGRtYV9idWZfYXR0YWNo
bWVudCAqYXR0YWNoKQotewotCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqID0gZG1hX2J1Zi0+
cHJpdjsKLQotCWRybV9nZW1fdW5waW4ob2JqKTsKLX0KLUVYUE9SVF9TWU1CT0woZHJtX2dlbV9t
YXBfZGV0YWNoKTsKLQogdm9pZCBkcm1fcHJpbWVfcmVtb3ZlX2J1Zl9oYW5kbGVfbG9ja2VkKHN0
cnVjdCBkcm1fcHJpbWVfZmlsZV9wcml2YXRlICpwcmltZV9mcHJpdiwKIAkJCQkJc3RydWN0IGRt
YV9idWYgKmRtYV9idWYpCiB7CkBAIC0yNDIsNjQgKzIwNiwxOCBAQCB2b2lkIGRybV9wcmltZV9y
ZW1vdmVfYnVmX2hhbmRsZV9sb2NrZWQoc3RydWN0IGRybV9wcmltZV9maWxlX3ByaXZhdGUgKnBy
aW1lX2ZwcgogCX0KIH0KIAotLyoqCi0gKiBkcm1fZ2VtX21hcF9kbWFfYnVmIC0gbWFwX2RtYV9i
dWYgaW1wbGVtZW50YXRpb24gZm9yIEdFTQotICogQGF0dGFjaDogYXR0YWNobWVudCB3aG9zZSBz
Y2F0dGVybGlzdCBpcyB0byBiZSByZXR1cm5lZAotICogQGRpcjogZGlyZWN0aW9uIG9mIERNQSB0
cmFuc2ZlcgotICoKLSAqIENhbGxzICZkcm1fZHJpdmVyLmdlbV9wcmltZV9nZXRfc2dfdGFibGUg
YW5kIHRoZW4gbWFwcyB0aGUgc2NhdHRlcmxpc3QuIFRoaXMKLSAqIGNhbiBiZSB1c2VkIGFzIHRo
ZSAmZG1hX2J1Zl9vcHMubWFwX2RtYV9idWYgY2FsbGJhY2suCi0gKgotICogUmV0dXJucyBzZ190
YWJsZSBjb250YWluaW5nIHRoZSBzY2F0dGVybGlzdCB0byBiZSByZXR1cm5lZDsgcmV0dXJucyBF
UlJfUFRSCi0gKiBvbiBlcnJvci4gTWF5IHJldHVybiAtRUlOVFIgaWYgaXQgaXMgaW50ZXJydXB0
ZWQgYnkgYSBzaWduYWwuCi0gKi8KLQotc3RydWN0IHNnX3RhYmxlICpkcm1fZ2VtX21hcF9kbWFf
YnVmKHN0cnVjdCBkbWFfYnVmX2F0dGFjaG1lbnQgKmF0dGFjaCwKLQkJCQkgICAgIGVudW0gZG1h
X2RhdGFfZGlyZWN0aW9uIGRpcikKK3ZvaWQgZHJtX3ByaW1lX2luaXRfZmlsZV9wcml2YXRlKHN0
cnVjdCBkcm1fcHJpbWVfZmlsZV9wcml2YXRlICpwcmltZV9mcHJpdikKIHsKLQlzdHJ1Y3QgZHJt
X2dlbV9vYmplY3QgKm9iaiA9IGF0dGFjaC0+ZG1hYnVmLT5wcml2OwotCXN0cnVjdCBzZ190YWJs
ZSAqc2d0OwotCi0JaWYgKFdBUk5fT04oZGlyID09IERNQV9OT05FKSkKLQkJcmV0dXJuIEVSUl9Q
VFIoLUVJTlZBTCk7Ci0KLQlpZiAob2JqLT5mdW5jcykKLQkJc2d0ID0gb2JqLT5mdW5jcy0+Z2V0
X3NnX3RhYmxlKG9iaik7Ci0JZWxzZQotCQlzZ3QgPSBvYmotPmRldi0+ZHJpdmVyLT5nZW1fcHJp
bWVfZ2V0X3NnX3RhYmxlKG9iaik7Ci0KLQlpZiAoIWRtYV9tYXBfc2dfYXR0cnMoYXR0YWNoLT5k
ZXYsIHNndC0+c2dsLCBzZ3QtPm5lbnRzLCBkaXIsCi0JCQkgICAgICBETUFfQVRUUl9TS0lQX0NQ
VV9TWU5DKSkgewotCQlzZ19mcmVlX3RhYmxlKHNndCk7Ci0JCWtmcmVlKHNndCk7Ci0JCXNndCA9
IEVSUl9QVFIoLUVOT01FTSk7Ci0JfQotCi0JcmV0dXJuIHNndDsKKwltdXRleF9pbml0KCZwcmlt
ZV9mcHJpdi0+bG9jayk7CisJcHJpbWVfZnByaXYtPmRtYWJ1ZnMgPSBSQl9ST09UOworCXByaW1l
X2Zwcml2LT5oYW5kbGVzID0gUkJfUk9PVDsKIH0KLUVYUE9SVF9TWU1CT0woZHJtX2dlbV9tYXBf
ZG1hX2J1Zik7CiAKLS8qKgotICogZHJtX2dlbV91bm1hcF9kbWFfYnVmIC0gdW5tYXBfZG1hX2J1
ZiBpbXBsZW1lbnRhdGlvbiBmb3IgR0VNCi0gKiBAYXR0YWNoOiBhdHRhY2htZW50IHRvIHVubWFw
IGJ1ZmZlciBmcm9tCi0gKiBAc2d0OiBzY2F0dGVybGlzdCBpbmZvIG9mIHRoZSBidWZmZXIgdG8g
dW5tYXAKLSAqIEBkaXI6IGRpcmVjdGlvbiBvZiBETUEgdHJhbnNmZXIKLSAqCi0gKiBUaGlzIGNh
biBiZSB1c2VkIGFzIHRoZSAmZG1hX2J1Zl9vcHMudW5tYXBfZG1hX2J1ZiBjYWxsYmFjay4KLSAq
Lwotdm9pZCBkcm1fZ2VtX3VubWFwX2RtYV9idWYoc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAq
YXR0YWNoLAotCQkJICAgc3RydWN0IHNnX3RhYmxlICpzZ3QsCi0JCQkgICBlbnVtIGRtYV9kYXRh
X2RpcmVjdGlvbiBkaXIpCit2b2lkIGRybV9wcmltZV9kZXN0cm95X2ZpbGVfcHJpdmF0ZShzdHJ1
Y3QgZHJtX3ByaW1lX2ZpbGVfcHJpdmF0ZSAqcHJpbWVfZnByaXYpCiB7Ci0JaWYgKCFzZ3QpCi0J
CXJldHVybjsKLQotCWRtYV91bm1hcF9zZ19hdHRycyhhdHRhY2gtPmRldiwgc2d0LT5zZ2wsIHNn
dC0+bmVudHMsIGRpciwKLQkJCSAgIERNQV9BVFRSX1NLSVBfQ1BVX1NZTkMpOwotCXNnX2ZyZWVf
dGFibGUoc2d0KTsKLQlrZnJlZShzZ3QpOworCS8qIGJ5IG5vdyBkcm1fZ2VtX3JlbGVhc2Ugc2hv
dWxkJ3ZlIG1hZGUgc3VyZSB0aGUgbGlzdCBpcyBlbXB0eSAqLworCVdBUk5fT04oIVJCX0VNUFRZ
X1JPT1QoJnByaW1lX2Zwcml2LT5kbWFidWZzKSk7CiB9Ci1FWFBPUlRfU1lNQk9MKGRybV9nZW1f
dW5tYXBfZG1hX2J1Zik7CiAKIC8qKgogICogZHJtX2dlbV9kbWFidWZfZXhwb3J0IC0gZG1hX2J1
ZiBleHBvcnQgaW1wbGVtZW50YXRpb24gZm9yIEdFTQpAQCAtMzUxLDEyOCArMjY5LDEwMSBAQCB2
b2lkIGRybV9nZW1fZG1hYnVmX3JlbGVhc2Uoc3RydWN0IGRtYV9idWYgKmRtYV9idWYpCiBFWFBP
UlRfU1lNQk9MKGRybV9nZW1fZG1hYnVmX3JlbGVhc2UpOwogCiAvKioKLSAqIGRybV9nZW1fZG1h
YnVmX3ZtYXAgLSBkbWFfYnVmIHZtYXAgaW1wbGVtZW50YXRpb24gZm9yIEdFTQotICogQGRtYV9i
dWY6IGJ1ZmZlciB0byBiZSBtYXBwZWQKLSAqCi0gKiBTZXRzIHVwIGEga2VybmVsIHZpcnR1YWwg
bWFwcGluZy4gVGhpcyBjYW4gYmUgdXNlZCBhcyB0aGUgJmRtYV9idWZfb3BzLnZtYXAKLSAqIGNh
bGxiYWNrLgorICogZHJtX2dlbV9wcmltZV9mZF90b19oYW5kbGUgLSBQUklNRSBpbXBvcnQgZnVu
Y3Rpb24gZm9yIEdFTSBkcml2ZXJzCisgKiBAZGV2OiBkZXYgdG8gZXhwb3J0IHRoZSBidWZmZXIg
ZnJvbQorICogQGZpbGVfcHJpdjogZHJtIGZpbGUtcHJpdmF0ZSBzdHJ1Y3R1cmUKKyAqIEBwcmlt
ZV9mZDogZmQgaWQgb2YgdGhlIGRtYS1idWYgd2hpY2ggc2hvdWxkIGJlIGltcG9ydGVkCisgKiBA
aGFuZGxlOiBwb2ludGVyIHRvIHN0b3JhZ2UgZm9yIHRoZSBoYW5kbGUgb2YgdGhlIGltcG9ydGVk
IGJ1ZmZlciBvYmplY3QKICAqCi0gKiBSZXR1cm5zIHRoZSBrZXJuZWwgdmlydHVhbCBhZGRyZXNz
LgorICogVGhpcyBpcyB0aGUgUFJJTUUgaW1wb3J0IGZ1bmN0aW9uIHdoaWNoIG11c3QgYmUgdXNl
ZCBtYW5kYXRvcmlseSBieSBHRU0KKyAqIGRyaXZlcnMgdG8gZW5zdXJlIGNvcnJlY3QgbGlmZXRp
bWUgbWFuYWdlbWVudCBvZiB0aGUgdW5kZXJseWluZyBHRU0gb2JqZWN0LgorICogVGhlIGFjdHVh
bCBpbXBvcnRpbmcgb2YgR0VNIG9iamVjdCBmcm9tIHRoZSBkbWEtYnVmIGlzIGRvbmUgdGhyb3Vn
aCB0aGUKKyAqIGdlbV9pbXBvcnRfZXhwb3J0IGRyaXZlciBjYWxsYmFjay4KICAqLwotdm9pZCAq
ZHJtX2dlbV9kbWFidWZfdm1hcChzdHJ1Y3QgZG1hX2J1ZiAqZG1hX2J1ZikKK2ludCBkcm1fZ2Vt
X3ByaW1lX2ZkX3RvX2hhbmRsZShzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAorCQkJICAgICAgIHN0
cnVjdCBkcm1fZmlsZSAqZmlsZV9wcml2LCBpbnQgcHJpbWVfZmQsCisJCQkgICAgICAgdWludDMy
X3QgKmhhbmRsZSkKIHsKLQlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiA9IGRtYV9idWYtPnBy
aXY7Ci0Jdm9pZCAqdmFkZHI7CisJc3RydWN0IGRtYV9idWYgKmRtYV9idWY7CisJc3RydWN0IGRy
bV9nZW1fb2JqZWN0ICpvYmo7CisJaW50IHJldDsKIAotCXZhZGRyID0gZHJtX2dlbV92bWFwKG9i
aik7Ci0JaWYgKElTX0VSUih2YWRkcikpCi0JCXZhZGRyID0gTlVMTDsKKwlkbWFfYnVmID0gZG1h
X2J1Zl9nZXQocHJpbWVfZmQpOworCWlmIChJU19FUlIoZG1hX2J1ZikpCisJCXJldHVybiBQVFJf
RVJSKGRtYV9idWYpOwogCi0JcmV0dXJuIHZhZGRyOwotfQotRVhQT1JUX1NZTUJPTChkcm1fZ2Vt
X2RtYWJ1Zl92bWFwKTsKKwltdXRleF9sb2NrKCZmaWxlX3ByaXYtPnByaW1lLmxvY2spOwogCi0v
KioKLSAqIGRybV9nZW1fZG1hYnVmX3Z1bm1hcCAtIGRtYV9idWYgdnVubWFwIGltcGxlbWVudGF0
aW9uIGZvciBHRU0KLSAqIEBkbWFfYnVmOiBidWZmZXIgdG8gYmUgdW5tYXBwZWQKLSAqIEB2YWRk
cjogdGhlIHZpcnR1YWwgYWRkcmVzcyBvZiB0aGUgYnVmZmVyCi0gKgotICogUmVsZWFzZXMgYSBr
ZXJuZWwgdmlydHVhbCBtYXBwaW5nLiBUaGlzIGNhbiBiZSB1c2VkIGFzIHRoZQotICogJmRtYV9i
dWZfb3BzLnZ1bm1hcCBjYWxsYmFjay4KLSAqLwotdm9pZCBkcm1fZ2VtX2RtYWJ1Zl92dW5tYXAo
c3RydWN0IGRtYV9idWYgKmRtYV9idWYsIHZvaWQgKnZhZGRyKQotewotCXN0cnVjdCBkcm1fZ2Vt
X29iamVjdCAqb2JqID0gZG1hX2J1Zi0+cHJpdjsKKwlyZXQgPSBkcm1fcHJpbWVfbG9va3VwX2J1
Zl9oYW5kbGUoJmZpbGVfcHJpdi0+cHJpbWUsCisJCQlkbWFfYnVmLCBoYW5kbGUpOworCWlmIChy
ZXQgPT0gMCkKKwkJZ290byBvdXRfcHV0OwogCi0JZHJtX2dlbV92dW5tYXAob2JqLCB2YWRkcik7
Ci19Ci1FWFBPUlRfU1lNQk9MKGRybV9nZW1fZG1hYnVmX3Z1bm1hcCk7CisJLyogbmV2ZXIgc2Vl
biB0aGlzIG9uZSwgbmVlZCB0byBpbXBvcnQgKi8KKwltdXRleF9sb2NrKCZkZXYtPm9iamVjdF9u
YW1lX2xvY2spOworCWlmIChkZXYtPmRyaXZlci0+Z2VtX3ByaW1lX2ltcG9ydCkKKwkJb2JqID0g
ZGV2LT5kcml2ZXItPmdlbV9wcmltZV9pbXBvcnQoZGV2LCBkbWFfYnVmKTsKKwllbHNlCisJCW9i
aiA9IGRybV9nZW1fcHJpbWVfaW1wb3J0KGRldiwgZG1hX2J1Zik7CisJaWYgKElTX0VSUihvYmop
KSB7CisJCXJldCA9IFBUUl9FUlIob2JqKTsKKwkJZ290byBvdXRfdW5sb2NrOworCX0KIAotLyoq
Ci0gKiBkcm1fZ2VtX2RtYWJ1Zl9tbWFwIC0gZG1hX2J1ZiBtbWFwIGltcGxlbWVudGF0aW9uIGZv
ciBHRU0KLSAqIEBkbWFfYnVmOiBidWZmZXIgdG8gYmUgbWFwcGVkCi0gKiBAdm1hOiB2aXJ0dWFs
IGFkZHJlc3MgcmFuZ2UKLSAqCi0gKiBQcm92aWRlcyBtZW1vcnkgbWFwcGluZyBmb3IgdGhlIGJ1
ZmZlci4gVGhpcyBjYW4gYmUgdXNlZCBhcyB0aGUKLSAqICZkbWFfYnVmX29wcy5tbWFwIGNhbGxi
YWNrLgotICoKLSAqIFJldHVybnMgMCBvbiBzdWNjZXNzIG9yIGEgbmVnYXRpdmUgZXJyb3IgY29k
ZSBvbiBmYWlsdXJlLgotICovCi1pbnQgZHJtX2dlbV9kbWFidWZfbW1hcChzdHJ1Y3QgZG1hX2J1
ZiAqZG1hX2J1Ziwgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpCi17Ci0Jc3RydWN0IGRybV9n
ZW1fb2JqZWN0ICpvYmogPSBkbWFfYnVmLT5wcml2OwotCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYg
PSBvYmotPmRldjsKKwlpZiAob2JqLT5kbWFfYnVmKSB7CisJCVdBUk5fT04ob2JqLT5kbWFfYnVm
ICE9IGRtYV9idWYpOworCX0gZWxzZSB7CisJCW9iai0+ZG1hX2J1ZiA9IGRtYV9idWY7CisJCWdl
dF9kbWFfYnVmKGRtYV9idWYpOworCX0KIAotCWlmICghZGV2LT5kcml2ZXItPmdlbV9wcmltZV9t
bWFwKQotCQlyZXR1cm4gLUVOT1NZUzsKKwkvKiBfaGFuZGxlX2NyZWF0ZV90YWlsIHVuY29uZGl0
aW9uYWxseSB1bmxvY2tzIGRldi0+b2JqZWN0X25hbWVfbG9jay4gKi8KKwlyZXQgPSBkcm1fZ2Vt
X2hhbmRsZV9jcmVhdGVfdGFpbChmaWxlX3ByaXYsIG9iaiwgaGFuZGxlKTsKKwlkcm1fZ2VtX29i
amVjdF9wdXRfdW5sb2NrZWQob2JqKTsKKwlpZiAocmV0KQorCQlnb3RvIG91dF9wdXQ7CiAKLQly
ZXR1cm4gZGV2LT5kcml2ZXItPmdlbV9wcmltZV9tbWFwKG9iaiwgdm1hKTsKLX0KLUVYUE9SVF9T
WU1CT0woZHJtX2dlbV9kbWFidWZfbW1hcCk7CisJcmV0ID0gZHJtX3ByaW1lX2FkZF9idWZfaGFu
ZGxlKCZmaWxlX3ByaXYtPnByaW1lLAorCQkJZG1hX2J1ZiwgKmhhbmRsZSk7CisJbXV0ZXhfdW5s
b2NrKCZmaWxlX3ByaXYtPnByaW1lLmxvY2spOworCWlmIChyZXQpCisJCWdvdG8gZmFpbDsKIAot
c3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfYnVmX29wcyBkcm1fZ2VtX3ByaW1lX2RtYWJ1Zl9vcHMg
PSAgewotCS5jYWNoZV9zZ3RfbWFwcGluZyA9IHRydWUsCi0JLmF0dGFjaCA9IGRybV9nZW1fbWFw
X2F0dGFjaCwKLQkuZGV0YWNoID0gZHJtX2dlbV9tYXBfZGV0YWNoLAotCS5tYXBfZG1hX2J1ZiA9
IGRybV9nZW1fbWFwX2RtYV9idWYsCi0JLnVubWFwX2RtYV9idWYgPSBkcm1fZ2VtX3VubWFwX2Rt
YV9idWYsCi0JLnJlbGVhc2UgPSBkcm1fZ2VtX2RtYWJ1Zl9yZWxlYXNlLAotCS5tbWFwID0gZHJt
X2dlbV9kbWFidWZfbW1hcCwKLQkudm1hcCA9IGRybV9nZW1fZG1hYnVmX3ZtYXAsCi0JLnZ1bm1h
cCA9IGRybV9nZW1fZG1hYnVmX3Z1bm1hcCwKLX07CisJZG1hX2J1Zl9wdXQoZG1hX2J1Zik7CiAK
LS8qKgotICogRE9DOiBQUklNRSBIZWxwZXJzCi0gKgotICogRHJpdmVycyBjYW4gaW1wbGVtZW50
IEBnZW1fcHJpbWVfZXhwb3J0IGFuZCBAZ2VtX3ByaW1lX2ltcG9ydCBpbiB0ZXJtcyBvZgotICog
c2ltcGxlciBBUElzIGJ5IHVzaW5nIHRoZSBoZWxwZXIgZnVuY3Rpb25zIEBkcm1fZ2VtX3ByaW1l
X2V4cG9ydCBhbmQKLSAqIEBkcm1fZ2VtX3ByaW1lX2ltcG9ydC4gIFRoZXNlIGZ1bmN0aW9ucyBp
bXBsZW1lbnQgZG1hLWJ1ZiBzdXBwb3J0IGluIHRlcm1zIG9mCi0gKiBzaXggbG93ZXItbGV2ZWwg
ZHJpdmVyIGNhbGxiYWNrczoKLSAqCi0gKiBFeHBvcnQgY2FsbGJhY2tzOgotICoKLSAqICAqIEBn
ZW1fcHJpbWVfcGluIChvcHRpb25hbCk6IHByZXBhcmUgYSBHRU0gb2JqZWN0IGZvciBleHBvcnRp
bmcKLSAqICAqIEBnZW1fcHJpbWVfZ2V0X3NnX3RhYmxlOiBwcm92aWRlIGEgc2NhdHRlci9nYXRo
ZXIgdGFibGUgb2YgcGlubmVkIHBhZ2VzCi0gKiAgKiBAZ2VtX3ByaW1lX3ZtYXA6IHZtYXAgYSBi
dWZmZXIgZXhwb3J0ZWQgYnkgeW91ciBkcml2ZXIKLSAqICAqIEBnZW1fcHJpbWVfdnVubWFwOiB2
dW5tYXAgYSBidWZmZXIgZXhwb3J0ZWQgYnkgeW91ciBkcml2ZXIKLSAqICAqIEBnZW1fcHJpbWVf
bW1hcCAob3B0aW9uYWwpOiBtbWFwIGEgYnVmZmVyIGV4cG9ydGVkIGJ5IHlvdXIgZHJpdmVyCi0g
KgotICogSW1wb3J0IGNhbGxiYWNrOgotICoKLSAqICAqIEBnZW1fcHJpbWVfaW1wb3J0X3NnX3Rh
YmxlIChpbXBvcnQpOiBwcm9kdWNlIGEgR0VNIG9iamVjdCBmcm9tIGFub3RoZXIKLSAqICAgIGRy
aXZlcidzIHNjYXR0ZXIvZ2F0aGVyIHRhYmxlCi0gKi8KKwlyZXR1cm4gMDsKIAotLyoqCi0gKiBk
cm1fZ2VtX3ByaW1lX2V4cG9ydCAtIGhlbHBlciBsaWJyYXJ5IGltcGxlbWVudGF0aW9uIG9mIHRo
ZSBleHBvcnQgY2FsbGJhY2sKLSAqIEBkZXY6IGRybV9kZXZpY2UgdG8gZXhwb3J0IGZyb20KLSAq
IEBvYmo6IEdFTSBvYmplY3QgdG8gZXhwb3J0Ci0gKiBAZmxhZ3M6IGZsYWdzIGxpa2UgRFJNX0NM
T0VYRUMgYW5kIERSTV9SRFdSCi0gKgotICogVGhpcyBpcyB0aGUgaW1wbGVtZW50YXRpb24gb2Yg
dGhlIGdlbV9wcmltZV9leHBvcnQgZnVuY3Rpb25zIGZvciBHRU0gZHJpdmVycwotICogdXNpbmcg
dGhlIFBSSU1FIGhlbHBlcnMuCi0gKi8KLXN0cnVjdCBkbWFfYnVmICpkcm1fZ2VtX3ByaW1lX2V4
cG9ydChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAotCQkJCSAgICAgc3RydWN0IGRybV9nZW1fb2Jq
ZWN0ICpvYmosCi0JCQkJICAgICBpbnQgZmxhZ3MpCitmYWlsOgorCS8qIGhtbSwgaWYgZHJpdmVy
IGF0dGFjaGVkLCB3ZSBhcmUgcmVseWluZyBvbiB0aGUgZnJlZS1vYmplY3QgcGF0aAorCSAqIHRv
IGRldGFjaC4uIHdoaWNoIHNlZW1zIG9rLi4KKwkgKi8KKwlkcm1fZ2VtX2hhbmRsZV9kZWxldGUo
ZmlsZV9wcml2LCAqaGFuZGxlKTsKKwlkbWFfYnVmX3B1dChkbWFfYnVmKTsKKwlyZXR1cm4gcmV0
OworCitvdXRfdW5sb2NrOgorCW11dGV4X3VubG9jaygmZGV2LT5vYmplY3RfbmFtZV9sb2NrKTsK
K291dF9wdXQ6CisJbXV0ZXhfdW5sb2NrKCZmaWxlX3ByaXYtPnByaW1lLmxvY2spOworCWRtYV9i
dWZfcHV0KGRtYV9idWYpOworCXJldHVybiByZXQ7Cit9CitFWFBPUlRfU1lNQk9MKGRybV9nZW1f
cHJpbWVfZmRfdG9faGFuZGxlKTsKKworaW50IGRybV9wcmltZV9mZF90b19oYW5kbGVfaW9jdGwo
c3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKKwkJCQkgc3RydWN0IGRybV9maWxl
ICpmaWxlX3ByaXYpCiB7Ci0Jc3RydWN0IGRtYV9idWZfZXhwb3J0X2luZm8gZXhwX2luZm8gPSB7
Ci0JCS5leHBfbmFtZSA9IEtCVUlMRF9NT0ROQU1FLCAvKiB3aGl0ZSBsaWUgZm9yIGRlYnVnICov
Ci0JCS5vd25lciA9IGRldi0+ZHJpdmVyLT5mb3BzLT5vd25lciwKLQkJLm9wcyA9ICZkcm1fZ2Vt
X3ByaW1lX2RtYWJ1Zl9vcHMsCi0JCS5zaXplID0gb2JqLT5zaXplLAotCQkuZmxhZ3MgPSBmbGFn
cywKLQkJLnByaXYgPSBvYmosCi0JCS5yZXN2ID0gb2JqLT5yZXN2LAotCX07CisJc3RydWN0IGRy
bV9wcmltZV9oYW5kbGUgKmFyZ3MgPSBkYXRhOwogCi0JaWYgKGRldi0+ZHJpdmVyLT5nZW1fcHJp
bWVfcmVzX29iaikKLQkJZXhwX2luZm8ucmVzdiA9IGRldi0+ZHJpdmVyLT5nZW1fcHJpbWVfcmVz
X29iaihvYmopOworCWlmICghZHJtX2NvcmVfY2hlY2tfZmVhdHVyZShkZXYsIERSSVZFUl9QUklN
RSkpCisJCXJldHVybiAtRU9QTk9UU1VQUDsKIAotCXJldHVybiBkcm1fZ2VtX2RtYWJ1Zl9leHBv
cnQoZGV2LCAmZXhwX2luZm8pOworCWlmICghZGV2LT5kcml2ZXItPnByaW1lX2ZkX3RvX2hhbmRs
ZSkKKwkJcmV0dXJuIC1FTk9TWVM7CisKKwlyZXR1cm4gZGV2LT5kcml2ZXItPnByaW1lX2ZkX3Rv
X2hhbmRsZShkZXYsIGZpbGVfcHJpdiwKKwkJCWFyZ3MtPmZkLCAmYXJncy0+aGFuZGxlKTsKIH0K
LUVYUE9SVF9TWU1CT0woZHJtX2dlbV9wcmltZV9leHBvcnQpOwogCiBzdGF0aWMgc3RydWN0IGRt
YV9idWYgKmV4cG9ydF9hbmRfcmVnaXN0ZXJfb2JqZWN0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYs
CiAJCQkJCQkgIHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqLApAQCAtNjA2LDU1ICs0OTcsMzI1
IEBAIGludCBkcm1fZ2VtX3ByaW1lX2hhbmRsZV90b19mZChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2
LAogb3V0X3VubG9jazoKIAltdXRleF91bmxvY2soJmZpbGVfcHJpdi0+cHJpbWUubG9jayk7CiAK
LQlyZXR1cm4gcmV0OworCXJldHVybiByZXQ7Cit9CitFWFBPUlRfU1lNQk9MKGRybV9nZW1fcHJp
bWVfaGFuZGxlX3RvX2ZkKTsKKworaW50IGRybV9wcmltZV9oYW5kbGVfdG9fZmRfaW9jdGwoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKKwkJCQkgc3RydWN0IGRybV9maWxlICpm
aWxlX3ByaXYpCit7CisJc3RydWN0IGRybV9wcmltZV9oYW5kbGUgKmFyZ3MgPSBkYXRhOworCisJ
aWYgKCFkcm1fY29yZV9jaGVja19mZWF0dXJlKGRldiwgRFJJVkVSX1BSSU1FKSkKKwkJcmV0dXJu
IC1FT1BOT1RTVVBQOworCisJaWYgKCFkZXYtPmRyaXZlci0+cHJpbWVfaGFuZGxlX3RvX2ZkKQor
CQlyZXR1cm4gLUVOT1NZUzsKKworCS8qIGNoZWNrIGZsYWdzIGFyZSB2YWxpZCAqLworCWlmIChh
cmdzLT5mbGFncyAmIH4oRFJNX0NMT0VYRUMgfCBEUk1fUkRXUikpCisJCXJldHVybiAtRUlOVkFM
OworCisJcmV0dXJuIGRldi0+ZHJpdmVyLT5wcmltZV9oYW5kbGVfdG9fZmQoZGV2LCBmaWxlX3By
aXYsCisJCQlhcmdzLT5oYW5kbGUsIGFyZ3MtPmZsYWdzLCAmYXJncy0+ZmQpOworfQorCisvKioK
KyAqIERPQzogUFJJTUUgSGVscGVycworICoKKyAqIERyaXZlcnMgY2FuIGltcGxlbWVudCBAZ2Vt
X3ByaW1lX2V4cG9ydCBhbmQgQGdlbV9wcmltZV9pbXBvcnQgaW4gdGVybXMgb2YKKyAqIHNpbXBs
ZXIgQVBJcyBieSB1c2luZyB0aGUgaGVscGVyIGZ1bmN0aW9ucyBAZHJtX2dlbV9wcmltZV9leHBv
cnQgYW5kCisgKiBAZHJtX2dlbV9wcmltZV9pbXBvcnQuICBUaGVzZSBmdW5jdGlvbnMgaW1wbGVt
ZW50IGRtYS1idWYgc3VwcG9ydCBpbiB0ZXJtcyBvZgorICogc2l4IGxvd2VyLWxldmVsIGRyaXZl
ciBjYWxsYmFja3M6CisgKgorICogRXhwb3J0IGNhbGxiYWNrczoKKyAqCisgKiAgKiBAZ2VtX3By
aW1lX3BpbiAob3B0aW9uYWwpOiBwcmVwYXJlIGEgR0VNIG9iamVjdCBmb3IgZXhwb3J0aW5nCisg
KiAgKiBAZ2VtX3ByaW1lX2dldF9zZ190YWJsZTogcHJvdmlkZSBhIHNjYXR0ZXIvZ2F0aGVyIHRh
YmxlIG9mIHBpbm5lZCBwYWdlcworICogICogQGdlbV9wcmltZV92bWFwOiB2bWFwIGEgYnVmZmVy
IGV4cG9ydGVkIGJ5IHlvdXIgZHJpdmVyCisgKiAgKiBAZ2VtX3ByaW1lX3Z1bm1hcDogdnVubWFw
IGEgYnVmZmVyIGV4cG9ydGVkIGJ5IHlvdXIgZHJpdmVyCisgKiAgKiBAZ2VtX3ByaW1lX21tYXAg
KG9wdGlvbmFsKTogbW1hcCBhIGJ1ZmZlciBleHBvcnRlZCBieSB5b3VyIGRyaXZlcgorICoKKyAq
IEltcG9ydCBjYWxsYmFjazoKKyAqCisgKiAgKiBAZ2VtX3ByaW1lX2ltcG9ydF9zZ190YWJsZSAo
aW1wb3J0KTogcHJvZHVjZSBhIEdFTSBvYmplY3QgZnJvbSBhbm90aGVyCisgKiAgICBkcml2ZXIn
cyBzY2F0dGVyL2dhdGhlciB0YWJsZQorICovCisKKy8qKgorICogZHJtX2dlbV9tYXBfYXR0YWNo
IC0gZG1hX2J1ZiBhdHRhY2ggaW1wbGVtZW50YXRpb24gZm9yIEdFTQorICogQGRtYV9idWY6IGJ1
ZmZlciB0byBhdHRhY2ggZGV2aWNlIHRvCisgKiBAYXR0YWNoOiBidWZmZXIgYXR0YWNobWVudCBk
YXRhCisgKgorICogQ2FsbHMgJmRybV9kcml2ZXIuZ2VtX3ByaW1lX3BpbiBmb3IgZGV2aWNlIHNw
ZWNpZmljIGhhbmRsaW5nLiBUaGlzIGNhbiBiZQorICogdXNlZCBhcyB0aGUgJmRtYV9idWZfb3Bz
LmF0dGFjaCBjYWxsYmFjay4KKyAqCisgKiBSZXR1cm5zIDAgb24gc3VjY2VzcywgbmVnYXRpdmUg
ZXJyb3IgY29kZSBvbiBmYWlsdXJlLgorICovCitpbnQgZHJtX2dlbV9tYXBfYXR0YWNoKHN0cnVj
dCBkbWFfYnVmICpkbWFfYnVmLAorCQkgICAgICAgc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAq
YXR0YWNoKQoreworCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqID0gZG1hX2J1Zi0+cHJpdjsK
KworCXJldHVybiBkcm1fZ2VtX3BpbihvYmopOworfQorRVhQT1JUX1NZTUJPTChkcm1fZ2VtX21h
cF9hdHRhY2gpOworCisvKioKKyAqIGRybV9nZW1fbWFwX2RldGFjaCAtIGRtYV9idWYgZGV0YWNo
IGltcGxlbWVudGF0aW9uIGZvciBHRU0KKyAqIEBkbWFfYnVmOiBidWZmZXIgdG8gZGV0YWNoIGZy
b20KKyAqIEBhdHRhY2g6IGF0dGFjaG1lbnQgdG8gYmUgZGV0YWNoZWQKKyAqCisgKiBDbGVhbnMg
dXAgJmRtYV9idWZfYXR0YWNobWVudC4gVGhpcyBjYW4gYmUgdXNlZCBhcyB0aGUgJmRtYV9idWZf
b3BzLmRldGFjaAorICogY2FsbGJhY2suCisgKi8KK3ZvaWQgZHJtX2dlbV9tYXBfZGV0YWNoKHN0
cnVjdCBkbWFfYnVmICpkbWFfYnVmLAorCQkJc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0
YWNoKQoreworCXN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqID0gZG1hX2J1Zi0+cHJpdjsKKwor
CWRybV9nZW1fdW5waW4ob2JqKTsKK30KK0VYUE9SVF9TWU1CT0woZHJtX2dlbV9tYXBfZGV0YWNo
KTsKKworLyoqCisgKiBkcm1fZ2VtX21hcF9kbWFfYnVmIC0gbWFwX2RtYV9idWYgaW1wbGVtZW50
YXRpb24gZm9yIEdFTQorICogQGF0dGFjaDogYXR0YWNobWVudCB3aG9zZSBzY2F0dGVybGlzdCBp
cyB0byBiZSByZXR1cm5lZAorICogQGRpcjogZGlyZWN0aW9uIG9mIERNQSB0cmFuc2ZlcgorICoK
KyAqIENhbGxzICZkcm1fZHJpdmVyLmdlbV9wcmltZV9nZXRfc2dfdGFibGUgYW5kIHRoZW4gbWFw
cyB0aGUgc2NhdHRlcmxpc3QuIFRoaXMKKyAqIGNhbiBiZSB1c2VkIGFzIHRoZSAmZG1hX2J1Zl9v
cHMubWFwX2RtYV9idWYgY2FsbGJhY2suCisgKgorICogUmV0dXJucyBzZ190YWJsZSBjb250YWlu
aW5nIHRoZSBzY2F0dGVybGlzdCB0byBiZSByZXR1cm5lZDsgcmV0dXJucyBFUlJfUFRSCisgKiBv
biBlcnJvci4gTWF5IHJldHVybiAtRUlOVFIgaWYgaXQgaXMgaW50ZXJydXB0ZWQgYnkgYSBzaWdu
YWwuCisgKi8KKworc3RydWN0IHNnX3RhYmxlICpkcm1fZ2VtX21hcF9kbWFfYnVmKHN0cnVjdCBk
bWFfYnVmX2F0dGFjaG1lbnQgKmF0dGFjaCwKKwkJCQkgICAgIGVudW0gZG1hX2RhdGFfZGlyZWN0
aW9uIGRpcikKK3sKKwlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiA9IGF0dGFjaC0+ZG1hYnVm
LT5wcml2OworCXN0cnVjdCBzZ190YWJsZSAqc2d0OworCisJaWYgKFdBUk5fT04oZGlyID09IERN
QV9OT05FKSkKKwkJcmV0dXJuIEVSUl9QVFIoLUVJTlZBTCk7CisKKwlpZiAob2JqLT5mdW5jcykK
KwkJc2d0ID0gb2JqLT5mdW5jcy0+Z2V0X3NnX3RhYmxlKG9iaik7CisJZWxzZQorCQlzZ3QgPSBv
YmotPmRldi0+ZHJpdmVyLT5nZW1fcHJpbWVfZ2V0X3NnX3RhYmxlKG9iaik7CisKKwlpZiAoIWRt
YV9tYXBfc2dfYXR0cnMoYXR0YWNoLT5kZXYsIHNndC0+c2dsLCBzZ3QtPm5lbnRzLCBkaXIsCisJ
CQkgICAgICBETUFfQVRUUl9TS0lQX0NQVV9TWU5DKSkgeworCQlzZ19mcmVlX3RhYmxlKHNndCk7
CisJCWtmcmVlKHNndCk7CisJCXNndCA9IEVSUl9QVFIoLUVOT01FTSk7CisJfQorCisJcmV0dXJu
IHNndDsKK30KK0VYUE9SVF9TWU1CT0woZHJtX2dlbV9tYXBfZG1hX2J1Zik7CisKKy8qKgorICog
ZHJtX2dlbV91bm1hcF9kbWFfYnVmIC0gdW5tYXBfZG1hX2J1ZiBpbXBsZW1lbnRhdGlvbiBmb3Ig
R0VNCisgKiBAYXR0YWNoOiBhdHRhY2htZW50IHRvIHVubWFwIGJ1ZmZlciBmcm9tCisgKiBAc2d0
OiBzY2F0dGVybGlzdCBpbmZvIG9mIHRoZSBidWZmZXIgdG8gdW5tYXAKKyAqIEBkaXI6IGRpcmVj
dGlvbiBvZiBETUEgdHJhbnNmZXIKKyAqCisgKiBUaGlzIGNhbiBiZSB1c2VkIGFzIHRoZSAmZG1h
X2J1Zl9vcHMudW5tYXBfZG1hX2J1ZiBjYWxsYmFjay4KKyAqLwordm9pZCBkcm1fZ2VtX3VubWFw
X2RtYV9idWYoc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNoLAorCQkJICAgc3RydWN0
IHNnX3RhYmxlICpzZ3QsCisJCQkgICBlbnVtIGRtYV9kYXRhX2RpcmVjdGlvbiBkaXIpCit7CisJ
aWYgKCFzZ3QpCisJCXJldHVybjsKKworCWRtYV91bm1hcF9zZ19hdHRycyhhdHRhY2gtPmRldiwg
c2d0LT5zZ2wsIHNndC0+bmVudHMsIGRpciwKKwkJCSAgIERNQV9BVFRSX1NLSVBfQ1BVX1NZTkMp
OworCXNnX2ZyZWVfdGFibGUoc2d0KTsKKwlrZnJlZShzZ3QpOworfQorRVhQT1JUX1NZTUJPTChk
cm1fZ2VtX3VubWFwX2RtYV9idWYpOworCisvKioKKyAqIGRybV9nZW1fZG1hYnVmX3ZtYXAgLSBk
bWFfYnVmIHZtYXAgaW1wbGVtZW50YXRpb24gZm9yIEdFTQorICogQGRtYV9idWY6IGJ1ZmZlciB0
byBiZSBtYXBwZWQKKyAqCisgKiBTZXRzIHVwIGEga2VybmVsIHZpcnR1YWwgbWFwcGluZy4gVGhp
cyBjYW4gYmUgdXNlZCBhcyB0aGUgJmRtYV9idWZfb3BzLnZtYXAKKyAqIGNhbGxiYWNrLgorICoK
KyAqIFJldHVybnMgdGhlIGtlcm5lbCB2aXJ0dWFsIGFkZHJlc3MuCisgKi8KK3ZvaWQgKmRybV9n
ZW1fZG1hYnVmX3ZtYXAoc3RydWN0IGRtYV9idWYgKmRtYV9idWYpCit7CisJc3RydWN0IGRybV9n
ZW1fb2JqZWN0ICpvYmogPSBkbWFfYnVmLT5wcml2OworCXZvaWQgKnZhZGRyOworCisJdmFkZHIg
PSBkcm1fZ2VtX3ZtYXAob2JqKTsKKwlpZiAoSVNfRVJSKHZhZGRyKSkKKwkJdmFkZHIgPSBOVUxM
OworCisJcmV0dXJuIHZhZGRyOworfQorRVhQT1JUX1NZTUJPTChkcm1fZ2VtX2RtYWJ1Zl92bWFw
KTsKKworLyoqCisgKiBkcm1fZ2VtX2RtYWJ1Zl92dW5tYXAgLSBkbWFfYnVmIHZ1bm1hcCBpbXBs
ZW1lbnRhdGlvbiBmb3IgR0VNCisgKiBAZG1hX2J1ZjogYnVmZmVyIHRvIGJlIHVubWFwcGVkCisg
KiBAdmFkZHI6IHRoZSB2aXJ0dWFsIGFkZHJlc3Mgb2YgdGhlIGJ1ZmZlcgorICoKKyAqIFJlbGVh
c2VzIGEga2VybmVsIHZpcnR1YWwgbWFwcGluZy4gVGhpcyBjYW4gYmUgdXNlZCBhcyB0aGUKKyAq
ICZkbWFfYnVmX29wcy52dW5tYXAgY2FsbGJhY2suCisgKi8KK3ZvaWQgZHJtX2dlbV9kbWFidWZf
dnVubWFwKHN0cnVjdCBkbWFfYnVmICpkbWFfYnVmLCB2b2lkICp2YWRkcikKK3sKKwlzdHJ1Y3Qg
ZHJtX2dlbV9vYmplY3QgKm9iaiA9IGRtYV9idWYtPnByaXY7CisKKwlkcm1fZ2VtX3Z1bm1hcChv
YmosIHZhZGRyKTsKK30KK0VYUE9SVF9TWU1CT0woZHJtX2dlbV9kbWFidWZfdnVubWFwKTsKKwor
LyoqCisgKiBkcm1fZ2VtX3ByaW1lX21tYXAgLSBQUklNRSBtbWFwIGZ1bmN0aW9uIGZvciBHRU0g
ZHJpdmVycworICogQG9iajogR0VNIG9iamVjdAorICogQHZtYTogVmlydHVhbCBhZGRyZXNzIHJh
bmdlCisgKgorICogVGhpcyBmdW5jdGlvbiBzZXRzIHVwIGEgdXNlcnNwYWNlIG1hcHBpbmcgZm9y
IFBSSU1FIGV4cG9ydGVkIGJ1ZmZlcnMgdXNpbmcKKyAqIHRoZSBzYW1lIGNvZGVwYXRoIHRoYXQg
aXMgdXNlZCBmb3IgcmVndWxhciBHRU0gYnVmZmVyIG1hcHBpbmcgb24gdGhlIERSTSBmZC4KKyAq
IFRoZSBmYWtlIEdFTSBvZmZzZXQgaXMgYWRkZWQgdG8gdm1hLT52bV9wZ29mZiBhbmQgJmRybV9k
cml2ZXItPmZvcHMtPm1tYXAgaXMKKyAqIGNhbGxlZCB0byBzZXQgdXAgdGhlIG1hcHBpbmcuCisg
KgorICogRHJpdmVycyBjYW4gdXNlIHRoaXMgYXMgdGhlaXIgJmRybV9kcml2ZXIuZ2VtX3ByaW1l
X21tYXAgY2FsbGJhY2suCisgKi8KK2ludCBkcm1fZ2VtX3ByaW1lX21tYXAoc3RydWN0IGRybV9n
ZW1fb2JqZWN0ICpvYmosIHN0cnVjdCB2bV9hcmVhX3N0cnVjdCAqdm1hKQoreworCXN0cnVjdCBk
cm1fZmlsZSAqcHJpdjsKKwlzdHJ1Y3QgZmlsZSAqZmlsOworCWludCByZXQ7CisKKwlwcml2ID0g
a3phbGxvYyhzaXplb2YoKnByaXYpLCBHRlBfS0VSTkVMKTsKKwlmaWwgPSBremFsbG9jKHNpemVv
ZigqZmlsKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFwcml2IHx8ICFmaWwpIHsKKwkJcmV0ID0gLUVO
T01FTTsKKwkJZ290byBvdXQ7CisJfQorCisJLyogVXNlZCBieSBkcm1fZ2VtX21tYXAoKSB0byBs
b29rdXAgdGhlIEdFTSBvYmplY3QgKi8KKwlwcml2LT5taW5vciA9IG9iai0+ZGV2LT5wcmltYXJ5
OworCWZpbC0+cHJpdmF0ZV9kYXRhID0gcHJpdjsKKworCXJldCA9IGRybV92bWFfbm9kZV9hbGxv
dygmb2JqLT52bWFfbm9kZSwgcHJpdik7CisJaWYgKHJldCkKKwkJZ290byBvdXQ7CisKKwl2bWEt
PnZtX3Bnb2ZmICs9IGRybV92bWFfbm9kZV9zdGFydCgmb2JqLT52bWFfbm9kZSk7CisKKwlyZXQg
PSBvYmotPmRldi0+ZHJpdmVyLT5mb3BzLT5tbWFwKGZpbCwgdm1hKTsKKworCWRybV92bWFfbm9k
ZV9yZXZva2UoJm9iai0+dm1hX25vZGUsIHByaXYpOworb3V0OgorCWtmcmVlKHByaXYpOworCWtm
cmVlKGZpbCk7CisKKwlyZXR1cm4gcmV0OworfQorRVhQT1JUX1NZTUJPTChkcm1fZ2VtX3ByaW1l
X21tYXApOworCisvKioKKyAqIGRybV9nZW1fZG1hYnVmX21tYXAgLSBkbWFfYnVmIG1tYXAgaW1w
bGVtZW50YXRpb24gZm9yIEdFTQorICogQGRtYV9idWY6IGJ1ZmZlciB0byBiZSBtYXBwZWQKKyAq
IEB2bWE6IHZpcnR1YWwgYWRkcmVzcyByYW5nZQorICoKKyAqIFByb3ZpZGVzIG1lbW9yeSBtYXBw
aW5nIGZvciB0aGUgYnVmZmVyLiBUaGlzIGNhbiBiZSB1c2VkIGFzIHRoZQorICogJmRtYV9idWZf
b3BzLm1tYXAgY2FsbGJhY2suCisgKgorICogUmV0dXJucyAwIG9uIHN1Y2Nlc3Mgb3IgYSBuZWdh
dGl2ZSBlcnJvciBjb2RlIG9uIGZhaWx1cmUuCisgKi8KK2ludCBkcm1fZ2VtX2RtYWJ1Zl9tbWFw
KHN0cnVjdCBkbWFfYnVmICpkbWFfYnVmLCBzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSkKK3sK
KwlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiA9IGRtYV9idWYtPnByaXY7CisJc3RydWN0IGRy
bV9kZXZpY2UgKmRldiA9IG9iai0+ZGV2OworCisJaWYgKCFkZXYtPmRyaXZlci0+Z2VtX3ByaW1l
X21tYXApCisJCXJldHVybiAtRU5PU1lTOworCisJcmV0dXJuIGRldi0+ZHJpdmVyLT5nZW1fcHJp
bWVfbW1hcChvYmosIHZtYSk7CiB9Ci1FWFBPUlRfU1lNQk9MKGRybV9nZW1fcHJpbWVfaGFuZGxl
X3RvX2ZkKTsKK0VYUE9SVF9TWU1CT0woZHJtX2dlbV9kbWFidWZfbW1hcCk7CisKK3N0YXRpYyBj
b25zdCBzdHJ1Y3QgZG1hX2J1Zl9vcHMgZHJtX2dlbV9wcmltZV9kbWFidWZfb3BzID0gIHsKKwku
Y2FjaGVfc2d0X21hcHBpbmcgPSB0cnVlLAorCS5hdHRhY2ggPSBkcm1fZ2VtX21hcF9hdHRhY2gs
CisJLmRldGFjaCA9IGRybV9nZW1fbWFwX2RldGFjaCwKKwkubWFwX2RtYV9idWYgPSBkcm1fZ2Vt
X21hcF9kbWFfYnVmLAorCS51bm1hcF9kbWFfYnVmID0gZHJtX2dlbV91bm1hcF9kbWFfYnVmLAor
CS5yZWxlYXNlID0gZHJtX2dlbV9kbWFidWZfcmVsZWFzZSwKKwkubW1hcCA9IGRybV9nZW1fZG1h
YnVmX21tYXAsCisJLnZtYXAgPSBkcm1fZ2VtX2RtYWJ1Zl92bWFwLAorCS52dW5tYXAgPSBkcm1f
Z2VtX2RtYWJ1Zl92dW5tYXAsCit9OwogCiAvKioKLSAqIGRybV9nZW1fcHJpbWVfbW1hcCAtIFBS
SU1FIG1tYXAgZnVuY3Rpb24gZm9yIEdFTSBkcml2ZXJzCi0gKiBAb2JqOiBHRU0gb2JqZWN0Ci0g
KiBAdm1hOiBWaXJ0dWFsIGFkZHJlc3MgcmFuZ2UKLSAqCi0gKiBUaGlzIGZ1bmN0aW9uIHNldHMg
dXAgYSB1c2Vyc3BhY2UgbWFwcGluZyBmb3IgUFJJTUUgZXhwb3J0ZWQgYnVmZmVycyB1c2luZwot
ICogdGhlIHNhbWUgY29kZXBhdGggdGhhdCBpcyB1c2VkIGZvciByZWd1bGFyIEdFTSBidWZmZXIg
bWFwcGluZyBvbiB0aGUgRFJNIGZkLgotICogVGhlIGZha2UgR0VNIG9mZnNldCBpcyBhZGRlZCB0
byB2bWEtPnZtX3Bnb2ZmIGFuZCAmZHJtX2RyaXZlci0+Zm9wcy0+bW1hcCBpcwotICogY2FsbGVk
IHRvIHNldCB1cCB0aGUgbWFwcGluZy4KKyAqIGRybV9wcmltZV9wYWdlc190b19zZyAtIGNvbnZl
cnRzIGEgcGFnZSBhcnJheSBpbnRvIGFuIHNnIGxpc3QKKyAqIEBwYWdlczogcG9pbnRlciB0byB0
aGUgYXJyYXkgb2YgcGFnZSBwb2ludGVycyB0byBjb252ZXJ0CisgKiBAbnJfcGFnZXM6IGxlbmd0
aCBvZiB0aGUgcGFnZSB2ZWN0b3IKICAqCi0gKiBEcml2ZXJzIGNhbiB1c2UgdGhpcyBhcyB0aGVp
ciAmZHJtX2RyaXZlci5nZW1fcHJpbWVfbW1hcCBjYWxsYmFjay4KKyAqIFRoaXMgaGVscGVyIGNy
ZWF0ZXMgYW4gc2cgdGFibGUgb2JqZWN0IGZyb20gYSBzZXQgb2YgcGFnZXMKKyAqIHRoZSBkcml2
ZXIgaXMgcmVzcG9uc2libGUgZm9yIG1hcHBpbmcgdGhlIHBhZ2VzIGludG8gdGhlCisgKiBpbXBv
cnRlcnMgYWRkcmVzcyBzcGFjZSBmb3IgdXNlIHdpdGggZG1hX2J1ZiBpdHNlbGYuCiAgKi8KLWlu
dCBkcm1fZ2VtX3ByaW1lX21tYXAoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmosIHN0cnVjdCB2
bV9hcmVhX3N0cnVjdCAqdm1hKQorc3RydWN0IHNnX3RhYmxlICpkcm1fcHJpbWVfcGFnZXNfdG9f
c2coc3RydWN0IHBhZ2UgKipwYWdlcywgdW5zaWduZWQgaW50IG5yX3BhZ2VzKQogewotCXN0cnVj
dCBkcm1fZmlsZSAqcHJpdjsKLQlzdHJ1Y3QgZmlsZSAqZmlsOworCXN0cnVjdCBzZ190YWJsZSAq
c2cgPSBOVUxMOwogCWludCByZXQ7CiAKLQlwcml2ID0ga3phbGxvYyhzaXplb2YoKnByaXYpLCBH
RlBfS0VSTkVMKTsKLQlmaWwgPSBremFsbG9jKHNpemVvZigqZmlsKSwgR0ZQX0tFUk5FTCk7Ci0J
aWYgKCFwcml2IHx8ICFmaWwpIHsKKwlzZyA9IGttYWxsb2Moc2l6ZW9mKHN0cnVjdCBzZ190YWJs
ZSksIEdGUF9LRVJORUwpOworCWlmICghc2cpIHsKIAkJcmV0ID0gLUVOT01FTTsKIAkJZ290byBv
dXQ7CiAJfQogCi0JLyogVXNlZCBieSBkcm1fZ2VtX21tYXAoKSB0byBsb29rdXAgdGhlIEdFTSBv
YmplY3QgKi8KLQlwcml2LT5taW5vciA9IG9iai0+ZGV2LT5wcmltYXJ5OwotCWZpbC0+cHJpdmF0
ZV9kYXRhID0gcHJpdjsKLQotCXJldCA9IGRybV92bWFfbm9kZV9hbGxvdygmb2JqLT52bWFfbm9k
ZSwgcHJpdik7CisJcmV0ID0gc2dfYWxsb2NfdGFibGVfZnJvbV9wYWdlcyhzZywgcGFnZXMsIG5y
X3BhZ2VzLCAwLAorCQkJCW5yX3BhZ2VzIDw8IFBBR0VfU0hJRlQsIEdGUF9LRVJORUwpOwogCWlm
IChyZXQpCiAJCWdvdG8gb3V0OwogCi0Jdm1hLT52bV9wZ29mZiArPSBkcm1fdm1hX25vZGVfc3Rh
cnQoJm9iai0+dm1hX25vZGUpOworCXJldHVybiBzZzsKK291dDoKKwlrZnJlZShzZyk7CisJcmV0
dXJuIEVSUl9QVFIocmV0KTsKK30KK0VYUE9SVF9TWU1CT0woZHJtX3ByaW1lX3BhZ2VzX3RvX3Nn
KTsKIAotCXJldCA9IG9iai0+ZGV2LT5kcml2ZXItPmZvcHMtPm1tYXAoZmlsLCB2bWEpOworLyoq
CisgKiBkcm1fZ2VtX3ByaW1lX2V4cG9ydCAtIGhlbHBlciBsaWJyYXJ5IGltcGxlbWVudGF0aW9u
IG9mIHRoZSBleHBvcnQgY2FsbGJhY2sKKyAqIEBkZXY6IGRybV9kZXZpY2UgdG8gZXhwb3J0IGZy
b20KKyAqIEBvYmo6IEdFTSBvYmplY3QgdG8gZXhwb3J0CisgKiBAZmxhZ3M6IGZsYWdzIGxpa2Ug
RFJNX0NMT0VYRUMgYW5kIERSTV9SRFdSCisgKgorICogVGhpcyBpcyB0aGUgaW1wbGVtZW50YXRp
b24gb2YgdGhlIGdlbV9wcmltZV9leHBvcnQgZnVuY3Rpb25zIGZvciBHRU0gZHJpdmVycworICog
dXNpbmcgdGhlIFBSSU1FIGhlbHBlcnMuCisgKi8KK3N0cnVjdCBkbWFfYnVmICpkcm1fZ2VtX3By
aW1lX2V4cG9ydChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAorCQkJCSAgICAgc3RydWN0IGRybV9n
ZW1fb2JqZWN0ICpvYmosCisJCQkJICAgICBpbnQgZmxhZ3MpCit7CisJc3RydWN0IGRtYV9idWZf
ZXhwb3J0X2luZm8gZXhwX2luZm8gPSB7CisJCS5leHBfbmFtZSA9IEtCVUlMRF9NT0ROQU1FLCAv
KiB3aGl0ZSBsaWUgZm9yIGRlYnVnICovCisJCS5vd25lciA9IGRldi0+ZHJpdmVyLT5mb3BzLT5v
d25lciwKKwkJLm9wcyA9ICZkcm1fZ2VtX3ByaW1lX2RtYWJ1Zl9vcHMsCisJCS5zaXplID0gb2Jq
LT5zaXplLAorCQkuZmxhZ3MgPSBmbGFncywKKwkJLnByaXYgPSBvYmosCisJCS5yZXN2ID0gb2Jq
LT5yZXN2LAorCX07CiAKLQlkcm1fdm1hX25vZGVfcmV2b2tlKCZvYmotPnZtYV9ub2RlLCBwcml2
KTsKLW91dDoKLQlrZnJlZShwcml2KTsKLQlrZnJlZShmaWwpOworCWlmIChkZXYtPmRyaXZlci0+
Z2VtX3ByaW1lX3Jlc19vYmopCisJCWV4cF9pbmZvLnJlc3YgPSBkZXYtPmRyaXZlci0+Z2VtX3By
aW1lX3Jlc19vYmoob2JqKTsKIAotCXJldHVybiByZXQ7CisJcmV0dXJuIGRybV9nZW1fZG1hYnVm
X2V4cG9ydChkZXYsICZleHBfaW5mbyk7CiB9Ci1FWFBPUlRfU1lNQk9MKGRybV9nZW1fcHJpbWVf
bW1hcCk7CitFWFBPUlRfU1lNQk9MKGRybV9nZW1fcHJpbWVfZXhwb3J0KTsKIAogLyoqCiAgKiBk
cm1fZ2VtX3ByaW1lX2ltcG9ydF9kZXYgLSBjb3JlIGltcGxlbWVudGF0aW9uIG9mIHRoZSBpbXBv
cnQgY2FsbGJhY2sKQEAgLTczNywxNTQgKzg5OCw2IEBAIHN0cnVjdCBkcm1fZ2VtX29iamVjdCAq
ZHJtX2dlbV9wcmltZV9pbXBvcnQoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIH0KIEVYUE9SVF9T
WU1CT0woZHJtX2dlbV9wcmltZV9pbXBvcnQpOwogCi0vKioKLSAqIGRybV9nZW1fcHJpbWVfZmRf
dG9faGFuZGxlIC0gUFJJTUUgaW1wb3J0IGZ1bmN0aW9uIGZvciBHRU0gZHJpdmVycwotICogQGRl
djogZGV2IHRvIGV4cG9ydCB0aGUgYnVmZmVyIGZyb20KLSAqIEBmaWxlX3ByaXY6IGRybSBmaWxl
LXByaXZhdGUgc3RydWN0dXJlCi0gKiBAcHJpbWVfZmQ6IGZkIGlkIG9mIHRoZSBkbWEtYnVmIHdo
aWNoIHNob3VsZCBiZSBpbXBvcnRlZAotICogQGhhbmRsZTogcG9pbnRlciB0byBzdG9yYWdlIGZv
ciB0aGUgaGFuZGxlIG9mIHRoZSBpbXBvcnRlZCBidWZmZXIgb2JqZWN0Ci0gKgotICogVGhpcyBp
cyB0aGUgUFJJTUUgaW1wb3J0IGZ1bmN0aW9uIHdoaWNoIG11c3QgYmUgdXNlZCBtYW5kYXRvcmls
eSBieSBHRU0KLSAqIGRyaXZlcnMgdG8gZW5zdXJlIGNvcnJlY3QgbGlmZXRpbWUgbWFuYWdlbWVu
dCBvZiB0aGUgdW5kZXJseWluZyBHRU0gb2JqZWN0LgotICogVGhlIGFjdHVhbCBpbXBvcnRpbmcg
b2YgR0VNIG9iamVjdCBmcm9tIHRoZSBkbWEtYnVmIGlzIGRvbmUgdGhyb3VnaCB0aGUKLSAqIGdl
bV9pbXBvcnRfZXhwb3J0IGRyaXZlciBjYWxsYmFjay4KLSAqLwotaW50IGRybV9nZW1fcHJpbWVf
ZmRfdG9faGFuZGxlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCi0JCQkgICAgICAgc3RydWN0IGRy
bV9maWxlICpmaWxlX3ByaXYsIGludCBwcmltZV9mZCwKLQkJCSAgICAgICB1aW50MzJfdCAqaGFu
ZGxlKQotewotCXN0cnVjdCBkbWFfYnVmICpkbWFfYnVmOwotCXN0cnVjdCBkcm1fZ2VtX29iamVj
dCAqb2JqOwotCWludCByZXQ7Ci0KLQlkbWFfYnVmID0gZG1hX2J1Zl9nZXQocHJpbWVfZmQpOwot
CWlmIChJU19FUlIoZG1hX2J1ZikpCi0JCXJldHVybiBQVFJfRVJSKGRtYV9idWYpOwotCi0JbXV0
ZXhfbG9jaygmZmlsZV9wcml2LT5wcmltZS5sb2NrKTsKLQotCXJldCA9IGRybV9wcmltZV9sb29r
dXBfYnVmX2hhbmRsZSgmZmlsZV9wcml2LT5wcmltZSwKLQkJCWRtYV9idWYsIGhhbmRsZSk7Ci0J
aWYgKHJldCA9PSAwKQotCQlnb3RvIG91dF9wdXQ7Ci0KLQkvKiBuZXZlciBzZWVuIHRoaXMgb25l
LCBuZWVkIHRvIGltcG9ydCAqLwotCW11dGV4X2xvY2soJmRldi0+b2JqZWN0X25hbWVfbG9jayk7
Ci0JaWYgKGRldi0+ZHJpdmVyLT5nZW1fcHJpbWVfaW1wb3J0KQotCQlvYmogPSBkZXYtPmRyaXZl
ci0+Z2VtX3ByaW1lX2ltcG9ydChkZXYsIGRtYV9idWYpOwotCWVsc2UKLQkJb2JqID0gZHJtX2dl
bV9wcmltZV9pbXBvcnQoZGV2LCBkbWFfYnVmKTsKLQlpZiAoSVNfRVJSKG9iaikpIHsKLQkJcmV0
ID0gUFRSX0VSUihvYmopOwotCQlnb3RvIG91dF91bmxvY2s7Ci0JfQotCi0JaWYgKG9iai0+ZG1h
X2J1ZikgewotCQlXQVJOX09OKG9iai0+ZG1hX2J1ZiAhPSBkbWFfYnVmKTsKLQl9IGVsc2Ugewot
CQlvYmotPmRtYV9idWYgPSBkbWFfYnVmOwotCQlnZXRfZG1hX2J1ZihkbWFfYnVmKTsKLQl9Ci0K
LQkvKiBfaGFuZGxlX2NyZWF0ZV90YWlsIHVuY29uZGl0aW9uYWxseSB1bmxvY2tzIGRldi0+b2Jq
ZWN0X25hbWVfbG9jay4gKi8KLQlyZXQgPSBkcm1fZ2VtX2hhbmRsZV9jcmVhdGVfdGFpbChmaWxl
X3ByaXYsIG9iaiwgaGFuZGxlKTsKLQlkcm1fZ2VtX29iamVjdF9wdXRfdW5sb2NrZWQob2JqKTsK
LQlpZiAocmV0KQotCQlnb3RvIG91dF9wdXQ7Ci0KLQlyZXQgPSBkcm1fcHJpbWVfYWRkX2J1Zl9o
YW5kbGUoJmZpbGVfcHJpdi0+cHJpbWUsCi0JCQlkbWFfYnVmLCAqaGFuZGxlKTsKLQltdXRleF91
bmxvY2soJmZpbGVfcHJpdi0+cHJpbWUubG9jayk7Ci0JaWYgKHJldCkKLQkJZ290byBmYWlsOwot
Ci0JZG1hX2J1Zl9wdXQoZG1hX2J1Zik7Ci0KLQlyZXR1cm4gMDsKLQotZmFpbDoKLQkvKiBobW0s
IGlmIGRyaXZlciBhdHRhY2hlZCwgd2UgYXJlIHJlbHlpbmcgb24gdGhlIGZyZWUtb2JqZWN0IHBh
dGgKLQkgKiB0byBkZXRhY2guLiB3aGljaCBzZWVtcyBvay4uCi0JICovCi0JZHJtX2dlbV9oYW5k
bGVfZGVsZXRlKGZpbGVfcHJpdiwgKmhhbmRsZSk7Ci0JZG1hX2J1Zl9wdXQoZG1hX2J1Zik7Ci0J
cmV0dXJuIHJldDsKLQotb3V0X3VubG9jazoKLQltdXRleF91bmxvY2soJmRldi0+b2JqZWN0X25h
bWVfbG9jayk7Ci1vdXRfcHV0OgotCW11dGV4X3VubG9jaygmZmlsZV9wcml2LT5wcmltZS5sb2Nr
KTsKLQlkbWFfYnVmX3B1dChkbWFfYnVmKTsKLQlyZXR1cm4gcmV0OwotfQotRVhQT1JUX1NZTUJP
TChkcm1fZ2VtX3ByaW1lX2ZkX3RvX2hhbmRsZSk7Ci0KLWludCBkcm1fcHJpbWVfaGFuZGxlX3Rv
X2ZkX2lvY3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCi0JCQkJIHN0cnVj
dCBkcm1fZmlsZSAqZmlsZV9wcml2KQotewotCXN0cnVjdCBkcm1fcHJpbWVfaGFuZGxlICphcmdz
ID0gZGF0YTsKLQotCWlmICghZHJtX2NvcmVfY2hlY2tfZmVhdHVyZShkZXYsIERSSVZFUl9QUklN
RSkpCi0JCXJldHVybiAtRU9QTk9UU1VQUDsKLQotCWlmICghZGV2LT5kcml2ZXItPnByaW1lX2hh
bmRsZV90b19mZCkKLQkJcmV0dXJuIC1FTk9TWVM7Ci0KLQkvKiBjaGVjayBmbGFncyBhcmUgdmFs
aWQgKi8KLQlpZiAoYXJncy0+ZmxhZ3MgJiB+KERSTV9DTE9FWEVDIHwgRFJNX1JEV1IpKQotCQly
ZXR1cm4gLUVJTlZBTDsKLQotCXJldHVybiBkZXYtPmRyaXZlci0+cHJpbWVfaGFuZGxlX3RvX2Zk
KGRldiwgZmlsZV9wcml2LAotCQkJYXJncy0+aGFuZGxlLCBhcmdzLT5mbGFncywgJmFyZ3MtPmZk
KTsKLX0KLQotaW50IGRybV9wcmltZV9mZF90b19oYW5kbGVfaW9jdGwoc3RydWN0IGRybV9kZXZp
Y2UgKmRldiwgdm9pZCAqZGF0YSwKLQkJCQkgc3RydWN0IGRybV9maWxlICpmaWxlX3ByaXYpCi17
Ci0Jc3RydWN0IGRybV9wcmltZV9oYW5kbGUgKmFyZ3MgPSBkYXRhOwotCi0JaWYgKCFkcm1fY29y
ZV9jaGVja19mZWF0dXJlKGRldiwgRFJJVkVSX1BSSU1FKSkKLQkJcmV0dXJuIC1FT1BOT1RTVVBQ
OwotCi0JaWYgKCFkZXYtPmRyaXZlci0+cHJpbWVfZmRfdG9faGFuZGxlKQotCQlyZXR1cm4gLUVO
T1NZUzsKLQotCXJldHVybiBkZXYtPmRyaXZlci0+cHJpbWVfZmRfdG9faGFuZGxlKGRldiwgZmls
ZV9wcml2LAotCQkJYXJncy0+ZmQsICZhcmdzLT5oYW5kbGUpOwotfQotCi0vKioKLSAqIGRybV9w
cmltZV9wYWdlc190b19zZyAtIGNvbnZlcnRzIGEgcGFnZSBhcnJheSBpbnRvIGFuIHNnIGxpc3QK
LSAqIEBwYWdlczogcG9pbnRlciB0byB0aGUgYXJyYXkgb2YgcGFnZSBwb2ludGVycyB0byBjb252
ZXJ0Ci0gKiBAbnJfcGFnZXM6IGxlbmd0aCBvZiB0aGUgcGFnZSB2ZWN0b3IKLSAqCi0gKiBUaGlz
IGhlbHBlciBjcmVhdGVzIGFuIHNnIHRhYmxlIG9iamVjdCBmcm9tIGEgc2V0IG9mIHBhZ2VzCi0g
KiB0aGUgZHJpdmVyIGlzIHJlc3BvbnNpYmxlIGZvciBtYXBwaW5nIHRoZSBwYWdlcyBpbnRvIHRo
ZQotICogaW1wb3J0ZXJzIGFkZHJlc3Mgc3BhY2UgZm9yIHVzZSB3aXRoIGRtYV9idWYgaXRzZWxm
LgotICovCi1zdHJ1Y3Qgc2dfdGFibGUgKmRybV9wcmltZV9wYWdlc190b19zZyhzdHJ1Y3QgcGFn
ZSAqKnBhZ2VzLCB1bnNpZ25lZCBpbnQgbnJfcGFnZXMpCi17Ci0Jc3RydWN0IHNnX3RhYmxlICpz
ZyA9IE5VTEw7Ci0JaW50IHJldDsKLQotCXNnID0ga21hbGxvYyhzaXplb2Yoc3RydWN0IHNnX3Rh
YmxlKSwgR0ZQX0tFUk5FTCk7Ci0JaWYgKCFzZykgewotCQlyZXQgPSAtRU5PTUVNOwotCQlnb3Rv
IG91dDsKLQl9Ci0KLQlyZXQgPSBzZ19hbGxvY190YWJsZV9mcm9tX3BhZ2VzKHNnLCBwYWdlcywg
bnJfcGFnZXMsIDAsCi0JCQkJbnJfcGFnZXMgPDwgUEFHRV9TSElGVCwgR0ZQX0tFUk5FTCk7Ci0J
aWYgKHJldCkKLQkJZ290byBvdXQ7Ci0KLQlyZXR1cm4gc2c7Ci1vdXQ6Ci0Ja2ZyZWUoc2cpOwot
CXJldHVybiBFUlJfUFRSKHJldCk7Ci19Ci1FWFBPUlRfU1lNQk9MKGRybV9wcmltZV9wYWdlc190
b19zZyk7Ci0KIC8qKgogICogZHJtX3ByaW1lX3NnX3RvX3BhZ2VfYWRkcl9hcnJheXMgLSBjb252
ZXJ0IGFuIHNnIHRhYmxlIGludG8gYSBwYWdlIGFycmF5CiAgKiBAc2d0OiBzY2F0dGVyLWdhdGhl
ciB0YWJsZSB0byBjb252ZXJ0CkBAIC05NDksMTYgKzk2MiwzIEBAIHZvaWQgZHJtX3ByaW1lX2dl
bV9kZXN0cm95KHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqLCBzdHJ1Y3Qgc2dfdGFibGUgKnNn
KQogCWRtYV9idWZfcHV0KGRtYV9idWYpOwogfQogRVhQT1JUX1NZTUJPTChkcm1fcHJpbWVfZ2Vt
X2Rlc3Ryb3kpOwotCi12b2lkIGRybV9wcmltZV9pbml0X2ZpbGVfcHJpdmF0ZShzdHJ1Y3QgZHJt
X3ByaW1lX2ZpbGVfcHJpdmF0ZSAqcHJpbWVfZnByaXYpCi17Ci0JbXV0ZXhfaW5pdCgmcHJpbWVf
ZnByaXYtPmxvY2spOwotCXByaW1lX2Zwcml2LT5kbWFidWZzID0gUkJfUk9PVDsKLQlwcmltZV9m
cHJpdi0+aGFuZGxlcyA9IFJCX1JPT1Q7Ci19Ci0KLXZvaWQgZHJtX3ByaW1lX2Rlc3Ryb3lfZmls
ZV9wcml2YXRlKHN0cnVjdCBkcm1fcHJpbWVfZmlsZV9wcml2YXRlICpwcmltZV9mcHJpdikKLXsK
LQkvKiBieSBub3cgZHJtX2dlbV9yZWxlYXNlIHNob3VsZCd2ZSBtYWRlIHN1cmUgdGhlIGxpc3Qg
aXMgZW1wdHkgKi8KLQlXQVJOX09OKCFSQl9FTVBUWV9ST09UKCZwcmltZV9mcHJpdi0+ZG1hYnVm
cykpOwotfQpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9kcm0vZHJtX3ByaW1lLmggYi9pbmNsdWRlL2Ry
bS9kcm1fcHJpbWUuaAppbmRleCBiMDM3MzFhM2YwNzkuLmVlMzJiMDdmM2ViMCAxMDA2NDQKLS0t
IGEvaW5jbHVkZS9kcm0vZHJtX3ByaW1lLmgKKysrIGIvaW5jbHVkZS9kcm0vZHJtX3ByaW1lLmgK
QEAgLTQyLDcgKzQyLDYgQEAKICAqIFRoaXMganVzdCBjb250YWlucyB0aGUgaW50ZXJuYWwgJnN0
cnVjdCBkbWFfYnVmIGFuZCBoYW5kbGUgY2FjaGVzIGZvciBlYWNoCiAgKiAmc3RydWN0IGRybV9m
aWxlIHVzZWQgYnkgdGhlIFBSSU1FIGNvcmUgY29kZS4KICAqLwotCiBzdHJ1Y3QgZHJtX3ByaW1l
X2ZpbGVfcHJpdmF0ZSB7CiAvKiBwcml2YXRlOiAqLwogCXN0cnVjdCBtdXRleCBsb2NrOwpAQCAt
NjQsMjUgKzYzLDE4IEBAIHN0cnVjdCBkcm1fZmlsZTsKIAogc3RydWN0IGRldmljZTsKIAotc3Ry
dWN0IGRtYV9idWYgKmRybV9nZW1fcHJpbWVfZXhwb3J0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYs
Ci0JCQkJICAgICBzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiwKLQkJCQkgICAgIGludCBmbGFn
cyk7CisvKiBjb3JlIHByaW1lIGZ1bmN0aW9ucyAqLworc3RydWN0IGRtYV9idWYgKmRybV9nZW1f
ZG1hYnVmX2V4cG9ydChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAorCQkJCSAgICAgIHN0cnVjdCBk
bWFfYnVmX2V4cG9ydF9pbmZvICpleHBfaW5mbyk7Cit2b2lkIGRybV9nZW1fZG1hYnVmX3JlbGVh
c2Uoc3RydWN0IGRtYV9idWYgKmRtYV9idWYpOworCitpbnQgZHJtX2dlbV9wcmltZV9mZF90b19o
YW5kbGUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKKwkJCSAgICAgICBzdHJ1Y3QgZHJtX2ZpbGUg
KmZpbGVfcHJpdiwgaW50IHByaW1lX2ZkLCB1aW50MzJfdCAqaGFuZGxlKTsKIGludCBkcm1fZ2Vt
X3ByaW1lX2hhbmRsZV90b19mZChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogCQkJICAgICAgIHN0
cnVjdCBkcm1fZmlsZSAqZmlsZV9wcml2LCB1aW50MzJfdCBoYW5kbGUsIHVpbnQzMl90IGZsYWdz
LAogCQkJICAgICAgIGludCAqcHJpbWVfZmQpOwotaW50IGRybV9nZW1fcHJpbWVfbW1hcChzdHJ1
Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiwgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpOwotc3Ry
dWN0IGRybV9nZW1fb2JqZWN0ICpkcm1fZ2VtX3ByaW1lX2ltcG9ydChzdHJ1Y3QgZHJtX2Rldmlj
ZSAqZGV2LAotCQkJCQkgICAgc3RydWN0IGRtYV9idWYgKmRtYV9idWYpOwotCi1zdHJ1Y3QgZHJt
X2dlbV9vYmplY3QgKmRybV9nZW1fcHJpbWVfaW1wb3J0X2RldihzdHJ1Y3QgZHJtX2RldmljZSAq
ZGV2LAotCQkJCQkJc3RydWN0IGRtYV9idWYgKmRtYV9idWYsCi0JCQkJCQlzdHJ1Y3QgZGV2aWNl
ICphdHRhY2hfZGV2KTsKIAotaW50IGRybV9nZW1fcHJpbWVfZmRfdG9faGFuZGxlKHN0cnVjdCBk
cm1fZGV2aWNlICpkZXYsCi0JCQkgICAgICAgc3RydWN0IGRybV9maWxlICpmaWxlX3ByaXYsIGlu
dCBwcmltZV9mZCwgdWludDMyX3QgKmhhbmRsZSk7Ci1zdHJ1Y3QgZG1hX2J1ZiAqZHJtX2dlbV9k
bWFidWZfZXhwb3J0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCi0JCQkJICAgICAgc3RydWN0IGRt
YV9idWZfZXhwb3J0X2luZm8gKmV4cF9pbmZvKTsKLXZvaWQgZHJtX2dlbV9kbWFidWZfcmVsZWFz
ZShzdHJ1Y3QgZG1hX2J1ZiAqZG1hX2J1Zik7CisvKiBoZWxwZXIgZnVuY3Rpb25zIGZvciBleHBv
cnRpbmcgKi8KIGludCBkcm1fZ2VtX21hcF9hdHRhY2goc3RydWN0IGRtYV9idWYgKmRtYV9idWYs
CiAJCSAgICAgICBzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhY2gpOwogdm9pZCBkcm1f
Z2VtX21hcF9kZXRhY2goc3RydWN0IGRtYV9idWYgKmRtYV9idWYsCkBAIC05NCwxMiArODYsMjYg
QEAgdm9pZCBkcm1fZ2VtX3VubWFwX2RtYV9idWYoc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAq
YXR0YWNoLAogCQkJICAgZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24gZGlyKTsKIHZvaWQgKmRybV9n
ZW1fZG1hYnVmX3ZtYXAoc3RydWN0IGRtYV9idWYgKmRtYV9idWYpOwogdm9pZCBkcm1fZ2VtX2Rt
YWJ1Zl92dW5tYXAoc3RydWN0IGRtYV9idWYgKmRtYV9idWYsIHZvaWQgKnZhZGRyKTsKKworaW50
IGRybV9nZW1fcHJpbWVfbW1hcChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiwgc3RydWN0IHZt
X2FyZWFfc3RydWN0ICp2bWEpOwogaW50IGRybV9nZW1fZG1hYnVmX21tYXAoc3RydWN0IGRtYV9i
dWYgKmRtYV9idWYsIHN0cnVjdCB2bV9hcmVhX3N0cnVjdCAqdm1hKTsKIAotaW50IGRybV9wcmlt
ZV9zZ190b19wYWdlX2FkZHJfYXJyYXlzKHN0cnVjdCBzZ190YWJsZSAqc2d0LCBzdHJ1Y3QgcGFn
ZSAqKnBhZ2VzLAotCQkJCSAgICAgZG1hX2FkZHJfdCAqYWRkcnMsIGludCBtYXhfcGFnZXMpOwog
c3RydWN0IHNnX3RhYmxlICpkcm1fcHJpbWVfcGFnZXNfdG9fc2coc3RydWN0IHBhZ2UgKipwYWdl
cywgdW5zaWduZWQgaW50IG5yX3BhZ2VzKTsKK3N0cnVjdCBkbWFfYnVmICpkcm1fZ2VtX3ByaW1l
X2V4cG9ydChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAorCQkJCSAgICAgc3RydWN0IGRybV9nZW1f
b2JqZWN0ICpvYmosCisJCQkJICAgICBpbnQgZmxhZ3MpOworCisvKiBoZWxwZXIgZnVuY3Rpb25z
IGZvciBpbXBvcnRpbmcgKi8KK3N0cnVjdCBkcm1fZ2VtX29iamVjdCAqZHJtX2dlbV9wcmltZV9p
bXBvcnRfZGV2KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCisJCQkJCQlzdHJ1Y3QgZG1hX2J1ZiAq
ZG1hX2J1ZiwKKwkJCQkJCXN0cnVjdCBkZXZpY2UgKmF0dGFjaF9kZXYpOworc3RydWN0IGRybV9n
ZW1fb2JqZWN0ICpkcm1fZ2VtX3ByaW1lX2ltcG9ydChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAor
CQkJCQkgICAgc3RydWN0IGRtYV9idWYgKmRtYV9idWYpOworCiB2b2lkIGRybV9wcmltZV9nZW1f
ZGVzdHJveShzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiwgc3RydWN0IHNnX3RhYmxlICpzZyk7
CiAKK2ludCBkcm1fcHJpbWVfc2dfdG9fcGFnZV9hZGRyX2FycmF5cyhzdHJ1Y3Qgc2dfdGFibGUg
KnNndCwgc3RydWN0IHBhZ2UgKipwYWdlcywKKwkJCQkgICAgIGRtYV9hZGRyX3QgKmFkZHJzLCBp
bnQgbWF4X3BhZ2VzKTsKKwogCiAjZW5kaWYgLyogX19EUk1fUFJJTUVfSF9fICovCi0tIAoyLjIw
LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1k
ZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczov
L2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
