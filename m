Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 8E0EEAA2BE
	for <lists+dri-devel@lfdr.de>; Thu,  5 Sep 2019 14:12:02 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7A5E46E0A6;
	Thu,  5 Sep 2019 12:12:00 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from foss.arm.com (foss.arm.com [217.140.110.172])
 by gabe.freedesktop.org (Postfix) with ESMTP id 8D1236E0A6
 for <dri-devel@lists.freedesktop.org>; Thu,  5 Sep 2019 12:11:59 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
 by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 06BB428;
 Thu,  5 Sep 2019 05:11:59 -0700 (PDT)
Received: from e112269-lin.arm.com (e112269-lin.cambridge.arm.com
 [10.1.196.133])
 by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id D4B983F718;
 Thu,  5 Sep 2019 05:11:57 -0700 (PDT)
From: Steven Price <steven.price@arm.com>
To: Rob Herring <robh@kernel.org>,
	Tomeu Vizoso <tomeu.vizoso@collabora.com>
Subject: [PATCH] drm/panfrost: Prevent race when handling page fault
Date: Thu,  5 Sep 2019 13:11:41 +0100
Message-Id: <20190905121141.42820-1-steven.price@arm.com>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, linux-kernel@vger.kernel.org,
 dri-devel@lists.freedesktop.org, Steven Price <steven.price@arm.com>,
 Alyssa Rosenzweig <alyssa.rosenzweig@collabora.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2hlbiBoYW5kbGluZyBhIEdQVSBwYWdlIGZhdWx0IGFkZHJfdG9fZHJtX21tX25vZGUoKSBpcyB1
c2VkIHRvCnRyYW5zbGF0ZSB0aGUgR1BVIGFkZHJlc3MgdG8gYSBidWZmZXIgb2JqZWN0LiBIb3dl
dmVyIGl0IGlzIHBvc3NpYmxlIGZvcgp0aGUgYnVmZmVyIG9iamVjdCB0byBiZSBmcmVlZCBhZnRl
ciB0aGUgZnVuY3Rpb24gaGFzIHJldHVybmVkIHJlc3VsdGluZwppbiBhIHVzZS1hZnRlci1mcmVl
IG9mIHRoZSBCTy4KCkNoYW5nZSBhZGRyX3RvX2RybV9tbV9ub2RlIHRvIHJldHVybiB0aGUgcGFu
ZnJvc3RfZ2VtX29iamVjdCB3aXRoIGFuCmV4dHJhIHJlZmVyZW5jZSBvbiBpdCwgcHJldmVudGlu
ZyB0aGUgQk8gZnJvbSBiZWluZyBmcmVlZCB1bnRpbCBhZnRlcgp0aGUgcGFnZSBmYXVsdCBoYXMg
YmVlbiBoYW5kbGVkLgoKU2lnbmVkLW9mZi1ieTogU3RldmVuIFByaWNlIDxzdGV2ZW4ucHJpY2VA
YXJtLmNvbT4KLS0tCgpJJ3ZlIG1hbmFnZWQgdG8gdHJpZ2dlciB0aGlzLCBnZW5lcmF0aW5nIHRo
ZSBmb2xsb3dpbmcgc3RhY2sgdHJhY2UuCgpVbmFibGUgdG8gaGFuZGxlIGtlcm5lbCBOVUxMIHBv
aW50ZXIgZGVyZWZlcmVuY2UgYXQgdmlydHVhbCBhZGRyZXNzIDAwMDAwMDkwCnBnZCA9IDMzYTZh
MTgxClswMDAwMDA5MF0gKnBnZD0wMDAwMDAwMApJbnRlcm5hbCBlcnJvcjogT29wczogNSBbIzFd
IFNNUCBBUk0KTW9kdWxlcyBsaW5rZWQgaW46CkNQVTogMCBQSUQ6IDgxIENvbW06IGlycS82MC1t
bXUgTm90IHRhaW50ZWQgNS4zLjAtcmMxKyAjNApIYXJkd2FyZSBuYW1lOiBSb2NrY2hpcCAoRGV2
aWNlIFRyZWUpClBDIGlzIGF0IHBhbmZyb3N0X21tdV9tYXBfZmF1bHRfYWRkcisweDE0MC8weDNh
MApMUiBpcyBhdCBfcmF3X3NwaW5fdW5sb2NrKzB4MjAvMHgzYwpwYyA6IFs8YzA1MDg5NDQ+XSAg
ICBsciA6IFs8YzA3Y2VkMTA+XSAgICBwc3I6IDIwMDMwMDEzCnNwIDogZWM2NDNlODggIGlwIDog
ZWE3MGNlMjQgIGZwIDogZWM1ZmU4NDAKcjEwOiAwMDAwMDAwMSAgcjkgOiAwMDAwMDAwMCAgcjgg
OiAwMDAxNzhjOQpyNyA6IDAwMDAwMDAwICByNiA6IDE3OGM5ZjAwICByNSA6IGVjNWZlOTQwICBy
NCA6IGVhNzBjZTA4CnIzIDogMDAwMDAwMDAgIHIyIDogMDAwMDAwMDAgIHIxIDogZWM2NDBlMDAg
IHIwIDogZWM1ZmU5NDAKRmxhZ3M6IG56Q3YgIElSUXMgb24gIEZJUXMgb24gIE1vZGUgU1ZDXzMy
ICBJU0EgQVJNICBTZWdtZW50IG5vbmUKQ29udHJvbDogMTBjNTM4N2QgIFRhYmxlOiAyOWY4NDA2
YSAgREFDOiAwMDAwMDA1MQpQcm9jZXNzIGlycS82MC1tbXUgKHBpZDogODEsIHN0YWNrIGxpbWl0
ID0gMHg0YjkwNzEwNikKU3RhY2s6ICgweGVjNjQzZTg4IHRvIDB4ZWM2NDQwMDApCjNlODA6ICAg
ICAgICAgICAgICAgICAgIGVjNjQwZTAwIGMwN2NlZGUwIGMwYzBiMjAwIGVjNjQwZTAwIDAwMDAw
MDAwIDAwMDAwMDAwCjNlYTA6IDAwMDE3OGM5IDAwMDAwMDAwIGMwYzBiMjAwIGMwN2NlZGUwIGVl
ZjkxMDQwIGVjNWZlODQwIDAwMDAwMDAxIDAwMDAwMDAwCjNlYzA6IDAwMDEwMDAxIDAxMDAwM2Mz
IDAwMDAwMGMzIDAwMDAwMDAxIDE3OGM5ZjAwIGMwNTA4Yzk4IGVlZjkxMDUwIDAwMDAwMDAwCjNl
ZTA6IGVjNjQzZjM0IGMwN2M5MTg4IDAwMDAwMDAxIGMwMTY3ODU0IDAwMDAwMDAwIGVjNjQzZWY4
IGMwYzA4NDQ4IGMwN2M5MzNjCjNmMDA6IDAwMDAwMDAwIGVjNjQzZjA0IGZmZmVmZmZlIDNkMTgy
YjE3IGVlMTkzNDY4IGVlMTkzNDAwIGVjNWRiM2MwIGVjNWRiM2MwCjNmMjA6IGMwMTgzODQwIGVj
NWRiM2U0IGMwY2IyODc0IGMwMTgzYjA4IDAwMDAwMDAxIGMwMTgzODVjIGZmZmZlMDAwIGVlMTkz
NDAwCjNmNDA6IGVjNWRiM2MwIGMwMTgzYjhjIGMwYzA4NDQ4IDAwMDAwMDAwIDYwMDAwMDEzIDAw
MDAwMDAwIGMwMTgzOWI4IDNkMTgyYjE3CjNmNjA6IGZmZmZlMDAwIGVjNWQwNTAwIGVjNWRiMzgw
IGVjNjQyMDAwIGVjNWRiM2MwIGMwMTgzYTY0IDAwMDAwMDAwIGVkMDI1Y2Q4CjNmODA6IGVjNWQw
NTM4IGMwMTQ2Y2ZjIGVjNjQyMDAwIGVjNWRiMzgwIGMwMTQ2YmMwIDAwMDAwMDAwIDAwMDAwMDAw
IDAwMDAwMDAwCjNmYTA6IDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIGMwMTAxMGI0IDAwMDAw
MDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwCjNmYzA6IDAwMDAwMDAwIDAwMDAwMDAwIDAw
MDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwCjNmZTA6
IDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDEzIDAwMDAwMDAwIDAw
MDAwMDAwIDAwMDAwMDAwCls8YzA1MDg5NDQ+XSAocGFuZnJvc3RfbW11X21hcF9mYXVsdF9hZGRy
KSBmcm9tIFs8YzA1MDhjOTg+XSAocGFuZnJvc3RfbW11X2lycV9oYW5kbGVyX3RocmVhZCsweGY0
LzB4MjQ4KQpbPGMwNTA4Yzk4Pl0gKHBhbmZyb3N0X21tdV9pcnFfaGFuZGxlcl90aHJlYWQpIGZy
b20gWzxjMDE4Mzg1Yz5dIChpcnFfdGhyZWFkX2ZuKzB4MWMvMHg1OCkKWzxjMDE4Mzg1Yz5dIChp
cnFfdGhyZWFkX2ZuKSBmcm9tIFs8YzAxODNiOGM+XSAoaXJxX3RocmVhZCsweDEyOC8weDI0MCkK
WzxjMDE4M2I4Yz5dIChpcnFfdGhyZWFkKSBmcm9tIFs8YzAxNDZjZmM+XSAoa3RocmVhZCsweDEz
Yy8weDE1NCkKWzxjMDE0NmNmYz5dIChrdGhyZWFkKSBmcm9tIFs8YzAxMDEwYjQ+XSAocmV0X2Zy
b21fZm9yaysweDE0LzB4MjApCkV4Y2VwdGlvbiBzdGFjaygweGVjNjQzZmIwIHRvIDB4ZWM2NDNm
ZjgpCjNmYTA6ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAwMDAwMDAwIDAw
MDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwCjNmYzA6IDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAw
IDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwCjNmZTA6IDAwMDAw
MDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDAwIDAwMDAwMDEzIDAwMDAwMDAwCkNvZGU6IDFh
ZmZmZmVjIGVhZmZmZmU4IGU1MTQzMDA0IGU1OWQyMDE0IChlNTkzMzA5MCkKLS0tWyBlbmQgdHJh
Y2UgMDRlYWRjMzAwOWI4ZjUwNyBdLS0tCi0tLQogZHJpdmVycy9ncHUvZHJtL3BhbmZyb3N0L3Bh
bmZyb3N0X21tdS5jIHwgMzggKysrKysrKysrKysrKysrKy0tLS0tLS0tLQogMSBmaWxlIGNoYW5n
ZWQsIDI0IGluc2VydGlvbnMoKyksIDE0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZl
cnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9tbXUuYyBiL2RyaXZlcnMvZ3B1L2RybS9wYW5m
cm9zdC9wYW5mcm9zdF9tbXUuYwppbmRleCA4NDJiZGQ3Y2Y2YmUuLjExNTkyNWU3NDYwYSAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3BhbmZyb3N0L3BhbmZyb3N0X21tdS5jCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9tbXUuYwpAQCAtMzkyLDkgKzM5MiwxMSBA
QCB2b2lkIHBhbmZyb3N0X21tdV9wZ3RhYmxlX2ZyZWUoc3RydWN0IHBhbmZyb3N0X2ZpbGVfcHJp
diAqcHJpdikKIAlmcmVlX2lvX3BndGFibGVfb3BzKG1tdS0+cGd0Ymxfb3BzKTsKIH0KIAotc3Rh
dGljIHN0cnVjdCBkcm1fbW1fbm9kZSAqYWRkcl90b19kcm1fbW1fbm9kZShzdHJ1Y3QgcGFuZnJv
c3RfZGV2aWNlICpwZmRldiwgaW50IGFzLCB1NjQgYWRkcikKK3N0YXRpYyBzdHJ1Y3QgcGFuZnJv
c3RfZ2VtX29iamVjdCAqCithZGRyX3RvX2RybV9tbV9ub2RlKHN0cnVjdCBwYW5mcm9zdF9kZXZp
Y2UgKnBmZGV2LCBpbnQgYXMsIHU2NCBhZGRyKQogewotCXN0cnVjdCBkcm1fbW1fbm9kZSAqbm9k
ZSA9IE5VTEw7CisJc3RydWN0IHBhbmZyb3N0X2dlbV9vYmplY3QgKmJvID0gTlVMTDsKKwlzdHJ1
Y3QgZHJtX21tX25vZGUgKm5vZGU7CiAJdTY0IG9mZnNldCA9IGFkZHIgPj4gUEFHRV9TSElGVDsK
IAlzdHJ1Y3QgcGFuZnJvc3RfbW11ICptbXU7CiAKQEAgLTQwNiwxNCArNDA4LDE3IEBAIHN0YXRp
YyBzdHJ1Y3QgZHJtX21tX25vZGUgKmFkZHJfdG9fZHJtX21tX25vZGUoc3RydWN0IHBhbmZyb3N0
X2RldmljZSAqcGZkZXYsIGluCiAKIAkJcHJpdiA9IGNvbnRhaW5lcl9vZihtbXUsIHN0cnVjdCBw
YW5mcm9zdF9maWxlX3ByaXYsIG1tdSk7CiAJCWRybV9tbV9mb3JfZWFjaF9ub2RlKG5vZGUsICZw
cml2LT5tbSkgewotCQkJaWYgKG9mZnNldCA+PSBub2RlLT5zdGFydCAmJiBvZmZzZXQgPCAobm9k
ZS0+c3RhcnQgKyBub2RlLT5zaXplKSkKKwkJCWlmIChvZmZzZXQgPj0gbm9kZS0+c3RhcnQgJiYK
KwkJCSAgICBvZmZzZXQgPCAobm9kZS0+c3RhcnQgKyBub2RlLT5zaXplKSkgeworCQkJCWJvID0g
ZHJtX21tX25vZGVfdG9fcGFuZnJvc3RfYm8obm9kZSk7CisJCQkJZHJtX2dlbV9vYmplY3RfZ2V0
KCZiby0+YmFzZS5iYXNlKTsKIAkJCQlnb3RvIG91dDsKKwkJCX0KIAkJfQogCX0KLQogb3V0Ogog
CXNwaW5fdW5sb2NrKCZwZmRldi0+YXNfbG9jayk7Ci0JcmV0dXJuIG5vZGU7CisJcmV0dXJuIGJv
OwogfQogCiAjZGVmaW5lIE5VTV9GQVVMVF9QQUdFUyAoU1pfMk0gLyBQQUdFX1NJWkUpCkBAIC00
MjEsMjkgKzQyNiwyOCBAQCBzdGF0aWMgc3RydWN0IGRybV9tbV9ub2RlICphZGRyX3RvX2RybV9t
bV9ub2RlKHN0cnVjdCBwYW5mcm9zdF9kZXZpY2UgKnBmZGV2LCBpbgogaW50IHBhbmZyb3N0X21t
dV9tYXBfZmF1bHRfYWRkcihzdHJ1Y3QgcGFuZnJvc3RfZGV2aWNlICpwZmRldiwgaW50IGFzLCB1
NjQgYWRkcikKIHsKIAlpbnQgcmV0LCBpOwotCXN0cnVjdCBkcm1fbW1fbm9kZSAqbm9kZTsKIAlz
dHJ1Y3QgcGFuZnJvc3RfZ2VtX29iamVjdCAqYm87CiAJc3RydWN0IGFkZHJlc3Nfc3BhY2UgKm1h
cHBpbmc7CiAJcGdvZmZfdCBwYWdlX29mZnNldDsKIAlzdHJ1Y3Qgc2dfdGFibGUgKnNndDsKIAlz
dHJ1Y3QgcGFnZSAqKnBhZ2VzOwogCi0Jbm9kZSA9IGFkZHJfdG9fZHJtX21tX25vZGUocGZkZXYs
IGFzLCBhZGRyKTsKLQlpZiAoIW5vZGUpCisJYm8gPSBhZGRyX3RvX2RybV9tbV9ub2RlKHBmZGV2
LCBhcywgYWRkcik7CisJaWYgKCFibykKIAkJcmV0dXJuIC1FTk9FTlQ7CiAKLQlibyA9IGRybV9t
bV9ub2RlX3RvX3BhbmZyb3N0X2JvKG5vZGUpOwogCWlmICghYm8tPmlzX2hlYXApIHsKIAkJZGV2
X1dBUk4ocGZkZXYtPmRldiwgIm1hdGNoaW5nIEJPIGlzIG5vdCBoZWFwIHR5cGUgKEdQVSBWQSA9
ICVsbHgpIiwKLQkJCSBub2RlLT5zdGFydCA8PCBQQUdFX1NISUZUKTsKLQkJcmV0dXJuIC1FSU5W
QUw7CisJCQkgYm8tPm5vZGUuc3RhcnQgPDwgUEFHRV9TSElGVCk7CisJCXJldCA9IC1FSU5WQUw7
CisJCWdvdG8gZXJyX2JvOwogCX0KIAlXQVJOX09OKGJvLT5tbXUtPmFzICE9IGFzKTsKIAogCS8q
IEFzc3VtZSAyTUIgYWxpZ25tZW50IGFuZCBzaXplIG11bHRpcGxlICovCiAJYWRkciAmPSB+KCh1
NjQpU1pfMk0gLSAxKTsKIAlwYWdlX29mZnNldCA9IGFkZHIgPj4gUEFHRV9TSElGVDsKLQlwYWdl
X29mZnNldCAtPSBub2RlLT5zdGFydDsKKwlwYWdlX29mZnNldCAtPSBiby0+bm9kZS5zdGFydDsK
IAogCW11dGV4X2xvY2soJmJvLT5iYXNlLnBhZ2VzX2xvY2spOwogCkBAIC00NTIsNyArNDU2LDgg
QEAgaW50IHBhbmZyb3N0X21tdV9tYXBfZmF1bHRfYWRkcihzdHJ1Y3QgcGFuZnJvc3RfZGV2aWNl
ICpwZmRldiwgaW50IGFzLCB1NjQgYWRkcikKIAkJCQkgICAgIHNpemVvZihzdHJ1Y3Qgc2dfdGFi
bGUpLCBHRlBfS0VSTkVMIHwgX19HRlBfWkVSTyk7CiAJCWlmICghYm8tPnNndHMpIHsKIAkJCW11
dGV4X3VubG9jaygmYm8tPmJhc2UucGFnZXNfbG9jayk7Ci0JCQlyZXR1cm4gLUVOT01FTTsKKwkJ
CXJldCA9IC1FTk9NRU07CisJCQlnb3RvIGVycl9ibzsKIAkJfQogCiAJCXBhZ2VzID0ga3ZtYWxs
b2NfYXJyYXkoYm8tPmJhc2UuYmFzZS5zaXplID4+IFBBR0VfU0hJRlQsCkBAIC00NjEsNyArNDY2
LDggQEAgaW50IHBhbmZyb3N0X21tdV9tYXBfZmF1bHRfYWRkcihzdHJ1Y3QgcGFuZnJvc3RfZGV2
aWNlICpwZmRldiwgaW50IGFzLCB1NjQgYWRkcikKIAkJCWtmcmVlKGJvLT5zZ3RzKTsKIAkJCWJv
LT5zZ3RzID0gTlVMTDsKIAkJCW11dGV4X3VubG9jaygmYm8tPmJhc2UucGFnZXNfbG9jayk7Ci0J
CQlyZXR1cm4gLUVOT01FTTsKKwkJCXJldCA9IC1FTk9NRU07CisJCQlnb3RvIGVycl9ibzsKIAkJ
fQogCQliby0+YmFzZS5wYWdlcyA9IHBhZ2VzOwogCQliby0+YmFzZS5wYWdlc191c2VfY291bnQg
PSAxOwpAQCAtNDk5LDEyICs1MDUsMTYgQEAgaW50IHBhbmZyb3N0X21tdV9tYXBfZmF1bHRfYWRk
cihzdHJ1Y3QgcGFuZnJvc3RfZGV2aWNlICpwZmRldiwgaW50IGFzLCB1NjQgYWRkcikKIAogCWRl
dl9kYmcocGZkZXYtPmRldiwgIm1hcHBlZCBwYWdlIGZhdWx0IEAgQVMlZCAlbGx4IiwgYXMsIGFk
ZHIpOwogCisJZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKCZiby0+YmFzZS5iYXNlKTsKKwog
CXJldHVybiAwOwogCiBlcnJfbWFwOgogCXNnX2ZyZWVfdGFibGUoc2d0KTsKIGVycl9wYWdlczoK
IAlkcm1fZ2VtX3NobWVtX3B1dF9wYWdlcygmYm8tPmJhc2UpOworZXJyX2JvOgorCWRybV9nZW1f
b2JqZWN0X3B1dF91bmxvY2tlZCgmYm8tPmJhc2UuYmFzZSk7CiAJcmV0dXJuIHJldDsKIH0KIAot
LSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
XwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcK
aHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
