Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id F0E781AE608
	for <lists+dri-devel@lfdr.de>; Fri, 17 Apr 2020 21:42:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 54A0D6E86E;
	Fri, 17 Apr 2020 19:42:38 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from us-smtp-delivery-1.mimecast.com (us-smtp-1.mimecast.com
 [207.211.31.81])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4BDE56E85E
 for <dri-devel@lists.freedesktop.org>; Fri, 17 Apr 2020 19:42:36 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
 s=mimecast20190719; t=1587152555;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=HQHNAYRwAh0SATyuoWLet2QKkrhrh3yzPiTWdLmXyM0=;
 b=JLnmOUmAh5N2uc4YSCjfGrkPY9dz2axUtctlLoadi6xDUhRKE64eS/7SNCP/pq6s532PKy
 VUq2pZUUyOs/fFZDGJ0MXw+w6EUC/4FUOZwMAwCPtmDnLYDj5yt5r7OjI8fbVUjU+Ln6MC
 AaoNiapQaXm04JkhDmBFGw1+sA3gGW4=
Received: from mimecast-mx01.redhat.com (mimecast-mx01.redhat.com
 [209.132.183.4]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-117-5t1BYcikMBKA7uZfFgtXjg-1; Fri, 17 Apr 2020 15:42:31 -0400
X-MC-Unique: 5t1BYcikMBKA7uZfFgtXjg-1
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
 [10.5.11.14])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mimecast-mx01.redhat.com (Postfix) with ESMTPS id C3F0E1926DA0;
 Fri, 17 Apr 2020 19:42:29 +0000 (UTC)
Received: from Ruby.redhat.com (ovpn-114-140.rdu2.redhat.com [10.10.114.140])
 by smtp.corp.redhat.com (Postfix) with ESMTP id B4E5E5D9CA;
 Fri, 17 Apr 2020 19:42:28 +0000 (UTC)
From: Lyude Paul <lyude@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [RFC v3 03/11] drm/vblank: Add vblank works
Date: Fri, 17 Apr 2020 15:40:50 -0400
Message-Id: <20200417194145.36350-4-lyude@redhat.com>
In-Reply-To: <20200417194145.36350-1-lyude@redhat.com>
References: <20200417194145.36350-1-lyude@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, linux-kernel@vger.kernel.org,
 Thomas Zimmermann <tzimmermann@suse.de>, Tejun Heo <tj@kernel.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

QWRkIHNvbWUga2luZCBvZiB2Ymxhbmsgd29ya2Vycy4gVGhlIGludGVyZmFjZSBpcyBzaW1pbGFy
IHRvIHJlZ3VsYXIKZGVsYXllZCB3b3JrcywgYW5kIGlzIG1vc3RseSBiYXNlZCBvZmYga3RocmVh
ZF93b3JrLiBJdCBhbGxvd3MgZm9yCnNjaGVkdWxpbmcgZGVsYXllZCB3b3JrcyB0aGF0IGV4ZWN1
dGUgb25jZSBhIHBhcnRpY3VsYXIgdmJsYW5rIHNlcXVlbmNlCmhhcyBwYXNzZWQuIEl0IGFsc28g
YWxsb3dzIGZvciBhY2N1cmF0ZSBmbHVzaGluZyBvZiBzY2hlZHVsZWQgdmJsYW5rCndvcmtzIC0g
aW4gdGhhdCBmbHVzaGluZyB3YWl0cyBmb3IgYm90aCB0aGUgdmJsYW5rIHNlcXVlbmNlIGFuZCBq
b2IKZXhlY3V0aW9uIHRvIGNvbXBsZXRlLCBvciBmb3IgdGhlIHdvcmsgdG8gZ2V0IGNhbmNlbGxl
ZCAtIHdoaWNoZXZlcgpjb21lcyBmaXJzdC4KCldoYXRldmVyIGhhcmR3YXJlIHByb2dyYW1taW5n
IHdlIGRvIGluIHRoZSB3b3JrIG11c3QgYmUgZmFzdCAobXVzdCBhdApsZWFzdCBjb21wbGV0ZSBk
dXJpbmcgdGhlIHZibGFuayBvciBzY2Fub3V0IHBlcmlvZCwgc29tZXRpbWVzIGR1cmluZyB0aGUK
Zmlyc3QgZmV3IHNjYW5saW5lcyBvZiB0aGUgdmJsYW5rKS4gQXMgc3VjaCB3ZSB1c2UgYSBoaWdo
LXByaW9yaXR5CnBlci1DUlRDIHRocmVhZCB0byBhY2NvbXBsaXNoIHRoaXMuCgpbYmFzZWQgb2Zm
IHBhdGNoZXMgZnJvbSBWaWxsZSBTeXJqw6Rsw6QgPHZpbGxlLnN5cmphbGFAbGludXguaW50ZWwu
Y29tPiwKY2hhbmdlIGJlbG93IHRvIHNpZ25vZmYgbGF0ZXJdCgpDaGFuZ2VzIHNpbmNlIHYyOgoq
IFVzZSBrdGhyZWFkX3dvcmtlcnMgaW5zdGVhZCBvZiByZWludmVudGluZyB0aGUgd2hlZWwuCgpD
YzogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4KQ2M6IFRl
anVuIEhlbyA8dGpAa2VybmVsLm9yZz4KU2lnbmVkLW9mZi1ieTogTHl1ZGUgUGF1bCA8bHl1ZGVA
cmVkaGF0LmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vZHJtX3ZibGFuay5jIHwgMjk2ICsrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKystCiBpbmNsdWRlL2RybS9kcm1fdmJsYW5rLmgg
ICAgIHwgIDMxICsrKysKIDIgZmlsZXMgY2hhbmdlZCwgMzI2IGluc2VydGlvbnMoKyksIDEgZGVs
ZXRpb24oLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vZHJtX3ZibGFuay5jIGIvZHJp
dmVycy9ncHUvZHJtL2RybV92YmxhbmsuYwppbmRleCBiZjhkZTEwYzEzMWYuLmVkMGFlM2Q3OGI2
OSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2RybV92YmxhbmsuYworKysgYi9kcml2ZXJz
L2dwdS9kcm0vZHJtX3ZibGFuay5jCkBAIC0yNSw3ICsyNSw5IEBACiAgKi8KIAogI2luY2x1ZGUg
PGxpbnV4L2V4cG9ydC5oPgorI2luY2x1ZGUgPGxpbnV4L2t0aHJlYWQuaD4KICNpbmNsdWRlIDxs
aW51eC9tb2R1bGVwYXJhbS5oPgorI2luY2x1ZGUgPHVhcGkvbGludXgvc2NoZWQvdHlwZXMuaD4K
IAogI2luY2x1ZGUgPGRybS9kcm1fY3J0Yy5oPgogI2luY2x1ZGUgPGRybS9kcm1fZHJ2Lmg+CkBA
IC0xNTUsNiArMTU3LDcgQEAKIHN0YXRpYyBib29sCiBkcm1fZ2V0X2xhc3RfdmJsdGltZXN0YW1w
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHVuc2lnbmVkIGludCBwaXBlLAogCQkJICBrdGltZV90
ICp0dmJsYW5rLCBib29sIGluX3ZibGFua19pcnEpOworc3RhdGljIGludCBkcm1fdmJsYW5rX2dl
dChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB1bnNpZ25lZCBpbnQgcGlwZSk7CiAKIHN0YXRpYyB1
bnNpZ25lZCBpbnQgZHJtX3RpbWVzdGFtcF9wcmVjaXNpb24gPSAyMDsgIC8qIERlZmF1bHQgdG8g
MjAgdXNlY3MuICovCiAKQEAgLTQ5Niw5ICs0OTksNDkgQEAgc3RhdGljIHZvaWQgZHJtX3ZibGFu
a19pbml0X3JlbGVhc2Uoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqcHRyKQogCVdBUk5f
T04oUkVBRF9PTkNFKHZibGFuay0+ZW5hYmxlZCkgJiYKIAkJZHJtX2NvcmVfY2hlY2tfZmVhdHVy
ZShkZXYsIERSSVZFUl9NT0RFU0VUKSk7CiAKKwlrdGhyZWFkX2Rlc3Ryb3lfd29ya2VyKHZibGFu
ay0+d29ya2VyKTsKIAlkZWxfdGltZXJfc3luYygmdmJsYW5rLT5kaXNhYmxlX3RpbWVyKTsKIH0K
IAorLyoqCisgKiBkcm1fdmJsYW5rX3dvcmtfaW5pdCAtIGluaXRpYWxpemUgYSB2Ymxhbmsgd29y
ayBpdGVtCisgKiBAd29yazogdmJsYW5rIHdvcmsgaXRlbQorICogQGNydGM6IENSVEMgd2hvc2Ug
dmJsYW5rIHdpbGwgdHJpZ2dlciB0aGUgd29yayBleGVjdXRpb24KKyAqIEBmdW5jOiB3b3JrIGZ1
bmN0aW9uIHRvIGJlIGV4ZWN1dGVkCisgKgorICogSW5pdGlhbGl6ZSBhIHZibGFuayB3b3JrIGl0
ZW0gZm9yIGEgc3BlY2lmaWMgY3J0Yy4KKyAqLwordm9pZCBkcm1fdmJsYW5rX3dvcmtfaW5pdChz
dHJ1Y3QgZHJtX3ZibGFua193b3JrICp3b3JrLCBzdHJ1Y3QgZHJtX2NydGMgKmNydGMsCisJCQkg
IHZvaWQgKCpmdW5jKShzdHJ1Y3Qga3RocmVhZF93b3JrICp3b3JrKSkKK3sKKwlrdGhyZWFkX2lu
aXRfd29yaygmd29yay0+YmFzZSwgZnVuYyk7CisJSU5JVF9MSVNUX0hFQUQoJndvcmstPmZsdXNo
ZXJzKTsKKwlJTklUX0xJU1RfSEVBRCgmd29yay0+cGVuZGluZyk7CisJd29yay0+dmJsYW5rID0g
JmNydGMtPmRldi0+dmJsYW5rW2RybV9jcnRjX2luZGV4KGNydGMpXTsKK30KK0VYUE9SVF9TWU1C
T0woZHJtX3ZibGFua193b3JrX2luaXQpOworCitzdGF0aWMgaW50IHZibGFua193b3JrZXJfaW5p
dChzdHJ1Y3QgZHJtX3ZibGFua19jcnRjICp2YmxhbmspCit7CisJc3RydWN0IHNjaGVkX3BhcmFt
IHBhcmFtID0geworCQkuc2NoZWRfcHJpb3JpdHkgPSBNQVhfUlRfUFJJTyAtIDEsCisJfTsKKwlp
bnQgcmV0OworCisJSU5JVF9MSVNUX0hFQUQoJnZibGFuay0+cGVuZGluZ193b3JrKTsKKwl2Ymxh
bmstPndvcmtlciA9IGt0aHJlYWRfY3JlYXRlX3dvcmtlcigwLCAiY2FyZCVkLWNydGMlZCIsCisJ
CQkJCSAgICAgICB2YmxhbmstPmRldi0+cHJpbWFyeS0+aW5kZXgsCisJCQkJCSAgICAgICB2Ymxh
bmstPnBpcGUpOworCWlmIChJU19FUlIodmJsYW5rLT53b3JrZXIpKQorCQlyZXR1cm4gUFRSX0VS
Uih2YmxhbmstPndvcmtlcik7CisKKwlyZXQgPSBzY2hlZF9zZXRzY2hlZHVsZXIodmJsYW5rLT53
b3JrZXItPnRhc2ssIFNDSEVEX0ZJRk8sICZwYXJhbSk7CisJaWYgKHJldCA8IDApCisJCWt0aHJl
YWRfZGVzdHJveV93b3JrZXIodmJsYW5rLT53b3JrZXIpOworCisJcmV0dXJuIHJldDsKK30KKwog
LyoqCiAgKiBkcm1fdmJsYW5rX2luaXQgLSBpbml0aWFsaXplIHZibGFuayBzdXBwb3J0CiAgKiBA
ZGV2OiBEUk0gZGV2aWNlCkBAIC01MzQsMTEgKzU3NywxNyBAQCBpbnQgZHJtX3ZibGFua19pbml0
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHVuc2lnbmVkIGludCBudW1fY3J0Y3MpCiAJCXRpbWVy
X3NldHVwKCZ2YmxhbmstPmRpc2FibGVfdGltZXIsIHZibGFua19kaXNhYmxlX2ZuLCAwKTsKIAkJ
c2VxbG9ja19pbml0KCZ2YmxhbmstPnNlcWxvY2spOwogCi0JCXJldCA9IGRybW1fYWRkX2FjdGlv
bihkZXYsIGRybV92YmxhbmtfaW5pdF9yZWxlYXNlLCB2YmxhbmspOworCQlyZXQgPSB2Ymxhbmtf
d29ya2VyX2luaXQodmJsYW5rKTsKIAkJaWYgKHJldCkgewogCQkJZGVsX3RpbWVyX3N5bmMoJnZi
bGFuay0+ZGlzYWJsZV90aW1lcik7CiAJCQlyZXR1cm4gcmV0OwogCQl9CisKKwkJcmV0ID0gZHJt
bV9hZGRfYWN0aW9uKGRldiwgZHJtX3ZibGFua19pbml0X3JlbGVhc2UsIHZibGFuayk7CisJCWlm
IChyZXQpIHsKKwkJCWRybV92YmxhbmtfaW5pdF9yZWxlYXNlKGRldiwgdmJsYW5rKTsKKwkJCXJl
dHVybiByZXQ7CisJCX0KIAl9CiAKIAlEUk1fSU5GTygiU3VwcG9ydHMgdmJsYW5rIHRpbWVzdGFt
cCBjYWNoaW5nIFJldiAyICgyMS4xMC4yMDEzKS5cbiIpOwpAQCAtMTg3OSw2ICsxOTI4LDQ4IEBA
IHN0YXRpYyB2b2lkIGRybV9oYW5kbGVfdmJsYW5rX2V2ZW50cyhzdHJ1Y3QgZHJtX2RldmljZSAq
ZGV2LCB1bnNpZ25lZCBpbnQgcGlwZSkKIAl0cmFjZV9kcm1fdmJsYW5rX2V2ZW50KHBpcGUsIHNl
cSwgbm93LCBoaWdoX3ByZWMpOwogfQogCitzdHJ1Y3QgZHJtX3ZibGFua19mbHVzaF93b3JrIHsK
KwlzdHJ1Y3Qga3RocmVhZF93b3JrIGJhc2U7CisJc3RydWN0IGNvbXBsZXRpb24gZG9uZTsKK307
CisKKy8qIEFkZCBhIHZibGFuayB3b3JrIGFsb25nIHdpdGggYW55IHBlbmRpbmcgZmx1c2hlcyB0
byB0aGUga3RocmVhZF93b3JrZXIgKi8KK3N0YXRpYyB2b2lkIHF1ZXVlX3ZibGFua193b3JrKHN0
cnVjdCBkcm1fdmJsYW5rX2NydGMgKnZibGFuaywKKwkJCSAgICAgIHN0cnVjdCBkcm1fdmJsYW5r
X3dvcmsgKndvcmspCit7CisJc3RydWN0IGRybV92YmxhbmtfZmx1c2hfd29yayAqcG9zLCAqdG1w
OworCisJX19rdGhyZWFkX3F1ZXVlX3dvcmsodmJsYW5rLT53b3JrZXIsICZ3b3JrLT5iYXNlLAor
CQkJICAgICAmdmJsYW5rLT53b3JrZXItPndvcmtfbGlzdCk7CisKKwlsaXN0X2Zvcl9lYWNoX2Vu
dHJ5X3NhZmUocG9zLCB0bXAsICZ3b3JrLT5mbHVzaGVycywgYmFzZS5ub2RlKSB7CisJCWxpc3Rf
ZGVsX2luaXQoJndvcmstPmJhc2Uubm9kZSk7CisJCV9fa3RocmVhZF9xdWV1ZV93b3JrKHZibGFu
ay0+d29ya2VyLCAmcG9zLT5iYXNlLAorCQkJCSAgICAgd29yay0+YmFzZS5ub2RlLm5leHQpOwor
CX0KK30KKworc3RhdGljIGlubGluZSB2b2lkIGRybV9oYW5kbGVfdmJsYW5rX3dvcmtzKHN0cnVj
dCBkcm1fdmJsYW5rX2NydGMgKnZibGFuaykKK3sKKwlzdHJ1Y3QgZHJtX3ZibGFua193b3JrICp3
b3JrLCAqbmV4dDsKKwl1NjQgY291bnQgPSBhdG9taWM2NF9yZWFkKCZ2YmxhbmstPmNvdW50KTsK
KwlpbnQgcHV0X2NvdW50ID0gMCwgaTsKKworCXJhd19zcGluX2xvY2soJnZibGFuay0+d29ya2Vy
LT5sb2NrKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUod29yaywgbmV4dCwgJnZibGFuay0+
cGVuZGluZ193b3JrLCBwZW5kaW5nKSB7CisJCWlmICghdmJsYW5rX3Bhc3NlZChjb3VudCwgd29y
ay0+Y291bnQpKQorCQkJY29udGludWU7CisKKwkJcHV0X2NvdW50Kys7CisJCWxpc3RfZGVsX2lu
aXQoJndvcmstPnBlbmRpbmcpOworCQlxdWV1ZV92Ymxhbmtfd29yayh2YmxhbmssIHdvcmspOwor
CX0KKwlyYXdfc3Bpbl91bmxvY2soJnZibGFuay0+d29ya2VyLT5sb2NrKTsKKworCWZvciAoaSA9
IDA7IGkgPCBwdXRfY291bnQ7IGkrKykKKwkJZHJtX3ZibGFua19wdXQodmJsYW5rLT5kZXYsIHZi
bGFuay0+cGlwZSk7Cit9CisKIC8qKgogICogZHJtX2hhbmRsZV92YmxhbmsgLSBoYW5kbGUgYSB2
YmxhbmsgZXZlbnQKICAqIEBkZXY6IERSTSBkZXZpY2UKQEAgLTE5MjAsNiArMjAxMSw3IEBAIGJv
b2wgZHJtX2hhbmRsZV92Ymxhbmsoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdW5zaWduZWQgaW50
IHBpcGUpCiAKIAlzcGluX3VubG9jaygmZGV2LT52YmxhbmtfdGltZV9sb2NrKTsKIAorCWRybV9o
YW5kbGVfdmJsYW5rX3dvcmtzKHZibGFuayk7CiAJd2FrZV91cCgmdmJsYW5rLT5xdWV1ZSk7CiAK
IAkvKiBXaXRoIGluc3RhbnQtb2ZmLCB3ZSBkZWZlciBkaXNhYmxpbmcgdGhlIGludGVycnVwdCB1
bnRpbCBhZnRlcgpAQCAtMjEzMCwzICsyMjIyLDIwNSBAQCBpbnQgZHJtX2NydGNfcXVldWVfc2Vx
dWVuY2VfaW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAlrZnJlZShl
KTsKIAlyZXR1cm4gcmV0OwogfQorCisvKioKKyAqIGRybV92Ymxhbmtfd29ya19zY2hlZHVsZSAt
IHNjaGVkdWxlIGEgdmJsYW5rIHdvcmsKKyAqIEB3b3JrOiB2Ymxhbmsgd29yayB0byBzY2hlZHVs
ZQorICogQGNvdW50OiB0YXJnZXQgdmJsYW5rIGNvdW50CisgKiBAbmV4dG9ubWlzczogZGVmZXIg
dW50aWwgdGhlIG5leHQgdmJsYW5rIGlmIHRhcmdldCB2Ymxhbmsgd2FzIG1pc3NlZAorICoKKyAq
IFNjaGVkdWxlIEB3b3JrIGZvciBleGVjdXRpb24gb25jZSB0aGUgY3J0YyB2YmxhbmsgY291bnQg
cmVhY2hlcyBAY291bnQuCisgKgorICogSWYgdGhlIGNydGMgdmJsYW5rIGNvdW50IGhhcyBhbHJl
YWR5IHJlYWNoZWQgQGNvdW50IGFuZCBAbmV4dG9ubWlzcyBpcworICogJWZhbHNlIHRoZSB3b3Jr
IHN0YXJ0cyB0byBleGVjdXRlIGltbWVkaWF0ZWx5LgorICoKKyAqIElmIHRoZSBjcnRjIHZibGFu
ayBjb3VudCBoYXMgYWxyZWFkeSByZWFjaGVkIEBjb3VudCBhbmQgQG5leHRvbm1pc3MgaXMKKyAq
ICV0cnVlIHRoZSB3b3JrIGlzIGRlZmVycmVkIHVudGlsIHRoZSBuZXh0IHZibGFuayAoYXMgaWYg
QGNvdW50IGhhcyBiZWVuCisgKiBzcGVjaWZpZWQgYXMgY3J0YyB2YmxhbmsgY291bnQgKyAxKS4K
KyAqCisgKiBJZiBAd29yayBpcyBhbHJlYWR5IHNjaGVkdWxlZCwgdGhpcyBmdW5jdGlvbiB3aWxs
IHJlc2NoZWR1bGUgc2FpZCB3b3JrCisgKiB1c2luZyB0aGUgbmV3IEBjb3VudC4KKyAqCisgKiBS
ZXR1cm5zOgorICogMCBvbiBzdWNjZXNzLCBlcnJvciBjb2RlIG9uIGZhaWx1cmUuCisgKi8KK2lu
dCBkcm1fdmJsYW5rX3dvcmtfc2NoZWR1bGUoc3RydWN0IGRybV92Ymxhbmtfd29yayAqd29yaywK
KwkJCSAgICAgdTY0IGNvdW50LCBib29sIG5leHRvbm1pc3MpCit7CisJc3RydWN0IGRybV92Ymxh
bmtfY3J0YyAqdmJsYW5rID0gd29yay0+dmJsYW5rOworCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYg
PSB2YmxhbmstPmRldjsKKwl1NjQgY3VyX3ZibDsKKwl1bnNpZ25lZCBsb25nIGlycWZsYWdzOwor
CWJvb2wgcGFzc2VkLCByZXNjaGVkdWxpbmcgPSBmYWxzZTsKKwlpbnQgcmV0ID0gMDsKKworCS8q
IEdyYWIgb3VyIHZibGFuayByZWYgZWFybHksIHNpbmNlIHRoYXQgZ3JhYnMgc3BpbmxvY2tzICov
CisJcmV0ID0gZHJtX3ZibGFua19nZXQoZGV2LCB2YmxhbmstPnBpcGUpOworCWlmIChyZXQgPCAw
KQorCQlyZXR1cm4gcmV0OworCisJcmF3X3NwaW5fbG9ja19pcnFzYXZlKCZ2YmxhbmstPndvcmtl
ci0+bG9jaywgaXJxZmxhZ3MpOworCisJaWYgKHdvcmstPmJhc2UuY2FuY2VsaW5nKQorCQlnb3Rv
IG91dDsKKworCWlmIChsaXN0X2VtcHR5KCZ3b3JrLT5wZW5kaW5nKSkKKwkJYXRvbWljX2luYygm
dmJsYW5rLT5yZWZjb3VudCk7CisJZWxzZSBpZiAod29yay0+Y291bnQgPT0gY291bnQpIC8qIEFs
cmVhZHkgc2NoZWR1bGVkIHcvIHNhbWUgdmJsIGNvdW50ICovCisJCWdvdG8gb3V0OworCWVsc2UK
KwkJcmVzY2hlZHVsaW5nID0gdHJ1ZTsKKworCXdvcmstPmNvdW50ID0gY291bnQ7CisJY3VyX3Zi
bCA9IGF0b21pYzY0X3JlYWQoJnZibGFuay0+Y291bnQpOworCXBhc3NlZCA9IHZibGFua19wYXNz
ZWQoY3VyX3ZibCwgY291bnQpOworCWlmIChwYXNzZWQpCisJCURSTV9FUlJPUigiY3J0YyAlZCB2
YmxhbmsgJWxsdSBhbHJlYWR5IHBhc3NlZCAoY3VycmVudCAlbGx1KVxuIiwKKwkJCSAgdmJsYW5r
LT5waXBlLCBjb3VudCwgY3VyX3ZibCk7CisKKwlpZiAoIW5leHRvbm1pc3MgJiYgcGFzc2VkKSB7
CisJCWF0b21pY19kZWMoJnZibGFuay0+cmVmY291bnQpOworCQlpZiAocmVzY2hlZHVsaW5nKQor
CQkJbGlzdF9kZWxfaW5pdCgmd29yay0+cGVuZGluZyk7CisJCXF1ZXVlX3ZibGFua193b3JrKHZi
bGFuaywgd29yayk7CisJfSBlbHNlIHsKKwkJaWYgKHJlc2NoZWR1bGluZykKKwkJCWxpc3RfbW92
ZV90YWlsKCZ3b3JrLT5wZW5kaW5nLCAmdmJsYW5rLT5wZW5kaW5nX3dvcmspOworCQllbHNlCisJ
CQlsaXN0X2FkZF90YWlsKCZ3b3JrLT5wZW5kaW5nLCAmdmJsYW5rLT5wZW5kaW5nX3dvcmspOwor
CX0KKworIG91dDoKKwlyYXdfc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmdmJsYW5rLT53b3JrZXIt
PmxvY2ssIGlycWZsYWdzKTsKKwlkcm1fdmJsYW5rX3B1dChkZXYsIHZibGFuay0+cGlwZSk7CisK
KwlyZXR1cm4gcmV0OworfQorRVhQT1JUX1NZTUJPTChkcm1fdmJsYW5rX3dvcmtfc2NoZWR1bGUp
OworCitzdGF0aWMgYm9vbCB2Ymxhbmtfd29ya19jYW5jZWwoc3RydWN0IGRybV92Ymxhbmtfd29y
ayAqd29yaykKK3sKKwlzdHJ1Y3QgZHJtX3ZibGFua19mbHVzaF93b3JrICpwb3MsICp0bXA7CisK
KwlpZiAobGlzdF9lbXB0eSgmd29yay0+cGVuZGluZykpCisJCXJldHVybiBmYWxzZTsKKworCWxp
c3RfZGVsX2luaXQoJndvcmstPnBlbmRpbmcpOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZl
KHBvcywgdG1wLCAmd29yay0+Zmx1c2hlcnMsIGJhc2Uubm9kZSkgeworCQlsaXN0X2RlbCgmcG9z
LT5iYXNlLm5vZGUpOworCQljb21wbGV0ZSgmcG9zLT5kb25lKTsKKwl9CisKKwlyZXR1cm4gdHJ1
ZTsKK30KKworLyoqCisgKiBkcm1fdmJsYW5rX3dvcmtfY2FuY2VsIC0gY2FuY2VsIGEgdmJsYW5r
IHdvcmsKKyAqIEB3b3JrOiB2Ymxhbmsgd29yayB0byBjYW5jZWwKKyAqCisgKiBDYW5jZWwgYW4g
YWxyZWFkeSBzY2hlZHVsZWQgdmJsYW5rIHdvcmsuCisgKgorICogT24gcmV0dXJuIEB3b3JrIG1h
eSBzdGlsbCBiZSBleGVjdXRpbmcsIHVubGVzcyB0aGUgcmV0dXJuCisgKiB2YWx1ZSBpcyAldHJ1
ZS4KKyAqCisgKiBSZXR1cm5zOgorICogVHJ1ZSBpZiB0aGUgd29yayB3YXMgY2FuY2VsbGVkIGJl
Zm9yZSBpdCBzdGFydGVkIHRvIGV4Y3V0ZSwgZmFsc2Ugb3RoZXJ3aXNlLgorICovCitib29sIGRy
bV92Ymxhbmtfd29ya19jYW5jZWwoc3RydWN0IGRybV92Ymxhbmtfd29yayAqd29yaykKK3sKKwlz
dHJ1Y3QgZHJtX3ZibGFua19jcnRjICp2YmxhbmsgPSB3b3JrLT52Ymxhbms7CisJYm9vbCBjYW5j
ZWxsZWQ7CisKKwlyYXdfc3Bpbl9sb2NrX2lycSgmdmJsYW5rLT53b3JrZXItPmxvY2spOworCWNh
bmNlbGxlZCA9IHZibGFua193b3JrX2NhbmNlbCh3b3JrKTsKKwlyYXdfc3Bpbl91bmxvY2tfaXJx
KCZ2YmxhbmstPndvcmtlci0+bG9jayk7CisJaWYgKGNhbmNlbGxlZCkKKwkJZHJtX3ZibGFua19w
dXQodmJsYW5rLT5kZXYsIHZibGFuay0+cGlwZSk7CisKKwlyZXR1cm4gY2FuY2VsbGVkOworfQor
RVhQT1JUX1NZTUJPTChkcm1fdmJsYW5rX3dvcmtfY2FuY2VsKTsKKworLyoqCisgKiBkcm1fdmJs
YW5rX3dvcmtfY2FuY2VsX3N5bmMgLSBjYW5jZWwgYSB2Ymxhbmsgd29yayBhbmQgd2FpdCBmb3Ig
aXQgdG8KKyAqIGZpbmlzaCBleGVjdXRpbmcKKyAqIEB3b3JrOiB2Ymxhbmsgd29yayB0byBjYW5j
ZWwKKyAqCisgKiBDYW5jZWwgYW4gYWxyZWFkeSBzY2hlZHVsZWQgdmJsYW5rIHdvcmsgYW5kIHdh
aXQgZm9yIGl0cworICogZXhlY3V0aW9uIHRvIGZpbmlzaC4KKyAqCisgKiBPbiByZXR1cm4gQHdv
cmsgaXMgbm8gbG9uZ2VyIGd1YXJhbmVlZCB0byBiZSBleGVjdXRpbmcuCisgKgorICogUmV0dXJu
czoKKyAqIFRydWUgaWYgdGhlIHdvcmsgd2FzIGNhbmNlbGxlZCBiZWZvcmUgaXQgc3RhcnRlZCB0
byBleGN1dGUsIGZhbHNlCisgKiBvdGhlcndpc2UuCisgKi8KK2Jvb2wgZHJtX3ZibGFua193b3Jr
X2NhbmNlbF9zeW5jKHN0cnVjdCBkcm1fdmJsYW5rX3dvcmsgKndvcmspCit7CisJc3RydWN0IGRy
bV92YmxhbmtfY3J0YyAqdmJsYW5rID0gd29yay0+dmJsYW5rOworCWJvb2wgcXVldWVkLCBjYW5j
ZWxsZWQ7CisKKwlyYXdfc3Bpbl9sb2NrX2lycSgmdmJsYW5rLT53b3JrZXItPmxvY2spOworCWNh
bmNlbGxlZCA9IHZibGFua193b3JrX2NhbmNlbCh3b3JrKTsKKwlxdWV1ZWQgPSAhIXdvcmstPmJh
c2Uud29ya2VyOworCWlmIChxdWV1ZWQpCisJCXdvcmstPmJhc2UuY2FuY2VsaW5nKys7CisJcmF3
X3NwaW5fdW5sb2NrX2lycSgmdmJsYW5rLT53b3JrZXItPmxvY2spOworCisJaWYgKGNhbmNlbGxl
ZCkKKwkJZHJtX3ZibGFua19wdXQodmJsYW5rLT5kZXYsIHZibGFuay0+cGlwZSk7CisKKwlpZiAo
cXVldWVkKSB7CisJCWNhbmNlbGxlZCA9IGt0aHJlYWRfY2FuY2VsX3dvcmtfc3luYygmd29yay0+
YmFzZSk7CisJCXJhd19zcGluX2xvY2tfaXJxKCZ2YmxhbmstPndvcmtlci0+bG9jayk7CisJCXdv
cmstPmJhc2UuY2FuY2VsaW5nLS07CisJCXJhd19zcGluX3VubG9ja19pcnEoJnZibGFuay0+d29y
a2VyLT5sb2NrKTsKKwl9CisKKwlyZXR1cm4gY2FuY2VsbGVkOworfQorRVhQT1JUX1NZTUJPTChk
cm1fdmJsYW5rX3dvcmtfY2FuY2VsX3N5bmMpOworCitzdGF0aWMgdm9pZCBkcm1fZmx1c2hfdmJs
YW5rX3dvcmtfZm4oc3RydWN0IGt0aHJlYWRfd29yayAqd29yaykKK3sKKwlzdHJ1Y3QgZHJtX3Zi
bGFua19mbHVzaF93b3JrICpmd29yayA9CisJCWNvbnRhaW5lcl9vZih3b3JrLCBzdHJ1Y3QgZHJt
X3ZibGFua19mbHVzaF93b3JrLCBiYXNlKTsKKworCWNvbXBsZXRlKCZmd29yay0+ZG9uZSk7Cit9
CisKKy8qKgorICogZHJtX3ZibGFua193b3JrX2ZsdXNoIC0gd2FpdCBmb3IgYSBzY2hlZHVsZWQg
dmJsYW5rIHdvcmsgdG8gZmluaXNoCisgKiBleGVjdXRpbmcKKyAqIEB3b3JrOiB2Ymxhbmsgd29y
ayB0byBmbHVzaAorICoKKyAqIFdhaXQgdW50aWwgQHdvcmsgaGFzIGZpbmlzaGVkIGV4ZWN1dGlu
ZyBvbmNlLgorICovCit2b2lkIGRybV92Ymxhbmtfd29ya19mbHVzaChzdHJ1Y3QgZHJtX3ZibGFu
a193b3JrICp3b3JrKQoreworCXN0cnVjdCBkcm1fdmJsYW5rX2NydGMgKnZibGFuayA9IHdvcmst
PnZibGFuazsKKwlzdHJ1Y3QgZHJtX3ZibGFua19mbHVzaF93b3JrIGZ3b3JrID0geworCQlLVEhS
RUFEX1dPUktfSU5JVChmd29yay5iYXNlLCBkcm1fZmx1c2hfdmJsYW5rX3dvcmtfZm4pLAorCQlD
T01QTEVUSU9OX0lOSVRJQUxJWkVSX09OU1RBQ0soZndvcmsuZG9uZSksCisJfTsKKworCXJhd19z
cGluX2xvY2tfaXJxKCZ2YmxhbmstPndvcmtlci0+bG9jayk7CisKKwlpZiAoIWxpc3RfZW1wdHko
JndvcmstPnBlbmRpbmcpKSB7CisJCWxpc3RfYWRkX3RhaWwoJmZ3b3JrLmJhc2Uubm9kZSwgJndv
cmstPmZsdXNoZXJzKTsKKwl9IGVsc2UgaWYgKCFsaXN0X2VtcHR5KCZ3b3JrLT5iYXNlLm5vZGUp
KSB7CisJCV9fa3RocmVhZF9xdWV1ZV93b3JrKHZibGFuay0+d29ya2VyLCAmZndvcmsuYmFzZSwK
KwkJCQkgICAgIHdvcmstPmJhc2Uubm9kZS5uZXh0KTsKKwl9IGVsc2UgaWYgKHZibGFuay0+d29y
a2VyLT5jdXJyZW50X3dvcmsgPT0gJndvcmstPmJhc2UpIHsKKwkJX19rdGhyZWFkX3F1ZXVlX3dv
cmsodmJsYW5rLT53b3JrZXIsICZmd29yay5iYXNlLAorCQkJCSAgICAgdmJsYW5rLT53b3JrZXIt
PndvcmtfbGlzdC5uZXh0KTsKKwl9IGVsc2UgeworCQlyYXdfc3Bpbl91bmxvY2tfaXJxKCZ2Ymxh
bmstPndvcmtlci0+bG9jayk7CisJCXJldHVybjsKKwl9CisKKwlyYXdfc3Bpbl91bmxvY2tfaXJx
KCZ2YmxhbmstPndvcmtlci0+bG9jayk7CisJd2FpdF9mb3JfY29tcGxldGlvbigmZndvcmsuZG9u
ZSk7Cit9CitFWFBPUlRfU1lNQk9MKGRybV92Ymxhbmtfd29ya19mbHVzaCk7CmRpZmYgLS1naXQg
YS9pbmNsdWRlL2RybS9kcm1fdmJsYW5rLmggYi9pbmNsdWRlL2RybS9kcm1fdmJsYW5rLmgKaW5k
ZXggZGQ5ZjViOWU1NmU0Li4wM2ZjOTZhNTMzYmIgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvZHJtL2Ry
bV92YmxhbmsuaAorKysgYi9pbmNsdWRlL2RybS9kcm1fdmJsYW5rLmgKQEAgLTI3LDYgKzI3LDcg
QEAKICNpbmNsdWRlIDxsaW51eC9zZXFsb2NrLmg+CiAjaW5jbHVkZSA8bGludXgvaWRyLmg+CiAj
aW5jbHVkZSA8bGludXgvcG9sbC5oPgorI2luY2x1ZGUgPGxpbnV4L2t0aHJlYWQuaD4KIAogI2lu
Y2x1ZGUgPGRybS9kcm1fZmlsZS5oPgogI2luY2x1ZGUgPGRybS9kcm1fbW9kZXMuaD4KQEAgLTIw
Myw4ICsyMDQsMzggQEAgc3RydWN0IGRybV92YmxhbmtfY3J0YyB7CiAJICogZGlzYWJsaW5nIGZ1
bmN0aW9ucyBtdWx0aXBsZSB0aW1lcy4KIAkgKi8KIAlib29sIGVuYWJsZWQ7CisKKwkvKioKKwkg
KiBAd29ya2VyOiBUaGUgJmt0aHJlYWRfd29ya2VyIHVzZWQgZm9yIGV4ZWN1dGluZyB2Ymxhbmsg
d29ya3MuCisJICovCisJc3RydWN0IGt0aHJlYWRfd29ya2VyICp3b3JrZXI7CisJLyoqCisJICog
QHBlbmRpbmdfd29yazogQSBsaXN0IG9mIHNjaGVkdWxlZCAmZHJtX3ZibGFua193b3JrIHRoYXQg
YXJlCisJICogd2FpdGluZyBmb3IgYSBmdXR1cmUgdmJsYW5rLgorCSAqLworCXN0cnVjdCBsaXN0
X2hlYWQgcGVuZGluZ193b3JrOwogfTsKIAorc3RydWN0IGRybV92Ymxhbmtfd29yayB7CisJc3Ry
dWN0IGt0aHJlYWRfd29yayBiYXNlOworCXN0cnVjdCBkcm1fdmJsYW5rX2NydGMgKnZibGFuazsK
Kwl1NjQgY291bnQ7CisKKwlzdHJ1Y3QgbGlzdF9oZWFkIHBlbmRpbmc7CisJc3RydWN0IGxpc3Rf
aGVhZCBmbHVzaGVyczsKK307CisKKyNkZWZpbmUgdG9fZHJtX3ZibGFua193b3JrKF93b3JrKSBc
CisJY29udGFpbmVyX29mKChfd29yayksIHN0cnVjdCBkcm1fdmJsYW5rX3dvcmssIGJhc2UpCisK
K2ludCBkcm1fdmJsYW5rX3dvcmtfc2NoZWR1bGUoc3RydWN0IGRybV92Ymxhbmtfd29yayAqd29y
aywKKwkJCSAgICAgdTY0IGNvdW50LCBib29sIG5leHRvbm1pc3MpOwordm9pZCBkcm1fdmJsYW5r
X3dvcmtfaW5pdChzdHJ1Y3QgZHJtX3ZibGFua193b3JrICp3b3JrLCBzdHJ1Y3QgZHJtX2NydGMg
KmNydGMsCisJCQkgIHZvaWQgKCpmdW5jKShzdHJ1Y3Qga3RocmVhZF93b3JrICp3b3JrKSk7Citi
b29sIGRybV92Ymxhbmtfd29ya19jYW5jZWwoc3RydWN0IGRybV92Ymxhbmtfd29yayAqd29yayk7
Citib29sIGRybV92Ymxhbmtfd29ya19jYW5jZWxfc3luYyhzdHJ1Y3QgZHJtX3ZibGFua193b3Jr
ICp3b3JrKTsKK3ZvaWQgZHJtX3ZibGFua193b3JrX2ZsdXNoKHN0cnVjdCBkcm1fdmJsYW5rX3dv
cmsgKndvcmspOworCiBpbnQgZHJtX3ZibGFua19pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYs
IHVuc2lnbmVkIGludCBudW1fY3J0Y3MpOwogYm9vbCBkcm1fZGV2X2hhc192YmxhbmsoY29uc3Qg
c3RydWN0IGRybV9kZXZpY2UgKmRldik7CiB1NjQgZHJtX2NydGNfdmJsYW5rX2NvdW50KHN0cnVj
dCBkcm1fY3J0YyAqY3J0Yyk7Ci0tIAoyLjI1LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxp
c3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFu
L2xpc3RpbmZvL2RyaS1kZXZlbAo=
