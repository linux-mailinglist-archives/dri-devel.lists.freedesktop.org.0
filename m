Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id EA32710FFDF
	for <lists+dri-devel@lfdr.de>; Tue,  3 Dec 2019 15:15:46 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 213326E5E8;
	Tue,  3 Dec 2019 14:15:32 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from bhuna.collabora.co.uk (bhuna.collabora.co.uk [46.235.227.227])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D29FA6E5F2
 for <dri-devel@lists.freedesktop.org>; Tue,  3 Dec 2019 14:15:30 +0000 (UTC)
Received: from localhost.localdomain (unknown
 [IPv6:2a01:e0a:2c:6930:5cf4:84a1:2763:fe0d])
 (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
 (No client certificate requested) (Authenticated sender: bbrezillon)
 by bhuna.collabora.co.uk (Postfix) with ESMTPSA id 14D22290623;
 Tue,  3 Dec 2019 14:15:29 +0000 (GMT)
From: Boris Brezillon <boris.brezillon@collabora.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v4 09/11] drm/bridge: Patch atomic hooks to take a
 drm_bridge_state
Date: Tue,  3 Dec 2019 15:15:13 +0100
Message-Id: <20191203141515.3597631-10-boris.brezillon@collabora.com>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191203141515.3597631-1-boris.brezillon@collabora.com>
References: <20191203141515.3597631-1-boris.brezillon@collabora.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Mark Rutland <mark.rutland@arm.com>,
 Neil Armstrong <narmstrong@baylibre.com>,
 Thierry Reding <thierry.reding@gmail.com>,
 Laurent Pinchart <laurent.pinchart@ideasonboard.com>, kernel@collabora.com,
 Sam Ravnborg <sam@ravnborg.org>,
 Nikita Yushchenko <nikita.yoush@cogentembedded.com>,
 Andrey Smirnov <andrew.smirnov@gmail.com>,
 Kyungmin Park <kyungmin.park@samsung.com>, Chris Healy <cphealy@gmail.com>,
 devicetree@vger.kernel.org, Jonas Karlman <jonas@kwiboo.se>,
 Rob Herring <robh+dt@kernel.org>, Jernej Skrabec <jernej.skrabec@siol.net>,
 Seung-Woo Kim <sw0312.kim@samsung.com>,
 Boris Brezillon <boris.brezillon@collabora.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyB3YXkgdGhlIGRybV9icmlkZ2VfZnVuY3MgaW50ZXJmYWNlIGlzIGNvbnNpc3RlbnQgd2l0
aCB0aGUgcmVzdCBvZgp0aGUgc3Vic3lzdGVtLgoKVGhlIG9ubHkgZHJpdmVyIGltcGxlbWVudGlu
ZyB0aG9zZSBob29rcyAoYW5hbG9naXggRFApIGlzIHBhdGNoZWQgdG9vLgoKU2lnbmVkLW9mZi1i
eTogQm9yaXMgQnJlemlsbG9uIDxib3Jpcy5icmV6aWxsb25AY29sbGFib3JhLmNvbT4KUmV2aWV3
ZWQtYnk6IExhdXJlbnQgUGluY2hhcnQgPGxhdXJlbnQucGluY2hhcnRAaWRlYXNvbmJvYXJkLmNv
bT4KLS0tCkNoYW5nZXMgaW4gdjQ6CiogUmVuYW1lIGZ1bmMgcGFyYW1zIGludG8gb2xkX2JyaWRn
ZV9zdGF0ZQoqIEFkZCBMYXVyZW50J3MgUmIKCkNoYW5nZXMgaW4gdjM6CiogT2xkIHN0YXRlIGNs
YXJpZmljYXRpb24gbW92ZWQgdG8gYSBzZXBhcmF0ZSBwYXRjaAoKQ2hhbmdlcyBpbiB2MjoKKiBQ
YXNzIHRoZSBvbGQgYnJpZGdlIHN0YXRlCi0tLQogLi4uL2RybS9icmlkZ2UvYW5hbG9naXgvYW5h
bG9naXhfZHBfY29yZS5jICAgIHwgNDEgKysrKysrLS0tLQogZHJpdmVycy9ncHUvZHJtL2RybV9i
cmlkZ2UuYyAgICAgICAgICAgICAgICAgIHwgNzcgKysrKysrKysrKysrKystLS0tLQogaW5jbHVk
ZS9kcm0vZHJtX2JyaWRnZS5oICAgICAgICAgICAgICAgICAgICAgIHwgIDggKy0KIDMgZmlsZXMg
Y2hhbmdlZCwgODUgaW5zZXJ0aW9ucygrKSwgNDEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL2JyaWRnZS9hbmFsb2dpeC9hbmFsb2dpeF9kcF9jb3JlLmMgYi9kcml2
ZXJzL2dwdS9kcm0vYnJpZGdlL2FuYWxvZ2l4L2FuYWxvZ2l4X2RwX2NvcmUuYwppbmRleCBiYjQx
MWZlNTJhZTguLmM4Yjc3YjZhOGZiMCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2JyaWRn
ZS9hbmFsb2dpeC9hbmFsb2dpeF9kcF9jb3JlLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2JyaWRn
ZS9hbmFsb2dpeC9hbmFsb2dpeF9kcF9jb3JlLmMKQEAgLTEyODksMTkgKzEyODksMjEgQEAgc3Ry
dWN0IGRybV9jcnRjICphbmFsb2dpeF9kcF9nZXRfbmV3X2NydGMoc3RydWN0IGFuYWxvZ2l4X2Rw
X2RldmljZSAqZHAsCiAJcmV0dXJuIGNvbm5fc3RhdGUtPmNydGM7CiB9CiAKLXN0YXRpYyB2b2lk
IGFuYWxvZ2l4X2RwX2JyaWRnZV9hdG9taWNfcHJlX2VuYWJsZShzdHJ1Y3QgZHJtX2JyaWRnZSAq
YnJpZGdlLAotCQkJCQkJIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkKK3N0YXRpYyB2
b2lkCithbmFsb2dpeF9kcF9icmlkZ2VfYXRvbWljX3ByZV9lbmFibGUoc3RydWN0IGRybV9icmlk
Z2UgKmJyaWRnZSwKKwkJCQkgICAgIHN0cnVjdCBkcm1fYnJpZGdlX3N0YXRlICpvbGRfYnJpZGdl
X3N0YXRlKQogeworCXN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpvbGRfc3RhdGUgPSBvbGRfYnJp
ZGdlX3N0YXRlLT5iYXNlLnN0YXRlOwogCXN0cnVjdCBhbmFsb2dpeF9kcF9kZXZpY2UgKmRwID0g
YnJpZGdlLT5kcml2ZXJfcHJpdmF0ZTsKIAlzdHJ1Y3QgZHJtX2NydGMgKmNydGM7CiAJc3RydWN0
IGRybV9jcnRjX3N0YXRlICpvbGRfY3J0Y19zdGF0ZTsKIAlpbnQgcmV0OwogCi0JY3J0YyA9IGFu
YWxvZ2l4X2RwX2dldF9uZXdfY3J0YyhkcCwgc3RhdGUpOworCWNydGMgPSBhbmFsb2dpeF9kcF9n
ZXRfbmV3X2NydGMoZHAsIG9sZF9zdGF0ZSk7CiAJaWYgKCFjcnRjKQogCQlyZXR1cm47CiAKLQlv
bGRfY3J0Y19zdGF0ZSA9IGRybV9hdG9taWNfZ2V0X29sZF9jcnRjX3N0YXRlKHN0YXRlLCBjcnRj
KTsKKwlvbGRfY3J0Y19zdGF0ZSA9IGRybV9hdG9taWNfZ2V0X29sZF9jcnRjX3N0YXRlKG9sZF9z
dGF0ZSwgY3J0Yyk7CiAJLyogRG9uJ3QgdG91Y2ggdGhlIHBhbmVsIGlmIHdlJ3JlIGNvbWluZyBi
YWNrIGZyb20gUFNSICovCiAJaWYgKG9sZF9jcnRjX3N0YXRlICYmIG9sZF9jcnRjX3N0YXRlLT5z
ZWxmX3JlZnJlc2hfYWN0aXZlKQogCQlyZXR1cm47CkBAIC0xMzY2LDIwICsxMzY4LDIyIEBAIHN0
YXRpYyBpbnQgYW5hbG9naXhfZHBfc2V0X2JyaWRnZShzdHJ1Y3QgYW5hbG9naXhfZHBfZGV2aWNl
ICpkcCkKIAlyZXR1cm4gcmV0OwogfQogCi1zdGF0aWMgdm9pZCBhbmFsb2dpeF9kcF9icmlkZ2Vf
YXRvbWljX2VuYWJsZShzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAotCQkJCQkgICAgIHN0cnVj
dCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkKK3N0YXRpYyB2b2lkCithbmFsb2dpeF9kcF9icmlk
Z2VfYXRvbWljX2VuYWJsZShzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAorCQkJCSBzdHJ1Y3Qg
ZHJtX2JyaWRnZV9zdGF0ZSAqb2xkX2JyaWRnZV9zdGF0ZSkKIHsKKwlzdHJ1Y3QgZHJtX2F0b21p
Y19zdGF0ZSAqb2xkX3N0YXRlID0gb2xkX2JyaWRnZV9zdGF0ZS0+YmFzZS5zdGF0ZTsKIAlzdHJ1
Y3QgYW5hbG9naXhfZHBfZGV2aWNlICpkcCA9IGJyaWRnZS0+ZHJpdmVyX3ByaXZhdGU7CiAJc3Ry
dWN0IGRybV9jcnRjICpjcnRjOwogCXN0cnVjdCBkcm1fY3J0Y19zdGF0ZSAqb2xkX2NydGNfc3Rh
dGU7CiAJaW50IHRpbWVvdXRfbG9vcCA9IDA7CiAJaW50IHJldDsKIAotCWNydGMgPSBhbmFsb2dp
eF9kcF9nZXRfbmV3X2NydGMoZHAsIHN0YXRlKTsKKwljcnRjID0gYW5hbG9naXhfZHBfZ2V0X25l
d19jcnRjKGRwLCBvbGRfc3RhdGUpOwogCWlmICghY3J0YykKIAkJcmV0dXJuOwogCi0Jb2xkX2Ny
dGNfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9vbGRfY3J0Y19zdGF0ZShzdGF0ZSwgY3J0Yyk7CisJ
b2xkX2NydGNfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9vbGRfY3J0Y19zdGF0ZShvbGRfc3RhdGUs
IGNydGMpOwogCS8qIE5vdCBhIGZ1bGwgZW5hYmxlLCBqdXN0IGRpc2FibGUgUFNSIGFuZCBjb250
aW51ZSAqLwogCWlmIChvbGRfY3J0Y19zdGF0ZSAmJiBvbGRfY3J0Y19zdGF0ZS0+c2VsZl9yZWZy
ZXNoX2FjdGl2ZSkgewogCQlyZXQgPSBhbmFsb2dpeF9kcF9kaXNhYmxlX3BzcihkcCk7CkBAIC0x
NDQwLDE4ICsxNDQ0LDIwIEBAIHN0YXRpYyB2b2lkIGFuYWxvZ2l4X2RwX2JyaWRnZV9kaXNhYmxl
KHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UpCiAJZHAtPmRwbXNfbW9kZSA9IERSTV9NT0RFX0RQ
TVNfT0ZGOwogfQogCi1zdGF0aWMgdm9pZCBhbmFsb2dpeF9kcF9icmlkZ2VfYXRvbWljX2Rpc2Fi
bGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKLQkJCQkJICAgICAgc3RydWN0IGRybV9hdG9t
aWNfc3RhdGUgKnN0YXRlKQorc3RhdGljIHZvaWQKK2FuYWxvZ2l4X2RwX2JyaWRnZV9hdG9taWNf
ZGlzYWJsZShzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAorCQkJCSAgc3RydWN0IGRybV9icmlk
Z2Vfc3RhdGUgKm9sZF9icmlkZ2Vfc3RhdGUpCiB7CisJc3RydWN0IGRybV9hdG9taWNfc3RhdGUg
Km9sZF9zdGF0ZSA9IG9sZF9icmlkZ2Vfc3RhdGUtPmJhc2Uuc3RhdGU7CiAJc3RydWN0IGFuYWxv
Z2l4X2RwX2RldmljZSAqZHAgPSBicmlkZ2UtPmRyaXZlcl9wcml2YXRlOwogCXN0cnVjdCBkcm1f
Y3J0YyAqY3J0YzsKIAlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUgKm5ld19jcnRjX3N0YXRlID0gTlVM
TDsKIAotCWNydGMgPSBhbmFsb2dpeF9kcF9nZXRfbmV3X2NydGMoZHAsIHN0YXRlKTsKKwljcnRj
ID0gYW5hbG9naXhfZHBfZ2V0X25ld19jcnRjKGRwLCBvbGRfc3RhdGUpOwogCWlmICghY3J0YykK
IAkJZ290byBvdXQ7CiAKLQluZXdfY3J0Y19zdGF0ZSA9IGRybV9hdG9taWNfZ2V0X25ld19jcnRj
X3N0YXRlKHN0YXRlLCBjcnRjKTsKKwluZXdfY3J0Y19zdGF0ZSA9IGRybV9hdG9taWNfZ2V0X25l
d19jcnRjX3N0YXRlKG9sZF9zdGF0ZSwgY3J0Yyk7CiAJaWYgKCFuZXdfY3J0Y19zdGF0ZSkKIAkJ
Z290byBvdXQ7CiAKQEAgLTE0NjMsMjAgKzE0NjksMjEgQEAgc3RhdGljIHZvaWQgYW5hbG9naXhf
ZHBfYnJpZGdlX2F0b21pY19kaXNhYmxlKHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UsCiAJYW5h
bG9naXhfZHBfYnJpZGdlX2Rpc2FibGUoYnJpZGdlKTsKIH0KIAotc3RhdGljCi12b2lkIGFuYWxv
Z2l4X2RwX2JyaWRnZV9hdG9taWNfcG9zdF9kaXNhYmxlKHN0cnVjdCBkcm1fYnJpZGdlICpicmlk
Z2UsCi0JCQkJCSAgICBzdHJ1Y3QgZHJtX2F0b21pY19zdGF0ZSAqc3RhdGUpCitzdGF0aWMgdm9p
ZAorYW5hbG9naXhfZHBfYnJpZGdlX2F0b21pY19wb3N0X2Rpc2FibGUoc3RydWN0IGRybV9icmlk
Z2UgKmJyaWRnZSwKKwkJCQlzdHJ1Y3QgZHJtX2JyaWRnZV9zdGF0ZSAqb2xkX2JyaWRnZV9zdGF0
ZSkKIHsKKwlzdHJ1Y3QgZHJtX2F0b21pY19zdGF0ZSAqb2xkX3N0YXRlID0gb2xkX2JyaWRnZV9z
dGF0ZS0+YmFzZS5zdGF0ZTsKIAlzdHJ1Y3QgYW5hbG9naXhfZHBfZGV2aWNlICpkcCA9IGJyaWRn
ZS0+ZHJpdmVyX3ByaXZhdGU7CiAJc3RydWN0IGRybV9jcnRjICpjcnRjOwogCXN0cnVjdCBkcm1f
Y3J0Y19zdGF0ZSAqbmV3X2NydGNfc3RhdGU7CiAJaW50IHJldDsKIAotCWNydGMgPSBhbmFsb2dp
eF9kcF9nZXRfbmV3X2NydGMoZHAsIHN0YXRlKTsKKwljcnRjID0gYW5hbG9naXhfZHBfZ2V0X25l
d19jcnRjKGRwLCBvbGRfc3RhdGUpOwogCWlmICghY3J0YykKIAkJcmV0dXJuOwogCi0JbmV3X2Ny
dGNfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9uZXdfY3J0Y19zdGF0ZShzdGF0ZSwgY3J0Yyk7CisJ
bmV3X2NydGNfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9uZXdfY3J0Y19zdGF0ZShvbGRfc3RhdGUs
IGNydGMpOwogCWlmICghbmV3X2NydGNfc3RhdGUgfHwgIW5ld19jcnRjX3N0YXRlLT5zZWxmX3Jl
ZnJlc2hfYWN0aXZlKQogCQlyZXR1cm47CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9k
cm1fYnJpZGdlLmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2JyaWRnZS5jCmluZGV4IGJmNWEyMjQz
YTExNS4uMTViMjFmZjZmMWZlIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2JyaWRn
ZS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fYnJpZGdlLmMKQEAgLTQ2MCw3ICs0NjAsNyBA
QCBFWFBPUlRfU1lNQk9MKGRybV9icmlkZ2VfY2hhaW5fZW5hYmxlKTsKIC8qKgogICogZHJtX2F0
b21pY19icmlkZ2VfY2hhaW5fZGlzYWJsZSAtIGRpc2FibGVzIGFsbCBicmlkZ2VzIGluIHRoZSBl
bmNvZGVyIGNoYWluCiAgKiBAYnJpZGdlOiBicmlkZ2UgY29udHJvbCBzdHJ1Y3R1cmUKLSAqIEBz
dGF0ZTogYXRvbWljIHN0YXRlIGJlaW5nIGNvbW1pdHRlZAorICogQG9sZF9zdGF0ZTogb2xkIGF0
b21pYyBzdGF0ZQogICoKICAqIENhbGxzICZkcm1fYnJpZGdlX2Z1bmNzLmF0b21pY19kaXNhYmxl
IChmYWxscyBiYWNrIG9uCiAgKiAmZHJtX2JyaWRnZV9mdW5jcy5kaXNhYmxlKSBvcCBmb3IgYWxs
IHRoZSBicmlkZ2VzIGluIHRoZSBlbmNvZGVyIGNoYWluLApAQCAtNDcwLDcgKzQ3MCw3IEBAIEVY
UE9SVF9TWU1CT0woZHJtX2JyaWRnZV9jaGFpbl9lbmFibGUpOwogICogTm90ZTogdGhlIGJyaWRn
ZSBwYXNzZWQgc2hvdWxkIGJlIHRoZSBvbmUgY2xvc2VzdCB0byB0aGUgZW5jb2RlcgogICovCiB2
b2lkIGRybV9hdG9taWNfYnJpZGdlX2NoYWluX2Rpc2FibGUoc3RydWN0IGRybV9icmlkZ2UgKmJy
aWRnZSwKLQkJCQkgICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkKKwkJCQkgICAg
IHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpvbGRfc3RhdGUpCiB7CiAJc3RydWN0IGRybV9lbmNv
ZGVyICplbmNvZGVyOwogCXN0cnVjdCBkcm1fYnJpZGdlICppdGVyOwpAQCAtNDgwLDEwICs0ODAs
MTkgQEAgdm9pZCBkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9kaXNhYmxlKHN0cnVjdCBkcm1fYnJp
ZGdlICpicmlkZ2UsCiAKIAllbmNvZGVyID0gYnJpZGdlLT5lbmNvZGVyOwogCWxpc3RfZm9yX2Vh
Y2hfZW50cnlfcmV2ZXJzZShpdGVyLCAmZW5jb2Rlci0+YnJpZGdlX2NoYWluLCBjaGFpbl9ub2Rl
KSB7Ci0JCWlmIChpdGVyLT5mdW5jcy0+YXRvbWljX2Rpc2FibGUpCi0JCQlpdGVyLT5mdW5jcy0+
YXRvbWljX2Rpc2FibGUoaXRlciwgc3RhdGUpOwotCQllbHNlIGlmIChpdGVyLT5mdW5jcy0+ZGlz
YWJsZSkKKwkJaWYgKGl0ZXItPmZ1bmNzLT5hdG9taWNfZGlzYWJsZSkgeworCQkJc3RydWN0IGRy
bV9icmlkZ2Vfc3RhdGUgKm9sZF9icmlkZ2Vfc3RhdGU7CisKKwkJCW9sZF9icmlkZ2Vfc3RhdGUg
PQorCQkJCWRybV9hdG9taWNfZ2V0X29sZF9icmlkZ2Vfc3RhdGUob2xkX3N0YXRlLAorCQkJCQkJ
CQlpdGVyKTsKKwkJCWlmIChXQVJOX09OKCFvbGRfYnJpZGdlX3N0YXRlKSkKKwkJCQlyZXR1cm47
CisKKwkJCWl0ZXItPmZ1bmNzLT5hdG9taWNfZGlzYWJsZShpdGVyLCBvbGRfYnJpZGdlX3N0YXRl
KTsKKwkJfSBlbHNlIGlmIChpdGVyLT5mdW5jcy0+ZGlzYWJsZSkgewogCQkJaXRlci0+ZnVuY3Mt
PmRpc2FibGUoaXRlcik7CisJCX0KIAogCQlpZiAoaXRlciA9PSBicmlkZ2UpCiAJCQlicmVhazsK
QEAgLTQ5NSw3ICs1MDQsNyBAQCBFWFBPUlRfU1lNQk9MKGRybV9hdG9taWNfYnJpZGdlX2NoYWlu
X2Rpc2FibGUpOwogICogZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fcG9zdF9kaXNhYmxlIC0gY2xl
YW5zIHVwIGFmdGVyIGRpc2FibGluZyBhbGwgYnJpZGdlcwogICoJCQkJCSAgaW4gdGhlIGVuY29k
ZXIgY2hhaW4KICAqIEBicmlkZ2U6IGJyaWRnZSBjb250cm9sIHN0cnVjdHVyZQotICogQHN0YXRl
OiBhdG9taWMgc3RhdGUgYmVpbmcgY29tbWl0dGVkCisgKiBAb2xkX3N0YXRlOiBvbGQgYXRvbWlj
IHN0YXRlCiAgKgogICogQ2FsbHMgJmRybV9icmlkZ2VfZnVuY3MuYXRvbWljX3Bvc3RfZGlzYWJs
ZSAoZmFsbHMgYmFjayBvbgogICogJmRybV9icmlkZ2VfZnVuY3MucG9zdF9kaXNhYmxlKSBvcCBm
b3IgYWxsIHRoZSBicmlkZ2VzIGluIHRoZSBlbmNvZGVyIGNoYWluLApAQCAtNTA1LDcgKzUxNCw3
IEBAIEVYUE9SVF9TWU1CT0woZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fZGlzYWJsZSk7CiAgKiBO
b3RlOiB0aGUgYnJpZGdlIHBhc3NlZCBzaG91bGQgYmUgdGhlIG9uZSBjbG9zZXN0IHRvIHRoZSBl
bmNvZGVyCiAgKi8KIHZvaWQgZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fcG9zdF9kaXNhYmxlKHN0
cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UsCi0JCQkJCSAgc3RydWN0IGRybV9hdG9taWNfc3RhdGUg
KnN0YXRlKQorCQkJCQkgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpvbGRfc3RhdGUpCiB7CiAJ
c3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVyOwogCkBAIC01MTQsMTAgKzUyMywyMCBAQCB2b2lk
IGRybV9hdG9taWNfYnJpZGdlX2NoYWluX3Bvc3RfZGlzYWJsZShzdHJ1Y3QgZHJtX2JyaWRnZSAq
YnJpZGdlLAogCiAJZW5jb2RlciA9IGJyaWRnZS0+ZW5jb2RlcjsKIAlsaXN0X2Zvcl9lYWNoX2Vu
dHJ5X2Zyb20oYnJpZGdlLCAmZW5jb2Rlci0+YnJpZGdlX2NoYWluLCBjaGFpbl9ub2RlKSB7Ci0J
CWlmIChicmlkZ2UtPmZ1bmNzLT5hdG9taWNfcG9zdF9kaXNhYmxlKQotCQkJYnJpZGdlLT5mdW5j
cy0+YXRvbWljX3Bvc3RfZGlzYWJsZShicmlkZ2UsIHN0YXRlKTsKLQkJZWxzZSBpZiAoYnJpZGdl
LT5mdW5jcy0+cG9zdF9kaXNhYmxlKQorCQlpZiAoYnJpZGdlLT5mdW5jcy0+YXRvbWljX3Bvc3Rf
ZGlzYWJsZSkgeworCQkJc3RydWN0IGRybV9icmlkZ2Vfc3RhdGUgKm9sZF9icmlkZ2Vfc3RhdGU7
CisKKwkJCW9sZF9icmlkZ2Vfc3RhdGUgPQorCQkJCWRybV9hdG9taWNfZ2V0X29sZF9icmlkZ2Vf
c3RhdGUob2xkX3N0YXRlLAorCQkJCQkJCQlicmlkZ2UpOworCQkJaWYgKFdBUk5fT04oIW9sZF9i
cmlkZ2Vfc3RhdGUpKQorCQkJCXJldHVybjsKKworCQkJYnJpZGdlLT5mdW5jcy0+YXRvbWljX3Bv
c3RfZGlzYWJsZShicmlkZ2UsCisJCQkJCQkJICAgb2xkX2JyaWRnZV9zdGF0ZSk7CisJCX0gZWxz
ZSBpZiAoYnJpZGdlLT5mdW5jcy0+cG9zdF9kaXNhYmxlKSB7CiAJCQlicmlkZ2UtPmZ1bmNzLT5w
b3N0X2Rpc2FibGUoYnJpZGdlKTsKKwkJfQogCX0KIH0KIEVYUE9SVF9TWU1CT0woZHJtX2F0b21p
Y19icmlkZ2VfY2hhaW5fcG9zdF9kaXNhYmxlKTsKQEAgLTUyNiw3ICs1NDUsNyBAQCBFWFBPUlRf
U1lNQk9MKGRybV9hdG9taWNfYnJpZGdlX2NoYWluX3Bvc3RfZGlzYWJsZSk7CiAgKiBkcm1fYXRv
bWljX2JyaWRnZV9jaGFpbl9wcmVfZW5hYmxlIC0gcHJlcGFyZXMgZm9yIGVuYWJsaW5nIGFsbCBi
cmlkZ2VzIGluCiAgKgkJCQkJdGhlIGVuY29kZXIgY2hhaW4KICAqIEBicmlkZ2U6IGJyaWRnZSBj
b250cm9sIHN0cnVjdHVyZQotICogQHN0YXRlOiBhdG9taWMgc3RhdGUgYmVpbmcgY29tbWl0dGVk
CisgKiBAb2xkX3N0YXRlOiBvbGQgYXRvbWljIHN0YXRlCiAgKgogICogQ2FsbHMgJmRybV9icmlk
Z2VfZnVuY3MuYXRvbWljX3ByZV9lbmFibGUgKGZhbGxzIGJhY2sgb24KICAqICZkcm1fYnJpZGdl
X2Z1bmNzLnByZV9lbmFibGUpIG9wIGZvciBhbGwgdGhlIGJyaWRnZXMgaW4gdGhlIGVuY29kZXIg
Y2hhaW4sCkBAIC01MzYsNyArNTU1LDcgQEAgRVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRn
ZV9jaGFpbl9wb3N0X2Rpc2FibGUpOwogICogTm90ZTogdGhlIGJyaWRnZSBwYXNzZWQgc2hvdWxk
IGJlIHRoZSBvbmUgY2xvc2VzdCB0byB0aGUgZW5jb2RlcgogICovCiB2b2lkIGRybV9hdG9taWNf
YnJpZGdlX2NoYWluX3ByZV9lbmFibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKLQkJCQkJ
c3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQorCQkJCQlzdHJ1Y3QgZHJtX2F0b21pY19z
dGF0ZSAqb2xkX3N0YXRlKQogewogCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcjsKIAlzdHJ1
Y3QgZHJtX2JyaWRnZSAqaXRlcjsKQEAgLTU0NiwxMCArNTY1LDE5IEBAIHZvaWQgZHJtX2F0b21p
Y19icmlkZ2VfY2hhaW5fcHJlX2VuYWJsZShzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAogCiAJ
ZW5jb2RlciA9IGJyaWRnZS0+ZW5jb2RlcjsKIAlsaXN0X2Zvcl9lYWNoX2VudHJ5X3JldmVyc2Uo
aXRlciwgJmVuY29kZXItPmJyaWRnZV9jaGFpbiwgY2hhaW5fbm9kZSkgewotCQlpZiAoaXRlci0+
ZnVuY3MtPmF0b21pY19wcmVfZW5hYmxlKQotCQkJaXRlci0+ZnVuY3MtPmF0b21pY19wcmVfZW5h
YmxlKGl0ZXIsIHN0YXRlKTsKLQkJZWxzZSBpZiAoaXRlci0+ZnVuY3MtPnByZV9lbmFibGUpCisJ
CWlmIChpdGVyLT5mdW5jcy0+YXRvbWljX3ByZV9lbmFibGUpIHsKKwkJCXN0cnVjdCBkcm1fYnJp
ZGdlX3N0YXRlICpvbGRfYnJpZGdlX3N0YXRlOworCisJCQlvbGRfYnJpZGdlX3N0YXRlID0KKwkJ
CQlkcm1fYXRvbWljX2dldF9vbGRfYnJpZGdlX3N0YXRlKG9sZF9zdGF0ZSwKKwkJCQkJCQkJaXRl
cik7CisJCQlpZiAoV0FSTl9PTighb2xkX2JyaWRnZV9zdGF0ZSkpCisJCQkJcmV0dXJuOworCisJ
CQlpdGVyLT5mdW5jcy0+YXRvbWljX3ByZV9lbmFibGUoaXRlciwgb2xkX2JyaWRnZV9zdGF0ZSk7
CisJCX0gZWxzZSBpZiAoaXRlci0+ZnVuY3MtPnByZV9lbmFibGUpIHsKIAkJCWl0ZXItPmZ1bmNz
LT5wcmVfZW5hYmxlKGl0ZXIpOworCQl9CiAKIAkJaWYgKGl0ZXIgPT0gYnJpZGdlKQogCQkJYnJl
YWs7CkBAIC01NjAsNyArNTg4LDcgQEAgRVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9j
aGFpbl9wcmVfZW5hYmxlKTsKIC8qKgogICogZHJtX2F0b21pY19icmlkZ2VfY2hhaW5fZW5hYmxl
IC0gZW5hYmxlcyBhbGwgYnJpZGdlcyBpbiB0aGUgZW5jb2RlciBjaGFpbgogICogQGJyaWRnZTog
YnJpZGdlIGNvbnRyb2wgc3RydWN0dXJlCi0gKiBAc3RhdGU6IGF0b21pYyBzdGF0ZSBiZWluZyBj
b21taXR0ZWQKKyAqIEBvbGRfc3RhdGU6IG9sZCBhdG9taWMgc3RhdGUKICAqCiAgKiBDYWxscyAm
ZHJtX2JyaWRnZV9mdW5jcy5hdG9taWNfZW5hYmxlIChmYWxscyBiYWNrIG9uCiAgKiAmZHJtX2Jy
aWRnZV9mdW5jcy5lbmFibGUpIG9wIGZvciBhbGwgdGhlIGJyaWRnZXMgaW4gdGhlIGVuY29kZXIg
Y2hhaW4sCkBAIC01NzAsNyArNTk4LDcgQEAgRVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRn
ZV9jaGFpbl9wcmVfZW5hYmxlKTsKICAqIE5vdGU6IHRoZSBicmlkZ2UgcGFzc2VkIHNob3VsZCBi
ZSB0aGUgb25lIGNsb3Nlc3QgdG8gdGhlIGVuY29kZXIKICAqLwogdm9pZCBkcm1fYXRvbWljX2Jy
aWRnZV9jaGFpbl9lbmFibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKLQkJCQkgICAgc3Ry
dWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQorCQkJCSAgICBzdHJ1Y3QgZHJtX2F0b21pY19z
dGF0ZSAqb2xkX3N0YXRlKQogewogCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcjsKIApAQCAt
NTc5LDEwICs2MDcsMTkgQEAgdm9pZCBkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9lbmFibGUoc3Ry
dWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKIAogCWVuY29kZXIgPSBicmlkZ2UtPmVuY29kZXI7CiAJ
bGlzdF9mb3JfZWFjaF9lbnRyeV9mcm9tKGJyaWRnZSwgJmVuY29kZXItPmJyaWRnZV9jaGFpbiwg
Y2hhaW5fbm9kZSkgewotCQlpZiAoYnJpZGdlLT5mdW5jcy0+YXRvbWljX2VuYWJsZSkKLQkJCWJy
aWRnZS0+ZnVuY3MtPmF0b21pY19lbmFibGUoYnJpZGdlLCBzdGF0ZSk7Ci0JCWVsc2UgaWYgKGJy
aWRnZS0+ZnVuY3MtPmVuYWJsZSkKKwkJaWYgKGJyaWRnZS0+ZnVuY3MtPmF0b21pY19lbmFibGUp
IHsKKwkJCXN0cnVjdCBkcm1fYnJpZGdlX3N0YXRlICpvbGRfYnJpZGdlX3N0YXRlOworCisJCQlv
bGRfYnJpZGdlX3N0YXRlID0KKwkJCQlkcm1fYXRvbWljX2dldF9vbGRfYnJpZGdlX3N0YXRlKG9s
ZF9zdGF0ZSwKKwkJCQkJCQkJYnJpZGdlKTsKKwkJCWlmIChXQVJOX09OKCFvbGRfYnJpZGdlX3N0
YXRlKSkKKwkJCQlyZXR1cm47CisKKwkJCWJyaWRnZS0+ZnVuY3MtPmF0b21pY19lbmFibGUoYnJp
ZGdlLCBvbGRfYnJpZGdlX3N0YXRlKTsKKwkJfSBlbHNlIGlmIChicmlkZ2UtPmZ1bmNzLT5lbmFi
bGUpIHsKIAkJCWJyaWRnZS0+ZnVuY3MtPmVuYWJsZShicmlkZ2UpOworCQl9CiAJfQogfQogRVhQ
T1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9lbmFibGUpOwpkaWZmIC0tZ2l0IGEv
aW5jbHVkZS9kcm0vZHJtX2JyaWRnZS5oIGIvaW5jbHVkZS9kcm0vZHJtX2JyaWRnZS5oCmluZGV4
IGRiNWZjMThkNDliZC4uYjgwYzNjYWMzMjAzIDEwMDY0NAotLS0gYS9pbmNsdWRlL2RybS9kcm1f
YnJpZGdlLmgKKysrIGIvaW5jbHVkZS9kcm0vZHJtX2JyaWRnZS5oCkBAIC0yODIsNyArMjgyLDcg
QEAgc3RydWN0IGRybV9icmlkZ2VfZnVuY3MgewogCSAqIFRoZSBAYXRvbWljX3ByZV9lbmFibGUg
Y2FsbGJhY2sgaXMgb3B0aW9uYWwuCiAJICovCiAJdm9pZCAoKmF0b21pY19wcmVfZW5hYmxlKShz
dHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAotCQkJCSAgc3RydWN0IGRybV9hdG9taWNfc3RhdGUg
Km9sZF9zdGF0ZSk7CisJCQkJICBzdHJ1Y3QgZHJtX2JyaWRnZV9zdGF0ZSAqb2xkX2JyaWRnZV9z
dGF0ZSk7CiAKIAkvKioKIAkgKiBAYXRvbWljX2VuYWJsZToKQEAgLTMwNyw3ICszMDcsNyBAQCBz
dHJ1Y3QgZHJtX2JyaWRnZV9mdW5jcyB7CiAJICogVGhlIEBhdG9taWNfZW5hYmxlIGNhbGxiYWNr
IGlzIG9wdGlvbmFsLgogCSAqLwogCXZvaWQgKCphdG9taWNfZW5hYmxlKShzdHJ1Y3QgZHJtX2Jy
aWRnZSAqYnJpZGdlLAotCQkJICAgICAgc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKm9sZF9zdGF0
ZSk7CisJCQkgICAgICBzdHJ1Y3QgZHJtX2JyaWRnZV9zdGF0ZSAqb2xkX2JyaWRnZV9zdGF0ZSk7
CiAJLyoqCiAJICogQGF0b21pY19kaXNhYmxlOgogCSAqCkBAIC0zMzAsNyArMzMwLDcgQEAgc3Ry
dWN0IGRybV9icmlkZ2VfZnVuY3MgewogCSAqIFRoZSBAYXRvbWljX2Rpc2FibGUgY2FsbGJhY2sg
aXMgb3B0aW9uYWwuCiAJICovCiAJdm9pZCAoKmF0b21pY19kaXNhYmxlKShzdHJ1Y3QgZHJtX2Jy
aWRnZSAqYnJpZGdlLAotCQkJICAgICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpvbGRfc3Rh
dGUpOworCQkJICAgICAgIHN0cnVjdCBkcm1fYnJpZGdlX3N0YXRlICpvbGRfYnJpZGdlX3N0YXRl
KTsKIAogCS8qKgogCSAqIEBhdG9taWNfcG9zdF9kaXNhYmxlOgpAQCAtMzU2LDcgKzM1Niw3IEBA
IHN0cnVjdCBkcm1fYnJpZGdlX2Z1bmNzIHsKIAkgKiBUaGUgQGF0b21pY19wb3N0X2Rpc2FibGUg
Y2FsbGJhY2sgaXMgb3B0aW9uYWwuCiAJICovCiAJdm9pZCAoKmF0b21pY19wb3N0X2Rpc2FibGUp
KHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UsCi0JCQkJICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0
YXRlICpvbGRfc3RhdGUpOworCQkJCSAgICBzdHJ1Y3QgZHJtX2JyaWRnZV9zdGF0ZSAqb2xkX2Jy
aWRnZV9zdGF0ZSk7CiAKIAkvKioKIAkgKiBAYXRvbWljX2R1cGxpY2F0ZV9zdGF0ZToKLS0gCjIu
MjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJp
LWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBz
Oi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
