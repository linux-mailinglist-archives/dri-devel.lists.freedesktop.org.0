Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 243F538580
	for <lists+dri-devel@lfdr.de>; Fri,  7 Jun 2019 09:45:59 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id CB99C89B06;
	Fri,  7 Jun 2019 07:44:13 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-qk1-x743.google.com (mail-qk1-x743.google.com
 [IPv6:2607:f8b0:4864:20::743])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8F64B89690
 for <dri-devel@lists.freedesktop.org>; Thu,  6 Jun 2019 18:44:47 +0000 (UTC)
Received: by mail-qk1-x743.google.com with SMTP id c11so2117775qkk.8
 for <dri-devel@lists.freedesktop.org>; Thu, 06 Jun 2019 11:44:47 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=lL1gh8nawE6RFwsPdkPriGSJ+VnlR7Td1463Tqz8utE=;
 b=HCIifFOs0XUY2ZTYi3jYMfpPtexc4U9iSkuIppbQD8ahlHLOPK5ArI12QJbAXSxwj9
 2G+lUaGpO1GV5y+wxzZkTP4SbE4Wx9Te1STu1XnZ9hDvThVLfuVUWi1UgHBSJWlP3fAT
 FOXugfU0vK7dS9Wx4tF7UjXO6IGTfy/pEXwlyQIWYJIUta8d9NcFU/MolvrtsN+HsH5O
 Dyx1MN06w74mBnYsEOElsW6Cq/IXcNsW398naO1vksEF5TSC5yVNuXZATEYS57HMv5Ww
 EZz6G1WTdAW3R14e12vc+ndX4f9Rd2v3EQPStsfrdsmxFKLEMmSJ34uT0el4h01BezJf
 EBnw==
X-Gm-Message-State: APjAAAWancdhh5HvPjKytk07GWpQGlf4f+eFKnUUaaCKEf3J2Uoc+sJF
 XY7Phkf8a7c1QzXYQiDowLsHIBMg97aGcA==
X-Google-Smtp-Source: APXvYqysUYNwLpFGpXB7aK6DBYGI6cTSoPBzuRqVbpub4N7BK9TEIAgc5KayvZk47O3Fq3EpoC7BwA==
X-Received: by 2002:a37:6f81:: with SMTP id k123mr4055833qkc.321.1559846686738; 
 Thu, 06 Jun 2019 11:44:46 -0700 (PDT)
Received: from ziepe.ca
 (hlfxns017vw-156-34-55-100.dhcp-dynamic.fibreop.ns.bellaliant.net.
 [156.34.55.100])
 by smtp.gmail.com with ESMTPSA id e128sm1194796qkf.90.2019.06.06.11.44.45
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Thu, 06 Jun 2019 11:44:46 -0700 (PDT)
Received: from jgg by mlx.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1hYxNV-0008I5-Dx; Thu, 06 Jun 2019 15:44:45 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH v2 hmm 01/11] mm/hmm: fix use after free with struct hmm in
 the mmu notifiers
Date: Thu,  6 Jun 2019 15:44:28 -0300
Message-Id: <20190606184438.31646-2-jgg@ziepe.ca>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190606184438.31646-1-jgg@ziepe.ca>
References: <20190606184438.31646-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Fri, 07 Jun 2019 07:43:40 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=lL1gh8nawE6RFwsPdkPriGSJ+VnlR7Td1463Tqz8utE=;
 b=i1eoUPW+Np1ntz3bbKM3DpfMNN3rtSLjFDcmDB0vnq8UBH26kk63yNvtdKWmYVv2TV
 Pi+BVA4ti/NZ/Kxq6fbwoxDlR7kj35FAE/DOaimNUrZ5r1sTA5O/bAcr13jRwmRbnpxo
 TDFODNWEBAT/btsMWcqDTmLq2sZ6BFWqMBX8F+5SG9cP5jttZex0XY8bZAT3yEvhQllA
 Ti/dQpvuTYxWENCc1huucv5i9yrAjKo9CBNJ/Lo8NX9PMfBSb4jhB683uChR8oVThjIV
 ISzCmuSiYW97tizaIYodsqJaggibXGQKh2/eAvL6GclckuApULlhfSiRO/Br537Ceq9G
 qQdQ==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, linux-rdma@vger.kernel.org,
 amd-gfx@lists.freedesktop.org, linux-mm@kvack.org,
 Jason Gunthorpe <jgg@mellanox.com>, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKbW11X25vdGlmaWVyX3Vu
cmVnaXN0ZXJfbm9fcmVsZWFzZSgpIGlzIG5vdCBhIGZlbmNlIGFuZCB0aGUgbW11X25vdGlmaWVy
CnN5c3RlbSB3aWxsIGNvbnRpbnVlIHRvIHJlZmVyZW5jZSBobW0tPm1uIHVudGlsIHRoZSBzcmN1
IGdyYWNlIHBlcmlvZApleHBpcmVzLgoKUmVzdWx0aW5nIGluIHVzZSBhZnRlciBmcmVlIHJhY2Vz
IGxpa2UgdGhpczoKCiAgICAgICAgIENQVTAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgQ1BVMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IF9fbW11X25vdGlmaWVyX2ludmFsaWRhdGVfcmFuZ2Vfc3RhcnQoKQogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjdV9yZWFkX2xvY2sKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsaXN0X2Zvcl9lYWNoICgp
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1u
ID09IGhtbS0+bW4KaG1tX21pcnJvcl91bnJlZ2lzdGVyKCkKICBobW1fcHV0KCkKICAgIGhtbV9m
cmVlKCkKICAgICAgbW11X25vdGlmaWVyX3VucmVnaXN0ZXJfbm9fcmVsZWFzZSgpCiAgICAgICAg
IGhsaXN0X2RlbF9pbml0X3JjdShobW0tbW4tPmxpc3QpCgkJCSAgICAgICAgICAgICAgICAgICAg
ICAgICAgIG1uLT5vcHMtPmludmFsaWRhdGVfcmFuZ2Vfc3RhcnQobW4sIHJhbmdlKTsKCQkJCQkg
ICAgICAgICAgICAgbW1fZ2V0X2htbSgpCiAgICAgIG1tLT5obW0gPSBOVUxMOwogICAgICBrZnJl
ZShobW0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgbXV0ZXhfbG9jaygmaG1tLT5sb2NrKTsKClVzZSBTUkNVIHRvIGtmcmVlIHRoZSBobW0gbWVt
b3J5IHNvIHRoYXQgdGhlIG5vdGlmaWVycyBjYW4gcmVseSBvbiBobW0KZXhpc3RpbmcuIEdldCB0
aGUgbm93LXNhZmUgaG1tIHN0cnVjdCB0aHJvdWdoIGNvbnRhaW5lcl9vZiBhbmQgZGlyZWN0bHkK
Y2hlY2sga3JlZl9nZXRfdW5sZXNzX3plcm8gdG8gbG9jayBpdCBhZ2FpbnN0IGZyZWUuCgpTaWdu
ZWQtb2ZmLWJ5OiBKYXNvbiBHdW50aG9ycGUgPGpnZ0BtZWxsYW5veC5jb20+Ci0tLQp2MjoKLSBT
cGVsbCAnZnJlZScgcHJvcGVybHkgKEplcm9tZS9SYWxwaCkKLS0tCiBpbmNsdWRlL2xpbnV4L2ht
bS5oIHwgIDEgKwogbW0vaG1tLmMgICAgICAgICAgICB8IDI1ICsrKysrKysrKysrKysrKysrKyst
LS0tLS0KIDIgZmlsZXMgY2hhbmdlZCwgMjAgaW5zZXJ0aW9ucygrKSwgNiBkZWxldGlvbnMoLSkK
CmRpZmYgLS1naXQgYS9pbmNsdWRlL2xpbnV4L2htbS5oIGIvaW5jbHVkZS9saW51eC9obW0uaApp
bmRleCAwOTJmMDIzNGJmZTkxNy4uNjg4YzVjYTcwNjg3OTUgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUv
bGludXgvaG1tLmgKKysrIGIvaW5jbHVkZS9saW51eC9obW0uaApAQCAtMTAyLDYgKzEwMiw3IEBA
IHN0cnVjdCBobW0gewogCXN0cnVjdCBtbXVfbm90aWZpZXIJbW11X25vdGlmaWVyOwogCXN0cnVj
dCByd19zZW1hcGhvcmUJbWlycm9yc19zZW07CiAJd2FpdF9xdWV1ZV9oZWFkX3QJd3E7CisJc3Ry
dWN0IHJjdV9oZWFkCQlyY3U7CiAJbG9uZwkJCW5vdGlmaWVyczsKIAlib29sCQkJZGVhZDsKIH07
CmRpZmYgLS1naXQgYS9tbS9obW0uYyBiL21tL2htbS5jCmluZGV4IDhlNzQwM2YwODFmNDRhLi41
NDcwMDJmNTZhMTYzZCAxMDA2NDQKLS0tIGEvbW0vaG1tLmMKKysrIGIvbW0vaG1tLmMKQEAgLTEx
Myw2ICsxMTMsMTEgQEAgc3RhdGljIHN0cnVjdCBobW0gKmhtbV9nZXRfb3JfY3JlYXRlKHN0cnVj
dCBtbV9zdHJ1Y3QgKm1tKQogCXJldHVybiBOVUxMOwogfQogCitzdGF0aWMgdm9pZCBobW1fZnJl
ZV9yY3Uoc3RydWN0IHJjdV9oZWFkICpyY3UpCit7CisJa2ZyZWUoY29udGFpbmVyX29mKHJjdSwg
c3RydWN0IGhtbSwgcmN1KSk7Cit9CisKIHN0YXRpYyB2b2lkIGhtbV9mcmVlKHN0cnVjdCBrcmVm
ICprcmVmKQogewogCXN0cnVjdCBobW0gKmhtbSA9IGNvbnRhaW5lcl9vZihrcmVmLCBzdHJ1Y3Qg
aG1tLCBrcmVmKTsKQEAgLTEyNSw3ICsxMzAsNyBAQCBzdGF0aWMgdm9pZCBobW1fZnJlZShzdHJ1
Y3Qga3JlZiAqa3JlZikKIAkJbW0tPmhtbSA9IE5VTEw7CiAJc3Bpbl91bmxvY2soJm1tLT5wYWdl
X3RhYmxlX2xvY2spOwogCi0Ja2ZyZWUoaG1tKTsKKwltbXVfbm90aWZpZXJfY2FsbF9zcmN1KCZo
bW0tPnJjdSwgaG1tX2ZyZWVfcmN1KTsKIH0KIAogc3RhdGljIGlubGluZSB2b2lkIGhtbV9wdXQo
c3RydWN0IGhtbSAqaG1tKQpAQCAtMTUzLDEwICsxNTgsMTQgQEAgdm9pZCBobW1fbW1fZGVzdHJv
eShzdHJ1Y3QgbW1fc3RydWN0ICptbSkKIAogc3RhdGljIHZvaWQgaG1tX3JlbGVhc2Uoc3RydWN0
IG1tdV9ub3RpZmllciAqbW4sIHN0cnVjdCBtbV9zdHJ1Y3QgKm1tKQogewotCXN0cnVjdCBobW0g
KmhtbSA9IG1tX2dldF9obW0obW0pOworCXN0cnVjdCBobW0gKmhtbSA9IGNvbnRhaW5lcl9vZiht
biwgc3RydWN0IGhtbSwgbW11X25vdGlmaWVyKTsKIAlzdHJ1Y3QgaG1tX21pcnJvciAqbWlycm9y
OwogCXN0cnVjdCBobW1fcmFuZ2UgKnJhbmdlOwogCisJLyogaG1tIGlzIGluIHByb2dyZXNzIHRv
IGZyZWUgKi8KKwlpZiAoIWtyZWZfZ2V0X3VubGVzc196ZXJvKCZobW0tPmtyZWYpKQorCQlyZXR1
cm47CisKIAkvKiBSZXBvcnQgdGhpcyBITU0gYXMgZHlpbmcuICovCiAJaG1tLT5kZWFkID0gdHJ1
ZTsKIApAQCAtMTk0LDEzICsyMDMsMTUgQEAgc3RhdGljIHZvaWQgaG1tX3JlbGVhc2Uoc3RydWN0
IG1tdV9ub3RpZmllciAqbW4sIHN0cnVjdCBtbV9zdHJ1Y3QgKm1tKQogc3RhdGljIGludCBobW1f
aW52YWxpZGF0ZV9yYW5nZV9zdGFydChzdHJ1Y3QgbW11X25vdGlmaWVyICptbiwKIAkJCWNvbnN0
IHN0cnVjdCBtbXVfbm90aWZpZXJfcmFuZ2UgKm5yYW5nZSkKIHsKLQlzdHJ1Y3QgaG1tICpobW0g
PSBtbV9nZXRfaG1tKG5yYW5nZS0+bW0pOworCXN0cnVjdCBobW0gKmhtbSA9IGNvbnRhaW5lcl9v
Zihtbiwgc3RydWN0IGhtbSwgbW11X25vdGlmaWVyKTsKIAlzdHJ1Y3QgaG1tX21pcnJvciAqbWly
cm9yOwogCXN0cnVjdCBobW1fdXBkYXRlIHVwZGF0ZTsKIAlzdHJ1Y3QgaG1tX3JhbmdlICpyYW5n
ZTsKIAlpbnQgcmV0ID0gMDsKIAotCVZNX0JVR19PTighaG1tKTsKKwkvKiBobW0gaXMgaW4gcHJv
Z3Jlc3MgdG8gZnJlZSAqLworCWlmICgha3JlZl9nZXRfdW5sZXNzX3plcm8oJmhtbS0+a3JlZikp
CisJCXJldHVybiAwOwogCiAJdXBkYXRlLnN0YXJ0ID0gbnJhbmdlLT5zdGFydDsKIAl1cGRhdGUu
ZW5kID0gbnJhbmdlLT5lbmQ7CkBAIC0yNDUsOSArMjU2LDExIEBAIHN0YXRpYyBpbnQgaG1tX2lu
dmFsaWRhdGVfcmFuZ2Vfc3RhcnQoc3RydWN0IG1tdV9ub3RpZmllciAqbW4sCiBzdGF0aWMgdm9p
ZCBobW1faW52YWxpZGF0ZV9yYW5nZV9lbmQoc3RydWN0IG1tdV9ub3RpZmllciAqbW4sCiAJCQlj
b25zdCBzdHJ1Y3QgbW11X25vdGlmaWVyX3JhbmdlICpucmFuZ2UpCiB7Ci0Jc3RydWN0IGhtbSAq
aG1tID0gbW1fZ2V0X2htbShucmFuZ2UtPm1tKTsKKwlzdHJ1Y3QgaG1tICpobW0gPSBjb250YWlu
ZXJfb2YobW4sIHN0cnVjdCBobW0sIG1tdV9ub3RpZmllcik7CiAKLQlWTV9CVUdfT04oIWhtbSk7
CisJLyogaG1tIGlzIGluIHByb2dyZXNzIHRvIGZyZWUgKi8KKwlpZiAoIWtyZWZfZ2V0X3VubGVz
c196ZXJvKCZobW0tPmtyZWYpKQorCQlyZXR1cm47CiAKIAltdXRleF9sb2NrKCZobW0tPmxvY2sp
OwogCWhtbS0+bm90aWZpZXJzLS07Ci0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVs
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
