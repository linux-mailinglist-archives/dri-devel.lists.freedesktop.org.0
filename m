Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 5134E1E8601
	for <lists+dri-devel@lfdr.de>; Fri, 29 May 2020 19:57:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 57F676E95C;
	Fri, 29 May 2020 17:57:15 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from asav22.altibox.net (asav22.altibox.net [109.247.116.9])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D51A96E95C
 for <dri-devel@lists.freedesktop.org>; Fri, 29 May 2020 17:57:07 +0000 (UTC)
Received: from localhost.localdomain (unknown [81.166.168.211])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-SHA256 (128/128 bits))
 (No client certificate requested)
 (Authenticated sender: noralf.tronnes@ebnett.no)
 by asav22.altibox.net (Postfix) with ESMTPSA id 4957C200D8;
 Fri, 29 May 2020 19:57:04 +0200 (CEST)
From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
To: dri-devel@lists.freedesktop.org,
	balbi@kernel.org
Subject: [PATCH v3 5/6] drm/gud: Add functionality for the USB gadget side
Date: Fri, 29 May 2020 19:56:42 +0200
Message-Id: <20200529175643.46094-6-noralf@tronnes.org>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20200529175643.46094-1-noralf@tronnes.org>
References: <20200529175643.46094-1-noralf@tronnes.org>
MIME-Version: 1.0
X-CMAE-Score: 0
X-CMAE-Analysis: v=2.3 cv=LvK8NEVc c=1 sm=1 tr=0
 a=OYZzhG0JTxDrWp/F2OJbnw==:117 a=OYZzhG0JTxDrWp/F2OJbnw==:17
 a=IkcTkHD0fZMA:10 a=M51BFTxLslgA:10 a=SJz97ENfAAAA:8
 a=JEiCMFymvXJ_tcOM5XYA:9 a=g-H6GvAlq0W4zGb9:21 a=eoMYUHcxvnIfTj1J:21
 a=QEXdDO2ut3YA:10 a=vFet0B0WnEQeilDPIY6i:22
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: linux-usb@vger.kernel.org, sam@ravnborg.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2UgdGhlIFVTQiBnYWRnZXQvZGV2aWNlIGhhcyB0byByZWFjaCBpbnRvIHRoZSBEUk0gaW50
ZXJuYWxzLCBwYXJ0IG9mCnRoZSBjb2RlIGlzIHBsYWNlZCBpbiB0aGUgRFJNIHN1YnN5c3RlbSBh
cyBhIHNlcGFyYXRlIG1vZHVsZS4gQWxsIGNhbGxzCmludG8gdGhpcyBtb2R1bGUgcnVucyBpbiBw
cm9jZXNzIGNvbnRleHQgYW5kIGFyZSBzZXJpYWxpemVkLCBleGNlcHQgb25lCmZ1bmN0aW9uIHRo
YXQgcnVucyBpbiBpbnRlcnJ1cHQgY29udGV4dC4KClNpbmNlIGJvdGggdGhlIGdhZGdldCBzaWRl
IGFuZCB0aGUgRFJNIHNpZGUgY2FuIGRpc2FibGUgdGhlIGdhZGdldCwKc3BlY2lhbCBjYXJlIGhh
cyBiZWVuIHRha2VuIHRvIG1ha2UgdGhhdCBzYWZlLgoKdjI6Ci0gVXNlIGRybV9jbGllbnRfbW9k
ZXNldF9kaXNhYmxlKCkKClNpZ25lZC1vZmYtYnk6IE5vcmFsZiBUcsO4bm5lcyA8bm9yYWxmQHRy
b25uZXMub3JnPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9ndWQvS2NvbmZpZyAgICAgICAgICB8ICAg
IDYgKwogZHJpdmVycy9ncHUvZHJtL2d1ZC9NYWtlZmlsZSAgICAgICAgIHwgICAgMSArCiBkcml2
ZXJzL2dwdS9kcm0vZ3VkL2d1ZF9kcm1fZ2FkZ2V0LmMgfCAxMTY3ICsrKysrKysrKysrKysrKysr
KysrKysrKysrCiBpbmNsdWRlL2RybS9ndWRfZHJtLmggICAgICAgICAgICAgICAgfCAgIDEzICsK
IDQgZmlsZXMgY2hhbmdlZCwgMTE4NyBpbnNlcnRpb25zKCspCiBjcmVhdGUgbW9kZSAxMDA2NDQg
ZHJpdmVycy9ncHUvZHJtL2d1ZC9ndWRfZHJtX2dhZGdldC5jCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2d1ZC9LY29uZmlnIGIvZHJpdmVycy9ncHUvZHJtL2d1ZC9LY29uZmlnCmluZGV4
IDc2N2YxYzA2N2VkOS4uOWJiZjM5YWU2MTkxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
Z3VkL0tjb25maWcKKysrIGIvZHJpdmVycy9ncHUvZHJtL2d1ZC9LY29uZmlnCkBAIC0xMiwzICsx
Miw5IEBAIGNvbmZpZyBEUk1fR1VECiAJICBhZGFwdGVycy4KIAogCSAgSWYgTSBpcyBzZWxlY3Rl
ZCB0aGUgbW9kdWxlIHdpbGwgYmUgY2FsbGVkIGd1ZF9kcm0uCisKK2NvbmZpZyBEUk1fR1VEX0dB
REdFVAorCXRyaXN0YXRlCisJZGVwZW5kcyBvbiBEUk0KKwlzZWxlY3QgTFo0X0RFQ09NUFJFU1MK
KwlzZWxlY3QgQkFDS0xJR0hUX0NMQVNTX0RFVklDRQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2d1ZC9NYWtlZmlsZSBiL2RyaXZlcnMvZ3B1L2RybS9ndWQvTWFrZWZpbGUKaW5kZXggNzNl
ZDdlZjNkYTk0Li5mYjVjZmJkOTNkMGYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9ndWQv
TWFrZWZpbGUKKysrIGIvZHJpdmVycy9ncHUvZHJtL2d1ZC9NYWtlZmlsZQpAQCAtMiwzICsyLDQg
QEAKIAogZ3VkX2RybS1vYmpzCQkJOj0gZ3VkX2RybV9kcnYubyBndWRfZHJtX3BpcGUubyBndWRf
ZHJtX2Nvbm5lY3Rvci5vCiBvYmotJChDT05GSUdfRFJNX0dVRCkJCSs9IGd1ZF9kcm0ubworb2Jq
LSQoQ09ORklHX0RSTV9HVURfR0FER0VUKQkrPSBndWRfZHJtX2dhZGdldC5vCmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vZ3VkL2d1ZF9kcm1fZ2FkZ2V0LmMgYi9kcml2ZXJzL2dwdS9kcm0v
Z3VkL2d1ZF9kcm1fZ2FkZ2V0LmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAw
MDAwLi45MTNhYTVhOGQwNzUKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vZ3Vk
L2d1ZF9kcm1fZ2FkZ2V0LmMKQEAgLTAsMCArMSwxMTY3IEBACisvLyBTUERYLUxpY2Vuc2UtSWRl
bnRpZmllcjogR1BMLTIuMAorLyoKKyAqIENvcHlyaWdodCAyMDIwIE5vcmFsZiBUcsO4bm5lcwor
ICovCisKKyNpbmNsdWRlIDxsaW51eC9iYWNrbGlnaHQuaD4KKyNpbmNsdWRlIDxsaW51eC9kZWxh
eS5oPgorI2luY2x1ZGUgPGxpbnV4L2x6NC5oPgorI2luY2x1ZGUgPGxpbnV4L21vZHVsZS5oPgor
I2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxsaW51eC9zcGlubG9jay5oPgorI2lu
Y2x1ZGUgPGxpbnV4L3N0cmluZy5oPgorCisjaW5jbHVkZSA8ZHJtL2RybV9jbGllbnQuaD4KKyNp
bmNsdWRlIDxkcm0vZHJtX2Nvbm5lY3Rvci5oPgorI2luY2x1ZGUgPGRybS9kcm1fY3J0Yy5oPgor
I2luY2x1ZGUgPGRybS9kcm1fZm91cmNjLmg+CisjaW5jbHVkZSA8ZHJtL2RybV9tb2RlX29iamVj
dC5oPgorI2luY2x1ZGUgPGRybS9kcm1fcGxhbmUuaD4KKyNpbmNsdWRlIDxkcm0vZHJtX3JlY3Qu
aD4KKyNpbmNsdWRlIDxkcm0vZ3VkX2RybS5oPgorCisjaW5jbHVkZSAiZ3VkX2RybV9pbnRlcm5h
bC5oIgorCisvKgorICogQ29uY3VycmVuY3k6CisgKiBDYWxscyBpbnRvIHRoaXMgbW9kdWxlIGZy
b20gZl9ndWRfZHJtIGFyZSBzZXJpYWxpemVkIGFuZCBydW4gaW4gcHJvY2VzcworICogY29udGV4
dCBleGNlcHQgZ3VkX2RybV9nYWRnZXRfY3RybF9nZXQoKSB3aGljaCBpcyBydW4gaW4gaW50ZXJy
dXB0IGNvbnRleHQuCisgKgorICogVGVybWluYXRpb246CisgKiBBIERSTSBjbGllbnQgY2FuIG5v
dCByZWxlYXNlIGl0c2VsZiwgb25seSB0aGUgRFJNIGRyaXZlciB3aGljaCByZXNvdXJjZXMgdGhl
CisgKiBjbGllbnQgdXNlcyBjYW4gZG8gdGhhdC4KKyAqIFRoaXMgbWVhbnMgdGhhdCB0aGVyZSBh
cmUgMiBwYXRocyB0byBzdG9wIHRoZSBnYWRnZXQgZnVuY3Rpb246CisgKiAtIFVucmVnaXN0ZXJp
bmcgdGhlIERSTSBkcml2ZXIgKG1vZHVsZSB1bmxvYWQpCisgKiAtIERpc2FibGluZyB0aGUgVVNC
IGdhZGdldCAoY29uZmlnZnMgdW5iaW5kKQorICoKKyAqIEEgdXNlIGNvdW50ZXIgcHJvdGVjdHMg
dGhlIGdhZGdldCBzaG91bGQgdGhlIGNsaWVudCBnbyBhd2F5LiBBIGtyZWYgaXMgdXNlZAorICog
dG8gY29udHJvbCB0aGUgcmVsZWFzZSBvZiB0aGUgZ3VkX2RybV9nYWRnZXQgc3RydWN0dXJlIHNo
YXJlZCBieSB0aGUgMiBhY3RvcnMuCisgKgorICogQmFja2xpZ2h0OgorICogSWYgdGhlcmUncyBh
IGJhY2tsaWdodCBkZXZpY2UgaXQncyBhdHRhY2hlZCB0byB0aGUgZmlyc3QgY29ubmVjdG9yLgor
ICovCisKK3N0cnVjdCBndWRfZHJtX2dhZGdldF9jb25uZWN0b3IgeworCXN0cnVjdCBkcm1fY29u
bmVjdG9yICpjb25uZWN0b3I7CisKKwljb25zdCBzdHJ1Y3QgZ3VkX2RybV9wcm9wZXJ0eSAqcHJv
cGVydGllczsKKwl1bnNpZ25lZCBpbnQgbnVtX3Byb3BlcnRpZXM7CisJY29uc3QgY2hhciAqdHZf
bW9kZV9lbnVtX25hbWVzOworCXVuc2lnbmVkIGludCBudW1fdHZfbW9kZV9lbnVtX25hbWVzOwor
CXN0cnVjdCBiYWNrbGlnaHRfZGV2aWNlICpiYWNrbGlnaHQ7CisKKwlzcGlubG9ja190IGxvY2s7
IC8qIFByb3RlY3RzIHRoZSBmb2xsb3dpbmcgbWVtYmVyczogKi8KKwllbnVtIGRybV9jb25uZWN0
b3Jfc3RhdHVzIHN0YXR1czsKKwl1bnNpZ25lZCBpbnQgd2lkdGhfbW07CisJdW5zaWduZWQgaW50
IGhlaWdodF9tbTsKKwlzdHJ1Y3QgZ3VkX2RybV9kaXNwbGF5X21vZGUgKm1vZGVzOworCXVuc2ln
bmVkIGludCBudW1fbW9kZXM7CisJdm9pZCAqZWRpZDsKKwlzaXplX3QgZWRpZF9sZW47CisJYm9v
bCBjaGFuZ2VkOworfTsKKworc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0IHsKKwlzdHJ1Y3Qga3JlZiBy
ZWZjb3VudDsKKwlyZWZjb3VudF90IHVzZWNudDsKKwlzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgY2xp
ZW50OworCXN0cnVjdCBiYWNrbGlnaHRfZGV2aWNlICpiYWNrbGlnaHQ7CisKKwljb25zdCB1MzIg
KmZvcm1hdHM7CisJdW5zaWduZWQgaW50IGZvcm1hdF9jb3VudDsKKworCWNvbnN0IHN0cnVjdCBn
dWRfZHJtX3Byb3BlcnR5ICpwcm9wZXJ0aWVzOworCXVuc2lnbmVkIGludCBudW1fcHJvcGVydGll
czsKKworCXN0cnVjdCBndWRfZHJtX2dhZGdldF9jb25uZWN0b3IgKmNvbm5lY3RvcnM7CisJdW5z
aWduZWQgaW50IGNvbm5lY3Rvcl9jb3VudDsKKworCXN0cnVjdCBkcm1fcmVjdCBzZXRfYnVmZmVy
X3JlY3Q7CisJdTMyIHNldF9idWZmZXJfbGVuZ3RoOworCXU4IHNldF9idWZmZXJfY29tcHJlc3Np
b247CisJdTMyIHNldF9idWZmZXJfY29tcHJlc3NlZF9sZW5ndGg7CisKKwlzdHJ1Y3QgZHJtX2Ns
aWVudF9idWZmZXIgKmJ1ZmZlcjsKKwlzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlcl9j
aGVjazsKKwl1OCBicmlnaHRuZXNzOworCWJvb2wgY2hlY2tfb2s7CisKKwlzaXplX3QgbWF4X2J1
ZmZlcl9zaXplOworCXZvaWQgKndvcmtfYnVmOworfTsKKworc3RhdGljIGludCBndWRfZHJtX2dh
ZGdldF9wcm9iZV9jb25uZWN0b3Ioc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0X2Nvbm5lY3RvciAqZ2Nv
bm4pCit7CisJc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvciA9IGdjb25uLT5jb25uZWN0
b3I7CisJc3RydWN0IGd1ZF9kcm1fZGlzcGxheV9tb2RlICptb2RlcyA9IE5VTEw7CisJc3RydWN0
IGRybV9kZXZpY2UgKmRybSA9IGNvbm5lY3Rvci0+ZGV2OworCXN0cnVjdCBkcm1fZGlzcGxheV9t
b2RlICptb2RlOworCXZvaWQgKmVkaWRfZGF0YSwgKmVkaWQgPSBOVUxMOworCXVuc2lnbmVkIGlu
dCBudW1fbW9kZXMgPSAwOworCXNpemVfdCBlZGlkX2xlbiA9IDA7CisJdW5zaWduZWQgbG9uZyBm
bGFnczsKKwl1bnNpZ25lZCBpbnQgaSA9IDA7CisJaW50IHJldCA9IDA7CisKKwltdXRleF9sb2Nr
KCZkcm0tPm1vZGVfY29uZmlnLm11dGV4KTsKKworCWNvbm5lY3Rvci0+ZnVuY3MtPmZpbGxfbW9k
ZXMoY29ubmVjdG9yLAorCQkJCSAgICAgZHJtLT5tb2RlX2NvbmZpZy5tYXhfd2lkdGgsCisJCQkJ
ICAgICBkcm0tPm1vZGVfY29uZmlnLm1heF9oZWlnaHQpOworCisJbGlzdF9mb3JfZWFjaF9lbnRy
eShtb2RlLCAmY29ubmVjdG9yLT5tb2RlcywgaGVhZCkKKwkJbnVtX21vZGVzKys7CisKKwlpZiAo
IW51bV9tb2RlcykKKwkJZ290byB1cGRhdGU7CisKKwltb2RlcyA9IGttYWxsb2NfYXJyYXkobnVt
X21vZGVzLCBzaXplb2YoKm1vZGVzKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFtb2RlcykgeworCQly
ZXQgPSAtRU5PTUVNOworCQludW1fbW9kZXMgPSAwOworCQlnb3RvIHVwZGF0ZTsKKwl9CisKKwls
aXN0X2Zvcl9lYWNoX2VudHJ5KG1vZGUsICZjb25uZWN0b3ItPm1vZGVzLCBoZWFkKQorCQlndWRf
ZHJtX2Zyb21fZGlzcGxheV9tb2RlKCZtb2Rlc1tpKytdLCBtb2RlKTsKKworCWlmICghY29ubmVj
dG9yLT5lZGlkX2Jsb2JfcHRyKQorCQlnb3RvIHVwZGF0ZTsKKworCWVkaWRfZGF0YSA9IGNvbm5l
Y3Rvci0+ZWRpZF9ibG9iX3B0ci0+ZGF0YTsKKwllZGlkX2xlbiA9IGNvbm5lY3Rvci0+ZWRpZF9i
bG9iX3B0ci0+bGVuZ3RoOworCWlmICghZWRpZF9kYXRhIHx8ICFlZGlkX2xlbikgeworCQllZGlk
X2xlbiA9IDA7CisJCWdvdG8gdXBkYXRlOworCX0KKworCWVkaWQgPSBrbWVtZHVwKGVkaWRfZGF0
YSwgZWRpZF9sZW4sIEdGUF9LRVJORUwpOworCWlmICghZWRpZCkgeworCQlyZXQgPSAtRU5PTUVN
OworCQllZGlkX2xlbiA9IDA7CisJfQorCit1cGRhdGU6CisJc3Bpbl9sb2NrX2lycXNhdmUoJmdj
b25uLT5sb2NrLCBmbGFncyk7CisJaWYgKGdjb25uLT5zdGF0dXMgIT0gY29ubmVjdG9yLT5zdGF0
dXMgfHwgZ2Nvbm4tPm51bV9tb2RlcyAhPSBudW1fbW9kZXMgfHwKKwkgICAgZ2Nvbm4tPmVkaWRf
bGVuICE9IGVkaWRfbGVuIHx8CisJICAgIChnY29ubi0+bW9kZXMgJiYgbW9kZXMgJiYgbWVtY21w
KGdjb25uLT5tb2RlcywgbW9kZXMsIG51bV9tb2RlcyAqIHNpemVvZigqbW9kZXMpKSkgfHwKKwkg
ICAgKGdjb25uLT5lZGlkICYmIGVkaWQgJiYgbWVtY21wKGdjb25uLT5lZGlkLCBlZGlkLCBlZGlk
X2xlbikpKQorCQlnY29ubi0+Y2hhbmdlZCA9IHRydWU7CisJc3dhcChnY29ubi0+bW9kZXMsIG1v
ZGVzKTsKKwlnY29ubi0+bnVtX21vZGVzID0gbnVtX21vZGVzOworCXN3YXAoZ2Nvbm4tPmVkaWQs
IGVkaWQpOworCWdjb25uLT5lZGlkX2xlbiA9IGVkaWRfbGVuOworCWdjb25uLT53aWR0aF9tbSA9
IGNvbm5lY3Rvci0+ZGlzcGxheV9pbmZvLndpZHRoX21tOworCWdjb25uLT5oZWlnaHRfbW0gPSBj
b25uZWN0b3ItPmRpc3BsYXlfaW5mby5oZWlnaHRfbW07CisJZ2Nvbm4tPnN0YXR1cyA9IGNvbm5l
Y3Rvci0+c3RhdHVzOworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmdjb25uLT5sb2NrLCBmbGFn
cyk7CisKKwltdXRleF91bmxvY2soJmRybS0+bW9kZV9jb25maWcubXV0ZXgpOworCisJa2ZyZWUo
ZWRpZCk7CisJa2ZyZWUobW9kZXMpOworCisJcmV0dXJuIHJldDsKK30KKworc3RhdGljIHZvaWQg
Z3VkX2RybV9nYWRnZXRfcHJvYmVfY29ubmVjdG9ycyhzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdk
ZykKK3sKKwl1bnNpZ25lZCBpbnQgaTsKKworCWZvciAoaSA9IDA7IGkgPCBnZGctPmNvbm5lY3Rv
cl9jb3VudDsgaSsrKQorCQlndWRfZHJtX2dhZGdldF9wcm9iZV9jb25uZWN0b3IoJmdkZy0+Y29u
bmVjdG9yc1tpXSk7Cit9CisKK3N0YXRpYyBib29sIGd1ZF9kcm1fZ2FkZ2V0X2NoZWNrX2J1ZmZl
cihzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywKKwkJCQkJc3RydWN0IGRybV9jbGllbnRfYnVm
ZmVyICpidWZmZXIsCisJCQkJCXN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICptb2RlLAorCQkJCQl1
MzIgZm9ybWF0KQoreworCXN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiOworCisJaWYgKCFidWZm
ZXIpCisJCXJldHVybiBmYWxzZTsKKworCWZiID0gYnVmZmVyLT5mYjsKKworCXJldHVybiBmYi0+
Zm9ybWF0LT5mb3JtYXQgPT0gZm9ybWF0ICYmCisJICAgICAgIGZiLT53aWR0aCA9PSBtb2RlLT5o
ZGlzcGxheSAmJiBmYi0+aGVpZ2h0ID09IG1vZGUtPnZkaXNwbGF5OworfQorCitzdGF0aWMgYm9v
bCBndWRfZHJtX2dhZGdldF9zZXRfY29ubmVjdG9yX3Byb3BlcnR5KHN0cnVjdCBkcm1fY2xpZW50
X2RldiAqY2xpZW50LAorCQkJCQkJICBzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqY29ubmVjdG9yLAor
CQkJCQkJICB1MTYgcHJvcCwgdTY0IHZhbCwgaW50ICpyZXQpCit7CisJc3RydWN0IGRybV9tb2Rl
X2NvbmZpZyAqY29uZmlnID0gJmNvbm5lY3Rvci0+ZGV2LT5tb2RlX2NvbmZpZzsKKwlzdHJ1Y3Qg
ZHJtX3Byb3BlcnR5ICpwcm9wZXJ0eTsKKworCXN3aXRjaCAocHJvcCkgeworCWNhc2UgR1VEX0RS
TV9QUk9QRVJUWV9UVl9TRUxFQ1RfU1VCQ09OTkVDVE9SOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+
dHZfc2VsZWN0X3N1YmNvbm5lY3Rvcl9wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBHVURfRFJN
X1BST1BFUlRZX1RWX0xFRlRfTUFSR0lOOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+dHZfbGVmdF9t
YXJnaW5fcHJvcGVydHk7CisJCWJyZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9SSUdI
VF9NQVJHSU46CisJCXByb3BlcnR5ID0gY29uZmlnLT50dl9yaWdodF9tYXJnaW5fcHJvcGVydHk7
CisJCWJyZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9UT1BfTUFSR0lOOgorCQlwcm9w
ZXJ0eSA9IGNvbmZpZy0+dHZfdG9wX21hcmdpbl9wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBH
VURfRFJNX1BST1BFUlRZX1RWX0JPVFRPTV9NQVJHSU46CisJCXByb3BlcnR5ID0gY29uZmlnLT50
dl9ib3R0b21fbWFyZ2luX3Byb3BlcnR5OworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fUFJPUEVS
VFlfVFZfTU9ERToKKwkJcHJvcGVydHkgPSBjb25maWctPnR2X21vZGVfcHJvcGVydHk7CisJCWJy
ZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9CUklHSFRORVNTOgorCQlwcm9wZXJ0eSA9
IGNvbmZpZy0+dHZfYnJpZ2h0bmVzc19wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBHVURfRFJN
X1BST1BFUlRZX1RWX0NPTlRSQVNUOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+dHZfY29udHJhc3Rf
cHJvcGVydHk7CisJCWJyZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9GTElDS0VSX1JF
RFVDVElPTjoKKwkJcHJvcGVydHkgPSBjb25maWctPnR2X2ZsaWNrZXJfcmVkdWN0aW9uX3Byb3Bl
cnR5OworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fUFJPUEVSVFlfVFZfT1ZFUlNDQU46CisJCXBy
b3BlcnR5ID0gY29uZmlnLT50dl9vdmVyc2Nhbl9wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBH
VURfRFJNX1BST1BFUlRZX1RWX1NBVFVSQVRJT046CisJCXByb3BlcnR5ID0gY29uZmlnLT50dl9z
YXR1cmF0aW9uX3Byb3BlcnR5OworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fUFJPUEVSVFlfVFZf
SFVFOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+dHZfaHVlX3Byb3BlcnR5OworCQlicmVhazsKKwlk
ZWZhdWx0OgorCQlyZXR1cm4gZmFsc2U7CisJfQorCisJKnJldCA9IGRybV9jbGllbnRfbW9kZXNl
dF9zZXRfcHJvcGVydHkoY2xpZW50LCAmY29ubmVjdG9yLT5iYXNlLCBwcm9wZXJ0eSwgdmFsKTsK
KworCXJldHVybiB0cnVlOworfQorCitzdGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2NoZWNrKHN0
cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnLCBzdHJ1Y3QgZ3VkX2RybV9yZXFfc2V0X3N0YXRlICpy
ZXEsCisJCQkJc2l6ZV90IHNpemUpCit7CisJc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQg
PSAmZ2RnLT5jbGllbnQ7CisJdTMyIGZvcm1hdCA9IGxlMzJfdG9fY3B1KHJlcS0+Zm9ybWF0KTsK
KwlzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlcjsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3Rv
ciAqY29ubmVjdG9yOworCXN0cnVjdCBkcm1fZGlzcGxheV9tb2RlIG1vZGU7CisJdW5zaWduZWQg
aW50IGk7CisJdm9pZCAqdmFkZHI7CisJaW50IHJldDsKKworCWlmIChzaXplIDwgc2l6ZW9mKHN0
cnVjdCBndWRfZHJtX3JlcV9zZXRfc3RhdGUpKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCWlmIChz
aXplICE9IHN0cnVjdF9zaXplKHJlcSwgcHJvcGVydGllcywgcmVxLT5udW1fcHJvcGVydGllcykp
CisJCXJldHVybiAtRUlOVkFMOworCisJbWVtc2V0KCZtb2RlLCAwLCBzaXplb2YobW9kZSkpOwor
CWd1ZF9kcm1fdG9fZGlzcGxheV9tb2RlKCZtb2RlLCAmcmVxLT5tb2RlKTsKKworCWdkZy0+Y2hl
Y2tfb2sgPSBmYWxzZTsKKworCWlmICghbW9kZS5oZGlzcGxheSB8fCAhZm9ybWF0KQorCQlyZXR1
cm4gLUVJTlZBTDsKKworCWlmIChyZXEtPmNvbm5lY3RvciA+PSBnZGctPmNvbm5lY3Rvcl9jb3Vu
dCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwljb25uZWN0b3IgPSBnZGctPmNvbm5lY3RvcnNbcmVx
LT5jb25uZWN0b3JdLmNvbm5lY3RvcjsKKworCWlmIChnZGctPmJ1ZmZlcl9jaGVjaykgeworCQlk
cm1fY2xpZW50X2ZyYW1lYnVmZmVyX2RlbGV0ZShnZGctPmJ1ZmZlcl9jaGVjayk7CisJCWdkZy0+
YnVmZmVyX2NoZWNrID0gTlVMTDsKKwl9CisKKwlpZiAoIWd1ZF9kcm1fZ2FkZ2V0X2NoZWNrX2J1
ZmZlcihnZGcsIGdkZy0+YnVmZmVyLCAmbW9kZSwgZm9ybWF0KSkgeworCQlidWZmZXIgPSBkcm1f
Y2xpZW50X2ZyYW1lYnVmZmVyX2NyZWF0ZShjbGllbnQsIG1vZGUuaGRpc3BsYXksIG1vZGUudmRp
c3BsYXksCisJCQkJCQkgICAgICAgZm9ybWF0KTsKKwkJaWYgKElTX0VSUihidWZmZXIpKQorCQkJ
cmV0dXJuIFBUUl9FUlIoYnVmZmVyKTsKKworCQl2YWRkciA9IGRybV9jbGllbnRfYnVmZmVyX3Zt
YXAoYnVmZmVyKTsKKwkJaWYgKElTX0VSUih2YWRkcikpIHsKKwkJCWRybV9jbGllbnRfZnJhbWVi
dWZmZXJfZGVsZXRlKGJ1ZmZlcik7CisJCQlyZXR1cm4gUFRSX0VSUih2YWRkcik7CisJCX0KKwor
CQlnZGctPmJ1ZmZlcl9jaGVjayA9IGJ1ZmZlcjsKKwl9IGVsc2UgeworCQlidWZmZXIgPSBnZGct
PmJ1ZmZlcjsKKwl9CisKKwlyZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfc2V0KGNsaWVudCwgY29u
bmVjdG9yLCAmbW9kZSwgYnVmZmVyLT5mYik7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKwor
CWZvciAoaSA9IDA7IGkgPCByZXEtPm51bV9wcm9wZXJ0aWVzOyBpKyspIHsKKwkJdTE2IHByb3Ag
PSBsZTE2X3RvX2NwdShyZXEtPnByb3BlcnRpZXNbaV0ucHJvcCk7CisJCXU2NCB2YWwgPSBsZTY0
X3RvX2NwdShyZXEtPnByb3BlcnRpZXNbaV0udmFsKTsKKworCQlpZiAoZ3VkX2RybV9nYWRnZXRf
c2V0X2Nvbm5lY3Rvcl9wcm9wZXJ0eShjbGllbnQsIGNvbm5lY3RvciwgcHJvcCwgdmFsLCAmcmV0
KSkgeworCQkJaWYgKHJldCkKKwkJCQlyZXR1cm4gcmV0OworCQkJY29udGludWU7CisJCX0KKwor
CQlzd2l0Y2ggKHByb3ApIHsKKwkJY2FzZSBHVURfRFJNX1BST1BFUlRZX0JBQ0tMSUdIVF9CUklH
SFRORVNTOgorCQkJaWYgKHZhbCA+IDEwMCkKKwkJCQlyZXR1cm4gLUVJTlZBTDsKKwkJCWdkZy0+
YnJpZ2h0bmVzcyA9IHZhbDsKKwkJCWJyZWFrOworCQljYXNlIEdVRF9EUk1fUFJPUEVSVFlfUk9U
QVRJT046CisJCQlyZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfc2V0X3JvdGF0aW9uKGNsaWVudCwg
dmFsKTsKKwkJCWJyZWFrOworCQlkZWZhdWx0OgorCQkJcHJfZXJyKCIlczogVW5rbm93biBwcm9w
ZXJ0eTogJXVcbiIsIF9fZnVuY19fLCBwcm9wKTsKKwkJCWNvbnRpbnVlOworCQl9CisKKwkJaWYg
KHJldCkKKwkJCXJldHVybiByZXQ7CisJfQorCisJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2No
ZWNrKCZnZGctPmNsaWVudCk7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKworCWdkZy0+Y2hl
Y2tfb2sgPSB0cnVlOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgZ3VkX2RybV9nYWRn
ZXRfY29tbWl0KHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnKQoreworCWludCByZXQ7CisKKwlp
ZiAoIWdkZy0+Y2hlY2tfb2spCisJCXJldHVybiAtRUlOVkFMOworCisJaWYgKGdkZy0+YmFja2xp
Z2h0KSB7CisJCWludCB2YWwsIG1heF9icmlnaHRuZXNzID0gZ2RnLT5iYWNrbGlnaHQtPnByb3Bz
Lm1heF9icmlnaHRuZXNzOworCisJCXZhbCA9IERJVjY0X1U2NF9ST1VORF9VUChnZGctPmJyaWdo
dG5lc3MgKiBtYXhfYnJpZ2h0bmVzcywgMTAwKTsKKwkJcmV0ID0gYmFja2xpZ2h0X2RldmljZV9z
ZXRfYnJpZ2h0bmVzcyhnZGctPmJhY2tsaWdodCwgdmFsKTsKKwkJaWYgKHJldCkKKwkJCXJldHVy
biByZXQ7CisJfQorCisJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdCgmZ2RnLT5jbGll
bnQpOworCWlmIChyZXQpCisJCXJldHVybiByZXQ7CisKKwlpZiAoZ2RnLT5idWZmZXJfY2hlY2sp
IHsKKwkJZHJtX2NsaWVudF9mcmFtZWJ1ZmZlcl9kZWxldGUoZ2RnLT5idWZmZXIpOworCQlnZGct
PmJ1ZmZlciA9IGdkZy0+YnVmZmVyX2NoZWNrOworCQlnZGctPmJ1ZmZlcl9jaGVjayA9IE5VTEw7
CisJfQorCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBzaXplX3QgZ3VkX2RybV9nYWRnZXRfd3Jp
dGVfYnVmZmVyX21lbWNweShzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlciwKKwkJCQkJ
CSBjb25zdCB2b2lkICpzcmMsIHNpemVfdCBsZW4sCisJCQkJCQkgc3RydWN0IGRybV9yZWN0ICpy
ZWN0KQoreworCXVuc2lnbmVkIGludCBjcHAgPSBidWZmZXItPmZiLT5mb3JtYXQtPmNwcFswXTsK
KwlzaXplX3QgZHN0X3BpdGNoID0gYnVmZmVyLT5mYi0+cGl0Y2hlc1swXTsKKwlzaXplX3Qgc3Jj
X3BpdGNoID0gZHJtX3JlY3Rfd2lkdGgocmVjdCkgKiBjcHA7CisJdW5zaWduZWQgaW50IHk7CisJ
dm9pZCAqZHN0OworCisJLyogR2V0IHRoZSBhZGRyZXNzLCBpdCdzIGFscmVhZHkgbWFwcGVkICov
CisJZHN0ID0gZHJtX2NsaWVudF9idWZmZXJfdm1hcChidWZmZXIpOworCWRzdCArPSByZWN0LT55
MSAqIGRzdF9waXRjaDsKKwlkc3QgKz0gcmVjdC0+eDEgKiBjcHA7CisKKwlmb3IgKHkgPSAwOyB5
IDwgZHJtX3JlY3RfaGVpZ2h0KHJlY3QpICYmIGxlbjsgeSsrKSB7CisJCXNyY19waXRjaCA9IG1p
bihzcmNfcGl0Y2gsIGxlbik7CisJCW1lbWNweShkc3QsIHNyYywgc3JjX3BpdGNoKTsKKwkJc3Jj
ICs9IHNyY19waXRjaDsKKwkJZHN0ICs9IGRzdF9waXRjaDsKKwkJbGVuIC09IHNyY19waXRjaDsK
Kwl9CisKKwlyZXR1cm4gbGVuOworfQorCitzdGF0aWMgYm9vbCBndWRfZHJtX2dhZGdldF9jaGVj
a19yZWN0KHN0cnVjdCBkcm1fY2xpZW50X2J1ZmZlciAqYnVmZmVyLCBzdHJ1Y3QgZHJtX3JlY3Qg
KnJlY3QpCit7CisJcmV0dXJuIGJ1ZmZlci0+ZmIgJiYgcmVjdC0+eDEgPCByZWN0LT54MiAmJiBy
ZWN0LT55MSA8IHJlY3QtPnkyICYmCisJICAgICAgIHJlY3QtPngyIDw9IGJ1ZmZlci0+ZmItPndp
ZHRoICYmIHJlY3QtPnkyIDw9IGJ1ZmZlci0+ZmItPmhlaWdodDsKK30KKworaW50IGd1ZF9kcm1f
Z2FkZ2V0X3dyaXRlX2J1ZmZlcihzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywgY29uc3Qgdm9p
ZCAqYnVmLCBzaXplX3QgbGVuKQoreworCXN0cnVjdCBkcm1fY2xpZW50X2J1ZmZlciAqYnVmZmVy
ID0gZ2RnLT5idWZmZXIgPyBnZGctPmJ1ZmZlciA6IGdkZy0+YnVmZmVyX2NoZWNrOworCXN0cnVj
dCBkcm1fcmVjdCAqcmVjdCA9ICZnZGctPnNldF9idWZmZXJfcmVjdDsKKwl1OCBjb21wcmVzc2lv
biA9IGdkZy0+c2V0X2J1ZmZlcl9jb21wcmVzc2lvbjsKKwlzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVy
ICpmYjsKKwlzaXplX3QgcmVtYWluOworCWludCByZXQ7CisKKwlwcl9kZWJ1ZygiJXM6IGxlbj0l
enUgY29tcHJlc3Npb249MHgleFxuIiwgX19mdW5jX18sIGxlbiwgY29tcHJlc3Npb24pOworCisJ
aWYgKFdBUk5fT05fT05DRSghYnVmZmVyKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoIWd1
ZF9kcm1fZ2FkZ2V0X2NoZWNrX3JlY3QoYnVmZmVyLCByZWN0KSkgeworCQlwcl9lcnIoIiVzOiBS
ZWN0YW5nbGUgZG9lc24ndCBmaXQ6ICIgRFJNX1JFQ1RfRk1UICJcbiIsCisJCSAgICAgICBfX2Z1
bmNfXywgRFJNX1JFQ1RfQVJHKHJlY3QpKTsKKwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJZmIg
PSBidWZmZXItPmZiOworCisJaWYgKGNvbXByZXNzaW9uICYgR1VEX0RSTV9DT01QUkVTU0lPTl9M
WjQpIHsKKwkJaWYgKGxlbiAhPSBnZGctPnNldF9idWZmZXJfY29tcHJlc3NlZF9sZW5ndGgpIHsK
KwkJCXByX2VycigiJXM6IEJ1ZmZlciBjb21wcmVzc2VkIGxlbiBkaWZmZXJzOiAlenUgIT0gJXp1
XG4iLAorCQkJICAgICAgIF9fZnVuY19fLCBsZW4sIGdkZy0+c2V0X2J1ZmZlcl9jb21wcmVzc2Vk
X2xlbmd0aCk7CisJCQlyZXR1cm4gLUVJTlZBTDsKKwkJfQorCisJCXJldCA9IExaNF9kZWNvbXBy
ZXNzX3NhZmUoYnVmLCBnZGctPndvcmtfYnVmLCBsZW4sIGdkZy0+bWF4X2J1ZmZlcl9zaXplKTsK
KwkJaWYgKHJldCA8IDApIHsKKwkJCXByX2VycigiJXM6IEZhaWxlZCB0byBkZWNvbXByZXNzIGJ1
ZmZlclxuIiwgX19mdW5jX18pOworCQkJcmV0dXJuIC1FSU87CisJCX0KKworCQlidWYgPSBnZGct
PndvcmtfYnVmOworCQlsZW4gPSByZXQ7CisJfQorCisJaWYgKGxlbiAhPSBnZGctPnNldF9idWZm
ZXJfbGVuZ3RoKSB7CisJCXByX2VycigiJXM6IEJ1ZmZlciBsZW4gZGlmZmVyczogJXp1ICE9ICV6
dVxuIiwKKwkJICAgICAgIF9fZnVuY19fLCBsZW4sIGdkZy0+c2V0X2J1ZmZlcl9sZW5ndGgpOwor
CQlyZXR1cm4gLUVJTlZBTDsKKwl9CisKKwlpZiAobGVuID4gKGRybV9yZWN0X3dpZHRoKHJlY3Qp
ICogZHJtX3JlY3RfaGVpZ2h0KHJlY3QpICogZmItPmZvcm1hdC0+Y3BwWzBdKSkgeworCQlwcl9l
cnIoIiVzOiBCdWZmZXIgaXMgdG9vIGJpZyBmb3IgcmVjdGFuZ2xlOiAiIERSTV9SRUNUX0ZNVCAi
IGxlbj0lenVcbiIsCisJCSAgICAgICBfX2Z1bmNfXywgRFJNX1JFQ1RfQVJHKHJlY3QpLCBsZW4p
OworCQlyZXR1cm4gLUVJTlZBTDsKKwl9CisKKwlyZW1haW4gPSBndWRfZHJtX2dhZGdldF93cml0
ZV9idWZmZXJfbWVtY3B5KGJ1ZmZlciwgYnVmLCBsZW4sIHJlY3QpOworCWlmIChyZW1haW4pIHsK
KwkJcHJfZXJyKCIlczogRmFpbGVkIHRvIHdyaXRlIGJ1ZmZlcjogcmVtYWluPSV6dVxuIiwgX19m
dW5jX18sIHJlbWFpbik7CisJCXJldHVybiAtRUlPOworCX0KKworCXJldHVybiBkcm1fY2xpZW50
X2ZyYW1lYnVmZmVyX2ZsdXNoKGJ1ZmZlciwgcmVjdCk7Cit9CitFWFBPUlRfU1lNQk9MKGd1ZF9k
cm1fZ2FkZ2V0X3dyaXRlX2J1ZmZlcik7CisKK2ludCBndWRfZHJtX2dhZGdldF9zZXRfYnVmZmVy
KHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnLCBzdHJ1Y3QgZ3VkX2RybV9yZXFfc2V0X2J1ZmZl
ciAqcmVxKQoreworCXUzMiBjb21wcmVzc2VkX2xlbmd0aCA9IGxlMzJfdG9fY3B1KHJlcS0+Y29t
cHJlc3NlZF9sZW5ndGgpOworCXUzMiBsZW5ndGggPSBsZTMyX3RvX2NwdShyZXEtPmxlbmd0aCk7
CisJc3RydWN0IGRybV9jbGllbnRfYnVmZmVyICpidWZmZXI7CisJc3RydWN0IGRybV9yZWN0IHJl
Y3Q7CisJaW50IHJldCA9IDA7CisKKwlpZiAoIXJlZmNvdW50X2luY19ub3RfemVybygmZ2RnLT51
c2VjbnQpKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCWJ1ZmZlciA9IGdkZy0+YnVmZmVyID8gZ2Rn
LT5idWZmZXIgOiBnZGctPmJ1ZmZlcl9jaGVjazsKKwlpZiAoIWJ1ZmZlcikgeworCQlyZXQgPSAt
RU5PRU5UOworCQlnb3RvIG91dDsKKwl9CisKKwlkcm1fcmVjdF9pbml0KCZyZWN0LCBsZTMyX3Rv
X2NwdShyZXEtPngpLCBsZTMyX3RvX2NwdShyZXEtPnkpLAorCQkgICAgICBsZTMyX3RvX2NwdShy
ZXEtPndpZHRoKSwgbGUzMl90b19jcHUocmVxLT5oZWlnaHQpKTsKKworCXByX2RlYnVnKCIlczog
IiBEUk1fUkVDVF9GTVQgIlxuIiwgX19mdW5jX18sIERSTV9SRUNUX0FSRygmcmVjdCkpOworCisJ
aWYgKCFndWRfZHJtX2dhZGdldF9jaGVja19yZWN0KGJ1ZmZlciwgJnJlY3QpKSB7CisJCXJldCA9
IC1FSU5WQUw7CisJCWdvdG8gb3V0OworCX0KKworCWlmIChyZXEtPmNvbXByZXNzaW9uICYgfkdV
RF9EUk1fQ09NUFJFU1NJT05fTFo0KSB7CisJCXJldCA9IC1FSU5WQUw7CisJCWdvdG8gb3V0Owor
CX0KKworCWdkZy0+c2V0X2J1ZmZlcl9yZWN0ID0gcmVjdDsKKwlnZGctPnNldF9idWZmZXJfbGVu
Z3RoID0gbGVuZ3RoOworCisJaWYgKHJlcS0+Y29tcHJlc3Npb24pIHsKKwkJaWYgKCFjb21wcmVz
c2VkX2xlbmd0aCkgeworCQkJcmV0ID0gLUVJTlZBTDsKKwkJCWdvdG8gb3V0OworCQl9CisJCWdk
Zy0+c2V0X2J1ZmZlcl9jb21wcmVzc2lvbiA9IHJlcS0+Y29tcHJlc3Npb247CisJCWdkZy0+c2V0
X2J1ZmZlcl9jb21wcmVzc2VkX2xlbmd0aCA9IGNvbXByZXNzZWRfbGVuZ3RoOworCQlsZW5ndGgg
PSBjb21wcmVzc2VkX2xlbmd0aDsKKwl9IGVsc2UgeworCQlnZGctPnNldF9idWZmZXJfY29tcHJl
c3Npb24gPSAwOworCQlnZGctPnNldF9idWZmZXJfY29tcHJlc3NlZF9sZW5ndGggPSAwOworCX0K
K291dDoKKwlyZWZjb3VudF9kZWMoJmdkZy0+dXNlY250KTsKKworCXJldHVybiByZXQgPyByZXQg
OiBsZW5ndGg7Cit9CitFWFBPUlRfU1lNQk9MKGd1ZF9kcm1fZ2FkZ2V0X3NldF9idWZmZXIpOwor
CitzdGF0aWMgdm9pZCBndWRfZHJtX2dhZGdldF9kZWxldGVfYnVmZmVycyhzdHJ1Y3QgZ3VkX2Ry
bV9nYWRnZXQgKmdkZykKK3sKKwlkcm1fY2xpZW50X2ZyYW1lYnVmZmVyX2RlbGV0ZShnZGctPmJ1
ZmZlcl9jaGVjayk7CisJZHJtX2NsaWVudF9mcmFtZWJ1ZmZlcl9kZWxldGUoZ2RnLT5idWZmZXIp
OworCWdkZy0+YnVmZmVyX2NoZWNrID0gTlVMTDsKKwlnZGctPmJ1ZmZlciA9IE5VTEw7Cit9CisK
K2ludCBndWRfZHJtX2dhZGdldF9kaXNhYmxlX3BpcGUoc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpn
ZGcpCit7CisJaW50IHJldDsKKworCXJldCA9IGRybV9jbGllbnRfbW9kZXNldF9kaXNhYmxlKCZn
ZGctPmNsaWVudCk7CisJZ3VkX2RybV9nYWRnZXRfZGVsZXRlX2J1ZmZlcnMoZ2RnKTsKKworCXJl
dHVybiByZXQ7Cit9CitFWFBPUlRfU1lNQk9MKGd1ZF9kcm1fZ2FkZ2V0X2Rpc2FibGVfcGlwZSk7
CisKK3N0YXRpYyBpbnQgZ3VkX2RybV9nYWRnZXRfY3RybF9nZXRfZGlzcGxheV9kZXNjcmlwdG9y
KHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnLCB1MTYgdmFsdWUsCisJCQkJCQkgICAgICB2b2lk
ICpkYXRhLCBzaXplX3Qgc2l6ZSkKK3sKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZHJtID0gZ2RnLT5j
bGllbnQuZGV2OworCXN0cnVjdCBndWRfZHJtX2Rpc3BsYXlfZGVzY3JpcHRvciBkZXNjOworCXU4
IHR5cGUgPSB2YWx1ZSA+PiA4OworCXU4IGluZGV4ID0gdmFsdWUgJiAweGZmOworCisJaWYgKHR5
cGUgIT0gR1VEX0RSTV9VU0JfRFRfRElTUExBWSB8fCBpbmRleCkKKwkJcmV0dXJuIC1FSU5WQUw7
CisKKwlkZXNjLmJMZW5ndGggPSBzaXplb2YoZGVzYyk7CisJZGVzYy5iRGVzY3JpcHRvclR5cGUg
PSBHVURfRFJNX1VTQl9EVF9ESVNQTEFZOworCisJZGVzYy5iVmVyc2lvbiA9IDE7CisJZGVzYy5i
TWF4QnVmZmVyU2l6ZU9yZGVyID0gaWxvZzIoZ2RnLT5tYXhfYnVmZmVyX3NpemUpOworCWRlc2Mu
Ym1GbGFncyA9IDA7CisJZGVzYy5iQ29tcHJlc3Npb24gPSBHVURfRFJNX0NPTVBSRVNTSU9OX0xa
NDsKKworCWRlc2MuZHdNaW5XaWR0aCA9IGNwdV90b19sZTMyKGRybS0+bW9kZV9jb25maWcubWlu
X3dpZHRoKTsKKwlkZXNjLmR3TWF4V2lkdGggPSBjcHVfdG9fbGUzMihkcm0tPm1vZGVfY29uZmln
Lm1heF93aWR0aCk7CisJZGVzYy5kd01pbkhlaWdodCA9IGNwdV90b19sZTMyKGRybS0+bW9kZV9j
b25maWcubWluX2hlaWdodCk7CisJZGVzYy5kd01heEhlaWdodCA9IGNwdV90b19sZTMyKGRybS0+
bW9kZV9jb25maWcubWF4X2hlaWdodCk7CisJZGVzYy5iTnVtRm9ybWF0cyA9IGdkZy0+Zm9ybWF0
X2NvdW50OworCWRlc2MuYk51bVByb3BlcnRpZXMgPSBnZGctPm51bV9wcm9wZXJ0aWVzOworCWRl
c2MuYk51bUNvbm5lY3RvcnMgPSBnZGctPmNvbm5lY3Rvcl9jb3VudDsKKworCXNpemUgPSBtaW4o
c2l6ZSwgc2l6ZW9mKGRlc2MpKTsKKwltZW1jcHkoZGF0YSwgJmRlc2MsIHNpemUpOworCisJcmV0
dXJuIHNpemU7Cit9CisKK3N0YXRpYyB2b2lkIGd1ZF9kcm1fZ2FkZ2V0X2N0cmxfZ2V0X2Zvcm1h
dHMoc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcsIF9fbGUzMiAqZm9ybWF0cykKK3sKKwl1bnNp
Z25lZCBpbnQgaTsKKworCWZvciAoaSA9IDA7IGkgPCBnZGctPmZvcm1hdF9jb3VudDsgaSsrKQor
CQlmb3JtYXRzW2ldID0gY3B1X3RvX2xlMzIoZ2RnLT5mb3JtYXRzW2ldKTsKK30KKworc3RhdGlj
IGludCBndWRfZHJtX2dhZGdldF9jdHJsX2dldF9jb25uZWN0b3Ioc3RydWN0IGd1ZF9kcm1fZ2Fk
Z2V0ICpnZGcsIHVuc2lnbmVkIGludCBpbmRleCwKKwkJCQkJICAgICBzdHJ1Y3QgZ3VkX2RybV9y
ZXFfZ2V0X2Nvbm5lY3RvciAqZGVzYykKK3sKKwlzdHJ1Y3QgZ3VkX2RybV9nYWRnZXRfY29ubmVj
dG9yICpnY29ubjsKKworCWlmIChpbmRleCA+PSBnZGctPmNvbm5lY3Rvcl9jb3VudCkKKwkJcmV0
dXJuIC1FSU5WQUw7CisKKwltZW1zZXQoZGVzYywgMCwgc2l6ZW9mKCpkZXNjKSk7CisKKwlnY29u
biA9ICZnZGctPmNvbm5lY3RvcnNbaW5kZXhdOworCisJZGVzYy0+Y29ubmVjdG9yX3R5cGUgPSBn
Y29ubi0+Y29ubmVjdG9yLT5jb25uZWN0b3JfdHlwZTsKKwlkZXNjLT5mbGFncyA9IGNwdV90b19s
ZTMyKEdVRF9EUk1fQ09OTkVDVE9SX0ZMQUdTX1BPTEwpOworCWRlc2MtPm51bV9wcm9wZXJ0aWVz
ID0gZ2Nvbm4tPm51bV9wcm9wZXJ0aWVzOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBzdHJ1
Y3QgZ3VkX2RybV9nYWRnZXRfY29ubmVjdG9yICoKK2d1ZF9kcm1fZ2FkZ2V0X2dldF9nY29ubihz
dHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywgdW5zaWduZWQgaW50IGluZGV4KQoreworCWlmIChp
bmRleCA+PSBnZGctPmNvbm5lY3Rvcl9jb3VudCkKKwkJcmV0dXJuIE5VTEw7CisKKwlyZXR1cm4g
JmdkZy0+Y29ubmVjdG9yc1tpbmRleF07Cit9CisKK3N0YXRpYyBpbnQgZ3VkX2RybV9nYWRnZXRf
Y3RybF9nZXRfY29ubmVjdG9yX3N0YXR1cyhzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywgdW5z
aWduZWQgaW50IGluZGV4LAorCQkJCQkJICAgIHN0cnVjdCBndWRfZHJtX3JlcV9nZXRfY29ubmVj
dG9yX3N0YXR1cyAqc3RhdHVzKQoreworCXN0cnVjdCBndWRfZHJtX2dhZGdldF9jb25uZWN0b3Ig
Kmdjb25uOworCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisKKwlnY29ubiA9IGd1ZF9kcm1fZ2FkZ2V0
X2dldF9nY29ubihnZGcsIGluZGV4KTsKKwlpZiAoIWdjb25uKQorCQlyZXR1cm4gLUVOT0VOVDsK
KworCW1lbXNldChzdGF0dXMsIDAsIHNpemVvZigqc3RhdHVzKSk7CisKKwlzcGluX2xvY2tfaXJx
c2F2ZSgmZ2Nvbm4tPmxvY2ssIGZsYWdzKTsKKwlzdGF0dXMtPnN0YXR1cyA9IGdjb25uLT5zdGF0
dXM7CisJaWYgKGdjb25uLT5jaGFuZ2VkKSB7CisJCXN0YXR1cy0+c3RhdHVzIHw9IEdVRF9EUk1f
Q09OTkVDVE9SX1NUQVRVU19DSEFOR0VEOworCQlnY29ubi0+Y2hhbmdlZCA9IGZhbHNlOworCX0K
KwlpZiAoZ2Nvbm4tPm51bV9tb2RlcykKKwkJc3RhdHVzLT5udW1fbW9kZXMgPSBjcHVfdG9fbGUx
NihnY29ubi0+bnVtX21vZGVzKTsKKwlpZiAoZ2Nvbm4tPmVkaWRfbGVuKQorCQlzdGF0dXMtPmVk
aWRfbGVuID0gY3B1X3RvX2xlMTYoZ2Nvbm4tPmVkaWRfbGVuKTsKKwlzcGluX3VubG9ja19pcnFy
ZXN0b3JlKCZnY29ubi0+bG9jaywgZmxhZ3MpOworCisJcmV0dXJuIDA7Cit9CisKKy8qIFRoaXMg
cnVucyBpbiBpbnRlcnJ1cHQgY29udGV4dCAqLworaW50IGd1ZF9kcm1fZ2FkZ2V0X2N0cmxfZ2V0
KHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnLCB1OCByZXF1ZXN0LAorCQkJICAgIHUxNiBpbmRl
eCwgdm9pZCAqZGF0YSwgc2l6ZV90IHNpemUpCit7CisJc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0X2Nv
bm5lY3RvciAqZ2Nvbm47CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKwlpbnQgcmV0ID0gLUVJTlZB
TDsKKworCXByX2RlYnVnKCIlczogcmVxdWVzdD0weCV4IGluZGV4PSV1IHNpemU9JXp1XG4iLCBf
X2Z1bmNfXywgcmVxdWVzdCwgaW5kZXgsIHNpemUpOworCisJaWYgKCFyZWZjb3VudF9pbmNfbm90
X3plcm8oJmdkZy0+dXNlY250KSkKKwkJcmV0dXJuIC1FTk9ERVY7CisKKwlpZiAoIXNpemUpCisJ
CWdvdG8gb3V0OworCisJc3dpdGNoIChyZXF1ZXN0KSB7CisJY2FzZSBVU0JfUkVRX0dFVF9ERVND
UklQVE9SOgorCQlyZXQgPSBndWRfZHJtX2dhZGdldF9jdHJsX2dldF9kaXNwbGF5X2Rlc2NyaXB0
b3IoZ2RnLCBpbmRleCwgZGF0YSwgc2l6ZSk7CisJCWJyZWFrOworCWNhc2UgR1VEX0RSTV9VU0Jf
UkVRX0dFVF9GT1JNQVRTOgorCQlpZiAoIWluZGV4ICYmIHNpemUgPT0gZ2RnLT5mb3JtYXRfY291
bnQgKiBzaXplb2YodTMyKSkgeworCQkJZ3VkX2RybV9nYWRnZXRfY3RybF9nZXRfZm9ybWF0cyhn
ZGcsIGRhdGEpOworCQkJcmV0ID0gMDsKKwkJfQorCQlicmVhazsKKwljYXNlIEdVRF9EUk1fVVNC
X1JFUV9HRVRfUFJPUEVSVElFUzoKKwkJaWYgKCFpbmRleCAmJiBzaXplID09IGdkZy0+bnVtX3By
b3BlcnRpZXMgKiBzaXplb2YoKmdkZy0+cHJvcGVydGllcykpIHsKKwkJCW1lbWNweShkYXRhLCBn
ZGctPnByb3BlcnRpZXMsIHNpemUpOworCQkJcmV0ID0gMDsKKwkJfQorCQlicmVhazsKKwljYXNl
IEdVRF9EUk1fVVNCX1JFUV9HRVRfQ09OTkVDVE9SOgorCQlpZiAoc2l6ZSA9PSBzaXplb2Yoc3Ry
dWN0IGd1ZF9kcm1fcmVxX2dldF9jb25uZWN0b3IpKQorCQkJcmV0ID0gZ3VkX2RybV9nYWRnZXRf
Y3RybF9nZXRfY29ubmVjdG9yKGdkZywgaW5kZXgsIGRhdGEpOworCQlicmVhazsKKwljYXNlIEdV
RF9EUk1fVVNCX1JFUV9HRVRfQ09OTkVDVE9SX1BST1BFUlRJRVM6CisJCWdjb25uID0gZ3VkX2Ry
bV9nYWRnZXRfZ2V0X2djb25uKGdkZywgaW5kZXgpOworCQlpZiAoZ2Nvbm4gJiYgc2l6ZSA9PSBn
Y29ubi0+bnVtX3Byb3BlcnRpZXMgKiBzaXplb2YoKmdjb25uLT5wcm9wZXJ0aWVzKSkgeworCQkJ
bWVtY3B5KGRhdGEsIGdjb25uLT5wcm9wZXJ0aWVzLCBzaXplKTsKKwkJCXJldCA9IDA7CisJCX0K
KwkJYnJlYWs7CisJY2FzZSBHVURfRFJNX1VTQl9SRVFfR0VUX0NPTk5FQ1RPUl9UVl9NT0RFX1ZB
TFVFUzoKKwkJZ2Nvbm4gPSBndWRfZHJtX2dhZGdldF9nZXRfZ2Nvbm4oZ2RnLCBpbmRleCk7CisJ
CWlmIChnY29ubiAmJiBzaXplID09IGdjb25uLT5udW1fdHZfbW9kZV9lbnVtX25hbWVzICogRFJN
X1BST1BfTkFNRV9MRU4pIHsKKwkJCW1lbWNweShkYXRhLCBnY29ubi0+dHZfbW9kZV9lbnVtX25h
bWVzLCBzaXplKTsKKwkJCXJldCA9IDA7CisJCX0KKwkJYnJlYWs7CisJY2FzZSBHVURfRFJNX1VT
Ql9SRVFfR0VUX0NPTk5FQ1RPUl9TVEFUVVM6CisJCWlmIChzaXplID09IHNpemVvZihzdHJ1Y3Qg
Z3VkX2RybV9yZXFfZ2V0X2Nvbm5lY3Rvcl9zdGF0dXMpKQorCQkJcmV0ID0gZ3VkX2RybV9nYWRn
ZXRfY3RybF9nZXRfY29ubmVjdG9yX3N0YXR1cyhnZGcsIGluZGV4LCBkYXRhKTsKKwkJYnJlYWs7
CisJY2FzZSBHVURfRFJNX1VTQl9SRVFfR0VUX0NPTk5FQ1RPUl9NT0RFUzoKKwkJZ2Nvbm4gPSBn
dWRfZHJtX2dhZGdldF9nZXRfZ2Nvbm4oZ2RnLCBpbmRleCk7CisJCXNwaW5fbG9ja19pcnFzYXZl
KCZnY29ubi0+bG9jaywgZmxhZ3MpOworCQlpZiAoZ2Nvbm4gJiYgc2l6ZSA9PSBnY29ubi0+bnVt
X21vZGVzICogc2l6ZW9mKCpnY29ubi0+bW9kZXMpKSB7CisJCQltZW1jcHkoZGF0YSwgZ2Nvbm4t
Pm1vZGVzLCBzaXplKTsKKwkJCXJldCA9IDA7CisJCX0KKwkJc3Bpbl91bmxvY2tfaXJxcmVzdG9y
ZSgmZ2Nvbm4tPmxvY2ssIGZsYWdzKTsKKwkJYnJlYWs7CisJY2FzZSBHVURfRFJNX1VTQl9SRVFf
R0VUX0NPTk5FQ1RPUl9FRElEOgorCQlnY29ubiA9IGd1ZF9kcm1fZ2FkZ2V0X2dldF9nY29ubihn
ZGcsIGluZGV4KTsKKwkJc3Bpbl9sb2NrX2lycXNhdmUoJmdjb25uLT5sb2NrLCBmbGFncyk7CisJ
CWlmIChnY29ubiAmJiBzaXplID09IGdjb25uLT5lZGlkX2xlbikgeworCQkJbWVtY3B5KGRhdGEs
IGdjb25uLT5lZGlkLCBzaXplKTsKKwkJCXJldCA9IDA7CisJCX0KKwkJc3Bpbl91bmxvY2tfaXJx
cmVzdG9yZSgmZ2Nvbm4tPmxvY2ssIGZsYWdzKTsKKwkJYnJlYWs7CisJfQorb3V0OgorCXJlZmNv
dW50X2RlYygmZ2RnLT51c2VjbnQpOworCisJcmV0dXJuICFyZXQgPyBzaXplIDogcmV0OworfQor
RVhQT1JUX1NZTUJPTChndWRfZHJtX2dhZGdldF9jdHJsX2dldCk7CisKK2ludCBndWRfZHJtX2dh
ZGdldF9jdHJsX3NldChzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywgdTggcmVxdWVzdCwKKwkJ
CSAgICB1MTYgaW5kZXgsIHZvaWQgKmRhdGEsIHNpemVfdCBzaXplKQoreworCXN0cnVjdCBndWRf
ZHJtX2dhZGdldF9jb25uZWN0b3IgKmdjb25uOworCWludCBkcG1zLCByZXQgPSAtRUlOVkFMOwor
CisJcHJfZGVidWcoIiVzOiByZXF1ZXN0PTB4JXggaW5kZXg9JXUgc2l6ZT0lenVcbiIsIF9fZnVu
Y19fLCByZXF1ZXN0LCBpbmRleCwgc2l6ZSk7CisKKwlpZiAoIXJlZmNvdW50X2luY19ub3RfemVy
bygmZ2RnLT51c2VjbnQpKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCXN3aXRjaCAocmVxdWVzdCkg
eworCWNhc2UgR1VEX0RSTV9VU0JfUkVRX1NFVF9DT05ORUNUT1JfRk9SQ0VfREVURUNUOgorCQln
Y29ubiA9IGd1ZF9kcm1fZ2FkZ2V0X2dldF9nY29ubihnZGcsIGluZGV4KTsKKwkJaWYgKGdjb25u
KQorCQkJcmV0ID0gZ3VkX2RybV9nYWRnZXRfcHJvYmVfY29ubmVjdG9yKGdjb25uKTsKKwkJYnJl
YWs7CisJY2FzZSBHVURfRFJNX1VTQl9SRVFfU0VUX1NUQVRFX0NIRUNLOgorCQlyZXQgPSBndWRf
ZHJtX2dhZGdldF9jaGVjayhnZGcsIGRhdGEsIHNpemUpOworCQlicmVhazsKKwljYXNlIEdVRF9E
Uk1fVVNCX1JFUV9TRVRfU1RBVEVfQ09NTUlUOgorCQlpZiAoIXNpemUpCisJCQlyZXQgPSBndWRf
ZHJtX2dhZGdldF9jb21taXQoZ2RnKTsKKwkJYnJlYWs7CisJY2FzZSBHVURfRFJNX1VTQl9SRVFf
U0VUX0NPTlRST0xMRVJfRU5BQkxFOgorCQlpZiAoc2l6ZSA9PSBzaXplb2YodTgpKSB7CisJCQlp
ZiAoKih1OCAqKWRhdGEgPT0gMCkKKwkJCQlyZXQgPSBndWRfZHJtX2dhZGdldF9kaXNhYmxlX3Bp
cGUoZ2RnKTsKKwkJCWVsc2UKKwkJCQlyZXQgPSAwOworCQl9CisJCWJyZWFrOworCWNhc2UgR1VE
X0RSTV9VU0JfUkVRX1NFVF9ESVNQTEFZX0VOQUJMRToKKwkJaWYgKHNpemUgPT0gc2l6ZW9mKHU4
KSkgeworCQkJZHBtcyA9ICoodTggKilkYXRhID8gRFJNX01PREVfRFBNU19PTiA6IERSTV9NT0RF
X0RQTVNfT0ZGOworCQkJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2RwbXMoJmdkZy0+Y2xpZW50
LCBkcG1zKTsKKwkJfQorCQlicmVhazsKKwl9CisKKwlyZWZjb3VudF9kZWMoJmdkZy0+dXNlY250
KTsKKworCXJldHVybiByZXQ7Cit9CitFWFBPUlRfU1lNQk9MKGd1ZF9kcm1fZ2FkZ2V0X2N0cmxf
c2V0KTsKKworc3RhdGljIGludCBndWRfZHJtX2dhZGdldF9nZXRfZm9ybWF0cyhzdHJ1Y3QgZ3Vk
X2RybV9nYWRnZXQgKmdkZywgdTggKm1heF9jcHApCit7CisJc3RydWN0IGRybV9kZXZpY2UgKmRy
bSA9IGdkZy0+Y2xpZW50LmRldjsKKwlzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZTsKKwl1bnNpZ25l
ZCBpbnQgaTsKKwl1MzIgKmZvcm1hdHM7CisJaW50IHJldDsKKworCSptYXhfY3BwID0gMDsKKwor
CWRybV9mb3JfZWFjaF9wbGFuZShwbGFuZSwgZHJtKSB7CisJCWlmIChwbGFuZS0+dHlwZSA9PSBE
Uk1fUExBTkVfVFlQRV9QUklNQVJZKQorCQkJYnJlYWs7CisJfQorCisJZm9ybWF0cyA9IGtjYWxs
b2MocGxhbmUtPmZvcm1hdF9jb3VudCwgc2l6ZW9mKHUzMiksIEdGUF9LRVJORUwpOworCWlmICgh
Zm9ybWF0cykKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlmb3IgKGkgPSAwOyBpIDwgcGxhbmUtPmZv
cm1hdF9jb3VudDsgaSsrKSB7CisJCWNvbnN0IHN0cnVjdCBkcm1fZm9ybWF0X2luZm8gKmZtdDsK
KworCQlmbXQgPSBkcm1fZm9ybWF0X2luZm8ocGxhbmUtPmZvcm1hdF90eXBlc1tpXSk7CisJCWlm
IChmbXQtPm51bV9wbGFuZXMgIT0gMSkKKwkJCWNvbnRpbnVlOworCisJCS8qCisJCSAqIFN1cHBv
cnRpbmcgMjQtYml0IGJwcCB3b3VsZCBhZGQgY29tcGxleGl0eSBzbyBkb24ndCBib3RoZXIuCisJ
CSAqIEl0J3MgaGFyZGx5IHVzZWQgYW5kIGNvbXByZXNzaW9uIHJlbW92ZXMgbXVjaCBvZiB0aGUg
Z2Fpbi4KKwkJICovCisJCWlmIChmbXQtPmNwcFswXSA9PSAzKQorCQkJY29udGludWU7CisKKwkJ
aWYgKCptYXhfY3BwIDwgZm10LT5jcHBbMF0pCisJCQkqbWF4X2NwcCA9IGZtdC0+Y3BwWzBdOwor
CisJCWZvcm1hdHNbZ2RnLT5mb3JtYXRfY291bnQrK10gPSBwbGFuZS0+Zm9ybWF0X3R5cGVzW2ld
OworCX0KKworCWlmICghZ2RnLT5mb3JtYXRfY291bnQpIHsKKwkJcmV0ID0gLUVOT0VOVDsKKwkJ
Z290byBlcnJfZnJlZTsKKwl9CisKKwlnZGctPmZvcm1hdHMgPSBmb3JtYXRzOworCisJcmV0dXJu
IDA7CisKK2Vycl9mcmVlOgorCWtmcmVlKGZvcm1hdHMpOworCisJcmV0dXJuIHJldDsKK30KKwor
c3RhdGljIGludCBndWRfZHJtX2dhZGdldF9nZXRfcm90YXRpb25fcHJvcGVydHkoc3RydWN0IGRy
bV9kZXZpY2UgKmRybSwgdTE2ICpwcm9wLCB1NjQgKnZhbCkKK3sKKwlzdHJ1Y3QgZHJtX3Byb3Bl
cnR5X2VudW0gKnByb3BfZW51bTsKKwlzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZTsKKwl1bnNpZ25l
ZCBpbnQgbnVtX3Byb3BzID0gMDsKKwl1MTYgYml0bWFzayA9IDA7CisKKwlkcm1fZm9yX2VhY2hf
cGxhbmUocGxhbmUsIGRybSkgeworCQlpZiAocGxhbmUtPnR5cGUgPT0gRFJNX1BMQU5FX1RZUEVf
UFJJTUFSWSkKKwkJCWJyZWFrOworCX0KKworCWlmICghcGxhbmUtPnJvdGF0aW9uX3Byb3BlcnR5
KQorCQlyZXR1cm4gMDsKKworCWxpc3RfZm9yX2VhY2hfZW50cnkocHJvcF9lbnVtLCAmcGxhbmUt
PnJvdGF0aW9uX3Byb3BlcnR5LT5lbnVtX2xpc3QsIGhlYWQpIHsKKwkJbnVtX3Byb3BzKys7CisJ
CWJpdG1hc2sgfD0gQklUKHByb3BfZW51bS0+dmFsdWUpOworCX0KKworCSpwcm9wID0gR1VEX0RS
TV9QUk9QRVJUWV9ST1RBVElPTjsKKwkqdmFsID0gYml0bWFzazsKKworCXJldHVybiAxOworfQor
CitzdGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2dldF9wcm9wZXJ0aWVzKHN0cnVjdCBndWRfZHJt
X2dhZGdldCAqZ2RnKQoreworCXN0cnVjdCBndWRfZHJtX3Byb3BlcnR5ICpwcm9wZXJ0aWVzOwor
CXUxNiBwcm9wOworCXU2NCB2YWw7CisJaW50IHJldDsKKworCXJldCA9IGd1ZF9kcm1fZ2FkZ2V0
X2dldF9yb3RhdGlvbl9wcm9wZXJ0eShnZGctPmNsaWVudC5kZXYsICZwcm9wLCAmdmFsKTsKKwlp
ZiAocmV0IDw9IDApCisJCXJldHVybiByZXQ7CisKKwlwcm9wZXJ0aWVzID0ga2NhbGxvYygxLCBz
aXplb2YoKnByb3BlcnRpZXMpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIXByb3BlcnRpZXMpCisJCXJl
dHVybiAtRU5PTUVNOworCisJZ2RnLT5wcm9wZXJ0aWVzID0gcHJvcGVydGllczsKKwlnZGctPm51
bV9wcm9wZXJ0aWVzKys7CisKKwlwcm9wZXJ0aWVzWzBdLnByb3AgPSBjcHVfdG9fbGUxNihwcm9w
KTsKKwlwcm9wZXJ0aWVzWzBdLnZhbCA9IGNwdV90b19sZTY0KHZhbCk7CisKKwlyZXR1cm4gMDsK
K30KKworc3RhdGljIGludCBndWRfZHJtX2dhZGdldF9nZXRfY29ubmVjdG9yX3Byb3BlcnRpZXMo
c3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcsCisJCQkJCQkgICBzdHJ1Y3QgZ3VkX2RybV9nYWRn
ZXRfY29ubmVjdG9yICpnY29ubikKK3sKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZHJtID0gZ2RnLT5j
bGllbnQuZGV2OworCXN0cnVjdCBkcm1fbW9kZV9jb25maWcgKmNvbmZpZyA9ICZkcm0tPm1vZGVf
Y29uZmlnOworCXN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IgPSBnY29ubi0+Y29ubmVj
dG9yOworCXN0cnVjdCBkcm1fb2JqZWN0X3Byb3BlcnRpZXMgKmNvbm5fcHJvcHMgPSBjb25uZWN0
b3ItPmJhc2UucHJvcGVydGllczsKKwlzdHJ1Y3QgZ3VkX2RybV9wcm9wZXJ0eSAqcHJvcGVydGll
czsKKwl1bnNpZ25lZCBpbnQgaSwgcmV0ID0gMDsKKwl1MTYgcHJvcDsKKwl1NjQgdmFsOworCisJ
bXV0ZXhfbG9jaygmZHJtLT5tb2RlX2NvbmZpZy5tdXRleCk7CisKKwlpZiAoIWNvbm5fcHJvcHMt
PmNvdW50KQorCQlnb3RvIHVubG9jazsKKworCS8qIEFkZCByb29tIGZvciBwb3NzaWJsZSBiYWNr
bGlnaHQgKi8KKwlwcm9wZXJ0aWVzID0ga2NhbGxvYyhjb25uX3Byb3BzLT5jb3VudCArIDEsIHNp
emVvZigqcHJvcGVydGllcyksIEdGUF9LRVJORUwpOworCWlmICghcHJvcGVydGllcykgeworCQly
ZXQgPSAtRU5PTUVNOworCQlnb3RvIHVubG9jazsKKwl9CisKKwlnY29ubi0+cHJvcGVydGllcyA9
IHByb3BlcnRpZXM7CisKKwlmb3IgKGkgPSAwOyBpIDwgY29ubl9wcm9wcy0+Y291bnQ7IGkrKykg
eworCQlzdHJ1Y3QgZHJtX3Byb3BlcnR5ICpwcm9wZXJ0eSA9IGNvbm5fcHJvcHMtPnByb3BlcnRp
ZXNbaV07CisKKwkJaWYgKHByb3BlcnR5ID09IGNvbmZpZy0+dHZfc2VsZWN0X3N1YmNvbm5lY3Rv
cl9wcm9wZXJ0eSkgeworCQkJcHJvcCA9IEdVRF9EUk1fUFJPUEVSVFlfVFZfU0VMRUNUX1NVQkNP
Tk5FQ1RPUjsKKwkJCXZhbCA9IGNvbm5lY3Rvci0+c3RhdGUtPnR2LnN1YmNvbm5lY3RvcjsKKwkJ
fSBlbHNlIGlmIChwcm9wZXJ0eSA9PSBjb25maWctPnR2X2xlZnRfbWFyZ2luX3Byb3BlcnR5KSB7
CisJCQlwcm9wID0gR1VEX0RSTV9QUk9QRVJUWV9UVl9MRUZUX01BUkdJTjsKKwkJCXZhbCA9IGNv
bm5lY3Rvci0+c3RhdGUtPnR2Lm1hcmdpbnMubGVmdDsKKwkJfSBlbHNlIGlmIChwcm9wZXJ0eSA9
PSBjb25maWctPnR2X3JpZ2h0X21hcmdpbl9wcm9wZXJ0eSkgeworCQkJcHJvcCA9IEdVRF9EUk1f
UFJPUEVSVFlfVFZfUklHSFRfTUFSR0lOOworCQkJdmFsID0gY29ubmVjdG9yLT5zdGF0ZS0+dHYu
bWFyZ2lucy5yaWdodDsKKwkJfSBlbHNlIGlmIChwcm9wZXJ0eSA9PSBjb25maWctPnR2X3RvcF9t
YXJnaW5fcHJvcGVydHkpIHsKKwkJCXByb3AgPSBHVURfRFJNX1BST1BFUlRZX1RWX1RPUF9NQVJH
SU47CisJCQl2YWwgPSBjb25uZWN0b3ItPnN0YXRlLT50di5tYXJnaW5zLnRvcDsKKwkJfSBlbHNl
IGlmIChwcm9wZXJ0eSA9PSBjb25maWctPnR2X2JvdHRvbV9tYXJnaW5fcHJvcGVydHkpIHsKKwkJ
CXByb3AgPSBHVURfRFJNX1BST1BFUlRZX1RWX0JPVFRPTV9NQVJHSU47CisJCQl2YWwgPSBjb25u
ZWN0b3ItPnN0YXRlLT50di5tYXJnaW5zLmJvdHRvbTsKKwkJfSBlbHNlIGlmIChwcm9wZXJ0eSA9
PSBjb25maWctPnR2X21vZGVfcHJvcGVydHkpIHsKKwkJCXN0cnVjdCBkcm1fcHJvcGVydHlfZW51
bSAqcHJvcF9lbnVtOworCQkJY2hhciAqYnVmOworCisJCQlsaXN0X2Zvcl9lYWNoX2VudHJ5KHBy
b3BfZW51bSwgJnByb3BlcnR5LT5lbnVtX2xpc3QsIGhlYWQpCisJCQkJZ2Nvbm4tPm51bV90dl9t
b2RlX2VudW1fbmFtZXMrKzsKKworCQkJaWYgKFdBUk5fT04oIWdjb25uLT5udW1fdHZfbW9kZV9l
bnVtX25hbWVzKSkgeworCQkJCXJldCA9IC1FSU5WQUw7CisJCQkJZ290byB1bmxvY2s7CisJCQl9
CisKKwkJCWJ1ZiA9IGtjYWxsb2MoZ2Nvbm4tPm51bV90dl9tb2RlX2VudW1fbmFtZXMsIERSTV9Q
Uk9QX05BTUVfTEVOLCBHRlBfS0VSTkVMKTsKKwkJCWlmICghYnVmKSB7CisJCQkJcmV0ID0gLUVO
T01FTTsKKwkJCQlnb3RvIHVubG9jazsKKwkJCX0KKworCQkJZ2Nvbm4tPnR2X21vZGVfZW51bV9u
YW1lcyA9IGJ1ZjsKKworCQkJbGlzdF9mb3JfZWFjaF9lbnRyeShwcm9wX2VudW0sICZwcm9wZXJ0
eS0+ZW51bV9saXN0LCBoZWFkKSB7CisJCQkJc3RybmNweShidWYsIHByb3BfZW51bS0+bmFtZSwg
RFJNX1BST1BfTkFNRV9MRU4pOworCQkJCWJ1ZiArPSBEUk1fUFJPUF9OQU1FX0xFTjsKKwkJCX0K
KworCQkJcHJvcCA9IEdVRF9EUk1fUFJPUEVSVFlfVFZfTU9ERTsKKwkJCXZhbCA9IGNvbm5lY3Rv
ci0+c3RhdGUtPnR2Lm1vZGU7CisJCQl2YWwgfD0gZ2Nvbm4tPm51bV90dl9tb2RlX2VudW1fbmFt
ZXMgPDwgR1VEX0RSTV9VU0JfQ09OTkVDVE9SX1RWX01PREVfTlVNX1NISUZUOworCQl9IGVsc2Ug
aWYgKHByb3BlcnR5ID09IGNvbmZpZy0+dHZfYnJpZ2h0bmVzc19wcm9wZXJ0eSkgeworCQkJcHJv
cCA9IEdVRF9EUk1fUFJPUEVSVFlfVFZfQlJJR0hUTkVTUzsKKwkJCXZhbCA9IGNvbm5lY3Rvci0+
c3RhdGUtPnR2LmJyaWdodG5lc3M7CisJCX0gZWxzZSBpZiAocHJvcGVydHkgPT0gY29uZmlnLT50
dl9jb250cmFzdF9wcm9wZXJ0eSkgeworCQkJcHJvcCA9IEdVRF9EUk1fUFJPUEVSVFlfVFZfQ09O
VFJBU1Q7CisJCQl2YWwgPSBjb25uZWN0b3ItPnN0YXRlLT50di5jb250cmFzdDsKKwkJfSBlbHNl
IGlmIChwcm9wZXJ0eSA9PSBjb25maWctPnR2X2ZsaWNrZXJfcmVkdWN0aW9uX3Byb3BlcnR5KSB7
CisJCQlwcm9wID0gR1VEX0RSTV9QUk9QRVJUWV9UVl9GTElDS0VSX1JFRFVDVElPTjsKKwkJCXZh
bCA9IGNvbm5lY3Rvci0+c3RhdGUtPnR2LmZsaWNrZXJfcmVkdWN0aW9uOworCQl9IGVsc2UgaWYg
KHByb3BlcnR5ID09IGNvbmZpZy0+dHZfb3ZlcnNjYW5fcHJvcGVydHkpIHsKKwkJCXByb3AgPSBH
VURfRFJNX1BST1BFUlRZX1RWX09WRVJTQ0FOOworCQkJdmFsID0gY29ubmVjdG9yLT5zdGF0ZS0+
dHYub3ZlcnNjYW47CisJCX0gZWxzZSBpZiAocHJvcGVydHkgPT0gY29uZmlnLT50dl9zYXR1cmF0
aW9uX3Byb3BlcnR5KSB7CisJCQlwcm9wID0gR1VEX0RSTV9QUk9QRVJUWV9UVl9TQVRVUkFUSU9O
OworCQkJdmFsID0gY29ubmVjdG9yLT5zdGF0ZS0+dHYuc2F0dXJhdGlvbjsKKwkJfSBlbHNlIGlm
IChwcm9wZXJ0eSA9PSBjb25maWctPnR2X2h1ZV9wcm9wZXJ0eSkgeworCQkJcHJvcCA9IEdVRF9E
Uk1fUFJPUEVSVFlfVFZfSFVFOworCQkJdmFsID0gY29ubmVjdG9yLT5zdGF0ZS0+dHYuaHVlOwor
CQl9IGVsc2UgeworCQkJY29udGludWU7CisJCX0KKworCQlwcm9wZXJ0aWVzW2djb25uLT5udW1f
cHJvcGVydGllc10ucHJvcCA9IGNwdV90b19sZTE2KHByb3ApOworCQlwcm9wZXJ0aWVzW2djb25u
LT5udW1fcHJvcGVydGllcysrXS52YWwgPSBjcHVfdG9fbGU2NCh2YWwpOworCX0KKworCWlmICgh
Y29ubmVjdG9yLT5pbmRleCAmJiBnZGctPmJhY2tsaWdodCkgeworCQlzdHJ1Y3QgYmFja2xpZ2h0
X3Byb3BlcnRpZXMgKnByb3BzID0gJmdkZy0+YmFja2xpZ2h0LT5wcm9wczsKKworCQlwcm9wID0g
R1VEX0RSTV9QUk9QRVJUWV9CQUNLTElHSFRfQlJJR0hUTkVTUzsKKwkJdmFsID0gRElWNjRfVTY0
X1JPVU5EX1VQKHByb3BzLT5icmlnaHRuZXNzICogMTAwLCBwcm9wcy0+bWF4X2JyaWdodG5lc3Mp
OworCQlwcm9wZXJ0aWVzW2djb25uLT5udW1fcHJvcGVydGllc10ucHJvcCA9IGNwdV90b19sZTE2
KHByb3ApOworCQlwcm9wZXJ0aWVzW2djb25uLT5udW1fcHJvcGVydGllcysrXS52YWwgPSBjcHVf
dG9fbGU2NCh2YWwpOworCQlnY29ubi0+YmFja2xpZ2h0ID0gZ2RnLT5iYWNrbGlnaHQ7CisJfQor
dW5sb2NrOgorCW11dGV4X3VubG9jaygmZHJtLT5tb2RlX2NvbmZpZy5tdXRleCk7CisKKwlyZXR1
cm4gcmV0OworfQorCitzdGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2dldF9jb25uZWN0b3JzKHN0
cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnKQoreworCXN0cnVjdCBndWRfZHJtX2dhZGdldF9jb25u
ZWN0b3IgKmNvbm5lY3RvcnMgPSBOVUxMOworCXN0cnVjdCBkcm1fY29ubmVjdG9yX2xpc3RfaXRl
ciBjb25uX2l0ZXI7CisJc3RydWN0IGRybV9kZXZpY2UgKmRybSA9IGdkZy0+Y2xpZW50LmRldjsK
Kwl1bnNpZ25lZCBpbnQgY29ubmVjdG9yX2NvdW50ID0gMDsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3Rv
ciAqY29ubmVjdG9yOworCWludCByZXQgPSAwOworCisJZHJtX2Nvbm5lY3Rvcl9saXN0X2l0ZXJf
YmVnaW4oZHJtLCAmY29ubl9pdGVyKTsKKwlkcm1fY2xpZW50X2Zvcl9lYWNoX2Nvbm5lY3Rvcl9p
dGVyKGNvbm5lY3RvciwgJmNvbm5faXRlcikgeworCQlzdHJ1Y3QgZ3VkX2RybV9nYWRnZXRfY29u
bmVjdG9yICp0bXAsICpnY29ubjsKKworCQl0bXAgPSBrcmVhbGxvYyhjb25uZWN0b3JzLCAoY29u
bmVjdG9yX2NvdW50ICsgMSkgKiBzaXplb2YoKmNvbm5lY3RvcnMpLAorCQkJICAgICAgIEdGUF9L
RVJORUwgfCBfX0dGUF9aRVJPKTsKKwkJaWYgKCF0bXApIHsKKwkJCXJldCA9IC1FTk9NRU07CisJ
CQlicmVhazsKKwkJfQorCisJCWNvbm5lY3RvcnMgPSB0bXA7CisJCWRybV9jb25uZWN0b3JfZ2V0
KGNvbm5lY3Rvcik7CisJCWdjb25uID0gJmNvbm5lY3RvcnNbY29ubmVjdG9yX2NvdW50KytdOwor
CQlnY29ubi0+Y29ubmVjdG9yID0gY29ubmVjdG9yOworCQlzcGluX2xvY2tfaW5pdCgmZ2Nvbm4t
PmxvY2spOworCisJCXJldCA9IGd1ZF9kcm1fZ2FkZ2V0X2dldF9jb25uZWN0b3JfcHJvcGVydGll
cyhnZGcsIGdjb25uKTsKKwkJaWYgKHJldCkKKwkJCWJyZWFrOworCX0KKwlkcm1fY29ubmVjdG9y
X2xpc3RfaXRlcl9lbmQoJmNvbm5faXRlcik7CisKKwlnZGctPmNvbm5lY3RvcnMgPSBjb25uZWN0
b3JzOworCWdkZy0+Y29ubmVjdG9yX2NvdW50ID0gY29ubmVjdG9yX2NvdW50OworCisJcmV0dXJu
IHJldDsKK30KKworc3RhdGljIHZvaWQgZ3VkX2RybV9nYWRnZXRfcmVsZWFzZShzdHJ1Y3Qga3Jl
ZiAqa3JlZikKK3sKKwlzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZyA9IGNvbnRhaW5lcl9vZihr
cmVmLCBzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQsIHJlZmNvdW50KTsKKworCWtmcmVlKGdkZyk7Cit9
CisKK3N0YXRpYyB2b2lkIGd1ZF9kcm1fZ2FkZ2V0X3B1dChzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQg
KmdkZykKK3sKKwlrcmVmX3B1dCgmZ2RnLT5yZWZjb3VudCwgZ3VkX2RybV9nYWRnZXRfcmVsZWFz
ZSk7Cit9CisKK3N0YXRpYyB2b2lkIGd1ZF9kcm1fZ2FkZ2V0X2NsaWVudF91bnJlZ2lzdGVyKHN0
cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50KQoreworCXN0cnVjdCBndWRfZHJtX2dhZGdldCAq
Z2RnID0gY29udGFpbmVyX29mKGNsaWVudCwgc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0LCBjbGllbnQp
OworCWludCB0aW1lb3V0ID0gMTAwMDAgLyA1MDsKKwl1bnNpZ25lZCBpbnQgaTsKKworCS8qCisJ
ICogSWYgdXNlY250IGRvZXNuJ3QgZHJvcCB0byB6ZXJvLCB0cnkgd2FpdGluZyBmb3IgdGhlIGdh
ZGdldCwgYnV0IHdlCisJICogY2FuJ3QgYmxvY2sgdGhlIERSTSBkcml2ZXIgZm9yZXZlci4gVGhl
IHdvcnN0IGNhc2Ugd2FpdCB0aGUgZ2FkZ2V0IHNpZGUKKwkgKiBjYW4gaGl0IGFyZSB0ZW5zIG9m
IHNlY29uZHMgdGhyb3VnaCB0aGUgY2FsbCB0byBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0KCku
CisJICovCisJaWYgKHJlZmNvdW50X2RlY19hbmRfdGVzdCgmZ2RnLT51c2VjbnQpKSB7CisJCWZv
ciAoOyB0aW1lb3V0ICYmIHJlZmNvdW50X3JlYWQoJmdkZy0+dXNlY250KTsgdGltZW91dC0tKQor
CQkJbXNsZWVwKDUwKTsKKwl9CisKKwlpZiAoIXRpbWVvdXQpIHsKKwkJcHJfZXJyKCIlczogVGlt
ZW91dCB3YWl0aW5nIGZvciBnYWRnZXQgc2lkZSwgd2lsbCBsZWFrIG1lbW9yeVxuIiwgX19mdW5j
X18pOworCQlyZXR1cm47CisJfQorCisJdmZyZWUoZ2RnLT53b3JrX2J1Zik7CisJa2ZyZWUoZ2Rn
LT5mb3JtYXRzKTsKKwlrZnJlZShnZGctPnByb3BlcnRpZXMpOworCisJZm9yIChpID0gMDsgaSA8
IGdkZy0+Y29ubmVjdG9yX2NvdW50OyBpKyspIHsKKwkJc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0X2Nv
bm5lY3RvciAqZ2Nvbm4gPSAmZ2RnLT5jb25uZWN0b3JzW2ldOworCisJCWRybV9jb25uZWN0b3Jf
cHV0KGdjb25uLT5jb25uZWN0b3IpOworCQlrZnJlZShnY29ubi0+cHJvcGVydGllcyk7CisJCWtm
cmVlKGdjb25uLT50dl9tb2RlX2VudW1fbmFtZXMpOworCQlrZnJlZShnY29ubi0+bW9kZXMpOwor
CQlrZnJlZShnY29ubi0+ZWRpZCk7CisJfQorCWtmcmVlKGdkZy0+Y29ubmVjdG9ycyk7CisKKwln
dWRfZHJtX2dhZGdldF9kZWxldGVfYnVmZmVycyhnZGcpOworCWRybV9jbGllbnRfcmVsZWFzZShj
bGllbnQpOworCWd1ZF9kcm1fZ2FkZ2V0X3B1dChnZGcpOworfQorCitzdGF0aWMgaW50IGd1ZF9k
cm1fZ2FkZ2V0X2NsaWVudF9ob3RwbHVnKHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50KQor
eworCXN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnID0gY29udGFpbmVyX29mKGNsaWVudCwgc3Ry
dWN0IGd1ZF9kcm1fZ2FkZ2V0LCBjbGllbnQpOworCisJZ3VkX2RybV9nYWRnZXRfcHJvYmVfY29u
bmVjdG9ycyhnZGcpOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3QgZHJt
X2NsaWVudF9mdW5jcyBnZGdfY2xpZW50X2Z1bmNzID0geworCS5vd25lcgkJPSBUSElTX01PRFVM
RSwKKwkudW5yZWdpc3Rlcgk9IGd1ZF9kcm1fZ2FkZ2V0X2NsaWVudF91bnJlZ2lzdGVyLAorCS5o
b3RwbHVnCT0gZ3VkX2RybV9nYWRnZXRfY2xpZW50X2hvdHBsdWcsCit9OworCitzdHJ1Y3QgZ3Vk
X2RybV9nYWRnZXQgKmd1ZF9kcm1fZ2FkZ2V0X2luaXQodW5zaWduZWQgaW50IG1pbm9yX2lkLCBj
b25zdCBjaGFyICpiYWNrbGlnaHQsCisJCQkJCSAgIHNpemVfdCAqbWF4X2J1ZmZlcl9zaXplKQor
eworCXN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnOworCXU4IG1heF9jcHA7CisJaW50IHJldDsK
KworCWdkZyA9IGt6YWxsb2Moc2l6ZW9mKCpnZGcpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWdkZykK
KwkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7CisKKwlyZXQgPSBkcm1fY2xpZW50X2luaXRfZnJv
bV9pZChtaW5vcl9pZCwgJmdkZy0+Y2xpZW50LCAiZ3VkLWRybS1nYWRnZXQiLCAmZ2RnX2NsaWVu
dF9mdW5jcyk7CisJaWYgKHJldCkgeworCQlwcl9lcnIoIkZhaWxlZCB0byBhcXVpcmUgbWlub3I9
JXVcbiIsIG1pbm9yX2lkKTsKKwkJa2ZyZWUoZ2RnKTsKKwkJcmV0dXJuIEVSUl9QVFIocmV0KTsK
Kwl9CisKKwlyZWZjb3VudF9zZXQoJmdkZy0+dXNlY250LCAxKTsKKwkvKiBUaGUgRFJNIGRyaXZl
ciAodGhyb3VnaCB0aGUgY2xpZW50KSBhbmQgZl9ndWRfZHJtIG5lZWQgb25lIHJlZiBlYWNoICov
CisJa3JlZl9pbml0KCZnZGctPnJlZmNvdW50KTsKKwlrcmVmX2dldCgmZ2RnLT5yZWZjb3VudCk7
CisKKwlpZiAoYmFja2xpZ2h0KSB7CisJCWdkZy0+YmFja2xpZ2h0ID0gYmFja2xpZ2h0X2Rldmlj
ZV9nZXRfYnlfbmFtZShiYWNrbGlnaHQpOworCQlpZiAoIWdkZy0+YmFja2xpZ2h0KSB7CisJCQlw
cl9lcnIoIkZhaWxlZCB0byBmaW5kIGJhY2tsaWdodDogJXNcbiIsIGJhY2tsaWdodCk7CisJCQly
ZXQgPSAtRU5PREVWOworCQkJZ290byBlcnJvcl9yZWxlYXNlOworCQl9CisJfQorCisJcmV0ID0g
Z3VkX2RybV9nYWRnZXRfZ2V0X2Zvcm1hdHMoZ2RnLCAmbWF4X2NwcCk7CisJaWYgKHJldCkgewor
CQlwcl9lcnIoIkZhaWxlZCB0byBnZXQgZm9ybWF0c1xuIik7CisJCWdvdG8gZXJyb3JfcmVsZWFz
ZTsKKwl9CisKKwkqbWF4X2J1ZmZlcl9zaXplID0gZ2RnLT5jbGllbnQuZGV2LT5tb2RlX2NvbmZp
Zy5tYXhfd2lkdGggKgorCQkJICAgZ2RnLT5jbGllbnQuZGV2LT5tb2RlX2NvbmZpZy5tYXhfaGVp
Z2h0ICogbWF4X2NwcDsKKwkvKiBmX2d1ZF9kcm0gd2lsbCBrbWFsbG9jIGEgYnVmZmVyIG9mIHRo
aXMgc2l6ZSAqLworCSptYXhfYnVmZmVyX3NpemUgPSBtaW5fdChzaXplX3QsICptYXhfYnVmZmVy
X3NpemUsIEtNQUxMT0NfTUFYX1NJWkUpOworCisJZ2RnLT5tYXhfYnVmZmVyX3NpemUgPSAqbWF4
X2J1ZmZlcl9zaXplOworCWdkZy0+d29ya19idWYgPSB2bWFsbG9jKGdkZy0+bWF4X2J1ZmZlcl9z
aXplKTsKKwlpZiAoIWdkZy0+d29ya19idWYpIHsKKwkJcmV0ID0gLUVOT01FTTsKKwkJZ290byBl
cnJvcl9yZWxlYXNlOworCX0KKworCXJldCA9IGd1ZF9kcm1fZ2FkZ2V0X2dldF9wcm9wZXJ0aWVz
KGdkZyk7CisJaWYgKHJldCkgeworCQlwcl9lcnIoIkZhaWxlZCB0byBnZXQgcHJvcGVydGllc1xu
Iik7CisJCWdvdG8gZXJyb3JfcmVsZWFzZTsKKwl9CisKKwlyZXQgPSBndWRfZHJtX2dhZGdldF9n
ZXRfY29ubmVjdG9ycyhnZGcpOworCWlmIChyZXQpIHsKKwkJcHJfZXJyKCJGYWlsZWQgdG8gZ2V0
IGNvbm5lY3RvcnNcbiIpOworCQlnb3RvIGVycm9yX3JlbGVhc2U7CisJfQorCisJaWYgKCFkcm1f
Y2xpZW50X3JlZ2lzdGVyKCZnZGctPmNsaWVudCkpIHsKKwkJcHJfZXJyKCJEUk0gZGV2aWNlIGlz
IGdvbmVcbiIpOworCQlyZXQgPSAtRU5PREVWOworCQlnb3RvIGVycm9yX3JlbGVhc2U7CisJfQor
CisJZ3VkX2RybV9nYWRnZXRfcHJvYmVfY29ubmVjdG9ycyhnZGcpOworCisJcmV0dXJuIGdkZzsK
KworZXJyb3JfcmVsZWFzZToKKwlndWRfZHJtX2dhZGdldF9jbGllbnRfdW5yZWdpc3RlcigmZ2Rn
LT5jbGllbnQpOworCWd1ZF9kcm1fZ2FkZ2V0X2ZpbmkoZ2RnKTsKKworCXJldHVybiBFUlJfUFRS
KHJldCk7Cit9CitFWFBPUlRfU1lNQk9MKGd1ZF9kcm1fZ2FkZ2V0X2luaXQpOworCit2b2lkIGd1
ZF9kcm1fZ2FkZ2V0X2Zpbmkoc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcpCit7CisJYmFja2xp
Z2h0X3B1dChnZGctPmJhY2tsaWdodCk7CisJZ3VkX2RybV9nYWRnZXRfcHV0KGdkZyk7Cit9CitF
WFBPUlRfU1lNQk9MKGd1ZF9kcm1fZ2FkZ2V0X2ZpbmkpOworCitNT0RVTEVfQVVUSE9SKCJOb3Jh
bGYgVHLDuG5uZXMiKTsKK01PRFVMRV9MSUNFTlNFKCJHUEwiKTsKZGlmZiAtLWdpdCBhL2luY2x1
ZGUvZHJtL2d1ZF9kcm0uaCBiL2luY2x1ZGUvZHJtL2d1ZF9kcm0uaAppbmRleCA3ODc2ZDJlM2Ni
Y2YuLmRmOGUxNmMyZGU0YiAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vZ3VkX2RybS5oCisrKyBi
L2luY2x1ZGUvZHJtL2d1ZF9kcm0uaApAQCAtMzU4LDQgKzM1OCwxNyBAQCBzdGF0aWMgaW5saW5l
IHZvaWQgZ3VkX2RybV90b19kaXNwbGF5X21vZGUoc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKmRz
dCwKIAlkcm1fbW9kZV9zZXRfbmFtZShkc3QpOwogfQogCitzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQ7
CisKK3N0cnVjdCBndWRfZHJtX2dhZGdldCAqZ3VkX2RybV9nYWRnZXRfaW5pdCh1bnNpZ25lZCBp
bnQgbWlub3JfaWQsIGNvbnN0IGNoYXIgKmJhY2tsaWdodCwKKwkJCQkJICAgc2l6ZV90ICptYXhf
YnVmZmVyX3NpemUpOwordm9pZCBndWRfZHJtX2dhZGdldF9maW5pKHN0cnVjdCBndWRfZHJtX2dh
ZGdldCAqZ2RnKTsKK2ludCBndWRfZHJtX2dhZGdldF9kaXNhYmxlX3BpcGUoc3RydWN0IGd1ZF9k
cm1fZ2FkZ2V0ICpnZGcpOworaW50IGd1ZF9kcm1fZ2FkZ2V0X2N0cmxfZ2V0KHN0cnVjdCBndWRf
ZHJtX2dhZGdldCAqZ2RnLCB1OCByZXF1ZXN0LAorCQkJICAgIHUxNiBpbmRleCwgdm9pZCAqZGF0
YSwgc2l6ZV90IHNpemUpOworaW50IGd1ZF9kcm1fZ2FkZ2V0X2N0cmxfc2V0KHN0cnVjdCBndWRf
ZHJtX2dhZGdldCAqZ2RnLCB1OCByZXF1ZXN0LAorCQkJICAgIHUxNiBpbmRleCwgdm9pZCAqZGF0
YSwgc2l6ZV90IHNpemUpOworaW50IGd1ZF9kcm1fZ2FkZ2V0X3NldF9idWZmZXIoc3RydWN0IGd1
ZF9kcm1fZ2FkZ2V0ICpnZGcsIHN0cnVjdCBndWRfZHJtX3JlcV9zZXRfYnVmZmVyICpyZXEpOwor
aW50IGd1ZF9kcm1fZ2FkZ2V0X3dyaXRlX2J1ZmZlcihzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdk
ZywgY29uc3Qgdm9pZCAqYnVmLCBzaXplX3QgbGVuKTsKKwogI2VuZGlmCi0tIAoyLjIzLjAKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBt
YWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3Rz
LmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
