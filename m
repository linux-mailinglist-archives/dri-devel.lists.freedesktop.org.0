Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 5B9FCEE62F
	for <lists+dri-devel@lfdr.de>; Mon,  4 Nov 2019 18:38:18 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 4E3206E79C;
	Mon,  4 Nov 2019 17:38:11 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wm1-x344.google.com (mail-wm1-x344.google.com
 [IPv6:2a00:1450:4864:20::344])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0515C6E796
 for <dri-devel@lists.freedesktop.org>; Mon,  4 Nov 2019 17:38:10 +0000 (UTC)
Received: by mail-wm1-x344.google.com with SMTP id m17so8369654wmi.5
 for <dri-devel@lists.freedesktop.org>; Mon, 04 Nov 2019 09:38:09 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=CgtNM5aIR1Yq24u5yWTWDpVHmk3WVuyWYXkxbwfb67A=;
 b=ZGq41Lkw/00QGtrbh6yj4wCiaJUsvDy6QxOAZlP1C7X9FYccG5b8pGKSKd2/l1rlZi
 UR9jPbBj/yakIaM2XMLBZt++wews6149364B3OecNbAUFQO0Ze4giGnkBRtt5KZS1z3u
 l49qJAXIyxkQ+V95GE/yZBVjPCzRZ7jdH264kcKhhhYqfNl9aRjnbkCZ/RZZR+dz9W3u
 5gN12lL+Hq58MccrIFTUQR4cQ5sQ2To2xi4t4RQSvQJVcLA7NtmMMTGTEABa31SedF/0
 Jfd1cOuSct/IUL1ujvH1Y2BrnIChLpqD+Rue3xw24akBzwdBiZSywX7Bz+xj6z5j9e+t
 B+dg==
X-Gm-Message-State: APjAAAUro0fZE9aIsRUpmy1OKLdducnehKJYNp199jAqmJURcGWo1wvf
 7yfXnj5lrl1u/eW47lNwaKzjq6f96io=
X-Google-Smtp-Source: APXvYqyEk++V14ymsAk+NPvZ83SdT4efVsdQXaaBc+GkquyCXfOh2hHSdHciWzk6wysALEFcs3MXLw==
X-Received: by 2002:a1c:6309:: with SMTP id x9mr234524wmb.108.1572889088326;
 Mon, 04 Nov 2019 09:38:08 -0800 (PST)
Received: from phenom.ffwll.local (212-51-149-96.fiber7.init7.net.
 [212.51.149.96])
 by smtp.gmail.com with ESMTPSA id h140sm17991468wme.22.2019.11.04.09.38.07
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 04 Nov 2019 09:38:07 -0800 (PST)
From: Daniel Vetter <daniel.vetter@ffwll.ch>
To: DRI Development <dri-devel@lists.freedesktop.org>
Subject: [PATCH 2/3] drm/nouveau: slowpath for pushbuf ioctl
Date: Mon,  4 Nov 2019 18:38:00 +0100
Message-Id: <20191104173801.2972-2-daniel.vetter@ffwll.ch>
X-Mailer: git-send-email 2.24.0.rc2
In-Reply-To: <20191104173801.2972-1-daniel.vetter@ffwll.ch>
References: <20191104173801.2972-1-daniel.vetter@ffwll.ch>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ffwll.ch; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=CgtNM5aIR1Yq24u5yWTWDpVHmk3WVuyWYXkxbwfb67A=;
 b=klG+YEnE5UOXOxPPntfJp+We0KF/EHaeutUE70DO8GJ3PlWWKrGgOIdF8YXEqq2Hmn
 b8OihkS0wjpPrYJcVHhHodLagVWxcuohefIrDQfIP6KaZ/ifjNYCCZWDdCUs0SkSjMyV
 NWiPsjX42V0gcRQL2l5CEa1pijcM4q3Ljs8KE=
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>,
 Intel Graphics Development <intel-gfx@lists.freedesktop.org>,
 Ben Skeggs <bskeggs@redhat.com>, nouveau@lists.freedesktop.org,
 Daniel Vetter <daniel.vetter@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2UgY2FuJ3QgY29weV8qX3VzZXIgd2hpbGUgaG9sZGluZyByZXNlcnZhdGlvbnMsIHRoYXQgd2ls
bCAoc29vbiBldmVuCmZvciBub3V2ZWF1KSBsZWFkIHRvIGRlYWRsb2Nrcy4gQW5kIGl0IGJyZWFr
cyB0aGUgY3Jvc3MtZHJpdmVyCmNvbnRyYWN0IGFyb3VuZCBkbWFfcmVzdi4KCkZpeCB0aGlzIGJ5
IGFkZGluZyBhIHNsb3dwYXRoIGZvciB3aGVuIHdlIG5lZWQgcmVsb2NhdGlvbnMsIGFuZCBieQpw
dXNoaW5nIHRoZSB3cml0ZWJhY2sgb2YgdGhlIG5ldyBwcmVzdW1lZCBvZmZzZXRzIHRvIHRoZSB2
ZXJ5IGVuZC4KCkFzaWRlIGZyb20gIml0IGNvbXBpbGVzIiBlbnRpcmVseSB1bnRlc3RlZCB1bmZv
cnR1bmF0ZWx5LgoKU2lnbmVkLW9mZi1ieTogRGFuaWVsIFZldHRlciA8ZGFuaWVsLnZldHRlckBp
bnRlbC5jb20+CkNjOiBJbGlhIE1pcmtpbiA8aW1pcmtpbkBhbHVtLm1pdC5lZHU+CkNjOiBNYWFy
dGVuIExhbmtob3JzdCA8bWFhcnRlbi5sYW5raG9yc3RAbGludXguaW50ZWwuY29tPgpDYzogQmVu
IFNrZWdncyA8YnNrZWdnc0ByZWRoYXQuY29tPgpDYzogbm91dmVhdUBsaXN0cy5mcmVlZGVza3Rv
cC5vcmcKLS0tCiBkcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X2dlbS5jIHwgNTcgKysr
KysrKysrKysrKysrKysrLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMzggaW5zZXJ0aW9ucygr
KSwgMTkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUv
bm91dmVhdV9nZW0uYyBiL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25vdXZlYXVfZ2VtLmMKaW5k
ZXggMTMyNGMxOWY0ZTVjLi4wNWVjOGVkZDZhOGIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9ub3V2ZWF1L25vdXZlYXVfZ2VtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91
dmVhdV9nZW0uYwpAQCAtNDg0LDEyICs0ODQsOSBAQCB2YWxpZGF0ZV9pbml0KHN0cnVjdCBub3V2
ZWF1X2NoYW5uZWwgKmNoYW4sIHN0cnVjdCBkcm1fZmlsZSAqZmlsZV9wcml2LAogCiBzdGF0aWMg
aW50CiB2YWxpZGF0ZV9saXN0KHN0cnVjdCBub3V2ZWF1X2NoYW5uZWwgKmNoYW4sIHN0cnVjdCBu
b3V2ZWF1X2NsaSAqY2xpLAotCSAgICAgIHN0cnVjdCBsaXN0X2hlYWQgKmxpc3QsIHN0cnVjdCBk
cm1fbm91dmVhdV9nZW1fcHVzaGJ1Zl9ibyAqcGJibywKLQkgICAgICB1aW50NjRfdCB1c2VyX3Bi
Ym9fcHRyKQorCSAgICAgIHN0cnVjdCBsaXN0X2hlYWQgKmxpc3QsIHN0cnVjdCBkcm1fbm91dmVh
dV9nZW1fcHVzaGJ1Zl9ibyAqcGJibykKIHsKIAlzdHJ1Y3Qgbm91dmVhdV9kcm0gKmRybSA9IGNo
YW4tPmRybTsKLQlzdHJ1Y3QgZHJtX25vdXZlYXVfZ2VtX3B1c2hidWZfYm8gX191c2VyICp1cGJi
byA9Ci0JCQkJKHZvaWQgX19mb3JjZSBfX3VzZXIgKikodWludHB0cl90KXVzZXJfcGJib19wdHI7
CiAJc3RydWN0IG5vdXZlYXVfYm8gKm52Ym87CiAJaW50IHJldCwgcmVsb2NzID0gMDsKIApAQCAt
NTMzLDEwICs1MzAsNiBAQCB2YWxpZGF0ZV9saXN0KHN0cnVjdCBub3V2ZWF1X2NoYW5uZWwgKmNo
YW4sIHN0cnVjdCBub3V2ZWF1X2NsaSAqY2xpLAogCQkJYi0+cHJlc3VtZWQub2Zmc2V0ID0gbnZi
by0+Ym8ub2Zmc2V0OwogCQkJYi0+cHJlc3VtZWQudmFsaWQgPSAwOwogCQkJcmVsb2NzKys7Ci0K
LQkJCWlmIChjb3B5X3RvX3VzZXIoJnVwYmJvW252Ym8tPnBiYm9faW5kZXhdLnByZXN1bWVkLAot
CQkJCQkgICAgICZiLT5wcmVzdW1lZCwgc2l6ZW9mKGItPnByZXN1bWVkKSkpCi0JCQkJcmV0dXJu
IC1FRkFVTFQ7CiAJCX0KIAl9CiAKQEAgLTU0Nyw4ICs1NDAsOCBAQCBzdGF0aWMgaW50CiBub3V2
ZWF1X2dlbV9wdXNoYnVmX3ZhbGlkYXRlKHN0cnVjdCBub3V2ZWF1X2NoYW5uZWwgKmNoYW4sCiAJ
CQkgICAgIHN0cnVjdCBkcm1fZmlsZSAqZmlsZV9wcml2LAogCQkJICAgICBzdHJ1Y3QgZHJtX25v
dXZlYXVfZ2VtX3B1c2hidWZfYm8gKnBiYm8sCi0JCQkgICAgIHVpbnQ2NF90IHVzZXJfYnVmZmVy
cywgaW50IG5yX2J1ZmZlcnMsCi0JCQkgICAgIHN0cnVjdCB2YWxpZGF0ZV9vcCAqb3AsIGludCAq
YXBwbHlfcmVsb2NzKQorCQkJICAgICBpbnQgbnJfYnVmZmVycywKKwkJCSAgICAgc3RydWN0IHZh
bGlkYXRlX29wICpvcCwgYm9vbCAqYXBwbHlfcmVsb2NzKQogewogCXN0cnVjdCBub3V2ZWF1X2Ns
aSAqY2xpID0gbm91dmVhdV9jbGkoZmlsZV9wcml2KTsKIAlpbnQgcmV0OwpAQCAtNTY1LDcgKzU1
OCw3IEBAIG5vdXZlYXVfZ2VtX3B1c2hidWZfdmFsaWRhdGUoc3RydWN0IG5vdXZlYXVfY2hhbm5l
bCAqY2hhbiwKIAkJcmV0dXJuIHJldDsKIAl9CiAKLQlyZXQgPSB2YWxpZGF0ZV9saXN0KGNoYW4s
IGNsaSwgJm9wLT5saXN0LCBwYmJvLCB1c2VyX2J1ZmZlcnMpOworCXJldCA9IHZhbGlkYXRlX2xp
c3QoY2hhbiwgY2xpLCAmb3AtPmxpc3QsIHBiYm8pOwogCWlmICh1bmxpa2VseShyZXQgPCAwKSkg
ewogCQlpZiAocmV0ICE9IC1FUkVTVEFSVFNZUykKIAkJCU5WX1BSSU5USyhlcnIsIGNsaSwgInZh
bGlkYXRpbmcgYm8gbGlzdFxuIik7CkBAIC02MDUsMTYgKzU5OCwxMiBAQCB1X21lbWNweWEodWlu
dDY0X3QgdXNlciwgdW5zaWduZWQgbm1lbWIsIHVuc2lnbmVkIHNpemUpCiBzdGF0aWMgaW50CiBu
b3V2ZWF1X2dlbV9wdXNoYnVmX3JlbG9jX2FwcGx5KHN0cnVjdCBub3V2ZWF1X2NsaSAqY2xpLAog
CQkJCXN0cnVjdCBkcm1fbm91dmVhdV9nZW1fcHVzaGJ1ZiAqcmVxLAorCQkJCXN0cnVjdCBkcm1f
bm91dmVhdV9nZW1fcHVzaGJ1Zl9yZWxvYyAqcmVsb2MsCiAJCQkJc3RydWN0IGRybV9ub3V2ZWF1
X2dlbV9wdXNoYnVmX2JvICpibykKIHsKLQlzdHJ1Y3QgZHJtX25vdXZlYXVfZ2VtX3B1c2hidWZf
cmVsb2MgKnJlbG9jID0gTlVMTDsKIAlpbnQgcmV0ID0gMDsKIAl1bnNpZ25lZCBpOwogCi0JcmVs
b2MgPSB1X21lbWNweWEocmVxLT5yZWxvY3MsIHJlcS0+bnJfcmVsb2NzLCBzaXplb2YoKnJlbG9j
KSk7Ci0JaWYgKElTX0VSUihyZWxvYykpCi0JCXJldHVybiBQVFJfRVJSKHJlbG9jKTsKLQogCWZv
ciAoaSA9IDA7IGkgPCByZXEtPm5yX3JlbG9jczsgaSsrKSB7CiAJCXN0cnVjdCBkcm1fbm91dmVh
dV9nZW1fcHVzaGJ1Zl9yZWxvYyAqciA9ICZyZWxvY1tpXTsKIAkJc3RydWN0IGRybV9ub3V2ZWF1
X2dlbV9wdXNoYnVmX2JvICpiOwpAQCAtNjkzLDExICs2ODIsMTMgQEAgbm91dmVhdV9nZW1faW9j
dGxfcHVzaGJ1ZihzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCXN0cnVjdCBu
b3V2ZWF1X2RybSAqZHJtID0gbm91dmVhdV9kcm0oZGV2KTsKIAlzdHJ1Y3QgZHJtX25vdXZlYXVf
Z2VtX3B1c2hidWYgKnJlcSA9IGRhdGE7CiAJc3RydWN0IGRybV9ub3V2ZWF1X2dlbV9wdXNoYnVm
X3B1c2ggKnB1c2g7CisJc3RydWN0IGRybV9ub3V2ZWF1X2dlbV9wdXNoYnVmX3JlbG9jICpyZWxv
YyA9IE5VTEw7CiAJc3RydWN0IGRybV9ub3V2ZWF1X2dlbV9wdXNoYnVmX2JvICpibzsKIAlzdHJ1
Y3Qgbm91dmVhdV9jaGFubmVsICpjaGFuID0gTlVMTDsKIAlzdHJ1Y3QgdmFsaWRhdGVfb3Agb3A7
CiAJc3RydWN0IG5vdXZlYXVfZmVuY2UgKmZlbmNlID0gTlVMTDsKLQlpbnQgaSwgaiwgcmV0ID0g
MCwgZG9fcmVsb2MgPSAwOworCWludCBpLCBqLCByZXQgPSAwOworCWJvb2wgZG9fcmVsb2MgPSBm
YWxzZTsKIAogCWlmICh1bmxpa2VseSghYWJpMTYpKQogCQlyZXR1cm4gLUVOT01FTTsKQEAgLTc1
NSw3ICs3NDYsOCBAQCBub3V2ZWF1X2dlbV9pb2N0bF9wdXNoYnVmKHN0cnVjdCBkcm1fZGV2aWNl
ICpkZXYsIHZvaWQgKmRhdGEsCiAJfQogCiAJLyogVmFsaWRhdGUgYnVmZmVyIGxpc3QgKi8KLQly
ZXQgPSBub3V2ZWF1X2dlbV9wdXNoYnVmX3ZhbGlkYXRlKGNoYW4sIGZpbGVfcHJpdiwgYm8sIHJl
cS0+YnVmZmVycywKK3JldmFsaWRhdGU6CisJcmV0ID0gbm91dmVhdV9nZW1fcHVzaGJ1Zl92YWxp
ZGF0ZShjaGFuLCBmaWxlX3ByaXYsIGJvLAogCQkJCQkgICByZXEtPm5yX2J1ZmZlcnMsICZvcCwg
JmRvX3JlbG9jKTsKIAlpZiAocmV0KSB7CiAJCWlmIChyZXQgIT0gLUVSRVNUQVJUU1lTKQpAQCAt
NzY1LDcgKzc1NywxOCBAQCBub3V2ZWF1X2dlbV9pb2N0bF9wdXNoYnVmKHN0cnVjdCBkcm1fZGV2
aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAKIAkvKiBBcHBseSBhbnkgcmVsb2NhdGlvbnMgdGhhdCBh
cmUgcmVxdWlyZWQgKi8KIAlpZiAoZG9fcmVsb2MpIHsKLQkJcmV0ID0gbm91dmVhdV9nZW1fcHVz
aGJ1Zl9yZWxvY19hcHBseShjbGksIHJlcSwgYm8pOworCQlpZiAoIXJlbG9jKSB7CisJCQl2YWxp
ZGF0ZV9maW5pKCZvcCwgY2hhbiwgTlVMTCwgYm8pOworCQkJcmVsb2MgPSB1X21lbWNweWEocmVx
LT5yZWxvY3MsIHJlcS0+bnJfcmVsb2NzLCBzaXplb2YoKnJlbG9jKSk7CisJCQlpZiAoSVNfRVJS
KHJlbG9jKSkgeworCQkJCXJldCA9IFBUUl9FUlIocmVsb2MpOworCQkJCWdvdG8gb3V0X3ByZXZh
bGlkOworCQkJfQorCisJCQlnb3RvIHJldmFsaWRhdGU7CisJCX0KKworCQlyZXQgPSBub3V2ZWF1
X2dlbV9wdXNoYnVmX3JlbG9jX2FwcGx5KGNsaSwgcmVxLCByZWxvYywgYm8pOwogCQlpZiAocmV0
KSB7CiAJCQlOVl9QUklOVEsoZXJyLCBjbGksICJyZWxvYyBhcHBseTogJWRcbiIsIHJldCk7CiAJ
CQlnb3RvIG91dDsKQEAgLTg1MSw2ICs4NTQsMjIgQEAgbm91dmVhdV9nZW1faW9jdGxfcHVzaGJ1
ZihzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCXZhbGlkYXRlX2ZpbmkoJm9w
LCBjaGFuLCBmZW5jZSwgYm8pOwogCW5vdXZlYXVfZmVuY2VfdW5yZWYoJmZlbmNlKTsKIAorCWlm
IChkb19yZWxvYykgeworCQlzdHJ1Y3QgZHJtX25vdXZlYXVfZ2VtX3B1c2hidWZfYm8gX191c2Vy
ICp1cGJibyA9CisJCQl1NjRfdG9fdXNlcl9wdHIocmVxLT5idWZmZXJzKTsKKworCQlmb3IgKGkg
PSAwOyBpIDwgcmVxLT5ucl9idWZmZXJzOyBpKyspIHsKKwkJCWlmIChib1tpXS5wcmVzdW1lZC52
YWxpZCkKKwkJCQljb250aW51ZTsKKworCQkJaWYgKGNvcHlfdG9fdXNlcigmdXBiYm9baV0ucHJl
c3VtZWQsICZib1tpXS5wcmVzdW1lZCwKKwkJCQkJIHNpemVvZihib1tpXS5wcmVzdW1lZCkpKSB7
CisJCQkJcmV0ID0gLUVGQVVMVDsKKwkJCQlicmVhazsKKwkJCX0KKwkJfQorCQl1X2ZyZWUocmVs
b2MpOworCX0KIG91dF9wcmV2YWxpZDoKIAl1X2ZyZWUoYm8pOwogCXVfZnJlZShwdXNoKTsKLS0g
CjIuMjQuMC5yYzIKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9y
ZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZl
bA==
