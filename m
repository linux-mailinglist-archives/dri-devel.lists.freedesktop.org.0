Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 43B5C37E82
	for <lists+dri-devel@lfdr.de>; Thu,  6 Jun 2019 22:20:59 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B4BBA89812;
	Thu,  6 Jun 2019 20:20:56 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-it1-x142.google.com (mail-it1-x142.google.com
 [IPv6:2607:f8b0:4864:20::142])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1001989812
 for <dri-devel@lists.freedesktop.org>; Thu,  6 Jun 2019 20:20:56 +0000 (UTC)
Received: by mail-it1-x142.google.com with SMTP id j204so2017697ite.4
 for <dri-devel@lists.freedesktop.org>; Thu, 06 Jun 2019 13:20:56 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=sUXm3Wd8oYuxkA69NiXfIS+UrWdJqjnOIx5pX1NZf1s=;
 b=ftPvcGeSUbV2iO3dv1serfELIt97FnriN6WsgkkIQZqnkJ3w3hhVkEZq3yTcZXa63F
 dlIiWGu5ytKQjQo3FxFP7OwHolh8CkYsYptDgZvpMpBdXfJX6QKEoQYYl1POLBSO8kf0
 /KXJA7BLghbAlxiKcpHLOLqErI3jvoAXPWpkp9td9AjXOeKH03E7JUHtHnWScVv2Wz3e
 pnbXtDSH4/Pfzq8jFtdr/8Qlu4av6NmykEUhbBjVPs0Pf0+WPdRKDt7vZ1hsrXGNlH+9
 xD5JHpfieYSt+1oHdF6BhAFdTuhEOz9eqgraMo33nkKYz/jIrjroqwfgmkJeU5uMLuuv
 e+sw==
X-Gm-Message-State: APjAAAXtqEa/QWn1BFcvly5Qxp7XX1JfS2J51DWOsnB25/9JB5yXmyJC
 m6D69QxzdEl9KNSXcCwtLe5Ibats+WQ=
X-Google-Smtp-Source: APXvYqxLf4ImG3HIcS6elCvmAEy24g+oFz5LYUgolsrgmpcFEUUiPhlxihcEYwTjp0bJnL6pv8MYcA==
X-Received: by 2002:a24:9083:: with SMTP id x125mr1633343itd.76.1559852454641; 
 Thu, 06 Jun 2019 13:20:54 -0700 (PDT)
Received: from james-x399.Home (97-118-163-58.hlrn.qwest.net. [97.118.163.58])
 by smtp.gmail.com with ESMTPSA id
 v130sm1318384itc.8.2019.06.06.13.20.53
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
 Thu, 06 Jun 2019 13:20:53 -0700 (PDT)
From: James Hilliard <james.hilliard1@gmail.com>
To: dri-devel@lists.freedesktop.org
Subject: [RFC PATCH 1/1] drm/gma500: add atomic support
Date: Thu,  6 Jun 2019 14:20:32 -0600
Message-Id: <20190606202032.29748-1-james.hilliard1@gmail.com>
X-Mailer: git-send-email 2.20.1
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=sUXm3Wd8oYuxkA69NiXfIS+UrWdJqjnOIx5pX1NZf1s=;
 b=CxyFdkUwUKg/DbpbS1JxSdEOxljQTmdE2c4TtgnVB0Lc8W44Qp9sMFoA4oE91ycRSp
 JCCAMKu30GzN3UTi6vRWAyXJjr9wscqY/MiBKyz6TdHtODkl+ynEtCQkstu/TR3LsLSR
 leJrntCLOhaNI4+FJ34Nu6W6IaM4HHEDmluiC+mE6dVooSkNQ+Lf2v1X7TqcZ5/VDhen
 ORN1Q5OGqwkpSciOQY8MzBw3yzvu/TSY+A9q8aqvL+LA5cSg1VR9xEYTzMSE8/5DNzs5
 OiM5EMhugvJ/xzKNDJG0whIzwm+DVTd2JXPSQOIiKzrcr4vIvu0JXz9BUMd8QNUcDXgj
 xcgA==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: James Hilliard <james.hilliard1@gmail.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

SW1wb3J0ZWQgZnJvbSBodHRwczovL2dpdC50aXplbi5vcmcvY2dpdC9rZXJuZWwva2VybmVsLW1m
bGQtYmxhY2tiYXkvCgpUaGlzIGlzIGN1cnJlbnRseSBub3QgZnVuY3Rpb25hbCBhbmQgYmFzZWQg
b2ZmIG9mIGFuIG9sZGVyIHZlcnNpb24gb2YKdGhlIGdtYTUwMCBkcml2ZXIuIEZyb20gdGhlIGNv
bW1pdCBsb2cgdGhpcyB3YXMgd3JpdHRlbiBieSBJbnRlbCwgaXMKYW55b25lIGF3YXJlIG9mIGEg
bW9yZSB1cCB0byBkYXRlIHZlcnNpb24/CgpJJ20gbG9va2luZyB0byBzZWUgaWYgdGhpcyB3b3Vs
ZCBiZSBhIGRlY2VudCBzdGFydGluZyBwb2ludCBmb3IgYWRkaW5nCmdtYTUwMCBhdG9taWMgc3Vw
cG9ydCB0byBtYWlubGluZSBhbmQgaG93IGJlc3QgdG8gYXBwcm9hY2ggdGhhdC4KClNpZ25lZC1v
ZmYtYnk6IEphbWVzIEhpbGxpYXJkIDxqYW1lcy5oaWxsaWFyZDFAZ21haWwuY29tPgotLS0KIGRy
aXZlcnMvZ3B1L2RybS9nbWE1MDAvTWFrZWZpbGUgICAgICAgIHwgICAxICsKIGRyaXZlcnMvZ3B1
L2RybS9nbWE1MDAvcHNiX3BhZ2VfZmxpcC5jIHwgNjAwICsrKysrKysrKysrKysrKysrKysrKysr
KysKIGRyaXZlcnMvZ3B1L2RybS9nbWE1MDAvcHNiX3BhZ2VfZmxpcC5oIHwgIDM4ICsrCiAzIGZp
bGVzIGNoYW5nZWQsIDYzOSBpbnNlcnRpb25zKCspCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVy
cy9ncHUvZHJtL2dtYTUwMC9wc2JfcGFnZV9mbGlwLmMKIGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2
ZXJzL2dwdS9kcm0vZ21hNTAwL3BzYl9wYWdlX2ZsaXAuaAoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9nbWE1MDAvTWFrZWZpbGUgYi9kcml2ZXJzL2dwdS9kcm0vZ21hNTAwL01ha2VmaWxl
CmluZGV4IGM4ZjJjODliZTk5ZC4uM2RiNTM1ZWY1MWNiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vZ21hNTAwL01ha2VmaWxlCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9nbWE1MDAvTWFrZWZp
bGUKQEAgLTI0LDYgKzI0LDcgQEAgZ21hNTAwX2dmeC15ICs9IFwKIAkgIHBzYl9pbnRlbF9zZHZv
Lm8gXAogCSAgcHNiX2xpZC5vIFwKIAkgIHBzYl9pcnEubyBcCisJICBwc2JfcGFnZV9mbGlwLm8g
XAogCSAgcHNiX2RldmljZS5vIFwKIAkgIG1pZF9iaW9zLm8KIApkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2dtYTUwMC9wc2JfcGFnZV9mbGlwLmMgYi9kcml2ZXJzL2dwdS9kcm0vZ21hNTAw
L3BzYl9wYWdlX2ZsaXAuYwpuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMDAwMDAu
LjZhOTM3MjdjZjFjMQotLS0gL2Rldi9udWxsCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9nbWE1MDAv
cHNiX3BhZ2VfZmxpcC5jCkBAIC0wLDAgKzEsNjAwIEBACisvKgorICogQ29weXJpZ2h0IChjKSAy
MDExLTIwMTIsIEludGVsIENvcnBvcmF0aW9uLgorICoKKyAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVl
IHNvZnR3YXJlOyB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5IGl0CisgKiB1
bmRlciB0aGUgdGVybXMgYW5kIGNvbmRpdGlvbnMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBM
aWNlbnNlLAorICogdmVyc2lvbiAyLCBhcyBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUg
Rm91bmRhdGlvbi4KKyAqCisgKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhv
cGUgaXQgd2lsbCBiZSB1c2VmdWwsIGJ1dCBXSVRIT1VUCisgKiBBTlkgV0FSUkFOVFk7IHdpdGhv
dXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IKKyAqIEZJ
VE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZSBHTlUgR2VuZXJhbCBQdWJs
aWMgTGljZW5zZSBmb3IKKyAqIG1vcmUgZGV0YWlscy4KKyAqCisgKiBZb3Ugc2hvdWxkIGhhdmUg
cmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3
aXRoCisgKiB0aGlzIHByb2dyYW07IGlmIG5vdCwgd3JpdGUgdG8gdGhlIEZyZWUgU29mdHdhcmUg
Rm91bmRhdGlvbiwgSW5jLizCtworICogNTEgRnJhbmtsaW4gU3QgLSBGaWZ0aCBGbG9vciwgQm9z
dG9uLCBNQSAwMjExMC0xMzAxIFVTQS4KKyAqCisgKiBBdXRob3JzOgorICogQW5kZXIgQ29uc2Vs
dmFuIGRlIE9saXZlaXJhIDxhbmRlci5jb25zZWx2YW4uZGUub2xpdmVpcmFAaW50ZWwuY29tPgor
ICogUGF1bGkgTmllbWluZW4gPHBhdWxpLm5pZW1pbmVuQGludGVsLmNvbT4KKyAqIFZpbGxlIFN5
cmrDpGzDpCA8dmlsbGUuc3lyamFsYUBsaW51eC5pbnRlbC5jb20+CisgKi8KKworI2luY2x1ZGUg
PGxpbnV4L3NwaW5sb2NrLmg+CisjaW5jbHVkZSA8bGludXgvbGlzdC5oPgorCisjaW5jbHVkZSA8
ZHJtL2RybVAuaD4KKyNpbmNsdWRlICJwc2JfZHJ2LmgiCisjaW5jbHVkZSAiZnJhbWVidWZmZXIu
aCIKKyNpbmNsdWRlICJwc2JfaW50ZWxfcmVnLmgiCisjaW5jbHVkZSAicHNiX3BhZ2VfZmxpcC5o
IgorCisjaW5jbHVkZSAibWRmbGRfb3V0cHV0LmgiCisjaW5jbHVkZSAibWRmbGRfZHNpX291dHB1
dC5oIgorCisjaWYgZGVmaW5lZChDT05GSUdfTURGTERfRFVBTF9EU0lfRFBVKQorI2luY2x1ZGUg
Im1kZmxkX2RzaV9kYmlfZHB1LmgiCisjZWxpZiBkZWZpbmVkKENPTkZJR19NREZMRF9EU0lfRFNS
KQorI2luY2x1ZGUgIm1kZmxkX2RzaV9kYmkuaCIKKyNlbmRpZgorCitzdHJ1Y3QgcGVuZGluZ19m
bGlwIHsKKwlzdHJ1Y3QgZHJtX2NydGMgKmNydGM7CisJc3RydWN0IGRybV9wZW5kaW5nX3ZibGFu
a19ldmVudCAqZXZlbnQ7CisJUFZSU1JWX0tFUk5FTF9NRU1fSU5GTyAqbWVtX2luZm87CisJUFZS
U1JWX0tFUk5FTF9NRU1fSU5GTyAqb2xkX21lbV9pbmZvOworCXVpbnQzMl90IG9mZnNldDsKKwlz
dHJ1Y3QgbGlzdF9oZWFkIHVuY29tcGxldGVkOworCXN0cnVjdCBwdnJfcGVuZGluZ19zeW5jIHBl
bmRpbmdfc3luYzsKKwlzdHJ1Y3QgZHJtX2ZsaXAgYmFzZTsKKwl1MzIgdmJsX2NvdW50OworCXN0
cnVjdCBsaXN0X2hlYWQgY29tcGFuaW9uczsKKwl1MzIgdGdpZDsKKwlib29sIHZibGFua19yZWY7
CisJYXRvbWljX3QgcmVmY250OworCXN0cnVjdCBwc2JfcGVuZGluZ192YWx1ZXMgcGVuZGluZ192
YWx1ZXM7Cit9OworCitlbnVtIHsKKwkvKiBzb213ZWhhdCBhcmJpdHJhcnkgdmFsdWUgKi8KKwlQ
U0JfVkJMX0NOVF9USU1FT1VUID0gNSwKK307CisKK3N0YXRpYyB1MzIgZ2V0X3ZibF9jb3VudChz
dHJ1Y3QgZHJtX2NydGMgKmNydGMpCit7CisJc3RydWN0IHBzYl9pbnRlbF9jcnRjICpwc2JfaW50
ZWxfY3J0YyA9IHRvX3BzYl9pbnRlbF9jcnRjKGNydGMpOworCXN0cnVjdCBkcm1fcHNiX3ByaXZh
dGUgKmRldl9wcml2ID0gY3J0Yy0+ZGV2LT5kZXZfcHJpdmF0ZTsKKwlpbnQgcGlwZSA9IHBzYl9p
bnRlbF9jcnRjLT5waXBlOworCXUzMiBoaWdoLCBsb3cxLCBsb3cyLCBkc2w7CisJdW5zaWduZWQg
aW50IHRpbWVvdXQgPSAwOworCisJLyogQWxsIHJlYWRzIG11c3QgYmUgc2F0aXNmaWVkIGR1cmlu
ZyB0aGUgc2FtZSBmcmFtZSAqLworCWRvIHsKKwkJdm9pZCBfX2lvbWVtICpyZWdfcGl4ZWw7CisJ
CXZvaWQgX19pb21lbSAqcmVnX2hpZ2g7CisKKwkJcmVnX3BpeGVsID0gZGV2X3ByaXYtPnZkY19y
ZWcgKyBQU0JfUElQRUZSQU1FUElYRUwocGlwZSk7CisJCXJlZ19oaWdoID0gZGV2X3ByaXYtPnZk
Y19yZWcgKyBQU0JfUElQRUZSQU1FSElHSChwaXBlKTsKKwkJbG93MSA9IGlvcmVhZDMyKHJlZ19w
aXhlbCkgPj4gUElQRV9GUkFNRV9MT1dfU0hJRlQ7CisJCWhpZ2ggPSBpb3JlYWQzMihyZWdfaGln
aCkgPDwgODsKKwkJZHNsID0gaW9yZWFkMzIoZGV2X3ByaXYtPnZkY19yZWcgKyBQU0JfUElQRV9E
U0wocGlwZSkpOworCQlsb3cyID0gaW9yZWFkMzIocmVnX3BpeGVsKSA+PiBQSVBFX0ZSQU1FX0xP
V19TSElGVDsKKwl9IHdoaWxlIChsb3cxICE9IGxvdzIgJiYgdGltZW91dCsrIDwgUFNCX1ZCTF9D
TlRfVElNRU9VVCk7CisKKwlpZiAodGltZW91dCA+PSBQU0JfVkJMX0NOVF9USU1FT1VUKQorCQlk
ZXZfd2FybihjcnRjLT5kZXYtPmRldiwKKwkJCSAiVGltZWQgb3V0IHdoaWxlIGRldGVybWluaW5n
IFZCTCBjb3VudCBmb3IgcGlwZSAlZFxuIiwKKwkJCSBwc2JfaW50ZWxfY3J0Yy0+cGlwZSk7CisK
KwkvKgorCSAqIFRoZSBmcmFtZSBjb3VudGVyIHNlZW1zIHRvIGluY3JlbWVudCBhdCB0aGUgYmVn
aW5uaW5nIG9mIHRoZQorCSAqIGxhc3Qgc2NhbmxpbmUuIFRoZSBoYXJkd2FyZSBwZXJmb3JtcyB0
aGUgZmxpcCBhdCB0aGUgc3RhcnQKKwkgKiBvZiB0aGUgdmJsYW5rLCBzbyB3ZSB3YW50IHRvIGNv
dW50IHRob3NlIGV2ZW50cyBpbnN0ZWFkLgorCSAqIENvb2sgdXAgYSB2YmxhbmsgY291bnRlciBm
cm9tIHRoZSBmcmFtZSBjb3VudGVyIGFuZCBzY2FubGluZQorCSAqIGNvdW50ZXIuCisJICovCisJ
cmV0dXJuICgoaGlnaCB8IGxvdzIpICsKKwkJKChkc2wgPj0gY3J0Yy0+aHdtb2RlLmNydGNfdmRp
c3BsYXkpICYmCisJCSAoZHNsIDwgY3J0Yy0+aHdtb2RlLmNydGNfdnRvdGFsIC0gMSkpKSAmIDB4
ZmZmZmZmOworfQorCitzdGF0aWMgdW5zaWduZWQgaW50IHVzZWNzX3RvX3NjYW5saW5lcyhzdHJ1
Y3QgZHJtX2NydGMgKmNydGMsCisJCQkJICAgICAgIHVuc2lnbmVkIGludCB1c2VjcykKK3sKKwkv
KiBwYXJhbm9pYSAqLworCWlmICghY3J0Yy0+aHdtb2RlLmNydGNfaHRvdGFsKQorCQlyZXR1cm4g
MTsKKworCXJldHVybiBESVZfUk9VTkRfVVAodXNlY3MgKiBjcnRjLT5od21vZGUuY2xvY2ssCisJ
CQkgICAgMTAwMCAqIGNydGMtPmh3bW9kZS5jcnRjX2h0b3RhbCk7Cit9CisKKy8qIENhbGxlZCB3
aXRoIGludGVycnVwdHMgb2ZmLiAqLworc3RhdGljIHZvaWQgYXZvaWRfZGFuZ2VyX3pvbmUoc3Ry
dWN0IGRybV9jcnRjICpjcnRjKQoreworCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBjcnRjLT5k
ZXY7CisJc3RydWN0IGRybV9wc2JfcHJpdmF0ZSAqZGV2X3ByaXYgPSBkZXYtPmRldl9wcml2YXRl
OworCXN0cnVjdCBwc2JfaW50ZWxfY3J0YyAqcHNiX2ludGVsX2NydGMgPSB0b19wc2JfaW50ZWxf
Y3J0YyhjcnRjKTsKKwlpbnQgcGlwZSA9IHBzYl9pbnRlbF9jcnRjLT5waXBlOworCS8qCisJICog
V2l0aCBDUlRDIGFuZCBvbmUgb3ZlcmxheSB3ZSdyZSB1c3VhbGx5IHNwZW5kaW5nIDMwLTQwIHVz
ZWNzCisJICogYmV0d2VlbiBhdm9pZF9kYW5nZXJfem9uZSgpIGFuZCBwc2JfZmxpcF9kcml2ZXJf
Zmx1c2goKS4gTGVhdmUKKwkgKiBhIHNtYWxsIHNhZmV0eSBtYXJnaW4gYW5kIGF2b2lkIGZsaXBw
aW5nIHdoaWxlIHVuZGVyIDYwIHVzZWMKKwkgKiBmcm9tIHRoZSB2Ymxhbmsgc3RhcnQuCisJICov
CisJdTMyIG1pbiA9IGNydGMtPmh3bW9kZS5jcnRjX3ZkaXNwbGF5IC0gdXNlY3NfdG9fc2Nhbmxp
bmVzKGNydGMsIDYwKTsKKwl1MzIgbWF4ID0gY3J0Yy0+aHdtb2RlLmNydGNfdmRpc3BsYXkgLSAx
OworCWxvbmcgdGltZW91dCA9IG1zZWNzX3RvX2ppZmZpZXMoMSk7CisJdTMyIHZhbDsKKworCWRy
bV92YmxhbmtfZ2V0KGRldiwgcGlwZSk7CisKKwlwc2JfaW50ZWxfY3J0Yy0+dmJsX3JlY2VpdmVk
ID0gZmFsc2U7CisJdmFsID0gaW9yZWFkMzIoZGV2X3ByaXYtPnZkY19yZWcgKyBQU0JfUElQRV9E
U0wocGlwZSkpOworCisJd2hpbGUgKHZhbCA+PSBtaW4gJiYgdmFsIDw9IG1heCAmJiB0aW1lb3V0
ID4gMCkgeworCQlsb2NhbF9pcnFfZW5hYmxlKCk7CisKKwkJdGltZW91dCA9IHdhaXRfZXZlbnRf
dGltZW91dChwc2JfaW50ZWxfY3J0Yy0+dmJsX3dhaXQsCisJCQkJCSAgICAgcHNiX2ludGVsX2Ny
dGMtPnZibF9yZWNlaXZlZCwKKwkJCQkJICAgICB0aW1lb3V0KTsKKworCQlsb2NhbF9pcnFfZGlz
YWJsZSgpOworCisJCXBzYl9pbnRlbF9jcnRjLT52YmxfcmVjZWl2ZWQgPSBmYWxzZTsKKwkJdmFs
ID0gaW9yZWFkMzIoZGV2X3ByaXYtPnZkY19yZWcgKyBQU0JfUElQRV9EU0wocGlwZSkpOworCX0K
KworCWRybV92YmxhbmtfcHV0KGRldiwgcGlwZSk7CisKKwlpZiAodmFsID49IG1pbiAmJiB2YWwg
PD0gbWF4KQorCQlkZXZfd2FybihkZXYtPmRldiwKKwkJCSAiUGFnZSBmbGlwcGluZyBjbG9zZSB0
byB2Ymxhbmsgc3RhcnQgKERTTD0ldSwgVkJMPSV1KVxuIiwKKwkJCSB2YWwsIGNydGMtPmh3bW9k
ZS5jcnRjX3ZkaXNwbGF5KTsKK30KKwordm9pZAorcHNiX2NsZWFudXBfcGVuZGluZ19ldmVudHMo
c3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IHBzYl9mcHJpdiAqcHJpdikKK3sKKwlzdHJ1
Y3QgZHJtX3BlbmRpbmdfdmJsYW5rX2V2ZW50ICplOworCXN0cnVjdCBwZW5kaW5nX2ZsaXAgKnBl
bmRpbmdfZmxpcCwgKnRlbXA7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKworCXNwaW5fbG9ja19p
cnFzYXZlKCZkZXYtPmV2ZW50X2xvY2ssIGZsYWdzKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3Nh
ZmUocGVuZGluZ19mbGlwLCB0ZW1wLCAmcHJpdi0+cGVuZGluZ19mbGlwcywKKwkJCXVuY29tcGxl
dGVkKSB7CisJCWUgPSBwZW5kaW5nX2ZsaXAtPmV2ZW50OworCQlwZW5kaW5nX2ZsaXAtPmV2ZW50
ID0gTlVMTDsKKwkJZS0+YmFzZS5kZXN0cm95KCZlLT5iYXNlKTsKKwkJbGlzdF9kZWxfaW5pdCgm
cGVuZGluZ19mbGlwLT51bmNvbXBsZXRlZCk7CisJfQorCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUo
JmRldi0+ZXZlbnRfbG9jaywgZmxhZ3MpOworfQorCitzdGF0aWMgdm9pZAorc2VuZF9wYWdlX2Zs
aXBfZXZlbnQoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgaW50IHBpcGUsCisJCSAgICAgc3RydWN0
IHBlbmRpbmdfZmxpcCAqcGVuZGluZ19mbGlwKQoreworCXN0cnVjdCBkcm1fcGVuZGluZ192Ymxh
bmtfZXZlbnQgKmU7CisJc3RydWN0IHRpbWV2YWwgbm93OworCXVuc2lnbmVkIGxvbmcgZmxhZ3M7
CisKKwlzcGluX2xvY2tfaXJxc2F2ZSgmZGV2LT5ldmVudF9sb2NrLCBmbGFncyk7CisKKwlpZiAo
IXBlbmRpbmdfZmxpcC0+ZXZlbnQpCisJCWdvdG8gdW5sb2NrOworCisJbGlzdF9kZWwoJnBlbmRp
bmdfZmxpcC0+dW5jb21wbGV0ZWQpOworCWUgPSBwZW5kaW5nX2ZsaXAtPmV2ZW50OworCWRvX2dl
dHRpbWVvZmRheSgmbm93KTsKKwllLT5ldmVudC5zZXF1ZW5jZSA9IGRybV92YmxhbmtfY291bnQo
ZGV2LCBwaXBlKTsKKwllLT5ldmVudC50dl9zZWMgPSBub3cudHZfc2VjOworCWUtPmV2ZW50LnR2
X3VzZWMgPSBub3cudHZfdXNlYzsKKwlsaXN0X2FkZF90YWlsKCZlLT5iYXNlLmxpbmssCisJCQkm
ZS0+YmFzZS5maWxlX3ByaXYtPmV2ZW50X2xpc3QpOworCXdha2VfdXBfaW50ZXJydXB0aWJsZSgm
ZS0+YmFzZS5maWxlX3ByaXYtPmV2ZW50X3dhaXQpOworCit1bmxvY2s6CisJc3Bpbl91bmxvY2tf
aXJxcmVzdG9yZSgmZGV2LT5ldmVudF9sb2NrLCBmbGFncyk7Cit9CisKK3N0YXRpYyB2b2lkIGZy
ZWVfZmxpcChzdHJ1Y3QgcGVuZGluZ19mbGlwICpjcnRjX2ZsaXApCit7CisJaWYgKGF0b21pY19k
ZWNfYW5kX3Rlc3QoJmNydGNfZmxpcC0+cmVmY250KSkgeworCQlwc2JfZmJfdW5yZWYoY3J0Y19m
bGlwLT5vbGRfbWVtX2luZm8sIGNydGNfZmxpcC0+dGdpZCk7CisJCWtmcmVlKGNydGNfZmxpcCk7
CisJfQorfQorCitzdGF0aWMgdm9pZCBjcnRjX2ZsaXBfY2xlYW51cChzdHJ1Y3QgZHJtX2ZsaXAg
KmZsaXApCit7CisJc3RydWN0IHBlbmRpbmdfZmxpcCAqY3J0Y19mbGlwID0KKwkJY29udGFpbmVy
X29mKGZsaXAsIHN0cnVjdCBwZW5kaW5nX2ZsaXAsIGJhc2UpOworCXN0cnVjdCBkcm1fZGV2aWNl
ICpkZXYgPSBjcnRjX2ZsaXAtPmNydGMtPmRldjsKKworCW11dGV4X2xvY2soJmRldi0+bW9kZV9j
b25maWcubXV0ZXgpOworCXBzYl9mYl9ndHRfdW5yZWYoZGV2LCBjcnRjX2ZsaXAtPm1lbV9pbmZv
LCBjcnRjX2ZsaXAtPnRnaWQpOworCW11dGV4X3VubG9jaygmZGV2LT5tb2RlX2NvbmZpZy5tdXRl
eCk7CisKKwlmcmVlX2ZsaXAoY3J0Y19mbGlwKTsKK30KKworc3RhdGljIHZvaWQgY3J0Y19mbGlw
X2ZpbmlzaChzdHJ1Y3QgZHJtX2ZsaXAgKmZsaXApCit7Cit9CisKK3N0YXRpYyB2b2lkIHBzYl9m
bGlwX2RyaXZlcl9mbHVzaChzdHJ1Y3QgZHJtX2ZsaXBfZHJpdmVyICpkcml2ZXIpCit7CisJc3Ry
dWN0IGRybV9wc2JfcHJpdmF0ZSAqZGV2X3ByaXYgPQorCQljb250YWluZXJfb2YoZHJpdmVyLCBz
dHJ1Y3QgZHJtX3BzYl9wcml2YXRlLCBmbGlwX2RyaXZlcik7CisKKwkvKiBGbHVzaCBwb3N0ZWQg
d3JpdGVzICovCisJKHZvaWQpaW9yZWFkMzIoZGV2X3ByaXYtPnZkY19yZWcgKyBQU0JfUElQRVNU
QVQoUFNCX1BJUEVfQSkpOworfQorCitzdGF0aWMgdm9pZCBwc2JfZmxpcF9jb21wbGV0ZV9zeW5j
X2NhbGxiYWNrKHN0cnVjdCBwdnJfcGVuZGluZ19zeW5jICpzeW5jLAorCQlib29sIGNhbGxfZnJv
bV93b3JrKQoreworCXN0cnVjdCBwZW5kaW5nX2ZsaXAgKmNydGNfZmxpcCA9CisJCWNvbnRhaW5l
cl9vZihzeW5jLCBzdHJ1Y3QgcGVuZGluZ19mbGlwLCBwZW5kaW5nX3N5bmMpOworCisJaWYgKHBz
Yl9mYl9pbmNyZWFzZV9yZWFkX29wc19jb21wbGV0ZWQoY3J0Y19mbGlwLT5vbGRfbWVtX2luZm8s
CisJCQkmY3J0Y19mbGlwLT5wZW5kaW5nX3ZhbHVlcywgc3luYykpIHsKKwkJV0FSTih0cnVlLCAi
U3luYyBjYWxsYmFjayBjYWxsZWQgd2l0aG91dCBjb21wbGV0aW5nIG9wZXJhdGlvbiIpOworCQly
ZXR1cm47CisJfQorCisJZnJlZV9mbGlwKGNydGNfZmxpcCk7CisKKwlpZiAoY2FsbF9mcm9tX3dv
cmspCisJCW11dGV4X2xvY2soJmdQVlJTUlZMb2NrKTsKKworCVBWUlNSVlNjaGVkdWxlRGV2aWNl
Q2FsbGJhY2tzKCk7CisKKwlpZiAoY2FsbF9mcm9tX3dvcmspCisJCW11dGV4X3VubG9jaygmZ1BW
UlNSVkxvY2spOworfQorCitzdGF0aWMgdm9pZCBjcnRjX2ZsaXBfY29tcGxldGUoc3RydWN0IGRy
bV9mbGlwICpmbGlwKQoreworCXN0cnVjdCBwZW5kaW5nX2ZsaXAgKmNydGNfZmxpcCA9CisJCWNv
bnRhaW5lcl9vZihmbGlwLCBzdHJ1Y3QgcGVuZGluZ19mbGlwLCBiYXNlKTsKKwlzdHJ1Y3QgZHJt
X2RldmljZSAqZGV2ID0gY3J0Y19mbGlwLT5jcnRjLT5kZXY7CisJaW50IHBpcGUgPSB0b19wc2Jf
aW50ZWxfY3J0YyhjcnRjX2ZsaXAtPmNydGMpLT5waXBlOworCisJc2VuZF9wYWdlX2ZsaXBfZXZl
bnQoZGV2LCBwaXBlLCBjcnRjX2ZsaXApOworCisJaWYgKGNydGNfZmxpcC0+dmJsYW5rX3JlZikK
KwkJZHJtX3ZibGFua19wdXQoZGV2LCBwaXBlKTsKKworCWF0b21pY19pbmMoJmNydGNfZmxpcC0+
cmVmY250KTsKKwljcnRjX2ZsaXAtPnBlbmRpbmdfc3luYy5jYWxsYmFjayA9IHBzYl9mbGlwX2Nv
bXBsZXRlX3N5bmNfY2FsbGJhY2s7CisJaWYgKHBzYl9mYl9pbmNyZWFzZV9yZWFkX29wc19jb21w
bGV0ZWQoY3J0Y19mbGlwLT5vbGRfbWVtX2luZm8sCisJCQkJJmNydGNfZmxpcC0+cGVuZGluZ192
YWx1ZXMsCisJCQkJJmNydGNfZmxpcC0+cGVuZGluZ19zeW5jKSkKKwkJcmV0dXJuOworCisJZnJl
ZV9mbGlwKGNydGNfZmxpcCk7CisJUFZSU1JWU2NoZWR1bGVEZXZpY2VDYWxsYmFja3MoKTsKK30K
Kworc3RhdGljIGNvbnN0IHN0cnVjdCBkcm1fZmxpcF9kcml2ZXJfZnVuY3MgcHNiX2ZsaXBfZHJp
dmVyX2Z1bmNzID0geworCS5mbHVzaCA9IHBzYl9mbGlwX2RyaXZlcl9mbHVzaCwKK307CisKK3Zv
aWQgcHNiX3BhZ2VfZmxpcF9pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpCit7CisJc3RydWN0
IGRybV9wc2JfcHJpdmF0ZSAqZGV2X3ByaXYgPSBkZXYtPmRldl9wcml2YXRlOworCisJZHJtX2Zs
aXBfZHJpdmVyX2luaXQoJmRldl9wcml2LT5mbGlwX2RyaXZlciwKKwkJCSAgICAgJnBzYl9mbGlw
X2RyaXZlcl9mdW5jcyk7Cit9CisKK3ZvaWQgcHNiX3BhZ2VfZmxpcF9maW5pKHN0cnVjdCBkcm1f
ZGV2aWNlICpkZXYpCit7CisJc3RydWN0IGRybV9wc2JfcHJpdmF0ZSAqZGV2X3ByaXYgPSBkZXYt
PmRldl9wcml2YXRlOworCisJZHJtX2ZsaXBfZHJpdmVyX2ZpbmkoJmRldl9wcml2LT5mbGlwX2Ry
aXZlcik7Cit9CisKK3N0YXRpYyBib29sIHZibF9jb3VudF9hZnRlcl9lcSh1MzIgYSwgdTMyIGIp
Cit7CisJcmV0dXJuICEoKGEgLSBiKSAmIDB4ODAwMDAwKTsKK30KKworc3RhdGljIGJvb2wgY3J0
Y19jaGVjayhzdHJ1Y3QgZHJtX2ZsaXAgKnBlbmRpbmdfZmxpcCwKKwkJICAgICAgIHUzMiB2Ymxf
Y291bnQpCit7CisJc3RydWN0IHBlbmRpbmdfZmxpcCAqY3J0Y19mbGlwID0KKwkJY29udGFpbmVy
X29mKHBlbmRpbmdfZmxpcCwgc3RydWN0IHBlbmRpbmdfZmxpcCwgYmFzZSk7CisKKwlyZXR1cm4g
dmJsX2NvdW50X2FmdGVyX2VxKHZibF9jb3VudCwgY3J0Y19mbGlwLT52YmxfY291bnQpOworfQor
CitzdGF0aWMgYm9vbCBjcnRjX2ZsaXAoc3RydWN0IGRybV9mbGlwICpmbGlwLAorCQkgICAgICBz
dHJ1Y3QgZHJtX2ZsaXAgKnBlbmRpbmdfZmxpcCkKK3sKKwlzdHJ1Y3QgcGVuZGluZ19mbGlwICpj
cnRjX2ZsaXAgPSBjb250YWluZXJfb2YoZmxpcCwgc3RydWN0IHBlbmRpbmdfZmxpcCwgYmFzZSk7
CisJc3RydWN0IGRybV9jcnRjICpjcnRjID0gY3J0Y19mbGlwLT5jcnRjOworCXN0cnVjdCBkcm1f
ZGV2aWNlICpkZXYgPSBjcnRjLT5kZXY7CisJc3RydWN0IGRybV9wc2JfcHJpdmF0ZSAqZGV2X3By
aXYgPSBkZXYtPmRldl9wcml2YXRlOworCWludCBwaXBlID0gdG9fcHNiX2ludGVsX2NydGMoY3J0
YyktPnBpcGU7CisJdTMyIHZibF9jb3VudDsKKworCWNydGNfZmxpcC0+dmJsYW5rX3JlZiA9IGRy
bV92YmxhbmtfZ2V0KGRldiwgcGlwZSkgPT0gMDsKKworCXZibF9jb3VudCA9IGdldF92YmxfY291
bnQoY3J0Yyk7CisKKwlpb3dyaXRlMzIoY3J0Y19mbGlwLT5vZmZzZXQsIGRldl9wcml2LT52ZGNf
cmVnICsgUFNCX0RTUFNVUkYocGlwZSkpOworCisJLyogVGhpcyBmbGlwIHdpbGwgaGFwcGVuIG9u
IHRoZSBuZXh0IHZibGFuayAqLworCWNydGNfZmxpcC0+dmJsX2NvdW50ID0gKHZibF9jb3VudCAr
IDEpICYgMHhmZmZmZmY7CisKKwlpZiAocGVuZGluZ19mbGlwKSB7CisJCXN0cnVjdCBwZW5kaW5n
X2ZsaXAgKm9sZF9jcnRjX2ZsaXAgPQorCQkJY29udGFpbmVyX29mKHBlbmRpbmdfZmxpcCwgc3Ry
dWN0IHBlbmRpbmdfZmxpcCwgYmFzZSk7CisJCWJvb2wgZmxpcHBlZCA9IGNydGNfY2hlY2socGVu
ZGluZ19mbGlwLCB2YmxfY291bnQpOworCisJCWlmICghZmxpcHBlZCkgeworCQkJc3dhcChjcnRj
X2ZsaXAtPm9sZF9tZW1faW5mbywgb2xkX2NydGNfZmxpcC0+b2xkX21lbV9pbmZvKTsKKwkJCXN3
YXAoY3J0Y19mbGlwLT5wZW5kaW5nX3ZhbHVlcywgb2xkX2NydGNfZmxpcC0+cGVuZGluZ192YWx1
ZXMpOworCQl9CisKKwkJcmV0dXJuIGZsaXBwZWQ7CisJfQorCisJcmV0dXJuIGZhbHNlOworfQor
CitzdGF0aWMgYm9vbCBjcnRjX3ZibGFuayhzdHJ1Y3QgZHJtX2ZsaXAgKnBlbmRpbmdfZmxpcCkK
K3sKKwlzdHJ1Y3QgcGVuZGluZ19mbGlwICpjcnRjX2ZsaXAgPQorCQljb250YWluZXJfb2YocGVu
ZGluZ19mbGlwLCBzdHJ1Y3QgcGVuZGluZ19mbGlwLCBiYXNlKTsKKwl1MzIgdmJsX2NvdW50ID0g
Z2V0X3ZibF9jb3VudChjcnRjX2ZsaXAtPmNydGMpOworCisJcmV0dXJuIGNydGNfY2hlY2socGVu
ZGluZ19mbGlwLCB2YmxfY291bnQpOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IGRybV9mbGlw
X2hlbHBlcl9mdW5jcyBjcnRjX2ZsaXBfZnVuY3MgPSB7CisJLmZsaXAgPSBjcnRjX2ZsaXAsCisJ
LnZibGFuayA9IGNydGNfdmJsYW5rLAorCS5jb21wbGV0ZSA9IGNydGNfZmxpcF9jb21wbGV0ZSwK
KwkuZmluaXNoID0gY3J0Y19mbGlwX2ZpbmlzaCwKKwkuY2xlYW51cCA9IGNydGNfZmxpcF9jbGVh
bnVwLAorfTsKKwordm9pZCBwc2JfcGFnZV9mbGlwX2NydGNfaW5pdChzdHJ1Y3QgcHNiX2ludGVs
X2NydGMgKnBzYl9pbnRlbF9jcnRjKQoreworCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBwc2Jf
aW50ZWxfY3J0Yy0+YmFzZS5kZXY7CisJc3RydWN0IGRybV9wc2JfcHJpdmF0ZSAqZGV2X3ByaXYg
PSBkZXYtPmRldl9wcml2YXRlOworCisJZHJtX2ZsaXBfaGVscGVyX2luaXQoJnBzYl9pbnRlbF9j
cnRjLT5mbGlwX2hlbHBlciwKKwkJCSAgICAgJmRldl9wcml2LT5mbGlwX2RyaXZlciwKKwkJCSAg
ICAgJmNydGNfZmxpcF9mdW5jcyk7Cit9CisKK3ZvaWQgcHNiX3BhZ2VfZmxpcF9jcnRjX2Zpbmko
c3RydWN0IHBzYl9pbnRlbF9jcnRjICpwc2JfaW50ZWxfY3J0YykKK3sKKwlkcm1fZmxpcF9oZWxw
ZXJfZmluaSgmcHNiX2ludGVsX2NydGMtPmZsaXBfaGVscGVyKTsKK30KKworc3RhdGljIHZvaWQK
K3BzYl9pbnRlbF9jcnRjX3Byb2Nlc3NfdmJsYW5rX3JlYWwoc3RydWN0IGRybV9jcnRjICpjcnRj
KQoreworCXN0cnVjdCBkcm1fcHNiX3ByaXZhdGUgKmRldl9wcml2ID0gY3J0Yy0+ZGV2LT5kZXZf
cHJpdmF0ZTsKKwlzdHJ1Y3QgcHNiX2ludGVsX2NydGMgKnBzYl9pbnRlbF9jcnRjID0gdG9fcHNi
X2ludGVsX2NydGMoY3J0Yyk7CisJaW50IHBpcGUgPSBwc2JfaW50ZWxfY3J0Yy0+cGlwZTsKKwlp
bnQgaTsKKworCXBzYl9pbnRlbF9jcnRjLT52YmxfcmVjZWl2ZWQgPSB0cnVlOworCXdha2VfdXAo
JnBzYl9pbnRlbF9jcnRjLT52Ymxfd2FpdCk7CisKKwlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0la
RShkZXZfcHJpdi0+b3ZlcmxheXMpOyBpKyspIHsKKwkJaWYgKCFkZXZfcHJpdi0+b3ZlcmxheXNb
aV0pCisJCQljb250aW51ZTsKKworCQltZGZsZF9vdmVybGF5X3Byb2Nlc3NfdmJsYW5rKGRldl9w
cml2LT5vdmVybGF5c1tpXSwgcGlwZSk7CisJfQorCisJZHJtX2ZsaXBfaGVscGVyX3ZibGFuaygm
cHNiX2ludGVsX2NydGMtPmZsaXBfaGVscGVyKTsKK30KKwordm9pZAorcHNiX2ludGVsX2NydGNf
cHJvY2Vzc192Ymxhbmsoc3RydWN0IGRybV9jcnRjICpjcnRjKQoreworCXN0cnVjdCBkcm1fcHNi
X3ByaXZhdGUgKmRldl9wcml2ID0gY3J0Yy0+ZGV2LT5kZXZfcHJpdmF0ZTsKKwlzdHJ1Y3QgcHNi
X2ludGVsX2NydGMgKnBzYl9pbnRlbF9jcnRjID0gdG9fcHNiX2ludGVsX2NydGMoY3J0Yyk7CisJ
aW50IHBpcGUgPSBwc2JfaW50ZWxfY3J0Yy0+cGlwZTsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAq
Y29ubmVjdG9yOworCXN0cnVjdCBkcm1fY3J0YyAqaGRtaWNydGMgPSBOVUxMOworCisJcHNiX2lu
dGVsX2NydGNfcHJvY2Vzc192YmxhbmtfcmVhbChjcnRjKTsKKworCS8qIFRoaXMgZm9sbG93aW5n
IGlzIHRvIGhhbmRsZSBIRE1JIHBlbmRpbmcgZmxpcHMgaWYgdW5wbHVnIHRoZSBjYWJsZQorCSAq
IEFmdGVyIEhETUkgaXMgdW5wbHVnZWQsIHRoZXJlIGlzIG5vIHZibGFuayBpbnRlcnJ1cHQgYW55
bW9yZS4KKwkgKiBCdXQgdGhlcmUgbWF5IGJlIHNvbWUgcGVuZGluZyBmbGlwcyBleGlzdHMgaW4g
cHNiX2ludGVsX2NydGMuCisJICogV2UgbmVlZCBjb21wbGV0IHRoZSBwZW5kaW5nIGZsaXBzLgor
CSAqIFRoaXMgY2FuIGJlIFJFVkVSVEVELCBpZiB0aGUgcGVuZGluZyBmbGlwIGlzc3VlIGZpeGVk
LgorCSAqLworCWlmIChwaXBlICE9IDApCisJCXJldHVybjsKKworCWhkbWljcnRjID0gZGV2X3By
aXYtPnBpcGVfdG9fY3J0Y19tYXBwaW5nWzFdOworCWlmICghaGRtaWNydGMpCisJCXJldHVybjsK
KworCWxpc3RfZm9yX2VhY2hfZW50cnkoY29ubmVjdG9yLAorCQkJJmNydGMtPmRldi0+bW9kZV9j
b25maWcuY29ubmVjdG9yX2xpc3QsIGhlYWQpIHsKKwkJaWYgKGNvbm5lY3Rvci0+Y29ubmVjdG9y
X3R5cGUgPT0gRFJNX01PREVfQ09OTkVDVE9SX0RWSUQgJiYKKwkJCWNvbm5lY3Rvci0+c3RhdHVz
ID09IGNvbm5lY3Rvcl9zdGF0dXNfZGlzY29ubmVjdGVkKSB7CisJCQlwc2JfaW50ZWxfY3J0Y19w
cm9jZXNzX3ZibGFua19yZWFsKGhkbWljcnRjKTsKKwkJCWJyZWFrOworCQl9CisJfQorfQorCitz
dGF0aWMgdm9pZAorc3luY19jYWxsYmFjayhzdHJ1Y3QgcHZyX3BlbmRpbmdfc3luYyAqcGVuZGlu
Z19zeW5jLCBib29sIGZyb21fbWlzcikKK3sKKwlzdHJ1Y3QgcGVuZGluZ19mbGlwICpwZW5kaW5n
X2ZsaXAgPQorCQljb250YWluZXJfb2YocGVuZGluZ19zeW5jLCBzdHJ1Y3QgcGVuZGluZ19mbGlw
LCBwZW5kaW5nX3N5bmMpOworCXN0cnVjdCBkcm1fY3J0YyogY3J0YyA9IHBlbmRpbmdfZmxpcC0+
Y3J0YzsKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gY3J0Yy0+ZGV2OworCXN0cnVjdCBkcm1f
cHNiX3ByaXZhdGUgKmRldl9wcml2ID0gZGV2LT5kZXZfcHJpdmF0ZTsKKwlzdHJ1Y3QgZHJtX2Zs
aXAgKmZsaXAsICpuZXh0OworCUxJU1RfSEVBRChmbGlwcyk7CisJYm9vbCBwaXBlX2VuYWJsZWQg
PSBmYWxzZTsKKworCWxpc3RfYWRkX3RhaWwoJnBlbmRpbmdfZmxpcC0+YmFzZS5saXN0LCAmZmxp
cHMpOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKGZsaXAsIG5leHQsICZwZW5kaW5nX2Zs
aXAtPmNvbXBhbmlvbnMsIGxpc3QpCisJCWxpc3RfbW92ZV90YWlsKCZmbGlwLT5saXN0LCAmZmxp
cHMpOworCisJV0FSTl9PTighbGlzdF9lbXB0eSgmcGVuZGluZ19mbGlwLT5jb21wYW5pb25zKSk7
CisKKwkvKiBwcmV2ZW50IERQTVMgYW5kIHdoYXRub3QgZnJvbSBzaG9vdGluZyB1cyBpbiB0aGUg
Zm9vdCAqLworCWlmIChmcm9tX21pc3IpCisJCW11dGV4X2xvY2soJmRldi0+bW9kZV9jb25maWcu
bXV0ZXgpOworCisJaWYgKG9zcG1fcG93ZXJfdXNpbmdfaHdfYmVnaW4oT1NQTV9ESVNQTEFZX0lT
TEFORCwgZmFsc2UpKSB7CisJCWludCBwaXBlID0gdG9fcHNiX2ludGVsX2NydGMoY3J0YyktPnBp
cGU7CisJCXUzMiB2YWw7CisKKwkJdmFsID0gaW9yZWFkMzIoZGV2X3ByaXYtPnZkY19yZWcgKyBQ
U0JfUElQRUNPTkYocGlwZSkpOworCisJCXBpcGVfZW5hYmxlZCA9IHZhbCAmIFBJUEVBQ09ORl9F
TkFCTEU7CisKKwkJaWYgKCFwaXBlX2VuYWJsZWQpCisJCQlvc3BtX3Bvd2VyX3VzaW5nX2h3X2Vu
ZChPU1BNX0RJU1BMQVlfSVNMQU5EKTsKKwl9CisKKwlpZiAocGlwZV9lbmFibGVkKSB7CisJCWRy
bV9mbGlwX2RyaXZlcl9wcmVwYXJlX2ZsaXBzKCZkZXZfcHJpdi0+ZmxpcF9kcml2ZXIsICZmbGlw
cyk7CisKKwkJLyogTWFrZSBzdXJlIHdlJ3JlIG5vdCBpbnRlcnJ1cHRlZCBkdXJpbmcgdGhlIGNy
aXRpY2FsIHBoYXNlICovCisJCWxvY2FsX2lycV9kaXNhYmxlKCk7CisKKwkJLyoKKwkJICogSWYg
d2UgY3Jvc3MgaW50byB2Ymxhbmsgd2hpbGUgcHJvZ3JhbW1pbmcgdGhlIGZsaXBzLCB3ZQorCQkg
KiBjYW4ndCBkZXRlcm1pbmUgd2hpY2ggZmxpcHMgaGF2ZSBjb21wbGV0ZWQuIEFsc28gd2hlbgor
CQkgKiB0cnlpbmcgdG8gc3luY2hyb25pemUgbXVsdGlwbGUgZmxpcHMsIHdlIGNhbid0IGJlIHN1
cmUKKwkJICogdGhhdCBhbGwgZmxpcHMgd2lsbCBoYXBwZW4gb24gdGhlIHNhbWUgdmJsYW5rLiBT
bywgaWYKKwkJICogd2UncmUgY2xvc2UgdG8gdGhlIHN0YXJ0IG9mIHZibGFuaywgd2FpdCB1bnRp
bCB3ZSdyZQorCQkgKiBzYWZlbHkgcGFzdCBpdCBiZWZvcmUgcHJvY2VlZGluZyBhbnkgZnVydGhl
ci4KKwkJICovCisJCWF2b2lkX2Rhbmdlcl96b25lKGNydGMpOworCisJCWRybV9mbGlwX2RyaXZl
cl9zY2hlZHVsZV9mbGlwcygmZGV2X3ByaXYtPmZsaXBfZHJpdmVyLCAmZmxpcHMpOworCisJCWxv
Y2FsX2lycV9lbmFibGUoKTsKKworCQlvc3BtX3Bvd2VyX3VzaW5nX2h3X2VuZChPU1BNX0RJU1BM
QVlfSVNMQU5EKTsKKwl9IGVsc2UKKwkJLyogcG93ZXJlZCBvZmYsIGp1c3QgY29tcGxldGUgYWxs
IHBlbmRpbmcgYW5kIG5ldyBmbGlwcyAqLworCQlkcm1fZmxpcF9kcml2ZXJfY29tcGxldGVfZmxp
cHMoJmRldl9wcml2LT5mbGlwX2RyaXZlciwgJmZsaXBzKTsKKworCWlmIChmcm9tX21pc3IpCisJ
CW11dGV4X3VubG9jaygmZGV2LT5tb2RlX2NvbmZpZy5tdXRleCk7Cit9CisKK2ludAorcHNiX2lu
dGVsX2NydGNfcGFnZV9mbGlwKHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKKyAgICAgICAgICAgICAg
ICAgICAgICAgICBzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYiwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICBzdHJ1Y3QgZHJtX3BlbmRpbmdfdmJsYW5rX2V2ZW50ICpldmVudCkKK3sKKwlzdHJ1
Y3QgZHJtX2RldmljZSAqZGV2ID0gY3J0Yy0+ZGV2OworCXN0cnVjdCBkcm1fcHNiX3ByaXZhdGUg
KmRldl9wcml2ID0gZGV2LT5kZXZfcHJpdmF0ZTsKKwlzdHJ1Y3QgcHNiX2ZyYW1lYnVmZmVyICpw
c2JmYiA9IHRvX3BzYl9mYihmYik7CisJUFZSU1JWX0tFUk5FTF9NRU1fSU5GTyAqY3VycmVudF9m
Yl9tZW1faW5mbzsKKwlzdHJ1Y3QgcGVuZGluZ19mbGlwICpuZXdfcGVuZGluZ19mbGlwOworCXN0
cnVjdCBwc2JfZnByaXYgKnByaXY7CisJc3RydWN0IHBzYl9mYmRldiAqZmJkZXYgPSBOVUxMOwor
CXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisJdTMyIHRnaWQgPSBwc2JfZ2V0X3RnaWQoKTsKKwlpbnQg
cmV0OworCWludCBwaXBlID0gdG9fcHNiX2ludGVsX2NydGMoY3J0YyktPnBpcGU7CisJaW50IGk7
CisKKwlpZiAoIXBzYmZiLT5wdnJCTykKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwluZXdfcGVuZGlu
Z19mbGlwID0ga3phbGxvYyhzaXplb2YgKm5ld19wZW5kaW5nX2ZsaXAsIEdGUF9LRVJORUwpOwor
CWlmICghbmV3X3BlbmRpbmdfZmxpcCkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwkvKiBrZWVwIGEg
cmVmZXJlbmNlIHRvIHRoZSBuZXcgZmIsIHVudGlsIGl0J3Mgbm8gbG9uZ2VyIHNjYW5uZWQgb3V0
LiAqLworCXJldCA9IHBzYl9mYl9ndHRfcmVmKGRldiwgcHNiZmItPnB2ckJPKTsKKwlpZiAocmV0
KSB7CisJCWtmcmVlKG5ld19wZW5kaW5nX2ZsaXApOworCQlyZXR1cm4gcmV0OworCX0KKworCWN1
cnJlbnRfZmJfbWVtX2luZm8gPSB0b19wc2JfZmIoY3J0Yy0+ZmIpLT5wdnJCTzsKKworCS8qIGtl
ZXAgYSByZWZlcmVuY2UgdG8gdGhlIG9sZCBmYiwgZm9yIHJlYWQgb3BzIG1hbmlwdWxhdGlvbnMg
Ki8KKwlyZXQgPSBwc2JfZmJfcmVmKGN1cnJlbnRfZmJfbWVtX2luZm8pOworCWlmIChyZXQpIHsK
KwkJcHNiX2ZiX2d0dF91bnJlZihkZXYsIHBzYmZiLT5wdnJCTywgdGdpZCk7CisJCWtmcmVlKG5l
d19wZW5kaW5nX2ZsaXApOworCQlyZXR1cm4gcmV0OworCX0KKworCWRybV9mbGlwX2luaXQoJm5l
d19wZW5kaW5nX2ZsaXAtPmJhc2UsICZ0b19wc2JfaW50ZWxfY3J0YyhjcnRjKS0+ZmxpcF9oZWxw
ZXIpOworCisJYXRvbWljX3NldCgmbmV3X3BlbmRpbmdfZmxpcC0+cmVmY250LCAxKTsKKwluZXdf
cGVuZGluZ19mbGlwLT5jcnRjID0gY3J0YzsKKwluZXdfcGVuZGluZ19mbGlwLT5ldmVudCA9IGV2
ZW50OworCW5ld19wZW5kaW5nX2ZsaXAtPm9mZnNldCA9IHBzYmZiLT5vZmZzZXQ7CisKKwlpZiAo
ZXZlbnQpIHsKKwkJc3Bpbl9sb2NrX2lycXNhdmUoJmNydGMtPmRldi0+ZXZlbnRfbG9jaywgZmxh
Z3MpOworCQlwcml2ID0gcHNiX2Zwcml2KGV2ZW50LT5iYXNlLmZpbGVfcHJpdik7CisJCWxpc3Rf
YWRkKCZuZXdfcGVuZGluZ19mbGlwLT51bmNvbXBsZXRlZCwgJnByaXYtPnBlbmRpbmdfZmxpcHMp
OworCQlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZjcnRjLT5kZXYtPmV2ZW50X2xvY2ssIGZsYWdz
KTsKKwl9IGVsc2UgeworCQlJTklUX0xJU1RfSEVBRCgmbmV3X3BlbmRpbmdfZmxpcC0+dW5jb21w
bGV0ZWQpOworCX0KKworCS8qIEluIHBhZ2UgZmxpcCwgY2hhbmdlIHRoZSBwc2JfZmJfaGVscGVy
LmZiCisJICogYW5kIGZiZGV2IHRvIHRoZSBzd2FwcGVkIGZiLgorCSAqLworCWlmIChkZXYtPmRl
dl9wcml2YXRlKQorCQlmYmRldiA9ICgoc3RydWN0IGRybV9wc2JfcHJpdmF0ZSAqKWRldi0+ZGV2
X3ByaXZhdGUpLT5mYmRldjsKKwlpZiAoZmJkZXYpIHsKKwkJZmJkZXYtPnBzYl9mYl9oZWxwZXIu
ZmIgPSBmYjsKKwkJZmJkZXYtPnBzYl9mYl9oZWxwZXIuZmJkZXYgPSBwc2JmYi0+ZmJkZXY7CisJ
fSBlbHNlCisJCXByaW50ayhLRVJOX0FMRVJUICIlcyBjYW5ub3QgZmluZCB0aGUgZmJcbiIsIF9f
ZnVuY19fKTsKKworCWNydGMtPmZiID0gZmI7CisKKwluZXdfcGVuZGluZ19mbGlwLT5tZW1faW5m
byA9IHBzYmZiLT5wdnJCTzsKKwluZXdfcGVuZGluZ19mbGlwLT5vbGRfbWVtX2luZm8gPSBjdXJy
ZW50X2ZiX21lbV9pbmZvOworCisJcHNiX2ZiX2luY3JlYXNlX3JlYWRfb3BzX3BlbmRpbmcoY3Vy
cmVudF9mYl9tZW1faW5mbywKKwkJCSZuZXdfcGVuZGluZ19mbGlwLT5wZW5kaW5nX3ZhbHVlcyk7
CisJcHNiX2ZiX2ZsaXBfdHJhY2UoY3VycmVudF9mYl9tZW1faW5mbywgcHNiZmItPnB2ckJPKTsK
KworCW5ld19wZW5kaW5nX2ZsaXAtPnRnaWQgPSB0Z2lkOworCisJSU5JVF9MSVNUX0hFQUQoJm5l
d19wZW5kaW5nX2ZsaXAtPmNvbXBhbmlvbnMpOworCisJZm9yIChpID0gMDsgaSA8IEFSUkFZX1NJ
WkUoZGV2X3ByaXYtPm92ZXJsYXlzKTsgaSsrKSB7CisJCXN0cnVjdCBkcm1fZmxpcCAqZmxpcDsK
KworCQlpZiAoIWRldl9wcml2LT5vdmVybGF5c1tpXSkKKwkJCWNvbnRpbnVlOworCisJCWZsaXAg
PSBtZGZsZF9vdmVybGF5X2F0b21pY19mbGlwKGRldl9wcml2LT5vdmVybGF5c1tpXSwgcGlwZSk7
CisJCWlmICghZmxpcCkKKwkJCWNvbnRpbnVlOworCisJCWxpc3RfYWRkX3RhaWwoJmZsaXAtPmxp
c3QsICZuZXdfcGVuZGluZ19mbGlwLT5jb21wYW5pb25zKTsKKwl9CisKKwlQVlJTUlZDYWxsYmFj
a09uU3luYyhwc2JmYi0+cHZyQk8tPnBzS2VybmVsU3luY0luZm8sCisJCQkgICAgIFBWUlNSVl9T
WU5DX1dSSVRFLCBzeW5jX2NhbGxiYWNrLAorCQkJICAgICAmbmV3X3BlbmRpbmdfZmxpcC0+cGVu
ZGluZ19zeW5jKTsKKworCXJldHVybiAwOworfQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2dtYTUwMC9wc2JfcGFnZV9mbGlwLmggYi9kcml2ZXJzL2dwdS9kcm0vZ21hNTAwL3BzYl9wYWdl
X2ZsaXAuaApuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMDAwMDAuLjYwNjcxMjAx
ZDJjOAotLS0gL2Rldi9udWxsCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9nbWE1MDAvcHNiX3BhZ2Vf
ZmxpcC5oCkBAIC0wLDAgKzEsMzggQEAKKy8qCisgKiBDb3B5cmlnaHQgKGMpIDIwMTEsIEludGVs
IENvcnBvcmF0aW9uLgorICoKKyAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOyB5b3Ug
Y2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5IGl0CisgKiB1bmRlciB0aGUgdGVybXMg
YW5kIGNvbmRpdGlvbnMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlLAorICogdmVy
c2lvbiAyLCBhcyBwdWJsaXNoZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbi4KKyAq
CisgKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgaXQgd2lsbCBiZSB1
c2VmdWwsIGJ1dCBXSVRIT1VUCisgKiBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1w
bGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IKKyAqIEZJVE5FU1MgRk9SIEEgUEFS
VElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IK
KyAqIG1vcmUgZGV0YWlscy4KKyAqCisgKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5
IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoCisgKiB0aGlzIHBy
b2dyYW07IGlmIG5vdCwgd3JpdGUgdG8gdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgSW5j
LizCtworICogNTEgRnJhbmtsaW4gU3QgLSBGaWZ0aCBGbG9vciwgQm9zdG9uLCBNQSAwMjExMC0x
MzAxIFVTQS4KKyAqCisgKiBBdXRob3JzOgorICogQW5kZXIgQ29uc2VsdmFuIGRlIE9saXZlaXJh
IDxhbmRlci5jb25zZWx2YW4uZGUub2xpdmVpcmFAaW50ZWwuY29tPgorICoKKyAqLworCisjaWZu
ZGVmIF9QU0JfUEFHRV9GTElQX0hfCisjZGVmaW5lIF9QU0JfUEFHRV9GTElQX0hfCisKK3ZvaWQg
cHNiX3BhZ2VfZmxpcF9pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpOwordm9pZCBwc2JfcGFn
ZV9mbGlwX2Zpbmkoc3RydWN0IGRybV9kZXZpY2UgKmRldik7CisKK3ZvaWQgcHNiX3BhZ2VfZmxp
cF9jcnRjX2luaXQoc3RydWN0IHBzYl9pbnRlbF9jcnRjICpwc2JfaW50ZWxfY3J0Yyk7Cit2b2lk
IHBzYl9wYWdlX2ZsaXBfY3J0Y19maW5pKHN0cnVjdCBwc2JfaW50ZWxfY3J0YyAqcHNiX2ludGVs
X2NydGMpOworCit2b2lkIHBzYl9pbnRlbF9jcnRjX3Byb2Nlc3NfdmJsYW5rKHN0cnVjdCBkcm1f
Y3J0YyAqY3J0Yyk7CitpbnQgcHNiX2ludGVsX2NydGNfcGFnZV9mbGlwKHN0cnVjdCBkcm1fY3J0
YyAqY3J0YywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0IGRybV9mcmFtZWJ1
ZmZlciAqZmIsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBkcm1fcGVuZGlu
Z192YmxhbmtfZXZlbnQgKmV2ZW50KTsKK3ZvaWQgcHNiX2NsZWFudXBfcGVuZGluZ19ldmVudHMo
c3RydWN0IGRybV9kZXZpY2UgKmRldiwKKwkJCQlzdHJ1Y3QgcHNiX2Zwcml2ICpwcml2KTsKKwor
I2VuZGlmIC8qIF9QU0JfUEFHRV9GTElQX0hfICovCi0tIAoyLjIwLjEKCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QK
ZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9w
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
