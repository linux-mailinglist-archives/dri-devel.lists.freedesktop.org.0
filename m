Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 435AEA3172
	for <lists+dri-devel@lfdr.de>; Fri, 30 Aug 2019 09:46:24 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E39506E28C;
	Fri, 30 Aug 2019 07:46:21 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mailgw02.mediatek.com (unknown [210.61.82.184])
 by gabe.freedesktop.org (Postfix) with ESMTP id 0D6456E28A
 for <dri-devel@lists.freedesktop.org>; Fri, 30 Aug 2019 07:46:11 +0000 (UTC)
X-UUID: 6ccb015f63c64ca2bab7f85891492ba6-20190830
X-UUID: 6ccb015f63c64ca2bab7f85891492ba6-20190830
Received: from mtkmrs01.mediatek.inc [(172.21.131.159)] by
 mailgw02.mediatek.com (envelope-from <bibby.hsieh@mediatek.com>)
 (Cellopoint E-mail Firewall v4.1.10 Build 0809 with TLS)
 with ESMTP id 921805097; Fri, 30 Aug 2019 15:41:07 +0800
Received: from mtkcas08.mediatek.inc (172.21.101.126) by
 mtkmbs01n1.mediatek.inc (172.21.101.68) with Microsoft SMTP Server (TLS) id
 15.0.1395.4; Fri, 30 Aug 2019 15:41:10 +0800
Received: from mtksdccf07.mediatek.inc (172.21.84.99) by mtkcas08.mediatek.inc
 (172.21.101.73) with Microsoft SMTP Server id 15.0.1395.4 via
 Frontend Transport; Fri, 30 Aug 2019 15:41:10 +0800
From: Bibby Hsieh <bibby.hsieh@mediatek.com>
To: David Airlie <airlied@linux.ie>, Matthias Brugger
 <matthias.bgg@gmail.com>, Daniel Vetter <daniel.vetter@ffwll.ch>,
 <dri-devel@lists.freedesktop.org>, <linux-mediatek@lists.infradead.org>
Subject: [PATCH 2/2] drm/mediatek: Apply CMDQ control flow
Date: Fri, 30 Aug 2019 15:41:03 +0800
Message-ID: <20190830074103.16671-3-bibby.hsieh@mediatek.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20190830074103.16671-1-bibby.hsieh@mediatek.com>
References: <20190830074103.16671-1-bibby.hsieh@mediatek.com>
MIME-Version: 1.0
X-MTK: N
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: drinkcat@chromium.org, Yongqiang Niu <yongqiang.niu@mediatek.com>,
 linux-kernel@vger.kernel.org, tfiga@chromium.org,
 Thierry Reding <thierry.reding@gmail.com>,
 linux-arm-kernel@lists.infradead.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VW5saWtlIG90aGVyIFNvQ3MsIE1UODE4MyBkb2VzIG5vdCBoYXZlICJzaGFkb3ciCnJlZ2lzdGVy
cyBmb3IgcGVyZm9ybWFpbmcgYW4gYXRvbWljIHZpZGVvIG1vZGUKc2V0IG9yIHBhZ2UgZmxpcCBh
dCB2YmxhbmsvdnN5bmMuCgpUaGUgQ01EUSAoQ29tbWVuZCBRdWV1ZSkgaW4gTVQ4MTgzIGlzIHVz
ZWQgdG8gaGVscAp1cGRhdGUgYWxsIHJlbGV2YW50IGRpc3BsYXkgY29udHJvbGxlciByZWdpc3Rl
cnMKd2l0aCBjcml0aWNhbCB0aW1lIGxpbWF0aW9uLgoKU2lnbmVkLW9mZi1ieTogWVQgU2hlbiA8
eXQuc2hlbkBtZWRpYXRlay5jb20+ClNpZ25lZC1vZmYtYnk6IENLIEh1IDxjay5odUBtZWRpYXRl
ay5jb20+ClNpZ25lZC1vZmYtYnk6IFBoaWxpcHAgWmFiZWwgPHAuemFiZWxAcGVuZ3V0cm9uaXgu
ZGU+ClNpZ25lZC1vZmYtYnk6IEJpYmJ5IEhzaWVoIDxiaWJieS5oc2llaEBtZWRpYXRlay5jb20+
ClNpZ25lZC1vZmYtYnk6IFlvbmdxaWFuZyBOaXUgPHlvbmdxaWFuZy5uaXVAbWVkaWF0ZWsuY29t
PgotLS0KIGRyaXZlcnMvZ3B1L2RybS9tZWRpYXRlay9tdGtfZHJtX2NydGMuYyAgICAgfCAxOTAg
KysrKysrKysrKysrKysrKystLS0KIGRyaXZlcnMvZ3B1L2RybS9tZWRpYXRlay9tdGtfZHJtX2Ny
dGMuaCAgICAgfCAgIDIgKwogZHJpdmVycy9ncHUvZHJtL21lZGlhdGVrL210a19kcm1fZGRwX2Nv
bXAuYyB8ICAzNCArKysrCiBkcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kZHBfY29t
cC5oIHwgICAyICsKIGRyaXZlcnMvZ3B1L2RybS9tZWRpYXRlay9tdGtfZHJtX3BsYW5lLmMgICAg
fCAgIDQgKwogNSBmaWxlcyBjaGFuZ2VkLCAyMDYgaW5zZXJ0aW9ucygrKSwgMjYgZGVsZXRpb25z
KC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL21lZGlhdGVrL210a19kcm1fY3J0Yy5j
IGIvZHJpdmVycy9ncHUvZHJtL21lZGlhdGVrL210a19kcm1fY3J0Yy5jCmluZGV4IDA5MmU1MDJl
ZDI3Yi4uMzI5Y2E1YTE0YzM5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsv
bXRrX2RybV9jcnRjLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL21lZGlhdGVrL210a19kcm1fY3J0
Yy5jCkBAIC0xMCw3ICsxMCw5IEBACiAjaW5jbHVkZSA8ZHJtL2RybV9wbGFuZV9oZWxwZXIuaD4K
ICNpbmNsdWRlIDxkcm0vZHJtX3Byb2JlX2hlbHBlci5oPgogI2luY2x1ZGUgPGxpbnV4L2Nsay5o
PgorI2luY2x1ZGUgPGxpbnV4L29mX2FkZHJlc3MuaD4KICNpbmNsdWRlIDxsaW51eC9wbV9ydW50
aW1lLmg+CisjaW5jbHVkZSA8bGludXgvc29jL21lZGlhdGVrL210ay1jbWRxLmg+CiAKICNpbmNs
dWRlICJtdGtfZHJtX2Rydi5oIgogI2luY2x1ZGUgIm10a19kcm1fY3J0Yy5oIgpAQCAtNDEsNiAr
NDMsMTAgQEAgc3RydWN0IG10a19kcm1fY3J0YyB7CiAJdW5zaWduZWQgaW50CQkJbGF5ZXJfbnI7
CiAJYm9vbAkJCQlwZW5kaW5nX3BsYW5lczsKIAlib29sICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGN1cnNvcl91cGRhdGU7CisKKwlzdHJ1Y3QgY21kcV9jbGllbnQJCSpjbWRxX2NsaWVudDsK
Kwl1MzIJCQkJY21kcV9ldmVudDsKKwogCXZvaWQgX19pb21lbQkJCSpjb25maWdfcmVnczsKIAlj
b25zdCBzdHJ1Y3QgbXRrX21tc3lzX3JlZ19kYXRhICptbXN5c19yZWdfZGF0YTsKIAlzdHJ1Y3Qg
bXRrX2Rpc3BfbXV0ZXgJCSptdXRleDsKQEAgLTU3LDYgKzYzLDEyIEBAIHN0cnVjdCBtdGtfY3J0
Y19zdGF0ZSB7CiAJdW5zaWduZWQgaW50CQkJcGVuZGluZ193aWR0aDsKIAl1bnNpZ25lZCBpbnQJ
CQlwZW5kaW5nX2hlaWdodDsKIAl1bnNpZ25lZCBpbnQJCQlwZW5kaW5nX3ZyZWZyZXNoOworCXN0
cnVjdCBjbWRxX3BrdAkJCSpjbWRxX2hhbmRsZTsKK307CisKK3N0cnVjdCBtdGtfY21kcV9jYl9k
YXRhIHsKKwlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUJCSpzdGF0ZTsKKwlzdHJ1Y3QgY21kcV9wa3QJ
CQkqY21kcV9oYW5kbGU7CiB9OwogCiBzdGF0aWMgaW5saW5lIHN0cnVjdCBtdGtfZHJtX2NydGMg
KnRvX210a19jcnRjKHN0cnVjdCBkcm1fY3J0YyAqYykKQEAgLTIwOCw2ICsyMjAsNDYgQEAgc3Rh
dGljIHZvaWQgbXRrX2NydGNfZGRwX2Nsa19kaXNhYmxlKHN0cnVjdCBtdGtfZHJtX2NydGMgKm10
a19jcnRjKQogCQljbGtfZGlzYWJsZV91bnByZXBhcmUobXRrX2NydGMtPmRkcF9jb21wW2ldLT5j
bGspOwogfQogCitzdGF0aWMgdm9pZCBkZHBfY21kcV9jdXJzb3JfY2Ioc3RydWN0IGNtZHFfY2Jf
ZGF0YSBkYXRhKQoreworCisjaWYgSVNfRU5BQkxFRChDT05GSUdfTVRLX0NNRFEpCisJc3RydWN0
IG10a19jbWRxX2NiX2RhdGEgKmNiX2RhdGEgPSBkYXRhLmRhdGE7CisKKwlEUk1fREVCVUdfRFJJ
VkVSKCIlc1xuIiwgX19mdW5jX18pOworCisJY21kcV9wa3RfZGVzdHJveShjYl9kYXRhLT5jbWRx
X2hhbmRsZSk7CisJa2ZyZWUoY2JfZGF0YSk7CisjZW5kaWYKKworfQorCitzdGF0aWMgdm9pZCBk
ZHBfY21kcV9jYihzdHJ1Y3QgY21kcV9jYl9kYXRhIGRhdGEpCit7CisKKyNpZiBJU19FTkFCTEVE
KENPTkZJR19NVEtfQ01EUSkKKwlzdHJ1Y3QgbXRrX2NtZHFfY2JfZGF0YSAqY2JfZGF0YSA9IGRh
dGEuZGF0YTsKKwlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUgKmNydGNfc3RhdGUgPSBjYl9kYXRhLT5z
dGF0ZTsKKwlzdHJ1Y3QgZHJtX2F0b21pY19zdGF0ZSAqYXRvbWljX3N0YXRlID0gY3J0Y19zdGF0
ZS0+c3RhdGU7CisJc3RydWN0IGRybV9jcnRjICpjcnRjID0gY3J0Y19zdGF0ZS0+Y3J0YzsKKwlz
dHJ1Y3QgbXRrX2RybV9jcnRjICptdGtfY3J0YyA9IHRvX210a19jcnRjKGNydGMpOworCisJRFJN
X0RFQlVHX0RSSVZFUigiJXNcbiIsIF9fZnVuY19fKTsKKworCWlmIChtdGtfY3J0Yy0+cGVuZGlu
Z19uZWVkc192YmxhbmspIHsKKwkJLyogY21kcV92YmxhbmtfZXZlbnQgbXVzdCBiZSByZWFkIGFm
dGVyIGNtZHFfbmVlZHNfZXZlbnQgKi8KKwkJc21wX3JtYigpOworCisJCW10a19kcm1fY3J0Y19m
aW5pc2hfcGFnZV9mbGlwKG10a19jcnRjKTsKKwkJbXRrX2NydGMtPnBlbmRpbmdfbmVlZHNfdmJs
YW5rID0gZmFsc2U7CisJfQorCW10a19hdG9taWNfc3RhdGVfcHV0X3F1ZXVlKGF0b21pY19zdGF0
ZSk7CisJY21kcV9wa3RfZGVzdHJveShjYl9kYXRhLT5jbWRxX2hhbmRsZSk7CisJa2ZyZWUoY2Jf
ZGF0YSk7CisjZW5kaWYKKworfQorCiBzdGF0aWMgaW50IG10a19jcnRjX2RkcF9od19pbml0KHN0
cnVjdCBtdGtfZHJtX2NydGMgKm10a19jcnRjKQogewogCXN0cnVjdCBkcm1fY3J0YyAqY3J0YyA9
ICZtdGtfY3J0Yy0+YmFzZTsKQEAgLTI4Myw3ICszMzUsOCBAQCBzdGF0aWMgaW50IG10a19jcnRj
X2RkcF9od19pbml0KHN0cnVjdCBtdGtfZHJtX2NydGMgKm10a19jcnRjKQogCQlpZiAocHJldiA9
PSBERFBfQ09NUE9ORU5UX09WTDApCiAJCQltdGtfZGRwX2NvbXBfYmdjbHJfaW5fb24oY29tcCk7
CiAKLQkJbXRrX2RkcF9jb21wX2NvbmZpZyhjb21wLCB3aWR0aCwgaGVpZ2h0LCB2cmVmcmVzaCwg
YnBjKTsKKwkJbXRrX2RkcF9jb21wX2NvbmZpZyhjb21wLCB3aWR0aCwgaGVpZ2h0LAorCQkJCSAg
ICB2cmVmcmVzaCwgYnBjLCBOVUxMKTsKIAkJbXRrX2RkcF9jb21wX3N0YXJ0KGNvbXApOwogCX0K
IApAQCAtMzAzLDcgKzM1Niw3IEBAIHN0YXRpYyBpbnQgbXRrX2NydGNfZGRwX2h3X2luaXQoc3Ry
dWN0IG10a19kcm1fY3J0YyAqbXRrX2NydGMpCiAJCX0gZWxzZQogCQkJbG9jYWxfbGF5ZXIgPSBp
OwogCQltdGtfZGRwX2NvbXBfbGF5ZXJfY29uZmlnKGNvbXAsIGxvY2FsX2xheWVyLAotCQkJCQkg
IHBsYW5lX3N0YXRlKTsKKwkJCQkJICBwbGFuZV9zdGF0ZSwgTlVMTCk7CiAJfQogCiAJcmV0dXJu
IDA7CkBAIC0zNjEsNyArNDE0LDcgQEAgc3RhdGljIHZvaWQgbXRrX2NydGNfZGRwX2NvbmZpZyhz
dHJ1Y3QgZHJtX2NydGMgKmNydGMpCiAJaWYgKHN0YXRlLT5wZW5kaW5nX2NvbmZpZykgewogCQlt
dGtfZGRwX2NvbXBfY29uZmlnKGNvbXAsIHN0YXRlLT5wZW5kaW5nX3dpZHRoLAogCQkJCSAgICBz
dGF0ZS0+cGVuZGluZ19oZWlnaHQsCi0JCQkJICAgIHN0YXRlLT5wZW5kaW5nX3ZyZWZyZXNoLCAw
KTsKKwkJCQkgICAgc3RhdGUtPnBlbmRpbmdfdnJlZnJlc2gsIDAsIE5VTEwpOwogCiAJCXN0YXRl
LT5wZW5kaW5nX2NvbmZpZyA9IGZhbHNlOwogCX0KQEAgLTM4MSw3ICs0MzQsNyBAQCBzdGF0aWMg
dm9pZCBtdGtfY3J0Y19kZHBfY29uZmlnKHN0cnVjdCBkcm1fY3J0YyAqY3J0YykKIAkJCQkJbG9j
YWxfbGF5ZXIgPSBpOwogCiAJCQkJbXRrX2RkcF9jb21wX2xheWVyX2NvbmZpZyhjb21wLCBsb2Nh
bF9sYXllciwKLQkJCQkJCQkgIHBsYW5lX3N0YXRlKTsKKwkJCQkJCQkgIHBsYW5lX3N0YXRlLCBO
VUxMKTsKIAkJCQlwbGFuZV9zdGF0ZS0+cGVuZGluZy5jb25maWcgPSBmYWxzZTsKIAkJCX0KIAkJ
fQpAQCAtNDA1LDI2ICs0NTgsNjkgQEAgdm9pZCBtdGtfZHJtX2NydGNfY3Vyc29yX3VwZGF0ZShz
dHJ1Y3QgZHJtX2NydGMgKmNydGMsIHN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lLAogCQlyZXR1cm47
CiAKIAltdXRleF9sb2NrKCZwcml2LT5od19sb2NrKTsKLQlwbGFuZV9oZWxwZXJfZnVuY3MtPmF0
b21pY191cGRhdGUocGxhbmUsIHBsYW5lX3N0YXRlKTsKLQlmb3IgKGkgPSAwOyBpIDwgbXRrX2Ny
dGMtPmxheWVyX25yOyBpKyspIHsKLQkJc3RydWN0IGRybV9wbGFuZSAqcGxhbmUgPSAmbXRrX2Ny
dGMtPnBsYW5lc1tpXTsKLQkJc3RydWN0IG10a19wbGFuZV9zdGF0ZSAqcGxhbmVfc3RhdGU7CisJ
aWYgKElTX0VOQUJMRUQoQ09ORklHX01US19DTURRKSAmJiBtdGtfY3J0Yy0+Y21kcV9jbGllbnQp
IHsKKwkJc3RydWN0IG10a19jcnRjX3N0YXRlICptdGtfY3J0Y19zdGF0ZSA9CisJCQkJdG9fbXRr
X2NydGNfc3RhdGUoY3J0Yy0+c3RhdGUpOworCQlzdHJ1Y3QgbXRrX2NtZHFfY2JfZGF0YSAqY2Jf
ZGF0YTsKKworCQltdGtfY3J0Y19zdGF0ZS0+Y21kcV9oYW5kbGUgPQorCQkJCWNtZHFfcGt0X2Ny
ZWF0ZShtdGtfY3J0Yy0+Y21kcV9jbGllbnQsCisJCQkJCQlQQUdFX1NJWkUpOworCQljbWRxX3Br
dF9jbGVhcl9ldmVudChtdGtfY3J0Y19zdGF0ZS0+Y21kcV9oYW5kbGUsCisJCQkJICAgICBtdGtf
Y3J0Yy0+Y21kcV9ldmVudCk7CisJCWNtZHFfcGt0X3dmZShtdGtfY3J0Y19zdGF0ZS0+Y21kcV9o
YW5kbGUsIG10a19jcnRjLT5jbWRxX2V2ZW50KTsKKwkJcGxhbmVfaGVscGVyX2Z1bmNzLT5hdG9t
aWNfdXBkYXRlKHBsYW5lLCBwbGFuZV9zdGF0ZSk7CisJCWNiX2RhdGEgPSBrbWFsbG9jKHNpemVv
ZigqY2JfZGF0YSksIEdGUF9LRVJORUwpOworCQljYl9kYXRhLT5jbWRxX2hhbmRsZSA9IG10a19j
cnRjX3N0YXRlLT5jbWRxX2hhbmRsZTsKKwkJY21kcV9wa3RfZmx1c2hfYXN5bmMobXRrX2NydGNf
c3RhdGUtPmNtZHFfaGFuZGxlLAorCQkJCSAgICAgZGRwX2NtZHFfY3Vyc29yX2NiLCBjYl9kYXRh
KTsKKwl9IGVsc2UgeworCQlwbGFuZV9oZWxwZXJfZnVuY3MtPmF0b21pY191cGRhdGUocGxhbmUs
IHBsYW5lX3N0YXRlKTsKIAotCQlwbGFuZV9zdGF0ZSA9IHRvX210a19wbGFuZV9zdGF0ZShwbGFu
ZS0+c3RhdGUpOwotCQlpZiAocGxhbmVfc3RhdGUtPnBlbmRpbmcuZGlydHkpIHsKLQkJCXBsYW5l
X3N0YXRlLT5wZW5kaW5nLmNvbmZpZyA9IHRydWU7Ci0JCQlwbGFuZV9zdGF0ZS0+cGVuZGluZy5k
aXJ0eSA9IGZhbHNlOworCQlmb3IgKGkgPSAwOyBpIDwgbXRrX2NydGMtPmxheWVyX25yOyBpKysp
IHsKKwkJCXN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lID0gJm10a19jcnRjLT5wbGFuZXNbaV07CisJ
CQlzdHJ1Y3QgbXRrX3BsYW5lX3N0YXRlICpwbGFuZV9zdGF0ZTsKKworCQkJcGxhbmVfc3RhdGUg
PSB0b19tdGtfcGxhbmVfc3RhdGUocGxhbmUtPnN0YXRlKTsKKwkJCWlmIChwbGFuZV9zdGF0ZS0+
cGVuZGluZy5kaXJ0eSkgeworCQkJCXBsYW5lX3N0YXRlLT5wZW5kaW5nLmNvbmZpZyA9IHRydWU7
CisJCQkJcGxhbmVfc3RhdGUtPnBlbmRpbmcuZGlydHkgPSBmYWxzZTsKKwkJCX0KKwkJfQorCQlt
dGtfY3J0Yy0+cGVuZGluZ19wbGFuZXMgPSB0cnVlOworCQltdGtfY3J0Yy0+Y3Vyc29yX3VwZGF0
ZSA9IHRydWU7CisJCWlmIChwcml2LT5kYXRhLT5zaGFkb3dfcmVnaXN0ZXIpIHsKKwkJCW10a19k
aXNwX211dGV4X2FjcXVpcmUobXRrX2NydGMtPm11dGV4KTsKKwkJCW10a19jcnRjX2RkcF9jb25m
aWcoY3J0Yyk7CisJCQltdGtfZGlzcF9tdXRleF9yZWxlYXNlKG10a19jcnRjLT5tdXRleCk7CiAJ
CX0KIAl9Ci0JbXRrX2NydGMtPnBlbmRpbmdfcGxhbmVzID0gdHJ1ZTsKLQltdGtfY3J0Yy0+Y3Vy
c29yX3VwZGF0ZSA9IHRydWU7CisJbXV0ZXhfdW5sb2NrKCZwcml2LT5od19sb2NrKTsKK30KIAot
CWlmIChwcml2LT5kYXRhLT5zaGFkb3dfcmVnaXN0ZXIpIHsKLQkJbXRrX2Rpc3BfbXV0ZXhfYWNx
dWlyZShtdGtfY3J0Yy0+bXV0ZXgpOwotCQltdGtfY3J0Y19kZHBfY29uZmlnKGNydGMpOwotCQlt
dGtfZGlzcF9tdXRleF9yZWxlYXNlKG10a19jcnRjLT5tdXRleCk7Cit2b2lkIG10a19kcm1fY3J0
Y19wbGFuZV91cGRhdGUoc3RydWN0IGRybV9jcnRjICpjcnRjLCBzdHJ1Y3QgZHJtX3BsYW5lICpw
bGFuZSwKKwkJCSAgICAgICBzdHJ1Y3QgbXRrX3BsYW5lX3N0YXRlICpzdGF0ZSkKK3sKKwlzdHJ1
Y3QgbXRrX2RybV9jcnRjICptdGtfY3J0YyA9IHRvX210a19jcnRjKGNydGMpOworCXN0cnVjdCBt
dGtfZGRwX2NvbXAgKmNvbXAgPSBtdGtfY3J0Yy0+ZGRwX2NvbXBbMF07CisJc3RydWN0IGRybV9j
cnRjX3N0YXRlICpjcnRjX3N0YXRlID0gY3J0Yy0+c3RhdGU7CisJc3RydWN0IG10a19jcnRjX3N0
YXRlICptdGtfY3J0Y19zdGF0ZSA9IHRvX210a19jcnRjX3N0YXRlKGNydGNfc3RhdGUpOworCXN0
cnVjdCBjbWRxX3BrdCAqY21kcV9oYW5kbGUgPSBtdGtfY3J0Y19zdGF0ZS0+Y21kcV9oYW5kbGU7
CisJdW5zaWduZWQgaW50IGNvbXBfbGF5ZXJfbnIgPSBtdGtfZGRwX2NvbXBfbGF5ZXJfbnIoY29t
cCk7CisJdW5zaWduZWQgaW50IGxvY2FsX2xheWVyOworCXVuc2lnbmVkIGludCBwbGFuZV9pbmRl
eCA9IHBsYW5lIC0gbXRrX2NydGMtPnBsYW5lczsKKworCURSTV9ERUJVR19EUklWRVIoIiVzXG4i
LCBfX2Z1bmNfXyk7CisJaWYgKG10a19jcnRjLT5jbWRxX2NsaWVudCkgeworCQlpZiAocGxhbmVf
aW5kZXggPj0gY29tcF9sYXllcl9ucikgeworCQkJY29tcCA9IG10a19jcnRjLT5kZHBfY29tcFsx
XTsKKwkJCWxvY2FsX2xheWVyID0gcGxhbmVfaW5kZXggLSBjb21wX2xheWVyX25yOworCQl9IGVs
c2UgeworCQkJbG9jYWxfbGF5ZXIgPSBwbGFuZV9pbmRleDsKKwkJfQorCQltdGtfZGRwX2NvbXBf
bGF5ZXJfY29uZmlnKGNvbXAsIGxvY2FsX2xheWVyLCBzdGF0ZSwKKwkJCQkJICBjbWRxX2hhbmRs
ZSk7CiAJfQotCW11dGV4X3VubG9jaygmcHJpdi0+aHdfbG9jayk7CiB9CiAKIHN0YXRpYyB2b2lk
IG10a19kcm1fY3J0Y19hdG9taWNfZW5hYmxlKHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKQEAgLTQ4
Nyw2ICs1ODMsMTUgQEAgc3RhdGljIHZvaWQgbXRrX2RybV9jcnRjX2F0b21pY19iZWdpbihzdHJ1
Y3QgZHJtX2NydGMgKmNydGMsCiAJCVdBUk5fT04oZHJtX2NydGNfdmJsYW5rX2dldChjcnRjKSAh
PSAwKTsKIAkJbXRrX2NydGMtPmV2ZW50ID0gc3RhdGUtPmJhc2UuZXZlbnQ7CiAJCXN0YXRlLT5i
YXNlLmV2ZW50ID0gTlVMTDsKKwkJLyogTWFrZSBzdXJlIHRoZSBhYm92ZSBwYXJhbWV0ZXIgaXMg
c2V0IGJlZm9yZSB1cGRhdGUgKi8KKwkJc21wX3dtYigpOworCQltdGtfY3J0Yy0+cGVuZGluZ19u
ZWVkc192YmxhbmsgPSB0cnVlOworCX0KKwlpZiAoSVNfRU5BQkxFRChDT05GSUdfTVRLX0NNRFEp
ICYmIG10a19jcnRjLT5jbWRxX2NsaWVudCkgeworCQlzdGF0ZS0+Y21kcV9oYW5kbGUgPSBjbWRx
X3BrdF9jcmVhdGUobXRrX2NydGMtPmNtZHFfY2xpZW50LAorCQkJCQkJICAgICBQQUdFX1NJWkUp
OworCQljbWRxX3BrdF9jbGVhcl9ldmVudChzdGF0ZS0+Y21kcV9oYW5kbGUsIG10a19jcnRjLT5j
bWRxX2V2ZW50KTsKKwkJY21kcV9wa3Rfd2ZlKHN0YXRlLT5jbWRxX2hhbmRsZSwgbXRrX2NydGMt
PmNtZHFfZXZlbnQpOwogCX0KIH0KIApAQCAtNDk0LDEzICs1OTksMjkgQEAgc3RhdGljIHZvaWQg
bXRrX2RybV9jcnRjX2F0b21pY19mbHVzaChzdHJ1Y3QgZHJtX2NydGMgKmNydGMsCiAJCQkJICAg
ICAgc3RydWN0IGRybV9jcnRjX3N0YXRlICpvbGRfY3J0Y19zdGF0ZSkKIHsKIAlzdHJ1Y3QgZHJt
X2F0b21pY19zdGF0ZSAqb2xkX2F0b21pY19zdGF0ZSA9IG9sZF9jcnRjX3N0YXRlLT5zdGF0ZTsK
KwlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUgKmNydGNfc3RhdGUgPSBjcnRjLT5zdGF0ZTsKKwlzdHJ1
Y3QgbXRrX2NydGNfc3RhdGUgKnN0YXRlID0gdG9fbXRrX2NydGNfc3RhdGUoY3J0Y19zdGF0ZSk7
CisJc3RydWN0IGNtZHFfcGt0ICpjbWRxX2hhbmRsZSA9IHN0YXRlLT5jbWRxX2hhbmRsZTsKIAlz
dHJ1Y3QgbXRrX2RybV9jcnRjICptdGtfY3J0YyA9IHRvX210a19jcnRjKGNydGMpOwogCXN0cnVj
dCBtdGtfZHJtX3ByaXZhdGUgKnByaXYgPSBjcnRjLT5kZXYtPmRldl9wcml2YXRlOworCXN0cnVj
dCBtdGtfY21kcV9jYl9kYXRhICpjYl9kYXRhOwogCXVuc2lnbmVkIGludCBwZW5kaW5nX3BsYW5l
cyA9IDA7CiAJaW50IGk7CiAKLQlpZiAobXRrX2NydGMtPmV2ZW50KQotCQltdGtfY3J0Yy0+cGVu
ZGluZ19uZWVkc192YmxhbmsgPSB0cnVlOworCURSTV9ERUJVR19EUklWRVIoIltDUlRDOiV1XSBb
U1RBVEU6JXAoJXApLT4lcCglcCldXG4iLCBjcnRjLT5iYXNlLmlkLAorCQkJIG9sZF9jcnRjX3N0
YXRlLCBvbGRfY3J0Y19zdGF0ZS0+c3RhdGUsCisJCQkgY3J0Y19zdGF0ZSwgY3J0Y19zdGF0ZS0+
c3RhdGUpOworCisJaWYgKElTX0VOQUJMRUQoQ09ORklHX01US19DTURRKSAmJiBtdGtfY3J0Yy0+
Y21kcV9jbGllbnQpIHsKKwkJZHJtX2F0b21pY19zdGF0ZV9nZXQob2xkX2F0b21pY19zdGF0ZSk7
CisJCWNiX2RhdGEgPSBrbWFsbG9jKHNpemVvZigqY2JfZGF0YSksIEdGUF9LRVJORUwpOworCQlj
Yl9kYXRhLT5zdGF0ZSA9IG9sZF9jcnRjX3N0YXRlOworCQljYl9kYXRhLT5jbWRxX2hhbmRsZSA9
IGNtZHFfaGFuZGxlOworCQljbWRxX3BrdF9mbHVzaF9hc3luYyhjbWRxX2hhbmRsZSwgZGRwX2Nt
ZHFfY2IsIGNiX2RhdGEpOworCisJCXJldHVybjsKKwl9CisKIAlmb3IgKGkgPSAwOyBpIDwgbXRr
X2NydGMtPmxheWVyX25yOyBpKyspIHsKIAkJc3RydWN0IGRybV9wbGFuZSAqcGxhbmUgPSAmbXRr
X2NydGMtPnBsYW5lc1tpXTsKIAkJc3RydWN0IG10a19wbGFuZV9zdGF0ZSAqcGxhbmVfc3RhdGU7
CkBAIC01MjEsNyArNjQyLDggQEAgc3RhdGljIHZvaWQgbXRrX2RybV9jcnRjX2F0b21pY19mbHVz
aChzdHJ1Y3QgZHJtX2NydGMgKmNydGMsCiAKIAlpZiAoY3J0Yy0+c3RhdGUtPmNvbG9yX21nbXRf
Y2hhbmdlZCkKIAkJZm9yIChpID0gMDsgaSA8IG10a19jcnRjLT5kZHBfY29tcF9ucjsgaSsrKQot
CQkJbXRrX2RkcF9nYW1tYV9zZXQobXRrX2NydGMtPmRkcF9jb21wW2ldLCBjcnRjLT5zdGF0ZSk7
CisJCQltdGtfZGRwX2dhbW1hX3NldChtdGtfY3J0Yy0+ZGRwX2NvbXBbaV0sCisJCQkJCSAgY3J0
Yy0+c3RhdGUsIE5VTEwpOwogCiAJaWYgKHByaXYtPmRhdGEtPnNoYWRvd19yZWdpc3Rlcikgewog
CQltdGtfZGlzcF9tdXRleF9hY3F1aXJlKG10a19jcnRjLT5tdXRleCk7CkBAIC01NzgsMTAgKzcw
MCwxMyBAQCB2b2lkIG10a19jcnRjX2RkcF9pcnEoc3RydWN0IGRybV9jcnRjICpjcnRjLCBzdHJ1
Y3QgbXRrX2RkcF9jb21wICpjb21wKQogCXN0cnVjdCBtdGtfZHJtX2NydGMgKm10a19jcnRjID0g
dG9fbXRrX2NydGMoY3J0Yyk7CiAJc3RydWN0IG10a19kcm1fcHJpdmF0ZSAqcHJpdiA9IGNydGMt
PmRldi0+ZGV2X3ByaXZhdGU7CiAKLQlpZiAoIXByaXYtPmRhdGEtPnNoYWRvd19yZWdpc3RlcikK
LQkJbXRrX2NydGNfZGRwX2NvbmZpZyhjcnRjKTsKLQotCW10a19kcm1fZmluaXNoX3BhZ2VfZmxp
cChtdGtfY3J0Yyk7CisJaWYgKG10a19jcnRjLT5jbWRxX2NsaWVudCkgeworCQlkcm1fY3J0Y19o
YW5kbGVfdmJsYW5rKGNydGMpOworCX0gZWxzZSB7CisJCWlmICghcHJpdi0+ZGF0YS0+c2hhZG93
X3JlZ2lzdGVyKQorCQkJbXRrX2NydGNfZGRwX2NvbmZpZyhjcnRjKTsKKwkJbXRrX2RybV9maW5p
c2hfcGFnZV9mbGlwKG10a19jcnRjKTsKKwl9CiB9CiAKIGludCBtdGtfZHJtX2NydGNfY3JlYXRl
KHN0cnVjdCBkcm1fZGV2aWNlICpkcm1fZGV2LApAQCAtNjc4LDUgKzgwMywxOCBAQCBpbnQgbXRr
X2RybV9jcnRjX2NyZWF0ZShzdHJ1Y3QgZHJtX2RldmljZSAqZHJtX2RldiwKIAlkcm1fY3J0Y19l
bmFibGVfY29sb3JfbWdtdCgmbXRrX2NydGMtPmJhc2UsIDAsIGZhbHNlLCBNVEtfTFVUX1NJWkUp
OwogCXByaXYtPm51bV9waXBlcysrOwogCisJaWYgKElTX0VOQUJMRUQoQ09ORklHX01US19DTURR
KSkgeworCQltdGtfY3J0Yy0+Y21kcV9jbGllbnQgPSBjbWRxX21ib3hfY3JlYXRlKGRldiwKKwkJ
CQlkcm1fY3J0Y19pbmRleCgmbXRrX2NydGMtPmJhc2UpLCAyMDAwKTsKKwkJb2ZfcHJvcGVydHlf
cmVhZF91MzJfaW5kZXgoZGV2LT5vZl9ub2RlLCAibWVkaWF0ZWssZ2NlLWV2ZW50cyIsCisJCQkJ
CSAgIGRybV9jcnRjX2luZGV4KCZtdGtfY3J0Yy0+YmFzZSksCisJCQkJCSAgICZtdGtfY3J0Yy0+
Y21kcV9ldmVudCk7CisJCWlmIChJU19FUlIobXRrX2NydGMtPmNtZHFfY2xpZW50KSkgeworCQkJ
ZGV2X2RiZyhkZXYsICJtdGtfY3J0YyAlZCBmYWlsZWQgdG8gY3JlYXRlIG1haWxib3ggY2xpZW50
LCB3cml0aW5nIHJlZ2lzdGVyIGJ5IENQVSBub3dcbiIsCisJCQkJZHJtX2NydGNfaW5kZXgoJm10
a19jcnRjLT5iYXNlKSk7CisJCQltdGtfY3J0Yy0+Y21kcV9jbGllbnQgPSBOVUxMOworCQl9CisJ
fQorCiAJcmV0dXJuIDA7CiB9CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsv
bXRrX2RybV9jcnRjLmggYi9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9jcnRjLmgK
aW5kZXggNDZlOTAzYmU2OGVjLi42YjI0MjNjODg0MTYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1
L2RybS9tZWRpYXRlay9tdGtfZHJtX2NydGMuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0
ZWsvbXRrX2RybV9jcnRjLmgKQEAgLTE5LDYgKzE5LDggQEAgdm9pZCBtdGtfY3J0Y19kZHBfaXJx
KHN0cnVjdCBkcm1fY3J0YyAqY3J0Yywgc3RydWN0IG10a19kZHBfY29tcCAqY29tcCk7CiBpbnQg
bXRrX2RybV9jcnRjX2NyZWF0ZShzdHJ1Y3QgZHJtX2RldmljZSAqZHJtX2RldiwKIAkJCWNvbnN0
IGVudW0gbXRrX2RkcF9jb21wX2lkICpwYXRoLAogCQkJdW5zaWduZWQgaW50IHBhdGhfbGVuKTsK
K3ZvaWQgbXRrX2RybV9jcnRjX3BsYW5lX3VwZGF0ZShzdHJ1Y3QgZHJtX2NydGMgKmNydGMsIHN0
cnVjdCBkcm1fcGxhbmUgKnBsYW5lLAorCQkJICAgICAgIHN0cnVjdCBtdGtfcGxhbmVfc3RhdGUg
KnN0YXRlKTsKIHZvaWQgbXRrX2RybV9jcnRjX2N1cnNvcl91cGRhdGUoc3RydWN0IGRybV9jcnRj
ICpjcnRjLCBzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZSwKIAkJCQlzdHJ1Y3QgZHJtX3BsYW5lX3N0
YXRlICpwbGFuZV9zdGF0ZSk7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9tZWRpYXRl
ay9tdGtfZHJtX2RkcF9jb21wLmMgYi9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9k
ZHBfY29tcC5jCmluZGV4IDc2NDE2YzFjYmIyOC4uMDU2ZWJjNmE4MTk5IDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kZHBfY29tcC5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9tZWRpYXRlay9tdGtfZHJtX2RkcF9jb21wLmMKQEAgLTM5NSw2ICszOTUsNDAgQEAg
aW50IG10a19kZHBfY29tcF9pbml0KHN0cnVjdCBkZXZpY2UgKmRldiwgc3RydWN0IGRldmljZV9u
b2RlICpub2RlLAogCWlmIChJU19FUlIoY29tcC0+Y2xrKSkKIAkJcmV0dXJuIFBUUl9FUlIoY29t
cC0+Y2xrKTsKIAorCWlmIChJU19FTkFCTEVEKENPTkZJR19NVEtfQ01EUSkpIHsKKwkJc3RydWN0
IHBsYXRmb3JtX2RldmljZSAqY29tcF9wZGV2OworCQlzdHJ1Y3QgcmVzb3VyY2UgcmVzOworCQlz
dHJ1Y3QgY21kcV9jbGllbnRfcmVnICpjbWRxX3JlZzsKKwkJaW50IHJldCA9IDA7CisKKwkJaWYg
KG9mX2FkZHJlc3NfdG9fcmVzb3VyY2Uobm9kZSwgMCwgJnJlcykgIT0gMCkgeworCQkJZGV2X2Vy
cihkZXYsICJNaXNzaW5nIHJlZyBpbiAlcyBub2RlXG4iLAorCQkJCW5vZGUtPmZ1bGxfbmFtZSk7
CisJCQlyZXR1cm4gLUVJTlZBTDsKKwkJfQorCQljb21wLT5yZWdzX3BhID0gcmVzLnN0YXJ0Owor
CisJCWNvbXBfcGRldiA9IG9mX2ZpbmRfZGV2aWNlX2J5X25vZGUobm9kZSk7CisJCWlmICghY29t
cF9wZGV2KSB7CisJCQlkZXZfd2FybihkZXYsICJXYWl0aW5nIGZvciBjb21wb25lbnQgZGV2aWNl
ICVzXG4iLAorCQkJCSBub2RlLT5mdWxsX25hbWUpOworCQkJcmV0dXJuIC1FUFJPQkVfREVGRVI7
CisJCX0KKworCQljbWRxX3JlZyA9IGt6YWxsb2Moc2l6ZW9mKCpjbWRxX3JlZyksIEdGUF9LRVJO
RUwpOworCQlpZiAoIWNtZHFfcmVnKQorCQkJcmV0dXJuIC1FSU5WQUw7CisKKwkJcmV0ID0gY21k
cV9kZXZfZ2V0X2NsaWVudF9yZWcoJmNvbXBfcGRldi0+ZGV2LCBjbWRxX3JlZywgMCk7CisJCWlm
IChyZXQgIT0gMCkKKwkJCWRldl9kYmcoJmNvbXBfcGRldi0+ZGV2LAorCQkJCSJnZXQgbWVkaWF0
ZWssZ2NlLWNsaWVudC1yZWcgZmFpbCFcbiIpOworCQllbHNlCisJCQljb21wLT5zdWJzeXMgPSBj
bWRxX3JlZy0+c3Vic3lzOworCisJCWtmcmVlKGNtZHFfcmVnKTsKKwl9CisKIAlyZXR1cm4gMDsK
IH0KIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL21lZGlhdGVrL210a19kcm1fZGRwX2Nv
bXAuaCBiL2RyaXZlcnMvZ3B1L2RybS9tZWRpYXRlay9tdGtfZHJtX2RkcF9jb21wLmgKaW5kZXgg
NmJiYzM1ZjkyODE1Li4wZmFlYzJkYWQ1YTMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9t
ZWRpYXRlay9tdGtfZHJtX2RkcF9jb21wLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL21lZGlhdGVr
L210a19kcm1fZGRwX2NvbXAuaApAQCAtOTksNiArOTksOCBAQCBzdHJ1Y3QgbXRrX2RkcF9jb21w
IHsKIAlpbnQgaXJxOwogCWVudW0gbXRrX2RkcF9jb21wX2lkIGlkOwogCWNvbnN0IHN0cnVjdCBt
dGtfZGRwX2NvbXBfZnVuY3MgKmZ1bmNzOworCXJlc291cmNlX3NpemVfdCByZWdzX3BhOworCXU4
IHN1YnN5czsKIH07CiAKIHN0YXRpYyBpbmxpbmUgdm9pZCBtdGtfZGRwX2NvbXBfY29uZmlnKHN0
cnVjdCBtdGtfZGRwX2NvbXAgKmNvbXAsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbWVk
aWF0ZWsvbXRrX2RybV9wbGFuZS5jIGIvZHJpdmVycy9ncHUvZHJtL21lZGlhdGVrL210a19kcm1f
cGxhbmUuYwppbmRleCA1OWRiZGFmMDc0MjUuLmVmNDZjMGY0MzAzOSAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL21lZGlhdGVrL210a19kcm1fcGxhbmUuYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vbWVkaWF0ZWsvbXRrX2RybV9wbGFuZS5jCkBAIC0yMDIsNiArMjAyLDggQEAgc3RhdGljIHZv
aWQgbXRrX3BsYW5lX2F0b21pY191cGRhdGUoc3RydWN0IGRybV9wbGFuZSAqcGxhbmUsCiAJc3Rh
dGUtPnBlbmRpbmcuaGVpZ2h0ID0gZHJtX3JlY3RfaGVpZ2h0KCZwbGFuZS0+c3RhdGUtPmRzdCk7
CiAJd21iKCk7IC8qIE1ha2Ugc3VyZSB0aGUgYWJvdmUgcGFyYW1ldGVycyBhcmUgc2V0IGJlZm9y
ZSB1cGRhdGUgKi8KIAlzdGF0ZS0+cGVuZGluZy5kaXJ0eSA9IHRydWU7CisKKwltdGtfZHJtX2Ny
dGNfcGxhbmVfdXBkYXRlKGNydGMsIHBsYW5lLCBzdGF0ZSk7CiB9CiAKIHN0YXRpYyB2b2lkIG10
a19wbGFuZV9hdG9taWNfZGlzYWJsZShzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZSwKQEAgLTIxMiw2
ICsyMTQsOCBAQCBzdGF0aWMgdm9pZCBtdGtfcGxhbmVfYXRvbWljX2Rpc2FibGUoc3RydWN0IGRy
bV9wbGFuZSAqcGxhbmUsCiAJc3RhdGUtPnBlbmRpbmcuZW5hYmxlID0gZmFsc2U7CiAJd21iKCk7
IC8qIE1ha2Ugc3VyZSB0aGUgYWJvdmUgcGFyYW1ldGVyIGlzIHNldCBiZWZvcmUgdXBkYXRlICov
CiAJc3RhdGUtPnBlbmRpbmcuZGlydHkgPSB0cnVlOworCS8qIEZldGNoIENSVEMgZnJvbSBvbGQg
cGxhbmUgc3RhdGUgd2hlbiBkaXNhYmxpbmcuICovCisJbXRrX2RybV9jcnRjX3BsYW5lX3VwZGF0
ZShvbGRfc3RhdGUtPmNydGMsIHBsYW5lLCBzdGF0ZSk7CiB9CiAKIHN0YXRpYyBjb25zdCBzdHJ1
Y3QgZHJtX3BsYW5lX2hlbHBlcl9mdW5jcyBtdGtfcGxhbmVfaGVscGVyX2Z1bmNzID0gewotLSAK
Mi4xOC4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpk
cmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0
cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
