Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C2058C2F10
	for <lists+dri-devel@lfdr.de>; Tue,  1 Oct 2019 10:44:06 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BDE996E588;
	Tue,  1 Oct 2019 08:44:03 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-lj1-x244.google.com (mail-lj1-x244.google.com
 [IPv6:2a00:1450:4864:20::244])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3347A6E588
 for <dri-devel@lists.freedesktop.org>; Tue,  1 Oct 2019 08:44:02 +0000 (UTC)
Received: by mail-lj1-x244.google.com with SMTP id m13so12392198ljj.11
 for <dri-devel@lists.freedesktop.org>; Tue, 01 Oct 2019 01:44:02 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=nmZx+sXxvaFWDY9JqGbwwKWF9KaJsMK4bdeJTuJz5O0=;
 b=tU1nmLKFKYgyvGlhkoep5x/7BELk9kivbJNTUSD0OLLn6FCrGeRqFtiKy7XXBiwfY/
 obmh2SqBUzMZA6SNqjqrtuXKQfmjJcshEPz6mXYrvHINSX96w6ZuD8OcCeZ1n4XF1tq8
 jtuawjsHxT+0Da5CGsJwO9cgfCbGtC7spal+i/mtxgkz9XZSY4k+wHC/aMZf9iTmUNUk
 wpoqZUYjnY61b1CJYaREMErxUQ+J2jFOLbpJ8FyI8w8AvkogcL3rlSDGJ7L4gIuE1b21
 9MjcY1Qmjklv31syvNhf/Lbf5NF/XomzMWGpJrPSSLfvHv8cYpgXOpds/8LHAXbf22WS
 0YSw==
X-Gm-Message-State: APjAAAVNP3QqrUHt+gcFo4k7grENT8WJalYJQfi8PvJdleZQYshdX5aG
 pPhrPIIyR2oRuT01/61Jy93twBTR8sni6Q==
X-Google-Smtp-Source: APXvYqyNYKX8uGkMoRPscu3X3Hj2Vdo1IsseU3iZMteHo/ZpnlG7wofQBgUCquDoMTnJzP7vLyiw6Q==
X-Received: by 2002:a2e:9014:: with SMTP id h20mr14887837ljg.154.1569919440023; 
 Tue, 01 Oct 2019 01:44:00 -0700 (PDT)
Received: from genomnajs.ideon.se ([85.235.10.227])
 by smtp.gmail.com with ESMTPSA id d25sm3674013lfj.15.2019.10.01.01.43.58
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 01 Oct 2019 01:43:58 -0700 (PDT)
From: Linus Walleij <linus.walleij@linaro.org>
To: dri-devel@lists.freedesktop.org,
 Maarten Lankhorst <maarten.lankhorst@linux.intel.com>,
 Maxime Ripard <maxime.ripard@bootlin.com>, Sean Paul <sean@poorly.run>
Subject: [PATCH v3] drm/mcde: Some fixes to handling video mode
Date: Tue,  1 Oct 2019 10:43:54 +0200
Message-Id: <20191001084354.20630-1-linus.walleij@linaro.org>
X-Mailer: git-send-email 2.21.0
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=nmZx+sXxvaFWDY9JqGbwwKWF9KaJsMK4bdeJTuJz5O0=;
 b=nhqPBPEx7a6cPZl7gE39gBxqI9/wzRlSbTij8jd3JvqGMjJdtGQ9QYwg50IU1C4cVQ
 dZ9+6m8/WrjUIyTF0n7UqBoE1GGg0imSitsIlmW7Zv9vjgm8dqxsvBDfOpR2vm99JAOg
 jS7MSiptXEfsaZ7Cs86R2tVY/9Cabcxy/CAaA3qQZON0fbiGRPtQ9JXFNm3Y7xJXKj77
 zeu5PGq2OBx9fqV3JQzs1prMYU/J0OQ2Q6wYCq4/GYOc0w7a6CtsIyl5GTihagCT8OUt
 /KNnScEIAR5JniskuztTO/iStFjar9R0P++o+YlH0dEv14uiONhuOL6/tUHtsyHq/B3S
 /TZg==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Stephan Gerhold <stephan@gerhold.net>, linux-arm-kernel@lists.infradead.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhlIHZpZGVvIERTSSBtb2RlIGhhZCBub3QgcmVhbGx5IGJlZW4gdGVzdGVkLiBUaGVzZSBmaXhl
cyBtYWtlcwppdCBtb3JlIGxpa2VseSB0byB3b3JrIG9uIHJlYWwgaGFyZHdhcmU6Ci0gUHV0IHRo
ZSBhY3RpdmUgd2lkdGggKHggd2lkdGgpIGluIHRoZSByaWdodCBiaXRzIGFuZCB0aGUgVlNBCiAg
KHZlcnRpY2FsIHN5bmMgYWN0aXZlKSBpbiB0aGUgcmlnaHQgYml0cyAodGhvc2Ugd2VyZSBzd2Fw
cGVkKS4KLSBDYWxjdWxhdGUgdGhlIHBhY2tldCBzaXplcyBpbiBieXRlcyBhcyBpbiB0aGUgdmVu
ZG9yIGRyaXZlciwKICByYXRoZXIgdGhhbiBpbiBiaXRzLiBUZXN0IHRoZSBjYWxjdWxhdGlvbnMg
YWdhaW5zIGEKICBzcHJlYWRzaGVldCBhbmQgY29uZmlybWVkIGJ5IGRlYnVnIHByaW50cyB0byBi
ZSByZWFzb25hYmxlLgotIEVycm9yIG91dCBpZiB0aGUgY3VycmVudCBtb2RlIGFuZCByZWZyZXNo
IGZyZXF1ZW5jeSBkb2Vzbid0CiAgd29yayBvdXQuIChJbiB0aGUgZnV0dXJlIHdlIG1heSBzaW1w
bHkgd2FudCB0byBzY2FsZSBkb3duCiAgdGhlIHZyZWZyZXNoLikKLSBIYW5kbGUgbmVnYXRpdmUg
cmVzdWx0IGluIGZyb250L2JhY2svc3luYyBwYWNrYWdlcyBhbmQgZmFsbAogIGJhY2sgdG8gemVy
byBsaWtlIGluIHRoZSB2ZW5kb3IgZHJpdmVyLgoKQ2M6IFN0ZXBoYW4gR2VyaG9sZCA8c3RlcGhh
bkBnZXJob2xkLm5ldD4KRml4ZXM6IDVmYzUzN2JmZDAwMCAoImRybS9tY2RlOiBBZGQgbmV3IGRy
aXZlciBmb3IgU1QtRXJpY3Nzb24gTUNERSIpClNpZ25lZC1vZmYtYnk6IExpbnVzIFdhbGxlaWog
PGxpbnVzLndhbGxlaWpAbGluYXJvLm9yZz4KLS0tCkNoYW5nZUxvZyB2Mi0+djM6Ci0gUmVuYW1l
IHRoZSAiYnBwIiB2YXJpYWJsZSB0byAiY3BwIiBzaW5jZSBpdCBpcyAiY2hhcnMgcGVyIHBpeGVs
IgogIHRoaXMgd2FzIGNvbmZ1c2luZ2x5IG5hbWVkIGluIHRoZSB2ZW5kb3IgZHJpdmVyIGFuZCBp
dCBnb3QKICBjYXJyaWVkIG92ZXIuCi0gQXNzaWduIHRoZSBTRVRUSU5HMl9FWEFDVF9CVVJTVF9M
SU1JVCBieSBmaXJzdCBzaGlmdGluZwogIHRoZW4gbWFza2luZy4KLSBBbHNvIG1hc2sgd2l0aCB0
aGUgaW52ZXJzZSBvZiBEU0lfVklEX0JMS1NJWkUxX0JMS0VPTF9QQ0tfTUFTSwogIGJlZm9yZSB3
cml0aW5nIGJsa2VvbCBpbnRvIERTSV9WSURfQkxLU0laRTEsIHNvIHdlIG1ha2Ugc3VyZQogIHRv
IHplcm8gdGhlc2UgYml0cyBmaXJzdC4KLSBBbHNvIG1hc2sgd2l0aCBEU0lfVklEX0JMS1NJWkUx
X0JMS0xJTkVfRVZFTlRfUENLX01BU0sKICB3aGVuIHdyaXRpbmcgZXZlbnQgcGFja2FnZSBsZW5n
dGguCi0gQ29tYiB0aHJvdWdoIHRoZSBjb2RlIGFuZCBjb21wYXJlIGl0IHRvIHZlbmRvciBjb2Rl
IGFuZCB0cnkKICB0byBnZXQgY2xvc2VyIHRvIGRvaW5nIHdoYXQgdGhlIHZlbmRvciBkcml2ZXIg
aXMgZG9pbmcuIENvbXBhcmUKICBjYWxjdWxhdGVkIGJ5dGUgcGFja2V0IHNpemVzIHRvIHRoZSBz
aXplcyBjYWxjdWxhdGVkIGluIGEKICBzcHJlYWRzaGVldC4KQ2hhbmdlTG9nIHYxLT52MjoKLSBG
aXggc29tZSBtb3JlIGNvbW1lbnRzIHNvIHdlIHVuZGVyc3RhbmQgd2hhdCBpcyBnb2luZyBvbi4K
LSBTZXQgdXAgdGhlIG1heGltdW0gbGluZSBsaW1pdCBzaXplIGluIHRoZSByaWdodCByZWdpc3Rl
cgogIGluc3RlYWQgb2Ygc2V0dGluZyBpdCBpbiB0aGUgYnVyc3Qgc2l6ZSByZWdpc3RlciBwb3J0
aW9uLgotIFNldCBzb21lIGRlZmF1bHQgd2FrZXVwIHRpbWUgb3RoZXIgdGhhbiB6ZXJvIChzdGls
bCBuZWVkCiAgZml4aW5nIG1vcmUpLgotLS0KIGRyaXZlcnMvZ3B1L2RybS9tY2RlL21jZGVfZHNp
LmMgfCAxNzggKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2Vk
LCAxMzQgaW5zZXJ0aW9ucygrKSwgNDQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL21jZGUvbWNkZV9kc2kuYyBiL2RyaXZlcnMvZ3B1L2RybS9tY2RlL21jZGVfZHNp
LmMKaW5kZXggZjljOWUzMmIyOTljLi5hMzFjNmVjNzkwMTYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS9tY2RlL21jZGVfZHNpLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL21jZGUvbWNkZV9k
c2kuYwpAQCAtMzY1LDEzICszNjUsMTUgQEAgdm9pZCBtY2RlX2RzaV90ZV9yZXF1ZXN0KHN0cnVj
dCBtaXBpX2RzaV9kZXZpY2UgKm1kc2kpCiBzdGF0aWMgdm9pZCBtY2RlX2RzaV9zZXR1cF92aWRl
b19tb2RlKHN0cnVjdCBtY2RlX2RzaSAqZCwKIAkJCQkgICAgICBjb25zdCBzdHJ1Y3QgZHJtX2Rp
c3BsYXlfbW9kZSAqbW9kZSkKIHsKLQl1OCBicHAgPSBtaXBpX2RzaV9waXhlbF9mb3JtYXRfdG9f
YnBwKGQtPm1kc2ktPmZvcm1hdCk7CisJLyogY3BwLCBjaGFyYWN0ZXJzIHBlciBwaXhlbCwgbnVt
YmVyIG9mIGJ5dGVzIHBlciBwaXhlbCAqLworCXU4IGNwcCA9IG1pcGlfZHNpX3BpeGVsX2Zvcm1h
dF90b19icHAoZC0+bWRzaS0+Zm9ybWF0KSAvIDg7CisJdTY0IHBjbGs7CiAJdTY0IGJwbDsKLQl1
MzIgaGZwOwotCXUzMiBoYnA7Ci0JdTMyIGhzYTsKKwlpbnQgaGZwOworCWludCBoYnA7CisJaW50
IGhzYTsKIAl1MzIgYmxrbGluZV9wY2ssIGxpbmVfZHVyYXRpb247Ci0JdTMyIGJsa2VvbF9wY2ss
IGJsa2VvbF9kdXJhdGlvbjsKKwlpbnQgYmxrZW9sX3BjaywgYmxrZW9sX2R1cmF0aW9uOwogCXUz
MiB2YWw7CiAKIAl2YWwgPSAwOwpAQCAtNDA4LDExICs0MTAsMTEgQEAgc3RhdGljIHZvaWQgbWNk
ZV9kc2lfc2V0dXBfdmlkZW9fbW9kZShzdHJ1Y3QgbWNkZV9kc2kgKmQsCiAJCXJldHVybjsKIAl9
CiAKLQkvKiBUT0RPOiBUVkcgY291bGQgYmUgZW5hYmxlZCBoZXJlICovCisJLyogVE9ETzogVFZH
ICh0ZXN0IHZpZGVvIGdlbmVyYXRvcikgY291bGQgYmUgZW5hYmxlZCBoZXJlICovCiAKLQkvKiBT
ZW5kIGJsYW5raW5nIHBhY2tldCAqLworCS8qIER1cmluZyBibGFua2luZzogZ28gdG8gTFAgbW9k
ZSAqLwogCXZhbCB8PSBEU0lfVklEX01BSU5fQ1RMX1JFR19CTEtMSU5FX01PREVfTFBfMDsKLQkv
KiBTZW5kIEVPTCBwYWNrZXQgKi8KKwkvKiBEdXJpbmcgRU9MOiBnbyB0byBMUCBtb2RlICovCiAJ
dmFsIHw9IERTSV9WSURfTUFJTl9DVExfUkVHX0JMS0VPTF9NT0RFX0xQXzA7CiAJLyogUmVjb3Zl
cnkgbW9kZSAxICovCiAJdmFsIHw9IDEgPDwgRFNJX1ZJRF9NQUlOX0NUTF9SRUNPVkVSWV9NT0RF
X1NISUZUOwpAQCAtNDIwLDEzICs0MjIsMTMgQEAgc3RhdGljIHZvaWQgbWNkZV9kc2lfc2V0dXBf
dmlkZW9fbW9kZShzdHJ1Y3QgbWNkZV9kc2kgKmQsCiAJd3JpdGVsKHZhbCwgZC0+cmVncyArIERT
SV9WSURfTUFJTl9DVEwpOwogCiAJLyogVmVydGljYWwgZnJhbWUgcGFyYW1ldGVycyBhcmUgcHJl
dHR5IHN0cmFpZ2h0LWZvcndhcmQgKi8KLQl2YWwgPSBtb2RlLT52ZGlzcGxheSA8PCBEU0lfVklE
X1ZTSVpFX1ZTQV9MRU5HVEhfU0hJRlQ7CisJdmFsID0gbW9kZS0+dmRpc3BsYXkgPDwgRFNJX1ZJ
RF9WU0laRV9WQUNUX0xFTkdUSF9TSElGVDsKIAkvKiB2ZXJ0aWNhbCBmcm9udCBwb3JjaCAqLwog
CXZhbCB8PSAobW9kZS0+dnN5bmNfc3RhcnQgLSBtb2RlLT52ZGlzcGxheSkKIAkJPDwgRFNJX1ZJ
RF9WU0laRV9WRlBfTEVOR1RIX1NISUZUOwogCS8qIHZlcnRpY2FsIHN5bmMgYWN0aXZlICovCiAJ
dmFsIHw9IChtb2RlLT52c3luY19lbmQgLSBtb2RlLT52c3luY19zdGFydCkKLQkJPDwgRFNJX1ZJ
RF9WU0laRV9WQUNUX0xFTkdUSF9TSElGVDsKKwkJPDwgRFNJX1ZJRF9WU0laRV9WU0FfTEVOR1RI
X1NISUZUOwogCS8qIHZlcnRpY2FsIGJhY2sgcG9yY2ggKi8KIAl2YWwgfD0gKG1vZGUtPnZ0b3Rh
bCAtIG1vZGUtPnZzeW5jX2VuZCkKIAkJPDwgRFNJX1ZJRF9WU0laRV9WQlBfTEVOR1RIX1NISUZU
OwpAQCAtNDM0LDM2ICs0MzYsNTQgQEAgc3RhdGljIHZvaWQgbWNkZV9kc2lfc2V0dXBfdmlkZW9f
bW9kZShzdHJ1Y3QgbWNkZV9kc2kgKmQsCiAKIAkvKgogCSAqIEhvcml6b250YWwgZnJhbWUgcGFy
YW1ldGVyczoKLQkgKiBob3Jpem9udGFsIHJlc29sdXRpb24gaXMgZ2l2ZW4gaW4gcGl4ZWxzIGFu
ZCBtdXN0IGJlIHJlLWNhbGN1bGF0ZWQKLQkgKiBpbnRvIGJ5dGVzIHNpbmNlIHRoaXMgaXMgd2hh
dCB0aGUgaGFyZHdhcmUgZXhwZWN0cy4KKwkgKiBob3Jpem9udGFsIHJlc29sdXRpb24gaXMgZ2l2
ZW4gaW4gcGl4ZWxzIGJ1dCBtdXN0IGJlIHJlLWNhbGN1bGF0ZWQKKwkgKiBpbnRvIGJ5dGVzIHNp
bmNlIHRoaXMgaXMgd2hhdCB0aGUgaGFyZHdhcmUgZXhwZWN0cywgdGhlc2UgcmVnaXN0ZXJzCisJ
ICogZGVmaW5lIHRoZSBwYXlsb2FkIHNpemUgb2YgdGhlIHBhY2tldC4KKwkgKgorCSAqIGhmcCA9
IGhvcml6b250YWwgZnJvbnQgcG9yY2ggaW4gYnl0ZXMKKwkgKiBoYnAgPSBob3Jpem9udGFsIGJh
Y2sgcG9yY2ggaW4gYnl0ZXMKKwkgKiBoc2EgPSBob3Jpem9udGFsIHN5bmMgYWN0aXZlIGluIGJ5
dGVzCiAJICoKIAkgKiA2ICsgMiBpcyBIRlAgaGVhZGVyICsgY2hlY2tzdW0KIAkgKi8KLQloZnAg
PSAobW9kZS0+aHN5bmNfc3RhcnQgLSBtb2RlLT5oZGlzcGxheSkgKiBicHAgLSA2IC0gMjsKKwlo
ZnAgPSAobW9kZS0+aHN5bmNfc3RhcnQgLSBtb2RlLT5oZGlzcGxheSkgKiBjcHAgLSA2IC0gMjsK
IAlpZiAoZC0+bWRzaS0+bW9kZV9mbGFncyAmIE1JUElfRFNJX01PREVfVklERU9fU1lOQ19QVUxT
RSkgewogCQkvKgorCQkgKiBVc2Ugc3luYyBwdWxzZSBmb3Igc3luYzogZXhwbGljaXQgSFNBIHRp
bWUKIAkJICogNiBpcyBIQlAgaGVhZGVyICsgY2hlY2tzdW0KIAkJICogNCBpcyBSR0IgaGVhZGVy
ICsgY2hlY2tzdW0KIAkJICovCi0JCWhicCA9IChtb2RlLT5odG90YWwgLSBtb2RlLT5oc3luY19l
bmQpICogYnBwIC0gNCAtIDY7CisJCWhicCA9IChtb2RlLT5odG90YWwgLSBtb2RlLT5oc3luY19l
bmQpICogY3BwIC0gNCAtIDY7CiAJCS8qCiAJCSAqIDYgaXMgSEJQIGhlYWRlciArIGNoZWNrc3Vt
CiAJCSAqIDQgaXMgSFNXIHBhY2tldCBieXRlcwogCQkgKiA0IGlzIFJHQiBoZWFkZXIgKyBjaGVj
a3N1bQogCQkgKi8KLQkJaHNhID0gKG1vZGUtPmhzeW5jX2VuZCAtIG1vZGUtPmhzeW5jX3N0YXJ0
KSAqIGJwcCAtIDQgLSA0IC0gNjsKKwkJaHNhID0gKG1vZGUtPmhzeW5jX2VuZCAtIG1vZGUtPmhz
eW5jX3N0YXJ0KSAqIGNwcCAtIDQgLSA0IC0gNjsKIAl9IGVsc2UgewogCQkvKgotCQkgKiBIQlAg
aW5jbHVkZXMgYm90aCBiYWNrIHBvcmNoIGFuZCBzeW5jCisJCSAqIFVzZSBldmVudCBmb3Igc3lu
YzogSEJQIGluY2x1ZGVzIGJvdGggYmFjayBwb3JjaCBhbmQgc3luYwogCQkgKiA2IGlzIEhCUCBo
ZWFkZXIgKyBjaGVja3N1bQogCQkgKiA0IGlzIEhTVyBwYWNrZXQgYnl0ZXMKIAkJICogNCBpcyBS
R0IgaGVhZGVyICsgY2hlY2tzdW0KIAkJICovCi0JCWhicCA9IChtb2RlLT5odG90YWwgLSBtb2Rl
LT5oc3luY19zdGFydCkgKiBicHAgLSA0IC0gNCAtIDY7Ci0JCS8qIEhTQSBpcyBub3QgY29uc2lk
ZXJlZCBpbiB0aGlzIG1vZGUgYW5kIHNldCB0byAwICovCisJCWhicCA9IChtb2RlLT5odG90YWwg
LSBtb2RlLT5oc3luY19zdGFydCkgKiBjcHAgLSA0IC0gNCAtIDY7CisJCS8qIEhTQSBpcyBub3Qg
cHJlc2VudCBpbiB0aGlzIG1vZGUgYW5kIHNldCB0byAwICovCisJCWhzYSA9IDA7CisJfQorCWlm
IChoZnAgPCAwKSB7CisJCWRldl9pbmZvKGQtPmRldiwgImhmcCBuZWdhdGl2ZSwgc2V0IHRvIDBc
biIpOworCQloZnAgPSAwOworCX0KKwlpZiAoaGJwIDwgMCkgeworCQlkZXZfaW5mbyhkLT5kZXYs
ICJoYnAgbmVnYXRpdmUsIHNldCB0byAwXG4iKTsKKwkJaGJwID0gMDsKKwl9CisJaWYgKGhzYSA8
IDApIHsKKwkJZGV2X2luZm8oZC0+ZGV2LCAiaHNhIG5lZ2F0aXZlLCBzZXQgdG8gMFxuIik7CiAJ
CWhzYSA9IDA7CiAJfQotCWRldl9kYmcoZC0+ZGV2LCAiaGZwOiAldSwgaGJwOiAldSwgaHNhOiAl
dVxuIiwKKwlkZXZfZGJnKGQtPmRldiwgImhmcDogJXUsIGhicDogJXUsIGhzYTogJXUgYnl0ZXNc
biIsCiAJCWhmcCwgaGJwLCBoc2EpOwogCiAJLyogRnJhbWUgcGFyYW1ldGVyczogaG9yaXpvbnRh
bCBzeW5jIGFjdGl2ZSAqLwpAQCAtNDc0LDcwICs0OTQsMTQyIEBAIHN0YXRpYyB2b2lkIG1jZGVf
ZHNpX3NldHVwX3ZpZGVvX21vZGUoc3RydWN0IG1jZGVfZHNpICpkLAogCXZhbCB8PSBoZnAgPDwg
RFNJX1ZJRF9IU0laRTFfSEZQX0xFTkdUSF9TSElGVDsKIAl3cml0ZWwodmFsLCBkLT5yZWdzICsg
RFNJX1ZJRF9IU0laRTEpOwogCi0JLyogUkdCIGRhdGEgbGVuZ3RoIChieXRlcyBvbiBvbmUgc2Nh
bmxpbmUpICovCi0JdmFsID0gbW9kZS0+aGRpc3BsYXkgKiAoYnBwIC8gOCk7CisJLyogUkdCIGRh
dGEgbGVuZ3RoICh2aXNpYmxlIGJ5dGVzIG9uIG9uZSBzY2FubGluZSkgKi8KKwl2YWwgPSBtb2Rl
LT5oZGlzcGxheSAqIGNwcDsKIAl3cml0ZWwodmFsLCBkLT5yZWdzICsgRFNJX1ZJRF9IU0laRTIp
OworCWRldl9kYmcoZC0+ZGV2LCAiUkdCIGxlbmd0aCwgdmlzaWJsZSBhcmVhIG9uIGEgbGluZTog
JXUgYnl0ZXNcbiIsIHZhbCk7CiAKLQkvKiBUT0RPOiBmdXJ0aGVyIGFkanVzdG1lbnRzIGZvciBU
VkcgbW9kZSBoZXJlICovCisJLyoKKwkgKiBFT0wgcGFja2V0IGxlbmd0aCBmcm9tIGJpdHMgcGVy
IGxpbmUgY2FsY3VsYXRpb25zLgorCSAqCisJICogQ2FsY3VsYXRlIHRoZSB0aW1lIGJldHdlZW4g
dHdvIHBpeGVscyBpbiBwaWNvc2Vjb25kcyB1c2luZworCSAqIHRoZSBzdXBwbGllZCByZWZyZXNo
IHJhdGUgYW5kIHRvdGFsIHJlc29sdXRpb24gaW5jbHVkaW5nCisJICogcG9yY2hlcyBhbmQgc3lu
Yy4KKwkgKi8KKwkvKiAocHMvcykgLyAocGl4ZWxzL3MpID0gcHMvcGl4ZWxzICovCisJcGNsayA9
IERJVl9ST1VORF9VUF9VTEwoMTAwMDAwMDAwMDAwMCwKKwkJCQkobW9kZS0+dnJlZnJlc2ggKiBt
b2RlLT5odG90YWwgKiBtb2RlLT52dG90YWwpKTsKKwlkZXZfZGJnKGQtPmRldiwgInBpY29zZWNv
bmRzIGJldHdlZW4gdHdvIHBpeGVsczogJWxsdVxuIiwKKwkJcGNsayk7CiAKIAkvKgotCSAqIEVP
TCBwYWNrZXQgbGVuZ3RoIGZyb20gYml0cyBwZXIgbGluZSBjYWxjdWxhdGlvbnM6IHBpeGVsIGNs
b2NrCi0JICogaXMgZ2l2ZW4gaW4ga0h6LCBjYWxjdWxhdGUgdGhlIHRpbWUgYmV0d2VlbiB0d28g
cGl4ZWxzIGluCi0JICogcGljb3NlY29uZHMuCisJICogSG93IG1hbnkgYnl0ZXMgcGVyIGxpbmUg
d2lsbCB0aGlzIHVwZGF0ZSBmcmVxdWVuY3kgeWllbGQ/CisJICoKKwkgKiBDYWxjdWxhdGUgdGhl
IG51bWJlciBvZiBwaWNvc2Vjb25kcyBmb3Igb25lIHNjYW5saW5lICgxKSwgdGhlbgorCSAqIGRp
dmlkZSBieSAxMDAwMDAwMDAwMDAwICgyKSB0byBnZXQgaW4gcGl4ZWxzIHBlciBzZWNvbmQgd2UK
KwkgKiB3YW50IHRvIG91dHB1dC4KKwkgKgorCSAqIE11bHRpcGx5IHdpdGggbnVtYmVyIG9mIGJ5
dGVzIHBlciBzZWNvbmQgYXQgdGhpcyB2aWRlbyBkaXNwbGF5CisJICogZnJlcXVlbmN5ICgzKSB0
byBnZXQgbnVtYmVyIG9mIGJ5dGVzIHRyYW5zZmVycmVkIGR1cmluZyB0aGlzCisJICogdGltZS4g
Tm90aWNlIHRoYXQgd2UgdXNlIHRoZSBmcmVxdWVuY3kgdGhlIGRpc3BsYXkgd2FudHMsCisJICog
bm90IHdoYXQgd2UgYWN0dWFsbHkgZ2V0IGZyb20gdGhlIERTSSBQTEwsIHdoaWNoIGlzIGhzX2Zy
ZXEuCisJICoKKwkgKiBUaGVzZSBhcml0aG1ldGljcyBhcmUgZG9uZSBpbiBhIGRpZmZlcmVudCBv
cmRlciB0byBhdm9pZAorCSAqIG92ZXJmbG93LgogCSAqLwotCWJwbCA9IG1vZGUtPmNsb2NrICog
bW9kZS0+aHRvdGFsOwotCWJwbCAqPSAoZC0+aHNfZnJlcSAvIDgpOwotCWRvX2RpdihicGwsIDEw
MDAwMDApOyAvKiBtaWNyb3NlY29uZHMgKi8KLQlkb19kaXYoYnBsLCAxMDAwMDAwKTsgLyogc2Vj
b25kcyAqLworCWJwbCA9IHBjbGsgKiBtb2RlLT5odG90YWw7IC8qICgxKSBwaWNvc2Vjb25kcyBw
ZXIgbGluZSAqLworCWRldl9pbmZvKGQtPmRldiwgInBpY29zZWNvbmRzIHBlciBsaW5lOiAlbGx1
XG4iLCBicGwpOworCS8qIE11bHRpcGx5IHdpdGggYnl0ZXMgcGVyIHNlY29uZCAoMykgKi8KKwli
cGwgKj0gKChtb2RlLT5jbG9jayAqIDEwMDApIC8gOCk7CisJLyogUGl4ZWxzIHBlciBzZWNvbmQg
KDIpICovCisJYnBsID0gRElWX1JPVU5EX0RPV05fVUxMKGJwbCwgMTAwMDAwMCk7IC8qIG1pY3Jv
c2Vjb25kcyAqLworCWJwbCA9IERJVl9ST1VORF9ET1dOX1VMTChicGwsIDEwMDAwMDApOyAvKiBz
ZWNvbmRzICovCisJLyogcGFyYWxsZWwgdHJhbnNhY3Rpb25zIGluIGFsbCBsYW5lcyAqLwogCWJw
bCAqPSBkLT5tZHNpLT5sYW5lczsKLQlkZXZfZGJnKGQtPmRldiwgImNhbGN1bGF0ZWQgYnl0ZXMg
cGVyIGxpbmU6ICVsbHVcbiIsIGJwbCk7CisJZGV2X2RiZyhkLT5kZXYsICJjYWxjdWxhdGVkIGJ5
dGVzIHBlciBsaW5lOiAlbGx1IEAgJWQgSHpcbiIsCisJCWJwbCwgbW9kZS0+dnJlZnJlc2gpOwor
CiAJLyoKIAkgKiA2IGlzIGhlYWRlciArIGNoZWNrc3VtLCBoZWFkZXIgPSA0IGJ5dGVzLCBjaGVj
a3N1bSA9IDIgYnl0ZXMKIAkgKiA0IGlzIHNob3J0IHBhY2tldCBmb3IgdnN5bmMvaHN5bmMKIAkg
Ki8KIAlpZiAoZC0+bWRzaS0+bW9kZV9mbGFncyAmIE1JUElfRFNJX01PREVfVklERU9fU1lOQ19Q
VUxTRSkgewotCQkvKiBGaXhtZTogaXNuJ3QgdGhlIGhzeW5jIHdpZHRoIGluIHBpeGVscz8gKi8K
KwkJLyogU2V0IHRoZSBldmVudCBwYWNrZXQgc2l6ZSB0byAwIChub3QgdXNlZCkgKi8KKwkJd3Jp
dGVsKDAsIGQtPnJlZ3MgKyBEU0lfVklEX0JMS1NJWkUxKTsKKwkJLyoKKwkJICogRklYTUU6IGlz
bid0IHRoZSBoc3luYyB3aWR0aCBpbiBwaXhlbHM/IFRoZSBwb3JjaCBhbmQKKwkJICogc3luYyBh
cmVhIHNpemUgaXMgaW4gcGl4ZWxzIGhlcmUsIGJ1dCB0aGlzIC02CisJCSAqIHNlZW1zIHRvIGJl
IGZvciBieXRlcy4gSXQgbG9va3MgbGlrZSB0aGlzIGluIHRoZSB2ZW5kb3IKKwkJICogY29kZSB0
aG91Z2guIElzIGl0IGNvbXBsZXRlbHkgdW50ZXN0ZWQ/CisJCSAqLwogCQlibGtsaW5lX3BjayA9
IGJwbCAtIChtb2RlLT5oc3luY19lbmQgLSBtb2RlLT5oc3luY19zdGFydCkgLSA2OwogCQl2YWwg
PSBibGtsaW5lX3BjayA8PCBEU0lfVklEX0JMS1NJWkUyX0JMS0xJTkVfUFVMU0VfUENLX1NISUZU
OwogCQl3cml0ZWwodmFsLCBkLT5yZWdzICsgRFNJX1ZJRF9CTEtTSVpFMik7CiAJfSBlbHNlIHsK
KwkJLyogU2V0IHRoZSBzeW5jIHB1bHNlIHBhY2tldCBzaXplIHRvIDAgKG5vdCB1c2VkKSAqLwor
CQl3cml0ZWwoMCwgZC0+cmVncyArIERTSV9WSURfQkxLU0laRTIpOworCQkvKiBTcGVjaWZ5aW5n
IHBheWxvYWQgc2l6ZSBpbiBieXRlcyAoLTQtNiBmcm9tIG1hbnVhbCkgKi8KIAkJYmxrbGluZV9w
Y2sgPSBicGwgLSA0IC0gNjsKIAkJdmFsID0gYmxrbGluZV9wY2sgPDwgRFNJX1ZJRF9CTEtTSVpF
MV9CTEtMSU5FX0VWRU5UX1BDS19TSElGVDsKKwkJdmFsICY9IERTSV9WSURfQkxLU0laRTFfQkxL
TElORV9FVkVOVF9QQ0tfTUFTSzsKIAkJd3JpdGVsKHZhbCwgZC0+cmVncyArIERTSV9WSURfQkxL
U0laRTEpOwogCX0KIAotCWxpbmVfZHVyYXRpb24gPSAoYmxrbGluZV9wY2sgKyA2KSAvIGQtPm1k
c2ktPmxhbmVzOwotCWRldl9kYmcoZC0+ZGV2LCAibGluZSBkdXJhdGlvbiAldVxuIiwgbGluZV9k
dXJhdGlvbik7CisJLyoKKwkgKiBUaGUgbGluZSBkdXJhdGlvbiBpcyB1c2VkIHRvIHNjYWxlIGJh
Y2sgdGhlIGZyZXF1ZW5jeSBmcm9tCisJICogdGhlIG1heCBmcmVxdWVuY3kgc3VwcG9ydGVkIGJ5
IHRoZSBIUyBjbG9jayB0byB0aGUgZGVzaXJlZAorCSAqIHVwZGF0ZSBmcmVxdWVuY3kgaW4gdnJl
ZnJlc2guCisJICovCisJbGluZV9kdXJhdGlvbiA9IGJsa2xpbmVfcGNrICsgNjsKKwkvKgorCSAq
IFRoZSBkYXRhc2hlZXQgY29udGFpbnMgdGhpcyBjb21wbGV4IGNvbmRpdGlvbiB0byBkZWNyZWFz
aW5nCisJICogdGhlIGxpbmUgZHVyYXRpb24gYnkgMSB1bmRlciB2ZXJ5IHNwZWNpZmljIGNpcmN1
bXN0YW5jZXMuCisJICogSGVyZSB3ZSBhbHNvIGltcGx5IHRoYXQgTFAgaXMgdXNlZCBkdXJpbmcg
YnVyc3QgRU9MLgorCSAqLworCWlmIChkLT5tZHNpLT5sYW5lcyA9PSAyICYmIChoc2EgJiAweDAx
KSAmJiAoaGZwICYgMHgwMSkKKwkgICAgJiYgKGQtPm1kc2ktPm1vZGVfZmxhZ3MgJiBNSVBJX0RT
SV9NT0RFX1ZJREVPX0JVUlNUKSkKKwkJbGluZV9kdXJhdGlvbi0tOworCWxpbmVfZHVyYXRpb24g
PSBESVZfUk9VTkRfQ0xPU0VTVChsaW5lX2R1cmF0aW9uLCBkLT5tZHNpLT5sYW5lcyk7CisJZGV2
X2RiZyhkLT5kZXYsICJsaW5lIGR1cmF0aW9uICV1IGJ5dGVzIHBlciBsYW5lXG4iLCBsaW5lX2R1
cmF0aW9uKTsKIAl2YWwgPSBsaW5lX2R1cmF0aW9uIDw8IERTSV9WSURfRFBIWV9USU1FX1JFR19M
SU5FX0RVUkFUSU9OX1NISUZUOwogCS8qCiAJICogVGhpcyBpcyB0aGUgdGltZSB0byBwZXJmb3Jt
IExQLT5IUyBvbiBELVBIWQogCSAqIEZJWE1FOiBub3doZXJlIHRvIGdldCB0aGlzIGZyb206IERU
IHByb3BlcnR5IG9uIHRoZSBEU0k/CisJICogVGhlIG1hbnVhbCBzYXlzIHRoaXMgaXMgInN5c3Rl
bSBkZXBlbmRlbnQiLgorCSAqIHZhbHVlcyBsaWtlIDQ4IGFuZCA3MiBzZWVuIGluIHRoZSB2ZW5k
b3IgY29kZS4KIAkgKi8KLQl2YWwgfD0gMCA8PCBEU0lfVklEX0RQSFlfVElNRV9SRUdfV0FLRVVQ
X1RJTUVfU0hJRlQ7CisJdmFsIHw9IDQ4IDw8IERTSV9WSURfRFBIWV9USU1FX1JFR19XQUtFVVBf
VElNRV9TSElGVDsKIAl3cml0ZWwodmFsLCBkLT5yZWdzICsgRFNJX1ZJRF9EUEhZX1RJTUUpOwog
CiAJLyogQ2FsY3VsYXRlIGJsb2NrIGVuZCBvZiBsaW5lICovCi0JYmxrZW9sX3BjayA9IGJwbCAt
IG1vZGUtPmhkaXNwbGF5ICogYnBwIC0gNjsKLQlibGtlb2xfZHVyYXRpb24gPSAoYmxrZW9sX3Bj
ayArIDYpIC8gZC0+bWRzaS0+bGFuZXM7Ci0JZGV2X2RiZyhkLT5kZXYsICJibGtlb2wgcGNrOiAl
dSwgZHVyYXRpb246ICV1XG4iLAotCQkgYmxrZW9sX3BjaywgYmxrZW9sX2R1cmF0aW9uKTsKKwli
bGtlb2xfcGNrID0gYnBsIC0gbW9kZS0+aHRvdGFsICogY3BwIC0gNjsKKwlpZiAoYmxrZW9sX3Bj
ayA8IDApIHsKKwkJZGV2X2VycihkLT5kZXYsICJ2aWRlbyBibG9jayBkb2VzIG5vdCBmaXQgb24g
bGluZSFcbiIpOworCQlkZXZfZXJyKGQtPmRldiwgImNhbGN1bGF0ZWQgYnl0ZXMgcGVyIGxpbmU6
ICVsbHUgQCAlZCBIelxuIiwKKwkJCWJwbCwgbW9kZS0+dnJlZnJlc2gpOworCQlkZXZfZXJyKGQt
PmRldiwgImJ5dGVzIHBlciBsaW5lIChibGtsaW5lX3BjaykgJXUgYnl0ZXNcbiIsCisJCQlibGts
aW5lX3Bjayk7CisJCWRldl9lcnIoZC0+ZGV2LCAiYmxrZW9sX3BjayBiZWNvbWVzICVkIGJ5dGVz
XG4iLCBibGtlb2xfcGNrKTsKKwkJcmV0dXJuOworCX0KKwlibGtlb2xfZHVyYXRpb24gPSBESVZf
Uk9VTkRfVVAoYmxrZW9sX3BjayArIDYsIGQtPm1kc2ktPmxhbmVzKTsKKwlkZXZfZGJnKGQtPmRl
diwgImJsa2VvbCBwY2s6ICVkIGJ5dGVzLCBkdXJhdGlvbjogJWQgYnl0ZXNcbiIsCisJCWJsa2Vv
bF9wY2ssIGJsa2VvbF9kdXJhdGlvbik7CiAKIAlpZiAoZC0+bWRzaS0+bW9kZV9mbGFncyAmIE1J
UElfRFNJX01PREVfVklERU9fQlVSU1QpIHsKIAkJLyogU2V0IHVwIEVPTCBjbG9jayBmb3IgYnVy
c3QgbW9kZSAqLwogCQl2YWwgPSByZWFkbChkLT5yZWdzICsgRFNJX1ZJRF9CTEtTSVpFMSk7CisJ
CXZhbCAmPSB+RFNJX1ZJRF9CTEtTSVpFMV9CTEtFT0xfUENLX01BU0s7CiAJCXZhbCB8PSBibGtl
b2xfcGNrIDw8IERTSV9WSURfQkxLU0laRTFfQkxLRU9MX1BDS19TSElGVDsKIAkJd3JpdGVsKHZh
bCwgZC0+cmVncyArIERTSV9WSURfQkxLU0laRTEpOwotCQl3cml0ZWwoYmxrZW9sX3BjaywgZC0+
cmVncyArIERTSV9WSURfVkNBX1NFVFRJTkcyKTsKKwkJLyogVXNlIHRoZSBzYW1lIHZhbHVlIGZv
ciBleGFjdCBidXJzdCBsaW1pdCAqLworCQl2YWwgPSBibGtlb2xfcGNrIDw8CisJCQlEU0lfVklE
X1ZDQV9TRVRUSU5HMl9FWEFDVF9CVVJTVF9MSU1JVF9TSElGVDsKKwkJdmFsICY9IERTSV9WSURf
VkNBX1NFVFRJTkcyX0VYQUNUX0JVUlNUX0xJTUlUX01BU0s7CisJCXdyaXRlbCh2YWwsIGQtPnJl
Z3MgKyBEU0lfVklEX1ZDQV9TRVRUSU5HMik7CiAKIAkJd3JpdGVsKGJsa2VvbF9kdXJhdGlvbiwg
ZC0+cmVncyArIERTSV9WSURfUENLX1RJTUUpOworCQkvKiBNYXggYnVyc3QgbGltaXQgKi8KIAkJ
d3JpdGVsKGJsa2VvbF9kdXJhdGlvbiAtIDYsIGQtPnJlZ3MgKyBEU0lfVklEX1ZDQV9TRVRUSU5H
MSk7CiAJfQogCiAJLyogTWF4aW11bSBsaW5lIGxpbWl0ICovCiAJdmFsID0gcmVhZGwoZC0+cmVn
cyArIERTSV9WSURfVkNBX1NFVFRJTkcyKTsKKwl2YWwgJj0gfkRTSV9WSURfVkNBX1NFVFRJTkcy
X01BWF9MSU5FX0xJTUlUX01BU0s7CiAJdmFsIHw9IGJsa2xpbmVfcGNrIDw8Ci0JCURTSV9WSURf
VkNBX1NFVFRJTkcyX0VYQUNUX0JVUlNUX0xJTUlUX1NISUZUOworCQlEU0lfVklEX1ZDQV9TRVRU
SU5HMl9NQVhfTElORV9MSU1JVF9TSElGVDsKIAl3cml0ZWwodmFsLCBkLT5yZWdzICsgRFNJX1ZJ
RF9WQ0FfU0VUVElORzIpOworCWRldl9kYmcoZC0+ZGV2LCAiYmxrbGluZSBwY2s6ICVkIGJ5dGVz
XG4iLCBibGtsaW5lX3Bjayk7CiAKIAkvKiBQdXQgSUYxIGludG8gdmlkZW8gbW9kZSAqLwogCXZh
bCA9IHJlYWRsKGQtPnJlZ3MgKyBEU0lfTUNUTF9NQUlOX0RBVEFfQ1RMKTsKQEAgLTY3OSw3ICs3
NzEsNiBAQCBzdGF0aWMgdm9pZCBtY2RlX2RzaV9icmlkZ2VfbW9kZV9zZXQoc3RydWN0IGRybV9i
cmlkZ2UgKmJyaWRnZSwKIAkJCQkgICAgIGNvbnN0IHN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICph
ZGopCiB7CiAJc3RydWN0IG1jZGVfZHNpICpkID0gYnJpZGdlX3RvX21jZGVfZHNpKGJyaWRnZSk7
Ci0JdW5zaWduZWQgbG9uZyBwaXhlbF9jbG9ja19oeiA9IG1vZGUtPmNsb2NrICogMTAwMDsKIAl1
bnNpZ25lZCBsb25nIGhzX2ZyZXEsIGxwX2ZyZXE7CiAJdTMyIHZhbDsKIAlpbnQgcmV0OwpAQCAt
Njg4LDkgKzc3OSw4IEBAIHN0YXRpYyB2b2lkIG1jZGVfZHNpX2JyaWRnZV9tb2RlX3NldChzdHJ1
Y3QgZHJtX2JyaWRnZSAqYnJpZGdlLAogCQlkZXZfZXJyKGQtPmRldiwgIm5vIERTSSBkZXZpY2Ug
YXR0YWNoZWQgdG8gZW5jb2RlciFcbiIpOwogCQlyZXR1cm47CiAJfQotCi0JZGV2X2luZm8oZC0+
ZGV2LCAic2V0IERTSSBtYXN0ZXIgdG8gJWR4JWQgJWx1IEh6ICVzIG1vZGVcbiIsCi0JCSBtb2Rl
LT5oZGlzcGxheSwgbW9kZS0+dmRpc3BsYXksIHBpeGVsX2Nsb2NrX2h6LAorCWRldl9pbmZvKGQt
PmRldiwgInNldCBEU0kgbWFzdGVyIHRvICVkeCVkICVkIEh6ICVzIG1vZGVcbiIsCisJCSBtb2Rl
LT5oZGlzcGxheSwgbW9kZS0+dmRpc3BsYXksIG1vZGUtPmNsb2NrICogMTAwMCwKIAkJIChkLT5t
ZHNpLT5tb2RlX2ZsYWdzICYgTUlQSV9EU0lfTU9ERV9WSURFTykgPyAiVklERU8iIDogIkNNRCIK
IAkJKTsKIAotLSAKMi4yMS4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVz
a3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9k
cmktZGV2ZWw=
