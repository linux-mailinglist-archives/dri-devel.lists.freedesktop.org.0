Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C351814857C
	for <lists+dri-devel@lfdr.de>; Fri, 24 Jan 2020 13:56:44 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7E61072A49;
	Fri, 24 Jan 2020 12:56:40 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8CB146FA54;
 Fri, 24 Jan 2020 12:56:38 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19995095-1500050 
 for multiple; Fri, 24 Jan 2020 12:56:28 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH 1/2] drm: Release filp before global lock
Date: Fri, 24 Jan 2020 12:56:26 +0000
Message-Id: <20200124125627.125042-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.25.0
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: daniel.vetter@ffwll.ch, intel-gfx@lists.freedesktop.org,
 =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas_os@shipmail.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhlIGZpbGUgaXMgbm90IHBhcnQgb2YgdGhlIGdsb2JhbCBkcm0gcmVzb3VyY2UgYW5kIGNhbiBi
ZSByZWxlYXNlZApwcmlvciB0byB0YWtlIHRoZSBnbG9iYWwgbXV0ZXggdG8gZHJvcCB0aGUgb3Bl
bl9jb3VudCAoYW5kIHBvdGVudGlhbGx5CmNsb3NlKSB0aGUgZHJtIGRldmljZS4gQXMgdGhlIGds
b2JhbCBtdXRleCBpcyBpbmRlZWQgZ2xvYmFsLCBub3Qgb25seQp3aXRoaW4gdGhlIGRldmljZSBi
dXQgYWNyb3NzIGRldmljZXMsIGEgc2xvdyBmaWxlIHJlbGVhc2UgbWVjaGFuaXNtIGNhbgpib3R0
bGVuZWNrIHRoZSBlbnRpcmUgc3lzdGVtLgoKSG93ZXZlciwgaW5zaWRlIGRybV9jbG9zZV9oZWxw
ZXIoKSB0aGVyZSBhcmUgYSBudW1iZXIgb2YgZGV2LT5kcml2ZXIKY2FsbGJhY2tzIHRoYXQgdGFr
ZSB0aGUgZHJtX2RldmljZSBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLi4uIFdvcnJ5aW5nbHkKc29t
ZSBvZiB0aG9zZSBjYWxsYmFja3MgbWF5IGJlIChpbXBsaWNpdGx5KSBkZXBlbmRpbmcgb24gdGhl
IGdsb2JhbAptdXRleC4KCnYyOiBEcm9wIHRoZSBkZWJ1ZyBtZXNzYWdlIGZvciB0aGUgb3Blbi1j
b3VudCwgaXQncyBpbmNsdWRlZCB3aXRoIHRoZQpkcm1fZmlsZV9mcmVlKCkgZGVidWcgbWVzc2Fn
ZSAtLSBhbmQgZm9yIGdvb2QgbWVhc3VyZSBtYWtlIHRoYXQgdXAgYXMKcmVhZGluZyBvdXRzaWRl
IG9mIHRoZSBtdXRleC4KCnYzOiBTZXBhcmF0ZSB0aGUgY2FsbGluZyBvZiB0aGUgZmlscCBjbGVh
bnVwIG91dHNpZGUgb2YKZHJtX2dsb2JhbF9tdXRleCBpbnRvIGEgbmV3IGRybV9yZWxlYXNlX25v
Z2xvYmFsKCkgaG9vaywgc28gdGhhdCB3ZSBjYW4KcGhhc2UgdGhlIHRyYW5zaXRpb24uIGRybS9z
YXZhZ2UgcmVsaWVzIG9uIHRoZSBnbG9iYWwgbXV0ZXgsIGFuZCB0aGVyZQptYXkgYmUgbW9yZSwg
c28gYmUgY2F1dGlvdXMuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpcyBXaWxzb24gPGNocmlzQGNocmlz
LXdpbHNvbi5jby51az4KQ2M6IFRob21hcyBIZWxsc3Ryw7ZtIChWTXdhcmUpIDx0aG9tYXNfb3NA
c2hpcG1haWwub3JnPgpBY2tlZC1ieTogVGhvbWFzIEhlbGxzdHLDtm0gKFZNd2FyZSkgPHRob21h
c19vc0BzaGlwbWFpbC5vcmc+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2RybV9maWxlLmMgICAgICB8
IDM2ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrLQogZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9kcnYuYyB8ICAyICstCiBpbmNsdWRlL2RybS9kcm1fZmlsZS5oICAgICAgICAgIHwg
IDEgKwogMyBmaWxlcyBjaGFuZ2VkLCAzNyBpbnNlcnRpb25zKCspLCAyIGRlbGV0aW9ucygtKQoK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmlsZS5jIGIvZHJpdmVycy9ncHUvZHJt
L2RybV9maWxlLmMKaW5kZXggOTJkMTY3MjRmOTQ5Li5lMjUzMDZjNDljYzYgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9kcm1fZmlsZS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmls
ZS5jCkBAIC0yMjAsNyArMjIwLDcgQEAgdm9pZCBkcm1fZmlsZV9mcmVlKHN0cnVjdCBkcm1fZmls
ZSAqZmlsZSkKIAlEUk1fREVCVUcoInBpZCA9ICVkLCBkZXZpY2UgPSAweCVseCwgb3Blbl9jb3Vu
dCA9ICVkXG4iLAogCQkgIHRhc2tfcGlkX25yKGN1cnJlbnQpLAogCQkgIChsb25nKW9sZF9lbmNv
ZGVfZGV2KGZpbGUtPm1pbm9yLT5rZGV2LT5kZXZ0KSwKLQkJICBkZXYtPm9wZW5fY291bnQpOwor
CQkgIFJFQURfT05DRShkZXYtPm9wZW5fY291bnQpKTsKIAogCWlmIChkcm1fY29yZV9jaGVja19m
ZWF0dXJlKGRldiwgRFJJVkVSX0xFR0FDWSkgJiYKIAkgICAgZGV2LT5kcml2ZXItPnByZWNsb3Nl
KQpAQCAtNDU1LDYgKzQ1NSw0MCBAQCBpbnQgZHJtX3JlbGVhc2Uoc3RydWN0IGlub2RlICppbm9k
ZSwgc3RydWN0IGZpbGUgKmZpbHApCiB9CiBFWFBPUlRfU1lNQk9MKGRybV9yZWxlYXNlKTsKIAor
LyoqCisgKiBkcm1fcmVsZWFzZV9ub2dsb2JhbCAtIHJlbGVhc2UgbWV0aG9kIGZvciBEUk0gZmls
ZQorICogQGlub2RlOiBkZXZpY2UgaW5vZGUKKyAqIEBmaWxwOiBmaWxlIHBvaW50ZXIuCisgKgor
ICogVGhpcyBmdW5jdGlvbiBtYXkgYmUgdXNlZCBieSBkcml2ZXJzIGFzIHRoZWlyICZmaWxlX29w
ZXJhdGlvbnMucmVsZWFzZQorICogbWV0aG9kLiBJdCBmcmVlcyBhbnkgcmVzb3VyY2VzIGFzc29j
aWF0ZWQgd2l0aCB0aGUgb3BlbiBmaWxlIHByaW9yIHRvIHRha2luZworICogdGhlIGRybV9nbG9i
YWxfbXV0ZXgsIHdoaWNoIHRoZW4gY2FsbHMgdGhlICZkcm1fZHJpdmVyLnBvc3RjbG9zZSBkcml2
ZXIKKyAqIGNhbGxiYWNrLiBJZiB0aGlzIGlzIHRoZSBsYXN0IG9wZW4gZmlsZSBmb3IgdGhlIERS
TSBkZXZpY2UgYWxzbyBwcm9jZWVkcyB0bworICogY2FsbCB0aGUgJmRybV9kcml2ZXIubGFzdGNs
b3NlIGRyaXZlciBjYWxsYmFjay4KKyAqCisgKiBSRVRVUk5TOgorICoKKyAqIEFsd2F5cyBzdWNj
ZWVkcyBhbmQgcmV0dXJucyAwLgorICovCitpbnQgZHJtX3JlbGVhc2Vfbm9nbG9iYWwoc3RydWN0
IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUgKmZpbHApCit7CisJc3RydWN0IGRybV9maWxlICpm
aWxlX3ByaXYgPSBmaWxwLT5wcml2YXRlX2RhdGE7CisJc3RydWN0IGRybV9taW5vciAqbWlub3Ig
PSBmaWxlX3ByaXYtPm1pbm9yOworCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBtaW5vci0+ZGV2
OworCisJZHJtX2Nsb3NlX2hlbHBlcihmaWxwKTsKKworCW11dGV4X2xvY2soJmRybV9nbG9iYWxf
bXV0ZXgpOworCWlmICghLS1kZXYtPm9wZW5fY291bnQpCisJCWRybV9sYXN0Y2xvc2UoZGV2KTsK
KwltdXRleF91bmxvY2soJmRybV9nbG9iYWxfbXV0ZXgpOworCisJZHJtX21pbm9yX3JlbGVhc2Uo
bWlub3IpOworCisJcmV0dXJuIDA7Cit9CitFWFBPUlRfU1lNQk9MKGRybV9yZWxlYXNlX25vZ2xv
YmFsKTsKKwogLyoqCiAgKiBkcm1fcmVhZCAtIHJlYWQgbWV0aG9kIGZvciBEUk0gZmlsZQogICog
QGZpbHA6IGZpbGUgcG9pbnRlcgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9kcnYuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfZHJ2LmMKaW5kZXggZTliNDJlOTYy
MDMyLi41YTU4NDZkODkyZjQgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVf
ZHJ2LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9kcnYuYwpAQCAtMjY3Myw3ICsy
NjczLDcgQEAgY29uc3Qgc3RydWN0IGRldl9wbV9vcHMgaTkxNV9wbV9vcHMgPSB7CiBzdGF0aWMg
Y29uc3Qgc3RydWN0IGZpbGVfb3BlcmF0aW9ucyBpOTE1X2RyaXZlcl9mb3BzID0gewogCS5vd25l
ciA9IFRISVNfTU9EVUxFLAogCS5vcGVuID0gZHJtX29wZW4sCi0JLnJlbGVhc2UgPSBkcm1fcmVs
ZWFzZSwKKwkucmVsZWFzZSA9IGRybV9yZWxlYXNlX25vZ2xvYmFsLAogCS51bmxvY2tlZF9pb2N0
bCA9IGRybV9pb2N0bCwKIAkubW1hcCA9IGk5MTVfZ2VtX21tYXAsCiAJLnBvbGwgPSBkcm1fcG9s
bCwKZGlmZiAtLWdpdCBhL2luY2x1ZGUvZHJtL2RybV9maWxlLmggYi9pbmNsdWRlL2RybS9kcm1f
ZmlsZS5oCmluZGV4IDhiMDk5YjM0NzgxNy4uMTlkZjgwMjhhNmM0IDEwMDY0NAotLS0gYS9pbmNs
dWRlL2RybS9kcm1fZmlsZS5oCisrKyBiL2luY2x1ZGUvZHJtL2RybV9maWxlLmgKQEAgLTM3NCw2
ICszNzQsNyBAQCBpbnQgZHJtX29wZW4oc3RydWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUg
KmZpbHApOwogc3NpemVfdCBkcm1fcmVhZChzdHJ1Y3QgZmlsZSAqZmlscCwgY2hhciBfX3VzZXIg
KmJ1ZmZlciwKIAkJIHNpemVfdCBjb3VudCwgbG9mZl90ICpvZmZzZXQpOwogaW50IGRybV9yZWxl
YXNlKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxwKTsKK2ludCBkcm1fcmVs
ZWFzZV9ub2dsb2JhbChzdHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmlsZSAqZmlscCk7CiBf
X3BvbGxfdCBkcm1fcG9sbChzdHJ1Y3QgZmlsZSAqZmlscCwgc3RydWN0IHBvbGxfdGFibGVfc3Ry
dWN0ICp3YWl0KTsKIGludCBkcm1fZXZlbnRfcmVzZXJ2ZV9pbml0X2xvY2tlZChzdHJ1Y3QgZHJt
X2RldmljZSAqZGV2LAogCQkJCSAgc3RydWN0IGRybV9maWxlICpmaWxlX3ByaXYsCi0tIAoyLjI1
LjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1k
ZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczov
L2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
