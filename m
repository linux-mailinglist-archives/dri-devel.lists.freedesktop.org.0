Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 5CCB32820EE
	for <lists+dri-devel@lfdr.de>; Sat,  3 Oct 2020 06:03:22 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 39AED6EA3A;
	Sat,  3 Oct 2020 04:03:19 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pj1-x1042.google.com (mail-pj1-x1042.google.com
 [IPv6:2607:f8b0:4864:20::1042])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1A2E46EA3A
 for <dri-devel@lists.freedesktop.org>; Sat,  3 Oct 2020 04:03:18 +0000 (UTC)
Received: by mail-pj1-x1042.google.com with SMTP id x2so2146124pjk.0
 for <dri-devel@lists.freedesktop.org>; Fri, 02 Oct 2020 21:03:18 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=tpTaD+pd4ck4bVP3jdYyxJbjW42E08ISZPU7AHa+XuI=;
 b=iCtAp16i2PFqCuAtAc95pctbZClTzNcfeELmUCYBbz+JDgZFdJjc0ge+UW+FHMbNfh
 UrI0haS/vXZV+aUY9NLhpLM8R1G9G10iO44wZ5pKo1Ojd2xDJqr+TaMTIu2j1nU3hN3+
 L6cXOWui/1+aw3xCcYDN4c9ohitsWYOwJkOUXSWRf0mjoGhfuqIAg/i94L09LkwUxsP5
 I7gYH7jrY6i3VFNxRuwHqfW97kkF3mF3eGO550s63rK3LzEGo1fu/DIAVXsLAHd997bd
 WH30VF3FZrXEq4+mV31Yt9rgnaJ3ivCqg1/j3J6vmLZO2pIqYUP7v1SnRqJ975C38mN4
 cvwg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=tpTaD+pd4ck4bVP3jdYyxJbjW42E08ISZPU7AHa+XuI=;
 b=JdZFZ3OHxN7NVUJj98bLXQkrJEHXT9zQkLoOcW8OsyFixtBVYK6VSjLaMG2pJ1ztYP
 EHft+5gPs8FrczB3YsPVDVKmThpprmT16cA96FjN0TMh1S35WUKgHr+jSh5Pvx8BeL7t
 pLrEI4jnLwkss3Hxkeuipw4PkXhW00pt2BBn5iy2inpjQk9j4Id/C15AzUkYfmLQ/Mwm
 Yqe9e3JHXGBSFO8shqA+HErJTxGTYF/PqSPIUPTbuzV1EAcvfrheW0h+bxqAeg3KtO/j
 hfqESYonXG07dtxR2Z1llA7EaPpyfYkC1nvPg+3udvVE+kFe5kH2zTWWxn48y6oQYmGp
 l8CQ==
X-Gm-Message-State: AOAM532kxBN/TKs5fkrB5vgAmJoXQexY9dzWUXIh4s0N5k9Ecaoy6li3
 OByESJaGjJoyu4lkfBrn/cHiYQ==
X-Google-Smtp-Source: ABdhPJxtWqhtvVCWUchRdru+/v7VgHdom2HPrTSSjkwt5rvTB7sDHJfAy64XBhzTdVSAJlo5uf1IMA==
X-Received: by 2002:a17:90a:da06:: with SMTP id e6mr5906398pjv.8.1601697797650; 
 Fri, 02 Oct 2020 21:03:17 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 190sm3909290pfy.22.2020.10.02.21.03.15
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 02 Oct 2020 21:03:16 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v3 7/7] dma-buf: system_heap: Add a system-uncached heap
 re-using the system heap
Date: Sat,  3 Oct 2020 04:02:57 +0000
Message-Id: <20201003040257.62768-8-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20201003040257.62768-1-john.stultz@linaro.org>
References: <20201003040257.62768-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sandeep Patil <sspatil@google.com>, dri-devel@lists.freedesktop.org,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Chris Goldsworthy <cgoldswo@codeaurora.org>,
 Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 linux-media@vger.kernel.org, Suren Baghdasaryan <surenb@google.com>,
 Daniel Mentz <danielmentz@google.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBhZGRzIGEgaGVhcCB0aGF0IGFsbG9jYXRlcyBub24tY29udGlndW91cyBidWZmZXJzIHRo
YXQgYXJlCm1hcmtlZCBhcyB3cml0ZWNvbWJpbmVkLCBzbyB0aGV5IGFyZSBub3QgY2FjaGVkIGJ5
IHRoZSBDUFUuCgpUaGlzIGlzIHVzZWZ1bCwgYXMgbW9zdCBncmFwaGljcyBidWZmZXJzIGFyZSB1
c3VhbGx5IG5vdCB0b3VjaGVkCmJ5IHRoZSBDUFUgb3Igb25seSB3cml0dGVuIGludG8gb25jZSBi
eSB0aGUgQ1BVLiBTbyB3aGVuIG1hcHBpbmcKdGhlIGJ1ZmZlciBvdmVyIGFuZCBvdmVyIGJldHdl
ZW4gZGV2aWNlcywgd2UgY2FuIHNraXAgdGhlIENQVQpzeW5jaW5nLCB3aGljaCBzYXZlcyBhIGxv
dCBvZiBjYWNoZSBtYW5hZ2VtZW50IG92ZXJoZWFkLCBncmVhdGx5CmltcHJvdmluZyBwZXJmb3Jt
YW5jZS4KCkZvciBmb2xrIHVzaW5nIElPTiwgdGhlcmUgd2FzIGEgSU9OX0ZMQUdfQ0FDSEVEIGZs
YWcsIHdoaWNoCnNpZ25hbGVkIGlmIHRoZSByZXR1cm5lZCBidWZmZXIgc2hvdWxkIGJlIENQVSBj
YWNoZWFibGUgb3Igbm90LgpXaXRoIERNQS1CVUYgaGVhcHMsIHdlIGRvIG5vdCB5ZXQgaGF2ZSBz
dWNoIGEgZmxhZywgYW5kIGJ5IGRlZmF1bHQKdGhlIGN1cnJlbnQgaGVhcHMgKHN5c3RlbSBhbmQg
Y21hKSBwcm9kdWNlIENQVSBjYWNoYWJsZSBidWZmZXJzLgpTbyBmb3IgZm9sa3MgdHJhbnNpdGlv
bmluZyBmcm9tIElPTiB0byBETUEtQlVGIEhlYXBzLCB0aGlzIGZpbGxzCmluIHNvbWUgb2YgdGhh
dCBtaXNzaW5nIGZ1bmN0aW9uYWxpdHkuCgpUaGVyZSBoYXMgYmVlbiBhIHN1Z2dlc3Rpb24gdG8g
bWFrZSB0aGlzIGZ1bmN0aW9uYWxpdHkgYSBmbGFnCihETUFIRUFQX0ZMQUdfVU5DQUNIRUQ/KSBv
biB0aGUgc3lzdGVtIGhlYXAsIHNpbWlsYXIgdG8gaG93CklPTiB1c2VkIHRoZSBJT05fRkxBR19D
QUNIRUQuIEJ1dCBJIHdhbnQgdG8gbWFrZSBzdXJlIGFuCl9VTkNBQ0hFRCBmbGFnIHdvdWxkIHRy
dWVseSBiZSBhIGdlbmVyaWMgYXR0cmlidXRlIGFjcm9zcyBhbGwKaGVhcHMuIFNvIGZhciB0aGF0
IGhhcyBiZWVuIHVuY2xlYXIsIHNvIGhhdmluZyBpdCBhcyBhIHNlcGFyYXRlCmhlYXAgc2VlbWVz
IGJldHRlciBmb3Igbm93LiAoQnV0IEknbSBvcGVuIHRvIGRpc2N1c3Npb24gb24gdGhpcwpwb2lu
dCEpCgpUaGlzIGlzIGEgcmV3b3JrIG9mIGVhcmxpZXIgZWZmb3J0cyB0byBhZGQgYSB1bmNhY2hl
ZCBzeXN0ZW0gaGVhcCwKZG9uZSB1dGlsaXppbmcgdGhlIGV4aXNpdG5nIHN5c3RlbSBoZWFwLCBh
ZGRpbmcganVzdCBhIGJpdCBvZgpsb2dpYyB0byBoYW5kbGUgdGhlIHVuY2FjaGVkIGNhc2UuCgpG
ZWVkYmFjayB3b3VsZCBiZSB2ZXJ5IHdlbGNvbWUhCgpNYW55IHRoYW5rcyB0byBMaWFtIE1hcmsg
Zm9yIGhpcyBoZWxwIHRvIGdldCB0aGlzIHdvcmtpbmcuCgpQZW5kaW5nIG9wZW5zb3VyY2UgdXNl
cnMgb2YgdGhpcyBjb2RlIGluY2x1ZGU6CiogQU9TUCBIaUtleTk2MCBncmFsbG9jOgogIC0gaHR0
cHM6Ly9hbmRyb2lkLXJldmlldy5nb29nbGVzb3VyY2UuY29tL2MvZGV2aWNlL2xpbmFyby9oaWtl
eS8rLzEzOTk1MTkKICAtIFZpc2libHkgaW1wcm92ZXMgcGVyZm9ybWFuY2Ugb3ZlciB0aGUgc3lz
dGVtIGhlYXAKKiBBT1NQIENvZGVjMiAocG9zc2libHksIG5lZWRzIG1vcmUgcmV2aWV3KToKICAt
IGh0dHBzOi8vYW5kcm9pZC1yZXZpZXcuZ29vZ2xlc291cmNlLmNvbS9jL3BsYXRmb3JtL2ZyYW1l
d29ya3MvYXYvKy8xMzYwNjQwLzE3L21lZGlhL2NvZGVjMi92bmRrL0MyRG1hQnVmQWxsb2NhdG9y
LmNwcCMzMjUKCkNjOiBTdW1pdCBTZW13YWwgPHN1bWl0LnNlbXdhbEBsaW5hcm8ub3JnPgpDYzog
TGlhbSBNYXJrIDxsbWFya0Bjb2RlYXVyb3JhLm9yZz4KQ2M6IExhdXJhIEFiYm90dCA8bGFiYm90
dEBrZXJuZWwub3JnPgpDYzogQnJpYW4gU3RhcmtleSA8QnJpYW4uU3RhcmtleUBhcm0uY29tPgpD
YzogSHJpZHlhIFZhbHNhcmFqdSA8aHJpZHlhQGdvb2dsZS5jb20+CkNjOiBTdXJlbiBCYWdoZGFz
YXJ5YW4gPHN1cmVuYkBnb29nbGUuY29tPgpDYzogU2FuZGVlcCBQYXRpbCA8c3NwYXRpbEBnb29n
bGUuY29tPgpDYzogRGFuaWVsIE1lbnR6IDxkYW5pZWxtZW50ekBnb29nbGUuY29tPgpDYzogQ2hy
aXMgR29sZHN3b3J0aHkgPGNnb2xkc3dvQGNvZGVhdXJvcmEub3JnPgpDYzogw5hyamFuIEVpZGUg
PG9yamFuLmVpZGVAYXJtLmNvbT4KQ2M6IFJvYmluIE11cnBoeSA8cm9iaW4ubXVycGh5QGFybS5j
b20+CkNjOiBFemVxdWllbCBHYXJjaWEgPGV6ZXF1aWVsQGNvbGxhYm9yYS5jb20+CkNjOiBTaW1v
biBTZXIgPGNvbnRhY3RAZW1lcnNpb24uZnI+CkNjOiBKYW1lcyBKb25lcyA8amFqb25lc0Budmlk
aWEuY29tPgpDYzogbGludXgtbWVkaWFAdmdlci5rZXJuZWwub3JnCkNjOiBkcmktZGV2ZWxAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnClNpZ25lZC1vZmYtYnk6IEpvaG4gU3R1bHR6IDxqb2huLnN0dWx0
ekBsaW5hcm8ub3JnPgotLS0KIGRyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9zeXN0ZW1faGVhcC5jIHwg
ODcgKysrKysrKysrKysrKysrKysrKysrKysrKystLS0KIDEgZmlsZSBjaGFuZ2VkLCA3OSBpbnNl
cnRpb25zKCspLCA4IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9o
ZWFwcy9zeXN0ZW1faGVhcC5jIGIvZHJpdmVycy9kbWEtYnVmL2hlYXBzL3N5c3RlbV9oZWFwLmMK
aW5kZXggMmI4ZDRiNmFiYWNiLi45NTJmMWZkOWRhY2YgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZG1h
LWJ1Zi9oZWFwcy9zeXN0ZW1faGVhcC5jCisrKyBiL2RyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9zeXN0
ZW1faGVhcC5jCkBAIC0yMiw2ICsyMiw3IEBACiAjaW5jbHVkZSA8bGludXgvdm1hbGxvYy5oPgog
CiBzdHJ1Y3QgZG1hX2hlYXAgKnN5c19oZWFwOworc3RydWN0IGRtYV9oZWFwICpzeXNfdW5jYWNo
ZWRfaGVhcDsKIAogc3RydWN0IHN5c3RlbV9oZWFwX2J1ZmZlciB7CiAJc3RydWN0IGRtYV9oZWFw
ICpoZWFwOwpAQCAtMzEsNiArMzIsOCBAQCBzdHJ1Y3Qgc3lzdGVtX2hlYXBfYnVmZmVyIHsKIAlz
dHJ1Y3Qgc2dfdGFibGUgc2dfdGFibGU7CiAJaW50IHZtYXBfY250OwogCXZvaWQgKnZhZGRyOwor
CisJYm9vbCB1bmNhY2hlZDsKIH07CiAKIHN0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50IHsKQEAg
LTM4LDYgKzQxLDggQEAgc3RydWN0IGRtYV9oZWFwX2F0dGFjaG1lbnQgewogCXN0cnVjdCBzZ190
YWJsZSAqdGFibGU7CiAJc3RydWN0IGxpc3RfaGVhZCBsaXN0OwogCWJvb2wgbWFwcGVkOworCisJ
Ym9vbCB1bmNhY2hlZDsKIH07CiAKICNkZWZpbmUgSElHSF9PUkRFUl9HRlAgICgoKEdGUF9ISUdI
VVNFUiB8IF9fR0ZQX1pFUk8gfCBfX0dGUF9OT1dBUk4gXApAQCAtOTQsNyArOTksNyBAQCBzdGF0
aWMgaW50IHN5c3RlbV9oZWFwX2F0dGFjaChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAogCWEtPmRl
diA9IGF0dGFjaG1lbnQtPmRldjsKIAlJTklUX0xJU1RfSEVBRCgmYS0+bGlzdCk7CiAJYS0+bWFw
cGVkID0gZmFsc2U7Ci0KKwlhLT51bmNhY2hlZCA9IGJ1ZmZlci0+dW5jYWNoZWQ7CiAJYXR0YWNo
bWVudC0+cHJpdiA9IGE7CiAKIAltdXRleF9sb2NrKCZidWZmZXItPmxvY2spOwpAQCAtMTI0LDkg
KzEyOSwxMyBAQCBzdGF0aWMgc3RydWN0IHNnX3RhYmxlICpzeXN0ZW1faGVhcF9tYXBfZG1hX2J1
ZihzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhYwogewogCXN0cnVjdCBkbWFfaGVhcF9h
dHRhY2htZW50ICphID0gYXR0YWNobWVudC0+cHJpdjsKIAlzdHJ1Y3Qgc2dfdGFibGUgKnRhYmxl
ID0gYS0+dGFibGU7CisJaW50IGF0dHIgPSAwOwogCWludCByZXQ7CiAKLQlyZXQgPSBkbWFfbWFw
X3NndGFibGUoYXR0YWNobWVudC0+ZGV2LCB0YWJsZSwgZGlyZWN0aW9uLCAwKTsKKwlpZiAoYS0+
dW5jYWNoZWQpCisJCWF0dHIgPSBETUFfQVRUUl9TS0lQX0NQVV9TWU5DOworCisJcmV0ID0gZG1h
X21hcF9zZ3RhYmxlKGF0dGFjaG1lbnQtPmRldiwgdGFibGUsIGRpcmVjdGlvbiwgYXR0cik7CiAJ
aWYgKHJldCkKIAkJcmV0dXJuIEVSUl9QVFIocmV0KTsKIApAQCAtMTM5LDkgKzE0OCwxMiBAQCBz
dGF0aWMgdm9pZCBzeXN0ZW1faGVhcF91bm1hcF9kbWFfYnVmKHN0cnVjdCBkbWFfYnVmX2F0dGFj
aG1lbnQgKmF0dGFjaG1lbnQsCiAJCQkJICAgICAgZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24gZGly
ZWN0aW9uKQogewogCXN0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50ICphID0gYXR0YWNobWVudC0+
cHJpdjsKKwlpbnQgYXR0ciA9IDA7CiAKKwlpZiAoYS0+dW5jYWNoZWQpCisJCWF0dHIgPSBETUFf
QVRUUl9TS0lQX0NQVV9TWU5DOwogCWEtPm1hcHBlZCA9IGZhbHNlOwotCWRtYV91bm1hcF9zZ3Rh
YmxlKGF0dGFjaG1lbnQtPmRldiwgdGFibGUsIGRpcmVjdGlvbiwgMCk7CisJZG1hX3VubWFwX3Nn
dGFibGUoYXR0YWNobWVudC0+ZGV2LCB0YWJsZSwgZGlyZWN0aW9uLCBhdHRyKTsKIH0KIAogc3Rh
dGljIGludCBzeXN0ZW1faGVhcF9kbWFfYnVmX2JlZ2luX2NwdV9hY2Nlc3Moc3RydWN0IGRtYV9i
dWYgKmRtYWJ1ZiwKQEAgLTE1MCw2ICsxNjIsOSBAQCBzdGF0aWMgaW50IHN5c3RlbV9oZWFwX2Rt
YV9idWZfYmVnaW5fY3B1X2FjY2VzcyhzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAogCXN0cnVjdCBz
eXN0ZW1faGVhcF9idWZmZXIgKmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKIAlzdHJ1Y3QgZG1hX2hl
YXBfYXR0YWNobWVudCAqYTsKIAorCWlmIChidWZmZXItPnVuY2FjaGVkKQorCQlyZXR1cm4gMDsK
KwogCW11dGV4X2xvY2soJmJ1ZmZlci0+bG9jayk7CiAKIAlpZiAoYnVmZmVyLT52bWFwX2NudCkK
QEAgLTE3MSw2ICsxODYsOSBAQCBzdGF0aWMgaW50IHN5c3RlbV9oZWFwX2RtYV9idWZfZW5kX2Nw
dV9hY2Nlc3Moc3RydWN0IGRtYV9idWYgKmRtYWJ1ZiwKIAlzdHJ1Y3Qgc3lzdGVtX2hlYXBfYnVm
ZmVyICpidWZmZXIgPSBkbWFidWYtPnByaXY7CiAJc3RydWN0IGRtYV9oZWFwX2F0dGFjaG1lbnQg
KmE7CiAKKwlpZiAoYnVmZmVyLT51bmNhY2hlZCkKKwkJcmV0dXJuIDA7CisKIAltdXRleF9sb2Nr
KCZidWZmZXItPmxvY2spOwogCiAJaWYgKGJ1ZmZlci0+dm1hcF9jbnQpCkBAIC0xOTQsNiArMjEy
LDkgQEAgc3RhdGljIGludCBzeXN0ZW1faGVhcF9tbWFwKHN0cnVjdCBkbWFfYnVmICpkbWFidWYs
IHN0cnVjdCB2bV9hcmVhX3N0cnVjdCAqdm1hKQogCXN0cnVjdCBzZ19wYWdlX2l0ZXIgcGl0ZXI7
CiAJaW50IHJldDsKIAorCWlmIChidWZmZXItPnVuY2FjaGVkKQorCQl2bWEtPnZtX3BhZ2VfcHJv
dCA9IHBncHJvdF93cml0ZWNvbWJpbmUodm1hLT52bV9wYWdlX3Byb3QpOworCiAJZm9yX2VhY2hf
c2d0YWJsZV9wYWdlKHRhYmxlLCAmcGl0ZXIsIHZtYS0+dm1fcGdvZmYpIHsKIAkJc3RydWN0IHBh
Z2UgKnBhZ2UgPSBzZ19wYWdlX2l0ZXJfcGFnZSgmcGl0ZXIpOwogCkBAIC0yMTUsOCArMjM2LDEy
IEBAIHN0YXRpYyB2b2lkICpzeXN0ZW1faGVhcF9kb192bWFwKHN0cnVjdCBzeXN0ZW1faGVhcF9i
dWZmZXIgKmJ1ZmZlcikKIAlzdHJ1Y3QgcGFnZSAqKnBhZ2VzID0gdm1hbGxvYyhzaXplb2Yoc3Ry
dWN0IHBhZ2UgKikgKiBucGFnZXMpOwogCXN0cnVjdCBwYWdlICoqdG1wID0gcGFnZXM7CiAJc3Ry
dWN0IHNnX3BhZ2VfaXRlciBwaXRlcjsKKwlwZ3Byb3RfdCBwZ3Byb3QgPSBQQUdFX0tFUk5FTDsK
IAl2b2lkICp2YWRkcjsKIAorCWlmIChidWZmZXItPnVuY2FjaGVkKQorCQlwZ3Byb3QgPSBwZ3By
b3Rfd3JpdGVjb21iaW5lKFBBR0VfS0VSTkVMKTsKKwogCWlmICghcGFnZXMpCiAJCXJldHVybiBF
UlJfUFRSKC1FTk9NRU0pOwogCkBAIC0yMjUsNyArMjUwLDcgQEAgc3RhdGljIHZvaWQgKnN5c3Rl
bV9oZWFwX2RvX3ZtYXAoc3RydWN0IHN5c3RlbV9oZWFwX2J1ZmZlciAqYnVmZmVyKQogCQkqdG1w
KysgPSBzZ19wYWdlX2l0ZXJfcGFnZSgmcGl0ZXIpOwogCX0KIAotCXZhZGRyID0gdm1hcChwYWdl
cywgbnBhZ2VzLCBWTV9NQVAsIFBBR0VfS0VSTkVMKTsKKwl2YWRkciA9IHZtYXAocGFnZXMsIG5w
YWdlcywgVk1fTUFQLCBwZ3Byb3QpOwogCXZmcmVlKHBhZ2VzKTsKIAogCWlmICghdmFkZHIpCkBA
IC0yNzgsNiArMzAzLDEwIEBAIHN0YXRpYyB2b2lkIHN5c3RlbV9oZWFwX2RtYV9idWZfcmVsZWFz
ZShzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmKQogCWludCBpOwogCiAJdGFibGUgPSAmYnVmZmVyLT5z
Z190YWJsZTsKKwkvKiBVbm1hcCB0aGUgdW5jYWNoZWQgYnVmZmVycyBmcm9tIHRoZSBoZWFwIGRl
dmljZSAocGFpcnMgd2l0aCB0aGUgbWFwIG9uIGFsbG9jYXRlKSAqLworCWlmIChidWZmZXItPnVu
Y2FjaGVkKQorCQlkbWFfdW5tYXBfc2d0YWJsZShkbWFfaGVhcF9nZXRfZGV2KGJ1ZmZlci0+aGVh
cCksIHRhYmxlLCBETUFfQklESVJFQ1RJT05BTCwgMCk7CisKIAlmb3JfZWFjaF9zZyh0YWJsZS0+
c2dsLCBzZywgdGFibGUtPm5lbnRzLCBpKSB7CiAJCXN0cnVjdCBwYWdlICpwYWdlID0gc2dfcGFn
ZShzZyk7CiAKQEAgLTMyMCwxMCArMzQ5LDExIEBAIHN0YXRpYyBzdHJ1Y3QgcGFnZSAqYWxsb2Nf
bGFyZ2VzdF9hdmFpbGFibGUodW5zaWduZWQgbG9uZyBzaXplLAogCXJldHVybiBOVUxMOwogfQog
Ci1zdGF0aWMgaW50IHN5c3RlbV9oZWFwX2FsbG9jYXRlKHN0cnVjdCBkbWFfaGVhcCAqaGVhcCwK
LQkJCQl1bnNpZ25lZCBsb25nIGxlbiwKLQkJCQl1bnNpZ25lZCBsb25nIGZkX2ZsYWdzLAotCQkJ
CXVuc2lnbmVkIGxvbmcgaGVhcF9mbGFncykKK3N0YXRpYyBpbnQgc3lzdGVtX2hlYXBfZG9fYWxs
b2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAorCQkJCSAgIHVuc2lnbmVkIGxvbmcgbGVuLAor
CQkJCSAgIHVuc2lnbmVkIGxvbmcgZmRfZmxhZ3MsCisJCQkJICAgdW5zaWduZWQgbG9uZyBoZWFw
X2ZsYWdzLAorCQkJCSAgIGJvb2wgdW5jYWNoZWQpCiB7CiAJc3RydWN0IHN5c3RlbV9oZWFwX2J1
ZmZlciAqYnVmZmVyOwogCURFRklORV9ETUFfQlVGX0VYUE9SVF9JTkZPKGV4cF9pbmZvKTsKQEAg
LTM0NCw2ICszNzQsNyBAQCBzdGF0aWMgaW50IHN5c3RlbV9oZWFwX2FsbG9jYXRlKHN0cnVjdCBk
bWFfaGVhcCAqaGVhcCwKIAltdXRleF9pbml0KCZidWZmZXItPmxvY2spOwogCWJ1ZmZlci0+aGVh
cCA9IGhlYXA7CiAJYnVmZmVyLT5sZW4gPSBsZW47CisJYnVmZmVyLT51bmNhY2hlZCA9IHVuY2Fj
aGVkOwogCiAJSU5JVF9MSVNUX0hFQUQoJnBhZ2VzKTsKIAlpID0gMDsKQEAgLTM5Myw2ICs0MjQs
MTYgQEAgc3RhdGljIGludCBzeXN0ZW1faGVhcF9hbGxvY2F0ZShzdHJ1Y3QgZG1hX2hlYXAgKmhl
YXAsCiAJCS8qIGp1c3QgcmV0dXJuLCBhcyBwdXQgd2lsbCBjYWxsIHJlbGVhc2UgYW5kIHRoYXQg
d2lsbCBmcmVlICovCiAJCXJldHVybiByZXQ7CiAJfQorCisJLyoKKwkgKiBGb3IgdW5jYWNoZWQg
YnVmZmVycywgd2UgbmVlZCB0byBpbml0aWFsbHkgZmx1c2ggY3B1IGNhY2hlLCBzaW5jZQorCSAq
IHRoZSBfX0dGUF9aRVJPIG9uIHRoZSBhbGxvY2F0aW9uIG1lYW5zIHRoZSB6ZXJvaW5nIHdhcyBk
b25lIGJ5IHRoZQorCSAqIGNwdSBhbmQgdGh1cyBpdCBpcyBsaWtlbHkgY2FjaGVkLiBNYXAgKGFu
ZCBpbXBsaWNpdGx5IGZsdXNoKSBpdCBvdXQKKwkgKiBub3cgc28gd2UgZG9uJ3QgZ2V0IGNvcnJ1
cHRpb24gbGF0ZXIgb24uCisJICovCisJaWYgKGJ1ZmZlci0+dW5jYWNoZWQpCisJCWRtYV9tYXBf
c2d0YWJsZShkbWFfaGVhcF9nZXRfZGV2KGhlYXApLCB0YWJsZSwgRE1BX0JJRElSRUNUSU9OQUws
IDApOworCiAJcmV0dXJuIHJldDsKIAogZnJlZV9wYWdlczoKQEAgLTQxMCwxMCArNDUxLDMwIEBA
IHN0YXRpYyBpbnQgc3lzdGVtX2hlYXBfYWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAog
CXJldHVybiByZXQ7CiB9CiAKK3N0YXRpYyBpbnQgc3lzdGVtX2hlYXBfYWxsb2NhdGUoc3RydWN0
IGRtYV9oZWFwICpoZWFwLAorCQkJCXVuc2lnbmVkIGxvbmcgbGVuLAorCQkJCXVuc2lnbmVkIGxv
bmcgZmRfZmxhZ3MsCisJCQkJdW5zaWduZWQgbG9uZyBoZWFwX2ZsYWdzKQoreworCXJldHVybiBz
eXN0ZW1faGVhcF9kb19hbGxvY2F0ZShoZWFwLCBsZW4sIGZkX2ZsYWdzLCBoZWFwX2ZsYWdzLCBm
YWxzZSk7Cit9CisKIHN0YXRpYyBjb25zdCBzdHJ1Y3QgZG1hX2hlYXBfb3BzIHN5c3RlbV9oZWFw
X29wcyA9IHsKIAkuYWxsb2NhdGUgPSBzeXN0ZW1faGVhcF9hbGxvY2F0ZSwKIH07CiAKK3N0YXRp
YyBpbnQgc3lzdGVtX3VuY2FjaGVkX2hlYXBfYWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFw
LAorCQkJCQkgdW5zaWduZWQgbG9uZyBsZW4sCisJCQkJCSB1bnNpZ25lZCBsb25nIGZkX2ZsYWdz
LAorCQkJCQkgdW5zaWduZWQgbG9uZyBoZWFwX2ZsYWdzKQoreworCXJldHVybiBzeXN0ZW1faGVh
cF9kb19hbGxvY2F0ZShoZWFwLCBsZW4sIGZkX2ZsYWdzLCBoZWFwX2ZsYWdzLCB0cnVlKTsKK30K
Kworc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfaGVhcF9vcHMgc3lzdGVtX3VuY2FjaGVkX2hlYXBf
b3BzID0geworCS5hbGxvY2F0ZSA9IHN5c3RlbV91bmNhY2hlZF9oZWFwX2FsbG9jYXRlLAorfTsK
Kwogc3RhdGljIGludCBzeXN0ZW1faGVhcF9jcmVhdGUodm9pZCkKIHsKIAlzdHJ1Y3QgZG1hX2hl
YXBfZXhwb3J0X2luZm8gZXhwX2luZm87CkBAIC00MjYsNiArNDg3LDE2IEBAIHN0YXRpYyBpbnQg
c3lzdGVtX2hlYXBfY3JlYXRlKHZvaWQpCiAJaWYgKElTX0VSUihzeXNfaGVhcCkpCiAJCXJldHVy
biBQVFJfRVJSKHN5c19oZWFwKTsKIAorCWV4cF9pbmZvLm5hbWUgPSAic3lzdGVtLXVuY2FjaGVk
IjsKKwlleHBfaW5mby5vcHMgPSAmc3lzdGVtX3VuY2FjaGVkX2hlYXBfb3BzOworCWV4cF9pbmZv
LnByaXYgPSBOVUxMOworCisJc3lzX3VuY2FjaGVkX2hlYXAgPSBkbWFfaGVhcF9hZGQoJmV4cF9p
bmZvKTsKKwlpZiAoSVNfRVJSKHN5c191bmNhY2hlZF9oZWFwKSkKKwkJcmV0dXJuIFBUUl9FUlIo
c3lzX2hlYXApOworCisJZG1hX2NvZXJjZV9tYXNrX2FuZF9jb2hlcmVudChkbWFfaGVhcF9nZXRf
ZGV2KHN5c191bmNhY2hlZF9oZWFwKSwgRE1BX0JJVF9NQVNLKDY0KSk7CisKIAlyZXR1cm4gMDsK
IH0KIG1vZHVsZV9pbml0KHN5c3RlbV9oZWFwX2NyZWF0ZSk7Ci0tIAoyLjE3LjEKCl9fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5n
IGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVk
ZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
