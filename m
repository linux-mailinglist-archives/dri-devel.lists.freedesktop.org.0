Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 90810834A2
	for <lists+dri-devel@lfdr.de>; Tue,  6 Aug 2019 17:01:54 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5BB306E3CE;
	Tue,  6 Aug 2019 15:01:48 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x441.google.com (mail-wr1-x441.google.com
 [IPv6:2a00:1450:4864:20::441])
 by gabe.freedesktop.org (Postfix) with ESMTPS id BA24A6E3BB;
 Tue,  6 Aug 2019 15:01:43 +0000 (UTC)
Received: by mail-wr1-x441.google.com with SMTP id c2so85015224wrm.8;
 Tue, 06 Aug 2019 08:01:43 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=zalB8gq1beSq4ta9XAvlbVYYxDTmwakxB9DRHWgejUg=;
 b=bKiHkqzBzPoVTOW9oEHqhYcZKI7EDvRC6qasEhxWo6ZcG6+mSt1HtYKi85gu2+znlZ
 CJeUH7KH0wdsuMfmeEgpGV2jCTQe3T0ZE6YfhM0xuGRR/KCN77YQHD5FNTF2skKt+S2D
 4LzXs/FygbEqKAoZum+qPDmvyaqLrjkfZkvL75oo9/uJuJqATNYNbiIYSsWVab7UIC7Z
 QdydSn6cXBfnxU4KrEATTFUUOxQeWOB0qAYu7+FMVKGidnQroZXRifioE/OruF6C3AOk
 cP++eqjnlZdlNpcwxmnJWgnRvv3elfDM5ctbetvWUMIavx1sUMAXnm4oCBpJ19fqrAnJ
 hknA==
X-Gm-Message-State: APjAAAXcbV9bZ1MPO/vPycEbD4ZSDdLmFvGLgfTNm6PRY4h7X04nccet
 mLDRtDfZwAbJViva0YABRi+wvtap
X-Google-Smtp-Source: APXvYqxNjBUNUdlpAUZmAps4Mc7pazvmhMfBuAZ95n4cdBgcJvyHIK/6o9C2G5roYiFhLj2ePURWiA==
X-Received: by 2002:adf:ea4c:: with SMTP id j12mr5533215wrn.75.1565103701601; 
 Tue, 06 Aug 2019 08:01:41 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:d1e0:fffc:b0e3:c66d])
 by smtp.gmail.com with ESMTPSA id g2sm78766828wmh.0.2019.08.06.08.01.40
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
 Tue, 06 Aug 2019 08:01:41 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: intel-gfx@lists.freedesktop.org, linaro-mm-sig@lists.linaro.org,
 dri-devel@lists.freedesktop.org, chris@chris-wilson.co.uk
Subject: [PATCH 7/8] dma-buf: add reservation_object_fences helper
Date: Tue,  6 Aug 2019 17:01:33 +0200
Message-Id: <20190806150134.104222-7-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190806150134.104222-1-christian.koenig@amd.com>
References: <20190806150134.104222-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references:mime-version
 :content-transfer-encoding;
 bh=zalB8gq1beSq4ta9XAvlbVYYxDTmwakxB9DRHWgejUg=;
 b=ZXS6v3F4t9G3Rblrcns1QtgET1Hg2p7hBG07F6V3LP5C7NQeSz04+/Zgp+SZezBKJr
 DSnzCvd+qTjpOw9SwkOYGHjdsrGR88Qh3B/VYjQMkS7J5U6NYw3/rYoGvNc3CpLMOmUf
 SSNGZHu0+l62OEJfyfA3kHm4F5ECdEeNs50LZQUhr16xSVnT03Q+Yp6dsaBe4WYVKCs5
 MTHXxBQSwfJqP00LCwbD05ZQoqsqM+pp1cf+BsFrRAfOrDm6+SUgszfyW6WOyG3yunoz
 aSVuH6dKhRE57qQR0VABlNK/wn+7/7tKHSMCrDeXr/aH1vtBc6AqfJLvp/Dj04RaztiU
 0JWw==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

QWRkIGEgbmV3IGhlbHBlciB0byBnZXQgYSBjb25zaXN0ZW50IHNldCBvZiBwb2ludGVycyBmcm9t
IHRoZSByZXNlcnZhdGlvbgpvYmplY3QuIFdoaWxlIGF0IGl0IGdyb3VwIGFsbCBhY2Nlc3MgaGVs
cGVycyB0b2dldGhlciBpbiB0aGUgaGVhZGVyIGZpbGUuCgpTaWduZWQtb2ZmLWJ5OiBDaHJpc3Rp
YW4gS8O2bmlnIDxjaHJpc3RpYW4ua29lbmlnQGFtZC5jb20+Ci0tLQogZHJpdmVycy9kbWEtYnVm
L2RtYS1idWYuYyAgICAgfCAgMjcgKystLS0tLS0KIGRyaXZlcnMvZG1hLWJ1Zi9yZXNlcnZhdGlv
bi5jIHwgIDYwICsrKysrKy0tLS0tLS0tLS0tLQogaW5jbHVkZS9saW51eC9yZXNlcnZhdGlvbi5o
ICAgfCAxMTMgKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLQogMyBmaWxlcyBjaGFu
Z2VkLCA5NCBpbnNlcnRpb25zKCspLCAxMDYgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9kbWEtYnVmL2RtYS1idWYuYyBiL2RyaXZlcnMvZG1hLWJ1Zi9kbWEtYnVmLmMKaW5kZXgg
ZjQ1YmZiMjllZjk2Li4wZDExYjNjYzk2MWUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZG1hLWJ1Zi9k
bWEtYnVmLmMKKysrIGIvZHJpdmVycy9kbWEtYnVmL2RtYS1idWYuYwpAQCAtMTk5LDcgKzE5OSw3
IEBAIHN0YXRpYyBfX3BvbGxfdCBkbWFfYnVmX3BvbGwoc3RydWN0IGZpbGUgKmZpbGUsIHBvbGxf
dGFibGUgKnBvbGwpCiAJc3RydWN0IHJlc2VydmF0aW9uX29iamVjdF9saXN0ICpmb2JqOwogCXN0
cnVjdCBkbWFfZmVuY2UgKmZlbmNlX2V4Y2w7CiAJX19wb2xsX3QgZXZlbnRzOwotCXVuc2lnbmVk
IHNoYXJlZF9jb3VudCwgc2VxOworCXVuc2lnbmVkIHNoYXJlZF9jb3VudDsKIAogCWRtYWJ1ZiA9
IGZpbGUtPnByaXZhdGVfZGF0YTsKIAlpZiAoIWRtYWJ1ZiB8fCAhZG1hYnVmLT5yZXN2KQpAQCAt
MjEzLDIwICsyMTMsMTIgQEAgc3RhdGljIF9fcG9sbF90IGRtYV9idWZfcG9sbChzdHJ1Y3QgZmls
ZSAqZmlsZSwgcG9sbF90YWJsZSAqcG9sbCkKIAlpZiAoIWV2ZW50cykKIAkJcmV0dXJuIDA7CiAK
LXJldHJ5OgotCXNlcSA9IHJlYWRfc2VxY291bnRfYmVnaW4oJnJlc3YtPnNlcSk7CiAJcmN1X3Jl
YWRfbG9jaygpOwotCi0JZm9iaiA9IHJjdV9kZXJlZmVyZW5jZShyZXN2LT5mZW5jZSk7CisJcmVz
ZXJ2YXRpb25fb2JqZWN0X2ZlbmNlcyhyZXN2LCAmZmVuY2VfZXhjbCwgJmZvYmopOwogCWlmIChm
b2JqKQogCQlzaGFyZWRfY291bnQgPSBmb2JqLT5zaGFyZWRfY291bnQ7CiAJZWxzZQogCQlzaGFy
ZWRfY291bnQgPSAwOwotCWZlbmNlX2V4Y2wgPSByY3VfZGVyZWZlcmVuY2UocmVzdi0+ZmVuY2Vf
ZXhjbCk7Ci0JaWYgKHJlYWRfc2VxY291bnRfcmV0cnkoJnJlc3YtPnNlcSwgc2VxKSkgewotCQly
Y3VfcmVhZF91bmxvY2soKTsKLQkJZ290byByZXRyeTsKLQl9CiAKIAlpZiAoZmVuY2VfZXhjbCAm
JiAoIShldmVudHMgJiBFUE9MTE9VVCkgfHwgc2hhcmVkX2NvdW50ID09IDApKSB7CiAJCXN0cnVj
dCBkbWFfYnVmX3BvbGxfY2JfdCAqZGNiID0gJmRtYWJ1Zi0+Y2JfZXhjbDsKQEAgLTExNTcsNyAr
MTE0OSw2IEBAIHN0YXRpYyBpbnQgZG1hX2J1Zl9kZWJ1Z19zaG93KHN0cnVjdCBzZXFfZmlsZSAq
cywgdm9pZCAqdW51c2VkKQogCXN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3QgKnJvYmo7CiAJc3Ry
dWN0IHJlc2VydmF0aW9uX29iamVjdF9saXN0ICpmb2JqOwogCXN0cnVjdCBkbWFfZmVuY2UgKmZl
bmNlOwotCXVuc2lnbmVkIHNlcTsKIAlpbnQgY291bnQgPSAwLCBhdHRhY2hfY291bnQsIHNoYXJl
ZF9jb3VudCwgaTsKIAlzaXplX3Qgc2l6ZSA9IDA7CiAKQEAgLTExODgsMTYgKzExNzksMTAgQEAg
c3RhdGljIGludCBkbWFfYnVmX2RlYnVnX3Nob3coc3RydWN0IHNlcV9maWxlICpzLCB2b2lkICp1
bnVzZWQpCiAJCQkJYnVmX29iai0+bmFtZSA/OiAiIik7CiAKIAkJcm9iaiA9IGJ1Zl9vYmotPnJl
c3Y7Ci0JCXdoaWxlICh0cnVlKSB7Ci0JCQlzZXEgPSByZWFkX3NlcWNvdW50X2JlZ2luKCZyb2Jq
LT5zZXEpOwotCQkJcmN1X3JlYWRfbG9jaygpOwotCQkJZm9iaiA9IHJjdV9kZXJlZmVyZW5jZShy
b2JqLT5mZW5jZSk7Ci0JCQlzaGFyZWRfY291bnQgPSBmb2JqID8gZm9iai0+c2hhcmVkX2NvdW50
IDogMDsKLQkJCWZlbmNlID0gcmN1X2RlcmVmZXJlbmNlKHJvYmotPmZlbmNlX2V4Y2wpOwotCQkJ
aWYgKCFyZWFkX3NlcWNvdW50X3JldHJ5KCZyb2JqLT5zZXEsIHNlcSkpCi0JCQkJYnJlYWs7Ci0J
CQlyY3VfcmVhZF91bmxvY2soKTsKLQkJfQorCQlyY3VfcmVhZF9sb2NrKCk7CisJCXJlc2VydmF0
aW9uX29iamVjdF9mZW5jZXMocm9iaiwgJmZlbmNlLCAmZm9iaik7CisJCXNoYXJlZF9jb3VudCA9
IGZvYmogPyBmb2JqLT5zaGFyZWRfY291bnQgOiAwOworCQlyY3VfcmVhZF91bmxvY2soKTsKIAog
CQlpZiAoZmVuY2UpCiAJCQlzZXFfcHJpbnRmKHMsICJcdEV4Y2x1c2l2ZSBmZW5jZTogJXMgJXMg
JXNzaWduYWxsZWRcbiIsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvcmVzZXJ2YXRpb24u
YyBiL2RyaXZlcnMvZG1hLWJ1Zi9yZXNlcnZhdGlvbi5jCmluZGV4IDc1MDVlYjI4OTAyMy4uODM5
ZDcyYWY3YWQ4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2RtYS1idWYvcmVzZXJ2YXRpb24uYworKysg
Yi9kcml2ZXJzL2RtYS1idWYvcmVzZXJ2YXRpb24uYwpAQCAtMzE2LDkgKzMxNiw5IEBAIGludCBy
ZXNlcnZhdGlvbl9vYmplY3RfY29weV9mZW5jZXMoc3RydWN0IHJlc2VydmF0aW9uX29iamVjdCAq
ZHN0LAogCXJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChkc3QpOwogCiAJcmN1X3JlYWRf
bG9jaygpOwotCXNyY19saXN0ID0gcmN1X2RlcmVmZXJlbmNlKHNyYy0+ZmVuY2UpOwogCiByZXRy
eToKKwlyZXNlcnZhdGlvbl9vYmplY3RfZmVuY2VzKHNyYywgJm5ldywgJnNyY19saXN0KTsKIAlp
ZiAoc3JjX2xpc3QpIHsKIAkJdW5zaWduZWQgc2hhcmVkX2NvdW50ID0gc3JjX2xpc3QtPnNoYXJl
ZF9jb3VudDsKIApAQCAtMzI5LDcgKzMyOSw3IEBAIGludCByZXNlcnZhdGlvbl9vYmplY3RfY29w
eV9mZW5jZXMoc3RydWN0IHJlc2VydmF0aW9uX29iamVjdCAqZHN0LAogCQkJcmV0dXJuIC1FTk9N
RU07CiAKIAkJcmN1X3JlYWRfbG9jaygpOwotCQlzcmNfbGlzdCA9IHJjdV9kZXJlZmVyZW5jZShz
cmMtPmZlbmNlKTsKKwkJcmVzZXJ2YXRpb25fb2JqZWN0X2ZlbmNlcyhzcmMsICZuZXcsICZzcmNf
bGlzdCk7CiAJCWlmICghc3JjX2xpc3QgfHwgc3JjX2xpc3QtPnNoYXJlZF9jb3VudCA+IHNoYXJl
ZF9jb3VudCkgewogCQkJa2ZyZWUoZHN0X2xpc3QpOwogCQkJZ290byByZXRyeTsKQEAgLTM0Niw3
ICszNDYsNiBAQCBpbnQgcmVzZXJ2YXRpb25fb2JqZWN0X2NvcHlfZmVuY2VzKHN0cnVjdCByZXNl
cnZhdGlvbl9vYmplY3QgKmRzdCwKIAogCQkJaWYgKCFkbWFfZmVuY2VfZ2V0X3JjdShmZW5jZSkp
IHsKIAkJCQlyZXNlcnZhdGlvbl9vYmplY3RfbGlzdF9mcmVlKGRzdF9saXN0KTsKLQkJCQlzcmNf
bGlzdCA9IHJjdV9kZXJlZmVyZW5jZShzcmMtPmZlbmNlKTsKIAkJCQlnb3RvIHJldHJ5OwogCQkJ
fQogCkBAIC0zNjEsNyArMzYwLDEwIEBAIGludCByZXNlcnZhdGlvbl9vYmplY3RfY29weV9mZW5j
ZXMoc3RydWN0IHJlc2VydmF0aW9uX29iamVjdCAqZHN0LAogCQlkc3RfbGlzdCA9IE5VTEw7CiAJ
fQogCi0JbmV3ID0gZG1hX2ZlbmNlX2dldF9yY3Vfc2FmZSgmc3JjLT5mZW5jZV9leGNsKTsKKwlp
ZiAobmV3ICYmICFkbWFfZmVuY2VfZ2V0X3JjdShuZXcpKSB7CisJCXJlc2VydmF0aW9uX29iamVj
dF9saXN0X2ZyZWUoZHN0X2xpc3QpOworCQlnb3RvIHJldHJ5OworCX0KIAlyY3VfcmVhZF91bmxv
Y2soKTsKIAogCXNyY19saXN0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9saXN0KGRzdCk7CkBA
IC00MDcsMTkgKzQwOSwxNyBAQCBpbnQgcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9mZW5jZXNfcmN1
KHN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3QgKm9iaiwKIAogCWRvIHsKIAkJc3RydWN0IHJlc2Vy
dmF0aW9uX29iamVjdF9saXN0ICpmb2JqOwotCQl1bnNpZ25lZCBpbnQgaSwgc2VxOworCQl1bnNp
Z25lZCBpbnQgaTsKIAkJc2l6ZV90IHN6ID0gMDsKIAogCQlzaGFyZWRfY291bnQgPSBpID0gMDsK
IAogCQlyY3VfcmVhZF9sb2NrKCk7Ci0JCXNlcSA9IHJlYWRfc2VxY291bnRfYmVnaW4oJm9iai0+
c2VxKTsKKwkJcmVzZXJ2YXRpb25fb2JqZWN0X2ZlbmNlcyhvYmosICZmZW5jZV9leGNsLCAmZm9i
aik7CiAKLQkJZmVuY2VfZXhjbCA9IHJjdV9kZXJlZmVyZW5jZShvYmotPmZlbmNlX2V4Y2wpOwog
CQlpZiAoZmVuY2VfZXhjbCAmJiAhZG1hX2ZlbmNlX2dldF9yY3UoZmVuY2VfZXhjbCkpCiAJCQln
b3RvIHVubG9jazsKIAotCQlmb2JqID0gcmN1X2RlcmVmZXJlbmNlKG9iai0+ZmVuY2UpOwogCQlp
ZiAoZm9iaikKIAkJCXN6ICs9IHNpemVvZigqc2hhcmVkKSAqIGZvYmotPnNoYXJlZF9tYXg7CiAK
QEAgLTQ1NSw3ICs0NTUsNyBAQCBpbnQgcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9mZW5jZXNfcmN1
KHN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3QgKm9iaiwKIAkJCX0KIAkJfQogCi0JCWlmIChpICE9
IHNoYXJlZF9jb3VudCB8fCByZWFkX3NlcWNvdW50X3JldHJ5KCZvYmotPnNlcSwgc2VxKSkgewor
CQlpZiAoaSAhPSBzaGFyZWRfY291bnQpIHsKIAkJCXdoaWxlIChpLS0pCiAJCQkJZG1hX2ZlbmNl
X3B1dChzaGFyZWRbaV0pOwogCQkJZG1hX2ZlbmNlX3B1dChmZW5jZV9leGNsKTsKQEAgLTQ5OSwx
OCArNDk5LDE4IEBAIGxvbmcgcmVzZXJ2YXRpb25fb2JqZWN0X3dhaXRfdGltZW91dF9yY3Uoc3Ry
dWN0IHJlc2VydmF0aW9uX29iamVjdCAqb2JqLAogCQkJCQkgYm9vbCB3YWl0X2FsbCwgYm9vbCBp
bnRyLAogCQkJCQkgdW5zaWduZWQgbG9uZyB0aW1lb3V0KQogeworCXN0cnVjdCByZXNlcnZhdGlv
bl9vYmplY3RfbGlzdCAqZm9iajsKIAlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZTsKLQl1bnNpZ25l
ZCBzZXEsIHNoYXJlZF9jb3VudDsKKwl1bnNpZ25lZCBzaGFyZWRfY291bnQ7CiAJbG9uZyByZXQg
PSB0aW1lb3V0ID8gdGltZW91dCA6IDE7CiAJaW50IGk7CiAKIHJldHJ5OgogCXNoYXJlZF9jb3Vu
dCA9IDA7Ci0Jc2VxID0gcmVhZF9zZXFjb3VudF9iZWdpbigmb2JqLT5zZXEpOwogCXJjdV9yZWFk
X2xvY2soKTsKIAlpID0gLTE7CiAKLQlmZW5jZSA9IHJjdV9kZXJlZmVyZW5jZShvYmotPmZlbmNl
X2V4Y2wpOworCXJlc2VydmF0aW9uX29iamVjdF9mZW5jZXMob2JqLCAmZmVuY2UsICZmb2JqKTsK
IAlpZiAoZmVuY2UgJiYgIXRlc3RfYml0KERNQV9GRU5DRV9GTEFHX1NJR05BTEVEX0JJVCwgJmZl
bmNlLT5mbGFncykpIHsKIAkJaWYgKCFkbWFfZmVuY2VfZ2V0X3JjdShmZW5jZSkpCiAJCQlnb3Rv
IHVubG9ja19yZXRyeTsKQEAgLTUyNSw5ICs1MjUsNiBAQCBsb25nIHJlc2VydmF0aW9uX29iamVj
dF93YWl0X3RpbWVvdXRfcmN1KHN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3QgKm9iaiwKIAl9CiAK
IAlpZiAod2FpdF9hbGwpIHsKLQkJc3RydWN0IHJlc2VydmF0aW9uX29iamVjdF9saXN0ICpmb2Jq
ID0KLQkJCQkJCXJjdV9kZXJlZmVyZW5jZShvYmotPmZlbmNlKTsKLQogCQlpZiAoZm9iaikKIAkJ
CXNoYXJlZF9jb3VudCA9IGZvYmotPnNoYXJlZF9jb3VudDsKIApAQCAtNTUzLDExICs1NTAsNiBA
QCBsb25nIHJlc2VydmF0aW9uX29iamVjdF93YWl0X3RpbWVvdXRfcmN1KHN0cnVjdCByZXNlcnZh
dGlvbl9vYmplY3QgKm9iaiwKIAogCXJjdV9yZWFkX3VubG9jaygpOwogCWlmIChmZW5jZSkgewot
CQlpZiAocmVhZF9zZXFjb3VudF9yZXRyeSgmb2JqLT5zZXEsIHNlcSkpIHsKLQkJCWRtYV9mZW5j
ZV9wdXQoZmVuY2UpOwotCQkJZ290byByZXRyeTsKLQkJfQotCiAJCXJldCA9IGRtYV9mZW5jZV93
YWl0X3RpbWVvdXQoZmVuY2UsIGludHIsIHJldCk7CiAJCWRtYV9mZW5jZV9wdXQoZmVuY2UpOwog
CQlpZiAocmV0ID4gMCAmJiB3YWl0X2FsbCAmJiAoaSArIDEgPCBzaGFyZWRfY291bnQpKQpAQCAt
NjAyLDIxICs1OTQsMjAgQEAgcmVzZXJ2YXRpb25fb2JqZWN0X3Rlc3Rfc2lnbmFsZWRfc2luZ2xl
KHN0cnVjdCBkbWFfZmVuY2UgKnBhc3NlZF9mZW5jZSkKIGJvb2wgcmVzZXJ2YXRpb25fb2JqZWN0
X3Rlc3Rfc2lnbmFsZWRfcmN1KHN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3QgKm9iaiwKIAkJCQkJ
ICBib29sIHRlc3RfYWxsKQogewotCXVuc2lnbmVkIHNlcSwgc2hhcmVkX2NvdW50OworCXN0cnVj
dCByZXNlcnZhdGlvbl9vYmplY3RfbGlzdCAqZm9iajsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5j
ZV9leGNsOworCXVuc2lnbmVkIHNoYXJlZF9jb3VudDsKIAlpbnQgcmV0OwogCiAJcmN1X3JlYWRf
bG9jaygpOwogcmV0cnk6CiAJcmV0ID0gdHJ1ZTsKIAlzaGFyZWRfY291bnQgPSAwOwotCXNlcSA9
IHJlYWRfc2VxY291bnRfYmVnaW4oJm9iai0+c2VxKTsKIAorCXJlc2VydmF0aW9uX29iamVjdF9m
ZW5jZXMob2JqLCAmZmVuY2VfZXhjbCwgJmZvYmopOwogCWlmICh0ZXN0X2FsbCkgewogCQl1bnNp
Z25lZCBpOwogCi0JCXN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3RfbGlzdCAqZm9iaiA9Ci0JCQkJ
CQlyY3VfZGVyZWZlcmVuY2Uob2JqLT5mZW5jZSk7Ci0KIAkJaWYgKGZvYmopCiAJCQlzaGFyZWRf
Y291bnQgPSBmb2JqLT5zaGFyZWRfY291bnQ7CiAKQEAgLTYyOSwyMyArNjIwLDEyIEBAIGJvb2wg
cmVzZXJ2YXRpb25fb2JqZWN0X3Rlc3Rfc2lnbmFsZWRfcmN1KHN0cnVjdCByZXNlcnZhdGlvbl9v
YmplY3QgKm9iaiwKIAkJCWVsc2UgaWYgKCFyZXQpCiAJCQkJYnJlYWs7CiAJCX0KLQotCQlpZiAo
cmVhZF9zZXFjb3VudF9yZXRyeSgmb2JqLT5zZXEsIHNlcSkpCi0JCQlnb3RvIHJldHJ5OwogCX0K
IAotCWlmICghc2hhcmVkX2NvdW50KSB7Ci0JCXN0cnVjdCBkbWFfZmVuY2UgKmZlbmNlX2V4Y2wg
PSByY3VfZGVyZWZlcmVuY2Uob2JqLT5mZW5jZV9leGNsKTsKLQotCQlpZiAoZmVuY2VfZXhjbCkg
ewotCQkJcmV0ID0gcmVzZXJ2YXRpb25fb2JqZWN0X3Rlc3Rfc2lnbmFsZWRfc2luZ2xlKAotCQkJ
CQkJCQlmZW5jZV9leGNsKTsKLQkJCWlmIChyZXQgPCAwKQotCQkJCWdvdG8gcmV0cnk7Ci0KLQkJ
CWlmIChyZWFkX3NlcWNvdW50X3JldHJ5KCZvYmotPnNlcSwgc2VxKSkKLQkJCQlnb3RvIHJldHJ5
OwotCQl9CisJaWYgKCFzaGFyZWRfY291bnQgJiYgZmVuY2VfZXhjbCkgeworCQlyZXQgPSByZXNl
cnZhdGlvbl9vYmplY3RfdGVzdF9zaWduYWxlZF9zaW5nbGUoZmVuY2VfZXhjbCk7CisJCWlmIChy
ZXQgPCAwKQorCQkJZ290byByZXRyeTsKIAl9CiAKIAlyY3VfcmVhZF91bmxvY2soKTsKZGlmZiAt
LWdpdCBhL2luY2x1ZGUvbGludXgvcmVzZXJ2YXRpb24uaCBiL2luY2x1ZGUvbGludXgvcmVzZXJ2
YXRpb24uaAppbmRleCA1NmI3ODJmZWM0OWIuLmI4YjgyNzNlZWYwMCAxMDA2NDQKLS0tIGEvaW5j
bHVkZS9saW51eC9yZXNlcnZhdGlvbi5oCisrKyBiL2luY2x1ZGUvbGludXgvcmVzZXJ2YXRpb24u
aApAQCAtODEsNiArODEsNTEgQEAgc3RydWN0IHJlc2VydmF0aW9uX29iamVjdCB7CiAjZGVmaW5l
IHJlc2VydmF0aW9uX29iamVjdF9hc3NlcnRfaGVsZChvYmopIFwKIAlsb2NrZGVwX2Fzc2VydF9o
ZWxkKCYob2JqKS0+bG9jay5iYXNlKQogCisvKioKKyAqIHJlc2VydmF0aW9uX29iamVjdF9nZXRf
ZXhjbCAtIGdldCB0aGUgcmVzZXJ2YXRpb24gb2JqZWN0J3MKKyAqIGV4Y2x1c2l2ZSBmZW5jZSwg
d2l0aCB1cGRhdGUtc2lkZSBsb2NrIGhlbGQKKyAqIEBvYmo6IHRoZSByZXNlcnZhdGlvbiBvYmpl
Y3QKKyAqCisgKiBSZXR1cm5zIHRoZSBleGNsdXNpdmUgZmVuY2UgKGlmIGFueSkuICBEb2VzIE5P
VCB0YWtlIGEKKyAqIHJlZmVyZW5jZS4gV3JpdGVycyBtdXN0IGhvbGQgb2JqLT5sb2NrLCByZWFk
ZXJzIG1heSBvbmx5CisgKiBob2xkIGEgUkNVIHJlYWQgc2lkZSBsb2NrLgorICoKKyAqIFJFVFVS
TlMKKyAqIFRoZSBleGNsdXNpdmUgZmVuY2Ugb3IgTlVMTAorICovCitzdGF0aWMgaW5saW5lIHN0
cnVjdCBkbWFfZmVuY2UgKgorcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9leGNsKHN0cnVjdCByZXNl
cnZhdGlvbl9vYmplY3QgKm9iaikKK3sKKwlyZXR1cm4gcmN1X2RlcmVmZXJlbmNlX3Byb3RlY3Rl
ZChvYmotPmZlbmNlX2V4Y2wsCisJCQkJCSByZXNlcnZhdGlvbl9vYmplY3RfaGVsZChvYmopKTsK
K30KKworLyoqCisgKiByZXNlcnZhdGlvbl9vYmplY3RfZ2V0X2V4Y2xfcmN1IC0gZ2V0IHRoZSBy
ZXNlcnZhdGlvbiBvYmplY3QncworICogZXhjbHVzaXZlIGZlbmNlLCB3aXRob3V0IGxvY2sgaGVs
ZC4KKyAqIEBvYmo6IHRoZSByZXNlcnZhdGlvbiBvYmplY3QKKyAqCisgKiBJZiB0aGVyZSBpcyBh
biBleGNsdXNpdmUgZmVuY2UsIHRoaXMgYXRvbWljYWxseSBpbmNyZW1lbnRzIGl0J3MKKyAqIHJl
ZmVyZW5jZSBjb3VudCBhbmQgcmV0dXJucyBpdC4KKyAqCisgKiBSRVRVUk5TCisgKiBUaGUgZXhj
bHVzaXZlIGZlbmNlIG9yIE5VTEwgaWYgbm9uZQorICovCitzdGF0aWMgaW5saW5lIHN0cnVjdCBk
bWFfZmVuY2UgKgorcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9leGNsX3JjdShzdHJ1Y3QgcmVzZXJ2
YXRpb25fb2JqZWN0ICpvYmopCit7CisJc3RydWN0IGRtYV9mZW5jZSAqZmVuY2U7CisKKwlpZiAo
IXJjdV9hY2Nlc3NfcG9pbnRlcihvYmotPmZlbmNlX2V4Y2wpKQorCQlyZXR1cm4gTlVMTDsKKwor
CXJjdV9yZWFkX2xvY2soKTsKKwlmZW5jZSA9IGRtYV9mZW5jZV9nZXRfcmN1X3NhZmUoJm9iai0+
ZmVuY2VfZXhjbCk7CisJcmN1X3JlYWRfdW5sb2NrKCk7CisKKwlyZXR1cm4gZmVuY2U7Cit9CisK
IC8qKgogICogcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9saXN0IC0gZ2V0IHRoZSByZXNlcnZhdGlv
biBvYmplY3QncwogICogc2hhcmVkIGZlbmNlIGxpc3QsIHdpdGggdXBkYXRlLXNpZGUgbG9jayBo
ZWxkCkBAIC05Niw2ICsxNDEsMjkgQEAgcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9saXN0KHN0cnVj
dCByZXNlcnZhdGlvbl9vYmplY3QgKm9iaikKIAkJCQkJIHJlc2VydmF0aW9uX29iamVjdF9oZWxk
KG9iaikpOwogfQogCisvKioKKyAqIHJlc2VydmF0aW9uX29iamVjdF9mZW5jZXMgLSByZWFkIGNv
bnNpc3RlbnQgZmVuY2UgcG9pbnRlcnMKKyAqIEBvYmo6IHJlc2VydmF0aW9uIG9iamVjdCB3aGVy
ZSB3ZSBnZXQgdGhlIGZlbmNlcyBmcm9tCisgKiBAZXhjbDogcG9pbnRlciBmb3IgdGhlIGV4Y2x1
c2l2ZSBmZW5jZQorICogQGxpc3Q6IHBvaW50ZXIgZm9yIHRoZSBzaGFyZWQgZmVuY2UgbGlzdAor
ICoKKyAqIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgY29uc2lzdGVuIGV4Y2x1c2l2ZSBmZW5jZSBhbmQg
c2hhcmVkIGZlbmNlIGxpc3QuCisgKiBNdXN0IGJlIGNhbGxlZCB3aXRoIHJjdSByZWFkIHNpZGUg
bG9jayBoZWxkLgorICovCitzdGF0aWMgaW5saW5lIHZvaWQKK3Jlc2VydmF0aW9uX29iamVjdF9m
ZW5jZXMoc3RydWN0IHJlc2VydmF0aW9uX29iamVjdCAqb2JqLAorCQkJICBzdHJ1Y3QgZG1hX2Zl
bmNlICoqZXhjbCwKKwkJCSAgc3RydWN0IHJlc2VydmF0aW9uX29iamVjdF9saXN0ICoqbGlzdCkK
K3sKKwl1bnNpZ25lZCBpbnQgc2VxOworCisJZG8geworCQlzZXEgPSByZWFkX3NlcWNvdW50X2Jl
Z2luKCZvYmotPnNlcSk7CisJCSpleGNsID0gcmN1X2RlcmVmZXJlbmNlKG9iai0+ZmVuY2VfZXhj
bCk7CisJCSpsaXN0ID0gcmN1X2RlcmVmZXJlbmNlKG9iai0+ZmVuY2UpOworCX0gd2hpbGUgKHJl
YWRfc2VxY291bnRfcmV0cnkoJm9iai0+c2VxLCBzZXEpKTsKK30KKwogLyoqCiAgKiByZXNlcnZh
dGlvbl9vYmplY3RfbG9jayAtIGxvY2sgdGhlIHJlc2VydmF0aW9uIG9iamVjdAogICogQG9iajog
dGhlIHJlc2VydmF0aW9uIG9iamVjdApAQCAtMjM5LDUxICszMDcsNiBAQCByZXNlcnZhdGlvbl9v
YmplY3RfdW5sb2NrKHN0cnVjdCByZXNlcnZhdGlvbl9vYmplY3QgKm9iaikKIAl3d19tdXRleF91
bmxvY2soJm9iai0+bG9jayk7CiB9CiAKLS8qKgotICogcmVzZXJ2YXRpb25fb2JqZWN0X2dldF9l
eGNsIC0gZ2V0IHRoZSByZXNlcnZhdGlvbiBvYmplY3QncwotICogZXhjbHVzaXZlIGZlbmNlLCB3
aXRoIHVwZGF0ZS1zaWRlIGxvY2sgaGVsZAotICogQG9iajogdGhlIHJlc2VydmF0aW9uIG9iamVj
dAotICoKLSAqIFJldHVybnMgdGhlIGV4Y2x1c2l2ZSBmZW5jZSAoaWYgYW55KS4gIERvZXMgTk9U
IHRha2UgYQotICogcmVmZXJlbmNlLiBXcml0ZXJzIG11c3QgaG9sZCBvYmotPmxvY2ssIHJlYWRl
cnMgbWF5IG9ubHkKLSAqIGhvbGQgYSBSQ1UgcmVhZCBzaWRlIGxvY2suCi0gKgotICogUkVUVVJO
UwotICogVGhlIGV4Y2x1c2l2ZSBmZW5jZSBvciBOVUxMCi0gKi8KLXN0YXRpYyBpbmxpbmUgc3Ry
dWN0IGRtYV9mZW5jZSAqCi1yZXNlcnZhdGlvbl9vYmplY3RfZ2V0X2V4Y2woc3RydWN0IHJlc2Vy
dmF0aW9uX29iamVjdCAqb2JqKQotewotCXJldHVybiByY3VfZGVyZWZlcmVuY2VfcHJvdGVjdGVk
KG9iai0+ZmVuY2VfZXhjbCwKLQkJCQkJIHJlc2VydmF0aW9uX29iamVjdF9oZWxkKG9iaikpOwot
fQotCi0vKioKLSAqIHJlc2VydmF0aW9uX29iamVjdF9nZXRfZXhjbF9yY3UgLSBnZXQgdGhlIHJl
c2VydmF0aW9uIG9iamVjdCdzCi0gKiBleGNsdXNpdmUgZmVuY2UsIHdpdGhvdXQgbG9jayBoZWxk
LgotICogQG9iajogdGhlIHJlc2VydmF0aW9uIG9iamVjdAotICoKLSAqIElmIHRoZXJlIGlzIGFu
IGV4Y2x1c2l2ZSBmZW5jZSwgdGhpcyBhdG9taWNhbGx5IGluY3JlbWVudHMgaXQncwotICogcmVm
ZXJlbmNlIGNvdW50IGFuZCByZXR1cm5zIGl0LgotICoKLSAqIFJFVFVSTlMKLSAqIFRoZSBleGNs
dXNpdmUgZmVuY2Ugb3IgTlVMTCBpZiBub25lCi0gKi8KLXN0YXRpYyBpbmxpbmUgc3RydWN0IGRt
YV9mZW5jZSAqCi1yZXNlcnZhdGlvbl9vYmplY3RfZ2V0X2V4Y2xfcmN1KHN0cnVjdCByZXNlcnZh
dGlvbl9vYmplY3QgKm9iaikKLXsKLQlzdHJ1Y3QgZG1hX2ZlbmNlICpmZW5jZTsKLQotCWlmICgh
cmN1X2FjY2Vzc19wb2ludGVyKG9iai0+ZmVuY2VfZXhjbCkpCi0JCXJldHVybiBOVUxMOwotCi0J
cmN1X3JlYWRfbG9jaygpOwotCWZlbmNlID0gZG1hX2ZlbmNlX2dldF9yY3Vfc2FmZSgmb2JqLT5m
ZW5jZV9leGNsKTsKLQlyY3VfcmVhZF91bmxvY2soKTsKLQotCXJldHVybiBmZW5jZTsKLX0KLQog
dm9pZCByZXNlcnZhdGlvbl9vYmplY3RfaW5pdChzdHJ1Y3QgcmVzZXJ2YXRpb25fb2JqZWN0ICpv
YmopOwogdm9pZCByZXNlcnZhdGlvbl9vYmplY3RfZmluaShzdHJ1Y3QgcmVzZXJ2YXRpb25fb2Jq
ZWN0ICpvYmopOwogaW50IHJlc2VydmF0aW9uX29iamVjdF9yZXNlcnZlX3NoYXJlZChzdHJ1Y3Qg
cmVzZXJ2YXRpb25fb2JqZWN0ICpvYmosCi0tIAoyLjE3LjEKCl9fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRl
dmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9t
YWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
