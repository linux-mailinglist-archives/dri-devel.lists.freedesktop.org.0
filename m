Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 31AFCFF927
	for <lists+dri-devel@lfdr.de>; Sun, 17 Nov 2019 12:46:37 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AC8B46E36F;
	Sun, 17 Nov 2019 11:45:23 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from bhuna.collabora.co.uk (bhuna.collabora.co.uk [46.235.227.227])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A251D6E200
 for <dri-devel@lists.freedesktop.org>; Sun, 17 Nov 2019 02:41:51 +0000 (UTC)
Received: from [127.0.0.1] (localhost [127.0.0.1]) (Authenticated sender: sre)
 with ESMTPSA id 6C31F28F84E
Received: by earth.universe (Postfix, from userid 1000)
 id 2ED9B3C0CA9; Sun, 17 Nov 2019 03:41:40 +0100 (CET)
From: Sebastian Reichel <sebastian.reichel@collabora.com>
To: Sebastian Reichel <sre@kernel.org>,
 Laurent Pinchart <laurent.pinchart@ideasonboard.com>,
 Tomi Valkeinen <tomi.valkeinen@ti.com>
Subject: [RFCv1 29/42] drm/omap: dsi: do ULPS in host driver
Date: Sun, 17 Nov 2019 03:40:15 +0100
Message-Id: <20191117024028.2233-30-sebastian.reichel@collabora.com>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191117024028.2233-1-sebastian.reichel@collabora.com>
References: <20191117024028.2233-1-sebastian.reichel@collabora.com>
MIME-Version: 1.0
X-Mailman-Approved-At: Sun, 17 Nov 2019 11:44:18 +0000
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: kernel@collabora.com, Tony Lindgren <tony@atomide.com>,
 "H. Nikolaus Schaller" <hns@goldelico.com>, Merlijn Wajer <merlijn@wizzup.org>,
 Sebastian Reichel <sebastian.reichel@collabora.com>,
 dri-devel@lists.freedesktop.org, linux-omap@vger.kernel.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

TW92ZSBVTFBTIGhhbmRsaW5nIGludG8gdGhlIERTSSBob3N0IGNvbnRyb2xsZXIsIHNvIHRoYXQg
d2UKbm8gbG9uZ2VyIG5lZWQgYSBjdXN0b20gQVBJIGZvciB0aGUgRFNJIGNsaWVudC4KClNpZ25l
ZC1vZmYtYnk6IFNlYmFzdGlhbiBSZWljaGVsIDxzZWJhc3RpYW4ucmVpY2hlbEBjb2xsYWJvcmEu
Y29tPgotLS0KIC4uLi9ncHUvZHJtL29tYXBkcm0vZGlzcGxheXMvcGFuZWwtZHNpLWNtLmMgICB8
IDI3MyArLS0tLS0tLS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9vbWFwZHJtL2Rzcy9kc2ku
YyAgICAgICAgICAgICB8ICA2MSArKystCiBkcml2ZXJzL2dwdS9kcm0vb21hcGRybS9kc3Mvb21h
cGRzcy5oICAgICAgICAgfCAgIDIgLQogMyBmaWxlcyBjaGFuZ2VkLCA2MiBpbnNlcnRpb25zKCsp
LCAyNzQgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL29tYXBkcm0v
ZGlzcGxheXMvcGFuZWwtZHNpLWNtLmMgYi9kcml2ZXJzL2dwdS9kcm0vb21hcGRybS9kaXNwbGF5
cy9wYW5lbC1kc2ktY20uYwppbmRleCBmNzNiOGY0ODlmODIuLjU2Mzk4ZTJhZWMyZCAxMDA2NDQK
LS0tIGEvZHJpdmVycy9ncHUvZHJtL29tYXBkcm0vZGlzcGxheXMvcGFuZWwtZHNpLWNtLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL29tYXBkcm0vZGlzcGxheXMvcGFuZWwtZHNpLWNtLmMKQEAgLTE2
LDcgKzE2LDYgQEAKICNpbmNsdWRlIDxsaW51eC9tb2R1bGUuaD4KICNpbmNsdWRlIDxsaW51eC9z
Y2hlZC9zaWduYWwuaD4KICNpbmNsdWRlIDxsaW51eC9zbGFiLmg+Ci0jaW5jbHVkZSA8bGludXgv
d29ya3F1ZXVlLmg+CiAjaW5jbHVkZSA8bGludXgvb2ZfZGV2aWNlLmg+CiAjaW5jbHVkZSA8bGlu
dXgvcmVndWxhdG9yL2NvbnN1bWVyLmg+CiAKQEAgLTY5LDIxICs2OCwxMyBAQCBzdHJ1Y3QgcGFu
ZWxfZHJ2X2RhdGEgewogCiAJYm9vbCBpbnRyb19wcmludGVkOwogCi0Jc3RydWN0IHdvcmtxdWV1
ZV9zdHJ1Y3QgKndvcmtxdWV1ZTsKLQogCWJvb2wgdWxwc19lbmFibGVkOwotCXVuc2lnbmVkIGlu
dCB1bHBzX3RpbWVvdXQ7Ci0Jc3RydWN0IGRlbGF5ZWRfd29yayB1bHBzX3dvcms7CiB9OwogCiAj
ZGVmaW5lIHRvX3BhbmVsX2RhdGEocCkgY29udGFpbmVyX29mKHAsIHN0cnVjdCBwYW5lbF9kcnZf
ZGF0YSwgZHNzZGV2KQogCiBzdGF0aWMgaW50IF9kc2ljbV9lbmFibGVfdGUoc3RydWN0IHBhbmVs
X2Rydl9kYXRhICpkZGF0YSwgYm9vbCBlbmFibGUpOwogCi1zdGF0aWMgaW50IGRzaWNtX3BhbmVs
X3Jlc2V0KHN0cnVjdCBwYW5lbF9kcnZfZGF0YSAqZGRhdGEpOwotCi1zdGF0aWMgdm9pZCBkc2lj
bV91bHBzX3dvcmsoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKTsKLQogc3RhdGljIHZvaWQgZHNp
Y21fYmxfcG93ZXIoc3RydWN0IHBhbmVsX2Rydl9kYXRhICpkZGF0YSwgYm9vbCBlbmFibGUpCiB7
CiAJc3RydWN0IGJhY2tsaWdodF9kZXZpY2UgKmJhY2tsaWdodDsKQEAgLTIwNyw5NCArMTk4LDYg
QEAgc3RhdGljIGludCBkc2ljbV9zZXRfdXBkYXRlX3dpbmRvdyhzdHJ1Y3QgcGFuZWxfZHJ2X2Rh
dGEgKmRkYXRhLAogCXJldHVybiAwOwogfQogCi1zdGF0aWMgdm9pZCBkc2ljbV9xdWV1ZV91bHBz
X3dvcmsoc3RydWN0IHBhbmVsX2Rydl9kYXRhICpkZGF0YSkKLXsKLQlpZiAoZGRhdGEtPnVscHNf
dGltZW91dCA+IDApCi0JCXF1ZXVlX2RlbGF5ZWRfd29yayhkZGF0YS0+d29ya3F1ZXVlLCAmZGRh
dGEtPnVscHNfd29yaywKLQkJCQltc2Vjc190b19qaWZmaWVzKGRkYXRhLT51bHBzX3RpbWVvdXQp
KTsKLX0KLQotc3RhdGljIHZvaWQgZHNpY21fY2FuY2VsX3VscHNfd29yayhzdHJ1Y3QgcGFuZWxf
ZHJ2X2RhdGEgKmRkYXRhKQotewotCWNhbmNlbF9kZWxheWVkX3dvcmsoJmRkYXRhLT51bHBzX3dv
cmspOwotfQotCi1zdGF0aWMgaW50IGRzaWNtX2VudGVyX3VscHMoc3RydWN0IHBhbmVsX2Rydl9k
YXRhICpkZGF0YSkKLXsKLQlzdHJ1Y3Qgb21hcF9kc3NfZGV2aWNlICpzcmMgPSBkZGF0YS0+c3Jj
OwotCWludCByOwotCi0JaWYgKGRkYXRhLT51bHBzX2VuYWJsZWQpCi0JCXJldHVybiAwOwotCi0J
ZHNpY21fY2FuY2VsX3VscHNfd29yayhkZGF0YSk7Ci0KLQlyID0gX2RzaWNtX2VuYWJsZV90ZShk
ZGF0YSwgZmFsc2UpOwotCWlmIChyKQotCQlnb3RvIGVycjsKLQotCXNyYy0+b3BzLT5kc2kudWxw
cyhzcmMsIHRydWUpOwotCi0JZGRhdGEtPnVscHNfZW5hYmxlZCA9IHRydWU7Ci0KLQlyZXR1cm4g
MDsKLQotZXJyOgotCWRldl9lcnIoJmRkYXRhLT5kc2ktPmRldiwgImVudGVyIFVMUFMgZmFpbGVk
Iik7Ci0JZHNpY21fcGFuZWxfcmVzZXQoZGRhdGEpOwotCi0JZGRhdGEtPnVscHNfZW5hYmxlZCA9
IGZhbHNlOwotCi0JZHNpY21fcXVldWVfdWxwc193b3JrKGRkYXRhKTsKLQotCXJldHVybiByOwot
fQotCi1zdGF0aWMgaW50IGRzaWNtX2V4aXRfdWxwcyhzdHJ1Y3QgcGFuZWxfZHJ2X2RhdGEgKmRk
YXRhKQotewotCXN0cnVjdCBvbWFwX2Rzc19kZXZpY2UgKnNyYyA9IGRkYXRhLT5zcmM7Ci0JaW50
IHI7Ci0KLQlpZiAoIWRkYXRhLT51bHBzX2VuYWJsZWQpCi0JCXJldHVybiAwOwotCi0Jc3JjLT5v
cHMtPmRzaS51bHBzKHNyYywgZmFsc2UpOwotCWRkYXRhLT5kc2ktPm1vZGVfZmxhZ3MgJj0gfk1J
UElfRFNJX01PREVfTFBNOwotCi0JciA9IF9kc2ljbV9lbmFibGVfdGUoZGRhdGEsIGRkYXRhLT50
ZV9lbmFibGVkKTsKLQlpZiAocikgewotCQlkZXZfZXJyKCZkZGF0YS0+ZHNpLT5kZXYsICJmYWls
ZWQgdG8gcmUtZW5hYmxlIFRFIik7Ci0JCWdvdG8gZXJyMjsKLQl9Ci0KLQlkc2ljbV9xdWV1ZV91
bHBzX3dvcmsoZGRhdGEpOwotCi0JZGRhdGEtPnVscHNfZW5hYmxlZCA9IGZhbHNlOwotCi0JcmV0
dXJuIDA7Ci0KLWVycjI6Ci0JZGV2X2VycigmZGRhdGEtPmRzaS0+ZGV2LCAiZmFpbGVkIHRvIGV4
aXQgVUxQUyIpOwotCi0JciA9IGRzaWNtX3BhbmVsX3Jlc2V0KGRkYXRhKTsKLQlpZiAoIXIpCi0J
CWRkYXRhLT51bHBzX2VuYWJsZWQgPSBmYWxzZTsKLQotCWRzaWNtX3F1ZXVlX3VscHNfd29yayhk
ZGF0YSk7Ci0KLQlyZXR1cm4gcjsKLX0KLQotc3RhdGljIGludCBkc2ljbV93YWtlX3VwKHN0cnVj
dCBwYW5lbF9kcnZfZGF0YSAqZGRhdGEpCi17Ci0JaWYgKGRkYXRhLT51bHBzX2VuYWJsZWQpCi0J
CXJldHVybiBkc2ljbV9leGl0X3VscHMoZGRhdGEpOwotCi0JZHNpY21fY2FuY2VsX3VscHNfd29y
ayhkZGF0YSk7Ci0JZHNpY21fcXVldWVfdWxwc193b3JrKGRkYXRhKTsKLQlyZXR1cm4gMDsKLX0K
LQogc3RhdGljIGludCBkc2ljbV9ibF91cGRhdGVfc3RhdHVzKHN0cnVjdCBiYWNrbGlnaHRfZGV2
aWNlICpkZXYpCiB7CiAJc3RydWN0IHBhbmVsX2Rydl9kYXRhICpkZGF0YSA9IGRldl9nZXRfZHJ2
ZGF0YSgmZGV2LT5kZXYpOwpAQCAtMzEyLDExICsyMTUsOCBAQCBzdGF0aWMgaW50IGRzaWNtX2Js
X3VwZGF0ZV9zdGF0dXMoc3RydWN0IGJhY2tsaWdodF9kZXZpY2UgKmRldikKIAltdXRleF9sb2Nr
KCZkZGF0YS0+bG9jayk7CiAKIAlpZiAoZGRhdGEtPmVuYWJsZWQpIHsKLQkJciA9IGRzaWNtX3dh
a2VfdXAoZGRhdGEpOwotCQlpZiAoIXIpIHsKLQkJCXIgPSBkc2ljbV9kY3Nfd3JpdGVfMShkZGF0
YSwKLQkJCQlNSVBJX0RDU19TRVRfRElTUExBWV9CUklHSFRORVNTLCBsZXZlbCk7Ci0JCX0KKwkJ
ciA9IGRzaWNtX2Rjc193cml0ZV8xKGRkYXRhLCBNSVBJX0RDU19TRVRfRElTUExBWV9CUklHSFRO
RVNTLAorCQkJCSAgICAgIGxldmVsKTsKIAl9CiAKIAltdXRleF91bmxvY2soJmRkYXRhLT5sb2Nr
KTsKQEAgLTM0MywxOCArMjQzLDEyIEBAIHN0YXRpYyBzc2l6ZV90IGRzaWNtX251bV9lcnJvcnNf
c2hvdyhzdHJ1Y3QgZGV2aWNlICpkZXYsCiB7CiAJc3RydWN0IHBhbmVsX2Rydl9kYXRhICpkZGF0
YSA9IGRldl9nZXRfZHJ2ZGF0YShkZXYpOwogCXU4IGVycm9ycyA9IDA7Ci0JaW50IHI7CisJaW50
IHIgPSAtRU5PREVWOwogCiAJbXV0ZXhfbG9jaygmZGRhdGEtPmxvY2spOwogCi0JaWYgKGRkYXRh
LT5lbmFibGVkKSB7Ci0JCXIgPSBkc2ljbV93YWtlX3VwKGRkYXRhKTsKLQkJaWYgKCFyKQotCQkJ
ciA9IGRzaWNtX2Rjc19yZWFkXzEoZGRhdGEsIERDU19SRUFEX05VTV9FUlJPUlMsCi0JCQkJCSZl
cnJvcnMpOwotCX0gZWxzZSB7Ci0JCXIgPSAtRU5PREVWOwotCX0KKwlpZiAoZGRhdGEtPmVuYWJs
ZWQpCisJCXIgPSBkc2ljbV9kY3NfcmVhZF8xKGRkYXRhLCBEQ1NfUkVBRF9OVU1fRVJST1JTLCAm
ZXJyb3JzKTsKIAogCW11dGV4X3VubG9jaygmZGRhdGEtPmxvY2spOwogCkBAIC0zNjksMTcgKzI2
MywxMiBAQCBzdGF0aWMgc3NpemVfdCBkc2ljbV9od19yZXZpc2lvbl9zaG93KHN0cnVjdCBkZXZp
Y2UgKmRldiwKIHsKIAlzdHJ1Y3QgcGFuZWxfZHJ2X2RhdGEgKmRkYXRhID0gZGV2X2dldF9kcnZk
YXRhKGRldik7CiAJdTggaWQxLCBpZDIsIGlkMzsKLQlpbnQgcjsKKwlpbnQgciA9IC1FTk9ERVY7
CiAKIAltdXRleF9sb2NrKCZkZGF0YS0+bG9jayk7CiAKLQlpZiAoZGRhdGEtPmVuYWJsZWQpIHsK
LQkJciA9IGRzaWNtX3dha2VfdXAoZGRhdGEpOwotCQlpZiAoIXIpCi0JCQlyID0gZHNpY21fZ2V0
X2lkKGRkYXRhLCAmaWQxLCAmaWQyLCAmaWQzKTsKLQl9IGVsc2UgewotCQlyID0gLUVOT0RFVjsK
LQl9CisJaWYgKGRkYXRhLT5lbmFibGVkKQorCQlyID0gZHNpY21fZ2V0X2lkKGRkYXRhLCAmaWQx
LCAmaWQyLCAmaWQzKTsKIAogCW11dGV4X3VubG9jaygmZGRhdGEtPmxvY2spOwogCkBAIC0zODks
MTAzICsyNzgsMTIgQEAgc3RhdGljIHNzaXplX3QgZHNpY21faHdfcmV2aXNpb25fc2hvdyhzdHJ1
Y3QgZGV2aWNlICpkZXYsCiAJcmV0dXJuIHNucHJpbnRmKGJ1ZiwgUEFHRV9TSVpFLCAiJTAyeC4l
MDJ4LiUwMnhcbiIsIGlkMSwgaWQyLCBpZDMpOwogfQogCi1zdGF0aWMgc3NpemVfdCBkc2ljbV9z
dG9yZV91bHBzKHN0cnVjdCBkZXZpY2UgKmRldiwKLQkJc3RydWN0IGRldmljZV9hdHRyaWJ1dGUg
KmF0dHIsCi0JCWNvbnN0IGNoYXIgKmJ1Ziwgc2l6ZV90IGNvdW50KQotewotCXN0cnVjdCBwYW5l
bF9kcnZfZGF0YSAqZGRhdGEgPSBkZXZfZ2V0X2RydmRhdGEoZGV2KTsKLQl1bnNpZ25lZCBsb25n
IHQ7Ci0JaW50IHI7Ci0KLQlyID0ga3N0cnRvdWwoYnVmLCAwLCAmdCk7Ci0JaWYgKHIpCi0JCXJl
dHVybiByOwotCi0JbXV0ZXhfbG9jaygmZGRhdGEtPmxvY2spOwotCi0JaWYgKGRkYXRhLT5lbmFi
bGVkKSB7Ci0JCWlmICh0KQotCQkJciA9IGRzaWNtX2VudGVyX3VscHMoZGRhdGEpOwotCQllbHNl
Ci0JCQlyID0gZHNpY21fd2FrZV91cChkZGF0YSk7Ci0JfQotCi0JbXV0ZXhfdW5sb2NrKCZkZGF0
YS0+bG9jayk7Ci0KLQlpZiAocikKLQkJcmV0dXJuIHI7Ci0KLQlyZXR1cm4gY291bnQ7Ci19Ci0K
LXN0YXRpYyBzc2l6ZV90IGRzaWNtX3Nob3dfdWxwcyhzdHJ1Y3QgZGV2aWNlICpkZXYsCi0JCXN0
cnVjdCBkZXZpY2VfYXR0cmlidXRlICphdHRyLAotCQljaGFyICpidWYpCi17Ci0Jc3RydWN0IHBh
bmVsX2Rydl9kYXRhICpkZGF0YSA9IGRldl9nZXRfZHJ2ZGF0YShkZXYpOwotCXVuc2lnbmVkIGlu
dCB0OwotCi0JbXV0ZXhfbG9jaygmZGRhdGEtPmxvY2spOwotCXQgPSBkZGF0YS0+dWxwc19lbmFi
bGVkOwotCW11dGV4X3VubG9jaygmZGRhdGEtPmxvY2spOwotCi0JcmV0dXJuIHNucHJpbnRmKGJ1
ZiwgUEFHRV9TSVpFLCAiJXVcbiIsIHQpOwotfQotCi1zdGF0aWMgc3NpemVfdCBkc2ljbV9zdG9y
ZV91bHBzX3RpbWVvdXQoc3RydWN0IGRldmljZSAqZGV2LAotCQlzdHJ1Y3QgZGV2aWNlX2F0dHJp
YnV0ZSAqYXR0ciwKLQkJY29uc3QgY2hhciAqYnVmLCBzaXplX3QgY291bnQpCi17Ci0Jc3RydWN0
IHBhbmVsX2Rydl9kYXRhICpkZGF0YSA9IGRldl9nZXRfZHJ2ZGF0YShkZXYpOwotCXVuc2lnbmVk
IGxvbmcgdDsKLQlpbnQgcjsKLQotCXIgPSBrc3RydG91bChidWYsIDAsICZ0KTsKLQlpZiAocikK
LQkJcmV0dXJuIHI7Ci0KLQltdXRleF9sb2NrKCZkZGF0YS0+bG9jayk7Ci0JZGRhdGEtPnVscHNf
dGltZW91dCA9IHQ7Ci0KLQlpZiAoZGRhdGEtPmVuYWJsZWQpIHsKLQkJLyogZHNpY21fd2FrZV91
cCB3aWxsIHJlc3RhcnQgdGhlIHRpbWVyICovCi0JCXIgPSBkc2ljbV93YWtlX3VwKGRkYXRhKTsK
LQl9Ci0KLQltdXRleF91bmxvY2soJmRkYXRhLT5sb2NrKTsKLQotCWlmIChyKQotCQlyZXR1cm4g
cjsKLQotCXJldHVybiBjb3VudDsKLX0KLQotc3RhdGljIHNzaXplX3QgZHNpY21fc2hvd191bHBz
X3RpbWVvdXQoc3RydWN0IGRldmljZSAqZGV2LAotCQlzdHJ1Y3QgZGV2aWNlX2F0dHJpYnV0ZSAq
YXR0ciwKLQkJY2hhciAqYnVmKQotewotCXN0cnVjdCBwYW5lbF9kcnZfZGF0YSAqZGRhdGEgPSBk
ZXZfZ2V0X2RydmRhdGEoZGV2KTsKLQl1bnNpZ25lZCBpbnQgdDsKLQotCW11dGV4X2xvY2soJmRk
YXRhLT5sb2NrKTsKLQl0ID0gZGRhdGEtPnVscHNfdGltZW91dDsKLQltdXRleF91bmxvY2soJmRk
YXRhLT5sb2NrKTsKLQotCXJldHVybiBzbnByaW50ZihidWYsIFBBR0VfU0laRSwgIiV1XG4iLCB0
KTsKLX0KLQogc3RhdGljIERFVklDRV9BVFRSKG51bV9kc2lfZXJyb3JzLCBTX0lSVUdPLCBkc2lj
bV9udW1fZXJyb3JzX3Nob3csIE5VTEwpOwogc3RhdGljIERFVklDRV9BVFRSKGh3X3JldmlzaW9u
LCBTX0lSVUdPLCBkc2ljbV9od19yZXZpc2lvbl9zaG93LCBOVUxMKTsKLXN0YXRpYyBERVZJQ0Vf
QVRUUih1bHBzLCBTX0lSVUdPIHwgU19JV1VTUiwKLQkJZHNpY21fc2hvd191bHBzLCBkc2ljbV9z
dG9yZV91bHBzKTsKLXN0YXRpYyBERVZJQ0VfQVRUUih1bHBzX3RpbWVvdXQsIFNfSVJVR08gfCBT
X0lXVVNSLAotCQlkc2ljbV9zaG93X3VscHNfdGltZW91dCwgZHNpY21fc3RvcmVfdWxwc190aW1l
b3V0KTsKIAogc3RhdGljIHN0cnVjdCBhdHRyaWJ1dGUgKmRzaWNtX2F0dHJzW10gPSB7CiAJJmRl
dl9hdHRyX251bV9kc2lfZXJyb3JzLmF0dHIsCiAJJmRldl9hdHRyX2h3X3JldmlzaW9uLmF0dHIs
Ci0JJmRldl9hdHRyX3VscHMuYXR0ciwKLQkmZGV2X2F0dHJfdWxwc190aW1lb3V0LmF0dHIsCiAJ
TlVMTCwKIH07CiAKQEAgLTYyMSwxNSArNDE5LDYgQEAgc3RhdGljIHZvaWQgZHNpY21fcG93ZXJf
b2ZmKHN0cnVjdCBwYW5lbF9kcnZfZGF0YSAqZGRhdGEpCiAJZGRhdGEtPmVuYWJsZWQgPSAwOwog
fQogCi1zdGF0aWMgaW50IGRzaWNtX3BhbmVsX3Jlc2V0KHN0cnVjdCBwYW5lbF9kcnZfZGF0YSAq
ZGRhdGEpCi17Ci0JZGV2X2VycigmZGRhdGEtPmRzaS0+ZGV2LCAicGVyZm9ybWluZyBMQ0QgcmVz
ZXRcbiIpOwotCi0JZHNpY21fcG93ZXJfb2ZmKGRkYXRhKTsKLQlkc2ljbV9od19yZXNldChkZGF0
YSk7Ci0JcmV0dXJuIGRzaWNtX3Bvd2VyX29uKGRkYXRhKTsKLX0KLQogc3RhdGljIGludCBkc2lj
bV9jb25uZWN0KHN0cnVjdCBvbWFwX2Rzc19kZXZpY2UgKnNyYywKIAkJCSBzdHJ1Y3Qgb21hcF9k
c3NfZGV2aWNlICpkc3QpCiB7CkBAIC02NzEsMTcgKzQ2MCwxMiBAQCBzdGF0aWMgdm9pZCBkc2lj
bV9lbmFibGUoc3RydWN0IG9tYXBfZHNzX2RldmljZSAqZHNzZGV2KQogc3RhdGljIHZvaWQgZHNp
Y21fZGlzYWJsZShzdHJ1Y3Qgb21hcF9kc3NfZGV2aWNlICpkc3NkZXYpCiB7CiAJc3RydWN0IHBh
bmVsX2Rydl9kYXRhICpkZGF0YSA9IHRvX3BhbmVsX2RhdGEoZHNzZGV2KTsKLQlpbnQgcjsKIAog
CWRzaWNtX2JsX3Bvd2VyKGRkYXRhLCBmYWxzZSk7CiAKIAltdXRleF9sb2NrKCZkZGF0YS0+bG9j
ayk7CiAKLQlkc2ljbV9jYW5jZWxfdWxwc193b3JrKGRkYXRhKTsKLQotCXIgPSBkc2ljbV93YWtl
X3VwKGRkYXRhKTsKLQlpZiAoIXIpCi0JCWRzaWNtX3Bvd2VyX29mZihkZGF0YSk7CisJZHNpY21f
cG93ZXJfb2ZmKGRkYXRhKTsKIAogCW11dGV4X3VubG9jaygmZGRhdGEtPmxvY2spOwogfQpAQCAt
NzA1LDEwICs0ODksNiBAQCBzdGF0aWMgaW50IGRzaWNtX3VwZGF0ZShzdHJ1Y3Qgb21hcF9kc3Nf
ZGV2aWNlICpkc3NkZXYsCiAKIAltdXRleF9sb2NrKCZkZGF0YS0+bG9jayk7CiAKLQlyID0gZHNp
Y21fd2FrZV91cChkZGF0YSk7Ci0JaWYgKHIpCi0JCWdvdG8gZXJyOwotCiAJaWYgKCFkZGF0YS0+
ZW5hYmxlZCkgewogCQlyID0gMDsKIAkJZ290byBlcnI7CkBAIC03NDgsMjQgKzUyOCw2IEBAIHN0
YXRpYyBpbnQgX2RzaWNtX2VuYWJsZV90ZShzdHJ1Y3QgcGFuZWxfZHJ2X2RhdGEgKmRkYXRhLCBi
b29sIGVuYWJsZSkKIAlyZXR1cm4gcjsKIH0KIAotc3RhdGljIHZvaWQgZHNpY21fdWxwc193b3Jr
KHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykKLXsKLQlzdHJ1Y3QgcGFuZWxfZHJ2X2RhdGEgKmRk
YXRhID0gY29udGFpbmVyX29mKHdvcmssIHN0cnVjdCBwYW5lbF9kcnZfZGF0YSwKLQkJCXVscHNf
d29yay53b3JrKTsKLQlzdHJ1Y3Qgb21hcF9kc3NfZGV2aWNlICpkc3NkZXYgPSAmZGRhdGEtPmRz
c2RldjsKLQotCW11dGV4X2xvY2soJmRkYXRhLT5sb2NrKTsKLQotCWlmIChkc3NkZXYtPnN0YXRl
ICE9IE9NQVBfRFNTX0RJU1BMQVlfQUNUSVZFIHx8ICFkZGF0YS0+ZW5hYmxlZCkgewotCQltdXRl
eF91bmxvY2soJmRkYXRhLT5sb2NrKTsKLQkJcmV0dXJuOwotCX0KLQotCWRzaWNtX2VudGVyX3Vs
cHMoZGRhdGEpOwotCi0JbXV0ZXhfdW5sb2NrKCZkZGF0YS0+bG9jayk7Ci19Ci0KIHN0YXRpYyBp
bnQgZHNpY21fZ2V0X21vZGVzKHN0cnVjdCBvbWFwX2Rzc19kZXZpY2UgKmRzc2RldiwKIAkJCSAg
IHN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IpCiB7CkBAIC04NjUsNyArNjI3LDcgQEAg
c3RhdGljIGludCBkc2ljbV9wcm9iZV9vZihzdHJ1Y3QgbWlwaV9kc2lfZGV2aWNlICpkc2kpCiAJ
CWRkYXRhLT51c2VfZHNpX2JhY2tsaWdodCA9IHRydWU7CiAJfQogCi0JLyogVE9ETzogdWxwcyAq
LworCS8qIFRPRE86IHVscHNfZW5hYmxlZCAqLwogCiAJcmV0dXJuIDA7CiB9CkBAIC05MTMsMTMg
KzY3NSw2IEBAIHN0YXRpYyBpbnQgZHNpY21fcHJvYmUoc3RydWN0IG1pcGlfZHNpX2RldmljZSAq
ZHNpKQogCiAJbXV0ZXhfaW5pdCgmZGRhdGEtPmxvY2spOwogCi0JZGRhdGEtPndvcmtxdWV1ZSA9
IGNyZWF0ZV9zaW5nbGV0aHJlYWRfd29ya3F1ZXVlKCJkc2ljbV93cSIpOwotCWlmICghZGRhdGEt
PndvcmtxdWV1ZSkgewotCQlyID0gLUVOT01FTTsKLQkJZ290byBlcnJfcmVnOwotCX0KLQlJTklU
X0RFTEFZRURfV09SSygmZGRhdGEtPnVscHNfd29yaywgZHNpY21fdWxwc193b3JrKTsKLQogCWRz
aWNtX2h3X3Jlc2V0KGRkYXRhKTsKIAogCWlmIChkZGF0YS0+dXNlX2RzaV9iYWNrbGlnaHQpIHsK
QEAgLTk1MCw2ICs3MDUsOSBAQCBzdGF0aWMgaW50IGRzaWNtX3Byb2JlKHN0cnVjdCBtaXBpX2Rz
aV9kZXZpY2UgKmRzaSkKIAlkc2ktPmhzX3JhdGUgPSAzMDAwMDAwMDA7CiAJZHNpLT5scF9yYXRl
ID0gMTAwMDAwMDA7CiAKKwlpZiAoZGRhdGEtPnVscHNfZW5hYmxlZCkKKwkJZHNpLT5tb2RlX2Zs
YWdzIHw9IE1JUElfRFNJX01PREVfVUxQU19JRExFOworCiAJciA9IG1pcGlfZHNpX2F0dGFjaChk
c2kpOwogCWlmIChyIDwgMCkKIAkJZ290byBlcnJfZHNpX2F0dGFjaDsKQEAgLTk1OSw4ICs3MTcs
NiBAQCBzdGF0aWMgaW50IGRzaWNtX3Byb2JlKHN0cnVjdCBtaXBpX2RzaV9kZXZpY2UgKmRzaSkK
IGVycl9kc2lfYXR0YWNoOgogCXN5c2ZzX3JlbW92ZV9ncm91cCgmZHNpLT5kZXYua29iaiwgJmRz
aWNtX2F0dHJfZ3JvdXApOwogZXJyX2JsOgotCWRlc3Ryb3lfd29ya3F1ZXVlKGRkYXRhLT53b3Jr
cXVldWUpOwotZXJyX3JlZzoKIAlpZiAoZGRhdGEtPmV4dGJsZGV2KQogCQlwdXRfZGV2aWNlKCZk
ZGF0YS0+ZXh0YmxkZXYtPmRldik7CiAKQEAgLTk4Nyw5ICs3NDMsNiBAQCBzdGF0aWMgaW50IF9f
ZXhpdCBkc2ljbV9yZW1vdmUoc3RydWN0IG1pcGlfZHNpX2RldmljZSAqZHNpKQogCWlmIChkZGF0
YS0+ZXh0YmxkZXYpCiAJCXB1dF9kZXZpY2UoJmRkYXRhLT5leHRibGRldi0+ZGV2KTsKIAotCWRz
aWNtX2NhbmNlbF91bHBzX3dvcmsoZGRhdGEpOwotCWRlc3Ryb3lfd29ya3F1ZXVlKGRkYXRhLT53
b3JrcXVldWUpOwotCiAJLyogcmVzZXQsIHRvIGJlIHN1cmUgdGhhdCB0aGUgcGFuZWwgaXMgaW4g
YSB2YWxpZCBzdGF0ZSAqLwogCWRzaWNtX2h3X3Jlc2V0KGRkYXRhKTsKIApkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL29tYXBkcm0vZHNzL2RzaS5jIGIvZHJpdmVycy9ncHUvZHJtL29tYXBk
cm0vZHNzL2RzaS5jCmluZGV4IGQyMDBiN2E2ZjkzYy4uMzVjMGNlNzJjZDE1IDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vb21hcGRybS9kc3MvZHNpLmMKKysrIGIvZHJpdmVycy9ncHUvZHJt
L29tYXBkcm0vZHNzL2RzaS5jCkBAIC0yMTAsNiArMjEwLDggQEAgc3RydWN0IGRzaV9yZWcgeyB1
MTYgbW9kdWxlOyB1MTYgaWR4OyB9OwogdHlwZWRlZiB2b2lkICgqb21hcF9kc2lfaXNyX3QpICh2
b2lkICphcmcsIHUzMiBtYXNrKTsKIHN0cnVjdCBkc2lfZGF0YTsKIAorc3RhdGljIHZvaWQgZHNp
X3NldF91bHBzX2F1dG8oc3RydWN0IGRzaV9kYXRhICpkc2ksIGJvb2wgZW5hYmxlKTsKKwogc3Rh
dGljIGludCBkc2lfZGlzcGxheV9pbml0X2Rpc3BjKHN0cnVjdCBkc2lfZGF0YSAqZHNpKTsKIHN0
YXRpYyB2b2lkIGRzaV9kaXNwbGF5X3VuaW5pdF9kaXNwYyhzdHJ1Y3QgZHNpX2RhdGEgKmRzaSk7
CiAKQEAgLTM4MCw2ICszODIsOSBAQCBzdHJ1Y3QgZHNpX2RhdGEgewogCiAJYm9vbCB0ZV9lbmFi
bGVkOwogCWJvb2wgdWxwc19lbmFibGVkOworCWJvb2wgdWxwc19hdXRvX2lkbGU7CisKKwlzdHJ1
Y3QgZGVsYXllZF93b3JrIHVscHNfd29yazsKIAogCXZvaWQgKCpmcmFtZWRvbmVfY2FsbGJhY2sp
KGludCwgdm9pZCAqKTsKIAl2b2lkICpmcmFtZWRvbmVfZGF0YTsKQEAgLTM4MDEsNiArMzgwNiw3
IEBAIHN0YXRpYyB2b2lkIGRzaV9oYW5kbGVfZnJhbWVkb25lKHN0cnVjdCBkc2lfZGF0YSAqZHNp
LCBpbnQgZXJyb3IpCiAJCVJFR19GTERfTU9EKGRzaSwgRFNJX1RJTUlORzIsIDEsIDE1LCAxNSk7
IC8qIExQX1JYX1RPICovCiAJfQogCisJZHNpX3NldF91bHBzX2F1dG8oZHNpLCB0cnVlKTsKIAlk
c2lfYnVzX3VubG9jayhkc2kpOwogCiAJZHNpLT5mcmFtZWRvbmVfY2FsbGJhY2soZXJyb3IsIGRz
aS0+ZnJhbWVkb25lX2RhdGEpOwpAQCAtMzg2Myw2ICszODY5LDcgQEAgc3RhdGljIGludCBkc2lf
dXBkYXRlKHN0cnVjdCBvbWFwX2Rzc19kZXZpY2UgKmRzc2RldiwgaW50IGNoYW5uZWwsCiAJc3Ry
dWN0IGRzaV9kYXRhICpkc2kgPSB0b19kc2lfZGF0YShkc3NkZXYpOwogCiAJZHNpX2J1c19sb2Nr
KGRzaSk7CisJZHNpX3NldF91bHBzX2F1dG8oZHNpLCBmYWxzZSk7CiAKIAlkc2ktPnVwZGF0ZV9j
aGFubmVsID0gY2hhbm5lbDsKIAlkc2ktPmZyYW1lZG9uZV9jYWxsYmFjayA9IGNhbGxiYWNrOwpA
QCAtNDEyNCwxNiArNDEzMSw2IEBAIHN0YXRpYyB2b2lkIGRzaV9kaXNwbGF5X2Rpc2FibGUoc3Ry
dWN0IG9tYXBfZHNzX2RldmljZSAqZHNzZGV2KQogCWRzaV9kaXNwbGF5X3VscHNfZGlzYWJsZShk
c2ksIHRydWUsIGZhbHNlKTsKIH0KIAotc3RhdGljIHZvaWQgZHNpX3VscHMoc3RydWN0IG9tYXBf
ZHNzX2RldmljZSAqZHNzZGV2LCBib29sIGVuYWJsZSkKLXsKLQlzdHJ1Y3QgZHNpX2RhdGEgKmRz
aSA9IHRvX2RzaV9kYXRhKGRzc2Rldik7Ci0JRFNTREJHKCJkc2lfdWxwc1xuIik7Ci0JaWYgKGVu
YWJsZSkKLQkJZHNpX2Rpc3BsYXlfdWxwc19kaXNhYmxlKGRzaSwgZmFsc2UsIHRydWUpOwotCWVs
c2UKLQkJZHNpX2Rpc3BsYXlfdWxwc19lbmFibGUoZHNpKTsKLX0KLQogc3RhdGljIGludCBkc2lf
ZW5hYmxlX3RlKHN0cnVjdCBkc2lfZGF0YSAqZHNpLCBib29sIGVuYWJsZSkKIHsKIAlkc2ktPnRl
X2VuYWJsZWQgPSBlbmFibGU7CkBAIC00MTQ4LDYgKzQxNDUsNDAgQEAgc3RhdGljIGludCBkc2lf
ZW5hYmxlX3RlKHN0cnVjdCBkc2lfZGF0YSAqZHNpLCBib29sIGVuYWJsZSkKIAlyZXR1cm4gMDsK
IH0KIAorc3RhdGljIHZvaWQgb21hcF9kc2lfdWxwc193b3JrX2NhbGxiYWNrKHN0cnVjdCB3b3Jr
X3N0cnVjdCAqd29yaykKK3sKKwlzdHJ1Y3QgZHNpX2RhdGEgKmRzaSA9IGNvbnRhaW5lcl9vZih3
b3JrLCBzdHJ1Y3QgZHNpX2RhdGEsCisJCQkJCSAgICB1bHBzX3dvcmsud29yayk7CisKKwlkc2lf
YnVzX2xvY2soZHNpKTsKKworCWRzaV9lbmFibGVfdGUoZHNpLCBmYWxzZSk7CisKKwlkc2lfZGlz
cGxheV91bHBzX2Rpc2FibGUoZHNpLCBmYWxzZSwgdHJ1ZSk7CisKKwlkc2lfYnVzX3VubG9jayhk
c2kpOworfQorCitzdGF0aWMgdm9pZCBkc2lfc2V0X3VscHNfYXV0byhzdHJ1Y3QgZHNpX2RhdGEg
KmRzaSwgYm9vbCBlbmFibGUpCit7CisJV0FSTl9PTighZHNpX2J1c19pc19sb2NrZWQoZHNpKSk7
CisKKwlpZiAoIWRzaS0+dWxwc19hdXRvX2lkbGUpCisJCXJldHVybjsKKworCWlmIChlbmFibGUp
IHsKKwkJc2NoZWR1bGVfZGVsYXllZF93b3JrKCZkc2ktPnVscHNfd29yaywgbXNlY3NfdG9famlm
ZmllcygyNTApKTsKKwl9IGVsc2UgeworCQljYW5jZWxfZGVsYXllZF93b3JrX3N5bmMoJmRzaS0+
dWxwc193b3JrKTsKKworCQlpZiAoIWRzaS0+dWxwc19lbmFibGVkKQorCQkJcmV0dXJuOworCisJ
CWRzaV9kaXNwbGF5X3VscHNfZW5hYmxlKGRzaSk7CisJCWRzaV9lbmFibGVfdGUoZHNpLCB0cnVl
KTsKKwl9Cit9CisKICNpZmRlZiBQUklOVF9WRVJCT1NFX1ZNX1RJTUlOR1MKIHN0YXRpYyB2b2lk
IHByaW50X2RzaV92bShjb25zdCBjaGFyICpzdHIsCiAJCWNvbnN0IHN0cnVjdCBvbWFwX2Rzc19k
c2lfdmlkZW9tb2RlX3RpbWluZ3MgKnQpCkBAIC00Nzk4LDcgKzQ4MjksOSBAQCBzdGF0aWMgc3Np
emVfdCBvbWFwX2RzaV9ob3N0X3RyYW5zZmVyKHN0cnVjdCBtaXBpX2RzaV9ob3N0ICpob3N0LAog
CWludCByOwogCiAJZHNpX2J1c19sb2NrKGRzaSk7CisJZHNpX3NldF91bHBzX2F1dG8oZHNpLCBm
YWxzZSk7CiAJciA9IF9vbWFwX2RzaV9ob3N0X3RyYW5zZmVyKGRzaSwgbXNnKTsKKwlkc2lfc2V0
X3VscHNfYXV0byhkc2ksIHRydWUpOwogCWRzaV9idXNfdW5sb2NrKGRzaSk7CiAKIAlyZXR1cm4g
cjsKQEAgLTQ4MzgsOCArNDg3MSw2IEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3Qgb21hcF9kc3NfZGV2
aWNlX29wcyBkc2lfb3BzID0gewogCS5kaXNhYmxlID0gZHNpX2Rpc3BsYXlfZGlzYWJsZSwKIAog
CS5kc2kgPSB7Ci0JCS51bHBzID0gZHNpX3VscHMsCi0KIAkJLnNldF9jb25maWcgPSBkc2lfc2V0
X2NvbmZpZywKIAogCQkuZW5hYmxlX3ZpZGVvX291dHB1dCA9IGRzaV9lbmFibGVfdmlkZW9fb3V0
cHV0LApAQCAtNDk1OCw2ICs0OTg5LDEyIEBAIGludCBvbWFwX2RzaV9ob3N0X2F0dGFjaChzdHJ1
Y3QgbWlwaV9kc2lfaG9zdCAqaG9zdCwKIAlkc2ktPnZjW2NoYW5uZWxdLmRlc3QgPSBjbGllbnQ7
CiAJZHNpLT5waXhfZm10ID0gY2xpZW50LT5mb3JtYXQ7CiAKKwlJTklUX0RFRkVSUkFCTEVfV09S
SygmZHNpLT51bHBzX3dvcmssCisJCQkgICAgIG9tYXBfZHNpX3VscHNfd29ya19jYWxsYmFjayk7
CisKKwlkc2ktPnVscHNfYXV0b19pZGxlID0gISEoY2xpZW50LT5tb2RlX2ZsYWdzICYgTUlQSV9E
U0lfTU9ERV9VTFBTX0lETEUpOworCWRzaV9zZXRfdWxwc19hdXRvKGRzaSwgdHJ1ZSk7CisKIAly
ZXR1cm4gMDsKIH0KIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL29tYXBkcm0vZHNzL29t
YXBkc3MuaCBiL2RyaXZlcnMvZ3B1L2RybS9vbWFwZHJtL2Rzcy9vbWFwZHNzLmgKaW5kZXggYWQ1
MjVjZjgwYWQ4Li43NGNmMDM3MWI4YmIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9vbWFw
ZHJtL2Rzcy9vbWFwZHNzLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL29tYXBkcm0vZHNzL29tYXBk
c3MuaApAQCAtMjg4LDggKzI4OCw2IEBAIHN0cnVjdCBvbWFwZHNzX2hkbWlfb3BzIHsKIAogc3Ry
dWN0IG9tYXBkc3NfZHNpX29wcyB7CiAJLyogYnVzIGNvbmZpZ3VyYXRpb24gKi8KLQl2b2lkICgq
dWxwcykoc3RydWN0IG9tYXBfZHNzX2RldmljZSAqZHNzZGV2LCBib29sIGVuYWJsZSk7Ci0KIAlp
bnQgKCpzZXRfY29uZmlnKShzdHJ1Y3Qgb21hcF9kc3NfZGV2aWNlICpkc3NkZXYsCiAJCQljb25z
dCBzdHJ1Y3Qgb21hcF9kc3NfZHNpX2NvbmZpZyAqY2ZnKTsKIAotLSAKMi4yNC4wCgpfX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGlu
ZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVl
ZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
