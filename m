Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 3BF16A7570
	for <lists+dri-devel@lfdr.de>; Tue,  3 Sep 2019 22:48:59 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 625B289C69;
	Tue,  3 Sep 2019 20:48:41 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 7213989C2C;
 Tue,  3 Sep 2019 20:48:39 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id F111C10C6973;
 Tue,  3 Sep 2019 20:48:38 +0000 (UTC)
Received: from malachite.bss.redhat.com (dhcp-10-20-1-34.bss.redhat.com
 [10.20.1.34])
 by smtp.corp.redhat.com (Postfix) with ESMTP id B255C1001956;
 Tue,  3 Sep 2019 20:48:37 +0000 (UTC)
From: Lyude Paul <lyude@redhat.com>
To: dri-devel@lists.freedesktop.org, nouveau@lists.freedesktop.org,
 amd-gfx@lists.freedesktop.org
Subject: [PATCH v2 20/27] drm/dp_mst: Protect drm_dp_mst_port members with
 connection_mutex
Date: Tue,  3 Sep 2019 16:45:58 -0400
Message-Id: <20190903204645.25487-21-lyude@redhat.com>
In-Reply-To: <20190903204645.25487-1-lyude@redhat.com>
References: <20190903204645.25487-1-lyude@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.65]); Tue, 03 Sep 2019 20:48:39 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sean Paul <sean@poorly.run>, David Airlie <airlied@linux.ie>,
 Daniel Vetter <daniel.vetter@ffwll.ch>, linux-kernel@vger.kernel.org,
 Maxime Ripard <mripard@kernel.org>, Juston Li <juston.li@intel.com>,
 Harry Wentland <hwentlan@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

WWVzLXlvdSByZWFkIHRoYXQgcmlnaHQuIEN1cnJlbnRseSB0aGVyZSBpcyBsaXRlcmFsbHkgbm8g
bG9ja2luZyBpbgpwbGFjZSBmb3IgYW55IG9mIHRoZSBkcm1fZHBfbXN0X3BvcnQgc3RydWN0IG1l
bWJlcnMgdGhhdCBjYW4gYmUgbW9kaWZpZWQKaW4gcmVzcG9uc2UgdG8gYSBsaW5rIGFkZHJlc3Mg
cmVzcG9uc2UsIG9yIGEgY29ubmVjdGlvbiBzdGF0dXMgcmVzcG9uc2UuCldoaWNoIGxpdGVyYWxs
eSBtZWFucyBpZiB3ZSdyZSB1bmx1Y2t5IGVub3VnaCB0byBoYXZlIGFueSBzb3J0IG9mCmhvdHBs
dWdnaW5nIGV2ZW50IGhhcHBlbiBiZWZvcmUgd2UncmUgZmluaXNoZWQgd2l0aCByZXByb2Jpbmcg
bGluawphZGRyZXNzZXMsIHdlJ2xsIHJhY2UgYW5kIHRoZSBjb250ZW50cyBvZiBzYWlkIHN0cnVj
dCBtZW1iZXJzIGJlY29tZXMKdW5kZWZpbmVkLiBGdW4hCgpTbywgZmluYWxseSBhZGQgc29tZSBz
aW1wbGUgbG9ja2luZyBwcm90ZWN0aW9ucyB0byBvdXIgTVNUIGhlbHBlcnMgYnkKcHJvdGVjdGlu
ZyBhbnkgZHJtX2RwX21zdF9wb3J0IG1lbWJlcnMgd2hpY2ggY2FuIGJlIGNoYW5nZWQgYnkgbGlu
awphZGRyZXNzIHJlc3BvbnNlcyBvciBjb25uZWN0aW9uIHN0YXR1cyBub3RpZmljYXRpb25zIHVu
ZGVyCmRybV9kZXZpY2UtPm1vZGVfY29uZmlnLmNvbm5lY3Rpb25fbXV0ZXguCgpDYzogSnVzdG9u
IExpIDxqdXN0b24ubGlAaW50ZWwuY29tPgpDYzogSW1yZSBEZWFrIDxpbXJlLmRlYWtAaW50ZWwu
Y29tPgpDYzogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4K
Q2M6IEhhcnJ5IFdlbnRsYW5kIDxod2VudGxhbkBhbWQuY29tPgpDYzogRGFuaWVsIFZldHRlciA8
ZGFuaWVsLnZldHRlckBmZndsbC5jaD4KU2lnbmVkLW9mZi1ieTogTHl1ZGUgUGF1bCA8bHl1ZGVA
cmVkaGF0LmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5jIHwg
MTQ0ICsrKysrKysrKysrKysrKysrKystLS0tLS0tCiBpbmNsdWRlL2RybS9kcm1fZHBfbXN0X2hl
bHBlci5oICAgICAgIHwgIDM5ICsrKysrLS0KIDIgZmlsZXMgY2hhbmdlZCwgMTMzIGluc2VydGlv
bnMoKyksIDUwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9kcm1f
ZHBfbXN0X3RvcG9sb2d5LmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5j
CmluZGV4IDUxMDFlZWFiNDQ4NS4uMjU5NjM0YzVkNmRjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZHBf
bXN0X3RvcG9sb2d5LmMKQEAgLTEzNTQsNiArMTM1NCw3IEBAIHN0YXRpYyB2b2lkIGRybV9kcF9m
cmVlX21zdF9wb3J0KHN0cnVjdCBrcmVmICprcmVmKQogCQljb250YWluZXJfb2Yoa3JlZiwgc3Ry
dWN0IGRybV9kcF9tc3RfcG9ydCwgbWFsbG9jX2tyZWYpOwogCiAJZHJtX2RwX21zdF9wdXRfbXN0
Yl9tYWxsb2MocG9ydC0+cGFyZW50KTsKKwltdXRleF9kZXN0cm95KCZwb3J0LT5sb2NrKTsKIAlr
ZnJlZShwb3J0KTsKIH0KIApAQCAtMTkwNiw2ICsxOTA3LDM2IEBAIHZvaWQgZHJtX2RwX21zdF9j
b25uZWN0b3JfZWFybHlfdW5yZWdpc3RlcihzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqY29ubmVjdG9y
LAogfQogRVhQT1JUX1NZTUJPTChkcm1fZHBfbXN0X2Nvbm5lY3Rvcl9lYXJseV91bnJlZ2lzdGVy
KTsKIAorc3RhdGljIHZvaWQKK2RybV9kcF9tc3RfcG9ydF9hZGRfY29ubmVjdG9yKHN0cnVjdCBk
cm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKKwkJCSAgICAgIHN0cnVjdCBkcm1fZHBfbXN0X3BvcnQg
KnBvcnQpCit7CisJc3RydWN0IGRybV9kcF9tc3RfdG9wb2xvZ3lfbWdyICptZ3IgPSBwb3J0LT5t
Z3I7CisJY2hhciBwcm9wcGF0aFsyNTVdOworCWludCByZXQ7CisKKwlidWlsZF9tc3RfcHJvcF9w
YXRoKG1zdGIsIHBvcnQtPnBvcnRfbnVtLCBwcm9wcGF0aCwgc2l6ZW9mKHByb3BwYXRoKSk7CisJ
cG9ydC0+Y29ubmVjdG9yID0gbWdyLT5jYnMtPmFkZF9jb25uZWN0b3IobWdyLCBwb3J0LCBwcm9w
cGF0aCk7CisJaWYgKCFwb3J0LT5jb25uZWN0b3IpIHsKKwkJcmV0ID0gLUVOT01FTTsKKwkJZ290
byBlcnJvcjsKKwl9CisKKwlpZiAoKHBvcnQtPnBkdCA9PSBEUF9QRUVSX0RFVklDRV9EUF9MRUdB
Q1lfQ09OViB8fAorCSAgICAgcG9ydC0+cGR0ID09IERQX1BFRVJfREVWSUNFX1NTVF9TSU5LKSAm
JgorCSAgICBwb3J0LT5wb3J0X251bSA+PSBEUF9NU1RfTE9HSUNBTF9QT1JUXzApIHsKKwkJcG9y
dC0+Y2FjaGVkX2VkaWQgPSBkcm1fZ2V0X2VkaWQocG9ydC0+Y29ubmVjdG9yLAorCQkJCQkJICZw
b3J0LT5hdXguZGRjKTsKKwkJZHJtX2Nvbm5lY3Rvcl9zZXRfdGlsZV9wcm9wZXJ0eShwb3J0LT5j
b25uZWN0b3IpOworCX0KKworCW1nci0+Y2JzLT5yZWdpc3Rlcl9jb25uZWN0b3IocG9ydC0+Y29u
bmVjdG9yKTsKKwlyZXR1cm47CisKK2Vycm9yOgorCURSTV9FUlJPUigiRmFpbGVkIHRvIGNyZWF0
ZSBjb25uZWN0b3IgZm9yIHBvcnQgJXA6ICVkXG4iLCBwb3J0LCByZXQpOworfQorCiBzdGF0aWMg
dm9pZAogZHJtX2RwX21zdF9oYW5kbGVfbGlua19hZGRyZXNzX3BvcnQoc3RydWN0IGRybV9kcF9t
c3RfYnJhbmNoICptc3RiLAogCQkJCSAgICBzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LApAQCAtMTkx
Myw4ICsxOTQ0LDEyIEBAIGRybV9kcF9tc3RfaGFuZGxlX2xpbmtfYWRkcmVzc19wb3J0KHN0cnVj
dCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKIHsKIAlzdHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9n
eV9tZ3IgKm1nciA9IG1zdGItPm1ncjsKIAlzdHJ1Y3QgZHJtX2RwX21zdF9wb3J0ICpwb3J0Owot
CWJvb2wgY3JlYXRlZCA9IGZhbHNlOwotCWludCBvbGRfZGRwcyA9IDA7CisJc3RydWN0IGRybV9k
cF9tc3RfYnJhbmNoICpjaGlsZF9tc3RiID0gTlVMTDsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAq
Y29ubmVjdG9yX3RvX2Rlc3Ryb3kgPSBOVUxMOworCWludCBvbGRfZGRwcyA9IDAsIHJldDsKKwl1
OCBuZXdfcGR0ID0gRFBfUEVFUl9ERVZJQ0VfTk9ORTsKKwlib29sIGNyZWF0ZWQgPSBmYWxzZSwg
c2VuZF9saW5rX2FkZHIgPSBmYWxzZSwKKwkgICAgIGNyZWF0ZV9jb25uZWN0b3IgPSBmYWxzZTsK
IAogCXBvcnQgPSBkcm1fZHBfZ2V0X3BvcnQobXN0YiwgcG9ydF9tc2ctPnBvcnRfbnVtYmVyKTsK
IAlpZiAoIXBvcnQpIHsKQEAgLTE5MjMsNiArMTk1OCw3IEBAIGRybV9kcF9tc3RfaGFuZGxlX2xp
bmtfYWRkcmVzc19wb3J0KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKIAkJCXJldHVy
bjsKIAkJa3JlZl9pbml0KCZwb3J0LT50b3BvbG9neV9rcmVmKTsKIAkJa3JlZl9pbml0KCZwb3J0
LT5tYWxsb2Nfa3JlZik7CisJCW11dGV4X2luaXQoJnBvcnQtPmxvY2spOwogCQlwb3J0LT5wYXJl
bnQgPSBtc3RiOwogCQlwb3J0LT5wb3J0X251bSA9IHBvcnRfbXNnLT5wb3J0X251bWJlcjsKIAkJ
cG9ydC0+bWdyID0gbWdyOwpAQCAtMTkzNywxMSArMTk3MywxNyBAQCBkcm1fZHBfbXN0X2hhbmRs
ZV9saW5rX2FkZHJlc3NfcG9ydChzdHJ1Y3QgZHJtX2RwX21zdF9icmFuY2ggKm1zdGIsCiAJCWRy
bV9kcF9tc3RfZ2V0X21zdGJfbWFsbG9jKG1zdGIpOwogCiAJCWNyZWF0ZWQgPSB0cnVlOwotCX0g
ZWxzZSB7Ci0JCW9sZF9kZHBzID0gcG9ydC0+ZGRwczsKIAl9CiAKKwltdXRleF9sb2NrKCZwb3J0
LT5sb2NrKTsKKwlkcm1fbW9kZXNldF9sb2NrKCZkZXYtPm1vZGVfY29uZmlnLmNvbm5lY3Rpb25f
bXV0ZXgsIE5VTEwpOworCisJaWYgKCFjcmVhdGVkKQorCQlvbGRfZGRwcyA9IHBvcnQtPmRkcHM7
CisKIAlwb3J0LT5pbnB1dCA9IHBvcnRfbXNnLT5pbnB1dF9wb3J0OworCWlmICghcG9ydC0+aW5w
dXQpCisJCW5ld19wZHQgPSBwb3J0X21zZy0+cGVlcl9kZXZpY2VfdHlwZTsKIAlwb3J0LT5tY3Mg
PSBwb3J0X21zZy0+bWNzOwogCXBvcnQtPmRkcHMgPSBwb3J0X21zZy0+ZGRwczsKIAlwb3J0LT5s
ZHBzID0gcG9ydF9tc2ctPmxlZ2FjeV9kZXZpY2VfcGx1Z19zdGF0dXM7CkBAIC0xOTY5LDQ0ICsy
MDExLDU4IEBAIGRybV9kcF9tc3RfaGFuZGxlX2xpbmtfYWRkcmVzc19wb3J0KHN0cnVjdCBkcm1f
ZHBfbXN0X2JyYW5jaCAqbXN0YiwKIAkJfQogCX0KIAotCWlmICghcG9ydC0+aW5wdXQpIHsKLQkJ
aW50IHJldCA9IGRybV9kcF9wb3J0X3NldF9wZHQocG9ydCwKLQkJCQkJICAgICAgcG9ydF9tc2ct
PnBlZXJfZGV2aWNlX3R5cGUpOwotCQlpZiAocmV0ID09IDEpIHsKLQkJCWRybV9kcF9zZW5kX2xp
bmtfYWRkcmVzcyhtZ3IsIHBvcnQtPm1zdGIpOwotCQl9IGVsc2UgaWYgKHJldCA8IDApIHsKLQkJ
CURSTV9FUlJPUigiRmFpbGVkIHRvIGNoYW5nZSBQRFQgb24gcG9ydCAlcDogJWRcbiIsCi0JCQkJ
ICBwb3J0LCByZXQpOwotCQkJZ290byBmYWlsOworCXJldCA9IGRybV9kcF9wb3J0X3NldF9wZHQo
cG9ydCwgbmV3X3BkdCk7CisJaWYgKHJldCA9PSAxKSB7CisJCXNlbmRfbGlua19hZGRyID0gdHJ1
ZTsKKwl9IGVsc2UgaWYgKHJldCA8IDApIHsKKwkJRFJNX0VSUk9SKCJGYWlsZWQgdG8gY2hhbmdl
IFBEVCBvbiBwb3J0ICVwOiAlZFxuIiwKKwkJCSAgcG9ydCwgcmV0KTsKKwkJZ290byBmYWlsX3Vu
bG9jazsKKwl9CisKKwlpZiAoc2VuZF9saW5rX2FkZHIpIHsKKwkJbXV0ZXhfbG9jaygmbWdyLT5s
b2NrKTsKKwkJaWYgKHBvcnQtPm1zdGIpIHsKKwkJCWNoaWxkX21zdGIgPSBwb3J0LT5tc3RiOwor
CQkJZHJtX2RwX21zdF9nZXRfbXN0Yl9tYWxsb2MoY2hpbGRfbXN0Yik7CiAJCX0KKwkJbXV0ZXhf
dW5sb2NrKCZtZ3ItPmxvY2spOwogCX0KIAotCWlmIChjcmVhdGVkICYmICFwb3J0LT5pbnB1dCkg
ewotCQljaGFyIHByb3BwYXRoWzI1NV07CisJLyoKKwkgKiBXZSB1bnNldCBwb3J0LT5jb25uZWN0
b3IgYmVmb3JlIGRyb3BwaW5nIGNvbm5lY3Rpb25fbXV0ZXggc28gdGhhdAorCSAqIHRoZXJlJ3Mg
bm8gY2hhbmNlIGFueSBvZiB0aGUgYXRvbWljIE1TVCBoZWxwZXJzIGNhbiBhY2NpZGVudGFsbHkK
KwkgKiBhc3NvY2lhdGUgYSB0by1iZS1kZXN0cm95ZWQgY29ubmVjdG9yIHdpdGggYSBwb3J0Lgor
CSAqLworCWlmIChwb3J0LT5jb25uZWN0b3IgJiYgcG9ydC0+aW5wdXQpIHsKKwkJY29ubmVjdG9y
X3RvX2Rlc3Ryb3kgPSBwb3J0LT5jb25uZWN0b3I7CisJCXBvcnQtPmNvbm5lY3RvciA9IE5VTEw7
CisJfSBlbHNlIGlmICghcG9ydC0+Y29ubmVjdG9yICYmICFwb3J0LT5pbnB1dCkgeworCQljcmVh
dGVfY29ubmVjdG9yID0gdHJ1ZTsKKwl9CiAKLQkJYnVpbGRfbXN0X3Byb3BfcGF0aChtc3RiLCBw
b3J0LT5wb3J0X251bSwgcHJvcHBhdGgsCi0JCQkJICAgIHNpemVvZihwcm9wcGF0aCkpOwotCQlw
b3J0LT5jb25uZWN0b3IgPSAoKm1nci0+Y2JzLT5hZGRfY29ubmVjdG9yKShtZ3IsIHBvcnQsCi0J
CQkJCQkJICAgICBwcm9wcGF0aCk7Ci0JCWlmICghcG9ydC0+Y29ubmVjdG9yKQotCQkJZ290byBm
YWlsOworCWRybV9tb2Rlc2V0X3VubG9jaygmZGV2LT5tb2RlX2NvbmZpZy5jb25uZWN0aW9uX211
dGV4KTsKIAotCQlpZiAoKHBvcnQtPnBkdCA9PSBEUF9QRUVSX0RFVklDRV9EUF9MRUdBQ1lfQ09O
ViB8fAotCQkgICAgIHBvcnQtPnBkdCA9PSBEUF9QRUVSX0RFVklDRV9TU1RfU0lOSykgJiYKLQkJ
ICAgIHBvcnQtPnBvcnRfbnVtID49IERQX01TVF9MT0dJQ0FMX1BPUlRfMCkgewotCQkJcG9ydC0+
Y2FjaGVkX2VkaWQgPSBkcm1fZ2V0X2VkaWQocG9ydC0+Y29ubmVjdG9yLAotCQkJCQkJCSAmcG9y
dC0+YXV4LmRkYyk7Ci0JCQlkcm1fY29ubmVjdG9yX3NldF90aWxlX3Byb3BlcnR5KHBvcnQtPmNv
bm5lY3Rvcik7Ci0JCX0KKwlpZiAoY29ubmVjdG9yX3RvX2Rlc3Ryb3kpCisJCW1nci0+Y2JzLT5k
ZXN0cm95X2Nvbm5lY3RvcihtZ3IsIGNvbm5lY3Rvcl90b19kZXN0cm95KTsKKwllbHNlIGlmIChj
cmVhdGVfY29ubmVjdG9yKQorCQlkcm1fZHBfbXN0X3BvcnRfYWRkX2Nvbm5lY3Rvcihtc3RiLCBw
b3J0KTsKKworCW11dGV4X3VubG9jaygmcG9ydC0+bG9jayk7CiAKLQkJKCptZ3ItPmNicy0+cmVn
aXN0ZXJfY29ubmVjdG9yKShwb3J0LT5jb25uZWN0b3IpOworCWlmIChzZW5kX2xpbmtfYWRkciAm
JiBjaGlsZF9tc3RiKSB7CisJCWRybV9kcF9zZW5kX2xpbmtfYWRkcmVzcyhtZ3IsIGNoaWxkX21z
dGIpOworCQlkcm1fZHBfbXN0X3B1dF9tc3RiX21hbGxvYyhjaGlsZF9tc3RiKTsKIAl9CiAKIAkv
KiBwdXQgcmVmZXJlbmNlIHRvIHRoaXMgcG9ydCAqLwogCWRybV9kcF9tc3RfdG9wb2xvZ3lfcHV0
X3BvcnQocG9ydCk7CiAJcmV0dXJuOwogCi1mYWlsOgorZmFpbF91bmxvY2s6CisJZHJtX21vZGVz
ZXRfdW5sb2NrKCZkZXYtPm1vZGVfY29uZmlnLmNvbm5lY3Rpb25fbXV0ZXgpOworCW11dGV4X3Vu
bG9jaygmcG9ydC0+bG9jayk7CisKIAkvKiBSZW1vdmUgaXQgZnJvbSB0aGUgcG9ydCBsaXN0ICov
CiAJbXV0ZXhfbG9jaygmbWdyLT5sb2NrKTsKIAlsaXN0X2RlbCgmcG9ydC0+bmV4dCk7CkBAIC0y
MDIyLDYgKzIwNzgsNyBAQCBzdGF0aWMgdm9pZAogZHJtX2RwX21zdF9oYW5kbGVfY29ubl9zdGF0
KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKIAkJCSAgICBzdHJ1Y3QgZHJtX2RwX2Nv
bm5lY3Rpb25fc3RhdHVzX25vdGlmeSAqY29ubl9zdGF0KQogeworCXN0cnVjdCBkcm1fZGV2aWNl
ICpkZXYgPSBtc3RiLT5tZ3ItPmRldjsKIAlzdHJ1Y3QgZHJtX2RwX21zdF9wb3J0ICpwb3J0Owog
CWludCBvbGRfZGRwczsKIAlib29sIGRvd29yayA9IGZhbHNlOwpAQCAtMjAzMCw2ICsyMDg3LDgg
QEAgZHJtX2RwX21zdF9oYW5kbGVfY29ubl9zdGF0KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAq
bXN0YiwKIAlpZiAoIXBvcnQpCiAJCXJldHVybjsKIAorCWRybV9tb2Rlc2V0X2xvY2soJmRldi0+
bW9kZV9jb25maWcuY29ubmVjdGlvbl9tdXRleCwgTlVMTCk7CisKIAlvbGRfZGRwcyA9IHBvcnQt
PmRkcHM7CiAJcG9ydC0+bWNzID0gY29ubl9zdGF0LT5tZXNzYWdlX2NhcGFiaWxpdHlfc3RhdHVz
OwogCXBvcnQtPmxkcHMgPSBjb25uX3N0YXQtPmxlZ2FjeV9kZXZpY2VfcGx1Z19zdGF0dXM7CkBA
IC0yMDU1LDYgKzIxMTQsNyBAQCBkcm1fZHBfbXN0X2hhbmRsZV9jb25uX3N0YXQoc3RydWN0IGRy
bV9kcF9tc3RfYnJhbmNoICptc3RiLAogCQl9CiAJfQogCisJZHJtX21vZGVzZXRfdW5sb2NrKCZk
ZXYtPm1vZGVfY29uZmlnLmNvbm5lY3Rpb25fbXV0ZXgpOwogCWRybV9kcF9tc3RfdG9wb2xvZ3lf
cHV0X3BvcnQocG9ydCk7CiAJaWYgKGRvd29yaykKIAkJcXVldWVfd29yayhzeXN0ZW1fbG9uZ193
cSwgJm1zdGItPm1nci0+d29yayk7CkBAIC0yMTQ3LDI4ICsyMjA3LDM0IEBAIGRybV9kcF9nZXRf
bXN0X2JyYW5jaF9kZXZpY2VfYnlfZ3VpZChzdHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3Ig
Km1nciwKIHN0YXRpYyB2b2lkIGRybV9kcF9jaGVja19hbmRfc2VuZF9saW5rX2FkZHJlc3Moc3Ry
dWN0IGRybV9kcF9tc3RfdG9wb2xvZ3lfbWdyICptZ3IsCiAJCQkJCSAgICAgICBzdHJ1Y3QgZHJt
X2RwX21zdF9icmFuY2ggKm1zdGIpCiB7CisJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IG1nci0+
ZGV2OwogCXN0cnVjdCBkcm1fZHBfbXN0X3BvcnQgKnBvcnQ7Ci0Jc3RydWN0IGRybV9kcF9tc3Rf
YnJhbmNoICptc3RiX2NoaWxkOworCiAJaWYgKCFtc3RiLT5saW5rX2FkZHJlc3Nfc2VudCkKIAkJ
ZHJtX2RwX3NlbmRfbGlua19hZGRyZXNzKG1nciwgbXN0Yik7CiAKIAlsaXN0X2Zvcl9lYWNoX2Vu
dHJ5KHBvcnQsICZtc3RiLT5wb3J0cywgbmV4dCkgewotCQlpZiAocG9ydC0+aW5wdXQpCi0JCQlj
b250aW51ZTsKKwkJc3RydWN0IGRybV9kcF9tc3RfYnJhbmNoICptc3RiX2NoaWxkID0gTlVMTDsK
KworCQlkcm1fbW9kZXNldF9sb2NrKCZkZXYtPm1vZGVfY29uZmlnLmNvbm5lY3Rpb25fbXV0ZXgs
IE5VTEwpOwogCi0JCWlmICghcG9ydC0+ZGRwcykKKwkJaWYgKHBvcnQtPmlucHV0IHx8ICFwb3J0
LT5kZHBzKSB7CisJCQlkcm1fbW9kZXNldF91bmxvY2soJmRldi0+bW9kZV9jb25maWcuY29ubmVj
dGlvbl9tdXRleCk7CiAJCQljb250aW51ZTsKKwkJfQogCiAJCWlmICghcG9ydC0+YXZhaWxhYmxl
X3BibikKIAkJCWRybV9kcF9zZW5kX2VudW1fcGF0aF9yZXNvdXJjZXMobWdyLCBtc3RiLCBwb3J0
KTsKIAotCQlpZiAocG9ydC0+bXN0YikgeworCQlpZiAocG9ydC0+bXN0YikKIAkJCW1zdGJfY2hp
bGQgPSBkcm1fZHBfbXN0X3RvcG9sb2d5X2dldF9tc3RiX3ZhbGlkYXRlZCgKIAkJCSAgICBtZ3Is
IHBvcnQtPm1zdGIpOwotCQkJaWYgKG1zdGJfY2hpbGQpIHsKLQkJCQlkcm1fZHBfY2hlY2tfYW5k
X3NlbmRfbGlua19hZGRyZXNzKG1nciwgbXN0Yl9jaGlsZCk7Ci0JCQkJZHJtX2RwX21zdF90b3Bv
bG9neV9wdXRfbXN0Yihtc3RiX2NoaWxkKTsKLQkJCX0KKworCQlkcm1fbW9kZXNldF91bmxvY2so
JmRldi0+bW9kZV9jb25maWcuY29ubmVjdGlvbl9tdXRleCk7CisKKwkJaWYgKG1zdGJfY2hpbGQp
IHsKKwkJCWRybV9kcF9jaGVja19hbmRfc2VuZF9saW5rX2FkZHJlc3MobWdyLCBtc3RiX2NoaWxk
KTsKKwkJCWRybV9kcF9tc3RfdG9wb2xvZ3lfcHV0X21zdGIobXN0Yl9jaGlsZCk7CiAJCX0KIAl9
CiB9CmRpZmYgLS1naXQgYS9pbmNsdWRlL2RybS9kcm1fZHBfbXN0X2hlbHBlci5oIGIvaW5jbHVk
ZS9kcm0vZHJtX2RwX21zdF9oZWxwZXIuaAppbmRleCA3ZDgwYzM4ZWUwMGUuLjFlZmJiMDg2Zjdh
YyAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vZHJtX2RwX21zdF9oZWxwZXIuaAorKysgYi9pbmNs
dWRlL2RybS9kcm1fZHBfbXN0X2hlbHBlci5oCkBAIC00NSwyMyArNDUsMzQgQEAgc3RydWN0IGRy
bV9kcF92Y3BpIHsKIC8qKgogICogc3RydWN0IGRybV9kcF9tc3RfcG9ydCAtIE1TVCBwb3J0CiAg
KiBAcG9ydF9udW06IHBvcnQgbnVtYmVyCi0gKiBAaW5wdXQ6IGlmIHRoaXMgcG9ydCBpcyBhbiBp
bnB1dCBwb3J0LgotICogQG1jczogbWVzc2FnZSBjYXBhYmlsaXR5IHN0YXR1cyAtIERQIDEuMiBz
cGVjLgotICogQGRkcHM6IERpc3BsYXlQb3J0IERldmljZSBQbHVnIFN0YXR1cyAtIERQIDEuMgot
ICogQHBkdDogUGVlciBEZXZpY2UgVHlwZQotICogQGxkcHM6IExlZ2FjeSBEZXZpY2UgUGx1ZyBT
dGF0dXMKLSAqIEBkcGNkX3JldjogRFBDRCByZXZpc2lvbiBvZiBkZXZpY2Ugb24gdGhpcyBwb3J0
Ci0gKiBAbnVtX3NkcF9zdHJlYW1zOiBOdW1iZXIgb2Ygc2ltdWx0YW5lb3VzIHN0cmVhbXMKLSAq
IEBudW1fc2RwX3N0cmVhbV9zaW5rczogTnVtYmVyIG9mIHN0cmVhbSBzaW5rcwotICogQGF2YWls
YWJsZV9wYm46IEF2YWlsYWJsZSBiYW5kd2lkdGggZm9yIHRoaXMgcG9ydC4KKyAqIEBpbnB1dDog
aWYgdGhpcyBwb3J0IGlzIGFuIGlucHV0IHBvcnQuIFByb3RlY3RlZCBieQorICogJmRybV9kZXZp
Y2UubW9kZV9jb25maWcuY29ubmVjdGlvbl9tdXRleC4KKyAqIEBtY3M6IG1lc3NhZ2UgY2FwYWJp
bGl0eSBzdGF0dXMgLSBEUCAxLjIgc3BlYy4gUHJvdGVjdGVkIGJ5CisgKiAmZHJtX2RldmljZS5t
b2RlX2NvbmZpZy5jb25uZWN0aW9uX211dGV4LgorICogQGRkcHM6IERpc3BsYXlQb3J0IERldmlj
ZSBQbHVnIFN0YXR1cyAtIERQIDEuMi4gUHJvdGVjdGVkIGJ5CisgKiAmZHJtX2RldmljZS5tb2Rl
X2NvbmZpZy5jb25uZWN0aW9uX211dGV4LgorICogQHBkdDogUGVlciBEZXZpY2UgVHlwZS4gUHJv
dGVjdGVkIGJ5CisgKiAmZHJtX2RldmljZS5tb2RlX2NvbmZpZy5jb25uZWN0aW9uX211dGV4Lgor
ICogQGxkcHM6IExlZ2FjeSBEZXZpY2UgUGx1ZyBTdGF0dXMuIFByb3RlY3RlZCBieQorICogJmRy
bV9kZXZpY2UubW9kZV9jb25maWcuY29ubmVjdGlvbl9tdXRleC4KKyAqIEBkcGNkX3JldjogRFBD
RCByZXZpc2lvbiBvZiBkZXZpY2Ugb24gdGhpcyBwb3J0LiBQcm90ZWN0ZWQgYnkKKyAqICZkcm1f
ZGV2aWNlLm1vZGVfY29uZmlnLmNvbm5lY3Rpb25fbXV0ZXguCisgKiBAbnVtX3NkcF9zdHJlYW1z
OiBOdW1iZXIgb2Ygc2ltdWx0YW5lb3VzIHN0cmVhbXMuIFByb3RlY3RlZCBieQorICogJmRybV9k
ZXZpY2UubW9kZV9jb25maWcuY29ubmVjdGlvbl9tdXRleC4KKyAqIEBudW1fc2RwX3N0cmVhbV9z
aW5rczogTnVtYmVyIG9mIHN0cmVhbSBzaW5rcy4gUHJvdGVjdGVkIGJ5CisgKiAmZHJtX2Rldmlj
ZS5tb2RlX2NvbmZpZy5jb25uZWN0aW9uX211dGV4LgorICogQGF2YWlsYWJsZV9wYm46IEF2YWls
YWJsZSBiYW5kd2lkdGggZm9yIHRoaXMgcG9ydC4gUHJvdGVjdGVkIGJ5CisgKiAmZHJtX2Rldmlj
ZS5tb2RlX2NvbmZpZy5jb25uZWN0aW9uX211dGV4LgogICogQG5leHQ6IGxpbmsgdG8gbmV4dCBw
b3J0IG9uIHRoaXMgYnJhbmNoIGRldmljZQogICogQG1zdGI6IGJyYW5jaCBkZXZpY2Ugb24gdGhp
cyBwb3J0LCBwcm90ZWN0ZWQgYnkKICAqICZkcm1fZHBfbXN0X3RvcG9sb2d5X21nci5sb2NrCiAg
KiBAYXV4OiBpMmMgYXV4IHRyYW5zcG9ydCB0byB0YWxrIHRvIGRldmljZSBjb25uZWN0ZWQgdG8g
dGhpcyBwb3J0LCBwcm90ZWN0ZWQKLSAqIGJ5ICZkcm1fZHBfbXN0X3RvcG9sb2d5X21nci5sb2Nr
CisgKiBieSAmZHJtX2RldmljZS5tb2RlX2NvbmZpZy5jb25uZWN0aW9uX211dGV4LgogICogQHBh
cmVudDogYnJhbmNoIGRldmljZSBwYXJlbnQgb2YgdGhpcyBwb3J0CiAgKiBAdmNwaTogVmlydHVh
bCBDaGFubmVsIFBheWxvYWQgaW5mbyBmb3IgdGhpcyBwb3J0LgotICogQGNvbm5lY3RvcjogRFJN
IGNvbm5lY3RvciB0aGlzIHBvcnQgaXMgY29ubmVjdGVkIHRvLgorICogQGNvbm5lY3RvcjogRFJN
IGNvbm5lY3RvciB0aGlzIHBvcnQgaXMgY29ubmVjdGVkIHRvLiBQcm90ZWN0ZWQgYnkgQGxvY2su
CisgKiBXaGVuIHRoZXJlIGlzIGFscmVhZHkgYSBjb25uZWN0b3IgcmVnaXN0ZXJlZCBmb3IgdGhp
cyBwb3J0LCB0aGlzIGlzIGFsc28KKyAqIHByb3RlY3RlZCBieSAmZHJtX2RldmljZS5tb2RlX2Nv
bmZpZy5jb25uZWN0aW9uX211dGV4LgogICogQG1ncjogdG9wb2xvZ3kgbWFuYWdlciB0aGlzIHBv
cnQgbGl2ZXMgdW5kZXIuCiAgKgogICogVGhpcyBzdHJ1Y3R1cmUgcmVwcmVzZW50cyBhbiBNU1Qg
cG9ydCBlbmRwb2ludCBvbiBhIGRldmljZSBzb21ld2hlcmUKQEAgLTEwMCw2ICsxMTEsMTIgQEAg
c3RydWN0IGRybV9kcF9tc3RfcG9ydCB7CiAJc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3Rv
cjsKIAlzdHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3IgKm1ncjsKIAorCS8qKgorCSAqIEBs
b2NrOiBQcm90ZWN0cyBAY29ubmVjdG9yLiBJZiBuZWVkZWQsIHRoaXMgbG9jayBzaG91bGQgYmUg
Z3JhYmJlZAorCSAqIGJlZm9yZSAmZHJtX2RldmljZS5tb2RlX2NvbmZpZy5jb25uZWN0aW9uX211
dGV4LgorCSAqLworCXN0cnVjdCBtdXRleCBsb2NrOworCiAJLyoqCiAJICogQGNhY2hlZF9lZGlk
OiBmb3IgRFAgbG9naWNhbCBwb3J0cyAtIG1ha2UgdGlsaW5nIHdvcmsgYnkgZW5zdXJpbmcKIAkg
KiB0aGF0IHRoZSBFRElEIGZvciBhbGwgY29ubmVjdG9ycyBpcyByZWFkIGltbWVkaWF0ZWx5Lgot
LSAKMi4yMS4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
XwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcK
aHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
