Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 795E819ECB
	for <lists+dri-devel@lfdr.de>; Fri, 10 May 2019 16:13:26 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 4DA3589D66;
	Fri, 10 May 2019 14:13:22 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x443.google.com (mail-wr1-x443.google.com
 [IPv6:2a00:1450:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E5BDF89D63
 for <dri-devel@lists.freedesktop.org>; Fri, 10 May 2019 14:13:20 +0000 (UTC)
Received: by mail-wr1-x443.google.com with SMTP id d12so8089204wrm.8
 for <dri-devel@lists.freedesktop.org>; Fri, 10 May 2019 07:13:20 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references;
 bh=XAS52RM/uaatpNXhGFLYByxCveVbAecNMgtIqzqDIJA=;
 b=N7P0UbOzyJA5n0FTv8BrBWiO4Ar2695bGiAxmTe21FN2HUOGs5uCvH8Ol3euZ931xR
 h+ZXaerIV90bpTaywj8fYOxr44JwViO86bAaQpaqxqIa3pGhuJ6zPDaGDnJJEW7a5mCl
 7/y4uV+V/SJiWJ0fd1+cCcg6O4EMQK9wPlzIM75KNwU3lkrzHUcQP/VVxOFRjzXPptdG
 k4m29B8NlQV5Ls7JCyadmUmjgZpMscNYX4gm5SMieJXVkFb9LGSIac2IOv43wCbIQjMC
 ESTHAnM9kNzr208QPqgS1manpqV9QcGSzEAx0f9k+mBJv9omv+IghDiiuvOMUTs7SFt8
 Llqg==
X-Gm-Message-State: APjAAAVY5dTU5ca0q1p5trl4HB7fmMae7nh/sADk9IiC8UW26mQsAh0o
 8GubjaeRTgdBjyr4Fkbx8yp/ZdDB
X-Google-Smtp-Source: APXvYqzGYVRqVeYwrwvARbjWsJZe02rOSbE6JEb/ONE4s9c3alml1c0g2HkND+DLtlqOBwIuX7Y8mA==
X-Received: by 2002:adf:f208:: with SMTP id p8mr1598235wro.160.1557497599523; 
 Fri, 10 May 2019 07:13:19 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:d0ce:46fc:479d:f2c1])
 by smtp.gmail.com with ESMTPSA id a5sm7218050wrt.10.2019.05.10.07.13.18
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
 Fri, 10 May 2019 07:13:18 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: Marek.Olsak@amd.com, David1.Zhou@amd.com, Prike.Liang@amd.com,
 dri-devel@lists.freedesktop.org
Subject: [PATCH 2/4] drm/ttm: fix busy memory to fail other user v7
Date: Fri, 10 May 2019 16:13:14 +0200
Message-Id: <20190510141316.1746-2-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190510141316.1746-1-christian.koenig@amd.com>
References: <20190510141316.1746-1-christian.koenig@amd.com>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references;
 bh=XAS52RM/uaatpNXhGFLYByxCveVbAecNMgtIqzqDIJA=;
 b=c4q04nIDoCioKhE3d9StfEDHkcmbYFgxcrMy5ebEMDMl9ykSU+21GQoYHoV3CMdK5k
 z6m0SUTFskgG8Z0CzoFr/LI7d294KdpMlkmcG2oc+zSSPxOEObOxskyn5XoxWagyaVEr
 tXPWT8YqcN2dZi9lMM+HMU3I6WaxLQs7D2ubz8Mxqk4flKGK9MTaImjSws7XZ68iU/S/
 xeWP9OkiAFNNgNtlB+nDsmDQQ6DC8Gn5RfteCBemxWlDUsXankCNLSN7M8rseEmLjh4T
 u+ZL/sJGCOCLr9JuwI+J2E/Ot6UCzO5z/3N1A2f8E/wjo+IBh0UOjezLA4U7sKZVVW0Z
 LQtQ==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogQ2h1bm1pbmcgWmhvdSA8ZGF2aWQxLnpob3VAYW1kLmNvbT4KCmhlYXZ5IGdwdSBqb2Ig
Y291bGQgb2NjdXB5IG1lbW9yeSBsb25nIHRpbWUsIHdoaWNoIGxlYWQgb3RoZXIgdXNlciBmYWls
IHRvIGdldCBtZW1vcnkuCgpiYXNpY2FsbHkgcGljayB1cCBDaHJpc3RpYW4gaWRlYToKCjEuIFJl
c2VydmUgdGhlIEJPIGluIERDIHVzaW5nIGEgd3dfbXV0ZXggdGlja2V0ICh0cml2aWFsKS4KMi4g
SWYgd2UgdGhlbiBydW4gaW50byB0aGlzIEVCVVNZIGNvbmRpdGlvbiBpbiBUVE0gY2hlY2sgaWYg
dGhlIEJPIHdlIG5lZWQgbWVtb3J5IGZvciAob3IgcmF0aGVyIHRoZSB3d19tdXRleCBvZiBpdHMg
cmVzZXJ2YXRpb24gb2JqZWN0KSBoYXMgYSB0aWNrZXQgYXNzaWduZWQuCjMuIElmIHdlIGhhdmUg
YSB0aWNrZXQgd2UgZ3JhYiBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgQk8gb24gdGhlIExSVSwg
ZHJvcCB0aGUgTFJVIGxvY2sgYW5kIHRyeSB0byBncmFiIHRoZSByZXNlcnZhdGlvbiBsb2NrIHdp
dGggdGhlIHRpY2tldC4KNC4gSWYgZ2V0dGluZyB0aGUgcmVzZXJ2YXRpb24gbG9jayB3aXRoIHRo
ZSB0aWNrZXQgc3VjY2VlZGVkIHdlIGNoZWNrIGlmIHRoZSBCTyBpcyBzdGlsbCB0aGUgZmlyc3Qg
b25lIG9uIHRoZSBMUlUgaW4gcXVlc3Rpb24gKHRoZSBCTyBjb3VsZCBoYXZlIG1vdmVkKS4KNS4g
SWYgdGhlIEJPIGlzIHN0aWxsIHRoZSBmaXJzdCBvbmUgb24gdGhlIExSVSBpbiBxdWVzdGlvbiB3
ZSB0cnkgdG8gZXZpY3QgaXQgYXMgd2Ugd291bGQgZXZpY3QgYW55IG90aGVyIEJPLgo2LiBJZiBh
bnkgb2YgdGhlICJJZidzIiBhYm92ZSBmYWlsIHdlIGp1c3QgYmFjayBvZmYgYW5kIHJldHVybiAt
RUJVU1kuCgp2MjogZml4IHNvbWUgbWlub3IgY2hlY2sKdjM6IGFkZHJlc3MgQ2hyaXN0aWFuIHYy
IGNvbW1lbnRzLgp2NDogZml4IHNvbWUgbWlzc2luZwp2NTogaGFuZGxlIGZpcnN0X2JvIHVubG9j
ayBhbmQgYm9fZ2V0L3B1dAp2NjogYWJzdHJhY3QgdW5pZmllZCBpdGVyYXRlIGZ1bmN0aW9uLCBh
bmQgaGFuZGxlIGFsbCBwb3NzaWJsZSB1c2VjYXNlIG5vdCBvbmx5IHBpbm5lZCBiby4Kdjc6IHBh
c3MgcmVxdWVzdCBiby0+cmVzdiB0byB0dG1fYm9fZXZpY3RfZmlyc3QKCkNoYW5nZS1JZDogSTIx
NDIzZmI5MjJmODg1NDY1ZjEzODMzYzQxZGYxZTEzNDM2NGE4ZTcKU2lnbmVkLW9mZi1ieTogQ2h1
bm1pbmcgWmhvdSA8ZGF2aWQxLnpob3VAYW1kLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vdHRt
L3R0bV9iby5jIHwgMTExICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tCiAxIGZp
bGUgY2hhbmdlZCwgOTQgaW5zZXJ0aW9ucygrKSwgMTcgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8uYyBiL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRt
X2JvLmMKaW5kZXggMjg0NWZjZWIyZmJkLi5lMjE3YTQ1ZDI4NDEgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS90dG0vdHRtX2JvLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8u
YwpAQCAtNzY2LDExICs3NjYsMTMgQEAgRVhQT1JUX1NZTUJPTCh0dG1fYm9fZXZpY3Rpb25fdmFs
dWFibGUpOwogICogYi4gT3RoZXJ3aXNlLCB0cnlsb2NrIGl0LgogICovCiBzdGF0aWMgYm9vbCB0
dG1fYm9fZXZpY3Rfc3dhcG91dF9hbGxvd2FibGUoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpi
bywKLQkJCXN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4LCBib29sICpsb2NrZWQpCisJCQlz
dHJ1Y3QgdHRtX29wZXJhdGlvbl9jdHggKmN0eCwgYm9vbCAqbG9ja2VkLCBib29sICpidXN5KQog
ewogCWJvb2wgcmV0ID0gZmFsc2U7CiAKIAkqbG9ja2VkID0gZmFsc2U7CisJaWYgKGJ1c3kpCisJ
CSpidXN5ID0gZmFsc2U7CiAJaWYgKGJvLT5yZXN2ID09IGN0eC0+cmVzdikgewogCQlyZXNlcnZh
dGlvbl9vYmplY3RfYXNzZXJ0X2hlbGQoYm8tPnJlc3YpOwogCQlpZiAoY3R4LT5mbGFncyAmIFRU
TV9PUFRfRkxBR19BTExPV19SRVNfRVZJQ1QKQEAgLTc3OSwzNSArNzgxLDQ2IEBAIHN0YXRpYyBi
b29sIHR0bV9ib19ldmljdF9zd2Fwb3V0X2FsbG93YWJsZShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmpl
Y3QgKmJvLAogCX0gZWxzZSB7CiAJCSpsb2NrZWQgPSByZXNlcnZhdGlvbl9vYmplY3RfdHJ5bG9j
ayhiby0+cmVzdik7CiAJCXJldCA9ICpsb2NrZWQ7CisJCWlmICghcmV0ICYmIGJ1c3kpCisJCQkq
YnVzeSA9IHRydWU7CiAJfQogCiAJcmV0dXJuIHJldDsKIH0KIAotc3RhdGljIGludCB0dG1fbWVt
X2V2aWN0X2ZpcnN0KHN0cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LAotCQkJICAgICAgIHVpbnQz
Ml90IG1lbV90eXBlLAotCQkJICAgICAgIGNvbnN0IHN0cnVjdCB0dG1fcGxhY2UgKnBsYWNlLAot
CQkJICAgICAgIHN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4KQorc3RhdGljIHN0cnVjdCB0
dG1fYnVmZmVyX29iamVjdCoKK3R0bV9tZW1fZmluZF9ldml0YWJsZV9ibyhzdHJ1Y3QgdHRtX2Jv
X2RldmljZSAqYmRldiwKKwkJCSBzdHJ1Y3QgdHRtX21lbV90eXBlX21hbmFnZXIgKm1hbiwKKwkJ
CSBjb25zdCBzdHJ1Y3QgdHRtX3BsYWNlICpwbGFjZSwKKwkJCSBzdHJ1Y3QgdHRtX29wZXJhdGlv
bl9jdHggKmN0eCwKKwkJCSBzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKipmaXJzdF9ibywKKwkJ
CSBib29sICpsb2NrZWQpCiB7Ci0Jc3RydWN0IHR0bV9ib19nbG9iYWwgKmdsb2IgPSBiZGV2LT5n
bG9iOwotCXN0cnVjdCB0dG1fbWVtX3R5cGVfbWFuYWdlciAqbWFuID0gJmJkZXYtPm1hblttZW1f
dHlwZV07CiAJc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibyA9IE5VTEw7Ci0JYm9vbCBsb2Nr
ZWQgPSBmYWxzZTsKLQl1bnNpZ25lZCBpOwotCWludCByZXQ7CisJaW50IGk7CiAKLQlzcGluX2xv
Y2soJmdsb2ItPmxydV9sb2NrKTsKKwlpZiAoZmlyc3RfYm8pCisJCSpmaXJzdF9ibyA9IE5VTEw7
CiAJZm9yIChpID0gMDsgaSA8IFRUTV9NQVhfQk9fUFJJT1JJVFk7ICsraSkgewogCQlsaXN0X2Zv
cl9lYWNoX2VudHJ5KGJvLCAmbWFuLT5scnVbaV0sIGxydSkgewotCQkJaWYgKCF0dG1fYm9fZXZp
Y3Rfc3dhcG91dF9hbGxvd2FibGUoYm8sIGN0eCwgJmxvY2tlZCkpCisJCQlib29sIGJ1c3kgPSBm
YWxzZTsKKworCQkJaWYgKCF0dG1fYm9fZXZpY3Rfc3dhcG91dF9hbGxvd2FibGUoYm8sIGN0eCwg
bG9ja2VkLAorCQkJCQkJCSAgICAmYnVzeSkpIHsKKwkJCQlpZiAoZmlyc3RfYm8gJiYgISgqZmly
c3RfYm8pICYmIGJ1c3kpIHsKKwkJCQkJdHRtX2JvX2dldChibyk7CisJCQkJCSpmaXJzdF9ibyA9
IGJvOworCQkJCX0KIAkJCQljb250aW51ZTsKKwkJCX0KIAogCQkJaWYgKHBsYWNlICYmICFiZGV2
LT5kcml2ZXItPmV2aWN0aW9uX3ZhbHVhYmxlKGJvLAogCQkJCQkJCQkgICAgICBwbGFjZSkpIHsK
LQkJCQlpZiAobG9ja2VkKQorCQkJCWlmICgqbG9ja2VkKQogCQkJCQlyZXNlcnZhdGlvbl9vYmpl
Y3RfdW5sb2NrKGJvLT5yZXN2KTsKIAkJCQljb250aW51ZTsKIAkJCX0KKwogCQkJYnJlYWs7CiAJ
CX0KIApAQCAtODE4LDkgKzgzMSw2NyBAQCBzdGF0aWMgaW50IHR0bV9tZW1fZXZpY3RfZmlyc3Qo
c3RydWN0IHR0bV9ib19kZXZpY2UgKmJkZXYsCiAJCWJvID0gTlVMTDsKIAl9CiAKKwlyZXR1cm4g
Ym87Cit9CisKK3N0YXRpYyBpbnQgdHRtX21lbV9ldmljdF9maXJzdChzdHJ1Y3QgdHRtX2JvX2Rl
dmljZSAqYmRldiwKKwkJCSAgICAgICB1aW50MzJfdCBtZW1fdHlwZSwKKwkJCSAgICAgICBjb25z
dCBzdHJ1Y3QgdHRtX3BsYWNlICpwbGFjZSwKKwkJCSAgICAgICBzdHJ1Y3QgdHRtX29wZXJhdGlv
bl9jdHggKmN0eCwKKwkJCSAgICAgICBzdHJ1Y3QgcmVzZXJ2YXRpb25fb2JqZWN0ICpyZXF1ZXN0
X3Jlc3YpCit7CisJc3RydWN0IHR0bV9ib19nbG9iYWwgKmdsb2IgPSBiZGV2LT5nbG9iOworCXN0
cnVjdCB0dG1fbWVtX3R5cGVfbWFuYWdlciAqbWFuID0gJmJkZXYtPm1hblttZW1fdHlwZV07CisJ
c3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibyA9IE5VTEwsICpmaXJzdF9ibyA9IE5VTEw7CisJ
Ym9vbCBsb2NrZWQgPSBmYWxzZTsKKwlpbnQgcmV0OworCisJc3Bpbl9sb2NrKCZnbG9iLT5scnVf
bG9jayk7CisJYm8gPSB0dG1fbWVtX2ZpbmRfZXZpdGFibGVfYm8oYmRldiwgbWFuLCBwbGFjZSwg
Y3R4LCAmZmlyc3RfYm8sCisJCQkJICAgICAgJmxvY2tlZCk7CiAJaWYgKCFibykgeworCQlzdHJ1
Y3QgdHRtX29wZXJhdGlvbl9jdHggYnVzeV9jdHg7CisKIAkJc3Bpbl91bmxvY2soJmdsb2ItPmxy
dV9sb2NrKTsKLQkJcmV0dXJuIC1FQlVTWTsKKwkJLyogY2hlY2sgaWYgb3RoZXIgdXNlciBvY2N1
cHkgbWVtb3J5IHRvbyBsb25nIHRpbWUgKi8KKwkJaWYgKCFmaXJzdF9ibyB8fCAhcmVxdWVzdF9y
ZXN2IHx8ICFyZXF1ZXN0X3Jlc3YtPmxvY2suY3R4KSB7CisJCQlpZiAoZmlyc3RfYm8pCisJCQkJ
dHRtX2JvX3B1dChmaXJzdF9ibyk7CisJCQlyZXR1cm4gLUVCVVNZOworCQl9CisJCWlmIChmaXJz
dF9iby0+cmVzdiA9PSByZXF1ZXN0X3Jlc3YpIHsKKwkJCXR0bV9ib19wdXQoZmlyc3RfYm8pOwor
CQkJcmV0dXJuIC1FQlVTWTsKKwkJfQorCQlpZiAoY3R4LT5pbnRlcnJ1cHRpYmxlKQorCQkJcmV0
ID0gd3dfbXV0ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZmaXJzdF9iby0+cmVzdi0+bG9jaywKKwkJ
CQkJCQkgIHJlcXVlc3RfcmVzdi0+bG9jay5jdHgpOworCQllbHNlCisJCQlyZXQgPSB3d19tdXRl
eF9sb2NrKCZmaXJzdF9iby0+cmVzdi0+bG9jaywgcmVxdWVzdF9yZXN2LT5sb2NrLmN0eCk7CisJ
CWlmIChyZXQpIHsKKwkJCXR0bV9ib19wdXQoZmlyc3RfYm8pOworCQkJcmV0dXJuIHJldDsKKwkJ
fQorCQlzcGluX2xvY2soJmdsb2ItPmxydV9sb2NrKTsKKwkJLyogcHJldmlvdXMgYnVzeSByZXN2
IGxvY2sgaXMgaGVsZCBieSBhYm92ZSwgaWRsZSBub3csCisJCSAqIHNvIGxldCB0aGVtIGV2aWN0
YWJsZS4KKwkJICovCisJCWJ1c3lfY3R4LmludGVycnVwdGlibGUgPSBjdHgtPmludGVycnVwdGli
bGU7CisJCWJ1c3lfY3R4Lm5vX3dhaXRfZ3B1ICAgPSBjdHgtPm5vX3dhaXRfZ3B1OworCQlidXN5
X2N0eC5yZXN2CSAgICAgICA9IGZpcnN0X2JvLT5yZXN2OworCQlidXN5X2N0eC5mbGFncwkgICAg
ICAgPSBUVE1fT1BUX0ZMQUdfQUxMT1dfUkVTX0VWSUNUOworCisJCWJvID0gdHRtX21lbV9maW5k
X2V2aXRhYmxlX2JvKGJkZXYsIG1hbiwgcGxhY2UsICZidXN5X2N0eCwgTlVMTCwKKwkJCQkJICAg
ICAgJmxvY2tlZCk7CisJCWlmIChibyAmJiAoYm8tPnJlc3YgPT0gZmlyc3RfYm8tPnJlc3YpKQor
CQkJbG9ja2VkID0gdHJ1ZTsKKwkJZWxzZSBpZiAoYm8pCisJCQl3d19tdXRleF91bmxvY2soJmZp
cnN0X2JvLT5yZXN2LT5sb2NrKTsKKwkJaWYgKCFibykgeworCQkJc3Bpbl91bmxvY2soJmdsb2It
PmxydV9sb2NrKTsKKwkJCXR0bV9ib19wdXQoZmlyc3RfYm8pOworCQkJcmV0dXJuIC1FQlVTWTsK
KwkJfQogCX0KIAogCWtyZWZfZ2V0KCZiby0+bGlzdF9rcmVmKTsKQEAgLTgyOSwxMSArOTAwLDE1
IEBAIHN0YXRpYyBpbnQgdHRtX21lbV9ldmljdF9maXJzdChzdHJ1Y3QgdHRtX2JvX2RldmljZSAq
YmRldiwKIAkJcmV0ID0gdHRtX2JvX2NsZWFudXBfcmVmcyhibywgY3R4LT5pbnRlcnJ1cHRpYmxl
LAogCQkJCQkgIGN0eC0+bm9fd2FpdF9ncHUsIGxvY2tlZCk7CiAJCWtyZWZfcHV0KCZiby0+bGlz
dF9rcmVmLCB0dG1fYm9fcmVsZWFzZV9saXN0KTsKKwkJaWYgKGZpcnN0X2JvKQorCQkJdHRtX2Jv
X3B1dChmaXJzdF9ibyk7CiAJCXJldHVybiByZXQ7CiAJfQogCiAJdHRtX2JvX2RlbF9mcm9tX2xy
dShibyk7CiAJc3Bpbl91bmxvY2soJmdsb2ItPmxydV9sb2NrKTsKKwlpZiAoZmlyc3RfYm8pCisJ
CXR0bV9ib19wdXQoZmlyc3RfYm8pOwogCiAJcmV0ID0gdHRtX2JvX2V2aWN0KGJvLCBjdHgpOwog
CWlmIChsb2NrZWQpIHsKQEAgLTkwNyw3ICs5ODIsNyBAQCBzdGF0aWMgaW50IHR0bV9ib19tZW1f
Zm9yY2Vfc3BhY2Uoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKIAkJCXJldHVybiByZXQ7
CiAJCWlmIChtZW0tPm1tX25vZGUpCiAJCQlicmVhazsKLQkJcmV0ID0gdHRtX21lbV9ldmljdF9m
aXJzdChiZGV2LCBtZW1fdHlwZSwgcGxhY2UsIGN0eCk7CisJCXJldCA9IHR0bV9tZW1fZXZpY3Rf
Zmlyc3QoYmRldiwgbWVtX3R5cGUsIHBsYWNlLCBjdHgsIGJvLT5yZXN2KTsKIAkJaWYgKHVubGlr
ZWx5KHJldCAhPSAwKSkKIAkJCXJldHVybiByZXQ7CiAJfSB3aGlsZSAoMSk7CkBAIC0xNDAxLDcg
KzE0NzYsOCBAQCBzdGF0aWMgaW50IHR0bV9ib19mb3JjZV9saXN0X2NsZWFuKHN0cnVjdCB0dG1f
Ym9fZGV2aWNlICpiZGV2LAogCWZvciAoaSA9IDA7IGkgPCBUVE1fTUFYX0JPX1BSSU9SSVRZOyAr
K2kpIHsKIAkJd2hpbGUgKCFsaXN0X2VtcHR5KCZtYW4tPmxydVtpXSkpIHsKIAkJCXNwaW5fdW5s
b2NrKCZnbG9iLT5scnVfbG9jayk7Ci0JCQlyZXQgPSB0dG1fbWVtX2V2aWN0X2ZpcnN0KGJkZXYs
IG1lbV90eXBlLCBOVUxMLCAmY3R4KTsKKwkJCXJldCA9IHR0bV9tZW1fZXZpY3RfZmlyc3QoYmRl
diwgbWVtX3R5cGUsIE5VTEwsICZjdHgsCisJCQkJCQkgIE5VTEwpOwogCQkJaWYgKHJldCkKIAkJ
CQlyZXR1cm4gcmV0OwogCQkJc3Bpbl9sb2NrKCZnbG9iLT5scnVfbG9jayk7CkBAIC0xNzcyLDcg
KzE4NDgsOCBAQCBpbnQgdHRtX2JvX3N3YXBvdXQoc3RydWN0IHR0bV9ib19nbG9iYWwgKmdsb2Is
IHN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCAqY3R4KQogCXNwaW5fbG9jaygmZ2xvYi0+bHJ1X2xv
Y2spOwogCWZvciAoaSA9IDA7IGkgPCBUVE1fTUFYX0JPX1BSSU9SSVRZOyArK2kpIHsKIAkJbGlz
dF9mb3JfZWFjaF9lbnRyeShibywgJmdsb2ItPnN3YXBfbHJ1W2ldLCBzd2FwKSB7Ci0JCQlpZiAo
dHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dhYmxlKGJvLCBjdHgsICZsb2NrZWQpKSB7CisJCQlp
ZiAodHRtX2JvX2V2aWN0X3N3YXBvdXRfYWxsb3dhYmxlKGJvLCBjdHgsICZsb2NrZWQsCisJCQkJ
CQkJICAgTlVMTCkpIHsKIAkJCQlyZXQgPSAwOwogCQkJCWJyZWFrOwogCQkJfQotLSAKMi4xNy4x
CgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2
ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9s
aXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
