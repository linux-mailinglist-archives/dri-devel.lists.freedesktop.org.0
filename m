Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 3EDAE31F703
	for <lists+dri-devel@lfdr.de>; Fri, 19 Feb 2021 11:06:12 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 447876EACA;
	Fri, 19 Feb 2021 10:06:05 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5A4BB6E8B3
 for <dri-devel@lists.freedesktop.org>; Fri, 19 Feb 2021 10:05:59 +0000 (UTC)
IronPort-SDR: cfK+J2QgHNpChEEURkbY3/d+kOFj7ErtJvmKwzWRiK+bZ3Weq+4TR6dhhFFm9gWSgJJ+VhHNn0
 dSk46s9UDHeA==
X-IronPort-AV: E=McAfee;i="6000,8403,9899"; a="170932827"
X-IronPort-AV: E=Sophos;i="5.81,189,1610438400"; d="scan'208";a="170932827"
Received: from orsmga004.jf.intel.com ([10.7.209.38])
 by orsmga101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 19 Feb 2021 02:05:58 -0800
IronPort-SDR: bjdkVHXtWeKd80fZnrzav8VkhggKjFeE3yCJ1ND/sZEpNMwPloc1z2uMKoYDgHA+54uYLQQEee
 8esaIGs2X4/g==
X-IronPort-AV: E=Sophos;i="5.81,189,1610438400"; d="scan'208";a="513624313"
Received: from vkasired-desk2.fm.intel.com ([10.105.128.127])
 by orsmga004-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 19 Feb 2021 02:05:58 -0800
From: Vivek Kasireddy <vivek.kasireddy@intel.com>
To: virtualization@lists.linux-foundation.org, dri-devel@lists.freedesktop.org
Subject: [RFC v4 3/3] vhost: Add Vdmabuf backend
Date: Fri, 19 Feb 2021 01:55:23 -0800
Message-Id: <20210219095523.2621884-4-vivek.kasireddy@intel.com>
X-Mailer: git-send-email 2.26.2
In-Reply-To: <20210219095523.2621884-1-vivek.kasireddy@intel.com>
References: <20210219095523.2621884-1-vivek.kasireddy@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: dongwon.kim@intel.com, daniel.vetter@ffwll.ch,
 Vivek Kasireddy <vivek.kasireddy@intel.com>, kraxel@redhat.com,
 daniel.vetter@intel.com, linux-media@vger.kernel.org, christian.koenig@amd.com,
 stevensd@chromium.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBiYWNrZW5kIGFjdHMgYXMgdGhlIGNvdW50ZXJwYXJ0IHRvIHRoZSBWZG1hYnVmIFZpcnRp
byBmcm9udGVuZC4KV2hlbiBpdCByZWNlaXZlcyBhIG5ldyBleHBvcnQgZXZlbnQgZnJvbSB0aGUg
ZnJvbnRlbmQsIGl0IHJhaXNlcyBhbgpldmVudCB0byBhbGVydCB0aGUgUWVtdSBVSS91c2Vyc3Bh
Y2UuIFFlbXUgdGhlbiAiaW1wb3J0cyIgdGhpcyBidWZmZXIKdXNpbmcgdGhlIFVuaXF1ZSBJRC4K
CkFzIHBhcnQgb2YgdGhlIGltcG9ydCBzdGVwLCBhIG5ldyBkbWFidWYgaXMgY3JlYXRlZCBvbiB0
aGUgSG9zdCB1c2luZwp0aGUgcGFnZSBpbmZvcm1hdGlvbiBvYnRhaW5lZCBmcm9tIHRoZSBHdWVz
dC4gVGhlIGZkIGFzc29jaWF0ZWQgd2l0aAp0aGlzIGRtYWJ1ZiBpcyBtYWRlIGF2YWlsYWJsZSB0
byBRZW11IFVJL3VzZXJzcGFjZSB3aGljaCB0aGVuIGNyZWF0ZXMKYSB0ZXh0dXJlIGZyb20gaXQg
Zm9yIHRoZSBwdXJwb3NlIG9mIGRpc3BsYXlpbmcgaXQuCgpTaWduZWQtb2ZmLWJ5OiBEb25nd29u
IEtpbSA8ZG9uZ3dvbi5raW1AaW50ZWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBWaXZlayBLYXNpcmVk
ZHkgPHZpdmVrLmthc2lyZWRkeUBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy92aG9zdC9LY29uZmln
ICAgICAgfCAgICA5ICsKIGRyaXZlcnMvdmhvc3QvTWFrZWZpbGUgICAgIHwgICAgMyArCiBkcml2
ZXJzL3Zob3N0L3ZkbWFidWYuYyAgICB8IDEzNzIgKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrCiBpbmNsdWRlL3VhcGkvbGludXgvdmhvc3QuaCB8ICAgIDMgKwogNCBmaWxlcyBj
aGFuZ2VkLCAxMzg3IGluc2VydGlvbnMoKykKIGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL3Zo
b3N0L3ZkbWFidWYuYwoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmhvc3QvS2NvbmZpZyBiL2RyaXZl
cnMvdmhvc3QvS2NvbmZpZwppbmRleCA1ODdmYmFlMDYxODIuLjlhOTljYzI2MTFjYSAxMDA2NDQK
LS0tIGEvZHJpdmVycy92aG9zdC9LY29uZmlnCisrKyBiL2RyaXZlcnMvdmhvc3QvS2NvbmZpZwpA
QCAtODksNCArODksMTMgQEAgY29uZmlnIFZIT1NUX0NST1NTX0VORElBTl9MRUdBQ1kKIAogCSAg
SWYgdW5zdXJlLCBzYXkgIk4iLgogCitjb25maWcgVkhPU1RfVkRNQUJVRgorCWJvb2wgIlZob3N0
IGJhY2tlbmQgZm9yIHRoZSBWZG1hYnVmIGRyaXZlciIKKwlkZXBlbmRzIG9uIEtWTSAmJiBFVkVO
VEZECisJc2VsZWN0IFZIT1NUCisJZGVmYXVsdCBuCisJaGVscAorCSAgVGhpcyBkcml2ZXIgd29y
a3MgaW4gcGFpciB3aXRoIHRoZSBWaXJ0aW8gVmRtYWJ1ZiBmcm9udGVuZC4gSXQgY2FuCisJICBi
ZSB1c2VkIHRvIGNyZWF0ZSBhIGRtYWJ1ZiB1c2luZyB0aGUgcGFnZXMgc2hhcmVkIGJ5IHRoZSBH
dWVzdC4KKwogZW5kaWYKZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmhvc3QvTWFrZWZpbGUgYi9kcml2
ZXJzL3Zob3N0L01ha2VmaWxlCmluZGV4IGYzZTE4OTdjY2U4NS4uNWMyY2VhNGE3ZWFmIDEwMDY0
NAotLS0gYS9kcml2ZXJzL3Zob3N0L01ha2VmaWxlCisrKyBiL2RyaXZlcnMvdmhvc3QvTWFrZWZp
bGUKQEAgLTE3LDMgKzE3LDYgQEAgb2JqLSQoQ09ORklHX1ZIT1NUKQkrPSB2aG9zdC5vCiAKIG9i
ai0kKENPTkZJR19WSE9TVF9JT1RMQikgKz0gdmhvc3RfaW90bGIubwogdmhvc3RfaW90bGIteSA6
PSBpb3RsYi5vCisKK29iai0kKENPTkZJR19WSE9TVF9WRE1BQlVGKSArPSB2aG9zdF92ZG1hYnVm
Lm8KK3Zob3N0X3ZkbWFidWYteSA6PSB2ZG1hYnVmLm8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmhv
c3QvdmRtYWJ1Zi5jIGIvZHJpdmVycy92aG9zdC92ZG1hYnVmLmMKbmV3IGZpbGUgbW9kZSAxMDA2
NDQKaW5kZXggMDAwMDAwMDAwMDAwLi5mZTBlZmU4MjY4M2QKLS0tIC9kZXYvbnVsbAorKysgYi9k
cml2ZXJzL3Zob3N0L3ZkbWFidWYuYwpAQCAtMCwwICsxLDEzNzIgQEAKKy8vIFNQRFgtTGljZW5z
ZS1JZGVudGlmaWVyOiAoTUlUIE9SIEdQTC0yLjApCisKKy8qCisgKiBDb3B5cmlnaHQgwqkgMjAy
MSBJbnRlbCBDb3Jwb3JhdGlvbgorICoKKyAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQs
IGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCisgKiBjb3B5IG9mIHRo
aXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0
d2FyZSIpLAorICogdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwg
aW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgorICogdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHks
IG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsCisgKiBhbmQv
b3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8g
d2hvbSB0aGUKKyAqIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0
aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CisgKgorICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3Rp
Y2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2UgKGluY2x1ZGluZyB0aGUgbmV4dAorICogcGFy
YWdyYXBoKSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBv
cnRpb25zIG9mIHRoZQorICogU29mdHdhcmUuCisgKgorICogVEhFIFNPRlRXQVJFIElTIFBST1ZJ
REVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKKyAq
IElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0Yg
TUVSQ0hBTlRBQklMSVRZLAorICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5E
IE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMCisgKiBUSEUgQVVUSE9SUyBPUiBD
T1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhF
UgorICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBP
UiBPVEhFUldJU0UsIEFSSVNJTkcKKyAqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJ
VEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MKKyAqIElOIFRIRSBT
T0ZUV0FSRS4KKyAqCisgKiBBdXRob3JzOgorICogICAgRG9uZ3dvbiBLaW0gPGRvbmd3b24ua2lt
QGludGVsLmNvbT4KKyAqICAgIE1hdGV1c3ogUG9scm9sYSA8bWF0ZXVzei5wb2xyb2xhQGdtYWls
LmNvbT4KKyAqICAgIFZpdmVrIEthc2lyZWRkeSA8dml2ZWsua2FzaXJlZGR5QGludGVsLmNvbT4K
KyAqLworCisjaW5jbHVkZSA8bGludXgva2VybmVsLmg+CisjaW5jbHVkZSA8bGludXgvZXJybm8u
aD4KKyNpbmNsdWRlIDxsaW51eC9pbml0Lmg+CisjaW5jbHVkZSA8bGludXgvbW9kdWxlLmg+Cisj
aW5jbHVkZSA8bGludXgvbXV0ZXguaD4KKyNpbmNsdWRlIDxsaW51eC9taXNjZGV2aWNlLmg+Cisj
aW5jbHVkZSA8bGludXgvd29ya3F1ZXVlLmg+CisjaW5jbHVkZSA8bGludXgvc2xhYi5oPgorI2lu
Y2x1ZGUgPGxpbnV4L2RldmljZS5oPgorI2luY2x1ZGUgPGxpbnV4L2hhc2h0YWJsZS5oPgorI2lu
Y2x1ZGUgPGxpbnV4L3VhY2Nlc3MuaD4KKyNpbmNsdWRlIDxsaW51eC9wb2xsLmg+CisjaW5jbHVk
ZSA8bGludXgvZG1hLWJ1Zi5oPgorI2luY2x1ZGUgPGxpbnV4L3Zob3N0Lmg+CisjaW5jbHVkZSA8
bGludXgvdmZpby5oPgorI2luY2x1ZGUgPGxpbnV4L2t2bV9ob3N0Lmg+CisjaW5jbHVkZSA8bGlu
dXgvdmlydGlvX3ZkbWFidWYuaD4KKworI2luY2x1ZGUgInZob3N0LmgiCisKKyNkZWZpbmUgUkVG
U19QRVJfUEFHRSAoUEFHRV9TSVpFL3NpemVvZihsb25nKSkKKworZW51bSB7CisJVkhPU1RfVkRN
QUJVRl9GRUFUVVJFUyA9IFZIT1NUX0ZFQVRVUkVTLAorfTsKKworc3RhdGljIHN0cnVjdCB2aXJ0
aW9fdmRtYWJ1Zl9pbmZvICpkcnZfaW5mbzsKKworc3RydWN0IGt2bV9pbnN0YW5jZSB7CisJc3Ry
dWN0IGt2bSAqa3ZtOworCXN0cnVjdCBsaXN0X2hlYWQgbGluazsKK307CisKK3N0cnVjdCB2aG9z
dF92ZG1hYnVmIHsKKwlzdHJ1Y3Qgdmhvc3RfZGV2IGRldjsKKwlzdHJ1Y3Qgdmhvc3RfdmlydHF1
ZXVlIHZxc1tWRE1BQlVGX1ZRX01BWF07CisJc3RydWN0IHZob3N0X3dvcmsgc2VuZF93b3JrOwor
CXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9ldmVudF9xdWV1ZSAqZXZxOworCXU2NCB2bWlkOworCisJ
c3RydWN0IGxpc3RfaGVhZCBtc2dfbGlzdDsKKwlzdHJ1Y3QgbGlzdF9oZWFkIGxpc3Q7CisJc3Ry
dWN0IGt2bSAqa3ZtOworfTsKKworc3RhdGljIGlubGluZSB2b2lkIHZob3N0X3ZkbWFidWZfYWRk
KHN0cnVjdCB2aG9zdF92ZG1hYnVmICpuZXcpCit7CisJbGlzdF9hZGRfdGFpbCgmbmV3LT5saXN0
LCAmZHJ2X2luZm8tPmhlYWRfdmRtYWJ1Zl9saXN0KTsKK30KKworc3RhdGljIGlubGluZSBzdHJ1
Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmhvc3RfdmRtYWJ1Zl9maW5kKHU2NCB2bWlkKQoreworCXN0cnVj
dCB2aG9zdF92ZG1hYnVmICpmb3VuZDsKKworCWxpc3RfZm9yX2VhY2hfZW50cnkoZm91bmQsICZk
cnZfaW5mby0+aGVhZF92ZG1hYnVmX2xpc3QsIGxpc3QpCisJCWlmIChmb3VuZC0+dm1pZCA9PSB2
bWlkKQorCQkJcmV0dXJuIGZvdW5kOworCisJcmV0dXJuIE5VTEw7Cit9CisKK3N0YXRpYyBpbmxp
bmUgYm9vbCB2aG9zdF92ZG1hYnVmX2RlbChzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZikK
K3sKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqaXRlciwgKnRlbXA7CisKKwlsaXN0X2Zvcl9lYWNo
X2VudHJ5X3NhZmUoaXRlciwgdGVtcCwKKwkJCQkgJmRydl9pbmZvLT5oZWFkX3ZkbWFidWZfbGlz
dCwKKwkJCQkgbGlzdCkKKwkJaWYgKGl0ZXIgPT0gdmRtYWJ1ZikgeworCQkJbGlzdF9kZWwoJml0
ZXItPmxpc3QpOworCQkJcmV0dXJuIHRydWU7CisJCX0KKworCXJldHVybiBmYWxzZTsKK30KKwor
c3RhdGljIGlubGluZSB2b2lkIHZob3N0X3ZkbWFidWZfZGVsX2FsbCh2b2lkKQoreworCXN0cnVj
dCB2aG9zdF92ZG1hYnVmICppdGVyLCAqdGVtcDsKKworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2Fm
ZShpdGVyLCB0ZW1wLAorCQkJCSAmZHJ2X2luZm8tPmhlYWRfdmRtYWJ1Zl9saXN0LAorCQkJCSBs
aXN0KSB7CisJCWxpc3RfZGVsKCZpdGVyLT5saXN0KTsKKwkJa2ZyZWUoaXRlcik7CisJfQorfQor
CitzdGF0aWMgdm9pZCAqbWFwX2dwYShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdwYV90IGdwYSkK
K3sKKwlzdHJ1Y3Qga3ZtX2hvc3RfbWFwIG1hcDsKKwlpbnQgcmV0OworCisJcmV0ID0ga3ZtX3Zj
cHVfbWFwKHZjcHUsIGdwYV90b19nZm4oZ3BhKSwgJm1hcCk7CisJaWYgKHJldCA8IDApCisJCXJl
dHVybiBFUlJfUFRSKHJldCk7CisJZWxzZQorCQlyZXR1cm4gbWFwLmh2YTsKK30KKworc3RhdGlj
IHZvaWQgdW5tYXBfaHZhKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ3BhX3QgaHZhKQoreworCXN0
cnVjdCBwYWdlICpwYWdlID0gdmlydF90b19wYWdlKGh2YSk7CisJc3RydWN0IGt2bV9ob3N0X21h
cCBtYXA7CisKKwltYXAuaHZhID0gKHZvaWQgKilodmE7CisJbWFwLnBhZ2UgPSBwYWdlOworCisJ
a3ZtX3ZjcHVfdW5tYXAodmNwdSwgJm1hcCwgdHJ1ZSk7Cit9CisKKy8qIG1hcHBpbmcgZ3Vlc3Qn
cyBwYWdlcyBmb3IgdGhlIHZkbWFidWYgKi8KK3N0YXRpYyBpbnQKK3Zob3N0X3ZkbWFidWZfbWFw
X3BhZ2VzKHU2NCB2bWlkLAorCQkgICAgICAgIHN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9zaGFyZWRf
cGFnZXMgKnBhZ2VzX2luZm8pCit7CisJc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYgPSB2
aG9zdF92ZG1hYnVmX2ZpbmQodm1pZCk7CisJc3RydWN0IGt2bV92Y3B1ICp2Y3B1OworCXZvaWQg
KnBhZGRyOworCWludCBucGdzID0gUkVGU19QRVJfUEFHRTsKKwlpbnQgbGFzdF9uZW50cywgbl9s
MnJlZnM7CisJaW50IGksIGogPSAwLCBrID0gMDsKKworCWlmICghdmRtYWJ1ZiB8fCAhdmRtYWJ1
Zi0+a3ZtIHx8ICFwYWdlc19pbmZvIHx8IHBhZ2VzX2luZm8tPnBhZ2VzKQorCQlyZXR1cm4gLUVJ
TlZBTDsKKworCXZjcHUgPSBrdm1fZ2V0X3ZjcHVfYnlfaWQodmRtYWJ1Zi0+a3ZtLCAwKTsKKwlp
ZiAoIXZjcHUpCisJCXJldHVybiAtRUlOVkFMOworCisJbGFzdF9uZW50cyA9IChwYWdlc19pbmZv
LT5uZW50cyAtIDEpICUgbnBncyArIDE7CisJbl9sMnJlZnMgPSAocGFnZXNfaW5mby0+bmVudHMg
LyBucGdzKSArICgobGFzdF9uZW50cyA+IDApID8gMSA6IDApIC0KKwkJICAgKGxhc3RfbmVudHMg
PT0gbnBncyk7CisKKwlwYWdlc19pbmZvLT5wYWdlcyA9IGtjYWxsb2MocGFnZXNfaW5mby0+bmVu
dHMsIHNpemVvZihzdHJ1Y3QgcGFnZSAqKSwKKwkJCQkgICAgR0ZQX0tFUk5FTCk7CisJaWYgKCFw
YWdlc19pbmZvLT5wYWdlcykKKwkJZ290byBmYWlsX3BhZ2VfYWxsb2M7CisKKwlwYWdlc19pbmZv
LT5sMnJlZnMgPSBrY2FsbG9jKG5fbDJyZWZzLCBzaXplb2YoZ3BhX3QgKiksIEdGUF9LRVJORUwp
OworCWlmICghcGFnZXNfaW5mby0+bDJyZWZzKQorCQlnb3RvIGZhaWxfbDJyZWZzOworCisJcGFn
ZXNfaW5mby0+bDNyZWZzID0gKGdwYV90ICopbWFwX2dwYSh2Y3B1LCBwYWdlc19pbmZvLT5yZWYp
OworCWlmIChJU19FUlIocGFnZXNfaW5mby0+bDNyZWZzKSkKKwkJZ290byBmYWlsX2wzcmVmczsK
KworCWZvciAoaSA9IDA7IGkgPCBuX2wycmVmczsgaSsrKSB7CisJCXBhZ2VzX2luZm8tPmwycmVm
c1tpXSA9IChncGFfdCAqKW1hcF9ncGEodmNwdSwKKwkJCQkJCQkgcGFnZXNfaW5mby0+bDNyZWZz
W2ldKTsKKworCQlpZiAoSVNfRVJSKHBhZ2VzX2luZm8tPmwycmVmc1tpXSkpCisJCQlnb3RvIGZh
aWxfbWFwcGluZ19sMjsKKworCQkvKiBsYXN0IGxldmVsLTIgcmVmICovCisJCWlmIChpID09IG5f
bDJyZWZzIC0gMSkKKwkJCW5wZ3MgPSBsYXN0X25lbnRzOworCisJCWZvciAoaiA9IDA7IGogPCBu
cGdzOyBqKyspIHsKKwkJCXBhZGRyID0gbWFwX2dwYSh2Y3B1LCBwYWdlc19pbmZvLT5sMnJlZnNb
aV1bal0pOworCQkJaWYgKElTX0VSUihwYWRkcikpCisJCQkJZ290byBmYWlsX21hcHBpbmdfbDE7
CisKKwkJCXBhZ2VzX2luZm8tPnBhZ2VzW2tdID0gdmlydF90b19wYWdlKHBhZGRyKTsKKwkJCWsr
KzsKKwkJfQorCQl1bm1hcF9odmEodmNwdSwgcGFnZXNfaW5mby0+bDNyZWZzW2ldKTsKKwl9CisK
Kwl1bm1hcF9odmEodmNwdSwgcGFnZXNfaW5mby0+cmVmKTsKKworCXJldHVybiAwOworCitmYWls
X21hcHBpbmdfbDE6CisJZm9yIChrID0gMDsgayA8IGo7IGsrKykKKwkJdW5tYXBfaHZhKHZjcHUs
IHBhZ2VzX2luZm8tPmwycmVmc1tpXVtrXSk7CisKK2ZhaWxfbWFwcGluZ19sMjoKKwlmb3IgKGog
PSAwOyBqIDwgaTsgaisrKSB7CisJCWZvciAoayA9IDA7IGsgPCBSRUZTX1BFUl9QQUdFOyBrKysp
CisJCQl1bm1hcF9odmEodmNwdSwgcGFnZXNfaW5mby0+bDJyZWZzW2ldW2tdKTsKKwl9CisKKwl1
bm1hcF9odmEodmNwdSwgcGFnZXNfaW5mby0+bDNyZWZzW2ldKTsKKwl1bm1hcF9odmEodmNwdSwg
cGFnZXNfaW5mby0+cmVmKTsKKworZmFpbF9sM3JlZnM6CisJa2ZyZWUocGFnZXNfaW5mby0+bDJy
ZWZzKTsKKworZmFpbF9sMnJlZnM6CisJa2ZyZWUocGFnZXNfaW5mby0+cGFnZXMpOworCitmYWls
X3BhZ2VfYWxsb2M6CisJcmV0dXJuIC1FTk9NRU07Cit9CisKKy8qIHVubWFwcGluZyBtYXBwZWQg
cGFnZXMgKi8KK3N0YXRpYyBpbnQKK3Zob3N0X3ZkbWFidWZfdW5tYXBfcGFnZXModTY0IHZtaWQs
CisJCQkgIHN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9zaGFyZWRfcGFnZXMgKnBhZ2VzX2luZm8pCit7
CisJc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYgPSB2aG9zdF92ZG1hYnVmX2ZpbmQodm1p
ZCk7CisJc3RydWN0IGt2bV92Y3B1ICp2Y3B1OworCWludCBsYXN0X25lbnRzID0gKHBhZ2VzX2lu
Zm8tPm5lbnRzIC0gMSkgJSBSRUZTX1BFUl9QQUdFICsgMTsKKwlpbnQgbl9sMnJlZnMgPSAocGFn
ZXNfaW5mby0+bmVudHMgLyBSRUZTX1BFUl9QQUdFKSArCisJCSAgICAgICAoKGxhc3RfbmVudHMg
PiAwKSA/IDEgOiAwKSAtCisJCSAgICAgICAobGFzdF9uZW50cyA9PSBSRUZTX1BFUl9QQUdFKTsK
KwlpbnQgaSwgajsKKworCWlmICghdmRtYWJ1ZiB8fCAhdmRtYWJ1Zi0+a3ZtIHx8ICFwYWdlc19p
bmZvIHx8IHBhZ2VzX2luZm8tPnBhZ2VzKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCXZjcHUgPSBr
dm1fZ2V0X3ZjcHVfYnlfaWQodmRtYWJ1Zi0+a3ZtLCAwKTsKKwlpZiAoIXZjcHUpCisJCXJldHVy
biAtRUlOVkFMOworCisJZm9yIChpID0gMDsgaSA8IG5fbDJyZWZzIC0gMTsgaSsrKSB7CisJCWZv
ciAoaiA9IDA7IGogPCBSRUZTX1BFUl9QQUdFOyBqKyspCisJCQl1bm1hcF9odmEodmNwdSwgcGFn
ZXNfaW5mby0+bDJyZWZzW2ldW2pdKTsKKwl9CisKKwlmb3IgKGogPSAwOyBqIDwgbGFzdF9uZW50
czsgaisrKQorCQl1bm1hcF9odmEodmNwdSwgcGFnZXNfaW5mby0+bDJyZWZzW2ldW2pdKTsKKwor
CWtmcmVlKHBhZ2VzX2luZm8tPmwycmVmcyk7CisJa2ZyZWUocGFnZXNfaW5mby0+cGFnZXMpOwor
CXBhZ2VzX2luZm8tPnBhZ2VzID0gTlVMTDsKKworCXJldHVybiAwOworfQorCisvKiBjcmVhdGUg
c2dfdGFibGUgd2l0aCBnaXZlbiBwYWdlcyBhbmQgb3RoZXIgcGFyYW1ldGVycyAqLworc3RhdGlj
IHN0cnVjdCBzZ190YWJsZSAqbmV3X3NndChzdHJ1Y3QgcGFnZSAqKnBncywKKwkJCQlpbnQgZmly
c3Rfb2ZzdCwgaW50IGxhc3RfbGVuLAorCQkJCWludCBuZW50cykKK3sKKwlzdHJ1Y3Qgc2dfdGFi
bGUgKnNndDsKKwlzdHJ1Y3Qgc2NhdHRlcmxpc3QgKnNnbDsKKwlpbnQgaSwgcmV0OworCisJc2d0
ID0ga21hbGxvYyhzaXplb2Yoc3RydWN0IHNnX3RhYmxlKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFz
Z3QpCisJCXJldHVybiBOVUxMOworCisJcmV0ID0gc2dfYWxsb2NfdGFibGUoc2d0LCBuZW50cywg
R0ZQX0tFUk5FTCk7CisJaWYgKHJldCkgeworCQlrZnJlZShzZ3QpOworCQlyZXR1cm4gTlVMTDsK
Kwl9CisKKwlzZ2wgPSBzZ3QtPnNnbDsKKwlzZ19zZXRfcGFnZShzZ2wsIHBnc1swXSwgUEFHRV9T
SVpFLWZpcnN0X29mc3QsIGZpcnN0X29mc3QpOworCisJZm9yIChpID0gMTsgaSA8IG5lbnRzLTE7
IGkrKykgeworCQlzZ2wgPSBzZ19uZXh0KHNnbCk7CisJCXNnX3NldF9wYWdlKHNnbCwgcGdzW2ld
LCBQQUdFX1NJWkUsIDApOworCX0KKworCS8qIG1vcmUgdGhhbiAxIHBhZ2UgKi8KKwlpZiAobmVu
dHMgPiAxKSB7CisJCXNnbCA9IHNnX25leHQoc2dsKTsKKwkJc2dfc2V0X3BhZ2Uoc2dsLCBwZ3Nb
aV0sIGxhc3RfbGVuLCAwKTsKKwl9CisKKwlyZXR1cm4gc2d0OworfQorCitzdGF0aWMgc3RydWN0
IHNnX3RhYmxlCisqdmhvc3RfdmRtYWJ1Zl9kbWFidWZfbWFwKHN0cnVjdCBkbWFfYnVmX2F0dGFj
aG1lbnQgKmF0dGFjaG1lbnQsCisJCQkgIGVudW0gZG1hX2RhdGFfZGlyZWN0aW9uIGRpcikKK3sK
KwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfYnVmICppbXA7CisKKwlpZiAoIWF0dGFjaG1lbnQtPmRt
YWJ1ZiB8fCAhYXR0YWNobWVudC0+ZG1hYnVmLT5wcml2KQorCQlyZXR1cm4gTlVMTDsKKworCWlt
cCA9IChzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfYnVmICopYXR0YWNobWVudC0+ZG1hYnVmLT5wcml2
OworCisJLyogaWYgYnVmZmVyIGhhcyBuZXZlciBiZWVuIG1hcHBlZCAqLworCWlmICghaW1wLT5z
Z3QpIHsKKwkJaW1wLT5zZ3QgPSBuZXdfc2d0KGltcC0+cGFnZXNfaW5mby0+cGFnZXMsCisJCQkJ
ICAgaW1wLT5wYWdlc19pbmZvLT5maXJzdF9vZnN0LAorCQkJCSAgIGltcC0+cGFnZXNfaW5mby0+
bGFzdF9sZW4sCisJCQkJICAgaW1wLT5wYWdlc19pbmZvLT5uZW50cyk7CisKKwkJaWYgKCFpbXAt
PnNndCkKKwkJCXJldHVybiBOVUxMOworCX0KKworCWlmICghZG1hX21hcF9zZyhhdHRhY2htZW50
LT5kZXYsIGltcC0+c2d0LT5zZ2wsCisJCQlpbXAtPnNndC0+bmVudHMsIGRpcikpIHsKKwkJc2df
ZnJlZV90YWJsZShpbXAtPnNndCk7CisJCWtmcmVlKGltcC0+c2d0KTsKKwkJcmV0dXJuIE5VTEw7
CisJfQorCisJcmV0dXJuIGltcC0+c2d0OworfQorCitzdGF0aWMgdm9pZAordmhvc3RfdmRtYWJ1
Zl9kbWFidWZfdW5tYXAoc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNobWVudCwKKwkg
ICAJICAgICAgICAgICBzdHJ1Y3Qgc2dfdGFibGUgKnNnLAorCQkJICAgZW51bSBkbWFfZGF0YV9k
aXJlY3Rpb24gZGlyKQoreworCWRtYV91bm1hcF9zZyhhdHRhY2htZW50LT5kZXYsIHNnLT5zZ2ws
IHNnLT5uZW50cywgZGlyKTsKKworCXNnX2ZyZWVfdGFibGUoc2cpOworCWtmcmVlKHNnKTsKK30K
Kworc3RhdGljIGludCB2aG9zdF92ZG1hYnVmX2RtYWJ1Zl9tbWFwKHN0cnVjdCBkbWFfYnVmICpk
bWFidWYsCisJCQkJICAgICBzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSkKK3sKKwlzdHJ1Y3Qg
dmlydGlvX3ZkbWFidWZfYnVmICppbXA7CisJdTY0IHVhZGRyOworCWludCBpLCBlcnI7CisKKwlp
ZiAoIWRtYWJ1Zi0+cHJpdikKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpbXAgPSAoc3RydWN0IHZp
cnRpb192ZG1hYnVmX2J1ZiAqKWRtYWJ1Zi0+cHJpdjsKKworCWlmICghaW1wLT5wYWdlc19pbmZv
KQorCQlyZXR1cm4gLUVJTlZBTDsKKworCXZtYS0+dm1fZmxhZ3MgfD0gVk1fRE9OVEVYUEFORCB8
IFZNX0RPTlREVU1QOworCisJdWFkZHIgPSB2bWEtPnZtX3N0YXJ0OworCWZvciAoaSA9IDA7IGkg
PCBpbXAtPnBhZ2VzX2luZm8tPm5lbnRzOyBpKyspIHsKKwkJZXJyID0gdm1faW5zZXJ0X3BhZ2Uo
dm1hLCB1YWRkciwKKwkJCQkgICAgIGltcC0+cGFnZXNfaW5mby0+cGFnZXNbaV0pOworCQlpZiAo
ZXJyKQorCQkJcmV0dXJuIGVycjsKKworCQl1YWRkciArPSBQQUdFX1NJWkU7CisJfQorCisJcmV0
dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgdmhvc3RfdmRtYWJ1Zl9kbWFidWZfdm1hcChzdHJ1Y3Qg
ZG1hX2J1ZiAqZG1hYnVmLAorCQkJCSAgICAgc3RydWN0IGRtYV9idWZfbWFwICptYXApCit7CisJ
c3RydWN0IHZpcnRpb192ZG1hYnVmX2J1ZiAqaW1wOworCXZvaWQgKmFkZHI7CisKKwlpZiAoIWRt
YWJ1Zi0+cHJpdikKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpbXAgPSAoc3RydWN0IHZpcnRpb192
ZG1hYnVmX2J1ZiAqKWRtYWJ1Zi0+cHJpdjsKKworCWlmICghaW1wLT5wYWdlc19pbmZvKQorCQly
ZXR1cm4gLUVJTlZBTDsKKworCWFkZHIgPSB2bWFwKGltcC0+cGFnZXNfaW5mby0+cGFnZXMsIGlt
cC0+cGFnZXNfaW5mby0+bmVudHMsCisgICAgICAgICAgICAgICAgICAgIDAsIFBBR0VfS0VSTkVM
KTsKKwlpZiAoSVNfRVJSKGFkZHIpKQorCQlyZXR1cm4gUFRSX0VSUihhZGRyKTsKKworCXJldHVy
biAwOworfQorCitzdGF0aWMgdm9pZCB2aG9zdF92ZG1hYnVmX2RtYWJ1Zl9yZWxlYXNlKHN0cnVj
dCBkbWFfYnVmICpkbWFfYnVmKQoreworCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9idWYgKmltcDsK
KworCWlmICghZG1hX2J1Zi0+cHJpdikKKwkJcmV0dXJuOworCisJaW1wID0gKHN0cnVjdCB2aXJ0
aW9fdmRtYWJ1Zl9idWYgKilkbWFfYnVmLT5wcml2OworCWltcC0+ZG1hX2J1ZiA9IE5VTEw7CisJ
aW1wLT52YWxpZCA9IGZhbHNlOworCisJdmhvc3RfdmRtYWJ1Zl91bm1hcF9wYWdlcyhpbXAtPnZt
aWQsIGltcC0+cGFnZXNfaW5mbyk7CisJdmlydGlvX3ZkbWFidWZfZGVsX2J1ZihkcnZfaW5mbywg
JmltcC0+YnVmX2lkKTsKKworCWtmcmVlKGltcC0+cHJpdik7CisJa2ZyZWUoaW1wLT5wYWdlc19p
bmZvKTsKKwlrZnJlZShpbXApOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0IGRtYV9idWZfb3Bz
IHZob3N0X3ZkbWFidWZfZG1hYnVmX29wcyA9IHsKKwkubWFwX2RtYV9idWYgPSB2aG9zdF92ZG1h
YnVmX2RtYWJ1Zl9tYXAsCisJLnVubWFwX2RtYV9idWYgPSB2aG9zdF92ZG1hYnVmX2RtYWJ1Zl91
bm1hcCwKKwkucmVsZWFzZSA9IHZob3N0X3ZkbWFidWZfZG1hYnVmX3JlbGVhc2UsCisJLm1tYXAg
PSB2aG9zdF92ZG1hYnVmX2RtYWJ1Zl9tbWFwLAorCS52bWFwID0gdmhvc3RfdmRtYWJ1Zl9kbWFi
dWZfdm1hcCwKK307CisKKy8qIGV4cG9ydGluZyBkbWFidWYgYXMgZmQgKi8KK3N0YXRpYyBpbnQg
dmhvc3RfdmRtYWJ1Zl9leHBfZmQoc3RydWN0IHZpcnRpb192ZG1hYnVmX2J1ZiAqaW1wLCBpbnQg
ZmxhZ3MpCit7CisJREVGSU5FX0RNQV9CVUZfRVhQT1JUX0lORk8oZXhwX2luZm8pOworCisJZXhw
X2luZm8ub3BzID0gJnZob3N0X3ZkbWFidWZfZG1hYnVmX29wczsKKworCS8qIG11bHRpcGxlIG9m
IFBBR0VfU0laRSwgbm90IGNvbnNpZGVyaW5nIG9mZnNldCAqLworCWV4cF9pbmZvLnNpemUgPSBp
bXAtPnBhZ2VzX2luZm8tPm5lbnRzICogUEFHRV9TSVpFOworCWV4cF9pbmZvLmZsYWdzID0gT19D
TE9FWEVDOworCWV4cF9pbmZvLnByaXYgPSBpbXA7CisKKwlpZiAoIWltcC0+ZG1hX2J1Zikgewor
CQlpbXAtPmRtYV9idWYgPSBkbWFfYnVmX2V4cG9ydCgmZXhwX2luZm8pOworCQlpZiAoSVNfRVJS
X09SX05VTEwoaW1wLT5kbWFfYnVmKSkgeworCQkJaW1wLT5kbWFfYnVmID0gTlVMTDsKKwkJCXJl
dHVybiAtRUlOVkFMOworCQl9CisJfQorCisJcmV0dXJuIGRtYV9idWZfZmQoaW1wLT5kbWFfYnVm
LCBmbGFncyk7Cit9CisKK3N0YXRpYyBpbnQgdmhvc3RfdmRtYWJ1Zl9hZGRfZXZlbnQoc3RydWN0
IHZob3N0X3ZkbWFidWYgKnZkbWFidWYsCisJCQkJICAgc3RydWN0IHZpcnRpb192ZG1hYnVmX2J1
ZiAqYnVmX2luZm8pCit7CisJc3RydWN0IHZpcnRpb192ZG1hYnVmX2V2ZW50ICplX29sZGVzdCwg
KmVfbmV3OworCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9ldmVudF9xdWV1ZSAqZXZxID0gdmRtYWJ1
Zi0+ZXZxOworCXVuc2lnbmVkIGxvbmcgaXJxZmxhZ3M7CisKKwllX25ldyA9IGt6YWxsb2Moc2l6
ZW9mKCplX25ldyksIEdGUF9LRVJORUwpOworCWlmICghZV9uZXcpCisJCXJldHVybiAtRU5PTUVN
OworCisJZV9uZXctPmVfZGF0YS5oZHIuYnVmX2lkID0gYnVmX2luZm8tPmJ1Zl9pZDsKKwllX25l
dy0+ZV9kYXRhLmRhdGEgPSAodm9pZCAqKWJ1Zl9pbmZvLT5wcml2OworCWVfbmV3LT5lX2RhdGEu
aGRyLnNpemUgPSBidWZfaW5mby0+c3pfcHJpdjsKKworCXNwaW5fbG9ja19pcnFzYXZlKCZldnEt
PmVfbG9jaywgaXJxZmxhZ3MpOworCisJLyogY2hlY2sgY3VycmVudCBudW1iZXIgb2YgZXZlbnQg
dGhlbiBpZiBpdCBoaXRzIHRoZSBtYXggbnVtICgzMikKKwkgKiB0aGVuIHJlbW92ZSB0aGUgb2xk
ZXN0IGV2ZW50IGluIHRoZSBsaXN0CisJICovCisJaWYgKGV2cS0+cGVuZGluZyA+IDMxKSB7CisJ
CWVfb2xkZXN0ID0gbGlzdF9maXJzdF9lbnRyeSgmZXZxLT5lX2xpc3QsCisJCQkJCSAgICBzdHJ1
Y3QgdmlydGlvX3ZkbWFidWZfZXZlbnQsIGxpbmspOworCQlsaXN0X2RlbCgmZV9vbGRlc3QtPmxp
bmspOworCQlldnEtPnBlbmRpbmctLTsKKwkJa2ZyZWUoZV9vbGRlc3QpOworCX0KKworCWxpc3Rf
YWRkX3RhaWwoJmVfbmV3LT5saW5rLCAmZXZxLT5lX2xpc3QpOworCisJZXZxLT5wZW5kaW5nKys7
CisKKwl3YWtlX3VwX2ludGVycnVwdGlibGUoJmV2cS0+ZV93YWl0KTsKKwlzcGluX3VubG9ja19p
cnFyZXN0b3JlKCZldnEtPmVfbG9jaywgaXJxZmxhZ3MpOworCisJcmV0dXJuIDA7Cit9CisKK3N0
YXRpYyBpbnQgc2VuZF9tc2dfdG9fZ3Vlc3QodTY0IHZtaWQsIGVudW0gdmlydGlvX3ZkbWFidWZf
Y21kIGNtZCwgaW50ICpvcCkKK3sKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfbXNnICptc2c7CisJ
c3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWY7CisKKwl2ZG1hYnVmID0gdmhvc3RfdmRtYWJ1
Zl9maW5kKHZtaWQpOworCWlmICghdmRtYWJ1ZikgeworCQlkZXZfZXJyKGRydl9pbmZvLT5kZXYs
CisJCQkiY2FuJ3QgZmluZCB2ZG1hYnVmIGZvciA6IHZtaWQgPSAlbGx1XG4iLCB2bWlkKTsKKwkJ
cmV0dXJuIC1FSU5WQUw7CisJfQorCisJaWYgKGNtZCAhPSBWSVJUSU9fVkRNQUJVRl9DTURfRE1B
QlVGX1JFTCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwltc2cgPSBrdmNhbGxvYygxLCBzaXplb2Yo
c3RydWN0IHZpcnRpb192ZG1hYnVmX21zZyksCisJCSAgICAgICBHRlBfS0VSTkVMKTsKKwlpZiAo
IW1zZykKKwkJcmV0dXJuIC1FTk9NRU07CisKKwltZW1jcHkoJm1zZy0+b3BbMF0sICZvcFswXSwg
OCAqIHNpemVvZihpbnQpKTsKKwltc2ctPmNtZCA9IGNtZDsKKworCWxpc3RfYWRkX3RhaWwoJm1z
Zy0+bGlzdCwgJnZkbWFidWYtPm1zZ19saXN0KTsKKwl2aG9zdF93b3JrX3F1ZXVlKCZ2ZG1hYnVm
LT5kZXYsICZ2ZG1hYnVmLT5zZW5kX3dvcmspOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBp
bnQgcmVnaXN0ZXJfZXhwb3J0ZWQoc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYsCisJCQkg
ICAgIHZpcnRpb192ZG1hYnVmX2J1Zl9pZF90ICpidWZfaWQsIGludCAqb3BzKQoreworCXN0cnVj
dCB2aXJ0aW9fdmRtYWJ1Zl9idWYgKmltcDsKKwlpbnQgcmV0OworCisJaW1wID0ga2NhbGxvYygx
LCBzaXplb2YoKmltcCksIEdGUF9LRVJORUwpOworCWlmICghaW1wKQorCQlyZXR1cm4gLUVOT01F
TTsKKworCWltcC0+cGFnZXNfaW5mbyA9IGtjYWxsb2MoMSwgc2l6ZW9mKHN0cnVjdCB2aXJ0aW9f
dmRtYWJ1Zl9zaGFyZWRfcGFnZXMpLAorCQkJCSAgR0ZQX0tFUk5FTCk7CisJaWYgKCFpbXAtPnBh
Z2VzX2luZm8pIHsKKwkJa2ZyZWUoaW1wKTsKKwkJcmV0dXJuIC1FTk9NRU07CisJfQorCisJaW1w
LT5zel9wcml2ID0gb3BzW1ZJUlRJT19WRE1BQlVGX1BSSVZBVEVfREFUQV9TSVpFXTsKKwlpZiAo
aW1wLT5zel9wcml2KSB7CisJCWltcC0+cHJpdiA9IGtjYWxsb2MoMSwgb3BzW1ZJUlRJT19WRE1B
QlVGX1BSSVZBVEVfREFUQV9TSVpFXSwKKwkJCQkgICAgR0ZQX0tFUk5FTCk7CisJCWlmICghaW1w
LT5wcml2KSB7CisJCQlrZnJlZShpbXAtPnBhZ2VzX2luZm8pOworCQkJa2ZyZWUoaW1wKTsKKwkJ
CXJldHVybiAtRU5PTUVNOworCQl9CisJfQorCisJbWVtY3B5KCZpbXAtPmJ1Zl9pZCwgYnVmX2lk
LCBzaXplb2YoKmJ1Zl9pZCkpOworCisJaW1wLT5wYWdlc19pbmZvLT5uZW50cyA9IG9wc1tWSVJU
SU9fVkRNQUJVRl9OVU1fUEFHRVNfU0hBUkVEXTsKKwlpbXAtPnBhZ2VzX2luZm8tPmZpcnN0X29m
c3QgPSBvcHNbVklSVElPX1ZETUFCVUZfRklSU1RfUEFHRV9EQVRBX09GRlNFVF07CisJaW1wLT5w
YWdlc19pbmZvLT5sYXN0X2xlbiA9IG9wc1tWSVJUSU9fVkRNQUJVRl9MQVNUX1BBR0VfREFUQV9M
RU5HVEhdOworCWltcC0+cGFnZXNfaW5mby0+cmVmID0gKihncGFfdCAqKSZvcHNbVklSVElPX1ZE
TUFCVUZfUkVGX0FERFJfVVBQRVJfMzJCSVRdOworCWltcC0+dm1pZCA9IHZkbWFidWYtPnZtaWQ7
CisJaW1wLT52YWxpZCA9IHRydWU7CisKKwl2aXJ0aW9fdmRtYWJ1Zl9hZGRfYnVmKGRydl9pbmZv
LCBpbXApOworCisJLyogdHJhbnNmZXJyaW5nIHByaXZhdGUgZGF0YSAqLworCW1lbWNweShpbXAt
PnByaXYsICZvcHNbVklSVElPX1ZETUFCVUZfUFJJVkFURV9EQVRBX1NUQVJUXSwKKwkgICAgICAg
aW1wLT5zel9wcml2KTsKKworCS8qIGdlbmVyYXRlIGltcG9ydCBldmVudCAqLworCXJldCA9IHZo
b3N0X3ZkbWFidWZfYWRkX2V2ZW50KHZkbWFidWYsIGltcCk7CisJaWYgKHJldCkKKwkJcmV0dXJu
IHJldDsKKworCXJldHVybiAwOworfQorCitzdGF0aWMgdm9pZCBzZW5kX3RvX3JlY3ZxKHN0cnVj
dCB2aG9zdF92ZG1hYnVmICp2ZG1hYnVmLAorCQkJICBzdHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlICp2
cSkKK3sKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfbXNnICptc2c7CisJaW50IGhlYWQsIGluLCBv
dXQsIGluX3NpemU7CisJYm9vbCBhZGRlZCA9IGZhbHNlOworCWludCByZXQ7CisKKwltdXRleF9s
b2NrKCZ2cS0+bXV0ZXgpOworCisJaWYgKCF2aG9zdF92cV9nZXRfYmFja2VuZCh2cSkpCisJCWdv
dG8gb3V0OworCisJdmhvc3RfZGlzYWJsZV9ub3RpZnkoJnZkbWFidWYtPmRldiwgdnEpOworCisJ
Zm9yICg7OykgeworCQlpZiAobGlzdF9lbXB0eSgmdmRtYWJ1Zi0+bXNnX2xpc3QpKQorCQkJYnJl
YWs7CisKKwkJaGVhZCA9IHZob3N0X2dldF92cV9kZXNjKHZxLCB2cS0+aW92LCBBUlJBWV9TSVpF
KHZxLT5pb3YpLAorCQkJCQkgJm91dCwgJmluLCBOVUxMLCBOVUxMKTsKKworCQlpZiAoaGVhZCA8
IDAgfHwgaGVhZCA9PSB2cS0+bnVtKQorCQkJYnJlYWs7CisKKwkJaW5fc2l6ZSA9IGlvdl9sZW5n
dGgoJnZxLT5pb3Zbb3V0XSwgaW4pOworCQlpZiAoaW5fc2l6ZSAhPSBzaXplb2Yoc3RydWN0IHZp
cnRpb192ZG1hYnVmX21zZykpIHsKKwkJCWRldl9lcnIoZHJ2X2luZm8tPmRldiwgInJ4IG1zZyB3
aXRoIHdyb25nIHNpemVcbiIpOworCQkJYnJlYWs7CisJCX0KKworCQltc2cgPSBsaXN0X2ZpcnN0
X2VudHJ5KCZ2ZG1hYnVmLT5tc2dfbGlzdCwKKwkJCQkgICAgICAgc3RydWN0IHZpcnRpb192ZG1h
YnVmX21zZywgbGlzdCk7CisJCWxpc3RfZGVsX2luaXQoJm1zZy0+bGlzdCk7CisKKwkJcmV0ID0g
X19jb3B5X3RvX3VzZXIodnEtPmlvdltvdXRdLmlvdl9iYXNlLCBtc2csCisJCQkJICAgICBzaXpl
b2Yoc3RydWN0IHZpcnRpb192ZG1hYnVmX21zZykpOworCQlpZiAocmV0KSB7CisJCQlkZXZfZXJy
KGRydl9pbmZvLT5kZXYsCisJCQkJImZhaWwgdG8gY29weSB0eCBtc2dcbiIpOworCQkJYnJlYWs7
CisJCX0KKworCQl2aG9zdF9hZGRfdXNlZCh2cSwgaGVhZCwgaW5fc2l6ZSk7CisJCWFkZGVkID0g
dHJ1ZTsKKworCQkvL2tmcmVlKG1zZyk7CisJfQorCisJdmhvc3RfZW5hYmxlX25vdGlmeSgmdmRt
YWJ1Zi0+ZGV2LCB2cSk7CisJaWYgKGFkZGVkKQorCQl2aG9zdF9zaWduYWwoJnZkbWFidWYtPmRl
diwgdnEpOworb3V0OgorCW11dGV4X3VubG9jaygmdnEtPm11dGV4KTsKK30KKworc3RhdGljIHZv
aWQgdmhvc3Rfc2VuZF9tc2dfd29yayhzdHJ1Y3Qgdmhvc3Rfd29yayAqd29yaykKK3sKKwlzdHJ1
Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiA9IGNvbnRhaW5lcl9vZih3b3JrLAorCQkJCQkgICAg
ICAgICAgICAgc3RydWN0IHZob3N0X3ZkbWFidWYsCisJCQkJCSAgICAgICAgICAgICBzZW5kX3dv
cmspOworCXN0cnVjdCB2aG9zdF92aXJ0cXVldWUgKnZxID0gJnZkbWFidWYtPnZxc1tWRE1BQlVG
X1ZRX1JFQ1ZdOworCisJc2VuZF90b19yZWN2cSh2ZG1hYnVmLCB2cSk7Cit9CisKKy8qIHBhcnNl
IGluY29taW5nIG1lc3NhZ2UgZnJvbSBhIGd1ZXN0ICovCitzdGF0aWMgaW50IHBhcnNlX21zZyhz
dHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiwKKwkJICAgICBzdHJ1Y3QgdmlydGlvX3ZkbWFi
dWZfbXNnICptc2cpCit7CisJdmlydGlvX3ZkbWFidWZfYnVmX2lkX3QgKmJ1Zl9pZDsKKwlzdHJ1
Y3QgdmlydGlvX3ZkbWFidWZfbXNnICp2bWlkX21zZzsKKwlpbnQgcmV0ID0gMDsKKworCXN3aXRj
aCAobXNnLT5jbWQpIHsKKwljYXNlIFZJUlRJT19WRE1BQlVGX0NNRF9FWFBPUlQ6CisJCWJ1Zl9p
ZCA9ICh2aXJ0aW9fdmRtYWJ1Zl9idWZfaWRfdCAqKW1zZy0+b3A7CisJCXJldCA9IHJlZ2lzdGVy
X2V4cG9ydGVkKHZkbWFidWYsIGJ1Zl9pZCwgbXNnLT5vcCk7CisKKwkJYnJlYWs7CisJY2FzZSBW
SVJUSU9fVkRNQUJVRl9DTURfTkVFRF9WTUlEOgorCQl2bWlkX21zZyA9IGt2Y2FsbG9jKDEsIHNp
emVvZihzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfbXNnKSwKKwkJCQkgICAgR0ZQX0tFUk5FTCk7CisJ
CWlmICghdm1pZF9tc2cpIHsKKwkJCXJldCA9IC1FTk9NRU07CisJCQlicmVhazsKKwkJfQorCisJ
CXZtaWRfbXNnLT5jbWQgPSBtc2ctPmNtZDsKKwkJdm1pZF9tc2ctPm9wWzBdID0gdmRtYWJ1Zi0+
dm1pZDsKKwkJbGlzdF9hZGRfdGFpbCgmdm1pZF9tc2ctPmxpc3QsICZ2ZG1hYnVmLT5tc2dfbGlz
dCk7CisJCXZob3N0X3dvcmtfcXVldWUoJnZkbWFidWYtPmRldiwgJnZkbWFidWYtPnNlbmRfd29y
ayk7CisKKwkJYnJlYWs7CisJZGVmYXVsdDoKKwkJcmV0ID0gLUVJTlZBTDsKKwkJYnJlYWs7CisJ
fQorCisJcmV0dXJuIHJldDsKK30KKworc3RhdGljIHZvaWQgdmhvc3RfdmRtYWJ1Zl9oYW5kbGVf
c2VuZF9raWNrKHN0cnVjdCB2aG9zdF93b3JrICp3b3JrKQoreworCXN0cnVjdCB2aG9zdF92aXJ0
cXVldWUgKnZxID0gY29udGFpbmVyX29mKHdvcmssCisJCQkJCQkgIHN0cnVjdCB2aG9zdF92aXJ0
cXVldWUsCisJCQkJCQkgIHBvbGwud29yayk7CisJc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFi
dWYgPSBjb250YWluZXJfb2YodnEtPmRldiwKKwkJCQkJICAgICAgCSAgICAgc3RydWN0IHZob3N0
X3ZkbWFidWYsCisJCQkJCSAgICAgIAkgICAgIGRldik7CisJc3RydWN0IHZpcnRpb192ZG1hYnVm
X21zZyBtc2c7CisJaW50IGhlYWQsIGluLCBvdXQsIGluX3NpemU7CisJYm9vbCBhZGRlZCA9IGZh
bHNlOworCWludCByZXQ7CisKKwltdXRleF9sb2NrKCZ2cS0+bXV0ZXgpOworCisJaWYgKCF2aG9z
dF92cV9nZXRfYmFja2VuZCh2cSkpCisJCWdvdG8gb3V0OworCisJdmhvc3RfZGlzYWJsZV9ub3Rp
ZnkoJnZkbWFidWYtPmRldiwgdnEpOworCisJLyogTWFrZSBzdXJlIHdlIHdpbGwgcHJvY2VzcyBh
bGwgcGVuZGluZyByZXF1ZXN0cyAqLworCWZvciAoOzspIHsKKwkJaGVhZCA9IHZob3N0X2dldF92
cV9kZXNjKHZxLCB2cS0+aW92LCBBUlJBWV9TSVpFKHZxLT5pb3YpLAorCQkJCQkgJm91dCwgJmlu
LCBOVUxMLCBOVUxMKTsKKworCQlpZiAoaGVhZCA8IDAgfHwgaGVhZCA9PSB2cS0+bnVtKQorCQkJ
YnJlYWs7CisKKwkJaW5fc2l6ZSA9IGlvdl9sZW5ndGgoJnZxLT5pb3ZbaW5dLCBvdXQpOworCQlp
ZiAoaW5fc2l6ZSAhPSBzaXplb2Yoc3RydWN0IHZpcnRpb192ZG1hYnVmX21zZykpIHsKKwkJCWRl
dl9lcnIoZHJ2X2luZm8tPmRldiwgInJ4IG1zZyB3aXRoIHdyb25nIHNpemVcbiIpOworCQkJYnJl
YWs7CisJCX0KKworCQlpZiAoX19jb3B5X2Zyb21fdXNlcigmbXNnLCB2cS0+aW92W2luXS5pb3Zf
YmFzZSwgaW5fc2l6ZSkpIHsKKwkJCWRldl9lcnIoZHJ2X2luZm8tPmRldiwKKwkJCQkiZXJyOiBj
YW4ndCBnZXQgdGhlIG1zZyBmcm9tIHZxXG4iKTsKKwkJCWJyZWFrOworCQl9CisKKwkJcmV0ID0g
cGFyc2VfbXNnKHZkbWFidWYsICZtc2cpOworCQlpZiAocmV0KSB7CisJCQlkZXZfZXJyKGRydl9p
bmZvLT5kZXYsCisJCQkJIm1zZyBwYXJzZSBlcnJvcjogJWQiLAorCQkJCXJldCk7CisJCQlkZXZf
ZXJyKGRydl9pbmZvLT5kZXYsCisJCQkJIiBjbWQ6ICVkXG4iLCBtc2cuY21kKTsKKworCQkJYnJl
YWs7CisJCX0KKworCQl2aG9zdF9hZGRfdXNlZCh2cSwgaGVhZCwgaW5fc2l6ZSk7CisJCWFkZGVk
ID0gdHJ1ZTsKKwl9CisKKwl2aG9zdF9lbmFibGVfbm90aWZ5KCZ2ZG1hYnVmLT5kZXYsIHZxKTsK
KwlpZiAoYWRkZWQpCisJCXZob3N0X3NpZ25hbCgmdmRtYWJ1Zi0+ZGV2LCB2cSk7CitvdXQ6CisJ
bXV0ZXhfdW5sb2NrKCZ2cS0+bXV0ZXgpOworfQorCitzdGF0aWMgdm9pZCB2aG9zdF92ZG1hYnVm
X2hhbmRsZV9yZWN2X2tpY2soc3RydWN0IHZob3N0X3dvcmsgKndvcmspCit7CisJc3RydWN0IHZo
b3N0X3ZpcnRxdWV1ZSAqdnEgPSBjb250YWluZXJfb2Yod29yaywKKwkJCQkJCSAgc3RydWN0IHZo
b3N0X3ZpcnRxdWV1ZSwKKwkJCQkJCSAgcG9sbC53b3JrKTsKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1
ZiAqdmRtYWJ1ZiA9IGNvbnRhaW5lcl9vZih2cS0+ZGV2LAorCQkJCQkgICAgICAJICAgICBzdHJ1
Y3Qgdmhvc3RfdmRtYWJ1ZiwKKwkJCQkJICAgICAgCSAgICAgZGV2KTsKKworCXNlbmRfdG9fcmVj
dnEodmRtYWJ1ZiwgdnEpOworfQorCitzdGF0aWMgaW50IHZob3N0X3ZkbWFidWZfZ2V0X2t2bShz
dHJ1Y3Qgbm90aWZpZXJfYmxvY2sgKm5iLAorCQkJCSB1bnNpZ25lZCBsb25nIGV2ZW50LCB2b2lk
ICpkYXRhKQoreworCXN0cnVjdCBrdm1faW5zdGFuY2UgKmluc3RhbmNlOworCXN0cnVjdCB2aXJ0
aW9fdmRtYWJ1Zl9pbmZvICpkcnYgPSBjb250YWluZXJfb2YobmIsCisJCQkJCQlzdHJ1Y3Qgdmly
dGlvX3ZkbWFidWZfaW5mbywKKwkJCQkJCWt2bV9ub3RpZmllcik7CisKKwlpbnN0YW5jZSA9IGt6
YWxsb2Moc2l6ZW9mKCppbnN0YW5jZSksIEdGUF9LRVJORUwpOworCWlmIChpbnN0YW5jZSAmJiBl
dmVudCA9PSBLVk1fRVZFTlRfQ1JFQVRFX1ZNKSB7CisJCWlmIChkYXRhKSB7CisJCQlpbnN0YW5j
ZS0+a3ZtID0gZGF0YTsKKwkJCWxpc3RfYWRkX3RhaWwoJmluc3RhbmNlLT5saW5rLAorCQkJCSAg
ICAgICZkcnYtPmt2bV9pbnN0YW5jZXMpOworCQl9CisJfQorCisJcmV0dXJuIE5PVElGWV9PSzsK
K30KKworc3RhdGljIHN0cnVjdCBrdm0gKmZpbmRfa3ZtX2luc3RhbmNlKHU2NCB2bWlkKQorewor
CXN0cnVjdCBrdm1faW5zdGFuY2UgKmluc3RhbmNlLCAqdG1wOworCXN0cnVjdCBrdm0gKmt2bSA9
IE5VTEw7CisKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3NhZmUoaW5zdGFuY2UsIHRtcCwgJmRydl9p
bmZvLT5rdm1faW5zdGFuY2VzLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlu
aykgeworCQlpZiAoaW5zdGFuY2UtPmt2bS0+dXNlcnNwYWNlX3BpZCA9PSB2bWlkKSB7CisJCQlr
dm0gPSBpbnN0YW5jZS0+a3ZtOworCisJCQlsaXN0X2RlbCgmaW5zdGFuY2UtPmxpbmspOworCQkJ
a2ZyZWUoaW5zdGFuY2UpOworCQkJYnJlYWs7CisJCX0KKwl9CisKKwlyZXR1cm4ga3ZtOworfQor
CitzdGF0aWMgaW50IHZob3N0X3ZkbWFidWZfb3BlbihzdHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1
Y3QgZmlsZSAqZmlscCkKK3sKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZjsKKwlzdHJ1
Y3Qgdmhvc3RfdmlydHF1ZXVlICoqdnFzOworCWludCByZXQgPSAwOworCisJaWYgKCFkcnZfaW5m
bykgeworCQlwcl9lcnIoInZob3N0LXZkbWFidWY6IGNhbid0IG9wZW4gbWlzYyBkZXZpY2VcbiIp
OworCQlyZXR1cm4gLUVJTlZBTDsKKwl9CisKKwl2ZG1hYnVmID0ga3phbGxvYyhzaXplb2YoKnZk
bWFidWYpLCBHRlBfS0VSTkVMIHwKKwkJCSAgIF9fR0ZQX1JFVFJZX01BWUZBSUwpOworCWlmICgh
dmRtYWJ1ZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwl2cXMgPSBrbWFsbG9jX2FycmF5KEFSUkFZ
X1NJWkUodmRtYWJ1Zi0+dnFzKSwgc2l6ZW9mKCp2cXMpLAorCQkJICAgIEdGUF9LRVJORUwpOwor
CWlmICghdnFzKSB7CisJCWtmcmVlKHZkbWFidWYpOworCQlyZXR1cm4gLUVOT01FTTsKKwl9CisK
Kwl2ZG1hYnVmLT5ldnEgPSBrY2FsbG9jKDEsIHNpemVvZigqKHZkbWFidWYtPmV2cSkpLCBHRlBf
S0VSTkVMKTsKKwlpZiAoIXZkbWFidWYtPmV2cSkgeworCQlrZnJlZSh2ZG1hYnVmKTsKKwkJa2Zy
ZWUodnFzKTsKKwkJcmV0dXJuIC1FTk9NRU07CisJfQorCisJdnFzW1ZETUFCVUZfVlFfU0VORF0g
PSAmdmRtYWJ1Zi0+dnFzW1ZETUFCVUZfVlFfU0VORF07CisJdnFzW1ZETUFCVUZfVlFfUkVDVl0g
PSAmdmRtYWJ1Zi0+dnFzW1ZETUFCVUZfVlFfUkVDVl07CisJdmRtYWJ1Zi0+dnFzW1ZETUFCVUZf
VlFfU0VORF0uaGFuZGxlX2tpY2sgPSB2aG9zdF92ZG1hYnVmX2hhbmRsZV9zZW5kX2tpY2s7CisJ
dmRtYWJ1Zi0+dnFzW1ZETUFCVUZfVlFfUkVDVl0uaGFuZGxlX2tpY2sgPSB2aG9zdF92ZG1hYnVm
X2hhbmRsZV9yZWN2X2tpY2s7CisKKwl2aG9zdF9kZXZfaW5pdCgmdmRtYWJ1Zi0+ZGV2LCB2cXMs
IEFSUkFZX1NJWkUodmRtYWJ1Zi0+dnFzKSwKKwkJICAgICAgIFVJT19NQVhJT1YsIDAsIDAsIHRy
dWUsIE5VTEwpOworCisJSU5JVF9MSVNUX0hFQUQoJnZkbWFidWYtPm1zZ19saXN0KTsKKwl2aG9z
dF93b3JrX2luaXQoJnZkbWFidWYtPnNlbmRfd29yaywgdmhvc3Rfc2VuZF9tc2dfd29yayk7CisJ
dmRtYWJ1Zi0+dm1pZCA9IHRhc2tfcGlkX25yKGN1cnJlbnQpOworCXZkbWFidWYtPmt2bSA9IGZp
bmRfa3ZtX2luc3RhbmNlKHZkbWFidWYtPnZtaWQpOworCXZob3N0X3ZkbWFidWZfYWRkKHZkbWFi
dWYpOworCisJbXV0ZXhfaW5pdCgmdmRtYWJ1Zi0+ZXZxLT5lX3JlYWRsb2NrKTsKKwlzcGluX2xv
Y2tfaW5pdCgmdmRtYWJ1Zi0+ZXZxLT5lX2xvY2spOworCisJLyogSW5pdGlhbGl6ZSBldmVudCBx
dWV1ZSAqLworCUlOSVRfTElTVF9IRUFEKCZ2ZG1hYnVmLT5ldnEtPmVfbGlzdCk7CisJaW5pdF93
YWl0cXVldWVfaGVhZCgmdmRtYWJ1Zi0+ZXZxLT5lX3dhaXQpOworCisJLyogcmVzZXR0aW5nIG51
bWJlciBvZiBwZW5kaW5nIGV2ZW50cyAqLworCXZkbWFidWYtPmV2cS0+cGVuZGluZyA9IDA7CisJ
ZmlscC0+cHJpdmF0ZV9kYXRhID0gdmRtYWJ1ZjsKKworCXJldHVybiByZXQ7Cit9CisKK3N0YXRp
YyB2b2lkIHZob3N0X3ZkbWFidWZfZmx1c2goc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYp
Cit7CisJaW50IGk7CisKKwlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRSh2ZG1hYnVmLT52cXMp
OyBpKyspCisJCWlmICh2ZG1hYnVmLT52cXNbaV0uaGFuZGxlX2tpY2spCisJCQl2aG9zdF9wb2xs
X2ZsdXNoKCZ2ZG1hYnVmLT52cXNbaV0ucG9sbCk7CisKKwl2aG9zdF93b3JrX2ZsdXNoKCZ2ZG1h
YnVmLT5kZXYsICZ2ZG1hYnVmLT5zZW5kX3dvcmspOworfQorCitzdGF0aWMgaW50IHZob3N0X3Zk
bWFidWZfcmVsZWFzZShzdHJ1Y3QgaW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmlsZSAqZmlscCkKK3sK
KwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiA9IGZpbHAtPnByaXZhdGVfZGF0YTsKKwlz
dHJ1Y3QgdmlydGlvX3ZkbWFidWZfZXZlbnQgKmUsICpldDsKKworCWlmICghdmhvc3RfdmRtYWJ1
Zl9kZWwodmRtYWJ1ZikpCisJCXJldHVybiAtRUlOVkFMOworCisJbXV0ZXhfbG9jaygmZHJ2X2lu
Zm8tPmdfbXV0ZXgpOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKGUsIGV0LCAmdmRtYWJ1
Zi0+ZXZxLT5lX2xpc3QsCisJCQkJIGxpbmspIHsKKwkJbGlzdF9kZWwoJmUtPmxpbmspOworCQlr
ZnJlZShlKTsKKwkJdmRtYWJ1Zi0+ZXZxLT5wZW5kaW5nLS07CisJfQorCisJdmhvc3RfdmRtYWJ1
Zl9mbHVzaCh2ZG1hYnVmKTsKKwl2aG9zdF9kZXZfY2xlYW51cCgmdmRtYWJ1Zi0+ZGV2KTsKKwor
CWtmcmVlKHZkbWFidWYtPmRldi52cXMpOworCWt2ZnJlZSh2ZG1hYnVmKTsKKworCWZpbHAtPnBy
aXZhdGVfZGF0YSA9IE5VTEw7CisJbXV0ZXhfdW5sb2NrKCZkcnZfaW5mby0+Z19tdXRleCk7CisK
KwlyZXR1cm4gMDsKK30KKworc3RhdGljIHVuc2lnbmVkIGludCB2aG9zdF92ZG1hYnVmX2V2ZW50
X3BvbGwoc3RydWN0IGZpbGUgKmZpbHAsCisJCQkJICAgIAkgICAgIHN0cnVjdCBwb2xsX3RhYmxl
X3N0cnVjdCAqd2FpdCkKK3sKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiA9IGZpbHAt
PnByaXZhdGVfZGF0YTsKKworCXBvbGxfd2FpdChmaWxwLCAmdmRtYWJ1Zi0+ZXZxLT5lX3dhaXQs
IHdhaXQpOworCisJaWYgKCFsaXN0X2VtcHR5KCZ2ZG1hYnVmLT5ldnEtPmVfbGlzdCkpCisJCXJl
dHVybiBQT0xMSU4gfCBQT0xMUkROT1JNOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBzc2l6
ZV90IHZob3N0X3ZkbWFidWZfZXZlbnRfcmVhZChzdHJ1Y3QgZmlsZSAqZmlscCwgY2hhciBfX3Vz
ZXIgKmJ1ZiwKKwkJCSAgICAgICAJCXNpemVfdCBjbnQsIGxvZmZfdCAqb2ZzdCkKK3sKKwlzdHJ1
Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiA9IGZpbHAtPnByaXZhdGVfZGF0YTsKKwlpbnQgcmV0
OworCisJaWYgKHRhc2tfcGlkX25yKGN1cnJlbnQpICE9IHZkbWFidWYtPnZtaWQpIHsKKwkJZGV2
X2VycihkcnZfaW5mby0+ZGV2LCAiY3VycmVudCBwcm9jZXNzIGNhbm5vdCByZWFkIGV2ZW50c1xu
Iik7CisJCXJldHVybiAtRVBFUk07CisJfQorCisJLyogbWFrZSBzdXJlIHVzZXIgYnVmZmVyIGNh
biBiZSB3cml0dGVuICovCisJaWYgKCFhY2Nlc3Nfb2soYnVmLCBzaXplb2YoKmJ1ZikpKSB7CisJ
CWRldl9lcnIoZHJ2X2luZm8tPmRldiwgInVzZXIgYnVmZmVyIGNhbid0IGJlIHdyaXR0ZW4uXG4i
KTsKKwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJcmV0ID0gbXV0ZXhfbG9ja19pbnRlcnJ1cHRp
YmxlKCZ2ZG1hYnVmLT5ldnEtPmVfcmVhZGxvY2spOworCWlmIChyZXQpCisJCXJldHVybiByZXQ7
CisKKwlmb3IgKDs7KSB7CisJCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9ldmVudCAqZSA9IE5VTEw7
CisKKwkJc3Bpbl9sb2NrX2lycSgmdmRtYWJ1Zi0+ZXZxLT5lX2xvY2spOworCQlpZiAoIWxpc3Rf
ZW1wdHkoJnZkbWFidWYtPmV2cS0+ZV9saXN0KSkgeworCQkJZSA9IGxpc3RfZmlyc3RfZW50cnko
JnZkbWFidWYtPmV2cS0+ZV9saXN0LAorCQkJCQkgICAgIHN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9l
dmVudCwgbGluayk7CisJCQlsaXN0X2RlbCgmZS0+bGluayk7CisJCX0KKwkJc3Bpbl91bmxvY2tf
aXJxKCZ2ZG1hYnVmLT5ldnEtPmVfbG9jayk7CisKKwkJaWYgKCFlKSB7CisJCQlpZiAocmV0KQor
CQkJCWJyZWFrOworCisJCQlpZiAoZmlscC0+Zl9mbGFncyAmIE9fTk9OQkxPQ0spIHsKKwkJCQly
ZXQgPSAtRUFHQUlOOworCQkJCWJyZWFrOworCQkJfQorCisJCQltdXRleF91bmxvY2soJnZkbWFi
dWYtPmV2cS0+ZV9yZWFkbG9jayk7CisJCQlyZXQgPSB3YWl0X2V2ZW50X2ludGVycnVwdGlibGUo
dmRtYWJ1Zi0+ZXZxLT5lX3dhaXQsCisJCQkJCSFsaXN0X2VtcHR5KCZ2ZG1hYnVmLT5ldnEtPmVf
bGlzdCkpOworCisJCQlpZiAocmV0ID09IDApCisJCQkJcmV0ID0gbXV0ZXhfbG9ja19pbnRlcnJ1
cHRpYmxlKAorCQkJCQkJJnZkbWFidWYtPmV2cS0+ZV9yZWFkbG9jayk7CisKKwkJCWlmIChyZXQp
CisJCQkJcmV0dXJuIHJldDsKKwkJfSBlbHNlIHsKKwkJCXVuc2lnbmVkIGludCBsZW4gPSAoc2l6
ZW9mKGUtPmVfZGF0YS5oZHIpICsKKwkJCQkJICAgIGUtPmVfZGF0YS5oZHIuc2l6ZSk7CisKKwkJ
CWlmIChsZW4gPiBjbnQgLSByZXQpIHsKK3B1dF9iYWNrX2V2ZW50OgorCQkJCXNwaW5fbG9ja19p
cnEoJnZkbWFidWYtPmV2cS0+ZV9sb2NrKTsKKwkJCQlsaXN0X2FkZCgmZS0+bGluaywgJnZkbWFi
dWYtPmV2cS0+ZV9saXN0KTsKKwkJCQlzcGluX3VubG9ja19pcnEoJnZkbWFidWYtPmV2cS0+ZV9s
b2NrKTsKKwkJCQlicmVhazsKKwkJCX0KKworCQkJaWYgKGNvcHlfdG9fdXNlcihidWYgKyByZXQs
ICZlLT5lX2RhdGEuaGRyLAorCQkJCQkgc2l6ZW9mKGUtPmVfZGF0YS5oZHIpKSkgeworCQkJCWlm
IChyZXQgPT0gMCkKKwkJCQkJcmV0ID0gLUVGQVVMVDsKKworCQkJCWdvdG8gcHV0X2JhY2tfZXZl
bnQ7CisJCQl9CisKKwkJCXJldCArPSBzaXplb2YoZS0+ZV9kYXRhLmhkcik7CisKKwkJCWlmIChj
b3B5X3RvX3VzZXIoYnVmICsgcmV0LCBlLT5lX2RhdGEuZGF0YSwKKwkJCQkJIGUtPmVfZGF0YS5o
ZHIuc2l6ZSkpIHsKKworCQkJCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9lX2hkciBkdW1teV9oZHIg
PSB7MH07CisKKwkJCQlyZXQgLT0gc2l6ZW9mKGUtPmVfZGF0YS5oZHIpOworCisJCQkJLyogbnVs
bGlmeWluZyBoZHIgb2YgdGhlIGV2ZW50IGluIHVzZXIgYnVmZmVyICovCisJCQkJaWYgKGNvcHlf
dG9fdXNlcihidWYgKyByZXQsICZkdW1teV9oZHIsCisJCQkJCQkgc2l6ZW9mKGR1bW15X2hkcikp
KQorCQkJCQlkZXZfZXJyKGRydl9pbmZvLT5kZXYsCisJCQkJCSAgICJmYWlsIHRvIG51bGxpZnkg
aW52YWxpZCBoZHJcbiIpOworCisJCQkJcmV0ID0gLUVGQVVMVDsKKworCQkJCWdvdG8gcHV0X2Jh
Y2tfZXZlbnQ7CisJCQl9CisKKwkJCXJldCArPSBlLT5lX2RhdGEuaGRyLnNpemU7CisKKwkJCXNw
aW5fbG9ja19pcnEoJnZkbWFidWYtPmV2cS0+ZV9sb2NrKTsKKwkJCXZkbWFidWYtPmV2cS0+cGVu
ZGluZy0tOworCQkJc3Bpbl91bmxvY2tfaXJxKCZ2ZG1hYnVmLT5ldnEtPmVfbG9jayk7CisJCQlr
ZnJlZShlKTsKKwkJfQorCX0KKworCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+ZXZxLT5lX3JlYWRs
b2NrKTsKKworCXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBpbnQgdmhvc3RfdmRtYWJ1Zl9zdGFy
dChzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZikKK3sKKyAgICAgICAgc3RydWN0IHZob3N0
X3ZpcnRxdWV1ZSAqdnE7CisgICAgICAgIGludCBpLCByZXQ7CisKKwltdXRleF9sb2NrKCZ2ZG1h
YnVmLT5kZXYubXV0ZXgpOworCisgICAgICAgIHJldCA9IHZob3N0X2Rldl9jaGVja19vd25lcigm
dmRtYWJ1Zi0+ZGV2KTsKKyAgICAgICAgaWYgKHJldCkKKyAgICAgICAgICAgICAgICBnb3RvIGVy
cjsKKworCWZvciAoaSA9IDA7IGkgPCBBUlJBWV9TSVpFKHZkbWFidWYtPnZxcyk7IGkrKykgewor
CQl2cSA9ICZ2ZG1hYnVmLT52cXNbaV07CisKKwkJbXV0ZXhfbG9jaygmdnEtPm11dGV4KTsKKwor
CQlpZiAoIXZob3N0X3ZxX2FjY2Vzc19vayh2cSkpIHsKKwkJCXJldCA9IC1FRkFVTFQ7CisJCQln
b3RvIGVycl92cTsKKwkJfQorCisJCWlmICghdmhvc3RfdnFfZ2V0X2JhY2tlbmQodnEpKSB7CisJ
CQl2aG9zdF92cV9zZXRfYmFja2VuZCh2cSwgdmRtYWJ1Zik7CisJCQlyZXQgPSB2aG9zdF92cV9p
bml0X2FjY2Vzcyh2cSk7CisJCQlpZiAocmV0KQorCQkJCWdvdG8gZXJyX3ZxOworCQl9CisKKwkJ
bXV0ZXhfdW5sb2NrKCZ2cS0+bXV0ZXgpOworCX0KKworCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+
ZGV2Lm11dGV4KTsKKyAgICAgICAgcmV0dXJuIDA7CisKK2Vycl92cToKKyAgICAgICAgdmhvc3Rf
dnFfc2V0X2JhY2tlbmQodnEsIE5VTEwpOworICAgICAgICBtdXRleF91bmxvY2soJnZxLT5tdXRl
eCk7CisKKwlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRSh2ZG1hYnVmLT52cXMpOyBpKyspIHsK
KwkJdnEgPSAmdmRtYWJ1Zi0+dnFzW2ldOworCisJCW11dGV4X2xvY2soJnZxLT5tdXRleCk7CisJ
CXZob3N0X3ZxX3NldF9iYWNrZW5kKHZxLCBOVUxMKTsKKwkJbXV0ZXhfdW5sb2NrKCZ2cS0+bXV0
ZXgpOworCX0KKworZXJyOgorCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+ZGV2Lm11dGV4KTsKKyAg
ICAgICAgcmV0dXJuIHJldDsKK30KKworc3RhdGljIGludCB2aG9zdF92ZG1hYnVmX3N0b3Aoc3Ry
dWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYpCit7CisgICAgICAgIHN0cnVjdCB2aG9zdF92aXJ0
cXVldWUgKnZxOworICAgICAgICBpbnQgaSwgcmV0OworCisJbXV0ZXhfbG9jaygmdmRtYWJ1Zi0+
ZGV2Lm11dGV4KTsKKworICAgICAgICByZXQgPSB2aG9zdF9kZXZfY2hlY2tfb3duZXIoJnZkbWFi
dWYtPmRldik7CisgICAgICAgIGlmIChyZXQpCisgICAgICAgICAgICAgICAgZ290byBlcnI7CisK
Kwlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRSh2ZG1hYnVmLT52cXMpOyBpKyspIHsKKwkJdnEg
PSAmdmRtYWJ1Zi0+dnFzW2ldOworCisJCW11dGV4X2xvY2soJnZxLT5tdXRleCk7CisJCXZob3N0
X3ZxX3NldF9iYWNrZW5kKHZxLCBOVUxMKTsKKwkJbXV0ZXhfdW5sb2NrKCZ2cS0+bXV0ZXgpOwor
CX0KKworZXJyOgorCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+ZGV2Lm11dGV4KTsKKyAgICAgICAg
cmV0dXJuIHJldDsKK30KKworc3RhdGljIGludCB2aG9zdF92ZG1hYnVmX3NldF9mZWF0dXJlcyhz
dHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiwKKwkJCQkgICAgICB1NjQgZmVhdHVyZXMpCit7
CisJc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqdnE7CisJaW50IGk7CisKKwlpZiAoZmVhdHVyZXMg
JiB+VkhPU1RfVkRNQUJVRl9GRUFUVVJFUykKKwkJcmV0dXJuIC1FT1BOT1RTVVBQOworCisJbXV0
ZXhfbG9jaygmdmRtYWJ1Zi0+ZGV2Lm11dGV4KTsKKwlpZiAoKGZlYXR1cmVzICYgKDEgPDwgVkhP
U1RfRl9MT0dfQUxMKSkgJiYKKwkgICAgIXZob3N0X2xvZ19hY2Nlc3Nfb2soJnZkbWFidWYtPmRl
dikpIHsKKwkJbXV0ZXhfdW5sb2NrKCZ2ZG1hYnVmLT5kZXYubXV0ZXgpOworCQlyZXR1cm4gLUVG
QVVMVDsKKwl9CisKKwlmb3IgKGkgPSAwOyBpIDwgQVJSQVlfU0laRSh2ZG1hYnVmLT52cXMpOyBp
KyspIHsKKwkJdnEgPSAmdmRtYWJ1Zi0+dnFzW2ldOworCQltdXRleF9sb2NrKCZ2cS0+bXV0ZXgp
OworCQl2cS0+YWNrZWRfZmVhdHVyZXMgPSBmZWF0dXJlczsKKwkJbXV0ZXhfdW5sb2NrKCZ2cS0+
bXV0ZXgpOworCX0KKworCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+ZGV2Lm11dGV4KTsKKwlyZXR1
cm4gMDsKK30KKworLyogd3JhcHBlciBpb2N0bCBmb3Igdmhvc3QgaW50ZXJmYWNlIGNvbnRyb2wg
Ki8KK3N0YXRpYyBpbnQgdmhvc3RfY29yZV9pb2N0bChzdHJ1Y3QgZmlsZSAqZmlscCwgdW5zaWdu
ZWQgaW50IGNtZCwKKwkJCSAgICB1bnNpZ25lZCBsb25nIHBhcmFtKQoreworCXN0cnVjdCB2aG9z
dF92ZG1hYnVmICp2ZG1hYnVmID0gZmlscC0+cHJpdmF0ZV9kYXRhOworCXZvaWQgX191c2VyICph
cmdwID0gKHZvaWQgX191c2VyICopcGFyYW07CisJdTY0IGZlYXR1cmVzOworCWludCByZXQsIHN0
YXJ0OworCisJc3dpdGNoIChjbWQpIHsKKwljYXNlIFZIT1NUX0dFVF9GRUFUVVJFUzoKKwkJZmVh
dHVyZXMgPSBWSE9TVF9WRE1BQlVGX0ZFQVRVUkVTOworCQlpZiAoY29weV90b191c2VyKGFyZ3As
ICZmZWF0dXJlcywgc2l6ZW9mKGZlYXR1cmVzKSkpCisJCQlyZXR1cm4gLUVGQVVMVDsKKwkJcmV0
dXJuIDA7CisJY2FzZSBWSE9TVF9TRVRfRkVBVFVSRVM6CisJCWlmIChjb3B5X2Zyb21fdXNlcigm
ZmVhdHVyZXMsIGFyZ3AsIHNpemVvZihmZWF0dXJlcykpKQorCQkJcmV0dXJuIC1FRkFVTFQ7CisJ
CXJldHVybiB2aG9zdF92ZG1hYnVmX3NldF9mZWF0dXJlcyh2ZG1hYnVmLCBmZWF0dXJlcyk7CisJ
Y2FzZSBWSE9TVF9WRE1BQlVGX1NFVF9SVU5OSU5HOgorCQlpZiAoY29weV9mcm9tX3VzZXIoJnN0
YXJ0LCBhcmdwLCBzaXplb2Yoc3RhcnQpKSkKKyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVy
biAtRUZBVUxUOworCisJCWlmIChzdGFydCkKKyAgICAgICAgICAgICAgICAJcmV0dXJuIHZob3N0
X3ZkbWFidWZfc3RhcnQodmRtYWJ1Zik7CisgICAgICAgICAgICAgICAgZWxzZQorICAgICAgICAg
ICAgICAgICAgICAgICAgcmV0dXJuIHZob3N0X3ZkbWFidWZfc3RvcCh2ZG1hYnVmKTsKKwlkZWZh
dWx0OgorCQltdXRleF9sb2NrKCZ2ZG1hYnVmLT5kZXYubXV0ZXgpOworCQlyZXQgPSB2aG9zdF9k
ZXZfaW9jdGwoJnZkbWFidWYtPmRldiwgY21kLCBhcmdwKTsKKwkJaWYgKHJldCA9PSAtRU5PSU9D
VExDTUQpIHsKKwkJCXJldCA9IHZob3N0X3ZyaW5nX2lvY3RsKCZ2ZG1hYnVmLT5kZXYsIGNtZCwg
YXJncCk7CisJCX0gZWxzZSB7CisJCQl2aG9zdF92ZG1hYnVmX2ZsdXNoKHZkbWFidWYpOworCQl9
CisJCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+ZGV2Lm11dGV4KTsKKwl9CisKKwlyZXR1cm4gcmV0
OworfQorCisvKgorICogaW9jdGwgLSBpbXBvcnRpbmcgdmRtYWJ1ZiBmcm9tIGd1ZXN0IE9TCisg
KgorICogdXNlciBwYXJhbWV0ZXJzOgorICoKKyAqCXZpcnRpb192ZG1hYnVmX2J1Zl9pZF90IGJ1
Zl9pZCAtIHZkbWFidWYgSUQgb2YgaW1wb3J0ZWQgYnVmZmVyCisgKglpbnQgZmxhZ3MgLSBmbGFn
cworICoJaW50IGZkIC0gZmlsZSBoYW5kbGUgb2YJdGhlIGltcG9ydGVkIGJ1ZmZlcgorICoKKyAq
Lworc3RhdGljIGludCBpbXBvcnRfaW9jdGwoc3RydWN0IGZpbGUgKmZpbHAsIHZvaWQgKmRhdGEp
Cit7CisJc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYgPSBmaWxwLT5wcml2YXRlX2RhdGE7
CisJc3RydWN0IHZpcnRpb192ZG1hYnVmX2ltcG9ydCAqYXR0ciA9IGRhdGE7CisJc3RydWN0IHZp
cnRpb192ZG1hYnVmX2J1ZiAqaW1wOworCWludCByZXQgPSAwOworCisJbXV0ZXhfbG9jaygmdmRt
YWJ1Zi0+ZGV2Lm11dGV4KTsKKworCS8qIGxvb2sgZm9yIGRtYWJ1ZiBmb3IgdGhlIGlkICovCisJ
aW1wID0gdmlydGlvX3ZkbWFidWZfZmluZF9idWYoZHJ2X2luZm8sICZhdHRyLT5idWZfaWQpOwor
CWlmICghaW1wIHx8ICFpbXAtPnZhbGlkKSB7CisJCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+ZGV2
Lm11dGV4KTsKKwkJZGV2X2VycihkcnZfaW5mby0+ZGV2LAorCQkJIm5vIHZhbGlkIGJ1ZiBmb3Vu
ZCB3aXRoIGlkID0gJWxsdVxuIiwgYXR0ci0+YnVmX2lkLmlkKTsKKwkJcmV0dXJuIC1FTk9FTlQ7
CisJfQorCisJLyogb25seSBpZiBtYXBwZWQgcGFnZXMgYXJlIG5vdCBwcmVzZW50ICovCisJaWYg
KCFpbXAtPnBhZ2VzX2luZm8tPnBhZ2VzKSB7CisJCXJldCA9IHZob3N0X3ZkbWFidWZfbWFwX3Bh
Z2VzKHZkbWFidWYtPnZtaWQsIGltcC0+cGFnZXNfaW5mbyk7CisJCWlmIChyZXQgPCAwKSB7CisJ
CQlkZXZfZXJyKGRydl9pbmZvLT5kZXYsCisJCQkJImZhaWxlZCB0byBtYXAgZ3Vlc3QgcGFnZXNc
biIpOworCQkJZ290byBmYWlsX21hcDsKKwkJfQorCX0KKworCWF0dHItPmZkID0gdmhvc3RfdmRt
YWJ1Zl9leHBfZmQoaW1wLCBhdHRyLT5mbGFncyk7CisJaWYgKGF0dHItPmZkIDwgMCkgeworCQlk
ZXZfZXJyKGRydl9pbmZvLT5kZXYsICJmYWlsZWQgdG8gZ2V0IGZpbGUgZGVzY3JpcHRvclxuIik7
CisJCWdvdG8gZmFpbF9pbXBvcnQ7CisJfQorCisJaW1wLT5pbXBvcnRlZCA9IHRydWU7CisKKwlt
dXRleF91bmxvY2soJnZkbWFidWYtPmRldi5tdXRleCk7CisJZ290byBzdWNjZXNzOworCitmYWls
X2ltcG9ydDoKKwkvKiBub3QgaW1wb3J0ZWQgeWV0PyAqLworCWlmICghaW1wLT5pbXBvcnRlZCkg
eworCQl2aG9zdF92ZG1hYnVmX3VubWFwX3BhZ2VzKHZkbWFidWYtPnZtaWQsIGltcC0+cGFnZXNf
aW5mbyk7CisJCWlmIChpbXAtPmRtYV9idWYpCisJCQlrZnJlZShpbXAtPmRtYV9idWYpOworCisJ
CWlmIChpbXAtPnNndCkgeworCQkJc2dfZnJlZV90YWJsZShpbXAtPnNndCk7CisJCQlrZnJlZShp
bXAtPnNndCk7CisJCQlpbXAtPnNndCA9IE5VTEw7CisJCX0KKwl9CisKK2ZhaWxfbWFwOgorCS8q
IENoZWNrIGlmIGJ1ZmZlciBpcyBzdGlsbCB2YWxpZCBhbmQgaWYgbm90IHJlbW92ZSBpdAorCSAq
IGZyb20gaW1wb3J0ZWQgbGlzdC4KKwkgKi8KKwlpZiAoIWltcC0+dmFsaWQgJiYgIWltcC0+aW1w
b3J0ZWQpIHsKKwkJdmlydGlvX3ZkbWFidWZfZGVsX2J1ZihkcnZfaW5mbywgJmltcC0+YnVmX2lk
KTsKKwkJa2ZyZWUoaW1wLT5wcml2KTsKKwkJa2ZyZWUoaW1wLT5wYWdlc19pbmZvKTsKKwkJa2Zy
ZWUoaW1wKTsKKwl9CisKKwlyZXQgPSAgYXR0ci0+ZmQ7CisJbXV0ZXhfdW5sb2NrKCZ2ZG1hYnVm
LT5kZXYubXV0ZXgpOworCitzdWNjZXNzOgorCXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBpbnQg
cmVsZWFzZV9pb2N0bChzdHJ1Y3QgZmlsZSAqZmlscCwgdm9pZCAqZGF0YSkKK3sKKwlzdHJ1Y3Qg
dmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiA9IGZpbHAtPnByaXZhdGVfZGF0YTsKKwlzdHJ1Y3Qgdmly
dGlvX3ZkbWFidWZfaW1wb3J0ICphdHRyID0gZGF0YTsKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZf
YnVmICppbXA7CisJdmlydGlvX3ZkbWFidWZfYnVmX2lkX3QgYnVmX2lkID0gYXR0ci0+YnVmX2lk
OworCWludCAqb3A7CisJaW50IHJldCA9IDA7CisKKwlvcCA9IGtjYWxsb2MoMSwgc2l6ZW9mKGlu
dCkgKiA2NSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFvcCkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlp
bXAgPSB2aXJ0aW9fdmRtYWJ1Zl9maW5kX2J1ZihkcnZfaW5mbywgJmJ1Zl9pZCk7CisJaWYgKCFp
bXApCisJCXJldHVybiAtRUlOVkFMOworCisJaW1wLT5pbXBvcnRlZCA9IGZhbHNlOworCisJbWVt
Y3B5KG9wLCAmaW1wLT5idWZfaWQsIHNpemVvZihpbXAtPmJ1Zl9pZCkpOworCisJcmV0ID0gc2Vu
ZF9tc2dfdG9fZ3Vlc3QodmRtYWJ1Zi0+dm1pZCwgVklSVElPX1ZETUFCVUZfQ01EX0RNQUJVRl9S
RUwsCisJCQkJb3ApOworCWlmIChyZXQgPCAwKSB7CisJCWRldl9lcnIoZHJ2X2luZm8tPmRldiwg
ImZhaWwgdG8gc2VuZCByZWxlYXNlIGNtZFxuIik7CisJCXJldHVybiByZXQ7CisJfQorCisJcmV0
dXJuIDA7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfaW9jdGxfZGVz
YyB2aG9zdF92ZG1hYnVmX2lvY3Rsc1tdID0geworCVZJUlRJT19WRE1BQlVGX0lPQ1RMX0RFRihW
SVJUSU9fVkRNQUJVRl9JT0NUTF9JTVBPUlQsIGltcG9ydF9pb2N0bCwgMCksCisJVklSVElPX1ZE
TUFCVUZfSU9DVExfREVGKFZJUlRJT19WRE1BQlVGX0lPQ1RMX1JFTEVBU0UsIHJlbGVhc2VfaW9j
dGwsIDApLAorfTsKKworc3RhdGljIGxvbmcgdmhvc3RfdmRtYWJ1Zl9pb2N0bChzdHJ1Y3QgZmls
ZSAqZmlscCwgdW5zaWduZWQgaW50IGNtZCwKKwkJCQl1bnNpZ25lZCBsb25nIHBhcmFtKQorewor
CWNvbnN0IHN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9pb2N0bF9kZXNjICppb2N0bDsKKwl2aXJ0aW9f
dmRtYWJ1Zl9pb2N0bF90IGZ1bmM7CisJdW5zaWduZWQgaW50IG5yOworCWludCByZXQ7CisJY2hh
ciAqa2RhdGE7CisKKwkvKiBjaGVjayBpZiBjbWQgaXMgdmhvc3QncyAqLworCWlmIChfSU9DX1RZ
UEUoY21kKSA9PSBWSE9TVF9WSVJUSU8pIHsKKwkJcmV0ID0gdmhvc3RfY29yZV9pb2N0bChmaWxw
LCBjbWQsIHBhcmFtKTsKKwkJcmV0dXJuIHJldDsKKwl9CisKKwluciA9IF9JT0NfTlIoY21kKTsK
KworCWlmIChuciA+PSBBUlJBWV9TSVpFKHZob3N0X3ZkbWFidWZfaW9jdGxzKSkgeworCQlkZXZf
ZXJyKGRydl9pbmZvLT5kZXYsICJpbnZhbGlkIGlvY3RsXG4iKTsKKwkJcmV0dXJuIC1FSU5WQUw7
CisJfQorCisJaW9jdGwgPSAmdmhvc3RfdmRtYWJ1Zl9pb2N0bHNbbnJdOworCisJZnVuYyA9IGlv
Y3RsLT5mdW5jOworCisJaWYgKHVubGlrZWx5KCFmdW5jKSkgeworCQlkZXZfZXJyKGRydl9pbmZv
LT5kZXYsICJubyBmdW5jdGlvblxuIik7CisJCXJldHVybiAtRUlOVkFMOworCX0KKworCWtkYXRh
ID0ga21hbGxvYyhfSU9DX1NJWkUoY21kKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFrZGF0YSkKKwkJ
cmV0dXJuIC1FTk9NRU07CisKKwlpZiAoY29weV9mcm9tX3VzZXIoa2RhdGEsICh2b2lkIF9fdXNl
ciAqKXBhcmFtLAorCQkJICAgX0lPQ19TSVpFKGNtZCkpICE9IDApIHsKKwkJZGV2X2VycihkcnZf
aW5mby0+ZGV2LAorCQkJImZhaWxlZCB0byBjb3B5IGFyZ3MgZnJvbSB1c2Vyc3BhY2VcbiIpOwor
CQlyZXQgPSAtRUZBVUxUOworCQlnb3RvIGlvY3RsX2Vycm9yOworCX0KKworCXJldCA9IGZ1bmMo
ZmlscCwga2RhdGEpOworCisJaWYgKGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilwYXJhbSwg
a2RhdGEsCisJCQkgX0lPQ19TSVpFKGNtZCkpICE9IDApIHsKKwkJZGV2X2VycihkcnZfaW5mby0+
ZGV2LAorCQkJImZhaWxlZCB0byBjb3B5IGFyZ3MgYmFjayB0byB1c2Vyc3BhY2VcbiIpOworCQly
ZXQgPSAtRUZBVUxUOworCQlnb3RvIGlvY3RsX2Vycm9yOworCX0KKworaW9jdGxfZXJyb3I6CisJ
a2ZyZWUoa2RhdGEpOworCXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3QgZmls
ZV9vcGVyYXRpb25zIHZob3N0X3ZkbWFidWZfZm9wcyA9IHsKKwkub3duZXIgPSBUSElTX01PRFVM
RSwKKwkub3BlbiA9IHZob3N0X3ZkbWFidWZfb3BlbiwKKwkucmVsZWFzZSA9IHZob3N0X3ZkbWFi
dWZfcmVsZWFzZSwKKwkucmVhZCA9IHZob3N0X3ZkbWFidWZfZXZlbnRfcmVhZCwKKwkucG9sbCA9
IHZob3N0X3ZkbWFidWZfZXZlbnRfcG9sbCwKKwkudW5sb2NrZWRfaW9jdGwgPSB2aG9zdF92ZG1h
YnVmX2lvY3RsLAorfTsKKworc3RhdGljIHN0cnVjdCBtaXNjZGV2aWNlIHZob3N0X3ZkbWFidWZf
bWlzY2RldiA9IHsKKwkubWlub3IgPSBNSVNDX0RZTkFNSUNfTUlOT1IsCisJLm5hbWUgPSAidmhv
c3QtdmRtYWJ1ZiIsCisJLmZvcHMgPSAmdmhvc3RfdmRtYWJ1Zl9mb3BzLAorfTsKKworc3RhdGlj
IGludCBfX2luaXQgdmhvc3RfdmRtYWJ1Zl9pbml0KHZvaWQpCit7CisJaW50IHJldCA9IDA7CisK
KwlyZXQgPSBtaXNjX3JlZ2lzdGVyKCZ2aG9zdF92ZG1hYnVmX21pc2NkZXYpOworCWlmIChyZXQp
IHsKKwkJcHJfZXJyKCJ2aG9zdC12ZG1hYnVmOiBkcml2ZXIgY2FuJ3QgYmUgcmVnaXN0ZXJlZFxu
Iik7CisJCXJldHVybiByZXQ7CisJfQorCisJZG1hX2NvZXJjZV9tYXNrX2FuZF9jb2hlcmVudCh2
aG9zdF92ZG1hYnVmX21pc2NkZXYudGhpc19kZXZpY2UsCisJCQkJICAgICBETUFfQklUX01BU0so
NjQpKTsKKworCWRydl9pbmZvID0ga2NhbGxvYygxLCBzaXplb2YoKmRydl9pbmZvKSwgR0ZQX0tF
Uk5FTCk7CisJaWYgKCFkcnZfaW5mbykgeworCQltaXNjX2RlcmVnaXN0ZXIoJnZob3N0X3ZkbWFi
dWZfbWlzY2Rldik7CisJCXJldHVybiAtRU5PTUVNOworCX0KKworCWRydl9pbmZvLT5kZXYgPSB2
aG9zdF92ZG1hYnVmX21pc2NkZXYudGhpc19kZXZpY2U7CisKKwloYXNoX2luaXQoZHJ2X2luZm8t
PmJ1Zl9saXN0KTsKKwltdXRleF9pbml0KCZkcnZfaW5mby0+Z19tdXRleCk7CisKKwlJTklUX0xJ
U1RfSEVBRCgmZHJ2X2luZm8tPmhlYWRfdmRtYWJ1Zl9saXN0KTsKKwlJTklUX0xJU1RfSEVBRCgm
ZHJ2X2luZm8tPmt2bV9pbnN0YW5jZXMpOworCisJZHJ2X2luZm8tPmt2bV9ub3RpZmllci5ub3Rp
Zmllcl9jYWxsID0gdmhvc3RfdmRtYWJ1Zl9nZXRfa3ZtOworCXJldCA9IGt2bV92bV9yZWdpc3Rl
cl9ub3RpZmllcigmZHJ2X2luZm8tPmt2bV9ub3RpZmllcik7CisKKwlyZXR1cm4gcmV0OworfQor
CitzdGF0aWMgdm9pZCBfX2V4aXQgdmhvc3RfdmRtYWJ1Zl9kZWluaXQodm9pZCkKK3sKKwltaXNj
X2RlcmVnaXN0ZXIoJnZob3N0X3ZkbWFidWZfbWlzY2Rldik7CisJdmhvc3RfdmRtYWJ1Zl9kZWxf
YWxsKCk7CisKKwlrdm1fdm1fdW5yZWdpc3Rlcl9ub3RpZmllcigmZHJ2X2luZm8tPmt2bV9ub3Rp
Zmllcik7CisJa2ZyZWUoZHJ2X2luZm8pOworCWRydl9pbmZvID0gTlVMTDsKK30KKworbW9kdWxl
X2luaXQodmhvc3RfdmRtYWJ1Zl9pbml0KTsKK21vZHVsZV9leGl0KHZob3N0X3ZkbWFidWZfZGVp
bml0KTsKKworTU9EVUxFX0RFU0NSSVBUSU9OKCJWaG9zdCBWZG1hYnVmIERyaXZlciIpOworTU9E
VUxFX0xJQ0VOU0UoIkdQTCBhbmQgYWRkaXRpb25hbCByaWdodHMiKTsKZGlmZiAtLWdpdCBhL2lu
Y2x1ZGUvdWFwaS9saW51eC92aG9zdC5oIGIvaW5jbHVkZS91YXBpL2xpbnV4L3Zob3N0LmgKaW5k
ZXggYzk5ODg2MGQ3YmJjLi4yYjdiMzc2NjlhZjQgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvdWFwaS9s
aW51eC92aG9zdC5oCisrKyBiL2luY2x1ZGUvdWFwaS9saW51eC92aG9zdC5oCkBAIC0xNTAsNCAr
MTUwLDcgQEAKIC8qIEdldCB0aGUgdmFsaWQgaW92YSByYW5nZSAqLwogI2RlZmluZSBWSE9TVF9W
RFBBX0dFVF9JT1ZBX1JBTkdFCV9JT1IoVkhPU1RfVklSVElPLCAweDc4LCBcCiAJCQkJCSAgICAg
c3RydWN0IHZob3N0X3ZkcGFfaW92YV9yYW5nZSkKKworLyogVkhPU1RfVkRNQUJVRiBzcGVjaWZp
YyBkZWZpbmVzICovCisjZGVmaW5lIFZIT1NUX1ZETUFCVUZfU0VUX1JVTk5JTkcgICAgICAgX0lP
VyhWSE9TVF9WSVJUSU8sIDB4NzksIGludCkKICNlbmRpZgotLSAKMi4yNi4yCgpfX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBs
aXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVz
a3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
