Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 37B75FC86B
	for <lists+dri-devel@lfdr.de>; Thu, 14 Nov 2019 15:10:39 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 574206E313;
	Thu, 14 Nov 2019 14:10:32 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 854D06E313
 for <dri-devel@lists.freedesktop.org>; Thu, 14 Nov 2019 14:10:31 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id EE1BAB20D;
 Thu, 14 Nov 2019 14:10:29 +0000 (UTC)
From: Thomas Zimmermann <tzimmermann@suse.de>
To: airlied@redhat.com, sean@poorly.run, daniel@ffwll.ch, kraxel@redhat.com,
 emil.velikov@collabora.com, sam@ravnborg.org, noralf@tronnes.org
Subject: [PATCH 4/5] drm/udl: Call udl_handle_damage() with DRM framebuffer
Date: Thu, 14 Nov 2019 15:10:24 +0100
Message-Id: <20191114141025.32198-5-tzimmermann@suse.de>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191114141025.32198-1-tzimmermann@suse.de>
References: <20191114141025.32198-1-tzimmermann@suse.de>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Thomas Zimmermann <tzimmermann@suse.de>, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2ltcGxpZnlpbmcgdGhlIHVkbCBjb2RlIGJlZm9yZSByZXBsYWNpbmcgc3RydWN0IHVkbF9mcmFt
ZWJ1ZmZlci4KClNpZ25lZC1vZmYtYnk6IFRob21hcyBaaW1tZXJtYW5uIDx0emltbWVybWFubkBz
dXNlLmRlPgotLS0KIGRyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5oICAgICB8ICAyICstCiBk
cml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9mYi5jICAgICAgfCAzNSArKysrKysrKysrKysrKysrLS0t
LS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9tb2Rlc2V0LmMgfCAxNSArKysr
KysrLS0tLS0tCiAzIGZpbGVzIGNoYW5nZWQsIDI2IGluc2VydGlvbnMoKyksIDI2IGRlbGV0aW9u
cygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5oIGIvZHJpdmVy
cy9ncHUvZHJtL3VkbC91ZGxfZHJ2LmgKaW5kZXggYTA5NDZiOTU1NzM5Li5jNWUzMTYwMzkyY2Ig
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5oCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS91ZGwvdWRsX2Rydi5oCkBAIC0xMTAsNyArMTEwLDcgQEAgaW50IHVkbF9yZW5kZXJf
aGxpbmUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgaW50IGxvZ19icHAsIHN0cnVjdCB1cmIgKip1
cmJfcHRyLAogc3RydWN0IGRybV9nZW1fb2JqZWN0ICp1ZGxfZHJpdmVyX2dlbV9jcmVhdGVfb2Jq
ZWN0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJCQkJCQkgICAgc2l6ZV90IHNpemUpOwogCi1p
bnQgdWRsX2hhbmRsZV9kYW1hZ2Uoc3RydWN0IHVkbF9mcmFtZWJ1ZmZlciAqZmIsIGludCB4LCBp
bnQgeSwKK2ludCB1ZGxfaGFuZGxlX2RhbWFnZShzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYiwg
aW50IHgsIGludCB5LAogCQkgICAgICBpbnQgd2lkdGgsIGludCBoZWlnaHQpOwogCiBpbnQgdWRs
X2Ryb3BfdXNiKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9n
cHUvZHJtL3VkbC91ZGxfZmIuYyBiL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2ZiLmMKaW5kZXgg
ZTlhNGJiZDViMTk1Li5hZDdiZjE2NWI1OWIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS91
ZGwvdWRsX2ZiLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfZmIuYwpAQCAtNjAsMTAg
KzYwLDEwIEBAIHN0YXRpYyB1aW50MTZfdCByZ2IxNih1aW50MzJfdCBjb2wpCiB9CiAjZW5kaWYK
IAotaW50IHVkbF9oYW5kbGVfZGFtYWdlKHN0cnVjdCB1ZGxfZnJhbWVidWZmZXIgKmZiLCBpbnQg
eCwgaW50IHksCitpbnQgdWRsX2hhbmRsZV9kYW1hZ2Uoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAq
ZmIsIGludCB4LCBpbnQgeSwKIAkJICAgICAgaW50IHdpZHRoLCBpbnQgaGVpZ2h0KQogewotCXN0
cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBmYi0+YmFzZS5kZXY7CisJc3RydWN0IGRybV9kZXZpY2Ug
KmRldiA9IGZiLT5kZXY7CiAJc3RydWN0IHVkbF9kZXZpY2UgKnVkbCA9IHRvX3VkbChkZXYpOwog
CWludCBpLCByZXQ7CiAJY2hhciAqY21kOwpAQCAtNzUsMTcgKzc1LDE5IEBAIGludCB1ZGxfaGFu
ZGxlX2RhbWFnZShzdHJ1Y3QgdWRsX2ZyYW1lYnVmZmVyICpmYiwgaW50IHgsIGludCB5LAogCWlu
dCBsb2dfYnBwOwogCXZvaWQgKnZhZGRyOwogCi0JQlVHX09OKCFpc19wb3dlcl9vZl8yKGZiLT5i
YXNlLmZvcm1hdC0+Y3BwWzBdKSk7Ci0JbG9nX2JwcCA9IF9fZmZzKGZiLT5iYXNlLmZvcm1hdC0+
Y3BwWzBdKTsKKwlpZiAoV0FSTl9PTighaXNfcG93ZXJfb2ZfMihmYi0+Zm9ybWF0LT5jcHBbMF0p
KSkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlsb2dfYnBwID0gX19mZnMoZmItPmZvcm1hdC0+Y3Bw
WzBdKTsKIAogCXNwaW5fbG9jaygmdWRsLT5hY3RpdmVfZmJfMTZfbG9jayk7Ci0JaWYgKHVkbC0+
YWN0aXZlX2ZiXzE2ICE9ICZmYi0+YmFzZSkgeworCWlmICh1ZGwtPmFjdGl2ZV9mYl8xNiAhPSBm
YikgewogCQlzcGluX3VubG9jaygmdWRsLT5hY3RpdmVfZmJfMTZfbG9jayk7CiAJCXJldHVybiAw
OwogCX0KIAlzcGluX3VubG9jaygmdWRsLT5hY3RpdmVfZmJfMTZfbG9jayk7CiAKLQl2YWRkciA9
IGRybV9nZW1fc2htZW1fdm1hcCgmZmItPnNobWVtLT5iYXNlKTsKKwl2YWRkciA9IGRybV9nZW1f
c2htZW1fdm1hcChmYi0+b2JqWzBdKTsKIAlpZiAoSVNfRVJSKHZhZGRyKSkgewogCQlEUk1fRVJS
T1IoImZhaWxlZCB0byB2bWFwIGZiXG4iKTsKIAkJcmV0dXJuIDA7CkBAIC05Niw4ICs5OCw4IEBA
IGludCB1ZGxfaGFuZGxlX2RhbWFnZShzdHJ1Y3QgdWRsX2ZyYW1lYnVmZmVyICpmYiwgaW50IHgs
IGludCB5LAogCXggPSBhbGlnbmVkX3g7CiAKIAlpZiAoKHdpZHRoIDw9IDApIHx8Ci0JICAgICh4
ICsgd2lkdGggPiBmYi0+YmFzZS53aWR0aCkgfHwKLQkgICAgKHkgKyBoZWlnaHQgPiBmYi0+YmFz
ZS5oZWlnaHQpKSB7CisJICAgICh4ICsgd2lkdGggPiBmYi0+d2lkdGgpIHx8CisJICAgICh5ICsg
aGVpZ2h0ID4gZmItPmhlaWdodCkpIHsKIAkJcmV0ID0gLUVJTlZBTDsKIAkJZ290byBlcnJfZHJt
X2dlbV9zaG1lbV92dW5tYXA7CiAJfQpAQCAtMTEwLDkgKzExMiw5IEBAIGludCB1ZGxfaGFuZGxl
X2RhbWFnZShzdHJ1Y3QgdWRsX2ZyYW1lYnVmZmVyICpmYiwgaW50IHgsIGludCB5LAogCWNtZCA9
IHVyYi0+dHJhbnNmZXJfYnVmZmVyOwogCiAJZm9yIChpID0geTsgaSA8IHkgKyBoZWlnaHQgOyBp
KyspIHsKLQkJY29uc3QgaW50IGxpbmVfb2Zmc2V0ID0gZmItPmJhc2UucGl0Y2hlc1swXSAqIGk7
CisJCWNvbnN0IGludCBsaW5lX29mZnNldCA9IGZiLT5waXRjaGVzWzBdICogaTsKIAkJY29uc3Qg
aW50IGJ5dGVfb2Zmc2V0ID0gbGluZV9vZmZzZXQgKyAoeCA8PCBsb2dfYnBwKTsKLQkJY29uc3Qg
aW50IGRldl9ieXRlX29mZnNldCA9IChmYi0+YmFzZS53aWR0aCAqIGkgKyB4KSA8PCBsb2dfYnBw
OworCQljb25zdCBpbnQgZGV2X2J5dGVfb2Zmc2V0ID0gKGZiLT53aWR0aCAqIGkgKyB4KSA8PCBs
b2dfYnBwOwogCQlpZiAodWRsX3JlbmRlcl9obGluZShkZXYsIGxvZ19icHAsICZ1cmIsIChjaGFy
ICopdmFkZHIsCiAJCQkJICAgICAmY21kLCBieXRlX29mZnNldCwgZGV2X2J5dGVfb2Zmc2V0LAog
CQkJCSAgICAgd2lkdGggPDwgbG9nX2JwcCwKQEAgLTE0MSwxMiArMTQzLDEyIEBAIGludCB1ZGxf
aGFuZGxlX2RhbWFnZShzdHJ1Y3QgdWRsX2ZyYW1lYnVmZmVyICpmYiwgaW50IHgsIGludCB5LAog
CQkgICAmdWRsLT5jcHVfa2N5Y2xlc191c2VkKTsKIAogb3V0OgotCWRybV9nZW1fc2htZW1fdnVu
bWFwKCZmYi0+c2htZW0tPmJhc2UsIHZhZGRyKTsKKwlkcm1fZ2VtX3NobWVtX3Z1bm1hcChmYi0+
b2JqWzBdLCB2YWRkcik7CiAKIAlyZXR1cm4gMDsKIAogZXJyX2RybV9nZW1fc2htZW1fdnVubWFw
OgotCWRybV9nZW1fc2htZW1fdnVubWFwKCZmYi0+c2htZW0tPmJhc2UsIHZhZGRyKTsKKwlkcm1f
Z2VtX3NobWVtX3Z1bm1hcChmYi0+b2JqWzBdLCB2YWRkcik7CiAJcmV0dXJuIHJldDsKIH0KIApA
QCAtMTU2LDcgKzE1OCw2IEBAIHN0YXRpYyBpbnQgdWRsX3VzZXJfZnJhbWVidWZmZXJfZGlydHko
c3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIsCiAJCQkJICAgICAgc3RydWN0IGRybV9jbGlwX3Jl
Y3QgKmNsaXBzLAogCQkJCSAgICAgIHVuc2lnbmVkIG51bV9jbGlwcykKIHsKLQlzdHJ1Y3QgdWRs
X2ZyYW1lYnVmZmVyICp1ZmIgPSB0b191ZGxfZmIoZmIpOwogCXN0cnVjdCB1ZGxfZGV2aWNlICp1
ZGwgPSBmYi0+ZGV2LT5kZXZfcHJpdmF0ZTsKIAlzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICpp
bXBvcnRfYXR0YWNoOwogCWludCBpOwpAQCAtMTcxLDcgKzE3Miw3IEBAIHN0YXRpYyBpbnQgdWRs
X3VzZXJfZnJhbWVidWZmZXJfZGlydHkoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIsCiAJfQog
CXNwaW5fdW5sb2NrKCZ1ZGwtPmFjdGl2ZV9mYl8xNl9sb2NrKTsKIAotCWltcG9ydF9hdHRhY2gg
PSB1ZmItPnNobWVtLT5iYXNlLmltcG9ydF9hdHRhY2g7CisJaW1wb3J0X2F0dGFjaCA9IGZiLT5v
YmpbMF0tPmltcG9ydF9hdHRhY2g7CiAKIAlpZiAoaW1wb3J0X2F0dGFjaCkgewogCQlyZXQgPSBk
bWFfYnVmX2JlZ2luX2NwdV9hY2Nlc3MoaW1wb3J0X2F0dGFjaC0+ZG1hYnVmLApAQCAtMTgxLDkg
KzE4Miw5IEBAIHN0YXRpYyBpbnQgdWRsX3VzZXJfZnJhbWVidWZmZXJfZGlydHkoc3RydWN0IGRy
bV9mcmFtZWJ1ZmZlciAqZmIsCiAJfQogCiAJZm9yIChpID0gMDsgaSA8IG51bV9jbGlwczsgaSsr
KSB7Ci0JCXJldCA9IHVkbF9oYW5kbGVfZGFtYWdlKHVmYiwgY2xpcHNbaV0ueDEsIGNsaXBzW2ld
LnkxLAotCQkJCSAgY2xpcHNbaV0ueDIgLSBjbGlwc1tpXS54MSwKLQkJCQkgIGNsaXBzW2ldLnky
IC0gY2xpcHNbaV0ueTEpOworCQlyZXQgPSB1ZGxfaGFuZGxlX2RhbWFnZShmYiwgY2xpcHNbaV0u
eDEsIGNsaXBzW2ldLnkxLAorCQkJCQljbGlwc1tpXS54MiAtIGNsaXBzW2ldLngxLAorCQkJCQlj
bGlwc1tpXS55MiAtIGNsaXBzW2ldLnkxKTsKIAkJaWYgKHJldCkKIAkJCWJyZWFrOwogCX0KZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX21vZGVzZXQuYyBiL2RyaXZlcnMvZ3B1
L2RybS91ZGwvdWRsX21vZGVzZXQuYwppbmRleCA0NGE3NDFmNDYzYzkuLjkxYWYyNWNhZWQ2NCAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfbW9kZXNldC5jCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS91ZGwvdWRsX21vZGVzZXQuYwpAQCAtMzAxLDcgKzMwMSw3IEBAIHN0YXRpYyBp
bnQgdWRsX2NydGNfbW9kZV9zZXQoc3RydWN0IGRybV9jcnRjICpjcnRjLAogCiB7CiAJc3RydWN0
IGRybV9kZXZpY2UgKmRldiA9IGNydGMtPmRldjsKLQlzdHJ1Y3QgdWRsX2ZyYW1lYnVmZmVyICp1
ZmIgPSB0b191ZGxfZmIoY3J0Yy0+cHJpbWFyeS0+ZmIpOworCXN0cnVjdCBkcm1fZnJhbWVidWZm
ZXIgKmZiID0gY3J0Yy0+cHJpbWFyeS0+ZmI7CiAJc3RydWN0IHVkbF9kZXZpY2UgKnVkbCA9IGRl
di0+ZGV2X3ByaXZhdGU7CiAJY2hhciAqYnVmOwogCWNoYXIgKndycHRyOwpAQCAtMzMzLDEyICsz
MzMsMTIgQEAgc3RhdGljIGludCB1ZGxfY3J0Y19tb2RlX3NldChzdHJ1Y3QgZHJtX2NydGMgKmNy
dGMsCiAJd3JwdHIgPSB1ZGxfZHVtbXlfcmVuZGVyKHdycHRyKTsKIAogCXNwaW5fbG9jaygmdWRs
LT5hY3RpdmVfZmJfMTZfbG9jayk7Ci0JdWRsLT5hY3RpdmVfZmJfMTYgPSAmdWZiLT5iYXNlOwor
CXVkbC0+YWN0aXZlX2ZiXzE2ID0gZmI7CiAJc3Bpbl91bmxvY2soJnVkbC0+YWN0aXZlX2ZiXzE2
X2xvY2spOwogCXVkbC0+bW9kZV9idWZfbGVuID0gd3JwdHIgLSBidWY7CiAKIAkvKiBkYW1hZ2Ug
YWxsIG9mIGl0ICovCi0JdWRsX2hhbmRsZV9kYW1hZ2UodWZiLCAwLCAwLCB1ZmItPmJhc2Uud2lk
dGgsIHVmYi0+YmFzZS5oZWlnaHQpOworCXVkbF9oYW5kbGVfZGFtYWdlKGZiLCAwLCAwLCBmYi0+
d2lkdGgsIGZiLT5oZWlnaHQpOwogCXJldHVybiAwOwogfQogCkBAIC0zNjAsNyArMzYwLDYgQEAg
c3RhdGljIGludCB1ZGxfY3J0Y19wYWdlX2ZsaXAoc3RydWN0IGRybV9jcnRjICpjcnRjLAogCQkJ
ICAgICAgdWludDMyX3QgcGFnZV9mbGlwX2ZsYWdzLAogCQkJICAgICAgc3RydWN0IGRybV9tb2Rl
c2V0X2FjcXVpcmVfY3R4ICpjdHgpCiB7Ci0Jc3RydWN0IHVkbF9mcmFtZWJ1ZmZlciAqdWZiID0g
dG9fdWRsX2ZiKGZiKTsKIAlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gY3J0Yy0+ZGV2OwogCXN0
cnVjdCB1ZGxfZGV2aWNlICp1ZGwgPSBkZXYtPmRldl9wcml2YXRlOwogCkBAIC0zNjgsNyArMzY3
LDcgQEAgc3RhdGljIGludCB1ZGxfY3J0Y19wYWdlX2ZsaXAoc3RydWN0IGRybV9jcnRjICpjcnRj
LAogCXVkbC0+YWN0aXZlX2ZiXzE2ID0gZmI7CiAJc3Bpbl91bmxvY2soJnVkbC0+YWN0aXZlX2Zi
XzE2X2xvY2spOwogCi0JdWRsX2hhbmRsZV9kYW1hZ2UodWZiLCAwLCAwLCBmYi0+d2lkdGgsIGZi
LT5oZWlnaHQpOworCXVkbF9oYW5kbGVfZGFtYWdlKGZiLCAwLCAwLCBmYi0+d2lkdGgsIGZiLT5o
ZWlnaHQpOwogCiAJc3Bpbl9sb2NrX2lycSgmZGV2LT5ldmVudF9sb2NrKTsKIAlpZiAoZXZlbnQp
CkBAIC00NDgsMTMgKzQ0NywxMyBAQCBpbnQgdWRsX21vZGVzZXRfaW5pdChzdHJ1Y3QgZHJtX2Rl
dmljZSAqZGV2KQogdm9pZCB1ZGxfbW9kZXNldF9yZXN0b3JlKHN0cnVjdCBkcm1fZGV2aWNlICpk
ZXYpCiB7CiAJc3RydWN0IHVkbF9kZXZpY2UgKnVkbCA9IGRldi0+ZGV2X3ByaXZhdGU7Ci0Jc3Ry
dWN0IHVkbF9mcmFtZWJ1ZmZlciAqdWZiOworCXN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiOwog
CiAJaWYgKCF1ZGwtPmNydGMgfHwgIXVkbC0+Y3J0Yy0+cHJpbWFyeS0+ZmIpCiAJCXJldHVybjsK
IAl1ZGxfY3J0Y19jb21taXQodWRsLT5jcnRjKTsKLQl1ZmIgPSB0b191ZGxfZmIodWRsLT5jcnRj
LT5wcmltYXJ5LT5mYik7Ci0JdWRsX2hhbmRsZV9kYW1hZ2UodWZiLCAwLCAwLCB1ZmItPmJhc2Uu
d2lkdGgsIHVmYi0+YmFzZS5oZWlnaHQpOworCWZiID0gdWRsLT5jcnRjLT5wcmltYXJ5LT5mYjsK
Kwl1ZGxfaGFuZGxlX2RhbWFnZShmYiwgMCwgMCwgZmItPndpZHRoLCBmYi0+aGVpZ2h0KTsKIH0K
IAogdm9pZCB1ZGxfbW9kZXNldF9jbGVhbnVwKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpCi0tIAoy
LjIzLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRy
aS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRw
czovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
