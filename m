Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id AC7B3D898B
	for <lists+dri-devel@lfdr.de>; Wed, 16 Oct 2019 09:34:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 61A576E8DD;
	Wed, 16 Oct 2019 07:33:48 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-io1-xd43.google.com (mail-io1-xd43.google.com
 [IPv6:2607:f8b0:4864:20::d43])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A79536E87E
 for <dri-devel@lists.freedesktop.org>; Tue, 15 Oct 2019 18:16:21 +0000 (UTC)
Received: by mail-io1-xd43.google.com with SMTP id z19so48301674ior.0
 for <dri-devel@lists.freedesktop.org>; Tue, 15 Oct 2019 11:16:21 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=7bGBHV3XKTBYtn+s2VkOV5vFHFWD1VRFqgigxd7ES8s=;
 b=tRHaZKJKwbL0DKW+fhrkFX5+bhjcraIAYZLRphP91cz9BnI8UhIo1VnWpQwHEbfSGH
 32fOiKzT6/z1Lcq/QEcH++FwpgDB88LI+O+dXE9owOhkygckc3clsrX/HiuM6Y10xUHh
 odYRhCNXt/jQ6LCvZfoyUgQ69QOgoN3+2Jvowjea5629TOIXMRCWkP8xH/+d6aFtWFe6
 pd9L6VFuVrb/8q0fxPCqdejGpIUkA+e6ODRBZcdY0jdRe9F1FtPfwo3+0ik7KXs0e1s7
 aQtPeKKLTscNqzNCbaYPj7t1axLTIxSfO/1I2NVyZ88BevZnkhzgbkeDHKT1PVhyA9qO
 B23w==
X-Gm-Message-State: APjAAAUEPmEfLFmqmf2z4TRzORuxotc9GHMMRJ0Ch6ipllpsnpcGD/DC
 p13s997XSkQ3D8tPNb/FAF0E9A==
X-Google-Smtp-Source: APXvYqzXNjh0fKDKQEyiiqzBWh49cM4XsjfhBudT5whPmb8Cc0287ba+L/26Gqkm2bQl2N5jfKT/5w==
X-Received: by 2002:a05:6e02:783:: with SMTP id
 q3mr7197819ils.33.1571163380758; 
 Tue, 15 Oct 2019 11:16:20 -0700 (PDT)
Received: from ziepe.ca ([24.114.26.129])
 by smtp.gmail.com with ESMTPSA id r5sm2178117ill.12.2019.10.15.11.16.20
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Tue, 15 Oct 2019 11:16:20 -0700 (PDT)
Received: from jgg by jggl.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1iKRJT-0002Ca-M8; Tue, 15 Oct 2019 15:12:51 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH hmm 11/15] nouveau: use mmu_range_notifier instead of
 hmm_mirror
Date: Tue, 15 Oct 2019 15:12:38 -0300
Message-Id: <20191015181242.8343-12-jgg@ziepe.ca>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191015181242.8343-1-jgg@ziepe.ca>
References: <20191015181242.8343-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Wed, 16 Oct 2019 07:33:45 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=7bGBHV3XKTBYtn+s2VkOV5vFHFWD1VRFqgigxd7ES8s=;
 b=SZTuPs+9wtwF5qdo+T04vL15d88nht4jzLRt2KERwlIlmEXkDIWhnd1ZVIaUcbfUHB
 3lvX6T61iauTPcUGyedFFKgzQKx0qM38ovl5TsQiW8W9MlH3WDIMXXxhwPZA16J+FlJo
 WOMlNrj+nWtDbfr2oeHLqKkqb9xCx0UH8UPZ8bMwWH9gjlfWyysteaZ05Dwrq+hI0Pj4
 1AWgVI9R2WygWt6WGwALuiMdjbs0zn4/tZ+07Y+GvD+YCexEuaNFKnkovhprSZwmdMpJ
 ndfHvsy43KtDTBSWgQzQDBvwJEzLL1K+mBJJ4RmV5O3OucQZuKa1aj5T3C9OZDphUkNa
 QxDg==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, linux-rdma@vger.kernel.org,
 nouveau@lists.freedesktop.org, amd-gfx@lists.freedesktop.org,
 linux-mm@kvack.org, Jason Gunthorpe <jgg@mellanox.com>,
 dri-devel@lists.freedesktop.org, Ben Skeggs <bskeggs@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKUmVtb3ZlIHRoZSBobW1f
bWlycm9yIG9iamVjdCBhbmQgdXNlIHRoZSBtbXVfcmFuZ2Vfbm90aWZpZXIgQVBJIGluc3RlYWQK
Zm9yIHRoZSByYW5nZSwgYW5kIHVzZSB0aGUgbm9ybWFsIG1tdV9ub3RpZmllciBBUEkgZm9yIHRo
ZSBnZW5lcmFsCmludmFsaWRhdGlvbiBjYWxsYmFjay4KCldoaWxlIGhlcmUgcmUtb3JnYW5pemUg
dGhlIHBhZ2VmYXVsdCBwYXRoIHNvIHRoZSBsb2NraW5nIHBhdHRlcm4gaXMgY2xlYXIuCgpub3V2
ZWF1IGlzIHRoZSBvbmx5IGRyaXZlciB0aGF0IHVzZXMgYSB0ZW1wb3JhcnkgcmFuZ2Ugb2JqZWN0
IGFuZCBpbnN0ZWFkCmZvcndhcmRzIG5lYXJseSBldmVyeSBpbnZhbGlkYXRpb24gcmFuZ2UgZGly
ZWN0bHkgdG8gdGhlIEhXLiBXaGlsZSB0aGlzIGlzCm5vdCBob3cgdGhlIG1tdV9yYW5nZV9ub3Rp
ZmllciB3YXMgaW50ZW5kZWQgdG8gYmUgdXNlZCwgdGhlIG92ZXJoZWFkcyBvbgp0aGUgcGFnZWZh
dWx0aW5nIHBhdGggYXJlIHNpbWlsYXIgdG8gdGhlIGV4aXN0aW5nIGhtbV9taXJyb3IgdmVyc2lv
bi4KUGFydGljdWxhcmx5IHNpbmNlIHRoZSBpbnRlcnZhbCB0cmVlIHdpbGwgYmUgc21hbGwuCgpD
YzogQmVuIFNrZWdncyA8YnNrZWdnc0ByZWRoYXQuY29tPgpDYzogZHJpLWRldmVsQGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpDYzogbm91dmVhdUBsaXN0cy5mcmVlZGVza3RvcC5vcmcKQ2M6IFJhbHBo
IENhbXBiZWxsIDxyY2FtcGJlbGxAbnZpZGlhLmNvbT4KU2lnbmVkLW9mZi1ieTogSmFzb24gR3Vu
dGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25v
dXZlYXVfc3ZtLmMgfCAxNzggKysrKysrKysrKysrKystLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFu
Z2VkLCA5OCBpbnNlcnRpb25zKCspLCA4MCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2
ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X3N2bS5jIGIvZHJpdmVycy9ncHUvZHJtL25vdXZl
YXUvbm91dmVhdV9zdm0uYwppbmRleCA1NzdmODgxMTkyNWE1OS4uNzEyYzk5OTE4NTUxYmMgMTAw
NjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25vdXZlYXVfc3ZtLmMKKysrIGIvZHJp
dmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVhdV9zdm0uYwpAQCAtOTYsOCArOTYsNiBAQCBzdHJ1
Y3Qgbm91dmVhdV9zdm1tIHsKIAl9IHVubWFuYWdlZDsKIAogCXN0cnVjdCBtdXRleCBtdXRleDsK
LQotCXN0cnVjdCBobW1fbWlycm9yIG1pcnJvcjsKIH07CiAKICNkZWZpbmUgU1ZNTV9EQkcocyxm
LGEuLi4pICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBcCkBAIC0yOTMsMjMgKzI5MSwxMSBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IG1tdV9ub3RpZmll
cl9vcHMgbm91dmVhdV9tbl9vcHMgPSB7CiAJLmZyZWVfbm90aWZpZXIgPSBub3V2ZWF1X3N2bW1f
ZnJlZV9ub3RpZmllciwKIH07CiAKLXN0YXRpYyBpbnQKLW5vdXZlYXVfc3ZtbV9zeW5jX2NwdV9k
ZXZpY2VfcGFnZXRhYmxlcyhzdHJ1Y3QgaG1tX21pcnJvciAqbWlycm9yLAotCQkJCQljb25zdCBz
dHJ1Y3QgbW11X25vdGlmaWVyX3JhbmdlICp1cGRhdGUpCi17Ci0JcmV0dXJuIDA7Ci19Ci0KLXN0
YXRpYyBjb25zdCBzdHJ1Y3QgaG1tX21pcnJvcl9vcHMgbm91dmVhdV9zdm1tID0gewotCS5zeW5j
X2NwdV9kZXZpY2VfcGFnZXRhYmxlcyA9IG5vdXZlYXVfc3ZtbV9zeW5jX2NwdV9kZXZpY2VfcGFn
ZXRhYmxlcywKLX07Ci0KIHZvaWQKIG5vdXZlYXVfc3ZtbV9maW5pKHN0cnVjdCBub3V2ZWF1X3N2
bW0gKipwc3ZtbSkKIHsKIAlzdHJ1Y3Qgbm91dmVhdV9zdm1tICpzdm1tID0gKnBzdm1tOwogCWlm
IChzdm1tKSB7Ci0JCWhtbV9taXJyb3JfdW5yZWdpc3Rlcigmc3ZtbS0+bWlycm9yKTsKIAkJbXV0
ZXhfbG9jaygmc3ZtbS0+bXV0ZXgpOwogCQlzdm1tLT52bW0gPSBOVUxMOwogCQltdXRleF91bmxv
Y2soJnN2bW0tPm11dGV4KTsKQEAgLTM1NywxNSArMzQzLDEwIEBAIG5vdXZlYXVfc3ZtbV9pbml0
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAJCWdvdG8gb3V0X2ZyZWU7CiAK
IAlkb3duX3dyaXRlKCZjdXJyZW50LT5tbS0+bW1hcF9zZW0pOwotCXN2bW0tPm1pcnJvci5vcHMg
PSAmbm91dmVhdV9zdm1tOwotCXJldCA9IGhtbV9taXJyb3JfcmVnaXN0ZXIoJnN2bW0tPm1pcnJv
ciwgY3VycmVudC0+bW0pOwotCWlmIChyZXQpCi0JCWdvdG8gb3V0X21tX3VubG9jazsKLQogCXN2
bW0tPm5vdGlmaWVyLm9wcyA9ICZub3V2ZWF1X21uX29wczsKIAlyZXQgPSBfX21tdV9ub3RpZmll
cl9yZWdpc3Rlcigmc3ZtbS0+bm90aWZpZXIsIGN1cnJlbnQtPm1tKTsKIAlpZiAocmV0KQotCQln
b3RvIG91dF9obW1fdW5yZWdpc3RlcjsKKwkJZ290byBvdXRfbW1fdW5sb2NrOwogCS8qIE5vdGUs
IG93bmVyc2hpcCBvZiBzdm1tIHRyYW5zZmVycyB0byBtbXVfbm90aWZpZXIgKi8KIAogCWNsaS0+
c3ZtLnN2bW0gPSBzdm1tOwpAQCAtMzc0LDggKzM1NSw2IEBAIG5vdXZlYXVfc3ZtbV9pbml0KHN0
cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAJbXV0ZXhfdW5sb2NrKCZjbGktPm11
dGV4KTsKIAlyZXR1cm4gMDsKIAotb3V0X2htbV91bnJlZ2lzdGVyOgotCWhtbV9taXJyb3JfdW5y
ZWdpc3Rlcigmc3ZtbS0+bWlycm9yKTsKIG91dF9tbV91bmxvY2s6CiAJdXBfd3JpdGUoJmN1cnJl
bnQtPm1tLT5tbWFwX3NlbSk7CiBvdXRfZnJlZToKQEAgLTUwMyw0MyArNDgyLDg5IEBAIG5vdXZl
YXVfc3ZtX2ZhdWx0X2NhY2hlKHN0cnVjdCBub3V2ZWF1X3N2bSAqc3ZtLAogCQlmYXVsdC0+aW5z
dCwgZmF1bHQtPmFkZHIsIGZhdWx0LT5hY2Nlc3MpOwogfQogCi1zdGF0aWMgaW5saW5lIGJvb2wK
LW5vdXZlYXVfcmFuZ2VfZG9uZShzdHJ1Y3QgaG1tX3JhbmdlICpyYW5nZSkKK3N0cnVjdCBzdm1f
bm90aWZpZXIgeworCXN0cnVjdCBtbXVfcmFuZ2Vfbm90aWZpZXIgbm90aWZpZXI7CisJc3RydWN0
IG5vdXZlYXVfc3ZtbSAqc3ZtbTsKK307CisKK3N0YXRpYyBib29sIG5vdXZlYXVfc3ZtX3Jhbmdl
X2ludmFsaWRhdGUoc3RydWN0IG1tdV9yYW5nZV9ub3RpZmllciAqbXJuLAorCQkJCQkgY29uc3Qg
c3RydWN0IG1tdV9ub3RpZmllcl9yYW5nZSAqcmFuZ2UpCiB7Ci0JYm9vbCByZXQgPSBobW1fcmFu
Z2VfdmFsaWQocmFuZ2UpOworCXN0cnVjdCBzdm1fbm90aWZpZXIgKnNuID0KKwkJY29udGFpbmVy
X29mKG1ybiwgc3RydWN0IHN2bV9ub3RpZmllciwgbm90aWZpZXIpOwogCi0JaG1tX3JhbmdlX3Vu
cmVnaXN0ZXIocmFuZ2UpOwotCXJldHVybiByZXQ7CisJLyoKKwkgKiBzZXJpYWxpemVzIHRoZSB1
cGRhdGUgdG8gbXJuLT5pbnZhbGlkYXRlX3NlcSBkb25lIGJ5IGNhbGxlciBhbmQKKwkgKiBwcmV2
ZW50cyBpbnZhbGlkYXRpb24gb2YgdGhlIFBURSBmcm9tIHByb2dyZXNzaW5nIHdoaWxlIEhXIGlz
IGJlaW5nCisJICogcHJvZ3JhbW1lZC4gVGhpcyBpcyB2ZXJ5IGhhY2t5IGFuZCBvbmx5IHdvcmtz
IGJlY2F1c2UgdGhlIG5vcm1hbAorCSAqIG5vdGlmaWVyIHRoYXQgZG9lcyBpbnZhbGlkYXRpb24g
aXMgYWx3YXlzIGNhbGxlZCBhZnRlciB0aGUgcmFuZ2UKKwkgKiBub3RpZmllci4KKwkgKi8KKwlp
ZiAobW11X25vdGlmaWVyX3JhbmdlX2Jsb2NrYWJsZShyYW5nZSkpCisJCW11dGV4X2xvY2soJnNu
LT5zdm1tLT5tdXRleCk7CisJZWxzZSBpZiAoIW11dGV4X3RyeWxvY2soJnNuLT5zdm1tLT5tdXRl
eCkpCisJCXJldHVybiBmYWxzZTsKKwltdXRleF91bmxvY2soJnNuLT5zdm1tLT5tdXRleCk7CisJ
cmV0dXJuIHRydWU7CiB9CiAKLXN0YXRpYyBpbnQKLW5vdXZlYXVfcmFuZ2VfZmF1bHQoc3RydWN0
IG5vdXZlYXVfc3ZtbSAqc3ZtbSwgc3RydWN0IGhtbV9yYW5nZSAqcmFuZ2UpCitzdGF0aWMgY29u
c3Qgc3RydWN0IG1tdV9yYW5nZV9ub3RpZmllcl9vcHMgbm91dmVhdV9zdm1fbXJuX29wcyA9IHsK
KwkuaW52YWxpZGF0ZSA9IG5vdXZlYXVfc3ZtX3JhbmdlX2ludmFsaWRhdGUsCit9OworCitzdGF0
aWMgaW50IG5vdXZlYXVfcmFuZ2VfZmF1bHQoc3RydWN0IG5vdXZlYXVfc3ZtbSAqc3ZtbSwKKwkJ
CSAgICAgICBzdHJ1Y3Qgbm91dmVhdV9kcm0gKmRybSwgdm9pZCAqZGF0YSwgdTMyIHNpemUsCisJ
CQkgICAgICAgdTY0ICpwZm5zLAorCQkJICAgICAgIHN0cnVjdCBzdm1fbm90aWZpZXIgKm5vdGlm
aWVyKQogeworCXVuc2lnbmVkIGxvbmcgdGltZW91dCA9CisJCWppZmZpZXMgKyBtc2Vjc190b19q
aWZmaWVzKEhNTV9SQU5HRV9ERUZBVUxUX1RJTUVPVVQpOworCS8qIEhhdmUgSE1NIGZhdWx0IHBh
Z2VzIHdpdGhpbiB0aGUgZmF1bHQgd2luZG93IHRvIHRoZSBHUFUuICovCisJc3RydWN0IGhtbV9y
YW5nZSByYW5nZSA9IHsKKwkJLm5vdGlmaWVyID0gJm5vdGlmaWVyLT5ub3RpZmllciwKKwkJLnN0
YXJ0ID0gbm90aWZpZXItPm5vdGlmaWVyLmludGVydmFsX3RyZWUuc3RhcnQsCisJCS5lbmQgPSBu
b3RpZmllci0+bm90aWZpZXIuaW50ZXJ2YWxfdHJlZS5sYXN0ICsgMSwKKwkJLnBmbnMgPSBwZm5z
LAorCQkuZmxhZ3MgPSBub3V2ZWF1X3N2bV9wZm5fZmxhZ3MsCisJCS52YWx1ZXMgPSBub3V2ZWF1
X3N2bV9wZm5fdmFsdWVzLAorCQkucGZuX3NoaWZ0ID0gTlZJRl9WTU1fUEZOTUFQX1YwX0FERFJf
U0hJRlQsCisJfTsKKwlzdHJ1Y3QgbW1fc3RydWN0ICptbSA9IG5vdGlmaWVyLT5ub3RpZmllci5t
bTsKIAlsb25nIHJldDsKIAotCXJhbmdlLT5kZWZhdWx0X2ZsYWdzID0gMDsKLQlyYW5nZS0+cGZu
X2ZsYWdzX21hc2sgPSAtMVVMOworCXdoaWxlICh0cnVlKSB7CisJCWlmICh0aW1lX2FmdGVyKGpp
ZmZpZXMsIHRpbWVvdXQpKQorCQkJcmV0dXJuIC1FQlVTWTsKIAotCXJldCA9IGhtbV9yYW5nZV9y
ZWdpc3RlcihyYW5nZSwgJnN2bW0tPm1pcnJvcik7Ci0JaWYgKHJldCkgewotCQl1cF9yZWFkKCZz
dm1tLT5ub3RpZmllci5tbS0+bW1hcF9zZW0pOwotCQlyZXR1cm4gKGludClyZXQ7Ci0JfQorCQly
YW5nZS5ub3RpZmllcl9zZXEgPSBtbXVfcmFuZ2VfcmVhZF9iZWdpbihyYW5nZS5ub3RpZmllcik7
CisJCXJhbmdlLmRlZmF1bHRfZmxhZ3MgPSAwOworCQlyYW5nZS5wZm5fZmxhZ3NfbWFzayA9IC0x
VUw7CisJCWRvd25fcmVhZCgmbW0tPm1tYXBfc2VtKTsKKwkJcmV0ID0gaG1tX3JhbmdlX2ZhdWx0
KCZyYW5nZSwgMCk7CisJCXVwX3JlYWQoJm1tLT5tbWFwX3NlbSk7CisJCWlmIChyZXQgPD0gMCkg
eworCQkJaWYgKHJldCA9PSAwIHx8IHJldCA9PSAtRUJVU1kpCisJCQkJY29udGludWU7CisJCQly
ZXR1cm4gcmV0OworCQl9CiAKLQlpZiAoIWhtbV9yYW5nZV93YWl0X3VudGlsX3ZhbGlkKHJhbmdl
LCBITU1fUkFOR0VfREVGQVVMVF9USU1FT1VUKSkgewotCQl1cF9yZWFkKCZzdm1tLT5ub3RpZmll
ci5tbS0+bW1hcF9zZW0pOwotCQlyZXR1cm4gLUVCVVNZOworCQltdXRleF9sb2NrKCZzdm1tLT5t
dXRleCk7CisJCWlmIChtbXVfcmFuZ2VfcmVhZF9yZXRyeShyYW5nZS5ub3RpZmllciwKKwkJCQkJ
IHJhbmdlLm5vdGlmaWVyX3NlcSkpIHsKKwkJCW11dGV4X3VubG9jaygmc3ZtbS0+bXV0ZXgpOwor
CQkJY29udGludWU7CisJCX0KKwkJYnJlYWs7CiAJfQogCi0JcmV0ID0gaG1tX3JhbmdlX2ZhdWx0
KHJhbmdlLCAwKTsKLQlpZiAocmV0IDw9IDApIHsKLQkJaWYgKHJldCA9PSAwKQotCQkJcmV0ID0g
LUVCVVNZOwotCQl1cF9yZWFkKCZzdm1tLT5ub3RpZmllci5tbS0+bW1hcF9zZW0pOwotCQlobW1f
cmFuZ2VfdW5yZWdpc3RlcihyYW5nZSk7Ci0JCXJldHVybiByZXQ7Ci0JfQotCXJldHVybiAwOwor
CW5vdXZlYXVfZG1lbV9jb252ZXJ0X3Bmbihkcm0sICZyYW5nZSk7CisKKwlzdm1tLT52bW0tPnZt
bS5vYmplY3QuY2xpZW50LT5zdXBlciA9IHRydWU7CisJcmV0ID0gbnZpZl9vYmplY3RfaW9jdGwo
JnN2bW0tPnZtbS0+dm1tLm9iamVjdCwgZGF0YSwgc2l6ZSwgTlVMTCk7CisJc3ZtbS0+dm1tLT52
bW0ub2JqZWN0LmNsaWVudC0+c3VwZXIgPSBmYWxzZTsKKwltdXRleF91bmxvY2soJnN2bW0tPm11
dGV4KTsKKworCXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyBpbnQKQEAgLTU1OSw3ICs1ODQsNiBA
QCBub3V2ZWF1X3N2bV9mYXVsdChzdHJ1Y3QgbnZpZl9ub3RpZnkgKm5vdGlmeSkKIAkJfSBpOwog
CQl1NjQgcGh5c1sxNl07CiAJfSBhcmdzOwotCXN0cnVjdCBobW1fcmFuZ2UgcmFuZ2U7CiAJc3Ry
dWN0IHZtX2FyZWFfc3RydWN0ICp2bWE7CiAJdTY0IGluc3QsIHN0YXJ0LCBsaW1pdDsKIAlpbnQg
ZmksIGZuLCBwaSwgZmlsbDsKQEAgLTYxNSw2ICs2MzksNyBAQCBub3V2ZWF1X3N2bV9mYXVsdChz
dHJ1Y3QgbnZpZl9ub3RpZnkgKm5vdGlmeSkKIAlhcmdzLmkucC52ZXJzaW9uID0gMDsKIAogCWZv
ciAoZmkgPSAwOyBmbiA9IGZpICsgMSwgZmkgPCBidWZmZXItPmZhdWx0X25yOyBmaSA9IGZuKSB7
CisJCXN0cnVjdCBzdm1fbm90aWZpZXIgbm90aWZpZXI7CiAJCXN0cnVjdCBtbV9zdHJ1Y3QgKm1t
OwogCiAJCS8qIENhbmNlbCBhbnkgZmF1bHRzIGZyb20gbm9uLVNWTSBjaGFubmVscy4gKi8KQEAg
LTYyMyw3ICs2NDgsNiBAQCBub3V2ZWF1X3N2bV9mYXVsdChzdHJ1Y3QgbnZpZl9ub3RpZnkgKm5v
dGlmeSkKIAkJCWNvbnRpbnVlOwogCQl9CiAJCVNWTU1fREJHKHN2bW0sICJhZGRyICUwMTZsbHgi
LCBidWZmZXItPmZhdWx0W2ZpXS0+YWRkcik7Ci0JCW1tID0gc3ZtbS0+bm90aWZpZXIubW07CiAK
IAkJLyogV2UgdHJ5IGFuZCBncm91cCBoYW5kbGluZyBvZiBmYXVsdHMgd2l0aGluIGEgc21hbGwK
IAkJICogd2luZG93IGludG8gYSBzaW5nbGUgdXBkYXRlLgpAQCAtNjM3LDYgKzY2MSwxMiBAQCBu
b3V2ZWF1X3N2bV9mYXVsdChzdHJ1Y3QgbnZpZl9ub3RpZnkgKm5vdGlmeSkKIAkJCXN0YXJ0ID0g
bWF4X3QodTY0LCBzdGFydCwgc3ZtbS0+dW5tYW5hZ2VkLmxpbWl0KTsKIAkJU1ZNTV9EQkcoc3Zt
bSwgInduZHcgJTAxNmxseC0lMDE2bGx4Iiwgc3RhcnQsIGxpbWl0KTsKIAorCQltbSA9IHN2bW0t
Pm5vdGlmaWVyLm1tOworCQlpZiAoIW1tZ2V0X25vdF96ZXJvKG1tKSkgeworCQkJbm91dmVhdV9z
dm1fZmF1bHRfY2FuY2VsX2ZhdWx0KHN2bSwgYnVmZmVyLT5mYXVsdFtmaV0pOworCQkJY29udGlu
dWU7CisJCX0KKwogCQkvKiBJbnRlcnNlY3QgZmF1bHQgd2luZG93IHdpdGggdGhlIENQVSBWTUEs
IGNhbmNlbGxpbmcKIAkJICogdGhlIGZhdWx0IGlmIHRoZSBhZGRyZXNzIGlzIGludmFsaWQuCiAJ
CSAqLwpAQCAtNjQ1LDE2ICs2NzUsMTggQEAgbm91dmVhdV9zdm1fZmF1bHQoc3RydWN0IG52aWZf
bm90aWZ5ICpub3RpZnkpCiAJCWlmICghdm1hKSB7CiAJCQlTVk1NX0VSUihzdm1tLCAid25kdyAl
MDE2bGx4LSUwMTZsbHgiLCBzdGFydCwgbGltaXQpOwogCQkJdXBfcmVhZCgmbW0tPm1tYXBfc2Vt
KTsKKwkJCW1tcHV0KG1tKTsKIAkJCW5vdXZlYXVfc3ZtX2ZhdWx0X2NhbmNlbF9mYXVsdChzdm0s
IGJ1ZmZlci0+ZmF1bHRbZmldKTsKIAkJCWNvbnRpbnVlOwogCQl9CiAJCXN0YXJ0ID0gbWF4X3Qo
dTY0LCBzdGFydCwgdm1hLT52bV9zdGFydCk7CiAJCWxpbWl0ID0gbWluX3QodTY0LCBsaW1pdCwg
dm1hLT52bV9lbmQpOworCQl1cF9yZWFkKCZtbS0+bW1hcF9zZW0pOwogCQlTVk1NX0RCRyhzdm1t
LCAid25kdyAlMDE2bGx4LSUwMTZsbHgiLCBzdGFydCwgbGltaXQpOwogCiAJCWlmIChidWZmZXIt
PmZhdWx0W2ZpXS0+YWRkciAhPSBzdGFydCkgewogCQkJU1ZNTV9FUlIoc3ZtbSwgImFkZHIgJTAx
NmxseCIsIGJ1ZmZlci0+ZmF1bHRbZmldLT5hZGRyKTsKLQkJCXVwX3JlYWQoJm1tLT5tbWFwX3Nl
bSk7CisJCQltbXB1dChtbSk7CiAJCQlub3V2ZWF1X3N2bV9mYXVsdF9jYW5jZWxfZmF1bHQoc3Zt
LCBidWZmZXItPmZhdWx0W2ZpXSk7CiAJCQljb250aW51ZTsKIAkJfQpAQCAtNzEwLDMzICs3NDIs
MTkgQEAgbm91dmVhdV9zdm1fZmF1bHQoc3RydWN0IG52aWZfbm90aWZ5ICpub3RpZnkpCiAJCQkg
YXJncy5pLnAuYWRkciwKIAkJCSBhcmdzLmkucC5hZGRyICsgYXJncy5pLnAuc2l6ZSwgZm4gLSBm
aSk7CiAKLQkJLyogSGF2ZSBITU0gZmF1bHQgcGFnZXMgd2l0aGluIHRoZSBmYXVsdCB3aW5kb3cg
dG8gdGhlIEdQVS4gKi8KLQkJcmFuZ2Uuc3RhcnQgPSBhcmdzLmkucC5hZGRyOwotCQlyYW5nZS5l
bmQgPSBhcmdzLmkucC5hZGRyICsgYXJncy5pLnAuc2l6ZTsKLQkJcmFuZ2UucGZucyA9IGFyZ3Mu
cGh5czsKLQkJcmFuZ2UuZmxhZ3MgPSBub3V2ZWF1X3N2bV9wZm5fZmxhZ3M7Ci0JCXJhbmdlLnZh
bHVlcyA9IG5vdXZlYXVfc3ZtX3Bmbl92YWx1ZXM7Ci0JCXJhbmdlLnBmbl9zaGlmdCA9IE5WSUZf
Vk1NX1BGTk1BUF9WMF9BRERSX1NISUZUOwotYWdhaW46Ci0JCXJldCA9IG5vdXZlYXVfcmFuZ2Vf
ZmF1bHQoc3ZtbSwgJnJhbmdlKTsKLQkJaWYgKHJldCA9PSAwKSB7Ci0JCQltdXRleF9sb2NrKCZz
dm1tLT5tdXRleCk7Ci0JCQlpZiAoIW5vdXZlYXVfcmFuZ2VfZG9uZSgmcmFuZ2UpKSB7Ci0JCQkJ
bXV0ZXhfdW5sb2NrKCZzdm1tLT5tdXRleCk7Ci0JCQkJZ290byBhZ2FpbjsKLQkJCX0KLQotCQkJ
bm91dmVhdV9kbWVtX2NvbnZlcnRfcGZuKHN2bS0+ZHJtLCAmcmFuZ2UpOwotCi0JCQlzdm1tLT52
bW0tPnZtbS5vYmplY3QuY2xpZW50LT5zdXBlciA9IHRydWU7Ci0JCQlyZXQgPSBudmlmX29iamVj
dF9pb2N0bCgmc3ZtbS0+dm1tLT52bW0ub2JqZWN0LAotCQkJCQkJJmFyZ3MsIHNpemVvZihhcmdz
LmkpICsKLQkJCQkJCXBpICogc2l6ZW9mKGFyZ3MucGh5c1swXSksCi0JCQkJCQlOVUxMKTsKLQkJ
CXN2bW0tPnZtbS0+dm1tLm9iamVjdC5jbGllbnQtPnN1cGVyID0gZmFsc2U7Ci0JCQltdXRleF91
bmxvY2soJnN2bW0tPm11dGV4KTsKLQkJCXVwX3JlYWQoJm1tLT5tbWFwX3NlbSk7CisJCW5vdGlm
aWVyLnN2bW0gPSBzdm1tOworCQlub3RpZmllci5ub3RpZmllci5vcHMgPSAmbm91dmVhdV9zdm1f
bXJuX29wczsKKwkJcmV0ID0gbW11X3JhbmdlX25vdGlmaWVyX2luc2VydCgmbm90aWZpZXIubm90
aWZpZXIsCisJCQkJCQlhcmdzLmkucC5hZGRyLCBhcmdzLmkucC5zaXplLAorCQkJCQkJc3ZtbS0+
bm90aWZpZXIubW0pOworCQlpZiAoIXJldCkgeworCQkJcmV0ID0gbm91dmVhdV9yYW5nZV9mYXVs
dCgKKwkJCQlzdm1tLCBzdm0tPmRybSwgJmFyZ3MsCisJCQkJc2l6ZW9mKGFyZ3MuaSkgKyBwaSAq
IHNpemVvZihhcmdzLnBoeXNbMF0pLAorCQkJCWFyZ3MucGh5cywgJm5vdGlmaWVyKTsKKwkJCW1t
dV9yYW5nZV9ub3RpZmllcl9yZW1vdmUoJm5vdGlmaWVyLm5vdGlmaWVyKTsKIAkJfQorCQltbXB1
dChtbSk7CiAKIAkJLyogQ2FuY2VsIGFueSBmYXVsdHMgaW4gdGhlIHdpbmRvdyB3aG9zZSBwYWdl
cyBkaWRuJ3QgbWFuYWdlCiAJCSAqIHRvIGtlZXAgdGhlaXIgdmFsaWQgYml0LCBvciBzdGF5IHdy
aXRlYWJsZSB3aGVuIHJlcXVpcmVkLgpAQCAtNzQ1LDEwICs3NjMsMTAgQEAgbm91dmVhdV9zdm1f
ZmF1bHQoc3RydWN0IG52aWZfbm90aWZ5ICpub3RpZnkpCiAJCSAqLwogCQl3aGlsZSAoZmkgPCBm
bikgewogCQkJc3RydWN0IG5vdXZlYXVfc3ZtX2ZhdWx0ICpmYXVsdCA9IGJ1ZmZlci0+ZmF1bHRb
ZmkrK107Ci0JCQlwaSA9IChmYXVsdC0+YWRkciAtIHJhbmdlLnN0YXJ0KSA+PiBQQUdFX1NISUZU
OworCQkJcGkgPSAoZmF1bHQtPmFkZHIgLSBhcmdzLmkucC5hZGRyKSA+PiBQQUdFX1NISUZUOwog
CQkJaWYgKHJldCB8fAotCQkJICAgICAhKHJhbmdlLnBmbnNbcGldICYgTlZJRl9WTU1fUEZOTUFQ
X1YwX1YpIHx8Ci0JCQkgICAgKCEocmFuZ2UucGZuc1twaV0gJiBOVklGX1ZNTV9QRk5NQVBfVjBf
VykgJiYKKwkJCSAgICAgIShhcmdzLnBoeXNbcGldICYgTlZJRl9WTU1fUEZOTUFQX1YwX1YpIHx8
CisJCQkgICAgKCEoYXJncy5waHlzW3BpXSAmIE5WSUZfVk1NX1BGTk1BUF9WMF9XKSAmJgogCQkJ
ICAgICBmYXVsdC0+YWNjZXNzICE9IDAgJiYgZmF1bHQtPmFjY2VzcyAhPSAzKSkgewogCQkJCW5v
dXZlYXVfc3ZtX2ZhdWx0X2NhbmNlbF9mYXVsdChzdm0sIGZhdWx0KTsKIAkJCQljb250aW51ZTsK
LS0gCjIuMjMuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3Jn
Cmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
