Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 2788F322929
	for <lists+dri-devel@lfdr.de>; Tue, 23 Feb 2021 12:00:14 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A5EAB6E979;
	Tue, 23 Feb 2021 11:00:04 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x42a.google.com (mail-wr1-x42a.google.com
 [IPv6:2a00:1450:4864:20::42a])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 0DBD66E96F
 for <dri-devel@lists.freedesktop.org>; Tue, 23 Feb 2021 11:00:02 +0000 (UTC)
Received: by mail-wr1-x42a.google.com with SMTP id v15so22123215wrx.4
 for <dri-devel@lists.freedesktop.org>; Tue, 23 Feb 2021 03:00:01 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=ffwll.ch; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=jGpM7Z5VRozBvnjSuS3S3GParWPdexh1PlzmyDomlJg=;
 b=kMbMQt3gLyNBeSApgii9cE7Su+OXQoQy/yEqpOKsskxde8+PQeDpQHjXYAJ7Pu/ILV
 6q7NRsRUfVQTOoupWwUxUsiFwEavKqu+DtuXbSqvghHAzYToUwxahcbLdTjvizbuTZTT
 4DSd6E8ob0tCEibNpYBQl+W7n0rjAeSCwGjyk=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=jGpM7Z5VRozBvnjSuS3S3GParWPdexh1PlzmyDomlJg=;
 b=OvclUtwYO4+zt+U22z9YA031vAnVDz8dFiGrvZhmM2p6gwbIigaIYKvUCPj/raVMjU
 LNfxWno/GvS0KrKvnA50fUd7HvPhYQxFDycNkB1Riz35idWYOhSOXLI6feI5Dc/HI1+U
 qoIMn3/ejPsUSRm9Q3VhMxT/qYPf3MtlJw42C+sv9QvshUc2veP1AImMPAJYEwOWWykp
 MgPiKuEZk96Q8C7olwVNKwrhGgIjzSOZmuvzeN8LrBkk8dYlOH+vfgWEBzwpqHPcfQ44
 eURrvqUTSjdUSX50T1fwsjhICngcDltuoGASUwbYrFwCc8tFOXeREyRLhHn+vXH9RrT9
 gReg==
X-Gm-Message-State: AOAM530UWWmoCgVefFlcqYf7c7J0eezEj5I7e81vWgwDONwapT+NL1UX
 Nf8znI2NBMR74G6hZW4IyCbJ0X7QVJF79w==
X-Google-Smtp-Source: ABdhPJwvn8Txy8DbIyr5q1pMhfKFO/oU0tj3IvVToiAPJXMvyOScNCBsUMzzDX42Nk+CnxI6EUcoLQ==
X-Received: by 2002:a5d:4e0e:: with SMTP id p14mr25142667wrt.130.1614078000694; 
 Tue, 23 Feb 2021 03:00:00 -0800 (PST)
Received: from phenom.ffwll.local ([2a02:168:57f4:0:efd0:b9e5:5ae6:c2fa])
 by smtp.gmail.com with ESMTPSA id g9sm2196208wmq.25.2021.02.23.02.59.59
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 23 Feb 2021 03:00:00 -0800 (PST)
From: Daniel Vetter <daniel.vetter@ffwll.ch>
To: DRI Development <dri-devel@lists.freedesktop.org>
Subject: [PATCH 2/2] drm/vgem: use shmem helpers
Date: Tue, 23 Feb 2021 11:59:51 +0100
Message-Id: <20210223105951.912577-2-daniel.vetter@ffwll.ch>
X-Mailer: git-send-email 2.30.0
In-Reply-To: <20210223105951.912577-1-daniel.vetter@ffwll.ch>
References: <20210223105951.912577-1-daniel.vetter@ffwll.ch>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Daniel Vetter <daniel.vetter@ffwll.ch>,
 Intel Graphics Development <intel-gfx@lists.freedesktop.org>,
 =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>,
 Melissa Wen <melissa.srw@gmail.com>, Daniel Vetter <daniel.vetter@intel.com>,
 Chris Wilson <chris@chris-wilson.co.uk>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

QXNpZGUgZnJvbSBkZWxldGluZyBsb3RzIG9mIGNvZGUgdGhlIHJlYWwgbW90aXZhdGlvbiBoZXJl
IGlzIHRvIHN3aXRjaAp0aGUgbW1hcCBvdmVyIHRvIFZNX1BGTk1BUCwgdG8gYmUgbW9yZSBjb25z
aXN0ZW50IHdpdGggd2hhdCByZWFsIGdwdQpkcml2ZXJzIGRvLiBUaGV5J3JlIGFsbCBWTV9QRk5N
UCwgd2hpY2ggbWVhbnMgZ2V0X3VzZXJfcGFnZXMgZG9lc24ndAp3b3JrLCBhbmQgZXZlbiBpZiB5
b3UgdHJ5IGFuZCB0aGVyZSdzIGEgc3RydWN0IHBhZ2UgYmVoaW5kIHRoYXQsCnRvdWNoaW5nIGl0
IGFuZCBtdWNraW5nIGFyb3VuZCB3aXRoIGl0cyByZWZjb3VudCBjYW4gdXBzZXQgZHJpdmVycwpy
ZWFsIGJhZC4KCkNjOiBKb2huIFN0dWx0eiA8am9obi5zdHVsdHpAbGluYXJvLm9yZz4KQ2M6IFN1
bWl0IFNlbXdhbCA8c3VtaXQuc2Vtd2FsQGxpbmFyby5vcmc+CkNjOiAiQ2hyaXN0aWFuIEvDtm5p
ZyIgPGNocmlzdGlhbi5rb2VuaWdAYW1kLmNvbT4KU2lnbmVkLW9mZi1ieTogRGFuaWVsIFZldHRl
ciA8ZGFuaWVsLnZldHRlckBpbnRlbC5jb20+CkNjOiBNZWxpc3NhIFdlbiA8bWVsaXNzYS5zcndA
Z21haWwuY29tPgpDYzogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+Ci0t
LQogZHJpdmVycy9ncHUvZHJtL3ZnZW0vdmdlbV9kcnYuYyB8IDI4MCArLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDMgaW5zZXJ0aW9ucygrKSwgMjc3IGRl
bGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92Z2VtL3ZnZW1fZHJ2LmMg
Yi9kcml2ZXJzL2dwdS9kcm0vdmdlbS92Z2VtX2Rydi5jCmluZGV4IGEwZTc1ZjFkNWQwMS4uODhi
M2QxMjVhNjEwIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmdlbS92Z2VtX2Rydi5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS92Z2VtL3ZnZW1fZHJ2LmMKQEAgLTQwLDYgKzQwLDcgQEAKICNp
bmNsdWRlIDxkcm0vZHJtX2ZpbGUuaD4KICNpbmNsdWRlIDxkcm0vZHJtX2lvY3RsLmg+CiAjaW5j
bHVkZSA8ZHJtL2RybV9tYW5hZ2VkLmg+CisjaW5jbHVkZSA8ZHJtL2RybV9nZW1fc2htZW1faGVs
cGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9wcmltZS5oPgogCiAjaW5jbHVkZSAidmdlbV9kcnYu
aCIKQEAgLTUwLDI3ICs1MSwxMSBAQAogI2RlZmluZSBEUklWRVJfTUFKT1IJMQogI2RlZmluZSBE
UklWRVJfTUlOT1IJMAogCi1zdGF0aWMgY29uc3Qgc3RydWN0IGRybV9nZW1fb2JqZWN0X2Z1bmNz
IHZnZW1fZ2VtX29iamVjdF9mdW5jczsKLQogc3RhdGljIHN0cnVjdCB2Z2VtX2RldmljZSB7CiAJ
c3RydWN0IGRybV9kZXZpY2UgZHJtOwogCXN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBsYXRmb3Jt
OwogfSAqdmdlbV9kZXZpY2U7CiAKLXN0YXRpYyB2b2lkIHZnZW1fZ2VtX2ZyZWVfb2JqZWN0KHN0
cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqKQotewotCXN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0
ICp2Z2VtX29iaiA9IHRvX3ZnZW1fYm8ob2JqKTsKLQotCWt2ZnJlZSh2Z2VtX29iai0+cGFnZXMp
OwotCW11dGV4X2Rlc3Ryb3koJnZnZW1fb2JqLT5wYWdlc19sb2NrKTsKLQotCWlmIChvYmotPmlt
cG9ydF9hdHRhY2gpCi0JCWRybV9wcmltZV9nZW1fZGVzdHJveShvYmosIHZnZW1fb2JqLT50YWJs
ZSk7Ci0KLQlkcm1fZ2VtX29iamVjdF9yZWxlYXNlKG9iaik7Ci0Ja2ZyZWUodmdlbV9vYmopOwot
fQotCiBzdGF0aWMgdm1fZmF1bHRfdCB2Z2VtX2dlbV9mYXVsdChzdHJ1Y3Qgdm1fZmF1bHQgKnZt
ZikKIHsKIAlzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSA9IHZtZi0+dm1hOwpAQCAtMTU5LDI2
NSArMTQ0LDEyIEBAIHN0YXRpYyB2b2lkIHZnZW1fcG9zdGNsb3NlKHN0cnVjdCBkcm1fZGV2aWNl
ICpkZXYsIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSkKIAlrZnJlZSh2ZmlsZSk7CiB9CiAKLXN0YXRp
YyBzdHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqX192Z2VtX2dlbV9jcmVhdGUoc3RydWN0IGRy
bV9kZXZpY2UgKmRldiwKLQkJCQkJCXVuc2lnbmVkIGxvbmcgc2l6ZSkKLXsKLQlzdHJ1Y3QgZHJt
X3ZnZW1fZ2VtX29iamVjdCAqb2JqOwotCWludCByZXQ7Ci0KLQlvYmogPSBremFsbG9jKHNpemVv
Zigqb2JqKSwgR0ZQX0tFUk5FTCk7Ci0JaWYgKCFvYmopCi0JCXJldHVybiBFUlJfUFRSKC1FTk9N
RU0pOwotCi0Jb2JqLT5iYXNlLmZ1bmNzID0gJnZnZW1fZ2VtX29iamVjdF9mdW5jczsKLQotCXJl
dCA9IGRybV9nZW1fb2JqZWN0X2luaXQoZGV2LCAmb2JqLT5iYXNlLCByb3VuZHVwKHNpemUsIFBB
R0VfU0laRSkpOwotCWlmIChyZXQpIHsKLQkJa2ZyZWUob2JqKTsKLQkJcmV0dXJuIEVSUl9QVFIo
cmV0KTsKLQl9Ci0KLQltdXRleF9pbml0KCZvYmotPnBhZ2VzX2xvY2spOwotCi0JcmV0dXJuIG9i
ajsKLX0KLQotc3RhdGljIHZvaWQgX192Z2VtX2dlbV9kZXN0cm95KHN0cnVjdCBkcm1fdmdlbV9n
ZW1fb2JqZWN0ICpvYmopCi17Ci0JZHJtX2dlbV9vYmplY3RfcmVsZWFzZSgmb2JqLT5iYXNlKTsK
LQlrZnJlZShvYmopOwotfQotCi1zdGF0aWMgc3RydWN0IGRybV9nZW1fb2JqZWN0ICp2Z2VtX2dl
bV9jcmVhdGUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKLQkJCQkJICAgICAgc3RydWN0IGRybV9m
aWxlICpmaWxlLAotCQkJCQkgICAgICB1bnNpZ25lZCBpbnQgKmhhbmRsZSwKLQkJCQkJICAgICAg
dW5zaWduZWQgbG9uZyBzaXplKQotewotCXN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0ICpvYmo7
Ci0JaW50IHJldDsKLQotCW9iaiA9IF9fdmdlbV9nZW1fY3JlYXRlKGRldiwgc2l6ZSk7Ci0JaWYg
KElTX0VSUihvYmopKQotCQlyZXR1cm4gRVJSX0NBU1Qob2JqKTsKLQotCXJldCA9IGRybV9nZW1f
aGFuZGxlX2NyZWF0ZShmaWxlLCAmb2JqLT5iYXNlLCBoYW5kbGUpOwotCWlmIChyZXQpIHsKLQkJ
ZHJtX2dlbV9vYmplY3RfcHV0KCZvYmotPmJhc2UpOwotCQlyZXR1cm4gRVJSX1BUUihyZXQpOwot
CX0KLQotCXJldHVybiAmb2JqLT5iYXNlOwotfQotCi1zdGF0aWMgaW50IHZnZW1fZ2VtX2R1bWJf
Y3JlYXRlKHN0cnVjdCBkcm1fZmlsZSAqZmlsZSwgc3RydWN0IGRybV9kZXZpY2UgKmRldiwKLQkJ
CQlzdHJ1Y3QgZHJtX21vZGVfY3JlYXRlX2R1bWIgKmFyZ3MpCi17Ci0Jc3RydWN0IGRybV9nZW1f
b2JqZWN0ICpnZW1fb2JqZWN0OwotCXU2NCBwaXRjaCwgc2l6ZTsKLQotCXBpdGNoID0gYXJncy0+
d2lkdGggKiBESVZfUk9VTkRfVVAoYXJncy0+YnBwLCA4KTsKLQlzaXplID0gYXJncy0+aGVpZ2h0
ICogcGl0Y2g7Ci0JaWYgKHNpemUgPT0gMCkKLQkJcmV0dXJuIC1FSU5WQUw7Ci0KLQlnZW1fb2Jq
ZWN0ID0gdmdlbV9nZW1fY3JlYXRlKGRldiwgZmlsZSwgJmFyZ3MtPmhhbmRsZSwgc2l6ZSk7Ci0J
aWYgKElTX0VSUihnZW1fb2JqZWN0KSkKLQkJcmV0dXJuIFBUUl9FUlIoZ2VtX29iamVjdCk7Ci0K
LQlhcmdzLT5zaXplID0gZ2VtX29iamVjdC0+c2l6ZTsKLQlhcmdzLT5waXRjaCA9IHBpdGNoOwot
Ci0JZHJtX2dlbV9vYmplY3RfcHV0KGdlbV9vYmplY3QpOwotCi0JRFJNX0RFQlVHKCJDcmVhdGVk
IG9iamVjdCBvZiBzaXplICVsbHVcbiIsIGFyZ3MtPnNpemUpOwotCi0JcmV0dXJuIDA7Ci19Ci0K
IHN0YXRpYyBzdHJ1Y3QgZHJtX2lvY3RsX2Rlc2MgdmdlbV9pb2N0bHNbXSA9IHsKIAlEUk1fSU9D
VExfREVGX0RSVihWR0VNX0ZFTkNFX0FUVEFDSCwgdmdlbV9mZW5jZV9hdHRhY2hfaW9jdGwsIERS
TV9SRU5ERVJfQUxMT1cpLAogCURSTV9JT0NUTF9ERUZfRFJWKFZHRU1fRkVOQ0VfU0lHTkFMLCB2
Z2VtX2ZlbmNlX3NpZ25hbF9pb2N0bCwgRFJNX1JFTkRFUl9BTExPVyksCiB9OwogCi1zdGF0aWMg
aW50IHZnZW1fbW1hcChzdHJ1Y3QgZmlsZSAqZmlscCwgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2
bWEpCi17Ci0JdW5zaWduZWQgbG9uZyBmbGFncyA9IHZtYS0+dm1fZmxhZ3M7Ci0JaW50IHJldDsK
LQotCXJldCA9IGRybV9nZW1fbW1hcChmaWxwLCB2bWEpOwotCWlmIChyZXQpCi0JCXJldHVybiBy
ZXQ7Ci0KLQkvKiBLZWVwIHRoZSBXQyBtbWFwaW5nIHNldCBieSBkcm1fZ2VtX21tYXAoKSBidXQg
b3VyIHBhZ2VzCi0JICogYXJlIG9yZGluYXJ5IGFuZCBub3Qgc3BlY2lhbC4KLQkgKi8KLQl2bWEt
PnZtX2ZsYWdzID0gZmxhZ3MgfCBWTV9ET05URVhQQU5EIHwgVk1fRE9OVERVTVA7Ci0JcmV0dXJu
IDA7Ci19Ci0KLXN0YXRpYyBjb25zdCBzdHJ1Y3QgZmlsZV9vcGVyYXRpb25zIHZnZW1fZHJpdmVy
X2ZvcHMgPSB7Ci0JLm93bmVyCQk9IFRISVNfTU9EVUxFLAotCS5vcGVuCQk9IGRybV9vcGVuLAot
CS5tbWFwCQk9IHZnZW1fbW1hcCwKLQkucG9sbAkJPSBkcm1fcG9sbCwKLQkucmVhZAkJPSBkcm1f
cmVhZCwKLQkudW5sb2NrZWRfaW9jdGwgPSBkcm1faW9jdGwsCi0JLmNvbXBhdF9pb2N0bAk9IGRy
bV9jb21wYXRfaW9jdGwsCi0JLnJlbGVhc2UJPSBkcm1fcmVsZWFzZSwKLX07Ci0KLXN0YXRpYyBz
dHJ1Y3QgcGFnZSAqKnZnZW1fcGluX3BhZ2VzKHN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0ICpi
bykKLXsKLQltdXRleF9sb2NrKCZiby0+cGFnZXNfbG9jayk7Ci0JaWYgKGJvLT5wYWdlc19waW5f
Y291bnQrKyA9PSAwKSB7Ci0JCXN0cnVjdCBwYWdlICoqcGFnZXM7Ci0KLQkJcGFnZXMgPSBkcm1f
Z2VtX2dldF9wYWdlcygmYm8tPmJhc2UpOwotCQlpZiAoSVNfRVJSKHBhZ2VzKSkgewotCQkJYm8t
PnBhZ2VzX3Bpbl9jb3VudC0tOwotCQkJbXV0ZXhfdW5sb2NrKCZiby0+cGFnZXNfbG9jayk7Ci0J
CQlyZXR1cm4gcGFnZXM7Ci0JCX0KLQotCQliby0+cGFnZXMgPSBwYWdlczsKLQl9Ci0JbXV0ZXhf
dW5sb2NrKCZiby0+cGFnZXNfbG9jayk7Ci0KLQlyZXR1cm4gYm8tPnBhZ2VzOwotfQotCi1zdGF0
aWMgdm9pZCB2Z2VtX3VucGluX3BhZ2VzKHN0cnVjdCBkcm1fdmdlbV9nZW1fb2JqZWN0ICpibykK
LXsKLQltdXRleF9sb2NrKCZiby0+cGFnZXNfbG9jayk7Ci0JaWYgKC0tYm8tPnBhZ2VzX3Bpbl9j
b3VudCA9PSAwKSB7Ci0JCWRybV9nZW1fcHV0X3BhZ2VzKCZiby0+YmFzZSwgYm8tPnBhZ2VzLCB0
cnVlLCB0cnVlKTsKLQkJYm8tPnBhZ2VzID0gTlVMTDsKLQl9Ci0JbXV0ZXhfdW5sb2NrKCZiby0+
cGFnZXNfbG9jayk7Ci19Ci0KLXN0YXRpYyBpbnQgdmdlbV9wcmltZV9waW4oc3RydWN0IGRybV9n
ZW1fb2JqZWN0ICpvYmopCi17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvID0gdG9f
dmdlbV9ibyhvYmopOwotCWxvbmcgbl9wYWdlcyA9IG9iai0+c2l6ZSA+PiBQQUdFX1NISUZUOwot
CXN0cnVjdCBwYWdlICoqcGFnZXM7Ci0KLQlwYWdlcyA9IHZnZW1fcGluX3BhZ2VzKGJvKTsKLQlp
ZiAoSVNfRVJSKHBhZ2VzKSkKLQkJcmV0dXJuIFBUUl9FUlIocGFnZXMpOwotCi0JLyogRmx1c2gg
dGhlIG9iamVjdCBmcm9tIHRoZSBDUFUgY2FjaGUgc28gdGhhdCBpbXBvcnRlcnMgY2FuIHJlbHkK
LQkgKiBvbiBjb2hlcmVudCBpbmRpcmVjdCBhY2Nlc3MgdmlhIHRoZSBleHBvcnRlZCBkbWEtYWRk
cmVzcy4KLQkgKi8KLQlkcm1fY2xmbHVzaF9wYWdlcyhwYWdlcywgbl9wYWdlcyk7Ci0KLQlyZXR1
cm4gMDsKLX0KLQotc3RhdGljIHZvaWQgdmdlbV9wcmltZV91bnBpbihzdHJ1Y3QgZHJtX2dlbV9v
YmplY3QgKm9iaikKLXsKLQlzdHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqYm8gPSB0b192Z2Vt
X2JvKG9iaik7Ci0KLQl2Z2VtX3VucGluX3BhZ2VzKGJvKTsKLX0KLQotc3RhdGljIHN0cnVjdCBz
Z190YWJsZSAqdmdlbV9wcmltZV9nZXRfc2dfdGFibGUoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpv
YmopCi17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvID0gdG9fdmdlbV9ibyhvYmop
OwotCi0JcmV0dXJuIGRybV9wcmltZV9wYWdlc190b19zZyhvYmotPmRldiwgYm8tPnBhZ2VzLCBi
by0+YmFzZS5zaXplID4+IFBBR0VfU0hJRlQpOwotfQotCi1zdGF0aWMgc3RydWN0IGRybV9nZW1f
b2JqZWN0KiB2Z2VtX3ByaW1lX2ltcG9ydChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAotCQkJCQkJ
c3RydWN0IGRtYV9idWYgKmRtYV9idWYpCi17Ci0Jc3RydWN0IHZnZW1fZGV2aWNlICp2Z2VtID0g
Y29udGFpbmVyX29mKGRldiwgdHlwZW9mKCp2Z2VtKSwgZHJtKTsKLQotCXJldHVybiBkcm1fZ2Vt
X3ByaW1lX2ltcG9ydF9kZXYoZGV2LCBkbWFfYnVmLCAmdmdlbS0+cGxhdGZvcm0tPmRldik7Ci19
Ci0KLXN0YXRpYyBzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKnZnZW1fcHJpbWVfaW1wb3J0X3NnX3Rh
YmxlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCi0JCQlzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50
ICphdHRhY2gsIHN0cnVjdCBzZ190YWJsZSAqc2cpCi17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9v
YmplY3QgKm9iajsKLQlpbnQgbnBhZ2VzOwotCi0Jb2JqID0gX192Z2VtX2dlbV9jcmVhdGUoZGV2
LCBhdHRhY2gtPmRtYWJ1Zi0+c2l6ZSk7Ci0JaWYgKElTX0VSUihvYmopKQotCQlyZXR1cm4gRVJS
X0NBU1Qob2JqKTsKLQotCW5wYWdlcyA9IFBBR0VfQUxJR04oYXR0YWNoLT5kbWFidWYtPnNpemUp
IC8gUEFHRV9TSVpFOwotCi0Jb2JqLT50YWJsZSA9IHNnOwotCW9iai0+cGFnZXMgPSBrdm1hbGxv
Y19hcnJheShucGFnZXMsIHNpemVvZihzdHJ1Y3QgcGFnZSAqKSwgR0ZQX0tFUk5FTCk7Ci0JaWYg
KCFvYmotPnBhZ2VzKSB7Ci0JCV9fdmdlbV9nZW1fZGVzdHJveShvYmopOwotCQlyZXR1cm4gRVJS
X1BUUigtRU5PTUVNKTsKLQl9Ci0KLQlvYmotPnBhZ2VzX3Bpbl9jb3VudCsrOyAvKiBwZXJtYS1w
aW5uZWQgKi8KLQlkcm1fcHJpbWVfc2dfdG9fcGFnZV9hcnJheShvYmotPnRhYmxlLCBvYmotPnBh
Z2VzLCBucGFnZXMpOwotCXJldHVybiAmb2JqLT5iYXNlOwotfQotCi1zdGF0aWMgaW50IHZnZW1f
cHJpbWVfdm1hcChzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iaiwgc3RydWN0IGRtYV9idWZfbWFw
ICptYXApCi17Ci0Jc3RydWN0IGRybV92Z2VtX2dlbV9vYmplY3QgKmJvID0gdG9fdmdlbV9ibyhv
YmopOwotCWxvbmcgbl9wYWdlcyA9IG9iai0+c2l6ZSA+PiBQQUdFX1NISUZUOwotCXN0cnVjdCBw
YWdlICoqcGFnZXM7Ci0Jdm9pZCAqdmFkZHI7Ci0KLQlwYWdlcyA9IHZnZW1fcGluX3BhZ2VzKGJv
KTsKLQlpZiAoSVNfRVJSKHBhZ2VzKSkKLQkJcmV0dXJuIFBUUl9FUlIocGFnZXMpOwotCi0JdmFk
ZHIgPSB2bWFwKHBhZ2VzLCBuX3BhZ2VzLCAwLCBwZ3Byb3Rfd3JpdGVjb21iaW5lKFBBR0VfS0VS
TkVMKSk7Ci0JaWYgKCF2YWRkcikKLQkJcmV0dXJuIC1FTk9NRU07Ci0JZG1hX2J1Zl9tYXBfc2V0
X3ZhZGRyKG1hcCwgdmFkZHIpOwotCi0JcmV0dXJuIDA7Ci19Ci0KLXN0YXRpYyB2b2lkIHZnZW1f
cHJpbWVfdnVubWFwKHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqLCBzdHJ1Y3QgZG1hX2J1Zl9t
YXAgKm1hcCkKLXsKLQlzdHJ1Y3QgZHJtX3ZnZW1fZ2VtX29iamVjdCAqYm8gPSB0b192Z2VtX2Jv
KG9iaik7Ci0KLQl2dW5tYXAobWFwLT52YWRkcik7Ci0JdmdlbV91bnBpbl9wYWdlcyhibyk7Ci19
Ci0KLXN0YXRpYyBpbnQgdmdlbV9wcmltZV9tbWFwKHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2Jq
LAotCQkJICAgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpCi17Ci0JaW50IHJldDsKLQotCWlm
IChvYmotPnNpemUgPCB2bWEtPnZtX2VuZCAtIHZtYS0+dm1fc3RhcnQpCi0JCXJldHVybiAtRUlO
VkFMOwotCi0JaWYgKCFvYmotPmZpbHApCi0JCXJldHVybiAtRU5PREVWOwotCi0JcmV0ID0gY2Fs
bF9tbWFwKG9iai0+ZmlscCwgdm1hKTsKLQlpZiAocmV0KQotCQlyZXR1cm4gcmV0OwotCi0Jdm1h
X3NldF9maWxlKHZtYSwgb2JqLT5maWxwKTsKLQl2bWEtPnZtX2ZsYWdzIHw9IFZNX0RPTlRFWFBB
TkQgfCBWTV9ET05URFVNUDsKLQl2bWEtPnZtX3BhZ2VfcHJvdCA9IHBncHJvdF93cml0ZWNvbWJp
bmUodm1fZ2V0X3BhZ2VfcHJvdCh2bWEtPnZtX2ZsYWdzKSk7Ci0KLQlyZXR1cm4gMDsKLX0KLQot
c3RhdGljIGNvbnN0IHN0cnVjdCBkcm1fZ2VtX29iamVjdF9mdW5jcyB2Z2VtX2dlbV9vYmplY3Rf
ZnVuY3MgPSB7Ci0JLmZyZWUgPSB2Z2VtX2dlbV9mcmVlX29iamVjdCwKLQkucGluID0gdmdlbV9w
cmltZV9waW4sCi0JLnVucGluID0gdmdlbV9wcmltZV91bnBpbiwKLQkuZ2V0X3NnX3RhYmxlID0g
dmdlbV9wcmltZV9nZXRfc2dfdGFibGUsCi0JLnZtYXAgPSB2Z2VtX3ByaW1lX3ZtYXAsCi0JLnZ1
bm1hcCA9IHZnZW1fcHJpbWVfdnVubWFwLAotCS52bV9vcHMgPSAmdmdlbV9nZW1fdm1fb3BzLAot
fTsKK0RFRklORV9EUk1fR0VNX0ZPUFModmdlbV9kcml2ZXJfZm9wcyk7CiAKIHN0YXRpYyBjb25z
dCBzdHJ1Y3QgZHJtX2RyaXZlciB2Z2VtX2RyaXZlciA9IHsKIAkuZHJpdmVyX2ZlYXR1cmVzCQk9
IERSSVZFUl9HRU0gfCBEUklWRVJfUkVOREVSLApAQCAtNDI3LDEzICsxNTksNyBAQCBzdGF0aWMg
Y29uc3Qgc3RydWN0IGRybV9kcml2ZXIgdmdlbV9kcml2ZXIgPSB7CiAJLm51bV9pb2N0bHMgCQkJ
PSBBUlJBWV9TSVpFKHZnZW1faW9jdGxzKSwKIAkuZm9wcwkJCQk9ICZ2Z2VtX2RyaXZlcl9mb3Bz
LAogCi0JLmR1bWJfY3JlYXRlCQkJPSB2Z2VtX2dlbV9kdW1iX2NyZWF0ZSwKLQotCS5wcmltZV9o
YW5kbGVfdG9fZmQgPSBkcm1fZ2VtX3ByaW1lX2hhbmRsZV90b19mZCwKLQkucHJpbWVfZmRfdG9f
aGFuZGxlID0gZHJtX2dlbV9wcmltZV9mZF90b19oYW5kbGUsCi0JLmdlbV9wcmltZV9pbXBvcnQg
PSB2Z2VtX3ByaW1lX2ltcG9ydCwKLQkuZ2VtX3ByaW1lX2ltcG9ydF9zZ190YWJsZSA9IHZnZW1f
cHJpbWVfaW1wb3J0X3NnX3RhYmxlLAotCS5nZW1fcHJpbWVfbW1hcCA9IHZnZW1fcHJpbWVfbW1h
cCwKKwlEUk1fR0VNX1NITUVNX0RSSVZFUl9PUFMsCiAKIAkubmFtZQk9IERSSVZFUl9OQU1FLAog
CS5kZXNjCT0gRFJJVkVSX0RFU0MsCi0tIAoyLjMwLjAKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVs
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
