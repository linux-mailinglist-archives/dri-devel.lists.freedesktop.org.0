Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 166AFDAA7D
	for <lists+dri-devel@lfdr.de>; Thu, 17 Oct 2019 12:51:52 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8A8E76EA4F;
	Thu, 17 Oct 2019 10:51:49 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2A5256EA4F;
 Thu, 17 Oct 2019 10:51:49 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 5DEBC3082DDD;
 Thu, 17 Oct 2019 10:51:48 +0000 (UTC)
Received: from jason-ThinkPad-X1-Carbon-6th.redhat.com
 (ovpn-12-185.pek2.redhat.com [10.72.12.185])
 by smtp.corp.redhat.com (Postfix) with ESMTP id B33845D70D;
 Thu, 17 Oct 2019 10:51:23 +0000 (UTC)
From: Jason Wang <jasowang@redhat.com>
To: kvm@vger.kernel.org, linux-s390@vger.kernel.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 intel-gfx@lists.freedesktop.org, intel-gvt-dev@lists.freedesktop.org,
 kwankhede@nvidia.com, alex.williamson@redhat.com, mst@redhat.com,
 tiwei.bie@intel.com
Subject: [PATCH V4 5/6] virtio: introduce a mdev based transport
Date: Thu, 17 Oct 2019 18:48:35 +0800
Message-Id: <20191017104836.32464-6-jasowang@redhat.com>
In-Reply-To: <20191017104836.32464-1-jasowang@redhat.com>
References: <20191017104836.32464-1-jasowang@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.46]); Thu, 17 Oct 2019 10:51:48 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: christophe.de.dinechin@gmail.com, sebott@linux.ibm.com, airlied@linux.ie,
 Jason Wang <jasowang@redhat.com>, heiko.carstens@de.ibm.com,
 kevin.tian@intel.com, virtualization@lists.linux-foundation.org,
 rob.miller@broadcom.com, lulu@redhat.com, eperezma@redhat.com,
 pasic@linux.ibm.com, borntraeger@de.ibm.com, haotian.wang@sifive.com,
 zhi.a.wang@intel.com, farman@linux.ibm.com, idos@mellanox.com,
 gor@linux.ibm.com, cunming.liang@intel.com, rodrigo.vivi@intel.com,
 xiao.w.wang@intel.com, freude@linux.ibm.com, parav@mellanox.com,
 zhihong.wang@intel.com, stefanha@redhat.com, akrowiak@linux.ibm.com,
 netdev@vger.kernel.org, cohuck@redhat.com, oberpar@linux.ibm.com,
 maxime.coquelin@redhat.com, lingshan.zhu@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBpbnRyb2R1Y2VzIGEgbmV3IG1kZXYgdHJhbnNwb3J0IGZvciB2aXJ0aW8uIFRo
aXMgaXMgdXNlZCB0bwp1c2Uga2VybmVsIHZpcnRpbyBkcml2ZXIgdG8gZHJpdmUgdGhlIG1lZGlh
dGVkIGRldmljZSB0aGF0IGlzIGNhcGFibGUKb2YgcG9wdWxhdGluZyB2aXJ0cXVldWUgZGlyZWN0
bHkuCgpBIG5ldyB2aXJ0aW8tbWRldiBkcml2ZXIgd2lsbCBiZSByZWdpc3RlcmVkIHRvIHRoZSBt
ZGV2IGJ1cywgd2hlbiBhCm5ldyB2aXJ0aW8tbWRldiBkZXZpY2UgaXMgcHJvYmVkLCBpdCB3aWxs
IHJlZ2lzdGVyIHRoZSBkZXZpY2Ugd2l0aAptZGV2IGJhc2VkIGNvbmZpZyBvcHMuIFRoaXMgbWVh
bnMgaXQgaXMgYSBzb2Z0d2FyZSB0cmFuc3BvcnQgYmV0d2VlbgptZGV2IGRyaXZlciBhbmQgbWRl
diBkZXZpY2UuIFRoZSB0cmFuc3BvcnQgd2FzIGltcGxlbWVudGVkIHRocm91Z2gKZGV2aWNlIHNw
ZWNpZmljIG9wcyB3aGljaCBpcyBhIHBhcnQgb2YgbWRldl9wYXJlbnRfb3BzIG5vdy4KClNpZ25l
ZC1vZmYtYnk6IEphc29uIFdhbmcgPGphc293YW5nQHJlZGhhdC5jb20+Ci0tLQogZHJpdmVycy92
aXJ0aW8vS2NvbmZpZyAgICAgICB8ICAgNyArCiBkcml2ZXJzL3ZpcnRpby9NYWtlZmlsZSAgICAg
IHwgICAxICsKIGRyaXZlcnMvdmlydGlvL3ZpcnRpb19tZGV2LmMgfCA0MDkgKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysKIDMgZmlsZXMgY2hhbmdlZCwgNDE3IGluc2VydGlvbnMo
KykKIGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL3ZpcnRpby92aXJ0aW9fbWRldi5jCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy92aXJ0aW8vS2NvbmZpZyBiL2RyaXZlcnMvdmlydGlvL0tjb25maWcK
aW5kZXggMDc4NjE1Y2YyYWZjLi44ZDE4NzIyYWI1NzIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvdmly
dGlvL0tjb25maWcKKysrIGIvZHJpdmVycy92aXJ0aW8vS2NvbmZpZwpAQCAtNDMsNiArNDMsMTMg
QEAgY29uZmlnIFZJUlRJT19QQ0lfTEVHQUNZCiAKIAkgIElmIHVuc3VyZSwgc2F5IFkuCiAKK2Nv
bmZpZyBWSVJUSU9fTURFVl9ERVZJQ0UKKwl0cmlzdGF0ZSAiVklSVElPIGRyaXZlciBmb3IgTWVk
aWF0ZWQgZGV2aWNlcyIKKwlkZXBlbmRzIG9uIFZGSU9fTURFViAmJiBWSVJUSU8KKwlkZWZhdWx0
IG4KKwloZWxwCisJICBWSVJUSU8gYmFzZWQgZHJpdmVyIGZvciBNZWRpYXRlZCBkZXZpY2VzLgor
CiBjb25maWcgVklSVElPX1BNRU0KIAl0cmlzdGF0ZSAiU3VwcG9ydCBmb3IgdmlydGlvIHBtZW0g
ZHJpdmVyIgogCWRlcGVuZHMgb24gVklSVElPCmRpZmYgLS1naXQgYS9kcml2ZXJzL3ZpcnRpby9N
YWtlZmlsZSBiL2RyaXZlcnMvdmlydGlvL01ha2VmaWxlCmluZGV4IDNhMmI1YzVkY2Y0Ni4uZWJj
N2ZhMTVhZTgyIDEwMDY0NAotLS0gYS9kcml2ZXJzL3ZpcnRpby9NYWtlZmlsZQorKysgYi9kcml2
ZXJzL3ZpcnRpby9NYWtlZmlsZQpAQCAtNiwzICs2LDQgQEAgdmlydGlvX3BjaS15IDo9IHZpcnRp
b19wY2lfbW9kZXJuLm8gdmlydGlvX3BjaV9jb21tb24ubwogdmlydGlvX3BjaS0kKENPTkZJR19W
SVJUSU9fUENJX0xFR0FDWSkgKz0gdmlydGlvX3BjaV9sZWdhY3kubwogb2JqLSQoQ09ORklHX1ZJ
UlRJT19CQUxMT09OKSArPSB2aXJ0aW9fYmFsbG9vbi5vCiBvYmotJChDT05GSUdfVklSVElPX0lO
UFVUKSArPSB2aXJ0aW9faW5wdXQubworb2JqLSQoQ09ORklHX1ZJUlRJT19NREVWX0RFVklDRSkg
Kz0gdmlydGlvX21kZXYubwpkaWZmIC0tZ2l0IGEvZHJpdmVycy92aXJ0aW8vdmlydGlvX21kZXYu
YyBiL2RyaXZlcnMvdmlydGlvL3ZpcnRpb19tZGV2LmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5k
ZXggMDAwMDAwMDAwMDAwLi4yNGMwZGY1ZmZlNzcKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJz
L3ZpcnRpby92aXJ0aW9fbWRldi5jCkBAIC0wLDAgKzEsNDA5IEBACisvLyBTUERYLUxpY2Vuc2Ut
SWRlbnRpZmllcjogR1BMLTIuMC1vbmx5CisvKgorICogVklSVElPIGJhc2VkIGRyaXZlciBmb3Ig
TWVkaWF0ZWQgZGV2aWNlCisgKgorICogQ29weXJpZ2h0IChjKSAyMDE5LCBSZWQgSGF0LiBBbGwg
cmlnaHRzIHJlc2VydmVkLgorICogICAgIEF1dGhvcjogSmFzb24gV2FuZyA8amFzb3dhbmdAcmVk
aGF0LmNvbT4KKyAqCisgKi8KKworI2luY2x1ZGUgPGxpbnV4L2luaXQuaD4KKyNpbmNsdWRlIDxs
aW51eC9tb2R1bGUuaD4KKyNpbmNsdWRlIDxsaW51eC9kZXZpY2UuaD4KKyNpbmNsdWRlIDxsaW51
eC9rZXJuZWwuaD4KKyNpbmNsdWRlIDxsaW51eC9zbGFiLmg+CisjaW5jbHVkZSA8bGludXgvdXVp
ZC5oPgorI2luY2x1ZGUgPGxpbnV4L21kZXYuaD4KKyNpbmNsdWRlIDxsaW51eC92aXJ0aW9fbWRl
di5oPgorI2luY2x1ZGUgPGxpbnV4L3ZpcnRpby5oPgorI2luY2x1ZGUgPGxpbnV4L3ZpcnRpb19j
b25maWcuaD4KKyNpbmNsdWRlIDxsaW51eC92aXJ0aW9fcmluZy5oPgorCisjZGVmaW5lIERSSVZF
Ul9WRVJTSU9OICAiMC4xIgorI2RlZmluZSBEUklWRVJfQVVUSE9SICAgIlJlZCBIYXQgQ29ycG9y
YXRpb24iCisjZGVmaW5lIERSSVZFUl9ERVNDICAgICAiVklSVElPIGJhc2VkIGRyaXZlciBmb3Ig
TWVkaWF0ZWQgZGV2aWNlIgorCisjZGVmaW5lIHRvX3ZpcnRpb19tZGV2X2RldmljZShkZXYpIFwK
Kwljb250YWluZXJfb2YoZGV2LCBzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlLCB2ZGV2KQorCitz
dHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlIHsKKwlzdHJ1Y3QgdmlydGlvX2RldmljZSB2ZGV2Owor
CXN0cnVjdCBtZGV2X2RldmljZSAqbWRldjsKKwl1bnNpZ25lZCBsb25nIHZlcnNpb247CisKKwkv
KiBUaGUgbG9jayB0byBwcm90ZWN0IHZpcnRxdWV1ZSBsaXN0ICovCisJc3BpbmxvY2tfdCBsb2Nr
OworCS8qIExpc3Qgb2YgdmlydGlvX21kZXZfdnFfaW5mbyAqLworCXN0cnVjdCBsaXN0X2hlYWQg
dmlydHF1ZXVlczsKK307CisKK3N0cnVjdCB2aXJ0aW9fbWRldl92cV9pbmZvIHsKKwkvKiB0aGUg
YWN0dWFsIHZpcnRxdWV1ZSAqLworCXN0cnVjdCB2aXJ0cXVldWUgKnZxOworCisJLyogdGhlIGxp
c3Qgbm9kZSBmb3IgdGhlIHZpcnRxdWV1ZXMgbGlzdCAqLworCXN0cnVjdCBsaXN0X2hlYWQgbm9k
ZTsKK307CisKK3N0YXRpYyBzdHJ1Y3QgbWRldl9kZXZpY2UgKnZtX2dldF9tZGV2KHN0cnVjdCB2
aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2Rl
diA9IHRvX3ZpcnRpb19tZGV2X2RldmljZSh2ZGV2KTsKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1k
ZXYgPSB2bV9kZXYtPm1kZXY7CisKKwlyZXR1cm4gbWRldjsKK30KKworc3RhdGljIHZvaWQgdmly
dGlvX21kZXZfZ2V0KHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2LCB1bnNpZ25lZCBvZmZzZXQs
CisJCQkgICAgdm9pZCAqYnVmLCB1bnNpZ25lZCBsZW4pCit7CisJc3RydWN0IG1kZXZfZGV2aWNl
ICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0IHZpcnRpb19tZGV2X2Rl
dmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X2Rldl9vcHMobWRldik7CisKKwlvcHMtPmdldF9jb25m
aWcobWRldiwgb2Zmc2V0LCBidWYsIGxlbik7Cit9CisKK3N0YXRpYyB2b2lkIHZpcnRpb19tZGV2
X3NldChzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldiwgdW5zaWduZWQgb2Zmc2V0LAorCQkJICAg
IGNvbnN0IHZvaWQgKmJ1ZiwgdW5zaWduZWQgbGVuKQoreworCXN0cnVjdCBtZGV2X2RldmljZSAq
bWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCB2aXJ0aW9fbWRldl9kZXZp
Y2Vfb3BzICpvcHMgPSBtZGV2X2dldF9kZXZfb3BzKG1kZXYpOworCisJb3BzLT5zZXRfY29uZmln
KG1kZXYsIG9mZnNldCwgYnVmLCBsZW4pOworfQorCitzdGF0aWMgdTMyIHZpcnRpb19tZGV2X2dl
bmVyYXRpb24oc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7CisJc3RydWN0IG1kZXZfZGV2
aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0IHZpcnRpb19tZGV2
X2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X2Rldl9vcHMobWRldik7CisKKwlyZXR1cm4gb3Bz
LT5nZXRfZ2VuZXJhdGlvbihtZGV2KTsKK30KKworc3RhdGljIHU4IHZpcnRpb19tZGV2X2dldF9z
dGF0dXMoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7CisJc3RydWN0IG1kZXZfZGV2aWNl
ICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0IHZpcnRpb19tZGV2X2Rl
dmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X2Rldl9vcHMobWRldik7CisKKwlyZXR1cm4gb3BzLT5n
ZXRfc3RhdHVzKG1kZXYpOworfQorCitzdGF0aWMgdm9pZCB2aXJ0aW9fbWRldl9zZXRfc3RhdHVz
KHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2LCB1OCBzdGF0dXMpCit7CisJc3RydWN0IG1kZXZf
ZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0IHZpcnRpb19t
ZGV2X2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X2Rldl9vcHMobWRldik7CisKKwlyZXR1cm4g
b3BzLT5zZXRfc3RhdHVzKG1kZXYsIHN0YXR1cyk7Cit9CisKK3N0YXRpYyB2b2lkIHZpcnRpb19t
ZGV2X3Jlc2V0KHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCBtZGV2X2Rl
dmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCB2aXJ0aW9fbWRl
dl9kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF9kZXZfb3BzKG1kZXYpOworCisJcmV0dXJuIG9w
cy0+c2V0X3N0YXR1cyhtZGV2LCAwKTsKK30KKworc3RhdGljIGJvb2wgdmlydGlvX21kZXZfbm90
aWZ5KHN0cnVjdCB2aXJ0cXVldWUgKnZxKQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9
IHZtX2dldF9tZGV2KHZxLT52ZGV2KTsKKwljb25zdCBzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNl
X29wcyAqb3BzID0gbWRldl9nZXRfZGV2X29wcyhtZGV2KTsKKworCW9wcy0+a2lja192cShtZGV2
LCB2cS0+aW5kZXgpOworCisJcmV0dXJuIHRydWU7Cit9CisKK3N0YXRpYyBpcnFyZXR1cm5fdCB2
aXJ0aW9fbWRldl9jb25maWdfY2Iodm9pZCAqcHJpdmF0ZSkKK3sKKwlzdHJ1Y3QgdmlydGlvX21k
ZXZfZGV2aWNlICp2bV9kZXYgPSBwcml2YXRlOworCisJdmlydGlvX2NvbmZpZ19jaGFuZ2VkKCZ2
bV9kZXYtPnZkZXYpOworCisJcmV0dXJuIElSUV9IQU5ETEVEOworfQorCitzdGF0aWMgaXJxcmV0
dXJuX3QgdmlydGlvX21kZXZfdmlydHF1ZXVlX2NiKHZvaWQgKnByaXZhdGUpCit7CisJc3RydWN0
IHZpcnRpb19tZGV2X3ZxX2luZm8gKmluZm8gPSBwcml2YXRlOworCisJcmV0dXJuIHZyaW5nX2lu
dGVycnVwdCgwLCBpbmZvLT52cSk7Cit9CisKK3N0YXRpYyBzdHJ1Y3QgdmlydHF1ZXVlICoKK3Zp
cnRpb19tZGV2X3NldHVwX3ZxKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2LCB1bnNpZ25lZCBp
bmRleCwKKwkJICAgICB2b2lkICgqY2FsbGJhY2spKHN0cnVjdCB2aXJ0cXVldWUgKnZxKSwKKwkJ
ICAgICBjb25zdCBjaGFyICpuYW1lLCBib29sIGN0eCkKK3sKKwlzdHJ1Y3QgdmlydGlvX21kZXZf
ZGV2aWNlICp2bV9kZXYgPSB0b192aXJ0aW9fbWRldl9kZXZpY2UodmRldik7CisJc3RydWN0IG1k
ZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0IHZpcnRp
b19tZGV2X2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X2Rldl9vcHMobWRldik7CisJc3RydWN0
IHZpcnRpb19tZGV2X3ZxX2luZm8gKmluZm87CisJc3RydWN0IHZpcnRpb19tZGV2X2NhbGxiYWNr
IGNiOworCXN0cnVjdCB2aXJ0cXVldWUgKnZxOworCXU2NCBkZXNjX2FkZHIsIGRyaXZlcl9hZGRy
LCBkZXZpY2VfYWRkcjsKKwl1bnNpZ25lZCBsb25nIGZsYWdzOworCXUzMiBhbGlnbiwgbnVtOwor
CWludCBlcnI7CisKKwlpZiAoIW5hbWUpCisJCXJldHVybiBOVUxMOworCisJLyogUXVldWUgc2hv
dWxkbid0IGFscmVhZHkgYmUgc2V0IHVwLiAqLworCWlmIChvcHMtPmdldF92cV9yZWFkeShtZGV2
LCBpbmRleCkpCisJCXJldHVybiBFUlJfUFRSKC1FTk9FTlQpOworCisJLyogQWxsb2NhdGUgYW5k
IGZpbGwgb3V0IG91ciBhY3RpdmUgcXVldWUgZGVzY3JpcHRpb24gKi8KKwlpbmZvID0ga21hbGxv
YyhzaXplb2YoKmluZm8pLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWluZm8pCisJCXJldHVybiBFUlJf
UFRSKC1FTk9NRU0pOworCisJbnVtID0gb3BzLT5nZXRfdnFfbnVtX21heChtZGV2KTsKKwlpZiAo
bnVtID09IDApIHsKKwkJZXJyID0gLUVOT0VOVDsKKwkJZ290byBlcnJvcl9uZXdfdmlydHF1ZXVl
OworCX0KKworCS8qIENyZWF0ZSB0aGUgdnJpbmcgKi8KKwlhbGlnbiA9IG9wcy0+Z2V0X3ZxX2Fs
aWduKG1kZXYpOworCXZxID0gdnJpbmdfY3JlYXRlX3ZpcnRxdWV1ZShpbmRleCwgbnVtLCBhbGln
biwgdmRldiwKKwkJCQkgICAgdHJ1ZSwgdHJ1ZSwgY3R4LAorCQkJCSAgICB2aXJ0aW9fbWRldl9u
b3RpZnksIGNhbGxiYWNrLCBuYW1lKTsKKwlpZiAoIXZxKSB7CisJCWVyciA9IC1FTk9NRU07CisJ
CWdvdG8gZXJyb3JfbmV3X3ZpcnRxdWV1ZTsKKwl9CisKKwkvKiBTZXR1cCB2aXJ0cXVldWUgY2Fs
bGJhY2sgKi8KKwljYi5jYWxsYmFjayA9IHZpcnRpb19tZGV2X3ZpcnRxdWV1ZV9jYjsKKwljYi5w
cml2YXRlID0gaW5mbzsKKwlvcHMtPnNldF92cV9jYihtZGV2LCBpbmRleCwgJmNiKTsKKwlvcHMt
PnNldF92cV9udW0obWRldiwgaW5kZXgsIHZpcnRxdWV1ZV9nZXRfdnJpbmdfc2l6ZSh2cSkpOwor
CisJZGVzY19hZGRyID0gdmlydHF1ZXVlX2dldF9kZXNjX2FkZHIodnEpOworCWRyaXZlcl9hZGRy
ID0gdmlydHF1ZXVlX2dldF9hdmFpbF9hZGRyKHZxKTsKKwlkZXZpY2VfYWRkciA9IHZpcnRxdWV1
ZV9nZXRfdXNlZF9hZGRyKHZxKTsKKworCWlmIChvcHMtPnNldF92cV9hZGRyZXNzKG1kZXYsIGlu
ZGV4LAorCQkJCWRlc2NfYWRkciwgZHJpdmVyX2FkZHIsCisJCQkJZGV2aWNlX2FkZHIpKSB7CisJ
CWVyciA9IC1FSU5WQUw7CisJCWdvdG8gZXJyX3ZxOworCX0KKworCW9wcy0+c2V0X3ZxX3JlYWR5
KG1kZXYsIGluZGV4LCAxKTsKKworCXZxLT5wcml2ID0gaW5mbzsKKwlpbmZvLT52cSA9IHZxOwor
CisJc3Bpbl9sb2NrX2lycXNhdmUoJnZtX2Rldi0+bG9jaywgZmxhZ3MpOworCWxpc3RfYWRkKCZp
bmZvLT5ub2RlLCAmdm1fZGV2LT52aXJ0cXVldWVzKTsKKwlzcGluX3VubG9ja19pcnFyZXN0b3Jl
KCZ2bV9kZXYtPmxvY2ssIGZsYWdzKTsKKworCXJldHVybiB2cTsKKworZXJyX3ZxOgorCXZyaW5n
X2RlbF92aXJ0cXVldWUodnEpOworZXJyb3JfbmV3X3ZpcnRxdWV1ZToKKwlvcHMtPnNldF92cV9y
ZWFkeShtZGV2LCBpbmRleCwgMCk7CisJV0FSTl9PTihvcHMtPmdldF92cV9yZWFkeShtZGV2LCBp
bmRleCkpOworCWtmcmVlKGluZm8pOworCXJldHVybiBFUlJfUFRSKGVycik7CisKK30KKworc3Rh
dGljIHZvaWQgdmlydGlvX21kZXZfZGVsX3ZxKHN0cnVjdCB2aXJ0cXVldWUgKnZxKQoreworCXN0
cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2RldiA9IHRvX3ZpcnRpb19tZGV2X2RldmljZSh2
cS0+dmRldik7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZGV2LT5tZGV2OworCWNv
bnN0IHN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF9kZXZfb3Bz
KG1kZXYpOworCXN0cnVjdCB2aXJ0aW9fbWRldl92cV9pbmZvICppbmZvID0gdnEtPnByaXY7CisJ
dW5zaWduZWQgaW50IGluZGV4ID0gdnEtPmluZGV4OworCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisK
KwlzcGluX2xvY2tfaXJxc2F2ZSgmdm1fZGV2LT5sb2NrLCBmbGFncyk7CisJbGlzdF9kZWwoJmlu
Zm8tPm5vZGUpOworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJnZtX2Rldi0+bG9jaywgZmxhZ3Mp
OworCisJLyogU2VsZWN0IGFuZCBkZWFjdGl2YXRlIHRoZSBxdWV1ZSAqLworCW9wcy0+c2V0X3Zx
X3JlYWR5KG1kZXYsIGluZGV4LCAwKTsKKwlXQVJOX09OKG9wcy0+Z2V0X3ZxX3JlYWR5KG1kZXYs
IGluZGV4KSk7CisKKwl2cmluZ19kZWxfdmlydHF1ZXVlKHZxKTsKKworCWtmcmVlKGluZm8pOwor
fQorCitzdGF0aWMgdm9pZCB2aXJ0aW9fbWRldl9kZWxfdnFzKHN0cnVjdCB2aXJ0aW9fZGV2aWNl
ICp2ZGV2KQoreworCXN0cnVjdCB2aXJ0cXVldWUgKnZxLCAqbjsKKworCWxpc3RfZm9yX2VhY2hf
ZW50cnlfc2FmZSh2cSwgbiwgJnZkZXYtPnZxcywgbGlzdCkKKwkJdmlydGlvX21kZXZfZGVsX3Zx
KHZxKTsKK30KKworc3RhdGljIGludCB2aXJ0aW9fbWRldl9maW5kX3ZxcyhzdHJ1Y3QgdmlydGlv
X2RldmljZSAqdmRldiwgdW5zaWduZWQgbnZxcywKKwkJCQlzdHJ1Y3QgdmlydHF1ZXVlICp2cXNb
XSwKKwkJCQl2cV9jYWxsYmFja190ICpjYWxsYmFja3NbXSwKKwkJCQljb25zdCBjaGFyICogY29u
c3QgbmFtZXNbXSwKKwkJCQljb25zdCBib29sICpjdHgsCisJCQkJc3RydWN0IGlycV9hZmZpbml0
eSAqZGVzYykKK3sKKwlzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlICp2bV9kZXYgPSB0b192aXJ0
aW9fbWRldl9kZXZpY2UodmRldik7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0
X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0IHZpcnRpb19tZGV2X2RldmljZV9vcHMgKm9wcyA9
IG1kZXZfZ2V0X2Rldl9vcHMobWRldik7CisJc3RydWN0IHZpcnRpb19tZGV2X2NhbGxiYWNrIGNi
OworCWludCBpLCBlcnIsIHF1ZXVlX2lkeCA9IDA7CisKKwlmb3IgKGkgPSAwOyBpIDwgbnZxczsg
KytpKSB7CisJCWlmICghbmFtZXNbaV0pIHsKKwkJCXZxc1tpXSA9IE5VTEw7CisJCQljb250aW51
ZTsKKwkJfQorCisJCXZxc1tpXSA9IHZpcnRpb19tZGV2X3NldHVwX3ZxKHZkZXYsIHF1ZXVlX2lk
eCsrLAorCQkJCQkgICAgICBjYWxsYmFja3NbaV0sIG5hbWVzW2ldLCBjdHggPworCQkJCQkgICAg
ICBjdHhbaV0gOiBmYWxzZSk7CisJCWlmIChJU19FUlIodnFzW2ldKSkgeworCQkJZXJyID0gUFRS
X0VSUih2cXNbaV0pOworCQkJZ290byBlcnJfc2V0dXBfdnE7CisJCX0KKwl9CisKKwljYi5jYWxs
YmFjayA9IHZpcnRpb19tZGV2X2NvbmZpZ19jYjsKKwljYi5wcml2YXRlID0gdm1fZGV2OworCW9w
cy0+c2V0X2NvbmZpZ19jYihtZGV2LCAmY2IpOworCisJcmV0dXJuIDA7CisKK2Vycl9zZXR1cF92
cToKKwl2aXJ0aW9fbWRldl9kZWxfdnFzKHZkZXYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRp
YyB1NjQgdmlydGlvX21kZXZfZ2V0X2ZlYXR1cmVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2
KQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNv
bnN0IHN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF9kZXZfb3Bz
KG1kZXYpOworCisJcmV0dXJuIG9wcy0+Z2V0X2ZlYXR1cmVzKG1kZXYpOworfQorCitzdGF0aWMg
aW50IHZpcnRpb19tZGV2X2ZpbmFsaXplX2ZlYXR1cmVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2
ZGV2KQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOwor
CWNvbnN0IHN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF9kZXZf
b3BzKG1kZXYpOworCisJLyogR2l2ZSB2aXJ0aW9fcmluZyBhIGNoYW5jZSB0byBhY2NlcHQgZmVh
dHVyZXMuICovCisJdnJpbmdfdHJhbnNwb3J0X2ZlYXR1cmVzKHZkZXYpOworCisJcmV0dXJuIG9w
cy0+c2V0X2ZlYXR1cmVzKG1kZXYsIHZkZXYtPmZlYXR1cmVzKTsKK30KKworc3RhdGljIGNvbnN0
IGNoYXIgKnZpcnRpb19tZGV2X2J1c19uYW1lKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQor
eworCXN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2RldiA9IHRvX3ZpcnRpb19tZGV2X2Rl
dmljZSh2ZGV2KTsKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9kZXYtPm1kZXY7CisK
KwlyZXR1cm4gZGV2X25hbWUobWRldl9kZXYobWRldikpOworfQorCitzdGF0aWMgY29uc3Qgc3Ry
dWN0IHZpcnRpb19jb25maWdfb3BzIHZpcnRpb19tZGV2X2NvbmZpZ19vcHMgPSB7CisJLmdldAkJ
PSB2aXJ0aW9fbWRldl9nZXQsCisJLnNldAkJPSB2aXJ0aW9fbWRldl9zZXQsCisJLmdlbmVyYXRp
b24JPSB2aXJ0aW9fbWRldl9nZW5lcmF0aW9uLAorCS5nZXRfc3RhdHVzCT0gdmlydGlvX21kZXZf
Z2V0X3N0YXR1cywKKwkuc2V0X3N0YXR1cwk9IHZpcnRpb19tZGV2X3NldF9zdGF0dXMsCisJLnJl
c2V0CQk9IHZpcnRpb19tZGV2X3Jlc2V0LAorCS5maW5kX3Zxcwk9IHZpcnRpb19tZGV2X2ZpbmRf
dnFzLAorCS5kZWxfdnFzCT0gdmlydGlvX21kZXZfZGVsX3ZxcywKKwkuZ2V0X2ZlYXR1cmVzCT0g
dmlydGlvX21kZXZfZ2V0X2ZlYXR1cmVzLAorCS5maW5hbGl6ZV9mZWF0dXJlcyA9IHZpcnRpb19t
ZGV2X2ZpbmFsaXplX2ZlYXR1cmVzLAorCS5idXNfbmFtZQk9IHZpcnRpb19tZGV2X2J1c19uYW1l
LAorfTsKKworc3RhdGljIHZvaWQgdmlydGlvX21kZXZfcmVsZWFzZV9kZXYoc3RydWN0IGRldmlj
ZSAqX2QpCit7CisJc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYgPQorCSAgICAgICBjb250YWlu
ZXJfb2YoX2QsIHN0cnVjdCB2aXJ0aW9fZGV2aWNlLCBkZXYpOworCXN0cnVjdCB2aXJ0aW9fbWRl
dl9kZXZpY2UgKnZtX2RldiA9CisJICAgICAgIGNvbnRhaW5lcl9vZih2ZGV2LCBzdHJ1Y3Qgdmly
dGlvX21kZXZfZGV2aWNlLCB2ZGV2KTsKKworCWRldm1fa2ZyZWUoX2QsIHZtX2Rldik7Cit9CisK
K3N0YXRpYyBpbnQgdmlydGlvX21kZXZfcHJvYmUoc3RydWN0IGRldmljZSAqZGV2KQoreworCXN0
cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IG1kZXZfZnJvbV9kZXYoZGV2KTsKKwljb25zdCBzdHJ1
Y3QgdmlydGlvX21kZXZfZGV2aWNlX29wcyAqb3BzID0gbWRldl9nZXRfZGV2X29wcyhtZGV2KTsK
KwlzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlICp2bV9kZXY7CisJaW50IHJjOworCisJdm1fZGV2
ID0gZGV2bV9remFsbG9jKGRldiwgc2l6ZW9mKCp2bV9kZXYpLCBHRlBfS0VSTkVMKTsKKwlpZiAo
IXZtX2RldikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwl2bV9kZXYtPnZkZXYuZGV2LnBhcmVudCA9
IGRldjsKKwl2bV9kZXYtPnZkZXYuZGV2LnJlbGVhc2UgPSB2aXJ0aW9fbWRldl9yZWxlYXNlX2Rl
djsKKwl2bV9kZXYtPnZkZXYuY29uZmlnID0gJnZpcnRpb19tZGV2X2NvbmZpZ19vcHM7CisJdm1f
ZGV2LT5tZGV2ID0gbWRldjsKKwlJTklUX0xJU1RfSEVBRCgmdm1fZGV2LT52aXJ0cXVldWVzKTsK
KwlzcGluX2xvY2tfaW5pdCgmdm1fZGV2LT5sb2NrKTsKKworCXZtX2Rldi0+dmVyc2lvbiA9IG9w
cy0+Z2V0X21kZXZfZmVhdHVyZXMobWRldik7CisJaWYgKHZtX2Rldi0+dmVyc2lvbiAhPSBWSVJU
SU9fTURFVl9GX1ZFUlNJT05fMSkgeworCQlkZXZfZXJyKGRldiwgIlZJUlRJT19NREVWX0ZfVkVS
U0lPTl8xIGlzIG1hbmRhdG9yeVxuIik7CisJCXJldHVybiAtRU5YSU87CisJfQorCisJdm1fZGV2
LT52ZGV2LmlkLmRldmljZSA9IG9wcy0+Z2V0X2RldmljZV9pZChtZGV2KTsKKwlpZiAodm1fZGV2
LT52ZGV2LmlkLmRldmljZSA9PSAwKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCXZtX2Rldi0+dmRl
di5pZC52ZW5kb3IgPSBvcHMtPmdldF92ZW5kb3JfaWQobWRldik7CisJcmMgPSByZWdpc3Rlcl92
aXJ0aW9fZGV2aWNlKCZ2bV9kZXYtPnZkZXYpOworCWlmIChyYykKKwkJcHV0X2RldmljZShkZXYp
OworCWVsc2UKKwkJZGV2X3NldF9kcnZkYXRhKGRldiwgdm1fZGV2KTsKKworCXJldHVybiByYzsK
K30KKworc3RhdGljIHZvaWQgdmlydGlvX21kZXZfcmVtb3ZlKHN0cnVjdCBkZXZpY2UgKmRldikK
K3sKKwlzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlICp2bV9kZXYgPSBkZXZfZ2V0X2RydmRhdGEo
ZGV2KTsKKworCXVucmVnaXN0ZXJfdmlydGlvX2RldmljZSgmdm1fZGV2LT52ZGV2KTsKK30KKwor
c3RhdGljIGNvbnN0IHN0cnVjdCBtZGV2X2NsYXNzX2lkIGlkX3RhYmxlW10gPSB7CisJeyBNREVW
X0NMQVNTX0lEX1ZJUlRJTyB9LAorCXsgMCB9LAorfTsKKworTU9EVUxFX0RFVklDRV9UQUJMRSht
ZGV2LCBpZF90YWJsZSk7CisKK3N0YXRpYyBzdHJ1Y3QgbWRldl9kcml2ZXIgdmlydGlvX21kZXZf
ZHJpdmVyID0geworCS5uYW1lCT0gInZpcnRpb19tZGV2IiwKKwkucHJvYmUJPSB2aXJ0aW9fbWRl
dl9wcm9iZSwKKwkucmVtb3ZlID0gdmlydGlvX21kZXZfcmVtb3ZlLAorCS5pZF90YWJsZSA9IGlk
X3RhYmxlLAorfTsKKworc3RhdGljIGludCBfX2luaXQgdmlydGlvX21kZXZfaW5pdCh2b2lkKQor
eworCXJldHVybiBtZGV2X3JlZ2lzdGVyX2RyaXZlcigmdmlydGlvX21kZXZfZHJpdmVyLCBUSElT
X01PRFVMRSk7Cit9CisKK3N0YXRpYyB2b2lkIF9fZXhpdCB2aXJ0aW9fbWRldl9leGl0KHZvaWQp
Cit7CisJbWRldl91bnJlZ2lzdGVyX2RyaXZlcigmdmlydGlvX21kZXZfZHJpdmVyKTsKK30KKwor
bW9kdWxlX2luaXQodmlydGlvX21kZXZfaW5pdCkKK21vZHVsZV9leGl0KHZpcnRpb19tZGV2X2V4
aXQpCisKK01PRFVMRV9WRVJTSU9OKERSSVZFUl9WRVJTSU9OKTsKK01PRFVMRV9MSUNFTlNFKCJH
UEwgdjIiKTsKK01PRFVMRV9BVVRIT1IoRFJJVkVSX0FVVEhPUik7CitNT0RVTEVfREVTQ1JJUFRJ
T04oRFJJVkVSX0RFU0MpOwotLSAKMi4xOS4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0
cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9s
aXN0aW5mby9kcmktZGV2ZWw=
