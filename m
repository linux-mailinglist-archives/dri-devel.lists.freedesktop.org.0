Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id E00CEA7565
	for <lists+dri-devel@lfdr.de>; Tue,  3 Sep 2019 22:48:50 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E4EBF89C14;
	Tue,  3 Sep 2019 20:48:37 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 39D4089BF0;
 Tue,  3 Sep 2019 20:48:33 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id B1E7010F23F9;
 Tue,  3 Sep 2019 20:48:32 +0000 (UTC)
Received: from malachite.bss.redhat.com (dhcp-10-20-1-34.bss.redhat.com
 [10.20.1.34])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 721241001B0B;
 Tue,  3 Sep 2019 20:48:31 +0000 (UTC)
From: Lyude Paul <lyude@redhat.com>
To: dri-devel@lists.freedesktop.org, nouveau@lists.freedesktop.org,
 amd-gfx@lists.freedesktop.org
Subject: [PATCH v2 16/27] drm/dp_mst: Refactor pdt setup/teardown,
 add more locking
Date: Tue,  3 Sep 2019 16:45:54 -0400
Message-Id: <20190903204645.25487-17-lyude@redhat.com>
In-Reply-To: <20190903204645.25487-1-lyude@redhat.com>
References: <20190903204645.25487-1-lyude@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.66]); Tue, 03 Sep 2019 20:48:32 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sean Paul <sean@poorly.run>, David Airlie <airlied@linux.ie>,
 Daniel Vetter <daniel.vetter@ffwll.ch>, linux-kernel@vger.kernel.org,
 Maxime Ripard <mripard@kernel.org>, Juston Li <juston.li@intel.com>,
 Harry Wentland <hwentlan@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2Ugd2UncmUgZ29pbmcgdG8gYmUgaW1wbGVtZW50aW5nIHN1c3BlbmQvcmVzdW1lIHJlcHJv
YmluZyB2ZXJ5IHNvb24sCndlIG5lZWQgdG8gbWFrZSBzdXJlIHdlIGFyZSBleHRyYSBjYXJlZnVs
IHRvIGVuc3VyZSB0aGF0IG91ciBsb2NraW5nCmFjdHVhbGx5IHByb3RlY3RzIHRoZSB0b3BvbG9n
eSBzdGF0ZSB3aGVyZSB3ZSBleHBlY3QgaXQgdG8uIFR1cm5zIG91dAp0aGlzIGlzbid0IHRoZSBj
YXNlIHdpdGggZHJtX2RwX3BvcnRfc2V0dXBfcGR0KCkgYW5kCmRybV9kcF9wb3J0X3RlYXJkb3du
X3BkdCgpLCBib3RoIG9mIHdoaWNoIGNoYW5nZSBwb3J0LT5tc3RiIHdpdGhvdXQKZ3JhYmJpbmcg
Jm1nci0+bG9jay4KCkFkZGl0aW9uYWxseSwgc2luY2UgbW9zdCBjYWxsZXJzIG9mIHRoZXNlIGZ1
bmN0aW9ucyBhcmUganVzdCB1c2luZyBpdCB0bwp0ZWFyZG93biB0aGUgcG9ydCdzIHByZXZpb3Vz
IFBEVCBhbmQgc2V0dXAgYSBuZXcgb25lIHdlIGNhbiBzaW1wbGlmeQp0aGluZ3MgYSBiaXQgYW5k
IGNvbWJpbmUgZHJtX2RwX3BvcnRfc2V0dXBfcGR0KCkgYW5kCmRybV9kcF9wb3J0X3RlYXJkb3du
X3BkdCgpIGludG8gYSBzaW5nbGUgZnVuY3Rpb246CmRybV9kcF9wb3J0X3NldF9wZHQoKS4gVGhp
cyBmdW5jdGlvbiBhbHNvIGhhbmRsZXMgYWN0dWFsbHkgZW5zdXJpbmcgdGhhdAp3ZSBncmFiIHRo
ZSBjb3JyZWN0IGxvY2tzIHdoZW4gd2UgbmVlZCB0byBtb2RpZnkgcG9ydC0+bXN0Yi4KCkNjOiBK
dXN0b24gTGkgPGp1c3Rvbi5saUBpbnRlbC5jb20+CkNjOiBJbXJlIERlYWsgPGltcmUuZGVha0Bp
bnRlbC5jb20+CkNjOiBWaWxsZSBTeXJqw6Rsw6QgPHZpbGxlLnN5cmphbGFAbGludXguaW50ZWwu
Y29tPgpDYzogSGFycnkgV2VudGxhbmQgPGh3ZW50bGFuQGFtZC5jb20+CkNjOiBEYW5pZWwgVmV0
dGVyIDxkYW5pZWwudmV0dGVyQGZmd2xsLmNoPgpTaWduZWQtb2ZmLWJ5OiBMeXVkZSBQYXVsIDxs
eXVkZUByZWRoYXQuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9kcm1fZHBfbXN0X3RvcG9sb2d5
LmMgfCAxODEgKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0KIGluY2x1ZGUvZHJtL2RybV9kcF9t
c3RfaGVscGVyLmggICAgICAgfCAgIDYgKy0KIDIgZmlsZXMgY2hhbmdlZCwgMTEwIGluc2VydGlv
bnMoKyksIDc3IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9kcm1f
ZHBfbXN0X3RvcG9sb2d5LmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5j
CmluZGV4IGQxNjEwNDM0YTBjYi4uOTk0NGVmMmNlODg1IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZHBf
bXN0X3RvcG9sb2d5LmMKQEAgLTE0ODcsMjQgKzE0ODcsNiBAQCBkcm1fZHBfbXN0X3RvcG9sb2d5
X3B1dF9tc3RiKHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YikKIAlrcmVmX3B1dCgmbXN0
Yi0+dG9wb2xvZ3lfa3JlZiwgZHJtX2RwX2Rlc3Ryb3lfbXN0X2JyYW5jaF9kZXZpY2UpOwogfQog
Ci1zdGF0aWMgdm9pZCBkcm1fZHBfcG9ydF90ZWFyZG93bl9wZHQoc3RydWN0IGRybV9kcF9tc3Rf
cG9ydCAqcG9ydCwgaW50IG9sZF9wZHQpCi17Ci0Jc3RydWN0IGRybV9kcF9tc3RfYnJhbmNoICpt
c3RiOwotCi0Jc3dpdGNoIChvbGRfcGR0KSB7Ci0JY2FzZSBEUF9QRUVSX0RFVklDRV9EUF9MRUdB
Q1lfQ09OVjoKLQljYXNlIERQX1BFRVJfREVWSUNFX1NTVF9TSU5LOgotCQkvKiByZW1vdmUgaTJj
IG92ZXIgc2lkZWJhbmQgKi8KLQkJZHJtX2RwX21zdF91bnJlZ2lzdGVyX2kyY19idXMoJnBvcnQt
PmF1eCk7Ci0JCWJyZWFrOwotCWNhc2UgRFBfUEVFUl9ERVZJQ0VfTVNUX0JSQU5DSElORzoKLQkJ
bXN0YiA9IHBvcnQtPm1zdGI7Ci0JCXBvcnQtPm1zdGIgPSBOVUxMOwotCQlkcm1fZHBfbXN0X3Rv
cG9sb2d5X3B1dF9tc3RiKG1zdGIpOwotCQlicmVhazsKLQl9Ci19Ci0KIHN0YXRpYyB2b2lkIGRy
bV9kcF9kZXN0cm95X3BvcnQoc3RydWN0IGtyZWYgKmtyZWYpCiB7CiAJc3RydWN0IGRybV9kcF9t
c3RfcG9ydCAqcG9ydCA9CkBAIC0xNzE0LDM4ICsxNjk2LDc5IEBAIHN0YXRpYyB1OCBkcm1fZHBf
Y2FsY3VsYXRlX3JhZChzdHJ1Y3QgZHJtX2RwX21zdF9wb3J0ICpwb3J0LAogCXJldHVybiBwYXJl
bnRfbGN0ICsgMTsKIH0KIAotLyoKLSAqIHJldHVybiBzZW5kcyBsaW5rIGFkZHJlc3MgZm9yIG5l
dyBtc3RiCi0gKi8KLXN0YXRpYyBib29sIGRybV9kcF9wb3J0X3NldHVwX3BkdChzdHJ1Y3QgZHJt
X2RwX21zdF9wb3J0ICpwb3J0KQorc3RhdGljIGludCBkcm1fZHBfcG9ydF9zZXRfcGR0KHN0cnVj
dCBkcm1fZHBfbXN0X3BvcnQgKnBvcnQsIHU4IG5ld19wZHQpCiB7Ci0JaW50IHJldDsKLQl1OCBy
YWRbNl0sIGxjdDsKLQlib29sIHNlbmRfbGluayA9IGZhbHNlOworCXN0cnVjdCBkcm1fZHBfbXN0
X3RvcG9sb2d5X21nciAqbWdyID0gcG9ydC0+bWdyOworCXN0cnVjdCBkcm1fZHBfbXN0X2JyYW5j
aCAqbXN0YjsKKwl1OCByYWRbOF0sIGxjdDsKKwlpbnQgcmV0ID0gMDsKKworCWlmIChwb3J0LT5w
ZHQgPT0gbmV3X3BkdCkKKwkJcmV0dXJuIDA7CisKKwkvKiBUZWFyZG93biB0aGUgb2xkIHBkdCwg
aWYgdGhlcmUgaXMgb25lICovCisJc3dpdGNoIChwb3J0LT5wZHQpIHsKKwljYXNlIERQX1BFRVJf
REVWSUNFX0RQX0xFR0FDWV9DT05WOgorCWNhc2UgRFBfUEVFUl9ERVZJQ0VfU1NUX1NJTks6CisJ
CS8qCisJCSAqIElmIHRoZSBuZXcgUERUIHdvdWxkIGFsc28gaGF2ZSBhbiBpMmMgYnVzLCBkb24n
dCBib3RoZXIKKwkJICogd2l0aCByZXJlZ2lzdGVyaW5nIGl0CisJCSAqLworCQlpZiAobmV3X3Bk
dCA9PSBEUF9QRUVSX0RFVklDRV9EUF9MRUdBQ1lfQ09OViB8fAorCQkgICAgbmV3X3BkdCA9PSBE
UF9QRUVSX0RFVklDRV9TU1RfU0lOSykgeworCQkJcG9ydC0+cGR0ID0gbmV3X3BkdDsKKwkJCXJl
dHVybiAwOworCQl9CisKKwkJLyogcmVtb3ZlIGkyYyBvdmVyIHNpZGViYW5kICovCisJCWRybV9k
cF9tc3RfdW5yZWdpc3Rlcl9pMmNfYnVzKCZwb3J0LT5hdXgpOworCQlicmVhazsKKwljYXNlIERQ
X1BFRVJfREVWSUNFX01TVF9CUkFOQ0hJTkc6CisJCW11dGV4X2xvY2soJm1nci0+bG9jayk7CisJ
CWRybV9kcF9tc3RfdG9wb2xvZ3lfcHV0X21zdGIocG9ydC0+bXN0Yik7CisJCXBvcnQtPm1zdGIg
PSBOVUxMOworCQltdXRleF91bmxvY2soJm1nci0+bG9jayk7CisJCWJyZWFrOworCX0KKworCXBv
cnQtPnBkdCA9IG5ld19wZHQ7CiAJc3dpdGNoIChwb3J0LT5wZHQpIHsKIAljYXNlIERQX1BFRVJf
REVWSUNFX0RQX0xFR0FDWV9DT05WOgogCWNhc2UgRFBfUEVFUl9ERVZJQ0VfU1NUX1NJTks6CiAJ
CS8qIGFkZCBpMmMgb3ZlciBzaWRlYmFuZCAqLwogCQlyZXQgPSBkcm1fZHBfbXN0X3JlZ2lzdGVy
X2kyY19idXMoJnBvcnQtPmF1eCk7CiAJCWJyZWFrOworCiAJY2FzZSBEUF9QRUVSX0RFVklDRV9N
U1RfQlJBTkNISU5HOgogCQlsY3QgPSBkcm1fZHBfY2FsY3VsYXRlX3JhZChwb3J0LCByYWQpOwor
CQltc3RiID0gZHJtX2RwX2FkZF9tc3RfYnJhbmNoX2RldmljZShsY3QsIHJhZCk7CisJCWlmICgh
bXN0YikgeworCQkJcmV0ID0gLUVOT01FTTsKKwkJCURSTV9FUlJPUigiRmFpbGVkIHRvIGNyZWF0
ZSBNU1RCIGZvciBwb3J0ICVwIiwgcG9ydCk7CisJCQlnb3RvIG91dDsKKwkJfQogCi0JCXBvcnQt
Pm1zdGIgPSBkcm1fZHBfYWRkX21zdF9icmFuY2hfZGV2aWNlKGxjdCwgcmFkKTsKLQkJaWYgKHBv
cnQtPm1zdGIpIHsKLQkJCXBvcnQtPm1zdGItPm1nciA9IHBvcnQtPm1ncjsKLQkJCXBvcnQtPm1z
dGItPnBvcnRfcGFyZW50ID0gcG9ydDsKLQkJCS8qCi0JCQkgKiBNYWtlIHN1cmUgdGhpcyBwb3J0
J3MgbWVtb3J5IGFsbG9jYXRpb24gc3RheXMKLQkJCSAqIGFyb3VuZCB1bnRpbCBpdHMgY2hpbGQg
TVNUQiByZWxlYXNlcyBpdAotCQkJICovCi0JCQlkcm1fZHBfbXN0X2dldF9wb3J0X21hbGxvYyhw
b3J0KTsKKwkJbXV0ZXhfbG9jaygmbWdyLT5sb2NrKTsKKwkJcG9ydC0+bXN0YiA9IG1zdGI7CisJ
CW1zdGItPm1nciA9IHBvcnQtPm1ncjsKKwkJbXN0Yi0+cG9ydF9wYXJlbnQgPSBwb3J0OwogCi0J
CQlzZW5kX2xpbmsgPSB0cnVlOwotCQl9CisJCS8qCisJCSAqIE1ha2Ugc3VyZSB0aGlzIHBvcnQn
cyBtZW1vcnkgYWxsb2NhdGlvbiBzdGF5cworCQkgKiBhcm91bmQgdW50aWwgaXRzIGNoaWxkIE1T
VEIgcmVsZWFzZXMgaXQKKwkJICovCisJCWRybV9kcF9tc3RfZ2V0X3BvcnRfbWFsbG9jKHBvcnQp
OworCQltdXRleF91bmxvY2soJm1nci0+bG9jayk7CisKKwkJLyogQW5kIG1ha2Ugc3VyZSB3ZSBz
ZW5kIGEgbGluayBhZGRyZXNzIGZvciB0aGlzICovCisJCXJldCA9IDE7CiAJCWJyZWFrOwogCX0K
LQlyZXR1cm4gc2VuZF9saW5rOworCitvdXQ6CisJaWYgKHJldCA8IDApCisJCXBvcnQtPnBkdCA9
IERQX1BFRVJfREVWSUNFX05PTkU7CisJcmV0dXJuIHJldDsKIH0KIAogLyoqCkBAIC0xODgxLDEw
ICsxOTA0LDkgQEAgc3RhdGljIHZvaWQgZHJtX2RwX2FkZF9wb3J0KHN0cnVjdCBkcm1fZHBfbXN0
X2JyYW5jaCAqbXN0YiwKIAkJCSAgICBzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogCQkJICAgIHN0
cnVjdCBkcm1fZHBfbGlua19hZGRyX3JlcGx5X3BvcnQgKnBvcnRfbXNnKQogeworCXN0cnVjdCBk
cm1fZHBfbXN0X3RvcG9sb2d5X21nciAqbWdyID0gbXN0Yi0+bWdyOwogCXN0cnVjdCBkcm1fZHBf
bXN0X3BvcnQgKnBvcnQ7Ci0JYm9vbCByZXQ7CiAJYm9vbCBjcmVhdGVkID0gZmFsc2U7Ci0JaW50
IG9sZF9wZHQgPSAwOwogCWludCBvbGRfZGRwcyA9IDA7CiAKIAlwb3J0ID0gZHJtX2RwX2dldF9w
b3J0KG1zdGIsIHBvcnRfbXNnLT5wb3J0X251bWJlcik7CkBAIC0xODk2LDcgKzE5MTgsNyBAQCBz
dGF0aWMgdm9pZCBkcm1fZHBfYWRkX3BvcnQoc3RydWN0IGRybV9kcF9tc3RfYnJhbmNoICptc3Ri
LAogCQlrcmVmX2luaXQoJnBvcnQtPm1hbGxvY19rcmVmKTsKIAkJcG9ydC0+cGFyZW50ID0gbXN0
YjsKIAkJcG9ydC0+cG9ydF9udW0gPSBwb3J0X21zZy0+cG9ydF9udW1iZXI7Ci0JCXBvcnQtPm1n
ciA9IG1zdGItPm1ncjsKKwkJcG9ydC0+bWdyID0gbWdyOwogCQlwb3J0LT5hdXgubmFtZSA9ICJE
UE1TVCI7CiAJCXBvcnQtPmF1eC5kZXYgPSBkZXYtPmRldjsKIAkJcG9ydC0+YXV4LmlzX3JlbW90
ZSA9IHRydWU7CkBAIC0xOTA5LDExICsxOTMxLDkgQEAgc3RhdGljIHZvaWQgZHJtX2RwX2FkZF9w
b3J0KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKIAogCQljcmVhdGVkID0gdHJ1ZTsK
IAl9IGVsc2UgewotCQlvbGRfcGR0ID0gcG9ydC0+cGR0OwogCQlvbGRfZGRwcyA9IHBvcnQtPmRk
cHM7CiAJfQogCi0JcG9ydC0+cGR0ID0gcG9ydF9tc2ctPnBlZXJfZGV2aWNlX3R5cGU7CiAJcG9y
dC0+aW5wdXQgPSBwb3J0X21zZy0+aW5wdXRfcG9ydDsKIAlwb3J0LT5tY3MgPSBwb3J0X21zZy0+
bWNzOwogCXBvcnQtPmRkcHMgPSBwb3J0X21zZy0+ZGRwczsKQEAgLTE5MjUsMjkgKzE5NDUsMzMg
QEAgc3RhdGljIHZvaWQgZHJtX2RwX2FkZF9wb3J0KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAq
bXN0YiwKIAkvKiBtYW5hZ2UgbXN0YiBwb3J0IGxpc3RzIHdpdGggbWdyIGxvY2sgLSB0YWtlIGEg
cmVmZXJlbmNlCiAJICAgZm9yIHRoaXMgbGlzdCAqLwogCWlmIChjcmVhdGVkKSB7Ci0JCW11dGV4
X2xvY2soJm1zdGItPm1nci0+bG9jayk7CisJCW11dGV4X2xvY2soJm1nci0+bG9jayk7CiAJCWRy
bV9kcF9tc3RfdG9wb2xvZ3lfZ2V0X3BvcnQocG9ydCk7CiAJCWxpc3RfYWRkKCZwb3J0LT5uZXh0
LCAmbXN0Yi0+cG9ydHMpOwotCQltdXRleF91bmxvY2soJm1zdGItPm1nci0+bG9jayk7CisJCW11
dGV4X3VubG9jaygmbWdyLT5sb2NrKTsKIAl9CiAKIAlpZiAob2xkX2RkcHMgIT0gcG9ydC0+ZGRw
cykgewogCQlpZiAocG9ydC0+ZGRwcykgewogCQkJaWYgKCFwb3J0LT5pbnB1dCkgewotCQkJCWRy
bV9kcF9zZW5kX2VudW1fcGF0aF9yZXNvdXJjZXMobXN0Yi0+bWdyLAotCQkJCQkJCQltc3RiLCBw
b3J0KTsKKwkJCQlkcm1fZHBfc2VuZF9lbnVtX3BhdGhfcmVzb3VyY2VzKG1nciwgbXN0YiwKKwkJ
CQkJCQkJcG9ydCk7CiAJCQl9CiAJCX0gZWxzZSB7CiAJCQlwb3J0LT5hdmFpbGFibGVfcGJuID0g
MDsKIAkJfQogCX0KIAotCWlmIChvbGRfcGR0ICE9IHBvcnQtPnBkdCAmJiAhcG9ydC0+aW5wdXQp
IHsKLQkJZHJtX2RwX3BvcnRfdGVhcmRvd25fcGR0KHBvcnQsIG9sZF9wZHQpOwotCi0JCXJldCA9
IGRybV9kcF9wb3J0X3NldHVwX3BkdChwb3J0KTsKLQkJaWYgKHJldCA9PSB0cnVlKQotCQkJZHJt
X2RwX3NlbmRfbGlua19hZGRyZXNzKG1zdGItPm1nciwgcG9ydC0+bXN0Yik7CisJaWYgKCFwb3J0
LT5pbnB1dCkgeworCQlpbnQgcmV0ID0gZHJtX2RwX3BvcnRfc2V0X3BkdChwb3J0LAorCQkJCQkg
ICAgICBwb3J0X21zZy0+cGVlcl9kZXZpY2VfdHlwZSk7CisJCWlmIChyZXQgPT0gMSkgeworCQkJ
ZHJtX2RwX3NlbmRfbGlua19hZGRyZXNzKG1nciwgcG9ydC0+bXN0Yik7CisJCX0gZWxzZSBpZiAo
cmV0IDwgMCkgeworCQkJRFJNX0VSUk9SKCJGYWlsZWQgdG8gY2hhbmdlIFBEVCBvbiBwb3J0ICVw
OiAlZFxuIiwKKwkJCQkgIHBvcnQsIHJldCk7CisJCQlnb3RvIGZhaWw7CisJCX0KIAl9CiAKIAlp
ZiAoY3JlYXRlZCAmJiAhcG9ydC0+aW5wdXQpIHsKQEAgLTE5NTUsMTggKzE5NzksMTEgQEAgc3Rh
dGljIHZvaWQgZHJtX2RwX2FkZF9wb3J0KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwK
IAogCQlidWlsZF9tc3RfcHJvcF9wYXRoKG1zdGIsIHBvcnQtPnBvcnRfbnVtLCBwcm9wcGF0aCwK
IAkJCQkgICAgc2l6ZW9mKHByb3BwYXRoKSk7Ci0JCXBvcnQtPmNvbm5lY3RvciA9ICgqbXN0Yi0+
bWdyLT5jYnMtPmFkZF9jb25uZWN0b3IpKG1zdGItPm1nciwKLQkJCQkJCQkJICAgcG9ydCwKLQkJ
CQkJCQkJICAgcHJvcHBhdGgpOwotCQlpZiAoIXBvcnQtPmNvbm5lY3RvcikgewotCQkJLyogcmVt
b3ZlIGl0IGZyb20gdGhlIHBvcnQgbGlzdCAqLwotCQkJbXV0ZXhfbG9jaygmbXN0Yi0+bWdyLT5s
b2NrKTsKLQkJCWxpc3RfZGVsKCZwb3J0LT5uZXh0KTsKLQkJCW11dGV4X3VubG9jaygmbXN0Yi0+
bWdyLT5sb2NrKTsKLQkJCS8qIGRyb3AgcG9ydCBsaXN0IHJlZmVyZW5jZSAqLwotCQkJZHJtX2Rw
X21zdF90b3BvbG9neV9wdXRfcG9ydChwb3J0KTsKLQkJCWdvdG8gb3V0OwotCQl9CisJCXBvcnQt
PmNvbm5lY3RvciA9ICgqbWdyLT5jYnMtPmFkZF9jb25uZWN0b3IpKG1nciwgcG9ydCwKKwkJCQkJ
CQkgICAgIHByb3BwYXRoKTsKKwkJaWYgKCFwb3J0LT5jb25uZWN0b3IpCisJCQlnb3RvIGZhaWw7
CisKIAkJaWYgKChwb3J0LT5wZHQgPT0gRFBfUEVFUl9ERVZJQ0VfRFBfTEVHQUNZX0NPTlYgfHwK
IAkJICAgICBwb3J0LT5wZHQgPT0gRFBfUEVFUl9ERVZJQ0VfU1NUX1NJTkspICYmCiAJCSAgICBw
b3J0LT5wb3J0X251bSA+PSBEUF9NU1RfTE9HSUNBTF9QT1JUXzApIHsKQEAgLTE5NzQsMjggKzE5
OTEsMzggQEAgc3RhdGljIHZvaWQgZHJtX2RwX2FkZF9wb3J0KHN0cnVjdCBkcm1fZHBfbXN0X2Jy
YW5jaCAqbXN0YiwKIAkJCQkJCQkgJnBvcnQtPmF1eC5kZGMpOwogCQkJZHJtX2Nvbm5lY3Rvcl9z
ZXRfdGlsZV9wcm9wZXJ0eShwb3J0LT5jb25uZWN0b3IpOwogCQl9Ci0JCSgqbXN0Yi0+bWdyLT5j
YnMtPnJlZ2lzdGVyX2Nvbm5lY3RvcikocG9ydC0+Y29ubmVjdG9yKTsKKworCQkoKm1nci0+Y2Jz
LT5yZWdpc3Rlcl9jb25uZWN0b3IpKHBvcnQtPmNvbm5lY3Rvcik7CiAJfQogCi1vdXQ6CiAJLyog
cHV0IHJlZmVyZW5jZSB0byB0aGlzIHBvcnQgKi8KIAlkcm1fZHBfbXN0X3RvcG9sb2d5X3B1dF9w
b3J0KHBvcnQpOworCXJldHVybjsKKworZmFpbDoKKwkvKiBSZW1vdmUgaXQgZnJvbSB0aGUgcG9y
dCBsaXN0ICovCisJbXV0ZXhfbG9jaygmbWdyLT5sb2NrKTsKKwlsaXN0X2RlbCgmcG9ydC0+bmV4
dCk7CisJbXV0ZXhfdW5sb2NrKCZtZ3ItPmxvY2spOworCisJLyogRHJvcCB0aGUgcG9ydCBsaXN0
IHJlZmVyZW5jZSAqLworCWRybV9kcF9tc3RfdG9wb2xvZ3lfcHV0X3BvcnQocG9ydCk7CisJLyog
QW5kIG5vdyBkcm9wIG91ciByZWZlcmVuY2UgKi8KKwlkcm1fZHBfbXN0X3RvcG9sb2d5X3B1dF9w
b3J0KHBvcnQpOwogfQogCiBzdGF0aWMgdm9pZCBkcm1fZHBfdXBkYXRlX3BvcnQoc3RydWN0IGRy
bV9kcF9tc3RfYnJhbmNoICptc3RiLAogCQkJICAgICAgIHN0cnVjdCBkcm1fZHBfY29ubmVjdGlv
bl9zdGF0dXNfbm90aWZ5ICpjb25uX3N0YXQpCiB7CiAJc3RydWN0IGRybV9kcF9tc3RfcG9ydCAq
cG9ydDsKLQlpbnQgb2xkX3BkdDsKIAlpbnQgb2xkX2RkcHM7CiAJYm9vbCBkb3dvcmsgPSBmYWxz
ZTsKKwogCXBvcnQgPSBkcm1fZHBfZ2V0X3BvcnQobXN0YiwgY29ubl9zdGF0LT5wb3J0X251bWJl
cik7CiAJaWYgKCFwb3J0KQogCQlyZXR1cm47CiAKIAlvbGRfZGRwcyA9IHBvcnQtPmRkcHM7Ci0J
b2xkX3BkdCA9IHBvcnQtPnBkdDsKLQlwb3J0LT5wZHQgPSBjb25uX3N0YXQtPnBlZXJfZGV2aWNl
X3R5cGU7CiAJcG9ydC0+bWNzID0gY29ubl9zdGF0LT5tZXNzYWdlX2NhcGFiaWxpdHlfc3RhdHVz
OwogCXBvcnQtPmxkcHMgPSBjb25uX3N0YXQtPmxlZ2FjeV9kZXZpY2VfcGx1Z19zdGF0dXM7CiAJ
cG9ydC0+ZGRwcyA9IGNvbm5fc3RhdC0+ZGlzcGxheXBvcnRfZGV2aWNlX3BsdWdfc3RhdHVzOwpA
QCAtMjAwNywxMSArMjAzNCwxNyBAQCBzdGF0aWMgdm9pZCBkcm1fZHBfdXBkYXRlX3BvcnQoc3Ry
dWN0IGRybV9kcF9tc3RfYnJhbmNoICptc3RiLAogCQkJcG9ydC0+YXZhaWxhYmxlX3BibiA9IDA7
CiAJCX0KIAl9Ci0JaWYgKG9sZF9wZHQgIT0gcG9ydC0+cGR0ICYmICFwb3J0LT5pbnB1dCkgewot
CQlkcm1fZHBfcG9ydF90ZWFyZG93bl9wZHQocG9ydCwgb2xkX3BkdCk7CiAKLQkJaWYgKGRybV9k
cF9wb3J0X3NldHVwX3BkdChwb3J0KSkKKwlpZiAoIXBvcnQtPmlucHV0KSB7CisJCWludCByZXQg
PSBkcm1fZHBfcG9ydF9zZXRfcGR0KHBvcnQsCisJCQkJCSAgICAgIGNvbm5fc3RhdC0+cGVlcl9k
ZXZpY2VfdHlwZSk7CisJCWlmIChyZXQgPT0gMSkgewogCQkJZG93b3JrID0gdHJ1ZTsKKwkJfSBl
bHNlIGlmIChyZXQgPCAwKSB7CisJCQlEUk1fRVJST1IoIkZhaWxlZCB0byBjaGFuZ2UgUERUIGZv
ciBwb3J0ICVwOiAlZFxuIiwKKwkJCQkgIHBvcnQsIHJldCk7CisJCQlkb3dvcmsgPSBmYWxzZTsK
KwkJfQogCX0KIAogCWRybV9kcF9tc3RfdG9wb2xvZ3lfcHV0X3BvcnQocG9ydCk7CkBAIC00MDAz
LDkgKzQwMzYsNyBAQCBkcm1fZHBfZGVsYXllZF9kZXN0cm95X3BvcnQoc3RydWN0IGRybV9kcF9t
c3RfcG9ydCAqcG9ydCkKIAlpZiAocG9ydC0+Y29ubmVjdG9yKQogCQlwb3J0LT5tZ3ItPmNicy0+
ZGVzdHJveV9jb25uZWN0b3IocG9ydC0+bWdyLCBwb3J0LT5jb25uZWN0b3IpOwogCi0JZHJtX2Rw
X3BvcnRfdGVhcmRvd25fcGR0KHBvcnQsIHBvcnQtPnBkdCk7Ci0JcG9ydC0+cGR0ID0gRFBfUEVF
Ul9ERVZJQ0VfTk9ORTsKLQorCWRybV9kcF9wb3J0X3NldF9wZHQocG9ydCwgRFBfUEVFUl9ERVZJ
Q0VfTk9ORSk7CiAJZHJtX2RwX21zdF9wdXRfcG9ydF9tYWxsb2MocG9ydCk7CiB9CiAKZGlmZiAt
LWdpdCBhL2luY2x1ZGUvZHJtL2RybV9kcF9tc3RfaGVscGVyLmggYi9pbmNsdWRlL2RybS9kcm1f
ZHBfbXN0X2hlbHBlci5oCmluZGV4IDU0MjNhOGFkZGE3OC4uZjI1M2VlNDNlOWQ5IDEwMDY0NAot
LS0gYS9pbmNsdWRlL2RybS9kcm1fZHBfbXN0X2hlbHBlci5oCisrKyBiL2luY2x1ZGUvZHJtL2Ry
bV9kcF9tc3RfaGVscGVyLmgKQEAgLTU1LDggKzU1LDEwIEBAIHN0cnVjdCBkcm1fZHBfdmNwaSB7
CiAgKiBAbnVtX3NkcF9zdHJlYW1fc2lua3M6IE51bWJlciBvZiBzdHJlYW0gc2lua3MKICAqIEBh
dmFpbGFibGVfcGJuOiBBdmFpbGFibGUgYmFuZHdpZHRoIGZvciB0aGlzIHBvcnQuCiAgKiBAbmV4
dDogbGluayB0byBuZXh0IHBvcnQgb24gdGhpcyBicmFuY2ggZGV2aWNlCi0gKiBAbXN0YjogYnJh
bmNoIGRldmljZSBhdHRhY2ggYmVsb3cgdGhpcyBwb3J0Ci0gKiBAYXV4OiBpMmMgYXV4IHRyYW5z
cG9ydCB0byB0YWxrIHRvIGRldmljZSBjb25uZWN0ZWQgdG8gdGhpcyBwb3J0LgorICogQG1zdGI6
IGJyYW5jaCBkZXZpY2Ugb24gdGhpcyBwb3J0LCBwcm90ZWN0ZWQgYnkKKyAqICZkcm1fZHBfbXN0
X3RvcG9sb2d5X21nci5sb2NrCisgKiBAYXV4OiBpMmMgYXV4IHRyYW5zcG9ydCB0byB0YWxrIHRv
IGRldmljZSBjb25uZWN0ZWQgdG8gdGhpcyBwb3J0LCBwcm90ZWN0ZWQKKyAqIGJ5ICZkcm1fZHBf
bXN0X3RvcG9sb2d5X21nci5sb2NrCiAgKiBAcGFyZW50OiBicmFuY2ggZGV2aWNlIHBhcmVudCBv
ZiB0aGlzIHBvcnQKICAqIEB2Y3BpOiBWaXJ0dWFsIENoYW5uZWwgUGF5bG9hZCBpbmZvIGZvciB0
aGlzIHBvcnQuCiAgKiBAY29ubmVjdG9yOiBEUk0gY29ubmVjdG9yIHRoaXMgcG9ydCBpcyBjb25u
ZWN0ZWQgdG8uCi0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2RyaS1kZXZlbA==
