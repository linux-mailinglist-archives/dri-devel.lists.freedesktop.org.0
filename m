Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 704562C645E
	for <lists+dri-devel@lfdr.de>; Fri, 27 Nov 2020 13:08:38 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BDADD6EC19;
	Fri, 27 Nov 2020 12:08:01 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga11.intel.com (mga11.intel.com [192.55.52.93])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2145B6EBFF;
 Fri, 27 Nov 2020 12:07:54 +0000 (UTC)
IronPort-SDR: 7ojyYevpsXl7Jaq3VZYo3+JUtVxappuBeE04i/rCVoSo/6zd3qo7IKeFMD8MHlq+9LCbNm5nHw
 YCQgart7WkUw==
X-IronPort-AV: E=McAfee;i="6000,8403,9817"; a="168883380"
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="168883380"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga005.jf.intel.com ([10.7.209.41])
 by fmsmga102.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:07:52 -0800
IronPort-SDR: xnFWp5S+ice37t3AlO2ruyE7HWJfsEDUfALa9+bMCX3BMEzdI+IyQJGUtq7jKXpXi/CE3/1ePm
 4XktJXz0KY7Q==
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="548028588"
Received: from mjgleeso-mobl.ger.corp.intel.com (HELO
 mwauld-desk1.ger.corp.intel.com) ([10.251.85.2])
 by orsmga005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:07:50 -0800
From: Matthew Auld <matthew.auld@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [RFC PATCH 014/162] drm/i915: Ensure we hold the object mutex in pin
 correctly v2
Date: Fri, 27 Nov 2020 12:04:50 +0000
Message-Id: <20201127120718.454037-15-matthew.auld@intel.com>
X-Mailer: git-send-email 2.26.2
In-Reply-To: <20201127120718.454037-1-matthew.auld@intel.com>
References: <20201127120718.454037-1-matthew.auld@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: dri-devel@lists.freedesktop.org,
 =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNv
bT4KCkN1cnJlbnRseSB3ZSBoYXZlIGEgbG90IG9mIHBsYWNlcyB3aGVyZSB3ZSBob2xkIHRoZSBn
ZW0gb2JqZWN0IGxvY2ssCmJ1dCBoYXZlbid0IHlldCBiZWVuIGNvbnZlcnRlZCB0byB0aGUgd3cg
ZGFuY2UuIENvbXBsYWluIGxvdWRseSBhYm91dAp0aG9zZSBwbGFjZXMuCgppOTE1X3ZtYV9waW4g
c2hvdWxkbid0IGhhdmUgdGhlIG9iaiBsb2NrIGhlbGQsIHNvIHdlIGNhbiBkbyBhIHd3IGRhbmNl
LAp3aGlsZSBpOTE1X3ZtYV9waW5fd3cgc2hvdWxkLgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBM
YW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KQ2M6IFRob21hcyBI
ZWxsc3Ryw7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNvbT4KLS0tCiBkcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9yZW5kZXJzdGF0ZS5jIHwgIDIgKy0KIGRyaXZlcnMvZ3B1
L2RybS9pOTE1L2d0L2ludGVsX3RpbWVsaW5lLmMgICAgfCAgNCArLQogZHJpdmVycy9ncHUvZHJt
L2k5MTUvaTkxNV92bWEuYyAgICAgICAgICAgICB8IDQ2ICsrKysrKysrKysrKysrKysrKystLQog
ZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaCAgICAgICAgICAgICB8ICA1ICsrKwogNCBm
aWxlcyBjaGFuZ2VkLCA1MCBpbnNlcnRpb25zKCspLCA3IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdp
dCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3JlbmRlcnN0YXRlLmMgYi9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9yZW5kZXJzdGF0ZS5jCmluZGV4IGVhMmE3N2M3YjQ2OS4u
YTY4ZTVjMjNhNjdjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9y
ZW5kZXJzdGF0ZS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX3JlbmRlcnN0
YXRlLmMKQEAgLTE5Niw3ICsxOTYsNyBAQCBpbnQgaW50ZWxfcmVuZGVyc3RhdGVfaW5pdChzdHJ1
Y3QgaW50ZWxfcmVuZGVyc3RhdGUgKnNvLAogCWlmIChlcnIpCiAJCWdvdG8gZXJyX2NvbnRleHQ7
CiAKLQllcnIgPSBpOTE1X3ZtYV9waW4oc28tPnZtYSwgMCwgMCwgUElOX0dMT0JBTCB8IFBJTl9I
SUdIKTsKKwllcnIgPSBpOTE1X3ZtYV9waW5fd3coc28tPnZtYSwgJnNvLT53dywgMCwgMCwgUElO
X0dMT0JBTCB8IFBJTl9ISUdIKTsKIAlpZiAoZXJyKQogCQlnb3RvIGVycl9jb250ZXh0OwogCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZS5jIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfdGltZWxpbmUuYwppbmRleCA0NzllYjU0NDBiYzYu
LmIyZDA0NzE3ZGIyMCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
dGltZWxpbmUuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF90aW1lbGluZS5j
CkBAIC00Niw3ICs0Niw3IEBAIHN0YXRpYyBpbnQgX19od3NwX2FsbG9jKHN0cnVjdCBpbnRlbF9n
dCAqZ3QsIHN0cnVjdCBpbnRlbF90aW1lbGluZV9od3NwICpod3NwKQogCQlnb3RvIG91dF91bmxv
Y2s7CiAJfQogCi0JLyogUGluIGVhcmx5IHNvIHdlIGNhbiBjYWxsIGk5MTVfZ2d0dF9waW4gdW5s
b2NrZWQuICovCisJLyogUGluIGVhcmx5IHNvIHdlIGNhbiBjYWxsIGk5MTVfZ2d0dF9waW5fdW5s
b2NrZWQoKS4gKi8KIAlod3NwLT52YWRkciA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKG9iaiwg
STkxNV9NQVBfV0IpOwogCWlmIChJU19FUlIoaHdzcC0+dmFkZHIpKSB7CiAJCXJldCA9IFBUUl9F
UlIoaHdzcC0+dmFkZHIpOwpAQCAtNTE0LDcgKzUxNCw3IEBAIF9faW50ZWxfdGltZWxpbmVfZ2V0
X3NlcW5vKHN0cnVjdCBpbnRlbF90aW1lbGluZSAqdGwsCiAJCWdvdG8gZXJyX3JvbGxiYWNrOwog
CX0KIAotCWVyciA9IGk5MTVfZ2d0dF9waW4odm1hLCBOVUxMLCAwLCBQSU5fSElHSCk7CisJZXJy
ID0gaTkxNV9nZ3R0X3Bpbl91bmxvY2tlZCh2bWEsIDAsIFBJTl9ISUdIKTsKIAlpZiAoZXJyKSB7
CiAJCV9faWRsZV9od3NwX2ZyZWUodm1hLT5wcml2YXRlLCBjYWNoZWxpbmUpOwogCQlnb3RvIGVy
cl9yb2xsYmFjazsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmMg
Yi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5jCmluZGV4IDhlOGM4MGNjYmUzMi4uZTA3
NjIxODI1ZGE5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmMKQEAgLTg2Miw3ICs4NjIsOCBAQCBp
bnQgaTkxNV92bWFfcGluX3d3KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCBzdHJ1Y3QgaTkxNV9nZW1f
d3dfY3R4ICp3dywKIAl1bnNpZ25lZCBpbnQgYm91bmQ7CiAJaW50IGVycjsKIAotCWlmIChJU19F
TkFCTEVEKENPTkZJR19QUk9WRV9MT0NLSU5HKSAmJiBkZWJ1Z19sb2NrcykgeworI2lmZGVmIENP
TkZJR19QUk9WRV9MT0NLSU5HCisJaWYgKGRlYnVnX2xvY2tzKSB7CiAJCWJvb2wgcGlubmVkX2Jp
bmRfd29fYWxsb2MgPQogCQkJdm1hLT5vYmogJiYgaTkxNV9nZW1fb2JqZWN0X2hhc19waW5uZWRf
cGFnZXModm1hLT5vYmopICYmCiAJCQkhdm1hLT52bS0+YWxsb2NhdGVfdmFfcmFuZ2U7CkBAIC04
NzAsNyArODcxLDEwIEBAIGludCBpOTE1X3ZtYV9waW5fd3coc3RydWN0IGk5MTVfdm1hICp2bWEs
IHN0cnVjdCBpOTE1X2dlbV93d19jdHggKnd3LAogCQlpZiAobG9ja2RlcF9pc19oZWxkKCZ2bWEt
PnZtLT5pOTE1LT5kcm0uc3RydWN0X211dGV4KSAmJgogCQkgICAgIXBpbm5lZF9iaW5kX3dvX2Fs
bG9jKQogCQkJV0FSTl9PTighd3cpOworCQlpZiAod3cgJiYgdm1hLT5yZXN2KQorCQkJYXNzZXJ0
X3ZtYV9oZWxkKHZtYSk7CiAJfQorI2VuZGlmCiAKIAlCVUlMRF9CVUdfT04oUElOX0dMT0JBTCAh
PSBJOTE1X1ZNQV9HTE9CQUxfQklORCk7CiAJQlVJTERfQlVHX09OKFBJTl9VU0VSICE9IEk5MTVf
Vk1BX0xPQ0FMX0JJTkQpOwpAQCAtMTAxNyw4ICsxMDIxLDggQEAgc3RhdGljIHZvaWQgZmx1c2hf
aWRsZV9jb250ZXh0cyhzdHJ1Y3QgaW50ZWxfZ3QgKmd0KQogCWludGVsX2d0X3dhaXRfZm9yX2lk
bGUoZ3QsIE1BWF9TQ0hFRFVMRV9USU1FT1VUKTsKIH0KIAotaW50IGk5MTVfZ2d0dF9waW4oc3Ry
dWN0IGk5MTVfdm1hICp2bWEsIHN0cnVjdCBpOTE1X2dlbV93d19jdHggKnd3LAotCQkgIHUzMiBh
bGlnbiwgdW5zaWduZWQgaW50IGZsYWdzKQorc3RhdGljIGludCBfX2k5MTVfZ2d0dF9waW4oc3Ry
dWN0IGk5MTVfdm1hICp2bWEsIHN0cnVjdCBpOTE1X2dlbV93d19jdHggKnd3LAorCQkJICAgdTMy
IGFsaWduLCB1bnNpZ25lZCBpbnQgZmxhZ3MsIGJvb2wgdW5sb2NrZWQpCiB7CiAJc3RydWN0IGk5
MTVfYWRkcmVzc19zcGFjZSAqdm0gPSB2bWEtPnZtOwogCWludCBlcnI7CkBAIC0xMDI2LDcgKzEw
MzAsMTAgQEAgaW50IGk5MTVfZ2d0dF9waW4oc3RydWN0IGk5MTVfdm1hICp2bWEsIHN0cnVjdCBp
OTE1X2dlbV93d19jdHggKnd3LAogCUdFTV9CVUdfT04oIWk5MTVfdm1hX2lzX2dndHQodm1hKSk7
CiAKIAlkbyB7Ci0JCWVyciA9IGk5MTVfdm1hX3Bpbl93dyh2bWEsIHd3LCAwLCBhbGlnbiwgZmxh
Z3MgfCBQSU5fR0xPQkFMKTsKKwkJaWYgKHd3IHx8IHVubG9ja2VkKQorCQkJZXJyID0gaTkxNV92
bWFfcGluX3d3KHZtYSwgd3csIDAsIGFsaWduLCBmbGFncyB8IFBJTl9HTE9CQUwpOworCQllbHNl
CisJCQllcnIgPSBpOTE1X3ZtYV9waW4odm1hLCAwLCBhbGlnbiwgZmxhZ3MgfCBQSU5fR0xPQkFM
KTsKIAkJaWYgKGVyciAhPSAtRU5PU1BDKSB7CiAJCQlpZiAoIWVycikgewogCQkJCWVyciA9IGk5
MTVfdm1hX3dhaXRfZm9yX2JpbmQodm1hKTsKQEAgLTEwNDUsNiArMTA1MiwzNyBAQCBpbnQgaTkx
NV9nZ3R0X3BpbihzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAq
d3csCiAJfSB3aGlsZSAoMSk7CiB9CiAKK2ludCBpOTE1X2dndHRfcGluKHN0cnVjdCBpOTE1X3Zt
YSAqdm1hLCBzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4ICp3dywKKwkJICB1MzIgYWxpZ24sIHVuc2ln
bmVkIGludCBmbGFncykKK3sKKyNpZmRlZiBDT05GSUdfTE9DS0RFUAorCVdBUk5fT04oIXd3ICYm
IHZtYS0+cmVzdiAmJiBkbWFfcmVzdl9oZWxkKHZtYS0+cmVzdikpOworI2VuZGlmCisKKwlyZXR1
cm4gX19pOTE1X2dndHRfcGluKHZtYSwgd3csIGFsaWduLCBmbGFncywgZmFsc2UpOworfQorCisv
KioKKyAqIGk5MTVfZ2d0dF9waW5fdW5sb2NrZWQgLSBQaW4gYSB2bWEgdG8gZ2d0dCB3aXRob3V0
IHRoZSB1bmRlcmx5aW5nCisgKiBvYmplY3QncyBkbWEtcmVzdiBoZWxkLCBidXQgd2l0aCBvYmpl
Y3QgcGFnZXMgcGlubmVkLgorICoKKyAqIEB2bWE6IFRoZSB2bWEgdG8gcGluLgorICogQGFsaWdu
OiBnZ3R0IGFsaWdubWVudC4KKyAqIEBmbGFnczogUGlubmluZyBmbGFncworICoKKyAqIFJFVFVS
TjogWmVybyBvbiBzdWNjZXNzLCBuZWdhdGl2ZSBlcnJvciBjb2RlIG9uIGVycm9yLgorICoKKyAq
IFRoaXMgZnVuY3Rpb24gcmVsaWVzIG9uIHRoZSBmYWN0IHRoYXQgb2JqZWN0IHBhZ2VzIGFyZSBh
bHJlYWR5IHBpbm5lZCwKKyAqIGFuZCB0aGF0IGdndHQgcGlubmluZyBkb2Vzbid0IHJlcXVpcmUg
YW55IHBhZ2UgdGFibGUgcGFnZSBhbGxvY2F0aW9ucworICogdG8gcGluIGEgdm1hIHdpdGhvdXQg
ZG1hX3Jlc3YgbG9jayBhbmQgd3cgYWNxdWlyZSBjb250ZXh0LgorICovCitpbnQgaTkxNV9nZ3R0
X3Bpbl91bmxvY2tlZChzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgdTMyIGFsaWduLCB1bnNpZ25lZCBp
bnQgZmxhZ3MpCit7CisJaWYgKElTX0VOQUJMRUQoQ09ORklHX0xPQ0tERVApKQorCQlXQVJOX09O
KHZtYS0+b2JqICYmICFpOTE1X2dlbV9vYmplY3RfaGFzX3Bpbm5lZF9wYWdlcyh2bWEtPm9iaikp
OworCXJldHVybiBfX2k5MTVfZ2d0dF9waW4odm1hLCBOVUxMLCBhbGlnbiwgZmxhZ3MsIHRydWUp
OworfQorCiBzdGF0aWMgdm9pZCBfX3ZtYV9jbG9zZShzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgc3Ry
dWN0IGludGVsX2d0ICpndCkKIHsKIAkvKgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV92bWEuaCBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmgKaW5kZXggNWIz
YTNjNjUzNDU0Li4yMjM4N2EzNjE5OTkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2k5MTVfdm1hLmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaApAQCAtMjQz
LDEyICsyNDMsMTcgQEAgaTkxNV92bWFfcGluX3d3KHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCBzdHJ1
Y3QgaTkxNV9nZW1fd3dfY3R4ICp3dywKIHN0YXRpYyBpbmxpbmUgaW50IF9fbXVzdF9jaGVjawog
aTkxNV92bWFfcGluKHN0cnVjdCBpOTE1X3ZtYSAqdm1hLCB1NjQgc2l6ZSwgdTY0IGFsaWdubWVu
dCwgdTY0IGZsYWdzKQogeworI2lmZGVmIENPTkZJR19MT0NLREVQCisJV0FSTl9PTl9PTkNFKHZt
YS0+cmVzdiAmJiBkbWFfcmVzdl9oZWxkKHZtYS0+cmVzdikpOworI2VuZGlmCiAJcmV0dXJuIGk5
MTVfdm1hX3Bpbl93dyh2bWEsIE5VTEwsIHNpemUsIGFsaWdubWVudCwgZmxhZ3MpOwogfQogCiBp
bnQgaTkxNV9nZ3R0X3BpbihzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgc3RydWN0IGk5MTVfZ2VtX3d3
X2N0eCAqd3csCiAJCSAgdTMyIGFsaWduLCB1bnNpZ25lZCBpbnQgZmxhZ3MpOwogCitpbnQgaTkx
NV9nZ3R0X3Bpbl91bmxvY2tlZChzdHJ1Y3QgaTkxNV92bWEgKnZtYSwgdTMyIGFsaWduLCB1bnNp
Z25lZCBpbnQgZmxhZ3MpOworCiBzdGF0aWMgaW5saW5lIGludCBpOTE1X3ZtYV9waW5fY291bnQo
Y29uc3Qgc3RydWN0IGk5MTVfdm1hICp2bWEpCiB7CiAJcmV0dXJuIGF0b21pY19yZWFkKCZ2bWEt
PmZsYWdzKSAmIEk5MTVfVk1BX1BJTl9NQVNLOwotLSAKMi4yNi4yCgpfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRy
aS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5v
cmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
