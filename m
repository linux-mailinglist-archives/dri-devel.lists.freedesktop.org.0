Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C6E61346408
	for <lists+dri-devel@lfdr.de>; Tue, 23 Mar 2021 16:58:49 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3582C6EC09;
	Tue, 23 Mar 2021 15:57:59 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl
 [IPv6:2a02:2308::216:3eff:fe92:dfa3])
 by gabe.freedesktop.org (Postfix) with ESMTPS id BFA1E6EBFB
 for <dri-devel@lists.freedesktop.org>; Tue, 23 Mar 2021 15:57:42 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [PATCH v9 28/70] drm/i915: Take obj lock around set_domain ioctl
Date: Tue, 23 Mar 2021 16:50:17 +0100
Message-Id: <20210323155059.628690-29-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.31.0
In-Reply-To: <20210323155059.628690-1-maarten.lankhorst@linux.intel.com>
References: <20210323155059.628690-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>,
 dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2UgbmVlZCB0byBsb2NrIHRoZSBvYmplY3QgdG8gbW92ZSBpdCB0byB0aGUgY29ycmVjdCBkb21h
aW4sCmFkZCB0aGUgbWlzc2luZyBsb2NrLgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5raG9y
c3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFRob21h
cyBIZWxsc3Ryw7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNvbT4KLS0tCiBkcml2
ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZG9tYWluLmMgfCA0MSArKysrKysrKysrLS0t
LS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTkgaW5zZXJ0aW9ucygrKSwgMjIgZGVsZXRpb25z
KC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2RvbWFp
bi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2RvbWFpbi5jCmluZGV4IDQx
ZGFlMGQ4M2RiYi4uZTM1Mzc5MjIxODNiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fZG9tYWluLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5
MTVfZ2VtX2RvbWFpbi5jCkBAIC00NTYsMTMgKzQ1Niw3IEBAIGk5MTVfZ2VtX3NldF9kb21haW5f
aW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJICogdXNlcnB0ciB2
YWxpZGl0eQogCQkgKi8KIAkJZXJyID0gaTkxNV9nZW1fb2JqZWN0X3VzZXJwdHJfdmFsaWRhdGUo
b2JqKTsKLQkJaWYgKCFlcnIpCi0JCQllcnIgPSBpOTE1X2dlbV9vYmplY3Rfd2FpdChvYmosCi0J
CQkJCQkgICBJOTE1X1dBSVRfSU5URVJSVVBUSUJMRSB8Ci0JCQkJCQkgICBJOTE1X1dBSVRfUFJJ
T1JJVFkgfAotCQkJCQkJICAgKHdyaXRlX2RvbWFpbiA/IEk5MTVfV0FJVF9BTEwgOiAwKSwKLQkJ
CQkJCSAgIE1BWF9TQ0hFRFVMRV9USU1FT1VUKTsKLQkJZ290byBvdXQ7CisJCWdvdG8gb3V0X3dh
aXQ7CiAJfQogCiAJLyoKQEAgLTQ3Niw2ICs0NzAsMTAgQEAgaTkxNV9nZW1fc2V0X2RvbWFpbl9p
b2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCQlnb3RvIG91dDsKIAl9
CiAKKwllcnIgPSBpOTE1X2dlbV9vYmplY3RfbG9ja19pbnRlcnJ1cHRpYmxlKG9iaiwgTlVMTCk7
CisJaWYgKGVycikKKwkJZ290byBvdXQ7CisKIAkvKgogCSAqIEZsdXNoIGFuZCBhY3F1aXJlIG9i
ai0+cGFnZXMgc28gdGhhdCB3ZSBhcmUgY29oZXJlbnQgdGhyb3VnaAogCSAqIGRpcmVjdCBhY2Nl
c3MgaW4gbWVtb3J5IHdpdGggcHJldmlvdXMgY2FjaGVkIHdyaXRlcyB0aHJvdWdoCkBAIC00ODcs
NyArNDg1LDcgQEAgaTkxNV9nZW1fc2V0X2RvbWFpbl9pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAq
ZGV2LCB2b2lkICpkYXRhLAogCSAqLwogCWVyciA9IGk5MTVfZ2VtX29iamVjdF9waW5fcGFnZXMo
b2JqKTsKIAlpZiAoZXJyKQotCQlnb3RvIG91dDsKKwkJZ290byBvdXRfdW5sb2NrOwogCiAJLyoK
IAkgKiBBbHJlYWR5IGluIHRoZSBkZXNpcmVkIHdyaXRlIGRvbWFpbj8gTm90aGluZyBmb3IgdXMg
dG8gZG8hCkBAIC01MDAsMTAgKzQ5OCw2IEBAIGk5MTVfZ2VtX3NldF9kb21haW5faW9jdGwoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkgKiB3aXRob3V0IGhhdmluZyB0byBm
dXJ0aGVyIGNoZWNrIHRoZSByZXF1ZXN0ZWQgd3JpdGVfZG9tYWluLgogCSAqLwogCWlmIChSRUFE
X09OQ0Uob2JqLT53cml0ZV9kb21haW4pID09IHJlYWRfZG9tYWlucykKLQkJZ290byBvdXRfd2Fp
dDsKLQotCWVyciA9IGk5MTVfZ2VtX29iamVjdF9sb2NrX2ludGVycnVwdGlibGUob2JqLCBOVUxM
KTsKLQlpZiAoZXJyKQogCQlnb3RvIG91dF91bnBpbjsKIAogCWlmIChyZWFkX2RvbWFpbnMgJiBJ
OTE1X0dFTV9ET01BSU5fV0MpCkBAIC01MTMsMTkgKzUwNywyMiBAQCBpOTE1X2dlbV9zZXRfZG9t
YWluX2lvY3RsKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAJZWxzZQogCQlp
OTE1X2dlbV9vYmplY3Rfc2V0X3RvX2NwdV9kb21haW4ob2JqLCB3cml0ZV9kb21haW4pOwogCi0J
aTkxNV9nZW1fb2JqZWN0X3VubG9jayhvYmopOworb3V0X3VucGluOgorCWk5MTVfZ2VtX29iamVj
dF91bnBpbl9wYWdlcyhvYmopOwogCitvdXRfdW5sb2NrOgorCWk5MTVfZ2VtX29iamVjdF91bmxv
Y2sob2JqKTsKIG91dF93YWl0OgotCWVyciA9IGk5MTVfZ2VtX29iamVjdF93YWl0KG9iaiwKLQkJ
CQkgICBJOTE1X1dBSVRfSU5URVJSVVBUSUJMRSB8Ci0JCQkJICAgSTkxNV9XQUlUX1BSSU9SSVRZ
IHwKLQkJCQkgICAod3JpdGVfZG9tYWluID8gSTkxNV9XQUlUX0FMTCA6IDApLAotCQkJCSAgIE1B
WF9TQ0hFRFVMRV9USU1FT1VUKTsKLQlpZiAod3JpdGVfZG9tYWluKQotCQlpOTE1X2dlbV9vYmpl
Y3RfaW52YWxpZGF0ZV9mcm9udGJ1ZmZlcihvYmosIE9SSUdJTl9DUFUpOworCWlmICghZXJyKSB7
CisJCWVyciA9IGk5MTVfZ2VtX29iamVjdF93YWl0KG9iaiwKKwkJCQkJICBJOTE1X1dBSVRfSU5U
RVJSVVBUSUJMRSB8CisJCQkJCSAgSTkxNV9XQUlUX1BSSU9SSVRZIHwKKwkJCQkJICAod3JpdGVf
ZG9tYWluID8gSTkxNV9XQUlUX0FMTCA6IDApLAorCQkJCQkgIE1BWF9TQ0hFRFVMRV9USU1FT1VU
KTsKKwkJaWYgKHdyaXRlX2RvbWFpbikKKwkJCWk5MTVfZ2VtX29iamVjdF9pbnZhbGlkYXRlX2Zy
b250YnVmZmVyKG9iaiwgT1JJR0lOX0NQVSk7CisJfQogCi1vdXRfdW5waW46Ci0JaTkxNV9nZW1f
b2JqZWN0X3VucGluX3BhZ2VzKG9iaik7CiBvdXQ6CiAJaTkxNV9nZW1fb2JqZWN0X3B1dChvYmop
OwogCXJldHVybiBlcnI7Ci0tIAoyLjMxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3Rz
LmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xp
c3RpbmZvL2RyaS1kZXZlbAo=
