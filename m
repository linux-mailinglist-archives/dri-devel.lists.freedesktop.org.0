Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 395EB20A46
	for <lists+dri-devel@lfdr.de>; Thu, 16 May 2019 16:56:07 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 50ACC89701;
	Thu, 16 May 2019 14:56:01 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from relay12.mail.gandi.net (relay12.mail.gandi.net [217.70.178.232])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 05D96896DD
 for <dri-devel@lists.freedesktop.org>; Thu, 16 May 2019 14:55:59 +0000 (UTC)
Received: from localhost.localdomain
 (aaubervilliers-681-1-43-46.w90-88.abo.wanadoo.fr [90.88.161.46])
 (Authenticated sender: paul.kocialkowski@bootlin.com)
 by relay12.mail.gandi.net (Postfix) with ESMTPSA id 7FEF4200009;
 Thu, 16 May 2019 14:55:57 +0000 (UTC)
From: Paul Kocialkowski <paul.kocialkowski@bootlin.com>
To: dri-devel@lists.freedesktop.org,
	linux-kernel@vger.kernel.org
Subject: [PATCH v9 4/4] drm/vc4: Allocate binner bo when starting to use the
 V3D
Date: Thu, 16 May 2019 16:55:44 +0200
Message-Id: <20190516145544.29051-5-paul.kocialkowski@bootlin.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190516145544.29051-1-paul.kocialkowski@bootlin.com>
References: <20190516145544.29051-1-paul.kocialkowski@bootlin.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Maxime Ripard <maxime.ripard@bootlin.com>,
 Eben Upton <eben@raspberrypi.org>, David Airlie <airlied@linux.ie>,
 Paul Kocialkowski <paul.kocialkowski@bootlin.com>,
 Thomas Petazzoni <thomas.petazzoni@bootlin.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhlIGJpbm5lciBCTyBpcyBub3QgcmVxdWlyZWQgdW50aWwgdGhlIFYzRCBpcyBpbiB1c2UsIHNv
IGF2b2lkCmFsbG9jYXRpbmcgaXQgYXQgcHJvYmUgYW5kIGRvIGl0IG9uIHRoZSBmaXJzdCBub24t
ZHVtYiBCTyBhbGxvY2F0aW9uLgoKS2VlcCB0cmFjayBvZiB3aGljaCBjbGllbnRzIGFyZSB1c2lu
ZyB0aGUgVjNEIGFuZCBsaWJlcmF0ZSB0aGUgYnVmZmVyCndoZW4gdGhlcmUgaXMgbm9uZSBsZWZ0
LCB1c2luZyBhIGtyZWYuIFByb3RlY3QgdGhlIGxvZ2ljIHdpdGggYQptdXRleCB0byBhdm9pZCBy
YWNlIGNvbmRpdGlvbnMuCgpUaGUgYmlubmVyIEJPIGlzIGNyZWF0ZWQgYXQgdGhlIHRpbWUgb2Yg
dGhlIGZpcnN0IHJlbmRlciBpb2N0bCBhbmQgaXMKZGVzdHJveWVkIHdoZW4gdGhlcmUgaXMgbm8g
Y2xpZW50IGFuZCBubyBleGVjIGpvYiB1c2luZyBpdCBsZWZ0LgoKVGhlIE91dC1PZi1NZW1vcnkg
KE9PTSkgaW50ZXJydXB0IGFsc28gZ2V0cyBzb21lIHR3ZWFraW5nLCB0byBhdm9pZAplbmFibGlu
ZyBpdCBiZWZvcmUgaGF2aW5nIGFsbG9jYXRlZCBhIGJpbm5lciBiby4KCldlIGFsc28gd2FudCB0
byBrZWVwIHRoZSBCTyBhbGl2ZSBkdXJpbmcgcnVudGltZSBzdXNwZW5kL3Jlc3VtZSB0byBhdm9p
ZApmYWlsaW5nIHRvIGFsbG9jYXRlIGl0IGF0IHJlc3VtZS4gVGhpcyBoYXBwZW5zIHdoZW4gdGhl
IENNQSBwb29sIGlzCmZ1bGwgYXQgdGhhdCBwb2ludCBhbmQgcmVzdWx0cyBpbiBhIGhhcmQgY3Jh
c2guCgpTaWduZWQtb2ZmLWJ5OiBQYXVsIEtvY2lhbGtvd3NraSA8cGF1bC5rb2NpYWxrb3dza2lA
Ym9vdGxpbi5jb20+ClJldmlld2VkLWJ5OiBFcmljIEFuaG9sdCA8ZXJpY0BhbmhvbHQubmV0Pgot
LS0KIGRyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2JvLmMgIHwgMzEgKysrKysrKysrKysrKysrKyst
CiBkcml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9kcnYuYyB8ICA2ICsrKysKIGRyaXZlcnMvZ3B1L2Ry
bS92YzQvdmM0X2Rydi5oIHwgMTQgKysrKysrKysKIGRyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2dl
bS5jIHwgMTEgKysrKysrKwogZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfaXJxLmMgfCAyMSArKysr
KysrKy0tLS0KIGRyaXZlcnMvZ3B1L2RybS92YzQvdmM0X3YzZC5jIHwgNjIgKysrKysrKysrKysr
KysrKysrKysrKysrKysrLS0tLS0tLS0KIDYgZmlsZXMgY2hhbmdlZCwgMTI1IGluc2VydGlvbnMo
KyksIDIwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0
X2JvLmMgYi9kcml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9iby5jCmluZGV4IDg4ZWJkNjgxZDdlYi4u
MTQzNGJiODI5MjY3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9iby5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2JvLmMKQEAgLTc5OSwxMyArNzk5LDM2IEBAIHZj
NF9wcmltZV9pbXBvcnRfc2dfdGFibGUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAlyZXR1cm4g
b2JqOwogfQogCitzdGF0aWMgaW50IHZjNF9ncmFiX2Jpbl9ibyhzdHJ1Y3QgdmM0X2RldiAqdmM0
LCBzdHJ1Y3QgdmM0X2ZpbGUgKnZjNGZpbGUpCit7CisJaW50IHJldDsKKworCWlmICghdmM0LT52
M2QpCisJCXJldHVybiAtRU5PREVWOworCisJaWYgKHZjNGZpbGUtPmJpbl9ib191c2VkKQorCQly
ZXR1cm4gMDsKKworCXJldCA9IHZjNF92M2RfYmluX2JvX2dldCh2YzQsICZ2YzRmaWxlLT5iaW5f
Ym9fdXNlZCk7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKworCXJldHVybiAwOworfQorCiBp
bnQgdmM0X2NyZWF0ZV9ib19pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRh
LAogCQkJc3RydWN0IGRybV9maWxlICpmaWxlX3ByaXYpCiB7CiAJc3RydWN0IGRybV92YzRfY3Jl
YXRlX2JvICphcmdzID0gZGF0YTsKKwlzdHJ1Y3QgdmM0X2ZpbGUgKnZjNGZpbGUgPSBmaWxlX3By
aXYtPmRyaXZlcl9wcml2OworCXN0cnVjdCB2YzRfZGV2ICp2YzQgPSB0b192YzRfZGV2KGRldik7
CiAJc3RydWN0IHZjNF9ibyAqYm8gPSBOVUxMOwogCWludCByZXQ7CiAKKwlyZXQgPSB2YzRfZ3Jh
Yl9iaW5fYm8odmM0LCB2YzRmaWxlKTsKKwlpZiAocmV0KQorCQlyZXR1cm4gcmV0OworCiAJLyoK
IAkgKiBXZSBjYW4ndCBhbGxvY2F0ZSBmcm9tIHRoZSBCTyBjYWNoZSwgYmVjYXVzZSB0aGUgQk9z
IGRvbid0CiAJICogZ2V0IHplcm9lZCwgYW5kIHRoYXQgbWlnaHQgbGVhayBkYXRhIGJldHdlZW4g
dXNlcnMuCkBAIC04NDYsNiArODY5LDggQEAgdmM0X2NyZWF0ZV9zaGFkZXJfYm9faW9jdGwoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJCSAgIHN0cnVjdCBkcm1fZmlsZSAq
ZmlsZV9wcml2KQogewogCXN0cnVjdCBkcm1fdmM0X2NyZWF0ZV9zaGFkZXJfYm8gKmFyZ3MgPSBk
YXRhOworCXN0cnVjdCB2YzRfZmlsZSAqdmM0ZmlsZSA9IGZpbGVfcHJpdi0+ZHJpdmVyX3ByaXY7
CisJc3RydWN0IHZjNF9kZXYgKnZjNCA9IHRvX3ZjNF9kZXYoZGV2KTsKIAlzdHJ1Y3QgdmM0X2Jv
ICpibyA9IE5VTEw7CiAJaW50IHJldDsKIApAQCAtODY1LDYgKzg5MCwxMCBAQCB2YzRfY3JlYXRl
X3NoYWRlcl9ib19pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCQly
ZXR1cm4gLUVJTlZBTDsKIAl9CiAKKwlyZXQgPSB2YzRfZ3JhYl9iaW5fYm8odmM0LCB2YzRmaWxl
KTsKKwlpZiAocmV0KQorCQlyZXR1cm4gcmV0OworCiAJYm8gPSB2YzRfYm9fY3JlYXRlKGRldiwg
YXJncy0+c2l6ZSwgdHJ1ZSwgVkM0X0JPX1RZUEVfVjNEX1NIQURFUik7CiAJaWYgKElTX0VSUihi
bykpCiAJCXJldHVybiBQVFJfRVJSKGJvKTsKQEAgLTg5NCw3ICs5MjMsNyBAQCB2YzRfY3JlYXRl
X3NoYWRlcl9ib19pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCSAq
LwogCXJldCA9IGRybV9nZW1faGFuZGxlX2NyZWF0ZShmaWxlX3ByaXYsICZiby0+YmFzZS5iYXNl
LCAmYXJncy0+aGFuZGxlKTsKIAotIGZhaWw6CitmYWlsOgogCWRybV9nZW1fb2JqZWN0X3B1dF91
bmxvY2tlZCgmYm8tPmJhc2UuYmFzZSk7CiAKIAlyZXR1cm4gcmV0OwpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2LmMgYi9kcml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9kcnYu
YwppbmRleCA2ZDliZTIwYTMyYmUuLjBmOTlhZDAzNjE0ZSAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL3ZjNC92YzRfZHJ2LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2LmMK
QEAgLTEyOCw4ICsxMjgsMTIgQEAgc3RhdGljIGludCB2YzRfb3BlbihzdHJ1Y3QgZHJtX2Rldmlj
ZSAqZGV2LCBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGUpCiAKIHN0YXRpYyB2b2lkIHZjNF9jbG9zZShz
dHJ1Y3QgZHJtX2RldmljZSAqZGV2LCBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGUpCiB7CisJc3RydWN0
IHZjNF9kZXYgKnZjNCA9IHRvX3ZjNF9kZXYoZGV2KTsKIAlzdHJ1Y3QgdmM0X2ZpbGUgKnZjNGZp
bGUgPSBmaWxlLT5kcml2ZXJfcHJpdjsKIAorCWlmICh2YzRmaWxlLT5iaW5fYm9fdXNlZCkKKwkJ
dmM0X3YzZF9iaW5fYm9fcHV0KHZjNCk7CisKIAl2YzRfcGVyZm1vbl9jbG9zZV9maWxlKHZjNGZp
bGUpOwogCWtmcmVlKHZjNGZpbGUpOwogfQpAQCAtMjc0LDYgKzI3OCw4IEBAIHN0YXRpYyBpbnQg
dmM0X2RybV9iaW5kKHN0cnVjdCBkZXZpY2UgKmRldikKIAlkcm0tPmRldl9wcml2YXRlID0gdmM0
OwogCUlOSVRfTElTVF9IRUFEKCZ2YzQtPmRlYnVnZnNfbGlzdCk7CiAKKwltdXRleF9pbml0KCZ2
YzQtPmJpbl9ib19sb2NrKTsKKwogCXJldCA9IHZjNF9ib19jYWNoZV9pbml0KGRybSk7CiAJaWYg
KHJldCkKIAkJZ290byBkZXZfcHV0OwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZjNC92
YzRfZHJ2LmggYi9kcml2ZXJzL2dwdS9kcm0vdmM0L3ZjNF9kcnYuaAppbmRleCA0ZjEzZjYyNjI0
OTEuLjkxNzBhMjRlYzVmNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2
LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZHJ2LmgKQEAgLTIxNiw2ICsyMTYsMTEg
QEAgc3RydWN0IHZjNF9kZXYgewogCSAqIHRoZSBtaW5vciBpcyBhdmFpbGFibGUgKGFmdGVyIGRy
bV9kZXZfcmVnaXN0ZXIoKSkuCiAJICovCiAJc3RydWN0IGxpc3RfaGVhZCBkZWJ1Z2ZzX2xpc3Q7
CisKKwkvKiBNdXRleCBmb3IgYmlubmVyIGJvIGFsbG9jYXRpb24uICovCisJc3RydWN0IG11dGV4
IGJpbl9ib19sb2NrOworCS8qIFJlZmVyZW5jZSBjb3VudCBmb3Igb3VyIGJpbm5lciBiby4gKi8K
KwlzdHJ1Y3Qga3JlZiBiaW5fYm9fa3JlZjsKIH07CiAKIHN0YXRpYyBpbmxpbmUgc3RydWN0IHZj
NF9kZXYgKgpAQCAtNTg0LDYgKzU4OSwxMSBAQCBzdHJ1Y3QgdmM0X2V4ZWNfaW5mbyB7CiAJICog
TlVMTCBvdGhlcndpc2UuCiAJICovCiAJc3RydWN0IHZjNF9wZXJmbW9uICpwZXJmbW9uOworCisJ
LyogV2hldGhlciB0aGUgZXhlYyBoYXMgdGFrZW4gYSByZWZlcmVuY2UgdG8gdGhlIGJpbm5lciBC
Tywgd2hpY2ggc2hvdWxkCisJICogaGFwcGVuIHdpdGggYSBWQzRfUEFDS0VUX1RJTEVfQklOTklO
R19NT0RFX0NPTkZJRyBwYWNrZXQuCisJICovCisJYm9vbCBiaW5fYm9fdXNlZDsKIH07CiAKIC8q
IFBlci1vcGVuIGZpbGUgcHJpdmF0ZSBkYXRhLiBBbnkgZHJpdmVyLXNwZWNpZmljIHJlc291cmNl
IHRoYXQgaGFzIHRvIGJlCkBAIC01OTQsNiArNjA0LDggQEAgc3RydWN0IHZjNF9maWxlIHsKIAkJ
c3RydWN0IGlkciBpZHI7CiAJCXN0cnVjdCBtdXRleCBsb2NrOwogCX0gcGVyZm1vbjsKKworCWJv
b2wgYmluX2JvX3VzZWQ7CiB9OwogCiBzdGF0aWMgaW5saW5lIHN0cnVjdCB2YzRfZXhlY19pbmZv
ICoKQEAgLTgzMyw2ICs4NDUsOCBAQCB2b2lkIHZjNF9wbGFuZV9hc3luY19zZXRfZmIoc3RydWN0
IGRybV9wbGFuZSAqcGxhbmUsCiBleHRlcm4gc3RydWN0IHBsYXRmb3JtX2RyaXZlciB2YzRfdjNk
X2RyaXZlcjsKIGV4dGVybiBjb25zdCBzdHJ1Y3Qgb2ZfZGV2aWNlX2lkIHZjNF92M2RfZHRfbWF0
Y2hbXTsKIGludCB2YzRfdjNkX2dldF9iaW5fc2xvdChzdHJ1Y3QgdmM0X2RldiAqdmM0KTsKK2lu
dCB2YzRfdjNkX2Jpbl9ib19nZXQoc3RydWN0IHZjNF9kZXYgKnZjNCwgYm9vbCAqdXNlZCk7Cit2
b2lkIHZjNF92M2RfYmluX2JvX3B1dChzdHJ1Y3QgdmM0X2RldiAqdmM0KTsKIGludCB2YzRfdjNk
X3BtX2dldChzdHJ1Y3QgdmM0X2RldiAqdmM0KTsKIHZvaWQgdmM0X3YzZF9wbV9wdXQoc3RydWN0
IHZjNF9kZXYgKnZjNCk7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2dl
bS5jIGIvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfZ2VtLmMKaW5kZXggZDkzMTFiZTMyYTRmLi44
NDc5NWQ5MjhmMjAgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2dlbS5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2dlbS5jCkBAIC04MjAsNiArODIwLDcgQEAgc3Rh
dGljIGludAogdmM0X2dldF9iY2woc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IHZjNF9l
eGVjX2luZm8gKmV4ZWMpCiB7CiAJc3RydWN0IGRybV92YzRfc3VibWl0X2NsICphcmdzID0gZXhl
Yy0+YXJnczsKKwlzdHJ1Y3QgdmM0X2RldiAqdmM0ID0gdG9fdmM0X2RldihkZXYpOwogCXZvaWQg
KnRlbXAgPSBOVUxMOwogCXZvaWQgKmJpbjsKIAlpbnQgcmV0ID0gMDsKQEAgLTkxOCw2ICs5MTks
MTIgQEAgdmM0X2dldF9iY2woc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IHZjNF9leGVj
X2luZm8gKmV4ZWMpCiAJaWYgKHJldCkKIAkJZ290byBmYWlsOwogCisJaWYgKGV4ZWMtPmZvdW5k
X3RpbGVfYmlubmluZ19tb2RlX2NvbmZpZ19wYWNrZXQpIHsKKwkJcmV0ID0gdmM0X3YzZF9iaW5f
Ym9fZ2V0KHZjNCwgJmV4ZWMtPmJpbl9ib191c2VkKTsKKwkJaWYgKHJldCkKKwkJCWdvdG8gZmFp
bDsKKwl9CisKIAkvKiBCbG9jayB3YWl0aW5nIG9uIGFueSBwcmV2aW91cyByZW5kZXJpbmcgaW50
byB0aGUgQ1MncyBWQk8sCiAJICogSUIsIG9yIHRleHR1cmVzLCBzbyB0aGF0IHBpeGVscyBhcmUg
YWN0dWFsbHkgd3JpdHRlbiBieSB0aGUKIAkgKiB0aW1lIHdlIHRyeSB0byByZWFkIHRoZW0uCkBA
IC05NjYsNiArOTczLDEwIEBAIHZjNF9jb21wbGV0ZV9leGVjKHN0cnVjdCBkcm1fZGV2aWNlICpk
ZXYsIHN0cnVjdCB2YzRfZXhlY19pbmZvICpleGVjKQogCXZjNC0+YmluX2FsbG9jX3VzZWQgJj0g
fmV4ZWMtPmJpbl9zbG90czsKIAlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZ2YzQtPmpvYl9sb2Nr
LCBpcnFmbGFncyk7CiAKKwkvKiBSZWxlYXNlIHRoZSByZWZlcmVuY2Ugb24gdGhlIGJpbm5lciBC
TyBpZiBuZWVkZWQuICovCisJaWYgKGV4ZWMtPmJpbl9ib191c2VkKQorCQl2YzRfdjNkX2Jpbl9i
b19wdXQodmM0KTsKKwogCS8qIFJlbGVhc2UgdGhlIHJlZmVyZW5jZSB3ZSBoYWQgb24gdGhlIHBl
cmYgbW9uaXRvci4gKi8KIAl2YzRfcGVyZm1vbl9wdXQoZXhlYy0+cGVyZm1vbik7CiAKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2lycS5jIGIvZHJpdmVycy9ncHUvZHJtL3Zj
NC92YzRfaXJxLmMKaW5kZXggNzIzZGM4NmI0NTExLi5lMjI2YzI0ZTU0M2YgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS92YzQvdmM0X2lycS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS92YzQv
dmM0X2lycS5jCkBAIC01OSwxOCArNTksMjIgQEAgdmM0X292ZXJmbG93X21lbV93b3JrKHN0cnVj
dCB3b3JrX3N0cnVjdCAqd29yaykKIHsKIAlzdHJ1Y3QgdmM0X2RldiAqdmM0ID0KIAkJY29udGFp
bmVyX29mKHdvcmssIHN0cnVjdCB2YzRfZGV2LCBvdmVyZmxvd19tZW1fd29yayk7Ci0Jc3RydWN0
IHZjNF9ibyAqYm8gPSB2YzQtPmJpbl9ibzsKKwlzdHJ1Y3QgdmM0X2JvICpibzsKIAlpbnQgYmlu
X2JvX3Nsb3Q7CiAJc3RydWN0IHZjNF9leGVjX2luZm8gKmV4ZWM7CiAJdW5zaWduZWQgbG9uZyBp
cnFmbGFnczsKIAotCWlmICghYm8pCi0JCXJldHVybjsKKwltdXRleF9sb2NrKCZ2YzQtPmJpbl9i
b19sb2NrKTsKKworCWlmICghdmM0LT5iaW5fYm8pCisJCWdvdG8gY29tcGxldGU7CisKKwlibyA9
IHZjNC0+YmluX2JvOwogCiAJYmluX2JvX3Nsb3QgPSB2YzRfdjNkX2dldF9iaW5fc2xvdCh2YzQp
OwogCWlmIChiaW5fYm9fc2xvdCA8IDApIHsKIAkJRFJNX0VSUk9SKCJDb3VsZG4ndCBhbGxvY2F0
ZSBiaW5uZXIgb3ZlcmZsb3cgbWVtXG4iKTsKLQkJcmV0dXJuOworCQlnb3RvIGNvbXBsZXRlOwog
CX0KIAogCXNwaW5fbG9ja19pcnFzYXZlKCZ2YzQtPmpvYl9sb2NrLCBpcnFmbGFncyk7CkBAIC0x
MDEsNiArMTA1LDkgQEAgdmM0X292ZXJmbG93X21lbV93b3JrKHN0cnVjdCB3b3JrX3N0cnVjdCAq
d29yaykKIAlWM0RfV1JJVEUoVjNEX0lOVENUTCwgVjNEX0lOVF9PVVRPTUVNKTsKIAlWM0RfV1JJ
VEUoVjNEX0lOVEVOQSwgVjNEX0lOVF9PVVRPTUVNKTsKIAlzcGluX3VubG9ja19pcnFyZXN0b3Jl
KCZ2YzQtPmpvYl9sb2NrLCBpcnFmbGFncyk7CisKK2NvbXBsZXRlOgorCW11dGV4X3VubG9jaygm
dmM0LT5iaW5fYm9fbG9jayk7CiB9CiAKIHN0YXRpYyB2b2lkCkBAIC0yNTIsOCArMjU5LDEwIEBA
IHZjNF9pcnFfcG9zdGluc3RhbGwoc3RydWN0IGRybV9kZXZpY2UgKmRldikKIAlpZiAoIXZjNC0+
djNkKQogCQlyZXR1cm4gMDsKIAotCS8qIEVuYWJsZSBib3RoIHRoZSByZW5kZXIgZG9uZSBhbmQg
b3V0IG9mIG1lbW9yeSBpbnRlcnJ1cHRzLiAqLwotCVYzRF9XUklURShWM0RfSU5URU5BLCBWM0Rf
RFJJVkVSX0lSUVMpOworCS8qIEVuYWJsZSB0aGUgcmVuZGVyIGRvbmUgaW50ZXJydXB0cy4gVGhl
IG91dC1vZi1tZW1vcnkgaW50ZXJydXB0IGlzCisJICogZW5hYmxlZCBhcyBzb29uIGFzIHdlIGhh
dmUgYSBiaW5uZXIgQk8gYWxsb2NhdGVkLgorCSAqLworCVYzRF9XUklURShWM0RfSU5URU5BLCBW
M0RfSU5UX0ZMRE9ORSB8IFYzRF9JTlRfRlJET05FKTsKIAogCXJldHVybiAwOwogfQpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfdjNkLmMgYi9kcml2ZXJzL2dwdS9kcm0vdmM0
L3ZjNF92M2QuYwppbmRleCBjMTZkYjQ2NjVhZjYuLjg3NjFkZDI1NzgzYyAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL3ZjNC92YzRfdjNkLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZjNC92
YzRfdjNkLmMKQEAgLTI5NCw2ICsyOTQsMTQgQEAgc3RhdGljIGludCBiaW5fYm9fYWxsb2Moc3Ry
dWN0IHZjNF9kZXYgKnZjNCkKIAkJCVdBUk5fT05fT05DRShzaXplb2YodmM0LT5iaW5fYWxsb2Nf
dXNlZCkgKiA4ICE9CiAJCQkJICAgICBiby0+YmFzZS5iYXNlLnNpemUgLyB2YzQtPmJpbl9hbGxv
Y19zaXplKTsKIAorCQkJa3JlZl9pbml0KCZ2YzQtPmJpbl9ib19rcmVmKTsKKworCQkJLyogRW5h
YmxlIHRoZSBvdXQtb2YtbWVtb3J5IGludGVycnVwdCB0byBzZXQgb3VyCisJCQkgKiBuZXdseS1h
bGxvY2F0ZWQgYmlubmVyIEJPLCBwb3RlbnRpYWxseSBmcm9tIGFuCisJCQkgKiBhbHJlYWR5LXBl
bmRpbmctYnV0LW1hc2tlZCBpbnRlcnVwdC4KKwkJCSAqLworCQkJVjNEX1dSSVRFKFYzRF9JTlRF
TkEsIFYzRF9JTlRfT1VUT01FTSk7CisKIAkJCWJyZWFrOwogCQl9CiAKQEAgLTMxMyw2ICszMjEs
NDcgQEAgc3RhdGljIGludCBiaW5fYm9fYWxsb2Moc3RydWN0IHZjNF9kZXYgKnZjNCkKIAlyZXR1
cm4gcmV0OwogfQogCitpbnQgdmM0X3YzZF9iaW5fYm9fZ2V0KHN0cnVjdCB2YzRfZGV2ICp2YzQs
IGJvb2wgKnVzZWQpCit7CisJaW50IHJldCA9IDA7CisKKwltdXRleF9sb2NrKCZ2YzQtPmJpbl9i
b19sb2NrKTsKKworCWlmICh1c2VkICYmICp1c2VkKQorCQlnb3RvIGNvbXBsZXRlOworCisJaWYg
KHZjNC0+YmluX2JvKQorCQlrcmVmX2dldCgmdmM0LT5iaW5fYm9fa3JlZik7CisJZWxzZQorCQly
ZXQgPSBiaW5fYm9fYWxsb2ModmM0KTsKKworCWlmIChyZXQgPT0gMCAmJiB1c2VkKQorCQkqdXNl
ZCA9IHRydWU7CisKK2NvbXBsZXRlOgorCW11dGV4X3VubG9jaygmdmM0LT5iaW5fYm9fbG9jayk7
CisKKwlyZXR1cm4gcmV0OworfQorCitzdGF0aWMgdm9pZCBiaW5fYm9fcmVsZWFzZShzdHJ1Y3Qg
a3JlZiAqcmVmKQoreworCXN0cnVjdCB2YzRfZGV2ICp2YzQgPSBjb250YWluZXJfb2YocmVmLCBz
dHJ1Y3QgdmM0X2RldiwgYmluX2JvX2tyZWYpOworCisJaWYgKFdBUk5fT05fT05DRSghdmM0LT5i
aW5fYm8pKQorCQlyZXR1cm47CisKKwlkcm1fZ2VtX29iamVjdF9wdXRfdW5sb2NrZWQoJnZjNC0+
YmluX2JvLT5iYXNlLmJhc2UpOworCXZjNC0+YmluX2JvID0gTlVMTDsKK30KKwordm9pZCB2YzRf
djNkX2Jpbl9ib19wdXQoc3RydWN0IHZjNF9kZXYgKnZjNCkKK3sKKwltdXRleF9sb2NrKCZ2YzQt
PmJpbl9ib19sb2NrKTsKKwlrcmVmX3B1dCgmdmM0LT5iaW5fYm9fa3JlZiwgYmluX2JvX3JlbGVh
c2UpOworCW11dGV4X3VubG9jaygmdmM0LT5iaW5fYm9fbG9jayk7Cit9CisKICNpZmRlZiBDT05G
SUdfUE0KIHN0YXRpYyBpbnQgdmM0X3YzZF9ydW50aW1lX3N1c3BlbmQoc3RydWN0IGRldmljZSAq
ZGV2KQogewpAQCAtMzIxLDkgKzM3MCw2IEBAIHN0YXRpYyBpbnQgdmM0X3YzZF9ydW50aW1lX3N1
c3BlbmQoc3RydWN0IGRldmljZSAqZGV2KQogCiAJdmM0X2lycV91bmluc3RhbGwodmM0LT5kZXYp
OwogCi0JZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKCZ2YzQtPmJpbl9iby0+YmFzZS5iYXNl
KTsKLQl2YzQtPmJpbl9ibyA9IE5VTEw7Ci0KIAljbGtfZGlzYWJsZV91bnByZXBhcmUodjNkLT5j
bGspOwogCiAJcmV0dXJuIDA7CkBAIC0zMzUsMTAgKzM4MSw2IEBAIHN0YXRpYyBpbnQgdmM0X3Yz
ZF9ydW50aW1lX3Jlc3VtZShzdHJ1Y3QgZGV2aWNlICpkZXYpCiAJc3RydWN0IHZjNF9kZXYgKnZj
NCA9IHYzZC0+dmM0OwogCWludCByZXQ7CiAKLQlyZXQgPSBiaW5fYm9fYWxsb2ModmM0KTsKLQlp
ZiAocmV0KQotCQlyZXR1cm4gcmV0OwotCiAJcmV0ID0gY2xrX3ByZXBhcmVfZW5hYmxlKHYzZC0+
Y2xrKTsKIAlpZiAocmV0ICE9IDApCiAJCXJldHVybiByZXQ7CkBAIC00MDUsMTIgKzQ0Nyw2IEBA
IHN0YXRpYyBpbnQgdmM0X3YzZF9iaW5kKHN0cnVjdCBkZXZpY2UgKmRldiwgc3RydWN0IGRldmlj
ZSAqbWFzdGVyLCB2b2lkICpkYXRhKQogCWlmIChyZXQgIT0gMCkKIAkJcmV0dXJuIHJldDsKIAot
CXJldCA9IGJpbl9ib19hbGxvYyh2YzQpOwotCWlmIChyZXQpIHsKLQkJY2xrX2Rpc2FibGVfdW5w
cmVwYXJlKHYzZC0+Y2xrKTsKLQkJcmV0dXJuIHJldDsKLQl9Ci0KIAkvKiBSZXNldCB0aGUgYmlu
bmVyIG92ZXJmbG93IGFkZHJlc3Mvc2l6ZSBhdCBzZXR1cCwgdG8gYmUgc3VyZQogCSAqIHdlIGRv
bid0IHJldXNlIGFuIG9sZCBvbmUuCiAJICovCi0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJp
LWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
