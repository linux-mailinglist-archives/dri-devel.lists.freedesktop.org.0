Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 0362F1079D0
	for <lists+dri-devel@lfdr.de>; Fri, 22 Nov 2019 22:09:41 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id DA7C06F58C;
	Fri, 22 Nov 2019 21:09:08 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 28D386F575;
 Fri, 22 Nov 2019 21:09:02 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 22 Nov 2019 13:09:01 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,231,1571727600"; d="scan'208";a="205575866"
Received: from nvishwa1-desk.sc.intel.com ([10.3.160.185])
 by fmsmga007.fm.intel.com with ESMTP; 22 Nov 2019 13:09:00 -0800
From: Niranjana Vishwanathapura <niranjana.vishwanathapura@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [RFC 09/13] drm/i915/svm: Page copy support during migration
Date: Fri, 22 Nov 2019 12:57:30 -0800
Message-Id: <20191122205734.15925-10-niranjana.vishwanathapura@intel.com>
X-Mailer: git-send-email 2.21.0.rc0.32.g243a4c7e27
In-Reply-To: <20191122205734.15925-1-niranjana.vishwanathapura@intel.com>
References: <20191122205734.15925-1-niranjana.vishwanathapura@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: sanjay.k.kumar@intel.com, sudeep.dutt@intel.com,
 dri-devel@lists.freedesktop.org, dave.hansen@intel.com, jglisse@redhat.com,
 jon.bloomfield@intel.com, daniel.vetter@intel.com, dan.j.williams@intel.com,
 ira.weiny@intel.com, jgg@mellanox.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

Q29weSB0aGUgcGFnZXMgZHVpbmcgU1ZNIG1pZ3JhdGlvbiB1c2luZyBtZW1jcHkoKS4KCkNjOiBK
b29uYXMgTGFodGluZW4gPGpvb25hcy5sYWh0aW5lbkBsaW51eC5pbnRlbC5jb20+CkNjOiBKb24g
Qmxvb21maWVsZCA8am9uLmJsb29tZmllbGRAaW50ZWwuY29tPgpDYzogRGFuaWVsIFZldHRlciA8
ZGFuaWVsLnZldHRlckBpbnRlbC5jb20+CkNjOiBTdWRlZXAgRHV0dCA8c3VkZWVwLmR1dHRAaW50
ZWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBOaXJhbmphbmEgVmlzaHdhbmF0aGFwdXJhIDxuaXJhbmph
bmEudmlzaHdhbmF0aGFwdXJhQGludGVsLmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9p
OTE1X3N2bV9kZXZtZW0uYyB8IDcyICsrKysrKysrKysrKysrKysrKysrKysrKysrCiAxIGZpbGUg
Y2hhbmdlZCwgNzIgaW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfc3ZtX2Rldm1lbS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9zdm1fZGV2
bWVtLmMKaW5kZXggMzdhMjA1ZDNhODJmLi45NjBiMDQwOTFlNDQgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfc3ZtX2Rldm1lbS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9p
OTE1L2k5MTVfc3ZtX2Rldm1lbS5jCkBAIC0xNDIsNiArMTQyLDY5IEBAIGk5MTVfZGV2bWVtX3Bh
Z2VfZnJlZV9sb2NrZWQoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2LAogCXB1dF9w
YWdlKHBhZ2UpOwogfQogCitzdGF0aWMgaW50IGk5MTVfbWlncmF0ZV9jcHVfY29weShzdHJ1Y3Qg
aTkxNV9kZXZtZW1fbWlncmF0ZSAqbWlncmF0ZSkKK3sKKwljb25zdCB1bnNpZ25lZCBsb25nICpz
cmMgPSBtaWdyYXRlLT5hcmdzLT5zcmM7CisJdW5zaWduZWQgbG9uZyAqZHN0ID0gbWlncmF0ZS0+
YXJncy0+ZHN0OworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gbWlncmF0ZS0+aTkx
NTsKKwlzdHJ1Y3QgaW50ZWxfbWVtb3J5X3JlZ2lvbiAqbWVtOworCXZvaWQgKnNyY192YWRkciwg
KmRzdF92YWRkcjsKKwl1NjQgc3JjX2FkZHIsIGRzdF9hZGRyOworCXN0cnVjdCBwYWdlICpwYWdl
OworCWludCBpLCByZXQgPSAwOworCisJLyogWFhYOiBDb3B5IG11bHRpcGxlIHBhZ2VzIGF0IGEg
dGltZSAqLworCWZvciAoaSA9IDA7ICFyZXQgJiYgaSA8IG1pZ3JhdGUtPm5wYWdlczsgaSsrKSB7
CisJCWlmICghZHN0W2ldKQorCQkJY29udGludWU7CisKKwkJcGFnZSA9IG1pZ3JhdGVfcGZuX3Rv
X3BhZ2UoZHN0W2ldKTsKKwkJbWVtID0gaTkxNS0+bW0ucmVnaW9uc1ttaWdyYXRlLT5kc3RfaWRd
OworCQlkc3RfYWRkciA9IHBhZ2VfdG9fcGZuKHBhZ2UpOworCQlpZiAobWlncmF0ZS0+ZHN0X2lk
ICE9IElOVEVMX1JFR0lPTl9TTUVNKQorCQkJZHN0X2FkZHIgLT0gbWVtLT5kZXZtZW0tPnBmbl9m
aXJzdDsKKwkJZHN0X2FkZHIgPDw9IFBBR0VfU0hJRlQ7CisKKwkJaWYgKG1pZ3JhdGUtPmRzdF9p
ZCA9PSBJTlRFTF9SRUdJT05fU01FTSkKKwkJCWRzdF92YWRkciA9IHBoeXNfdG9fdmlydChkc3Rf
YWRkcik7CisJCWVsc2UKKwkJCWRzdF92YWRkciA9IGlvX21hcHBpbmdfbWFwX2F0b21pY193Yygm
bWVtLT5pb21hcCwKKwkJCQkJCQkgICAgIGRzdF9hZGRyKTsKKwkJaWYgKHVubGlrZWx5KCFkc3Rf
dmFkZHIpKQorCQkJcmV0dXJuIC1FTk9NRU07CisKKwkJcGFnZSA9IG1pZ3JhdGVfcGZuX3RvX3Bh
Z2Uoc3JjW2ldKTsKKwkJbWVtID0gaTkxNS0+bW0ucmVnaW9uc1ttaWdyYXRlLT5zcmNfaWRdOwor
CQlzcmNfYWRkciA9IHBhZ2VfdG9fcGZuKHBhZ2UpOworCQlpZiAobWlncmF0ZS0+c3JjX2lkICE9
IElOVEVMX1JFR0lPTl9TTUVNKQorCQkJc3JjX2FkZHIgLT0gbWVtLT5kZXZtZW0tPnBmbl9maXJz
dDsKKwkJc3JjX2FkZHIgPDw9IFBBR0VfU0hJRlQ7CisKKwkJaWYgKG1pZ3JhdGUtPnNyY19pZCA9
PSBJTlRFTF9SRUdJT05fU01FTSkKKwkJCXNyY192YWRkciA9IHBoeXNfdG9fdmlydChzcmNfYWRk
cik7CisJCWVsc2UKKwkJCXNyY192YWRkciA9IGlvX21hcHBpbmdfbWFwX2F0b21pY193YygmbWVt
LT5pb21hcCwKKwkJCQkJCQkgICAgIHNyY19hZGRyKTsKKworCQlpZiAobGlrZWx5KHNyY192YWRk
cikpCisJCQltZW1jcHkoZHN0X3ZhZGRyLCBzcmNfdmFkZHIsIFBBR0VfU0laRSk7CisJCWVsc2UK
KwkJCXJldCA9IC1FTk9NRU07CisKKwkJaWYgKG1pZ3JhdGUtPmRzdF9pZCAhPSBJTlRFTF9SRUdJ
T05fU01FTSkKKwkJCWlvX21hcHBpbmdfdW5tYXBfYXRvbWljKGRzdF92YWRkcik7CisKKwkJaWYg
KG1pZ3JhdGUtPnNyY19pZCAhPSBJTlRFTF9SRUdJT05fU01FTSAmJiBzcmNfdmFkZHIpCisJCQlp
b19tYXBwaW5nX3VubWFwX2F0b21pYyhzcmNfdmFkZHIpOworCisJCURSTV9ERUJVR19EUklWRVIo
InNyYyBbJWRdIDB4JWxseCwgZHN0IFslZF0gMHglbGx4XG4iLAorCQkJCSBtaWdyYXRlLT5zcmNf
aWQsIHNyY19hZGRyLAorCQkJCSBtaWdyYXRlLT5kc3RfaWQsIGRzdF9hZGRyKTsKKwl9CisKKwly
ZXR1cm4gcmV0OworfQorCiBzdGF0aWMgaW50CiBpOTE1X2Rldm1lbV9taWdyYXRlX2FsbG9jX2Fu
ZF9jb3B5KHN0cnVjdCBpOTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRlKQogewpAQCAtMjAxLDYg
KzI2NCw4IEBAIGk5MTVfZGV2bWVtX21pZ3JhdGVfYWxsb2NfYW5kX2NvcHkoc3RydWN0IGk5MTVf
ZGV2bWVtX21pZ3JhdGUgKm1pZ3JhdGUpCiAKIAkvKiBDb3B5IHRoZSBwYWdlcyAqLwogCW1pZ3Jh
dGUtPm5wYWdlcyA9IG5wYWdlczsKKwkvKiBYWFg6IEZsdXNoIHRoZSBjYWNoZXM/ICovCisJcmV0
ID0gaTkxNV9taWdyYXRlX2NwdV9jb3B5KG1pZ3JhdGUpOwogbWlncmF0ZV9vdXQ6CiAJaWYgKHVu
bGlrZWx5KHJldCkpIHsKIAkJZm9yIChpID0gMDsgaSA8IG5wYWdlczsgaSsrKSB7CkBAIC0yODYs
NiArMzUxLDcgQEAgaTkxNV9kZXZtZW1fZmF1bHRfYWxsb2NfYW5kX2NvcHkoc3RydWN0IGk5MTVf
ZGV2bWVtX21pZ3JhdGUgKm1pZ3JhdGUpCiAJc3RydWN0IGRldmljZSAqZGV2ID0gbWlncmF0ZS0+
aTkxNS0+ZHJtLmRldjsKIAlzdHJ1Y3QgbWlncmF0ZV92bWEgKmFyZ3MgPSBtaWdyYXRlLT5hcmdz
OwogCXN0cnVjdCBwYWdlICpkcGFnZSwgKnNwYWdlOworCWludCBlcnI7CiAKIAlEUk1fREVCVUdf
RFJJVkVSKCJzdGFydCAweCVseFxuIiwgYXJncy0+c3RhcnQpOwogCS8qIEFsbG9jYXRlIGhvc3Qg
cGFnZSAqLwpAQCAtMzAyLDYgKzM2OCwxMiBAQCBpOTE1X2Rldm1lbV9mYXVsdF9hbGxvY19hbmRf
Y29weShzdHJ1Y3QgaTkxNV9kZXZtZW1fbWlncmF0ZSAqbWlncmF0ZSkKIAogCS8qIENvcHkgdGhl
IHBhZ2VzICovCiAJbWlncmF0ZS0+bnBhZ2VzID0gMTsKKwllcnIgPSBpOTE1X21pZ3JhdGVfY3B1
X2NvcHkobWlncmF0ZSk7CisJaWYgKHVubGlrZWx5KGVycikpIHsKKwkJX19mcmVlX3BhZ2UoZHBh
Z2UpOworCQlhcmdzLT5kc3RbMF0gPSAwOworCQlyZXR1cm4gVk1fRkFVTFRfU0lHQlVTOworCX0K
IAogCXJldHVybiAwOwogfQotLSAKMi4yMS4wLnJjMC4zMi5nMjQzYTRjN2UyNwoKX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcg
bGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRl
c2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
