Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 9353E1079C9
	for <lists+dri-devel@lfdr.de>; Fri, 22 Nov 2019 22:09:28 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AF82C6F584;
	Fri, 22 Nov 2019 21:09:07 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5C3CF6F577;
 Fri, 22 Nov 2019 21:09:02 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 22 Nov 2019 13:09:01 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,231,1571727600"; d="scan'208";a="205575871"
Received: from nvishwa1-desk.sc.intel.com ([10.3.160.185])
 by fmsmga007.fm.intel.com with ESMTP; 22 Nov 2019 13:09:00 -0800
From: Niranjana Vishwanathapura <niranjana.vishwanathapura@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [RFC 11/13] drm/i915/svm: Use blitter copy for migration
Date: Fri, 22 Nov 2019 12:57:32 -0800
Message-Id: <20191122205734.15925-12-niranjana.vishwanathapura@intel.com>
X-Mailer: git-send-email 2.21.0.rc0.32.g243a4c7e27
In-Reply-To: <20191122205734.15925-1-niranjana.vishwanathapura@intel.com>
References: <20191122205734.15925-1-niranjana.vishwanathapura@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: sanjay.k.kumar@intel.com, sudeep.dutt@intel.com,
 dri-devel@lists.freedesktop.org, dave.hansen@intel.com, jglisse@redhat.com,
 jon.bloomfield@intel.com, daniel.vetter@intel.com, dan.j.williams@intel.com,
 ira.weiny@intel.com, jgg@mellanox.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VXNlIGJsaXR0ZXIgZW5naW5lIHRvIGNvcHkgcGFnZXMgZHVyaW5nIG1pZ3JhdGlvbi4KQXMgYmxp
dHRlciBjb250ZXh0IHZpcnR1YWwgYWRkcmVzcyBzcGFjZSBpcyBzaGFyZWQgd2l0aCBvdGhlciBm
bG93cywKZW5zdXJlIHZpcnR1YWwgYWRkcmVzcyBhcmUgYWxsb2NhdGVkIHByb3Blcmx5IGZyb20g
dGhhdCBhZGRyZXNzIHNwYWNlLgpBbHNvIGVuc3VyZSBjb21wbGV0aW9uIG9mIGJsaXR0ZXIgY29w
eSBieSB3YWl0aW5nIG9uIHRoZSBmZW5jZSBvZiB0aGUKaXNzdWVkIHJlcXVlc3QuCgpDYzogSm9v
bmFzIExhaHRpbmVuIDxqb29uYXMubGFodGluZW5AbGludXguaW50ZWwuY29tPgpDYzogSm9uIEJs
b29tZmllbGQgPGpvbi5ibG9vbWZpZWxkQGludGVsLmNvbT4KQ2M6IERhbmllbCBWZXR0ZXIgPGRh
bmllbC52ZXR0ZXJAaW50ZWwuY29tPgpDYzogU3VkZWVwIER1dHQgPHN1ZGVlcC5kdXR0QGludGVs
LmNvbT4KU2lnbmVkLW9mZi1ieTogTmlyYW5qYW5hIFZpc2h3YW5hdGhhcHVyYSA8bmlyYW5qYW5h
LnZpc2h3YW5hdGhhcHVyYUBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkx
NV9zdm1fZGV2bWVtLmMgfCAyNDkgKysrKysrKysrKysrKysrKysrKysrKysrLQogMSBmaWxlIGNo
YW5nZWQsIDI0NSBpbnNlcnRpb25zKCspLCA0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3ZtX2Rldm1lbS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5
MTUvaTkxNV9zdm1fZGV2bWVtLmMKaW5kZXggOTYwYjA0MDkxZTQ0Li40Zjc3Mjk4MzY3OWIgMTAw
NjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3ZtX2Rldm1lbS5jCisrKyBiL2Ry
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3ZtX2Rldm1lbS5jCkBAIC0xNSw3ICsxNSwxNSBAQCBz
dHJ1Y3QgaTkxNV9kZXZtZW1fbWlncmF0ZSB7CiAKIAllbnVtIGludGVsX3JlZ2lvbl9pZCBzcmNf
aWQ7CiAJZW51bSBpbnRlbF9yZWdpb25faWQgZHN0X2lkOworCWRtYV9hZGRyX3QgKmhvc3RfZG1h
OworCWJvb2wgYmxpdHRlcl9jb3B5OwogCXU2NCBucGFnZXM7CisKKwkvKiByZXF1aXJlZCBmb3Ig
YmxpdHRlciBjb3B5ICovCisJc3RydWN0IGRybV9tbV9ub2RlIHNyY19ub2RlOworCXN0cnVjdCBk
cm1fbW1fbm9kZSBkc3Rfbm9kZTsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2U7CisJc3RydWN0
IGRtYV9mZW5jZSAqZmVuY2U7CiB9OwogCiBzdHJ1Y3QgaTkxNV9kZXZtZW0gewpAQCAtMTQyLDYg
KzE1MCwxMzkgQEAgaTkxNV9kZXZtZW1fcGFnZV9mcmVlX2xvY2tlZChzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqZGV2X3ByaXYsCiAJcHV0X3BhZ2UocGFnZSk7CiB9CiAKK3N0YXRpYyBpbnQgaTkx
NV9kZXZtZW1fYmluZF9hZGRyKHN0cnVjdCBpOTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRlLAor
CQkJCSBib29sIGlzX3NyYykKK3sKKwlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4ID0gbWln
cmF0ZS0+Y2UtPmdlbV9jb250ZXh0OworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0g
bWlncmF0ZS0+aTkxNTsKKwlzdHJ1Y3QgaTkxNV9hZGRyZXNzX3NwYWNlICp2bSA9IGN0eC0+dm07
CisJc3RydWN0IGludGVsX21lbW9yeV9yZWdpb24gKm1lbTsKKwl1NjQgbnBhZ2VzID0gbWlncmF0
ZS0+bnBhZ2VzOworCWVudW0gaW50ZWxfcmVnaW9uX2lkIG1lbV9pZDsKKwlzdHJ1Y3QgZHJtX21t
X25vZGUgKm5vZGU7CisJc3RydWN0IHNjYXR0ZXJsaXN0ICpzZzsKKwl1MzIgc2dfcGFnZV9zaXpl
cyA9IDA7CisJc3RydWN0IHNnX3RhYmxlIHN0OworCXU2NCBmbGFncyA9IDA7CisJaW50IGksIHJl
dDsKKworCWlmICh1bmxpa2VseShzZ19hbGxvY190YWJsZSgmc3QsIG5wYWdlcywgR0ZQX0tFUk5F
TCkpKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWlmIChpc19zcmMpIHsKKwkJbm9kZSA9ICZtaWdy
YXRlLT5zcmNfbm9kZTsKKwkJbWVtX2lkID0gbWlncmF0ZS0+c3JjX2lkOworCQlmbGFncyB8PSBJ
OTE1X0dUVF9TVk1fUkVBRE9OTFk7CisJfSBlbHNlIHsKKwkJbm9kZSA9ICZtaWdyYXRlLT5kc3Rf
bm9kZTsKKwkJbWVtX2lkID0gbWlncmF0ZS0+ZHN0X2lkOworCX0KKworCW11dGV4X2xvY2soJnZt
LT5tdXRleCk7CisJcmV0ID0gaTkxNV9nZW1fZ3R0X2luc2VydCh2bSwgbm9kZSwgbnBhZ2VzICog
UEFHRV9TSVpFLAorCQkJCSAgSTkxNV9HVFRfUEFHRV9TSVpFXzJNLCAwLAorCQkJCSAgMCwgdm0t
PnRvdGFsLCBQSU5fVVNFUik7CisJbXV0ZXhfdW5sb2NrKCZ2bS0+bXV0ZXgpOworCWlmICh1bmxp
a2VseShyZXQpKQorCQlyZXR1cm4gcmV0OworCisJc2cgPSBOVUxMOworCXN0Lm5lbnRzID0gMDsK
KworCS8qCisJICogWFhYOiBJZiB0aGUgc291cmNlIHBhZ2UgaXMgbWlzc2luZywgc291cmNlIGl0
IGZyb20gYSB0ZW1wb3JhcnkKKwkgKiB6ZXJvIGZpbGxlZCBwYWdlLiBJZiBuZWVkZWQsIGRlc3Rp
bmF0aW9uIHBhZ2UgbWlzc2luZyBzY2VuYXJpb3MKKwkgKiBjYW4gYmUgc2ltaWxhcmx5IGhhbmRs
ZWQgYnkgZHJhaW5pbmcgZGF0YSBpbnRvIGEgdGVtcG9yYXJ5IHBhZ2UuCisJICovCisJZm9yIChp
ID0gMDsgaSA8IG5wYWdlczsgaSsrKSB7CisJCXU2NCBhZGRyOworCisJCWlmIChtZW1faWQgPT0g
SU5URUxfUkVHSU9OX1NNRU0pIHsKKwkJCWFkZHIgPSBtaWdyYXRlLT5ob3N0X2RtYVtpXTsKKwkJ
fSBlbHNlIHsKKwkJCXN0cnVjdCBwYWdlICpwYWdlOworCQkJdW5zaWduZWQgbG9uZyBtcGZuOwor
CisJCQltcGZuID0gaXNfc3JjID8gbWlncmF0ZS0+YXJncy0+c3JjW2ldIDoKKwkJCQkJbWlncmF0
ZS0+YXJncy0+ZHN0W2ldOworCQkJcGFnZSA9IG1pZ3JhdGVfcGZuX3RvX3BhZ2UobXBmbik7CisJ
CQltZW0gPSBpOTE1LT5tbS5yZWdpb25zW21lbV9pZF07CisJCQlhZGRyID0gcGFnZV90b19wZm4o
cGFnZSkgLSBtZW0tPmRldm1lbS0+cGZuX2ZpcnN0OworCQkJYWRkciA8PD0gUEFHRV9TSElGVDsK
KwkJCWFkZHIgKz0gbWVtLT5yZWdpb24uc3RhcnQ7CisJCX0KKworCQlpZiAoc2cgJiYgKGFkZHIg
PT0gKHNnX2RtYV9hZGRyZXNzKHNnKSArIHNnLT5sZW5ndGgpKSkgeworCQkJc2ctPmxlbmd0aCAr
PSBQQUdFX1NJWkU7CisJCQlzZ19kbWFfbGVuKHNnKSArPSBQQUdFX1NJWkU7CisJCQljb250aW51
ZTsKKwkJfQorCisJCWlmIChzZykKKwkJCXNnX3BhZ2Vfc2l6ZXMgfD0gc2ctPmxlbmd0aDsKKwor
CQlzZyA9ICBzZyA/IF9fc2dfbmV4dChzZykgOiBzdC5zZ2w7CisJCXNnX2RtYV9hZGRyZXNzKHNn
KSA9IGFkZHI7CisJCXNnX2RtYV9sZW4oc2cpID0gUEFHRV9TSVpFOworCQlzZy0+bGVuZ3RoID0g
UEFHRV9TSVpFOworCQlzdC5uZW50cysrOworCX0KKworCXNnX3BhZ2Vfc2l6ZXMgfD0gc2ctPmxl
bmd0aDsKKwlzZ19tYXJrX2VuZChzZyk7CisJaTkxNV9zZ190cmltKCZzdCk7CisKKwlyZXQgPSBz
dm1fYmluZF9hZGRyKHZtLCBub2RlLT5zdGFydCwgbnBhZ2VzICogUEFHRV9TSVpFLAorCQkJICAg
IGZsYWdzLCAmc3QsIHNnX3BhZ2Vfc2l6ZXMpOworCXNnX2ZyZWVfdGFibGUoJnN0KTsKKworCXJl
dHVybiByZXQ7Cit9CisKK3N0YXRpYyB2b2lkIGk5MTVfZGV2bWVtX3VuYmluZF9hZGRyKHN0cnVj
dCBpOTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRlLAorCQkJCSAgICBib29sIGlzX3NyYykKK3sK
KwlzdHJ1Y3QgaTkxNV9nZW1fY29udGV4dCAqY3R4ID0gbWlncmF0ZS0+Y2UtPmdlbV9jb250ZXh0
OworCXN0cnVjdCBpOTE1X2FkZHJlc3Nfc3BhY2UgKnZtID0gY3R4LT52bTsKKwlzdHJ1Y3QgZHJt
X21tX25vZGUgKm5vZGU7CisKKwlub2RlID0gaXNfc3JjID8gJm1pZ3JhdGUtPnNyY19ub2RlIDog
Jm1pZ3JhdGUtPmRzdF9ub2RlOworCXN2bV91bmJpbmRfYWRkcih2bSwgbm9kZS0+c3RhcnQsIG1p
Z3JhdGUtPm5wYWdlcyAqIFBBR0VfU0laRSk7CisJbXV0ZXhfbG9jaygmdm0tPm11dGV4KTsKKwlk
cm1fbW1fcmVtb3ZlX25vZGUobm9kZSk7CisJbXV0ZXhfdW5sb2NrKCZ2bS0+bXV0ZXgpOworfQor
CitzdGF0aWMgaW50IGk5MTVfbWlncmF0ZV9ibGl0dGVyX2NvcHkoc3RydWN0IGk5MTVfZGV2bWVt
X21pZ3JhdGUgKm1pZ3JhdGUpCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBt
aWdyYXRlLT5pOTE1OworCWludCByZXQ7CisKKwltaWdyYXRlLT5jZSA9IGk5MTUtPmVuZ2luZVtC
Q1MwXS0+a2VybmVsX2NvbnRleHQ7CisJcmV0ID0gaTkxNV9kZXZtZW1fYmluZF9hZGRyKG1pZ3Jh
dGUsIHRydWUpOworCWlmICh1bmxpa2VseShyZXQpKQorCQlyZXR1cm4gcmV0OworCisJcmV0ID0g
aTkxNV9kZXZtZW1fYmluZF9hZGRyKG1pZ3JhdGUsIGZhbHNlKTsKKwlpZiAodW5saWtlbHkocmV0
KSkgeworCQlpOTE1X2Rldm1lbV91bmJpbmRfYWRkcihtaWdyYXRlLCB0cnVlKTsKKwkJcmV0dXJu
IHJldDsKKwl9CisKKwlEUk1fREVCVUdfRFJJVkVSKCJucGFnZXMgJWxsZFxuIiwgbWlncmF0ZS0+
bnBhZ2VzKTsKKwlyZXQgPSBpOTE1X3N2bV9jb3B5X2JsdChtaWdyYXRlLT5jZSwKKwkJCQltaWdy
YXRlLT5zcmNfbm9kZS5zdGFydCwKKwkJCQltaWdyYXRlLT5kc3Rfbm9kZS5zdGFydCwKKwkJCQlt
aWdyYXRlLT5ucGFnZXMgKiBQQUdFX1NJWkUsCisJCQkJJm1pZ3JhdGUtPmZlbmNlKTsKKwlpZiAo
dW5saWtlbHkocmV0KSkgeworCQlpOTE1X2Rldm1lbV91bmJpbmRfYWRkcihtaWdyYXRlLCBmYWxz
ZSk7CisJCWk5MTVfZGV2bWVtX3VuYmluZF9hZGRyKG1pZ3JhdGUsIHRydWUpOworCX0KKworCXJl
dHVybiByZXQ7Cit9CisKIHN0YXRpYyBpbnQgaTkxNV9taWdyYXRlX2NwdV9jb3B5KHN0cnVjdCBp
OTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRlKQogewogCWNvbnN0IHVuc2lnbmVkIGxvbmcgKnNy
YyA9IG1pZ3JhdGUtPmFyZ3MtPnNyYzsKQEAgLTIxMCw2ICszNTEsNyBAQCBpOTE1X2Rldm1lbV9t
aWdyYXRlX2FsbG9jX2FuZF9jb3B5KHN0cnVjdCBpOTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRl
KQogewogCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gbWlncmF0ZS0+aTkxNTsKIAlz
dHJ1Y3QgbWlncmF0ZV92bWEgKmFyZ3MgPSBtaWdyYXRlLT5hcmdzOworCXN0cnVjdCBkZXZpY2Ug
KmRldiA9IGk5MTUtPmRybS5kZXY7CiAJc3RydWN0IGludGVsX21lbW9yeV9yZWdpb24gKm1lbTsK
IAlzdHJ1Y3QgbGlzdF9oZWFkIGJsb2NrcyA9IHswfTsKIAl1bnNpZ25lZCBsb25nIGksIG5wYWdl
cywgY250OwpAQCAtMjE4LDEzICszNjAsMzUgQEAgaTkxNV9kZXZtZW1fbWlncmF0ZV9hbGxvY19h
bmRfY29weShzdHJ1Y3QgaTkxNV9kZXZtZW1fbWlncmF0ZSAqbWlncmF0ZSkKIAogCW5wYWdlcyA9
IChhcmdzLT5lbmQgLSBhcmdzLT5zdGFydCkgPj4gUEFHRV9TSElGVDsKIAlEUk1fREVCVUdfRFJJ
VkVSKCJzdGFydCAweCVseCBucGFnZXMgJWxkXG4iLCBhcmdzLT5zdGFydCwgbnBhZ2VzKTsKKwkv
KgorCSAqIFhYWDogU2V0IHByb3BlciBjb25kaXRpb24gZm9yIGNwdSB2cyBibGl0dGVyIGNvcHkg
Zm9yIHBlcmZvcm1hbmNlLAorCSAqIGZ1bmN0aW9uYWxpdHkgYW5kIHRvIGF2b2lkIGFueSBkZWFk
bG9ja3MgYXJvdW5kIGJsaXR0ZXIgdXNhZ2UuCisJICovCisJbWlncmF0ZS0+YmxpdHRlcl9jb3B5
ID0gdHJ1ZTsKKworCWlmIChtaWdyYXRlLT5ibGl0dGVyX2NvcHkpIHsKKwkJLyogQWxsb2NhdGUg
c3RvcmFnZSBmb3IgRE1BIGFkZHJlc3Nlcywgc28gd2UgY2FuIHVubWFwIGxhdGVyLiAqLworCQlt
aWdyYXRlLT5ob3N0X2RtYSA9IGtjYWxsb2MobnBhZ2VzLCBzaXplb2YoKm1pZ3JhdGUtPmhvc3Rf
ZG1hKSwKKwkJCQkJICAgIEdGUF9LRVJORUwpOworCQlpZiAodW5saWtlbHkoIW1pZ3JhdGUtPmhv
c3RfZG1hKSkKKwkJCW1pZ3JhdGUtPmJsaXR0ZXJfY29weSA9IGZhbHNlOworCX0KIAotCS8qIENo
ZWNrIHNvdXJjZSBwYWdlcyAqLworCS8qIENoZWNrIGFuZCBETUEgbWFwIHNvdXJjZSBwYWdlcyAq
LwogCWZvciAoaSA9IDAsIGNudCA9IDA7IGkgPCBucGFnZXM7IGkrKykgewogCQlhcmdzLT5kc3Rb
aV0gPSAwOwogCQlwYWdlID0gbWlncmF0ZV9wZm5fdG9fcGFnZShhcmdzLT5zcmNbaV0pOwotCQlp
ZiAodW5saWtlbHkoIXBhZ2UgfHwgIShhcmdzLT5zcmNbaV0gJiBNSUdSQVRFX1BGTl9NSUdSQVRF
KSkpCisJCWlmICh1bmxpa2VseSghcGFnZSB8fCAhKGFyZ3MtPnNyY1tpXSAmIE1JR1JBVEVfUEZO
X01JR1JBVEUpKSkgeworCQkJbWlncmF0ZS0+YmxpdHRlcl9jb3B5ID0gZmFsc2U7CiAJCQljb250
aW51ZTsKKwkJfQorCisJCW1pZ3JhdGUtPmhvc3RfZG1hW2ldID0gZG1hX21hcF9wYWdlKGRldiwg
cGFnZSwgMCwgUEFHRV9TSVpFLAorCQkJCQkJICAgIFBDSV9ETUFfVE9ERVZJQ0UpOworCQlpZiAo
dW5saWtlbHkoZG1hX21hcHBpbmdfZXJyb3IoZGV2LCBtaWdyYXRlLT5ob3N0X2RtYVtpXSkpKSB7
CisJCQltaWdyYXRlLT5ibGl0dGVyX2NvcHkgPSBmYWxzZTsKKwkJCW1pZ3JhdGUtPmhvc3RfZG1h
W2ldID0gMDsKKwkJfQogCiAJCWFyZ3MtPmRzdFtpXSA9IE1JR1JBVEVfUEZOX1ZBTElEOwogCQlj
bnQrKzsKQEAgLTI0OCw2ICs0MTIsNyBAQCBpOTE1X2Rldm1lbV9taWdyYXRlX2FsbG9jX2FuZF9j
b3B5KHN0cnVjdCBpOTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRlKQogCQlwYWdlID0gaTkxNV9k
ZXZtZW1fcGFnZV9nZXRfbG9ja2VkKG1lbSwgJmJsb2Nrcyk7CiAJCWlmICh1bmxpa2VseSghcGFn
ZSkpIHsKIAkJCVdBUk4oMSwgIkZhaWxlZCB0byBnZXQgZHN0IHBhZ2VcbiIpOworCQkJbWlncmF0
ZS0+YmxpdHRlcl9jb3B5ID0gZmFsc2U7CiAJCQlhcmdzLT5kc3RbaV0gPSAwOwogCQkJY29udGlu
dWU7CiAJCX0KQEAgLTI2NSw3ICs0MzAsMTEgQEAgaTkxNV9kZXZtZW1fbWlncmF0ZV9hbGxvY19h
bmRfY29weShzdHJ1Y3QgaTkxNV9kZXZtZW1fbWlncmF0ZSAqbWlncmF0ZSkKIAkvKiBDb3B5IHRo
ZSBwYWdlcyAqLwogCW1pZ3JhdGUtPm5wYWdlcyA9IG5wYWdlczsKIAkvKiBYWFg6IEZsdXNoIHRo
ZSBjYWNoZXM/ICovCi0JcmV0ID0gaTkxNV9taWdyYXRlX2NwdV9jb3B5KG1pZ3JhdGUpOworCS8q
IFhYWDogRmFsbGJhY2sgdG8gY3B1X2NvcHkgaWYgYmxpdHRlcl9jb3B5IGZhaWxzPyAqLworCWlm
IChtaWdyYXRlLT5ibGl0dGVyX2NvcHkpCisJCXJldCA9IGk5MTVfbWlncmF0ZV9ibGl0dGVyX2Nv
cHkobWlncmF0ZSk7CisJZWxzZQorCQlyZXQgPSBpOTE1X21pZ3JhdGVfY3B1X2NvcHkobWlncmF0
ZSk7CiBtaWdyYXRlX291dDoKIAlpZiAodW5saWtlbHkocmV0KSkgewogCQlmb3IgKGkgPSAwOyBp
IDwgbnBhZ2VzOyBpKyspIHsKQEAgLTI3NywxMiArNDQ2LDQyIEBAIGk5MTVfZGV2bWVtX21pZ3Jh
dGVfYWxsb2NfYW5kX2NvcHkoc3RydWN0IGk5MTVfZGV2bWVtX21pZ3JhdGUgKm1pZ3JhdGUpCiAJ
CX0KIAl9CiAKKwlpZiAodW5saWtlbHkobWlncmF0ZS0+aG9zdF9kbWEgJiYgKCFtaWdyYXRlLT5i
bGl0dGVyX2NvcHkgfHwgcmV0KSkpIHsKKwkJZm9yIChpID0gMDsgaSA8IG5wYWdlczsgaSsrKSB7
CisJCQlpZiAobWlncmF0ZS0+aG9zdF9kbWFbaV0pCisJCQkJZG1hX3VubWFwX3BhZ2UoZGV2LCBt
aWdyYXRlLT5ob3N0X2RtYVtpXSwKKwkJCQkJICAgICAgIFBBR0VfU0laRSwgUENJX0RNQV9UT0RF
VklDRSk7CisJCX0KKwkJa2ZyZWUobWlncmF0ZS0+aG9zdF9kbWEpOworCQltaWdyYXRlLT5ob3N0
X2RtYSA9IE5VTEw7CisJfQorCiAJcmV0dXJuIHJldDsKIH0KIAogdm9pZCBpOTE1X2Rldm1lbV9t
aWdyYXRlX2ZpbmFsaXplX2FuZF9tYXAoc3RydWN0IGk5MTVfZGV2bWVtX21pZ3JhdGUgKm1pZ3Jh
dGUpCiB7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUgPSBtaWdyYXRlLT5pOTE1Owor
CXVuc2lnbmVkIGxvbmcgaTsKKwlpbnQgcmV0OworCisJaWYgKCFtaWdyYXRlLT5ibGl0dGVyX2Nv
cHkpCisJCXJldHVybjsKKwogCURSTV9ERUJVR19EUklWRVIoIm5wYWdlcyAlbGxkXG4iLCBtaWdy
YXRlLT5ucGFnZXMpOworCXJldCA9IGk5MTVfc3ZtX2NvcHlfYmx0X3dhaXQoaTkxNSwgbWlncmF0
ZS0+ZmVuY2UpOworCWlmICh1bmxpa2VseShyZXQgPCAwKSkKKwkJV0FSTigxLCAiV2FpdGluZyBm
b3IgZG1hIGZlbmNlIGZhaWxlZCAlZFxuIiwgcmV0KTsKKworCWk5MTVfZGV2bWVtX3VuYmluZF9h
ZGRyKG1pZ3JhdGUsIHRydWUpOworCWk5MTVfZGV2bWVtX3VuYmluZF9hZGRyKG1pZ3JhdGUsIGZh
bHNlKTsKKworCWZvciAoaSA9IDA7IGkgPCBtaWdyYXRlLT5ucGFnZXM7IGkrKykKKwkJZG1hX3Vu
bWFwX3BhZ2UoaTkxNS0+ZHJtLmRldiwgbWlncmF0ZS0+aG9zdF9kbWFbaV0sCisJCQkgICAgICAg
UEFHRV9TSVpFLCBQQ0lfRE1BX1RPREVWSUNFKTsKKworCWtmcmVlKG1pZ3JhdGUtPmhvc3RfZG1h
KTsKKwltaWdyYXRlLT5ob3N0X2RtYSA9IE5VTEw7CiB9CiAKIHN0YXRpYyB2b2lkIGk5MTVfZGV2
bWVtX21pZ3JhdGVfY2h1bmsoc3RydWN0IGk5MTVfZGV2bWVtX21pZ3JhdGUgKm1pZ3JhdGUpCkBA
IC0zNTQsNiArNTUzLDEyIEBAIGk5MTVfZGV2bWVtX2ZhdWx0X2FsbG9jX2FuZF9jb3B5KHN0cnVj
dCBpOTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRlKQogCWludCBlcnI7CiAKIAlEUk1fREVCVUdf
RFJJVkVSKCJzdGFydCAweCVseFxuIiwgYXJncy0+c3RhcnQpOworCS8qCisJICogWFhYOiBTZXQg
cHJvcGVyIGNvbmRpdGlvbiBmb3IgY3B1IHZzIGJsaXR0ZXIgY29weSBmb3IgcGVyZm9ybWFuY2Us
CisJICogZnVuY3Rpb25hbGl0eSBhbmQgdG8gYXZvaWQgYW55IGRlYWRsb2NrcyBhcm91bmQgYmxp
dHRlciB1c2FnZS4KKwkgKi8KKwltaWdyYXRlLT5ibGl0dGVyX2NvcHkgPSBmYWxzZTsKKwogCS8q
IEFsbG9jYXRlIGhvc3QgcGFnZSAqLwogCXNwYWdlID0gbWlncmF0ZV9wZm5fdG9fcGFnZShhcmdz
LT5zcmNbMF0pOwogCWlmICh1bmxpa2VseSghc3BhZ2UgfHwgIShhcmdzLT5zcmNbMF0gJiBNSUdS
QVRFX1BGTl9NSUdSQVRFKSkpCkBAIC0zNjQsMTIgKzU2OSwzMSBAQCBpOTE1X2Rldm1lbV9mYXVs
dF9hbGxvY19hbmRfY29weShzdHJ1Y3QgaTkxNV9kZXZtZW1fbWlncmF0ZSAqbWlncmF0ZSkKIAkJ
cmV0dXJuIFZNX0ZBVUxUX1NJR0JVUzsKIAlsb2NrX3BhZ2UoZHBhZ2UpOwogCisJLyogRE1BIG1h
cCBob3N0IHBhZ2UgKi8KKwlpZiAobWlncmF0ZS0+YmxpdHRlcl9jb3B5KSB7CisJCW1pZ3JhdGUt
Pmhvc3RfZG1hWzBdID0gZG1hX21hcF9wYWdlKGRldiwgZHBhZ2UsIDAsIFBBR0VfU0laRSwKKwkJ
CQkJCSAgICBQQ0lfRE1BX0ZST01ERVZJQ0UpOworCQlpZiAodW5saWtlbHkoZG1hX21hcHBpbmdf
ZXJyb3IoZGV2LCBtaWdyYXRlLT5ob3N0X2RtYVswXSkpKSB7CisJCQltaWdyYXRlLT5ob3N0X2Rt
YVswXSA9IDA7CisJCQllcnIgPSAtRU5PTUVNOworCQkJZ290byBmYXVsdF9vdXQ7CisJCX0KKwl9
CisKIAlhcmdzLT5kc3RbMF0gPSBtaWdyYXRlX3BmbihwYWdlX3RvX3BmbihkcGFnZSkpIHwgTUlH
UkFURV9QRk5fTE9DS0VEOwogCiAJLyogQ29weSB0aGUgcGFnZXMgKi8KIAltaWdyYXRlLT5ucGFn
ZXMgPSAxOwotCWVyciA9IGk5MTVfbWlncmF0ZV9jcHVfY29weShtaWdyYXRlKTsKKwkvKiBYWFg6
IEZhbGxiYWNrIHRvIGNwdV9jb3B5IGlmIGJsaXR0ZXJfY29weSBmYWlscz8gKi8KKwlpZiAobWln
cmF0ZS0+YmxpdHRlcl9jb3B5KQorCQllcnIgPSBpOTE1X21pZ3JhdGVfYmxpdHRlcl9jb3B5KG1p
Z3JhdGUpOworCWVsc2UKKwkJZXJyID0gaTkxNV9taWdyYXRlX2NwdV9jb3B5KG1pZ3JhdGUpOwor
ZmF1bHRfb3V0OgogCWlmICh1bmxpa2VseShlcnIpKSB7CisJCWlmIChtaWdyYXRlLT5ob3N0X2Rt
YVswXSkKKwkJCWRtYV91bm1hcF9wYWdlKGRldiwgbWlncmF0ZS0+aG9zdF9kbWFbMF0sCisJCQkJ
ICAgICAgIFBBR0VfU0laRSwgUENJX0RNQV9GUk9NREVWSUNFKTsKIAkJX19mcmVlX3BhZ2UoZHBh
Z2UpOwogCQlhcmdzLT5kc3RbMF0gPSAwOwogCQlyZXR1cm4gVk1fRkFVTFRfU0lHQlVTOwpAQCAt
MzgwLDcgKzYwNCwyMiBAQCBpOTE1X2Rldm1lbV9mYXVsdF9hbGxvY19hbmRfY29weShzdHJ1Y3Qg
aTkxNV9kZXZtZW1fbWlncmF0ZSAqbWlncmF0ZSkKIAogdm9pZCBpOTE1X2Rldm1lbV9mYXVsdF9m
aW5hbGl6ZV9hbmRfbWFwKHN0cnVjdCBpOTE1X2Rldm1lbV9taWdyYXRlICptaWdyYXRlKQogewor
CXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gbWlncmF0ZS0+aTkxNTsKKwlpbnQgZXJy
OworCiAJRFJNX0RFQlVHX0RSSVZFUigiXG4iKTsKKwlpZiAoIW1pZ3JhdGUtPmJsaXR0ZXJfY29w
eSkKKwkJcmV0dXJuOworCisJZXJyID0gaTkxNV9zdm1fY29weV9ibHRfd2FpdChpOTE1LCBtaWdy
YXRlLT5mZW5jZSk7CisJaWYgKHVubGlrZWx5KGVyciA8IDApKQorCQlXQVJOKDEsICJXYWl0aW5n
IGZvciBkbWEgZmVuY2UgZmFpbGVkICVkXG4iLCBlcnIpOworCisJaTkxNV9kZXZtZW1fdW5iaW5k
X2FkZHIobWlncmF0ZSwgdHJ1ZSk7CisJaTkxNV9kZXZtZW1fdW5iaW5kX2FkZHIobWlncmF0ZSwg
ZmFsc2UpOworCisJZG1hX3VubWFwX3BhZ2UoaTkxNS0+ZHJtLmRldiwgbWlncmF0ZS0+aG9zdF9k
bWFbMF0sCisJCSAgICAgICBQQUdFX1NJWkUsIFBDSV9ETUFfRlJPTURFVklDRSk7CiB9CiAKIHN0
YXRpYyBpbmxpbmUgc3RydWN0IGk5MTVfZGV2bWVtICpwYWdlX3RvX2Rldm1lbShzdHJ1Y3QgcGFn
ZSAqcGFnZSkKQEAgLTM5NCw2ICs2MzMsNyBAQCBzdGF0aWMgdm1fZmF1bHRfdCBpOTE1X2Rldm1l
bV9taWdyYXRlX3RvX3JhbShzdHJ1Y3Qgdm1fZmF1bHQgKnZtZikKIAlzdHJ1Y3QgZHJtX2k5MTVf
cHJpdmF0ZSAqaTkxNSA9IGRldm1lbS0+aTkxNTsKIAlzdHJ1Y3QgaTkxNV9kZXZtZW1fbWlncmF0
ZSBtaWdyYXRlID0gezB9OwogCXVuc2lnbmVkIGxvbmcgc3JjID0gMCwgZHN0ID0gMDsKKwlkbWFf
YWRkcl90IGRtYV9hZGRyID0gMDsKIAl2bV9mYXVsdF90IHJldDsKIAlzdHJ1Y3QgbWlncmF0ZV92
bWEgYXJncyA9IHsKIAkJLnZtYQkJPSB2bWYtPnZtYSwKQEAgLTQwNyw2ICs2NDcsNyBAQCBzdGF0
aWMgdm1fZmF1bHRfdCBpOTE1X2Rldm1lbV9taWdyYXRlX3RvX3JhbShzdHJ1Y3Qgdm1fZmF1bHQg
KnZtZikKIAlEUk1fREVCVUdfRFJJVkVSKCJhZGRyIDB4JWx4XG4iLCBhcmdzLnN0YXJ0KTsKIAlt
aWdyYXRlLmk5MTUgPSBpOTE1OwogCW1pZ3JhdGUuYXJncyA9ICZhcmdzOworCW1pZ3JhdGUuaG9z
dF9kbWEgPSAmZG1hX2FkZHI7CiAJbWlncmF0ZS5zcmNfaWQgPSBJTlRFTF9SRUdJT05fTE1FTTsK
IAltaWdyYXRlLmRzdF9pZCA9IElOVEVMX1JFR0lPTl9TTUVNOwogCWlmIChtaWdyYXRlX3ZtYV9z
ZXR1cCgmYXJncykgPCAwKQotLSAKMi4yMS4wLnJjMC4zMi5nMjQzYTRjN2UyNwoKX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcg
bGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRl
c2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
