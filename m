Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 466A6F1443
	for <lists+dri-devel@lfdr.de>; Wed,  6 Nov 2019 11:47:33 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1F2DF6ECC4;
	Wed,  6 Nov 2019 10:47:29 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A8B3B6ECC5
 for <dri-devel@lists.freedesktop.org>; Wed,  6 Nov 2019 10:47:26 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 275D9B03A;
 Wed,  6 Nov 2019 10:47:25 +0000 (UTC)
From: Thomas Zimmermann <tzimmermann@suse.de>
To: airlied@redhat.com, sean@poorly.run, daniel@ffwll.ch, noralf@tronnes.org,
 sam@ravnborg.org, emil.velikov@collabora.com, kraxel@redhat.com
Subject: [PATCH v2 3/4] drm/udl: Switch to SHMEM
Date: Wed,  6 Nov 2019 11:47:21 +0100
Message-Id: <20191106104722.19700-4-tzimmermann@suse.de>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191106104722.19700-1-tzimmermann@suse.de>
References: <20191106104722.19700-1-tzimmermann@suse.de>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Thomas Zimmermann <tzimmermann@suse.de>, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VWRsJ3MgR0VNIGNvZGUgYW5kIHRoZSBnZW5lcmljIFNITUVNIGFyZSBhbG1vc3QgaWRlbnRpY2Fs
LiBSZXBsYWNlCnRoZSBmb3JtZXIgd2l0aCBTSE1FTS4gVGhlIGRtYWJ1ZiBzdXBwb3J0IGluIHVk
bCBpcyBiZWluZyByZXBsYWNlZAp3aXRoIGdlbmVyaWMgR0VNIFBSSU1FIGZ1bmN0aW9ucy4KClRo
ZSBtYWluIGRpZmZlcmVuY2UgaXMgaW4gdGhlIGNhY2hpbmcgZmxhZ3MgZm9yIG1tYXAgcGFnZXMu
IEJ5CmRlZmF1bHQsIFNITUVNIGFsd2F5cyBzZXRzICh1bmNhY2hlZCkgd3JpdGUgY29tYmluaW5n
LiBJbiB1ZGwncwptZW1vcnkgbWFuYWdlbWVudCBjb2RlLCBvbmx5IGltcG9ydGVkIGJ1ZmZlcnMg
dXNlIHdyaXRlIGNvbWJpbmluZy4KTWVtb3J5IHBhZ2VzIG9mIGxvY2FsbHkgY3JlYXRlZCBidWZm
ZXIgb2JqZWN0cyBhcmUgbW1hcCdlZCB3aXRoCmNhY2hpbmcgZW5hYmxlZC4gVG8ga2VlcCB0aGUg
b3B0aW1pemF0aW9uLCB1ZGwgcHJvdmlkZXMgaXRzIG93bgptbWFwIGZ1bmN0aW9uIGZvciBHRU0g
b2JqZWN0cyB3aGVyZSBpdCBmaXhlcyB1cCB0aGUgbWFwcGluZyBmbGFncy4KCnYyOgoJLSByZW1v
dmUgb2Jzb2xldGUgY29kZSBpbiBhIHNlcGFyYXRlIHBhdGNoCgpTaWduZWQtb2ZmLWJ5OiBUaG9t
YXMgWmltbWVybWFubiA8dHppbW1lcm1hbm5Ac3VzZS5kZT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0v
dWRsL0tjb25maWcgICB8ICAxICsKIGRyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5jIHwgMjkg
KystLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9kcnYuaCB8ICAxICsKIGRy
aXZlcnMvZ3B1L2RybS91ZGwvdWRsX2ZiLmMgIHwgNjYgKysrKysrKysrKysrKysrKysrKy0tLS0t
LS0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2dlbS5jIHwgNjEgKysrKysrKysr
KysrKysrKysrKysrKysrKysrKystLS0KIDUgZmlsZXMgY2hhbmdlZCwgOTggaW5zZXJ0aW9ucygr
KSwgNjAgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3VkbC9LY29u
ZmlnIGIvZHJpdmVycy9ncHUvZHJtL3VkbC9LY29uZmlnCmluZGV4IGI0ZDE3OWI4N2YwMS4uMTQ1
YjJhOTVjZTU4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdWRsL0tjb25maWcKKysrIGIv
ZHJpdmVycy9ncHUvZHJtL3VkbC9LY29uZmlnCkBAIC01LDYgKzUsNyBAQCBjb25maWcgRFJNX1VE
TAogCWRlcGVuZHMgb24gVVNCX1NVUFBPUlQKIAlkZXBlbmRzIG9uIFVTQl9BUkNIX0hBU19IQ0QK
IAlzZWxlY3QgVVNCCisJc2VsZWN0IERSTV9HRU1fU0hNRU1fSEVMUEVSCiAJc2VsZWN0IERSTV9L
TVNfSEVMUEVSCiAJaGVscAogCSAgVGhpcyBpcyBhIEtNUyBkcml2ZXIgZm9yIHRoZSBVU0IgZGlz
cGxheWxpbmsgdmlkZW8gYWRhcHRlcnMuCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdWRs
L3VkbF9kcnYuYyBiL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5jCmluZGV4IDc3OGEwYjY1
MmY2NC4uNTYzY2M1ODA5ZTU2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9k
cnYuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9kcnYuYwpAQCAtOCw2ICs4LDcgQEAK
ICNpbmNsdWRlIDxkcm0vZHJtX2NydGNfaGVscGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9kcnYu
aD4KICNpbmNsdWRlIDxkcm0vZHJtX2ZpbGUuaD4KKyNpbmNsdWRlIDxkcm0vZHJtX2dlbV9zaG1l
bV9oZWxwZXIuaD4KICNpbmNsdWRlIDxkcm0vZHJtX2lvY3RsLmg+CiAjaW5jbHVkZSA8ZHJtL2Ry
bV9wcm9iZV9oZWxwZXIuaD4KICNpbmNsdWRlIDxkcm0vZHJtX3ByaW50Lmg+CkBAIC0zMiwyMyAr
MzMsNyBAQCBzdGF0aWMgaW50IHVkbF91c2JfcmVzdW1lKHN0cnVjdCB1c2JfaW50ZXJmYWNlICpp
bnRlcmZhY2UpCiAJcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyBjb25zdCBzdHJ1Y3Qgdm1fb3BlcmF0
aW9uc19zdHJ1Y3QgdWRsX2dlbV92bV9vcHMgPSB7Ci0JLmZhdWx0ID0gdWRsX2dlbV9mYXVsdCwK
LQkub3BlbiA9IGRybV9nZW1fdm1fb3BlbiwKLQkuY2xvc2UgPSBkcm1fZ2VtX3ZtX2Nsb3NlLAot
fTsKLQotc3RhdGljIGNvbnN0IHN0cnVjdCBmaWxlX29wZXJhdGlvbnMgdWRsX2RyaXZlcl9mb3Bz
ID0gewotCS5vd25lciA9IFRISVNfTU9EVUxFLAotCS5vcGVuID0gZHJtX29wZW4sCi0JLm1tYXAg
PSB1ZGxfZHJtX2dlbV9tbWFwLAotCS5wb2xsID0gZHJtX3BvbGwsCi0JLnJlYWQgPSBkcm1fcmVh
ZCwKLQkudW5sb2NrZWRfaW9jdGwJPSBkcm1faW9jdGwsCi0JLnJlbGVhc2UgPSBkcm1fcmVsZWFz
ZSwKLQkuY29tcGF0X2lvY3RsID0gZHJtX2NvbXBhdF9pb2N0bCwKLQkubGxzZWVrID0gbm9vcF9s
bHNlZWssCi19OworREVGSU5FX0RSTV9HRU1fRk9QUyh1ZGxfZHJpdmVyX2ZvcHMpOwogCiBzdGF0
aWMgdm9pZCB1ZGxfZHJpdmVyX3JlbGVhc2Uoc3RydWN0IGRybV9kZXZpY2UgKmRldikKIHsKQEAg
LTYzLDE4ICs0OCwxMCBAQCBzdGF0aWMgc3RydWN0IGRybV9kcml2ZXIgZHJpdmVyID0gewogCS5y
ZWxlYXNlID0gdWRsX2RyaXZlcl9yZWxlYXNlLAogCiAJLyogZ2VtIGhvb2tzICovCi0JLmdlbV9m
cmVlX29iamVjdF91bmxvY2tlZCA9IHVkbF9nZW1fZnJlZV9vYmplY3QsCiAJLmdlbV9jcmVhdGVf
b2JqZWN0ID0gdWRsX2RyaXZlcl9nZW1fY3JlYXRlX29iamVjdCwKLQkuZ2VtX3ZtX29wcyA9ICZ1
ZGxfZ2VtX3ZtX29wcywKIAotCS5kdW1iX2NyZWF0ZSA9IHVkbF9kdW1iX2NyZWF0ZSwKLQkuZHVt
Yl9tYXBfb2Zmc2V0ID0gdWRsX2dlbV9tbWFwLAogCS5mb3BzID0gJnVkbF9kcml2ZXJfZm9wcywK
LQotCS5wcmltZV9oYW5kbGVfdG9fZmQgPSBkcm1fZ2VtX3ByaW1lX2hhbmRsZV90b19mZCwKLQku
cHJpbWVfZmRfdG9faGFuZGxlID0gZHJtX2dlbV9wcmltZV9mZF90b19oYW5kbGUsCi0JLmdlbV9w
cmltZV9leHBvcnQgPSB1ZGxfZ2VtX3ByaW1lX2V4cG9ydCwKLQkuZ2VtX3ByaW1lX2ltcG9ydCA9
IHVkbF9nZW1fcHJpbWVfaW1wb3J0LAorCURSTV9HRU1fU0hNRU1fRFJJVkVSX09QUywKIAogCS5u
YW1lID0gRFJJVkVSX05BTUUsCiAJLmRlc2MgPSBEUklWRVJfREVTQywKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5oIGIvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfZHJ2
LmgKaW5kZXggZmMzMTJlNzkxZDE4Li42MzBlNjRhYmM5ODYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMv
Z3B1L2RybS91ZGwvdWRsX2Rydi5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5o
CkBAIC04NSw2ICs4NSw3IEBAIHN0cnVjdCB1ZGxfZ2VtX29iamVjdCB7CiBzdHJ1Y3QgdWRsX2Zy
YW1lYnVmZmVyIHsKIAlzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyIGJhc2U7CiAJc3RydWN0IHVkbF9n
ZW1fb2JqZWN0ICpvYmo7CisJc3RydWN0IGRybV9nZW1fc2htZW1fb2JqZWN0ICpzaG1lbTsKIAli
b29sIGFjdGl2ZV8xNjsgLyogYWN0aXZlIG9uIHRoZSAxNi1iaXQgY2hhbm5lbCAqLwogfTsKIApk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfZmIuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS91ZGwvdWRsX2ZiLmMKaW5kZXggZWYzNTA0ZDA2MzQzLi5mODE1M2I3MjYzNDMgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2ZiLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3Vk
bC91ZGxfZmIuYwpAQCAtMTUsNiArMTUsNyBAQAogI2luY2x1ZGUgPGRybS9kcm1fZHJ2Lmg+CiAj
aW5jbHVkZSA8ZHJtL2RybV9mYl9oZWxwZXIuaD4KICNpbmNsdWRlIDxkcm0vZHJtX2ZvdXJjYy5o
PgorI2luY2x1ZGUgPGRybS9kcm1fZ2VtX3NobWVtX2hlbHBlci5oPgogI2luY2x1ZGUgPGRybS9k
cm1fbW9kZXNldF9oZWxwZXIuaD4KIAogI2luY2x1ZGUgInVkbF9kcnYuaCIKQEAgLTk0LDE2ICs5
NSwxNCBAQCBpbnQgdWRsX2hhbmRsZV9kYW1hZ2Uoc3RydWN0IHVkbF9mcmFtZWJ1ZmZlciAqZmIs
IGludCB4LCBpbnQgeSwKIAlpZiAoIWZiLT5hY3RpdmVfMTYpCiAJCXJldHVybiAwOwogCi0JaWYg
KCFmYi0+b2JqLT52bWFwcGluZykgewotCQlyZXQgPSB1ZGxfZ2VtX3ZtYXAoZmItPm9iaik7Ci0J
CWlmIChyZXQgPT0gLUVOT01FTSkgeworCWlmICghZmItPnNobWVtLT52YWRkcikgeworCQl2b2lk
ICp2YWRkcjsKKworCQl2YWRkciA9IGRybV9nZW1fc2htZW1fdm1hcCgmZmItPnNobWVtLT5iYXNl
KTsKKwkJaWYgKElTX0VSUih2YWRkcikpIHsKIAkJCURSTV9FUlJPUigiZmFpbGVkIHRvIHZtYXAg
ZmJcbiIpOwogCQkJcmV0dXJuIDA7CiAJCX0KLQkJaWYgKCFmYi0+b2JqLT52bWFwcGluZykgewot
CQkJRFJNX0VSUk9SKCJmYWlsZWQgdG8gdm1hcHBpbmdcbiIpOwotCQkJcmV0dXJuIDA7Ci0JCX0K
IAl9CiAKIAlhbGlnbmVkX3ggPSBETF9BTElHTl9ET1dOKHgsIHNpemVvZih1bnNpZ25lZCBsb25n
KSk7CkBAIC0xMjcsNyArMTI2LDcgQEAgaW50IHVkbF9oYW5kbGVfZGFtYWdlKHN0cnVjdCB1ZGxf
ZnJhbWVidWZmZXIgKmZiLCBpbnQgeCwgaW50IHksCiAJCWNvbnN0IGludCBieXRlX29mZnNldCA9
IGxpbmVfb2Zmc2V0ICsgKHggPDwgbG9nX2JwcCk7CiAJCWNvbnN0IGludCBkZXZfYnl0ZV9vZmZz
ZXQgPSAoZmItPmJhc2Uud2lkdGggKiBpICsgeCkgPDwgbG9nX2JwcDsKIAkJaWYgKHVkbF9yZW5k
ZXJfaGxpbmUoZGV2LCBsb2dfYnBwLCAmdXJiLAotCQkJCSAgICAgKGNoYXIgKikgZmItPm9iai0+
dm1hcHBpbmcsCisJCQkJICAgICAoY2hhciAqKSBmYi0+c2htZW0tPnZhZGRyLAogCQkJCSAgICAg
JmNtZCwgYnl0ZV9vZmZzZXQsIGRldl9ieXRlX29mZnNldCwKIAkJCQkgICAgIHdpZHRoIDw8IGxv
Z19icHAsCiAJCQkJICAgICAmYnl0ZXNfaWRlbnRpY2FsLCAmYnl0ZXNfc2VudCkpCkBAIC0yODEs
NiArMjgwLDcgQEAgc3RhdGljIGludCB1ZGxfdXNlcl9mcmFtZWJ1ZmZlcl9kaXJ0eShzdHJ1Y3Qg
ZHJtX2ZyYW1lYnVmZmVyICpmYiwKIAkJCQkgICAgICB1bnNpZ25lZCBudW1fY2xpcHMpCiB7CiAJ
c3RydWN0IHVkbF9mcmFtZWJ1ZmZlciAqdWZiID0gdG9fdWRsX2ZiKGZiKTsKKwlzdHJ1Y3QgZG1h
X2J1Zl9hdHRhY2htZW50ICppbXBvcnRfYXR0YWNoOwogCWludCBpOwogCWludCByZXQgPSAwOwog
CkBAIC0yODksOCArMjg5LDEwIEBAIHN0YXRpYyBpbnQgdWRsX3VzZXJfZnJhbWVidWZmZXJfZGly
dHkoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIsCiAJaWYgKCF1ZmItPmFjdGl2ZV8xNikKIAkJ
Z290byB1bmxvY2s7CiAKLQlpZiAodWZiLT5vYmotPmJhc2UuaW1wb3J0X2F0dGFjaCkgewotCQly
ZXQgPSBkbWFfYnVmX2JlZ2luX2NwdV9hY2Nlc3ModWZiLT5vYmotPmJhc2UuaW1wb3J0X2F0dGFj
aC0+ZG1hYnVmLAorCWltcG9ydF9hdHRhY2ggPSB1ZmItPnNobWVtLT5iYXNlLmltcG9ydF9hdHRh
Y2g7CisKKwlpZiAoaW1wb3J0X2F0dGFjaCkgeworCQlyZXQgPSBkbWFfYnVmX2JlZ2luX2NwdV9h
Y2Nlc3MoaW1wb3J0X2F0dGFjaC0+ZG1hYnVmLAogCQkJCQkgICAgICAgRE1BX0ZST01fREVWSUNF
KTsKIAkJaWYgKHJldCkKIAkJCWdvdG8gdW5sb2NrOwpAQCAtMzA0LDEwICszMDYsOSBAQCBzdGF0
aWMgaW50IHVkbF91c2VyX2ZyYW1lYnVmZmVyX2RpcnR5KHN0cnVjdCBkcm1fZnJhbWVidWZmZXIg
KmZiLAogCQkJYnJlYWs7CiAJfQogCi0JaWYgKHVmYi0+b2JqLT5iYXNlLmltcG9ydF9hdHRhY2gp
IHsKLQkJcmV0ID0gZG1hX2J1Zl9lbmRfY3B1X2FjY2Vzcyh1ZmItPm9iai0+YmFzZS5pbXBvcnRf
YXR0YWNoLT5kbWFidWYsCisJaWYgKGltcG9ydF9hdHRhY2gpCisJCXJldCA9IGRtYV9idWZfZW5k
X2NwdV9hY2Nlc3MoaW1wb3J0X2F0dGFjaC0+ZG1hYnVmLAogCQkJCQkgICAgIERNQV9GUk9NX0RF
VklDRSk7Ci0JfQogCiAgdW5sb2NrOgogCWRybV9tb2Rlc2V0X3VubG9ja19hbGwoZmItPmRldik7
CkBAIC0zMTksOCArMzIwLDggQEAgc3RhdGljIHZvaWQgdWRsX3VzZXJfZnJhbWVidWZmZXJfZGVz
dHJveShzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYikKIHsKIAlzdHJ1Y3QgdWRsX2ZyYW1lYnVm
ZmVyICp1ZmIgPSB0b191ZGxfZmIoZmIpOwogCi0JaWYgKHVmYi0+b2JqKQotCQlkcm1fZ2VtX29i
amVjdF9wdXRfdW5sb2NrZWQoJnVmYi0+b2JqLT5iYXNlKTsKKwlpZiAodWZiLT5zaG1lbSkKKwkJ
ZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKCZ1ZmItPnNobWVtLT5iYXNlKTsKIAogCWRybV9m
cmFtZWJ1ZmZlcl9jbGVhbnVwKGZiKTsKIAlrZnJlZSh1ZmIpOwpAQCAtMzM2LDExICszMzcsMTEg
QEAgc3RhdGljIGludAogdWRsX2ZyYW1lYnVmZmVyX2luaXQoc3RydWN0IGRybV9kZXZpY2UgKmRl
diwKIAkJICAgICBzdHJ1Y3QgdWRsX2ZyYW1lYnVmZmVyICp1ZmIsCiAJCSAgICAgY29uc3Qgc3Ry
dWN0IGRybV9tb2RlX2ZiX2NtZDIgKm1vZGVfY21kLAotCQkgICAgIHN0cnVjdCB1ZGxfZ2VtX29i
amVjdCAqb2JqKQorCQkgICAgIHN0cnVjdCBkcm1fZ2VtX3NobWVtX29iamVjdCAqc2htZW0pCiB7
CiAJaW50IHJldDsKIAotCXVmYi0+b2JqID0gb2JqOworCXVmYi0+c2htZW0gPSBzaG1lbTsKIAlk
cm1faGVscGVyX21vZGVfZmlsbF9mYl9zdHJ1Y3QoZGV2LCAmdWZiLT5iYXNlLCBtb2RlX2NtZCk7
CiAJcmV0ID0gZHJtX2ZyYW1lYnVmZmVyX2luaXQoZGV2LCAmdWZiLT5iYXNlLCAmdWRsZmJfZnVu
Y3MpOwogCXJldHVybiByZXQ7CkBAIC0zNTYsNyArMzU3LDggQEAgc3RhdGljIGludCB1ZGxmYl9j
cmVhdGUoc3RydWN0IGRybV9mYl9oZWxwZXIgKmhlbHBlciwKIAlzdHJ1Y3QgZmJfaW5mbyAqaW5m
bzsKIAlzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYjsKIAlzdHJ1Y3QgZHJtX21vZGVfZmJfY21k
MiBtb2RlX2NtZDsKLQlzdHJ1Y3QgdWRsX2dlbV9vYmplY3QgKm9iajsKKwlzdHJ1Y3QgZHJtX2dl
bV9zaG1lbV9vYmplY3QgKnNobWVtOworCXZvaWQgKnZhZGRyOwogCXVpbnQzMl90IHNpemU7CiAJ
aW50IHJldCA9IDA7CiAKQEAgLTM3MywxMiArMzc1LDE1IEBAIHN0YXRpYyBpbnQgdWRsZmJfY3Jl
YXRlKHN0cnVjdCBkcm1fZmJfaGVscGVyICpoZWxwZXIsCiAJc2l6ZSA9IG1vZGVfY21kLnBpdGNo
ZXNbMF0gKiBtb2RlX2NtZC5oZWlnaHQ7CiAJc2l6ZSA9IEFMSUdOKHNpemUsIFBBR0VfU0laRSk7
CiAKLQlvYmogPSB1ZGxfZ2VtX2FsbG9jX29iamVjdChkZXYsIHNpemUpOwotCWlmICghb2JqKQor
CXNobWVtID0gZHJtX2dlbV9zaG1lbV9jcmVhdGUoZGV2LCBzaXplKTsKKwlpZiAoSVNfRVJSKHNo
bWVtKSkgeworCQlyZXQgPSBQVFJfRVJSKHNobWVtKTsKIAkJZ290byBvdXQ7CisJfQogCi0JcmV0
ID0gdWRsX2dlbV92bWFwKG9iaik7Ci0JaWYgKHJldCkgeworCXZhZGRyID0gZHJtX2dlbV9zaG1l
bV92bWFwKCZzaG1lbS0+YmFzZSk7CisJaWYgKElTX0VSUih2YWRkcikpIHsKKwkJcmV0ID0gUFRS
X0VSUih2YWRkcik7CiAJCURSTV9FUlJPUigiZmFpbGVkIHRvIHZtYXAgZmJcbiIpOwogCQlnb3Rv
IG91dF9nZnJlZTsKIAl9CkBAIC0zODksNyArMzk0LDcgQEAgc3RhdGljIGludCB1ZGxmYl9jcmVh
dGUoc3RydWN0IGRybV9mYl9oZWxwZXIgKmhlbHBlciwKIAkJZ290byBvdXRfZ2ZyZWU7CiAJfQog
Ci0JcmV0ID0gdWRsX2ZyYW1lYnVmZmVyX2luaXQoZGV2LCAmdWZiZGV2LT51ZmIsICZtb2RlX2Nt
ZCwgb2JqKTsKKwlyZXQgPSB1ZGxfZnJhbWVidWZmZXJfaW5pdChkZXYsICZ1ZmJkZXYtPnVmYiwg
Jm1vZGVfY21kLCBzaG1lbSk7CiAJaWYgKHJldCkKIAkJZ290byBvdXRfZ2ZyZWU7CiAKQEAgLTM5
NywyMCArNDAyLDIwIEBAIHN0YXRpYyBpbnQgdWRsZmJfY3JlYXRlKHN0cnVjdCBkcm1fZmJfaGVs
cGVyICpoZWxwZXIsCiAKIAl1ZmJkZXYtPmhlbHBlci5mYiA9IGZiOwogCi0JaW5mby0+c2NyZWVu
X2Jhc2UgPSB1ZmJkZXYtPnVmYi5vYmotPnZtYXBwaW5nOworCWluZm8tPnNjcmVlbl9iYXNlID0g
dmFkZHI7CiAJaW5mby0+Zml4LnNtZW1fbGVuID0gc2l6ZTsKLQlpbmZvLT5maXguc21lbV9zdGFy
dCA9ICh1bnNpZ25lZCBsb25nKXVmYmRldi0+dWZiLm9iai0+dm1hcHBpbmc7CisJaW5mby0+Zml4
LnNtZW1fc3RhcnQgPSAodW5zaWduZWQgbG9uZyl2YWRkcjsKIAogCWluZm8tPmZib3BzID0gJnVk
bGZiX29wczsKIAlkcm1fZmJfaGVscGVyX2ZpbGxfaW5mbyhpbmZvLCAmdWZiZGV2LT5oZWxwZXIs
IHNpemVzKTsKIAogCURSTV9ERUJVR19LTVMoImFsbG9jYXRlZCAlZHglZCB2bWFsICVwXG4iLAog
CQkgICAgICBmYi0+d2lkdGgsIGZiLT5oZWlnaHQsCi0JCSAgICAgIHVmYmRldi0+dWZiLm9iai0+
dm1hcHBpbmcpOworCQkgICAgICB1ZmJkZXYtPnVmYi5zaG1lbS0+dmFkZHIpOwogCiAJcmV0dXJu
IHJldDsKIG91dF9nZnJlZToKLQlkcm1fZ2VtX29iamVjdF9wdXRfdW5sb2NrZWQoJnVmYmRldi0+
dWZiLm9iai0+YmFzZSk7CisJZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKCZ1ZmJkZXYtPnVm
Yi5zaG1lbS0+YmFzZSk7CiBvdXQ6CiAJcmV0dXJuIHJldDsKIH0KQEAgLTQyNCwxMCArNDI5LDEw
IEBAIHN0YXRpYyB2b2lkIHVkbF9mYmRldl9kZXN0cm95KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYs
CiB7CiAJZHJtX2ZiX2hlbHBlcl91bnJlZ2lzdGVyX2ZiaSgmdWZiZGV2LT5oZWxwZXIpOwogCWRy
bV9mYl9oZWxwZXJfZmluaSgmdWZiZGV2LT5oZWxwZXIpOwotCWlmICh1ZmJkZXYtPnVmYi5vYmop
IHsKKwlpZiAodWZiZGV2LT51ZmIuc2htZW0pIHsKIAkJZHJtX2ZyYW1lYnVmZmVyX3VucmVnaXN0
ZXJfcHJpdmF0ZSgmdWZiZGV2LT51ZmIuYmFzZSk7CiAJCWRybV9mcmFtZWJ1ZmZlcl9jbGVhbnVw
KCZ1ZmJkZXYtPnVmYi5iYXNlKTsKLQkJZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKCZ1ZmJk
ZXYtPnVmYi5vYmotPmJhc2UpOworCQlkcm1fZ2VtX29iamVjdF9wdXRfdW5sb2NrZWQoJnVmYmRl
di0+dWZiLnNobWVtLT5iYXNlKTsKIAl9CiB9CiAKQEAgLTUxOCw3ICs1MjMsOCBAQCB1ZGxfZmJf
dXNlcl9mYl9jcmVhdGUoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAlpZiAodWZiID09IE5VTEwp
CiAJCXJldHVybiBFUlJfUFRSKC1FTk9NRU0pOwogCi0JcmV0ID0gdWRsX2ZyYW1lYnVmZmVyX2lu
aXQoZGV2LCB1ZmIsIG1vZGVfY21kLCB0b191ZGxfYm8ob2JqKSk7CisJcmV0ID0gdWRsX2ZyYW1l
YnVmZmVyX2luaXQoZGV2LCB1ZmIsIG1vZGVfY21kLAorCQkJCSAgIHRvX2RybV9nZW1fc2htZW1f
b2JqKG9iaikpOwogCWlmIChyZXQpIHsKIAkJa2ZyZWUodWZiKTsKIAkJcmV0dXJuIEVSUl9QVFIo
LUVJTlZBTCk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9nZW0uYyBiL2Ry
aXZlcnMvZ3B1L2RybS91ZGwvdWRsX2dlbS5jCmluZGV4IDYyODc0OWNjMTE0My4uMzU1NGZmZmJm
MWRiIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9nZW0uYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vdWRsL3VkbF9nZW0uYwpAQCAtNywxMSArNyw2MCBAQAogI2luY2x1ZGUgPGxp
bnV4L3ZtYWxsb2MuaD4KIAogI2luY2x1ZGUgPGRybS9kcm1fZHJ2Lmg+CisjaW5jbHVkZSA8ZHJt
L2RybV9nZW1fc2htZW1faGVscGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9tb2RlLmg+CiAjaW5j
bHVkZSA8ZHJtL2RybV9wcmltZS5oPgogCiAjaW5jbHVkZSAidWRsX2Rydi5oIgogCisvKgorICog
R0VNIG9iamVjdCBmdW5jcworICovCisKK3N0YXRpYyB2b2lkIHVkbF9nZW1fb2JqZWN0X2ZyZWVf
b2JqZWN0KHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqKQoreworCXN0cnVjdCBkcm1fZ2VtX3No
bWVtX29iamVjdCAqc2htZW0gPSB0b19kcm1fZ2VtX3NobWVtX29iaihvYmopOworCisJLyogRmJk
ZXYgZW11bGF0aW9uIHZtYXBzIHRoZSBidWZmZXIuIFVubWFwIGl0IGhlcmUgZm9yIGNvbnNpc3Rl
bmN5CisJICogd2l0aCB0aGUgb3JpZ2luYWwgdWRsIEdFTSBjb2RlLgorCSAqCisJICogVE9ETzog
U3dpdGNoIHRvIGdlbmVyaWMgZmJkZXYgZW11bGF0aW9uIGFuZCByZWxlYXNlIHRoZQorCSAqICAg
ICAgIEdFTSBvYmplY3Qgd2l0aCBkcm1fZ2VtX3NobWVtX2ZyZWVfb2JqZWN0KCkuCisJICovCisJ
aWYgKHNobWVtLT52YWRkcikKKwkJZHJtX2dlbV9zaG1lbV92dW5tYXAob2JqLCBzaG1lbS0+dmFk
ZHIpOworCisJZHJtX2dlbV9zaG1lbV9mcmVlX29iamVjdChvYmopOworfQorCitzdGF0aWMgaW50
IHVkbF9nZW1fb2JqZWN0X21tYXAoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmosCisJCQkgICAg
ICAgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpCit7CisJaW50IHJldDsKKworCXJldCA9IGRy
bV9nZW1fc2htZW1fbW1hcChvYmosIHZtYSk7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKwor
CXZtYS0+dm1fcGFnZV9wcm90ID0gdm1fZ2V0X3BhZ2VfcHJvdCh2bWEtPnZtX2ZsYWdzKTsKKwlp
ZiAob2JqLT5pbXBvcnRfYXR0YWNoKQorCQl2bWEtPnZtX3BhZ2VfcHJvdCA9IHBncHJvdF93cml0
ZWNvbWJpbmUodm1hLT52bV9wYWdlX3Byb3QpOworCXZtYS0+dm1fcGFnZV9wcm90ID0gcGdwcm90
X2RlY3J5cHRlZCh2bWEtPnZtX3BhZ2VfcHJvdCk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGlj
IGNvbnN0IHN0cnVjdCBkcm1fZ2VtX29iamVjdF9mdW5jcyB1ZGxfZ2VtX29iamVjdF9mdW5jcyA9
IHsKKwkuZnJlZSA9IHVkbF9nZW1fb2JqZWN0X2ZyZWVfb2JqZWN0LAorCS5wcmludF9pbmZvID0g
ZHJtX2dlbV9zaG1lbV9wcmludF9pbmZvLAorCS5waW4gPSBkcm1fZ2VtX3NobWVtX3BpbiwKKwku
dW5waW4gPSBkcm1fZ2VtX3NobWVtX3VucGluLAorCS5nZXRfc2dfdGFibGUgPSBkcm1fZ2VtX3No
bWVtX2dldF9zZ190YWJsZSwKKwkudm1hcCA9IGRybV9nZW1fc2htZW1fdm1hcCwKKwkudnVubWFw
ID0gZHJtX2dlbV9zaG1lbV92dW5tYXAsCisJLm1tYXAgPSB1ZGxfZ2VtX29iamVjdF9tbWFwLAor
fTsKKwogLyoKICAqIEhlbHBlcnMgZm9yIHN0cnVjdCBkcm1fZHJpdmVyCiAgKi8KQEAgLTE5LDEz
ICs2OCwxNyBAQAogc3RydWN0IGRybV9nZW1fb2JqZWN0ICp1ZGxfZHJpdmVyX2dlbV9jcmVhdGVf
b2JqZWN0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJCQkJCQkgICAgc2l6ZV90IHNpemUpCiB7
Ci0Jc3RydWN0IHVkbF9nZW1fb2JqZWN0ICpvYmo7CisJc3RydWN0IGRybV9nZW1fc2htZW1fb2Jq
ZWN0ICpzaG1lbTsKKwlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iajsKIAotCW9iaiA9IGt6YWxs
b2Moc2l6ZW9mKCpvYmopLCBHRlBfS0VSTkVMKTsKLQlpZiAoIW9iaikKKwlzaG1lbSA9IGt6YWxs
b2Moc2l6ZW9mKCpzaG1lbSksIEdGUF9LRVJORUwpOworCWlmICghc2htZW0pCiAJCXJldHVybiBO
VUxMOwogCi0JcmV0dXJuICZvYmotPmJhc2U7CisJb2JqID0gJnNobWVtLT5iYXNlOworCW9iai0+
ZnVuY3MgPSAmdWRsX2dlbV9vYmplY3RfZnVuY3M7CisKKwlyZXR1cm4gb2JqOwogfQogCiBzdHJ1
Y3QgdWRsX2dlbV9vYmplY3QgKnVkbF9nZW1fYWxsb2Nfb2JqZWN0KHN0cnVjdCBkcm1fZGV2aWNl
ICpkZXYsCi0tIAoyLjIzLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNr
dG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2Ry
aS1kZXZlbA==
