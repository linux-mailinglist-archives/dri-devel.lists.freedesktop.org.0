Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E57143463F3
	for <lists+dri-devel@lfdr.de>; Tue, 23 Mar 2021 16:58:23 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A35AA6EC01;
	Tue, 23 Mar 2021 15:57:58 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl [141.105.120.124])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D04616EC05
 for <dri-devel@lists.freedesktop.org>; Tue, 23 Mar 2021 15:57:43 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [PATCH v9 25/70] drm/i915: Take reservation lock around i915_vma_pin.
Date: Tue, 23 Mar 2021 16:50:14 +0100
Message-Id: <20210323155059.628690-26-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.31.0
In-Reply-To: <20210323155059.628690-1-maarten.lankhorst@linux.intel.com>
References: <20210323155059.628690-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>,
 dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2UgcHJldmlvdXNseSBjb21wbGFpbmVkIHdoZW4gd3cgPT0gTlVMTC4KClRoaXMgZnVuY3Rpb24g
aXMgbm93IG9ubHkgdXNlZCBpbiBzZWxmdGVzdHMgdG8gcGluIGFuIG9iamVjdCwKYW5kIHd3IGxv
Y2tpbmcgaXMgbm93IGZpeGVkLgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1h
YXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFRob21hcyBIZWxs
c3Ryw7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNvbT4KLS0tCiAuLi4vaTkxNS9n
ZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2NvaGVyZW5jeS5jICAgfCAxMiArKysrLS0tLS0tLQogZHJp
dmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYyAgICAgICAgICAgICAgIHwgIDYgKysrKystCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5jICAgICAgICAgICAgICAgfCAgNCArLS0tCiBk
cml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oICAgICAgICAgICAgICAgfCAyMCArKysrKysr
KysrKysrKystLS0tCiA0IGZpbGVzIGNoYW5nZWQsIDI2IGluc2VydGlvbnMoKyksIDE2IGRlbGV0
aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMv
aTkxNV9nZW1fY29oZXJlbmN5LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3Rz
L2k5MTVfZ2VtX2NvaGVyZW5jeS5jCmluZGV4IGI1ZGJmMTU1NzBmYy4uM2VlYzM4NWQ0M2JiIDEw
MDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX2Nv
aGVyZW5jeS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9zZWxmdGVzdHMvaTkxNV9n
ZW1fY29oZXJlbmN5LmMKQEAgLTIxOCwxNSArMjE4LDEzIEBAIHN0YXRpYyBpbnQgZ3B1X3NldChz
dHJ1Y3QgY29udGV4dCAqY3R4LCB1bnNpZ25lZCBsb25nIG9mZnNldCwgdTMyIHYpCiAJdTMyICpj
czsKIAlpbnQgZXJyOwogCisJdm1hID0gaTkxNV9nZW1fb2JqZWN0X2dndHRfcGluKGN0eC0+b2Jq
LCBOVUxMLCAwLCAwLCAwKTsKKwlpZiAoSVNfRVJSKHZtYSkpCisJCXJldHVybiBQVFJfRVJSKHZt
YSk7CisKIAlpOTE1X2dlbV9vYmplY3RfbG9jayhjdHgtPm9iaiwgTlVMTCk7CiAJaTkxNV9nZW1f
b2JqZWN0X3NldF90b19ndHRfZG9tYWluKGN0eC0+b2JqLCBmYWxzZSk7CiAKLQl2bWEgPSBpOTE1
X2dlbV9vYmplY3RfZ2d0dF9waW4oY3R4LT5vYmosIE5VTEwsIDAsIDAsIDApOwotCWlmIChJU19F
UlIodm1hKSkgewotCQllcnIgPSBQVFJfRVJSKHZtYSk7Ci0JCWdvdG8gb3V0X3VubG9jazsKLQl9
Ci0KIAlycSA9IGludGVsX2VuZ2luZV9jcmVhdGVfa2VybmVsX3JlcXVlc3QoY3R4LT5lbmdpbmUp
OwogCWlmIChJU19FUlIocnEpKSB7CiAJCWVyciA9IFBUUl9FUlIocnEpOwpAQCAtMjY1LDkgKzI2
Myw3IEBAIHN0YXRpYyBpbnQgZ3B1X3NldChzdHJ1Y3QgY29udGV4dCAqY3R4LCB1bnNpZ25lZCBs
b25nIG9mZnNldCwgdTMyIHYpCiAJaTkxNV9yZXF1ZXN0X2FkZChycSk7CiBvdXRfdW5waW46CiAJ
aTkxNV92bWFfdW5waW4odm1hKTsKLW91dF91bmxvY2s6CiAJaTkxNV9nZW1fb2JqZWN0X3VubG9j
ayhjdHgtPm9iaik7Ci0KIAlyZXR1cm4gZXJyOwogfQogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X2dlbS5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV9nZW0uYwpp
bmRleCAzZGVlNGUzMWZiMTQuLjgzNzM2NjJlNGI1ZiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvaTkxNV9nZW0uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X2dlbS5j
CkBAIC05MjAsNyArOTIwLDExIEBAIGk5MTVfZ2VtX29iamVjdF9nZ3R0X3Bpbl93dyhzdHJ1Y3Qg
ZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAogCQkJcmV0dXJuIEVSUl9QVFIocmV0KTsKIAl9CiAK
LQlyZXQgPSBpOTE1X3ZtYV9waW5fd3codm1hLCB3dywgc2l6ZSwgYWxpZ25tZW50LCBmbGFncyB8
IFBJTl9HTE9CQUwpOworCWlmICh3dykKKwkJcmV0ID0gaTkxNV92bWFfcGluX3d3KHZtYSwgd3cs
IHNpemUsIGFsaWdubWVudCwgZmxhZ3MgfCBQSU5fR0xPQkFMKTsKKwllbHNlCisJCXJldCA9IGk5
MTVfdm1hX3Bpbih2bWEsIHNpemUsIGFsaWdubWVudCwgZmxhZ3MgfCBQSU5fR0xPQkFMKTsKKwog
CWlmIChyZXQpCiAJCXJldHVybiBFUlJfUFRSKHJldCk7CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2k5MTVfdm1hLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5j
CmluZGV4IDFmZmRhMmFhYTdhMC4uMjY1ZTNhMzA3OWUyIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dw
dS9kcm0vaTkxNS9pOTE1X3ZtYS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1h
LmMKQEAgLTg2Myw5ICs4NjMsNyBAQCBpbnQgaTkxNV92bWFfcGluX3d3KHN0cnVjdCBpOTE1X3Zt
YSAqdm1hLCBzdHJ1Y3QgaTkxNV9nZW1fd3dfY3R4ICp3dywKIAlpbnQgZXJyOwogCiAjaWZkZWYg
Q09ORklHX1BST1ZFX0xPQ0tJTkcKLQlpZiAoZGVidWdfbG9ja3MgJiYgbG9ja2RlcF9pc19oZWxk
KCZ2bWEtPnZtLT5pOTE1LT5kcm0uc3RydWN0X211dGV4KSkKLQkJV0FSTl9PTighd3cpOwotCWlm
IChkZWJ1Z19sb2NrcyAmJiB3dyAmJiB2bWEtPnJlc3YpCisJaWYgKGRlYnVnX2xvY2tzICYmICFX
QVJOX09OKCF3dykgJiYgdm1hLT5yZXN2KQogCQlhc3NlcnRfdm1hX2hlbGQodm1hKTsKICNlbmRp
ZgogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oIGIvZHJpdmVy
cy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaAppbmRleCA2YjQ4ZjVjNDI0ODguLjhkZjc4NGEwMjZk
MiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuaAorKysgYi9kcml2
ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3ZtYS5oCkBAIC0yNDYsMTAgKzI0NiwyMiBAQCBpOTE1X3Zt
YV9waW5fd3coc3RydWN0IGk5MTVfdm1hICp2bWEsIHN0cnVjdCBpOTE1X2dlbV93d19jdHggKnd3
LAogc3RhdGljIGlubGluZSBpbnQgX19tdXN0X2NoZWNrCiBpOTE1X3ZtYV9waW4oc3RydWN0IGk5
MTVfdm1hICp2bWEsIHU2NCBzaXplLCB1NjQgYWxpZ25tZW50LCB1NjQgZmxhZ3MpCiB7Ci0jaWZk
ZWYgQ09ORklHX0xPQ0tERVAKLQlXQVJOX09OX09OQ0Uodm1hLT5yZXN2ICYmIGRtYV9yZXN2X2hl
bGQodm1hLT5yZXN2KSk7Ci0jZW5kaWYKLQlyZXR1cm4gaTkxNV92bWFfcGluX3d3KHZtYSwgTlVM
TCwgc2l6ZSwgYWxpZ25tZW50LCBmbGFncyk7CisJc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCB3dzsK
KwlpbnQgZXJyOworCisJaTkxNV9nZW1fd3dfY3R4X2luaXQoJnd3LCB0cnVlKTsKK3JldHJ5Ogor
CWVyciA9IGk5MTVfZ2VtX29iamVjdF9sb2NrKHZtYS0+b2JqLCAmd3cpOworCWlmICghZXJyKQor
CQllcnIgPSBpOTE1X3ZtYV9waW5fd3codm1hLCAmd3csIHNpemUsIGFsaWdubWVudCwgZmxhZ3Mp
OworCWlmIChlcnIgPT0gLUVERUFETEspIHsKKwkJZXJyID0gaTkxNV9nZW1fd3dfY3R4X2JhY2tv
ZmYoJnd3KTsKKwkJaWYgKCFlcnIpCisJCQlnb3RvIHJldHJ5OworCX0KKwlpOTE1X2dlbV93d19j
dHhfZmluaSgmd3cpOworCisJcmV0dXJuIGVycjsKIH0KIAogaW50IGk5MTVfZ2d0dF9waW4oc3Ry
dWN0IGk5MTVfdm1hICp2bWEsIHN0cnVjdCBpOTE1X2dlbV93d19jdHggKnd3LAotLSAKMi4zMS4w
CgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2
ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9s
aXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
