Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 3266227E87
	for <lists+dri-devel@lfdr.de>; Thu, 23 May 2019 15:45:02 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9C35D89EA6;
	Thu, 23 May 2019 13:44:49 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from smtp.domeneshop.no (smtp.domeneshop.no
 [IPv6:2a01:5b40:0:3005::1])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1E5FD89E41;
 Thu, 23 May 2019 13:44:38 +0000 (UTC)
Received: from 211.81-166-168.customer.lyse.net ([81.166.168.211]:53376
 helo=localhost.localdomain)
 by smtp.domeneshop.no with esmtpsa (TLS1.2:ECDHE_RSA_AES_128_CBC_SHA1:128)
 (Exim 4.84_2) (envelope-from <noralf@tronnes.org>)
 id 1hTo1M-0002si-4p; Thu, 23 May 2019 15:44:36 +0200
From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v6 4/8] drm/fb-helper: Move out commit code
Date: Thu, 23 May 2019 15:44:09 +0200
Message-Id: <20190523134413.4210-5-noralf@tronnes.org>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190523134413.4210-1-noralf@tronnes.org>
References: <20190523134413.4210-1-noralf@tronnes.org>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; d=tronnes.org; s=ds201810; 
 h=Content-Transfer-Encoding:Content-Type:MIME-Version:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From;
 bh=O3Q6VtAKFgY2UICkOO5eZAquEHIat9Ktp/o3Prldg5U=; 
 b=PB9KPn8FDcC9Lj5ocLYtf5NDSmoNiBSswLOhsVGemDYOaa7nWLZCRDGXCTaE6RpSp2ITeQocKif5+Lb5UkJ5iDflTRezp9BdbRr4Gk6PiD5BCFHuy2U8mfVfteybW7Uj5h+hr0Tpr+K3eWJPLFn5WvEvJ+xyJ5oNPyht7wZaploLBOS+joLUqLZ+jj8H0uv4vT+lNZqYKTzMVptzbfbs55FInTEghuGyELKi1X1mh8eiAM7M3PLKaewFdfxEY+N46mQ1klMcX0kQLYm3k2Gf1nNy9G5bfa9dnbsKXbpW+XZWQdMSU6DtwLxwI1+Kf93Fhnsbqfa/Y4LVux0E7WB+pg==;
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: intel-gfx@lists.freedesktop.org, Sam Ravnborg <sam@ravnborg.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

TW92ZSB0aGUgbW9kZXNldCBjb21taXQgY29kZSB0byBkcm1fY2xpZW50X21vZGVzZXQuCk5vIGNo
YW5nZXMgZXhjZXB0IGV4cG9ydGluZyBBUEkuCgp2MjogTW92ZSB0byBkcm1fY2xpZW50X21vZGVz
ZXQuYyBpbnN0ZWFkIG9mIGRybV9jbGllbnQuYwoKU2lnbmVkLW9mZi1ieTogTm9yYWxmIFRyw7hu
bmVzIDxub3JhbGZAdHJvbm5lcy5vcmc+ClJldmlld2VkLWJ5OiBTYW0gUmF2bmJvcmcgPHNhbUBy
YXZuYm9yZy5vcmc+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2RybV9jbGllbnRfbW9kZXNldC5jIHwg
Mjg3ICsrKysrKysrKysrKysrKysrKysrKysrKysrKwogZHJpdmVycy9ncHUvZHJtL2RybV9mYl9o
ZWxwZXIuYyAgICAgIHwgMjgyIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiBpbmNsdWRlL2Ry
bS9kcm1fY2xpZW50LmggICAgICAgICAgICAgfCAgIDQgKwogMyBmaWxlcyBjaGFuZ2VkLCAyOTEg
aW5zZXJ0aW9ucygrKSwgMjgyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9kcm1fY2xpZW50X21vZGVzZXQuYyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fY2xpZW50X21v
ZGVzZXQuYwppbmRleCA2Njc3MGVkMzI5OWUuLmIyYWVkZWM2NTYzNyAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL2RybV9jbGllbnRfbW9kZXNldC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9k
cm1fY2xpZW50X21vZGVzZXQuYwpAQCAtMTEsOSArMTEsMTQgQEAKICNpbmNsdWRlIDxsaW51eC9t
dXRleC5oPgogI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KIAorI2luY2x1ZGUgPGRybS9kcm1fYXRv
bWljLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9jbGllbnQuaD4KICNpbmNsdWRlIDxkcm0vZHJtX2Ny
dGMuaD4KICNpbmNsdWRlIDxkcm0vZHJtX2RldmljZS5oPgorI2luY2x1ZGUgPGRybS9kcm1fZHJ2
Lmg+CisKKyNpbmNsdWRlICJkcm1fY3J0Y19pbnRlcm5hbC5oIgorI2luY2x1ZGUgImRybV9pbnRl
cm5hbC5oIgogCiBpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2NyZWF0ZShzdHJ1Y3QgZHJtX2NsaWVu
dF9kZXYgKmNsaWVudCkKIHsKQEAgLTEwMiwzICsxMDcsMjg1IEBAIHN0cnVjdCBkcm1fbW9kZV9z
ZXQgKmRybV9jbGllbnRfZmluZF9tb2Rlc2V0KHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50
LCBzdHJ1CiB9CiAvKiBUT0RPOiBSZW1vdmUgZXhwb3J0IHdoZW4gbW9kZXNldCBjb2RlIGhhcyBi
ZWVuIG1vdmVkIG92ZXIgKi8KIEVYUE9SVF9TWU1CT0woZHJtX2NsaWVudF9maW5kX21vZGVzZXQp
OworCisvKioKKyAqIGRybV9jbGllbnRfcGFuZWxfcm90YXRpb24oKSAtIENoZWNrIHBhbmVsIG9y
aWVudGF0aW9uCisgKiBAbW9kZXNldDogRFJNIG1vZGVzZXQKKyAqIEByb3RhdGlvbjogUmV0dXJu
ZWQgcm90YXRpb24gdmFsdWUKKyAqCisgKiBUaGlzIGZ1bmN0aW9uIGNoZWNrcyBpZiB0aGUgcHJp
bWFyeSBwbGFuZSBpbiBAbW9kZXNldCBjYW4gaHcgcm90YXRlIHRvIG1hdGNoCisgKiB0aGUgcGFu
ZWwgb3JpZW50YXRpb24gb24gaXRzIGNvbm5lY3Rvci4KKyAqCisgKiBOb3RlOiBDdXJyZW50bHkg
b25seSAwIGFuZCAxODAgZGVncmVlcyBhcmUgc3VwcG9ydGVkLgorICoKKyAqIFJldHVybjoKKyAq
IFRydWUgaWYgdGhlIHBsYW5lIGNhbiBkbyB0aGUgcm90YXRpb24sIGZhbHNlIG90aGVyd2lzZS4K
KyAqLworYm9vbCBkcm1fY2xpZW50X3BhbmVsX3JvdGF0aW9uKHN0cnVjdCBkcm1fbW9kZV9zZXQg
Km1vZGVzZXQsIHVuc2lnbmVkIGludCAqcm90YXRpb24pCit7CisJc3RydWN0IGRybV9jb25uZWN0
b3IgKmNvbm5lY3RvciA9IG1vZGVzZXQtPmNvbm5lY3RvcnNbMF07CisJc3RydWN0IGRybV9wbGFu
ZSAqcGxhbmUgPSBtb2Rlc2V0LT5jcnRjLT5wcmltYXJ5OworCXU2NCB2YWxpZF9tYXNrID0gMDsK
Kwl1bnNpZ25lZCBpbnQgaTsKKworCWlmICghbW9kZXNldC0+bnVtX2Nvbm5lY3RvcnMpCisJCXJl
dHVybiBmYWxzZTsKKworCXN3aXRjaCAoY29ubmVjdG9yLT5kaXNwbGF5X2luZm8ucGFuZWxfb3Jp
ZW50YXRpb24pIHsKKwljYXNlIERSTV9NT0RFX1BBTkVMX09SSUVOVEFUSU9OX0JPVFRPTV9VUDoK
KwkJKnJvdGF0aW9uID0gRFJNX01PREVfUk9UQVRFXzE4MDsKKwkJYnJlYWs7CisJY2FzZSBEUk1f
TU9ERV9QQU5FTF9PUklFTlRBVElPTl9MRUZUX1VQOgorCQkqcm90YXRpb24gPSBEUk1fTU9ERV9S
T1RBVEVfOTA7CisJCWJyZWFrOworCWNhc2UgRFJNX01PREVfUEFORUxfT1JJRU5UQVRJT05fUklH
SFRfVVA6CisJCSpyb3RhdGlvbiA9IERSTV9NT0RFX1JPVEFURV8yNzA7CisJCWJyZWFrOworCWRl
ZmF1bHQ6CisJCSpyb3RhdGlvbiA9IERSTV9NT0RFX1JPVEFURV8wOworCX0KKworCS8qCisJICog
VE9ETzogc3VwcG9ydCA5MCAvIDI3MCBkZWdyZWUgaGFyZHdhcmUgcm90YXRpb24sCisJICogZGVw
ZW5kaW5nIG9uIHRoZSBoYXJkd2FyZSB0aGlzIG1heSByZXF1aXJlIHRoZSBmcmFtZWJ1ZmZlcgor
CSAqIHRvIGJlIGluIGEgc3BlY2lmaWMgdGlsaW5nIGZvcm1hdC4KKwkgKi8KKwlpZiAoKnJvdGF0
aW9uICE9IERSTV9NT0RFX1JPVEFURV8xODAgfHwgIXBsYW5lLT5yb3RhdGlvbl9wcm9wZXJ0eSkK
KwkJcmV0dXJuIGZhbHNlOworCisJZm9yIChpID0gMDsgaSA8IHBsYW5lLT5yb3RhdGlvbl9wcm9w
ZXJ0eS0+bnVtX3ZhbHVlczsgaSsrKQorCQl2YWxpZF9tYXNrIHw9ICgxVUxMIDw8IHBsYW5lLT5y
b3RhdGlvbl9wcm9wZXJ0eS0+dmFsdWVzW2ldKTsKKworCWlmICghKCpyb3RhdGlvbiAmIHZhbGlk
X21hc2spKQorCQlyZXR1cm4gZmFsc2U7CisKKwlyZXR1cm4gdHJ1ZTsKK30KKworc3RhdGljIGlu
dCBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2F0b21pYyhzdHJ1Y3QgZHJtX2NsaWVudF9kZXYg
KmNsaWVudCwgYm9vbCBhY3RpdmUpCit7CisJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVu
dC0+ZGV2OworCXN0cnVjdCBkcm1fcGxhbmVfc3RhdGUgKnBsYW5lX3N0YXRlOworCXN0cnVjdCBk
cm1fcGxhbmUgKnBsYW5lOworCXN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZTsKKwlzdHJ1
Y3QgZHJtX21vZGVzZXRfYWNxdWlyZV9jdHggY3R4OworCXN0cnVjdCBkcm1fbW9kZV9zZXQgKm1v
ZGVfc2V0OworCWludCByZXQ7CisKKwlkcm1fbW9kZXNldF9hY3F1aXJlX2luaXQoJmN0eCwgMCk7
CisKKwlzdGF0ZSA9IGRybV9hdG9taWNfc3RhdGVfYWxsb2MoZGV2KTsKKwlpZiAoIXN0YXRlKSB7
CisJCXJldCA9IC1FTk9NRU07CisJCWdvdG8gb3V0X2N0eDsKKwl9CisKKwlzdGF0ZS0+YWNxdWly
ZV9jdHggPSAmY3R4OworcmV0cnk6CisJZHJtX2Zvcl9lYWNoX3BsYW5lKHBsYW5lLCBkZXYpIHsK
KwkJcGxhbmVfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9wbGFuZV9zdGF0ZShzdGF0ZSwgcGxhbmUp
OworCQlpZiAoSVNfRVJSKHBsYW5lX3N0YXRlKSkgeworCQkJcmV0ID0gUFRSX0VSUihwbGFuZV9z
dGF0ZSk7CisJCQlnb3RvIG91dF9zdGF0ZTsKKwkJfQorCisJCXBsYW5lX3N0YXRlLT5yb3RhdGlv
biA9IERSTV9NT0RFX1JPVEFURV8wOworCisJCS8qIGRpc2FibGUgbm9uLXByaW1hcnk6ICovCisJ
CWlmIChwbGFuZS0+dHlwZSA9PSBEUk1fUExBTkVfVFlQRV9QUklNQVJZKQorCQkJY29udGludWU7
CisKKwkJcmV0ID0gX19kcm1fYXRvbWljX2hlbHBlcl9kaXNhYmxlX3BsYW5lKHBsYW5lLCBwbGFu
ZV9zdGF0ZSk7CisJCWlmIChyZXQgIT0gMCkKKwkJCWdvdG8gb3V0X3N0YXRlOworCX0KKworCWRy
bV9jbGllbnRfZm9yX2VhY2hfbW9kZXNldChtb2RlX3NldCwgY2xpZW50KSB7CisJCXN0cnVjdCBk
cm1fcGxhbmUgKnByaW1hcnkgPSBtb2RlX3NldC0+Y3J0Yy0+cHJpbWFyeTsKKwkJdW5zaWduZWQg
aW50IHJvdGF0aW9uOworCisJCWlmIChkcm1fY2xpZW50X3BhbmVsX3JvdGF0aW9uKG1vZGVfc2V0
LCAmcm90YXRpb24pKSB7CisJCQkvKiBDYW5ub3QgZmFpbCBhcyB3ZSd2ZSBhbHJlYWR5IGdvdHRl
biB0aGUgcGxhbmUgc3RhdGUgYWJvdmUgKi8KKwkJCXBsYW5lX3N0YXRlID0gZHJtX2F0b21pY19n
ZXRfbmV3X3BsYW5lX3N0YXRlKHN0YXRlLCBwcmltYXJ5KTsKKwkJCXBsYW5lX3N0YXRlLT5yb3Rh
dGlvbiA9IHJvdGF0aW9uOworCQl9CisKKwkJcmV0ID0gX19kcm1fYXRvbWljX2hlbHBlcl9zZXRf
Y29uZmlnKG1vZGVfc2V0LCBzdGF0ZSk7CisJCWlmIChyZXQgIT0gMCkKKwkJCWdvdG8gb3V0X3N0
YXRlOworCisJCS8qCisJCSAqIF9fZHJtX2F0b21pY19oZWxwZXJfc2V0X2NvbmZpZygpIHNldHMg
YWN0aXZlIHdoZW4gYQorCQkgKiBtb2RlIGlzIHNldCwgdW5jb25kaXRpb25hbGx5IGNsZWFyIGl0
IGlmIHdlIGZvcmNlIERQTVMgb2ZmCisJCSAqLworCQlpZiAoIWFjdGl2ZSkgeworCQkJc3RydWN0
IGRybV9jcnRjICpjcnRjID0gbW9kZV9zZXQtPmNydGM7CisJCQlzdHJ1Y3QgZHJtX2NydGNfc3Rh
dGUgKmNydGNfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9uZXdfY3J0Y19zdGF0ZShzdGF0ZSwgY3J0
Yyk7CisKKwkJCWNydGNfc3RhdGUtPmFjdGl2ZSA9IGZhbHNlOworCQl9CisJfQorCisJcmV0ID0g
ZHJtX2F0b21pY19jb21taXQoc3RhdGUpOworCitvdXRfc3RhdGU6CisJaWYgKHJldCA9PSAtRURF
QURMSykKKwkJZ290byBiYWNrb2ZmOworCisJZHJtX2F0b21pY19zdGF0ZV9wdXQoc3RhdGUpOwor
b3V0X2N0eDoKKwlkcm1fbW9kZXNldF9kcm9wX2xvY2tzKCZjdHgpOworCWRybV9tb2Rlc2V0X2Fj
cXVpcmVfZmluaSgmY3R4KTsKKworCXJldHVybiByZXQ7CisKK2JhY2tvZmY6CisJZHJtX2F0b21p
Y19zdGF0ZV9jbGVhcihzdGF0ZSk7CisJZHJtX21vZGVzZXRfYmFja29mZigmY3R4KTsKKworCWdv
dG8gcmV0cnk7Cit9CisKK3N0YXRpYyBpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9sZWdh
Y3koc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpCit7CisJc3RydWN0IGRybV9kZXZpY2Ug
KmRldiA9IGNsaWVudC0+ZGV2OworCXN0cnVjdCBkcm1fbW9kZV9zZXQgKm1vZGVfc2V0OworCXN0
cnVjdCBkcm1fcGxhbmUgKnBsYW5lOworCWludCByZXQgPSAwOworCisJZHJtX21vZGVzZXRfbG9j
a19hbGwoZGV2KTsKKwlkcm1fZm9yX2VhY2hfcGxhbmUocGxhbmUsIGRldikgeworCQlpZiAocGxh
bmUtPnR5cGUgIT0gRFJNX1BMQU5FX1RZUEVfUFJJTUFSWSkKKwkJCWRybV9wbGFuZV9mb3JjZV9k
aXNhYmxlKHBsYW5lKTsKKworCQlpZiAocGxhbmUtPnJvdGF0aW9uX3Byb3BlcnR5KQorCQkJZHJt
X21vZGVfcGxhbmVfc2V0X29ial9wcm9wKHBsYW5lLAorCQkJCQkJICAgIHBsYW5lLT5yb3RhdGlv
bl9wcm9wZXJ0eSwKKwkJCQkJCSAgICBEUk1fTU9ERV9ST1RBVEVfMCk7CisJfQorCisJZHJtX2Ns
aWVudF9mb3JfZWFjaF9tb2Rlc2V0KG1vZGVfc2V0LCBjbGllbnQpIHsKKwkJc3RydWN0IGRybV9j
cnRjICpjcnRjID0gbW9kZV9zZXQtPmNydGM7CisKKwkJaWYgKGNydGMtPmZ1bmNzLT5jdXJzb3Jf
c2V0MikgeworCQkJcmV0ID0gY3J0Yy0+ZnVuY3MtPmN1cnNvcl9zZXQyKGNydGMsIE5VTEwsIDAs
IDAsIDAsIDAsIDApOworCQkJaWYgKHJldCkKKwkJCQlnb3RvIG91dDsKKwkJfSBlbHNlIGlmIChj
cnRjLT5mdW5jcy0+Y3Vyc29yX3NldCkgeworCQkJcmV0ID0gY3J0Yy0+ZnVuY3MtPmN1cnNvcl9z
ZXQoY3J0YywgTlVMTCwgMCwgMCwgMCk7CisJCQlpZiAocmV0KQorCQkJCWdvdG8gb3V0OworCQl9
CisKKwkJcmV0ID0gZHJtX21vZGVfc2V0X2NvbmZpZ19pbnRlcm5hbChtb2RlX3NldCk7CisJCWlm
IChyZXQpCisJCQlnb3RvIG91dDsKKwl9CitvdXQ6CisJZHJtX21vZGVzZXRfdW5sb2NrX2FsbChk
ZXYpOworCisJcmV0dXJuIHJldDsKK30KKworLyoqCisgKiBkcm1fY2xpZW50X21vZGVzZXRfY29t
bWl0X2ZvcmNlKCkgLSBGb3JjZSBjb21taXQgQ1JUQyBjb25maWd1cmF0aW9uCisgKiBAY2xpZW50
OiBEUk0gY2xpZW50CisgKgorICogQ29tbWl0IG1vZGVzZXQgY29uZmlndXJhdGlvbiB0byBjcnRj
cyB3aXRob3V0IGNoZWNraW5nIGlmIHRoZXJlIGlzIGEgRFJNIG1hc3Rlci4KKyAqCisgKiBSZXR1
cm5zOgorICogWmVybyBvbiBzdWNjZXNzIG9yIG5lZ2F0aXZlIGVycm9yIGNvZGUgb24gZmFpbHVy
ZS4KKyAqLworaW50IGRybV9jbGllbnRfbW9kZXNldF9jb21taXRfZm9yY2Uoc3RydWN0IGRybV9j
bGllbnRfZGV2ICpjbGllbnQpCit7CisJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVudC0+
ZGV2OworCWludCByZXQ7CisKKwltdXRleF9sb2NrKCZjbGllbnQtPm1vZGVzZXRfbXV0ZXgpOwor
CWlmIChkcm1fZHJ2X3VzZXNfYXRvbWljX21vZGVzZXQoZGV2KSkKKwkJcmV0ID0gZHJtX2NsaWVu
dF9tb2Rlc2V0X2NvbW1pdF9hdG9taWMoY2xpZW50LCB0cnVlKTsKKwllbHNlCisJCXJldCA9IGRy
bV9jbGllbnRfbW9kZXNldF9jb21taXRfbGVnYWN5KGNsaWVudCk7CisJbXV0ZXhfdW5sb2NrKCZj
bGllbnQtPm1vZGVzZXRfbXV0ZXgpOworCisJcmV0dXJuIHJldDsKK30KK0VYUE9SVF9TWU1CT0wo
ZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9mb3JjZSk7CisKKy8qKgorICogZHJtX2NsaWVudF9t
b2Rlc2V0X2NvbW1pdCgpIC0gQ29tbWl0IENSVEMgY29uZmlndXJhdGlvbgorICogQGNsaWVudDog
RFJNIGNsaWVudAorICoKKyAqIENvbW1pdCBtb2Rlc2V0IGNvbmZpZ3VyYXRpb24gdG8gY3J0Y3Mu
CisgKgorICogUmV0dXJuczoKKyAqIFplcm8gb24gc3VjY2VzcyBvciBuZWdhdGl2ZSBlcnJvciBj
b2RlIG9uIGZhaWx1cmUuCisgKi8KK2ludCBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0KHN0cnVj
dCBkcm1fY2xpZW50X2RldiAqY2xpZW50KQoreworCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBj
bGllbnQtPmRldjsKKwlpbnQgcmV0OworCisJaWYgKCFkcm1fbWFzdGVyX2ludGVybmFsX2FjcXVp
cmUoZGV2KSkKKwkJcmV0dXJuIC1FQlVTWTsKKworCXJldCA9IGRybV9jbGllbnRfbW9kZXNldF9j
b21taXRfZm9yY2UoY2xpZW50KTsKKworCWRybV9tYXN0ZXJfaW50ZXJuYWxfcmVsZWFzZShkZXYp
OworCisJcmV0dXJuIHJldDsKK30KK0VYUE9SVF9TWU1CT0woZHJtX2NsaWVudF9tb2Rlc2V0X2Nv
bW1pdCk7CisKK3N0YXRpYyB2b2lkIGRybV9jbGllbnRfbW9kZXNldF9kcG1zX2xlZ2FjeShzdHJ1
Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCwgaW50IGRwbXNfbW9kZSkKK3sKKwlzdHJ1Y3QgZHJt
X2RldmljZSAqZGV2ID0gY2xpZW50LT5kZXY7CisJc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5l
Y3RvcjsKKwlzdHJ1Y3QgZHJtX21vZGVfc2V0ICptb2Rlc2V0OworCWludCBqOworCisJZHJtX21v
ZGVzZXRfbG9ja19hbGwoZGV2KTsKKwlkcm1fY2xpZW50X2Zvcl9lYWNoX21vZGVzZXQobW9kZXNl
dCwgY2xpZW50KSB7CisJCWlmICghbW9kZXNldC0+Y3J0Yy0+ZW5hYmxlZCkKKwkJCWNvbnRpbnVl
OworCisJCWZvciAoaiA9IDA7IGogPCBtb2Rlc2V0LT5udW1fY29ubmVjdG9yczsgaisrKSB7CisJ
CQljb25uZWN0b3IgPSBtb2Rlc2V0LT5jb25uZWN0b3JzW2pdOworCQkJY29ubmVjdG9yLT5mdW5j
cy0+ZHBtcyhjb25uZWN0b3IsIGRwbXNfbW9kZSk7CisJCQlkcm1fb2JqZWN0X3Byb3BlcnR5X3Nl
dF92YWx1ZSgmY29ubmVjdG9yLT5iYXNlLAorCQkJCWRldi0+bW9kZV9jb25maWcuZHBtc19wcm9w
ZXJ0eSwgZHBtc19tb2RlKTsKKwkJfQorCX0KKwlkcm1fbW9kZXNldF91bmxvY2tfYWxsKGRldik7
Cit9CisKKy8qKgorICogZHJtX2NsaWVudF9tb2Rlc2V0X2RwbXMoKSAtIFNldCBEUE1TIG1vZGUK
KyAqIEBjbGllbnQ6IERSTSBjbGllbnQKKyAqIEBtb2RlOiBEUE1TIG1vZGUKKyAqCisgKiBOb3Rl
OiBGb3IgYXRvbWljIGRyaXZlcnMgQG1vZGUgaXMgcmVkdWNlZCB0byBvbi9vZmYuCisgKgorICog
UmV0dXJuczoKKyAqIFplcm8gb24gc3VjY2VzcyBvciBuZWdhdGl2ZSBlcnJvciBjb2RlIG9uIGZh
aWx1cmUuCisgKi8KK2ludCBkcm1fY2xpZW50X21vZGVzZXRfZHBtcyhzdHJ1Y3QgZHJtX2NsaWVu
dF9kZXYgKmNsaWVudCwgaW50IG1vZGUpCit7CisJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNs
aWVudC0+ZGV2OworCWludCByZXQgPSAwOworCisJaWYgKCFkcm1fbWFzdGVyX2ludGVybmFsX2Fj
cXVpcmUoZGV2KSkKKwkJcmV0dXJuIC1FQlVTWTsKKworCW11dGV4X2xvY2soJmNsaWVudC0+bW9k
ZXNldF9tdXRleCk7CisJaWYgKGRybV9kcnZfdXNlc19hdG9taWNfbW9kZXNldChkZXYpKQorCQly
ZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2F0b21pYyhjbGllbnQsIG1vZGUgPT0gRFJN
X01PREVfRFBNU19PTik7CisJZWxzZQorCQlkcm1fY2xpZW50X21vZGVzZXRfZHBtc19sZWdhY3ko
Y2xpZW50LCBtb2RlKTsKKwltdXRleF91bmxvY2soJmNsaWVudC0+bW9kZXNldF9tdXRleCk7CisK
Kwlkcm1fbWFzdGVyX2ludGVybmFsX3JlbGVhc2UoZGV2KTsKKworCXJldHVybiByZXQ7Cit9CitF
WFBPUlRfU1lNQk9MKGRybV9jbGllbnRfbW9kZXNldF9kcG1zKTsKZGlmZiAtLWdpdCBhL2RyaXZl
cnMvZ3B1L2RybS9kcm1fZmJfaGVscGVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2ZiX2hlbHBl
ci5jCmluZGV4IGQ1MzBmYjMxNWU1Mi4uZTljZmNjZGE2NTMzIDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vZHJtX2ZiX2hlbHBlci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmJfaGVs
cGVyLmMKQEAgLTQwLDEwICs0MCw3IEBACiAjaW5jbHVkZSA8ZHJtL2RybV9mYl9oZWxwZXIuaD4K
ICNpbmNsdWRlIDxkcm0vZHJtX2NydGNfaGVscGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9hdG9t
aWMuaD4KLSNpbmNsdWRlIDxkcm0vZHJtX2F0b21pY19oZWxwZXIuaD4KIAotI2luY2x1ZGUgImRy
bV9jcnRjX2ludGVybmFsLmgiCi0jaW5jbHVkZSAiZHJtX2NydGNfaGVscGVyX2ludGVybmFsLmgi
CiAjaW5jbHVkZSAiZHJtX2ludGVybmFsLmgiCiAKIHN0YXRpYyBib29sIGRybV9mYmRldl9lbXVs
YXRpb24gPSB0cnVlOwpAQCAtMzg4LDIzMyArMzg1LDYgQEAgaW50IGRybV9mYl9oZWxwZXJfZGVi
dWdfbGVhdmUoc3RydWN0IGZiX2luZm8gKmluZm8pCiB9CiBFWFBPUlRfU1lNQk9MKGRybV9mYl9o
ZWxwZXJfZGVidWdfbGVhdmUpOwogCi0vKioKLSAqIGRybV9jbGllbnRfcGFuZWxfcm90YXRpb24o
KSAtIENoZWNrIHBhbmVsIG9yaWVudGF0aW9uCi0gKiBAbW9kZXNldDogRFJNIG1vZGVzZXQKLSAq
IEByb3RhdGlvbjogUmV0dXJuZWQgcm90YXRpb24gdmFsdWUKLSAqCi0gKiBUaGlzIGZ1bmN0aW9u
IGNoZWNrcyBpZiB0aGUgcHJpbWFyeSBwbGFuZSBpbiBAbW9kZXNldCBjYW4gaHcgcm90YXRlIHRv
IG1hdGNoCi0gKiB0aGUgcGFuZWwgb3JpZW50YXRpb24gb24gaXRzIGNvbm5lY3Rvci4KLSAqCi0g
KiBOb3RlOiBDdXJyZW50bHkgb25seSAwIGFuZCAxODAgZGVncmVlcyBhcmUgc3VwcG9ydGVkLgot
ICoKLSAqIFJldHVybjoKLSAqIFRydWUgaWYgdGhlIHBsYW5lIGNhbiBkbyB0aGUgcm90YXRpb24s
IGZhbHNlIG90aGVyd2lzZS4KLSAqLwotYm9vbCBkcm1fY2xpZW50X3BhbmVsX3JvdGF0aW9uKHN0
cnVjdCBkcm1fbW9kZV9zZXQgKm1vZGVzZXQsIHVuc2lnbmVkIGludCAqcm90YXRpb24pCi17Ci0J
c3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvciA9IG1vZGVzZXQtPmNvbm5lY3RvcnNbMF07
Ci0Jc3RydWN0IGRybV9wbGFuZSAqcGxhbmUgPSBtb2Rlc2V0LT5jcnRjLT5wcmltYXJ5OwotCXU2
NCB2YWxpZF9tYXNrID0gMDsKLQl1bnNpZ25lZCBpbnQgaTsKLQotCWlmICghbW9kZXNldC0+bnVt
X2Nvbm5lY3RvcnMpCi0JCXJldHVybiBmYWxzZTsKLQotCXN3aXRjaCAoY29ubmVjdG9yLT5kaXNw
bGF5X2luZm8ucGFuZWxfb3JpZW50YXRpb24pIHsKLQljYXNlIERSTV9NT0RFX1BBTkVMX09SSUVO
VEFUSU9OX0JPVFRPTV9VUDoKLQkJKnJvdGF0aW9uID0gRFJNX01PREVfUk9UQVRFXzE4MDsKLQkJ
YnJlYWs7Ci0JY2FzZSBEUk1fTU9ERV9QQU5FTF9PUklFTlRBVElPTl9MRUZUX1VQOgotCQkqcm90
YXRpb24gPSBEUk1fTU9ERV9ST1RBVEVfOTA7Ci0JCWJyZWFrOwotCWNhc2UgRFJNX01PREVfUEFO
RUxfT1JJRU5UQVRJT05fUklHSFRfVVA6Ci0JCSpyb3RhdGlvbiA9IERSTV9NT0RFX1JPVEFURV8y
NzA7Ci0JCWJyZWFrOwotCWRlZmF1bHQ6Ci0JCSpyb3RhdGlvbiA9IERSTV9NT0RFX1JPVEFURV8w
OwotCX0KLQotCS8qCi0JICogVE9ETzogc3VwcG9ydCA5MCAvIDI3MCBkZWdyZWUgaGFyZHdhcmUg
cm90YXRpb24sCi0JICogZGVwZW5kaW5nIG9uIHRoZSBoYXJkd2FyZSB0aGlzIG1heSByZXF1aXJl
IHRoZSBmcmFtZWJ1ZmZlcgotCSAqIHRvIGJlIGluIGEgc3BlY2lmaWMgdGlsaW5nIGZvcm1hdC4K
LQkgKi8KLQlpZiAoKnJvdGF0aW9uICE9IERSTV9NT0RFX1JPVEFURV8xODAgfHwgIXBsYW5lLT5y
b3RhdGlvbl9wcm9wZXJ0eSkKLQkJcmV0dXJuIGZhbHNlOwotCi0JZm9yIChpID0gMDsgaSA8IHBs
YW5lLT5yb3RhdGlvbl9wcm9wZXJ0eS0+bnVtX3ZhbHVlczsgaSsrKQotCQl2YWxpZF9tYXNrIHw9
ICgxVUxMIDw8IHBsYW5lLT5yb3RhdGlvbl9wcm9wZXJ0eS0+dmFsdWVzW2ldKTsKLQotCWlmICgh
KCpyb3RhdGlvbiAmIHZhbGlkX21hc2spKQotCQlyZXR1cm4gZmFsc2U7Ci0KLQlyZXR1cm4gdHJ1
ZTsKLX0KLQotc3RhdGljIGludCBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2F0b21pYyhzdHJ1
Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCwgYm9vbCBhY3RpdmUpCi17Ci0Jc3RydWN0IGRybV9k
ZXZpY2UgKmRldiA9IGNsaWVudC0+ZGV2OwotCXN0cnVjdCBkcm1fcGxhbmVfc3RhdGUgKnBsYW5l
X3N0YXRlOwotCXN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lOwotCXN0cnVjdCBkcm1fYXRvbWljX3N0
YXRlICpzdGF0ZTsKLQlzdHJ1Y3QgZHJtX21vZGVzZXRfYWNxdWlyZV9jdHggY3R4OwotCXN0cnVj
dCBkcm1fbW9kZV9zZXQgKm1vZGVfc2V0OwotCWludCByZXQ7Ci0KLQlkcm1fbW9kZXNldF9hY3F1
aXJlX2luaXQoJmN0eCwgMCk7Ci0KLQlzdGF0ZSA9IGRybV9hdG9taWNfc3RhdGVfYWxsb2MoZGV2
KTsKLQlpZiAoIXN0YXRlKSB7Ci0JCXJldCA9IC1FTk9NRU07Ci0JCWdvdG8gb3V0X2N0eDsKLQl9
Ci0KLQlzdGF0ZS0+YWNxdWlyZV9jdHggPSAmY3R4OwotcmV0cnk6Ci0JZHJtX2Zvcl9lYWNoX3Bs
YW5lKHBsYW5lLCBkZXYpIHsKLQkJcGxhbmVfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9wbGFuZV9z
dGF0ZShzdGF0ZSwgcGxhbmUpOwotCQlpZiAoSVNfRVJSKHBsYW5lX3N0YXRlKSkgewotCQkJcmV0
ID0gUFRSX0VSUihwbGFuZV9zdGF0ZSk7Ci0JCQlnb3RvIG91dF9zdGF0ZTsKLQkJfQotCi0JCXBs
YW5lX3N0YXRlLT5yb3RhdGlvbiA9IERSTV9NT0RFX1JPVEFURV8wOwotCi0JCS8qIGRpc2FibGUg
bm9uLXByaW1hcnk6ICovCi0JCWlmIChwbGFuZS0+dHlwZSA9PSBEUk1fUExBTkVfVFlQRV9QUklN
QVJZKQotCQkJY29udGludWU7Ci0KLQkJcmV0ID0gX19kcm1fYXRvbWljX2hlbHBlcl9kaXNhYmxl
X3BsYW5lKHBsYW5lLCBwbGFuZV9zdGF0ZSk7Ci0JCWlmIChyZXQgIT0gMCkKLQkJCWdvdG8gb3V0
X3N0YXRlOwotCX0KLQotCWRybV9jbGllbnRfZm9yX2VhY2hfbW9kZXNldChtb2RlX3NldCwgY2xp
ZW50KSB7Ci0JCXN0cnVjdCBkcm1fcGxhbmUgKnByaW1hcnkgPSBtb2RlX3NldC0+Y3J0Yy0+cHJp
bWFyeTsKLQkJdW5zaWduZWQgaW50IHJvdGF0aW9uOwotCi0JCWlmIChkcm1fY2xpZW50X3BhbmVs
X3JvdGF0aW9uKG1vZGVfc2V0LCAmcm90YXRpb24pKSB7Ci0JCQkvKiBDYW5ub3QgZmFpbCBhcyB3
ZSd2ZSBhbHJlYWR5IGdvdHRlbiB0aGUgcGxhbmUgc3RhdGUgYWJvdmUgKi8KLQkJCXBsYW5lX3N0
YXRlID0gZHJtX2F0b21pY19nZXRfbmV3X3BsYW5lX3N0YXRlKHN0YXRlLCBwcmltYXJ5KTsKLQkJ
CXBsYW5lX3N0YXRlLT5yb3RhdGlvbiA9IHJvdGF0aW9uOwotCQl9Ci0KLQkJcmV0ID0gX19kcm1f
YXRvbWljX2hlbHBlcl9zZXRfY29uZmlnKG1vZGVfc2V0LCBzdGF0ZSk7Ci0JCWlmIChyZXQgIT0g
MCkKLQkJCWdvdG8gb3V0X3N0YXRlOwotCi0JCS8qCi0JCSAqIF9fZHJtX2F0b21pY19oZWxwZXJf
c2V0X2NvbmZpZygpIHNldHMgYWN0aXZlIHdoZW4gYQotCQkgKiBtb2RlIGlzIHNldCwgdW5jb25k
aXRpb25hbGx5IGNsZWFyIGl0IGlmIHdlIGZvcmNlIERQTVMgb2ZmCi0JCSAqLwotCQlpZiAoIWFj
dGl2ZSkgewotCQkJc3RydWN0IGRybV9jcnRjICpjcnRjID0gbW9kZV9zZXQtPmNydGM7Ci0JCQlz
dHJ1Y3QgZHJtX2NydGNfc3RhdGUgKmNydGNfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9uZXdfY3J0
Y19zdGF0ZShzdGF0ZSwgY3J0Yyk7Ci0KLQkJCWNydGNfc3RhdGUtPmFjdGl2ZSA9IGZhbHNlOwot
CQl9Ci0JfQotCi0JcmV0ID0gZHJtX2F0b21pY19jb21taXQoc3RhdGUpOwotCi1vdXRfc3RhdGU6
Ci0JaWYgKHJldCA9PSAtRURFQURMSykKLQkJZ290byBiYWNrb2ZmOwotCi0JZHJtX2F0b21pY19z
dGF0ZV9wdXQoc3RhdGUpOwotb3V0X2N0eDoKLQlkcm1fbW9kZXNldF9kcm9wX2xvY2tzKCZjdHgp
OwotCWRybV9tb2Rlc2V0X2FjcXVpcmVfZmluaSgmY3R4KTsKLQotCXJldHVybiByZXQ7Ci0KLWJh
Y2tvZmY6Ci0JZHJtX2F0b21pY19zdGF0ZV9jbGVhcihzdGF0ZSk7Ci0JZHJtX21vZGVzZXRfYmFj
a29mZigmY3R4KTsKLQotCWdvdG8gcmV0cnk7Ci19Ci0KLXN0YXRpYyBpbnQgZHJtX2NsaWVudF9t
b2Rlc2V0X2NvbW1pdF9sZWdhY3koc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpCi17Ci0J
c3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVudC0+ZGV2OwotCXN0cnVjdCBkcm1fbW9kZV9z
ZXQgKm1vZGVfc2V0OwotCXN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lOwotCWludCByZXQgPSAwOwot
Ci0JZHJtX21vZGVzZXRfbG9ja19hbGwoZGV2KTsKLQlkcm1fZm9yX2VhY2hfcGxhbmUocGxhbmUs
IGRldikgewotCQlpZiAocGxhbmUtPnR5cGUgIT0gRFJNX1BMQU5FX1RZUEVfUFJJTUFSWSkKLQkJ
CWRybV9wbGFuZV9mb3JjZV9kaXNhYmxlKHBsYW5lKTsKLQotCQlpZiAocGxhbmUtPnJvdGF0aW9u
X3Byb3BlcnR5KQotCQkJZHJtX21vZGVfcGxhbmVfc2V0X29ial9wcm9wKHBsYW5lLAotCQkJCQkJ
ICAgIHBsYW5lLT5yb3RhdGlvbl9wcm9wZXJ0eSwKLQkJCQkJCSAgICBEUk1fTU9ERV9ST1RBVEVf
MCk7Ci0JfQotCi0JZHJtX2NsaWVudF9mb3JfZWFjaF9tb2Rlc2V0KG1vZGVfc2V0LCBjbGllbnQp
IHsKLQkJc3RydWN0IGRybV9jcnRjICpjcnRjID0gbW9kZV9zZXQtPmNydGM7Ci0KLQkJaWYgKGNy
dGMtPmZ1bmNzLT5jdXJzb3Jfc2V0MikgewotCQkJcmV0ID0gY3J0Yy0+ZnVuY3MtPmN1cnNvcl9z
ZXQyKGNydGMsIE5VTEwsIDAsIDAsIDAsIDAsIDApOwotCQkJaWYgKHJldCkKLQkJCQlnb3RvIG91
dDsKLQkJfSBlbHNlIGlmIChjcnRjLT5mdW5jcy0+Y3Vyc29yX3NldCkgewotCQkJcmV0ID0gY3J0
Yy0+ZnVuY3MtPmN1cnNvcl9zZXQoY3J0YywgTlVMTCwgMCwgMCwgMCk7Ci0JCQlpZiAocmV0KQot
CQkJCWdvdG8gb3V0OwotCQl9Ci0KLQkJcmV0ID0gZHJtX21vZGVfc2V0X2NvbmZpZ19pbnRlcm5h
bChtb2RlX3NldCk7Ci0JCWlmIChyZXQpCi0JCQlnb3RvIG91dDsKLQl9Ci1vdXQ6Ci0JZHJtX21v
ZGVzZXRfdW5sb2NrX2FsbChkZXYpOwotCi0JcmV0dXJuIHJldDsKLX0KLQotLyoqCi0gKiBkcm1f
Y2xpZW50X21vZGVzZXRfY29tbWl0X2ZvcmNlKCkgLSBGb3JjZSBjb21taXQgQ1JUQyBjb25maWd1
cmF0aW9uCi0gKiBAY2xpZW50OiBEUk0gY2xpZW50Ci0gKgotICogQ29tbWl0IG1vZGVzZXQgY29u
ZmlndXJhdGlvbiB0byBjcnRjcyB3aXRob3V0IGNoZWNraW5nIGlmIHRoZXJlIGlzIGEgRFJNIG1h
c3Rlci4KLSAqCi0gKiBSZXR1cm5zOgotICogWmVybyBvbiBzdWNjZXNzIG9yIG5lZ2F0aXZlIGVy
cm9yIGNvZGUgb24gZmFpbHVyZS4KLSAqLwotaW50IGRybV9jbGllbnRfbW9kZXNldF9jb21taXRf
Zm9yY2Uoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpCi17Ci0Jc3RydWN0IGRybV9kZXZp
Y2UgKmRldiA9IGNsaWVudC0+ZGV2OwotCWludCByZXQ7Ci0KLQltdXRleF9sb2NrKCZjbGllbnQt
Pm1vZGVzZXRfbXV0ZXgpOwotCWlmIChkcm1fZHJ2X3VzZXNfYXRvbWljX21vZGVzZXQoZGV2KSkK
LQkJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9hdG9taWMoY2xpZW50LCB0cnVlKTsK
LQllbHNlCi0JCXJldCA9IGRybV9jbGllbnRfbW9kZXNldF9jb21taXRfbGVnYWN5KGNsaWVudCk7
Ci0JbXV0ZXhfdW5sb2NrKCZjbGllbnQtPm1vZGVzZXRfbXV0ZXgpOwotCi0JcmV0dXJuIHJldDsK
LX0KLQotLyoqCi0gKiBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0KCkgLSBDb21taXQgQ1JUQyBj
b25maWd1cmF0aW9uCi0gKiBAY2xpZW50OiBEUk0gY2xpZW50Ci0gKgotICogQ29tbWl0IG1vZGVz
ZXQgY29uZmlndXJhdGlvbiB0byBjcnRjcy4KLSAqCi0gKiBSZXR1cm5zOgotICogWmVybyBvbiBz
dWNjZXNzIG9yIG5lZ2F0aXZlIGVycm9yIGNvZGUgb24gZmFpbHVyZS4KLSAqLwotaW50IGRybV9j
bGllbnRfbW9kZXNldF9jb21taXQoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpCi17Ci0J
c3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVudC0+ZGV2OwotCWludCByZXQ7Ci0KLQlpZiAo
IWRybV9tYXN0ZXJfaW50ZXJuYWxfYWNxdWlyZShkZXYpKQotCQlyZXR1cm4gLUVCVVNZOwotCi0J
cmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9mb3JjZShjbGllbnQpOwotCi0JZHJtX21h
c3Rlcl9pbnRlcm5hbF9yZWxlYXNlKGRldik7Ci0KLQlyZXR1cm4gcmV0OwotfQotCiAvKioKICAq
IGRybV9mYl9oZWxwZXJfcmVzdG9yZV9mYmRldl9tb2RlX3VubG9ja2VkIC0gcmVzdG9yZSBmYmRl
diBjb25maWd1cmF0aW9uCiAgKiBAZmJfaGVscGVyOiBkcml2ZXItYWxsb2NhdGVkIGZiZGV2IGhl
bHBlciwgY2FuIGJlIE5VTEwKQEAgLTcxNCw1OCArNDg0LDYgQEAgc3RhdGljIHN0cnVjdCBzeXNy
cV9rZXlfb3Agc3lzcnFfZHJtX2ZiX2hlbHBlcl9yZXN0b3JlX29wID0gewogc3RhdGljIHN0cnVj
dCBzeXNycV9rZXlfb3Agc3lzcnFfZHJtX2ZiX2hlbHBlcl9yZXN0b3JlX29wID0geyB9OwogI2Vu
ZGlmCiAKLXN0YXRpYyB2b2lkIGRybV9jbGllbnRfbW9kZXNldF9kcG1zX2xlZ2FjeShzdHJ1Y3Qg
ZHJtX2NsaWVudF9kZXYgKmNsaWVudCwgaW50IGRwbXNfbW9kZSkKLXsKLQlzdHJ1Y3QgZHJtX2Rl
dmljZSAqZGV2ID0gY2xpZW50LT5kZXY7Ci0Jc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3Rv
cjsKLQlzdHJ1Y3QgZHJtX21vZGVfc2V0ICptb2Rlc2V0OwotCWludCBqOwotCi0JZHJtX21vZGVz
ZXRfbG9ja19hbGwoZGV2KTsKLQlkcm1fY2xpZW50X2Zvcl9lYWNoX21vZGVzZXQobW9kZXNldCwg
Y2xpZW50KSB7Ci0JCWlmICghbW9kZXNldC0+Y3J0Yy0+ZW5hYmxlZCkKLQkJCWNvbnRpbnVlOwot
Ci0JCWZvciAoaiA9IDA7IGogPCBtb2Rlc2V0LT5udW1fY29ubmVjdG9yczsgaisrKSB7Ci0JCQlj
b25uZWN0b3IgPSBtb2Rlc2V0LT5jb25uZWN0b3JzW2pdOwotCQkJY29ubmVjdG9yLT5mdW5jcy0+
ZHBtcyhjb25uZWN0b3IsIGRwbXNfbW9kZSk7Ci0JCQlkcm1fb2JqZWN0X3Byb3BlcnR5X3NldF92
YWx1ZSgmY29ubmVjdG9yLT5iYXNlLAotCQkJCWRldi0+bW9kZV9jb25maWcuZHBtc19wcm9wZXJ0
eSwgZHBtc19tb2RlKTsKLQkJfQotCX0KLQlkcm1fbW9kZXNldF91bmxvY2tfYWxsKGRldik7Ci19
Ci0KLS8qKgotICogZHJtX2NsaWVudF9tb2Rlc2V0X2RwbXMoKSAtIFNldCBEUE1TIG1vZGUKLSAq
IEBjbGllbnQ6IERSTSBjbGllbnQKLSAqIEBtb2RlOiBEUE1TIG1vZGUKLSAqCi0gKiBOb3RlOiBG
b3IgYXRvbWljIGRyaXZlcnMgQG1vZGUgaXMgcmVkdWNlZCB0byBvbi9vZmYuCi0gKgotICogUmV0
dXJuczoKLSAqIFplcm8gb24gc3VjY2VzcyBvciBuZWdhdGl2ZSBlcnJvciBjb2RlIG9uIGZhaWx1
cmUuCi0gKi8KLWludCBkcm1fY2xpZW50X21vZGVzZXRfZHBtcyhzdHJ1Y3QgZHJtX2NsaWVudF9k
ZXYgKmNsaWVudCwgaW50IG1vZGUpCi17Ci0Jc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVu
dC0+ZGV2OwotCWludCByZXQgPSAwOwotCi0JaWYgKCFkcm1fbWFzdGVyX2ludGVybmFsX2FjcXVp
cmUoZGV2KSkKLQkJcmV0dXJuIC1FQlVTWTsKLQotCW11dGV4X2xvY2soJmNsaWVudC0+bW9kZXNl
dF9tdXRleCk7Ci0JaWYgKGRybV9kcnZfdXNlc19hdG9taWNfbW9kZXNldChkZXYpKQotCQlyZXQg
PSBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2F0b21pYyhjbGllbnQsIG1vZGUgPT0gRFJNX01P
REVfRFBNU19PTik7Ci0JZWxzZQotCQlkcm1fY2xpZW50X21vZGVzZXRfZHBtc19sZWdhY3koY2xp
ZW50LCBtb2RlKTsKLQltdXRleF91bmxvY2soJmNsaWVudC0+bW9kZXNldF9tdXRleCk7Ci0KLQlk
cm1fbWFzdGVyX2ludGVybmFsX3JlbGVhc2UoZGV2KTsKLQotCXJldHVybiByZXQ7Ci19Ci0KIHN0
YXRpYyB2b2lkIGRybV9mYl9oZWxwZXJfZHBtcyhzdHJ1Y3QgZmJfaW5mbyAqaW5mbywgaW50IGRw
bXNfbW9kZSkKIHsKIAlzdHJ1Y3QgZHJtX2ZiX2hlbHBlciAqZmJfaGVscGVyID0gaW5mby0+cGFy
OwpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9kcm0vZHJtX2NsaWVudC5oIGIvaW5jbHVkZS9kcm0vZHJt
X2NsaWVudC5oCmluZGV4IDg3YmU5YWViMWZlMC4uNmNmNDg0MTlmNzdmIDEwMDY0NAotLS0gYS9p
bmNsdWRlL2RybS9kcm1fY2xpZW50LmgKKysrIGIvaW5jbHVkZS9kcm0vZHJtX2NsaWVudC5oCkBA
IC0xNTUsNiArMTU1LDEwIEBAIGludCBkcm1fY2xpZW50X21vZGVzZXRfY3JlYXRlKHN0cnVjdCBk
cm1fY2xpZW50X2RldiAqY2xpZW50KTsKIHZvaWQgZHJtX2NsaWVudF9tb2Rlc2V0X2ZyZWUoc3Ry
dWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpOwogdm9pZCBkcm1fY2xpZW50X21vZGVzZXRfcmVs
ZWFzZShzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCk7CiBzdHJ1Y3QgZHJtX21vZGVfc2V0
ICpkcm1fY2xpZW50X2ZpbmRfbW9kZXNldChzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCwg
c3RydWN0IGRybV9jcnRjICpjcnRjKTsKK2Jvb2wgZHJtX2NsaWVudF9wYW5lbF9yb3RhdGlvbihz
dHJ1Y3QgZHJtX21vZGVfc2V0ICptb2Rlc2V0LCB1bnNpZ25lZCBpbnQgKnJvdGF0aW9uKTsKK2lu
dCBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2ZvcmNlKHN0cnVjdCBkcm1fY2xpZW50X2RldiAq
Y2xpZW50KTsKK2ludCBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0KHN0cnVjdCBkcm1fY2xpZW50
X2RldiAqY2xpZW50KTsKK2ludCBkcm1fY2xpZW50X21vZGVzZXRfZHBtcyhzdHJ1Y3QgZHJtX2Ns
aWVudF9kZXYgKmNsaWVudCwgaW50IG1vZGUpOwogCiAvKioKICAqIGRybV9jbGllbnRfZm9yX2Vh
Y2hfbW9kZXNldCgpIC0gSXRlcmF0ZSBvdmVyIGNsaWVudCBtb2Rlc2V0cwotLSAKMi4yMC4xCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwg
bWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0
cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
