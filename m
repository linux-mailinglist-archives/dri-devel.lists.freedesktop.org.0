Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id AB9B42820EC
	for <lists+dri-devel@lfdr.de>; Sat,  3 Oct 2020 06:03:19 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 4B84E6EA37;
	Sat,  3 Oct 2020 04:03:15 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pj1-x1044.google.com (mail-pj1-x1044.google.com
 [IPv6:2607:f8b0:4864:20::1044])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8F2DF6EA37
 for <dri-devel@lists.freedesktop.org>; Sat,  3 Oct 2020 04:03:13 +0000 (UTC)
Received: by mail-pj1-x1044.google.com with SMTP id p21so2321560pju.0
 for <dri-devel@lists.freedesktop.org>; Fri, 02 Oct 2020 21:03:13 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=PGBUf2FeLay+nQHyuni0t4hgT0kPOlsr2Zfrvy6inwQ=;
 b=dlmqtogwHIsTBC7zsDHkdYC3vPfe+xOYAzKF2XBWDKezceULr8cxnchrdhZ47vJkF/
 Yf/yIs3uNKubchja1cAPvlaDQidn2DY6o8YYHf/fpF2plRQpgv17W6ZlvPIByJjPUc8j
 hKwxAeraiMdPRWzmkfvf3NqIHRR/XxkvHPq8KmUxmRN2gx2t9VuX0B5U18JMuym+7JKL
 8Qo4oAg7HHxMO9aHrBMqnI3bFtarP/DlMF+7ExOErzVxgtH3w2o3flvLCgvA7AbhNKgJ
 XiDTYWh/CjA2rvvFRZLWJUN27l8D1nKZYPHF50RtTeVPc90jyvidnR30FruSb9vT6WnB
 aLhQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=PGBUf2FeLay+nQHyuni0t4hgT0kPOlsr2Zfrvy6inwQ=;
 b=jwlAAj/x05vneWn3zQ/9fmwRasefEasN+/YZwuOwNIPOeFRdz/rPrWqsLZy1AwCWey
 HxOZpWgAPTsvWPGfjt8y3+BRkTPo0r9ndIPIhqY4bLye3H45jjTGvnNHoQ1lgaWy1m+I
 qBF5hIXiAMap7iND2CYe+xn07wL6LNn/COnlGyivTgq9DRQEwYT26YnyXWBULxar1Yrn
 PdXNua+y69nKIWqgo7zRKYfLVmEATDFRldzIxkDNENuA2vmt7HT/2Dw3Nnnf1/iBgPPo
 VGcmjssIpKwI+Xtf7SKEa2od1yVumqa+MAzcYGgPDZnHvgdHzDigF+5qjw8zylBS7heY
 4ihg==
X-Gm-Message-State: AOAM533eA7OkBRDPSfSi01mkS84PQIwJCDJurcrpZhxJtIJLUIp3QwLS
 oPw/dY2QqoN59egbsJYkJ76nlQ==
X-Google-Smtp-Source: ABdhPJw6x2iomjFWYCIIvf5UjciBYCwEdh1abbohvzeAGK4/bURbgJbONxDzpE2X9WEYhi02wVdmLQ==
X-Received: by 2002:a17:90b:1114:: with SMTP id
 gi20mr5784908pjb.12.1601697793150; 
 Fri, 02 Oct 2020 21:03:13 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 190sm3909290pfy.22.2020.10.02.21.03.11
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 02 Oct 2020 21:03:12 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v3 5/7] dma-buf: system_heap: Allocate higher order pages if
 available
Date: Sat,  3 Oct 2020 04:02:55 +0000
Message-Id: <20201003040257.62768-6-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20201003040257.62768-1-john.stultz@linaro.org>
References: <20201003040257.62768-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sandeep Patil <sspatil@google.com>, dri-devel@lists.freedesktop.org,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Chris Goldsworthy <cgoldswo@codeaurora.org>,
 Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 linux-media@vger.kernel.org, Suren Baghdasaryan <surenb@google.com>,
 Daniel Mentz <danielmentz@google.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2hpbGUgdGhlIHN5c3RlbSBoZWFwIGNhbiByZXR1cm4gbm9uLWNvbnRpZ3VvdXMgcGFnZXMsCnRy
eSB0byBhbGxvY2F0ZSBsYXJnZXIgb3JkZXIgcGFnZXMgaWYgcG9zc2libGUuCgpUaGlzIHdpbGwg
YWxsb3cgc2xpZ2h0IHBlcmZvcm1hbmNlIGdhaW5zIGFuZCBtYWtlIGltcGxlbWVudGluZwpwYWdl
IHBvb2xpbmcgZWFzaWVyLgoKQ2M6IFN1bWl0IFNlbXdhbCA8c3VtaXQuc2Vtd2FsQGxpbmFyby5v
cmc+CkNjOiBMaWFtIE1hcmsgPGxtYXJrQGNvZGVhdXJvcmEub3JnPgpDYzogTGF1cmEgQWJib3R0
IDxsYWJib3R0QGtlcm5lbC5vcmc+CkNjOiBCcmlhbiBTdGFya2V5IDxCcmlhbi5TdGFya2V5QGFy
bS5jb20+CkNjOiBIcmlkeWEgVmFsc2FyYWp1IDxocmlkeWFAZ29vZ2xlLmNvbT4KQ2M6IFN1cmVu
IEJhZ2hkYXNhcnlhbiA8c3VyZW5iQGdvb2dsZS5jb20+CkNjOiBTYW5kZWVwIFBhdGlsIDxzc3Bh
dGlsQGdvb2dsZS5jb20+CkNjOiBEYW5pZWwgTWVudHogPGRhbmllbG1lbnR6QGdvb2dsZS5jb20+
CkNjOiBDaHJpcyBHb2xkc3dvcnRoeSA8Y2dvbGRzd29AY29kZWF1cm9yYS5vcmc+CkNjOiDDmHJq
YW4gRWlkZSA8b3JqYW4uZWlkZUBhcm0uY29tPgpDYzogUm9iaW4gTXVycGh5IDxyb2Jpbi5tdXJw
aHlAYXJtLmNvbT4KQ2M6IEV6ZXF1aWVsIEdhcmNpYSA8ZXplcXVpZWxAY29sbGFib3JhLmNvbT4K
Q2M6IFNpbW9uIFNlciA8Y29udGFjdEBlbWVyc2lvbi5mcj4KQ2M6IEphbWVzIEpvbmVzIDxqYWpv
bmVzQG52aWRpYS5jb20+CkNjOiBsaW51eC1tZWRpYUB2Z2VyLmtlcm5lbC5vcmcKQ2M6IGRyaS1k
ZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKU2lnbmVkLW9mZi1ieTogSm9obiBTdHVsdHogPGpv
aG4uc3R1bHR6QGxpbmFyby5vcmc+Ci0tLQp2MzoKKiBVc2UgcGFnZV9zaXplKCkgcmF0aGVyIHRo
ZW4gb3BlbmNvZGluZyBpdAotLS0KIGRyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9zeXN0ZW1faGVhcC5j
IHwgODMgKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA2NSBp
bnNlcnRpb25zKCspLCAxOCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1i
dWYvaGVhcHMvc3lzdGVtX2hlYXAuYyBiL2RyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9zeXN0ZW1faGVh
cC5jCmluZGV4IGVmOGQ0N2U1YTdmZi4uMmI4ZDRiNmFiYWNiIDEwMDY0NAotLS0gYS9kcml2ZXJz
L2RtYS1idWYvaGVhcHMvc3lzdGVtX2hlYXAuYworKysgYi9kcml2ZXJzL2RtYS1idWYvaGVhcHMv
c3lzdGVtX2hlYXAuYwpAQCAtNDAsNiArNDAsMTQgQEAgc3RydWN0IGRtYV9oZWFwX2F0dGFjaG1l
bnQgewogCWJvb2wgbWFwcGVkOwogfTsKIAorI2RlZmluZSBISUdIX09SREVSX0dGUCAgKCgoR0ZQ
X0hJR0hVU0VSIHwgX19HRlBfWkVSTyB8IF9fR0ZQX05PV0FSTiBcCisJCQkJfCBfX0dGUF9OT1JF
VFJZKSAmIH5fX0dGUF9SRUNMQUlNKSBcCisJCQkJfCBfX0dGUF9DT01QKQorI2RlZmluZSBMT1df
T1JERVJfR0ZQIChHRlBfSElHSFVTRVIgfCBfX0dGUF9aRVJPIHwgX19HRlBfQ09NUCkKK3N0YXRp
YyBnZnBfdCBvcmRlcl9mbGFnc1tdID0ge0hJR0hfT1JERVJfR0ZQLCBMT1dfT1JERVJfR0ZQLCBM
T1dfT1JERVJfR0ZQfTsKK3N0YXRpYyBjb25zdCB1bnNpZ25lZCBpbnQgb3JkZXJzW10gPSB7OCwg
NCwgMH07CisjZGVmaW5lIE5VTV9PUkRFUlMgQVJSQVlfU0laRShvcmRlcnMpCisKIHN0YXRpYyBz
dHJ1Y3Qgc2dfdGFibGUgKmR1cF9zZ190YWJsZShzdHJ1Y3Qgc2dfdGFibGUgKnRhYmxlKQogewog
CXN0cnVjdCBzZ190YWJsZSAqbmV3X3RhYmxlOwpAQCAtMjcwLDggKzI3OCwxMSBAQCBzdGF0aWMg
dm9pZCBzeXN0ZW1faGVhcF9kbWFfYnVmX3JlbGVhc2Uoc3RydWN0IGRtYV9idWYgKmRtYWJ1ZikK
IAlpbnQgaTsKIAogCXRhYmxlID0gJmJ1ZmZlci0+c2dfdGFibGU7Ci0JZm9yX2VhY2hfc2d0YWJs
ZV9zZyh0YWJsZSwgc2csIGkpCi0JCV9fZnJlZV9wYWdlKHNnX3BhZ2Uoc2cpKTsKKwlmb3JfZWFj
aF9zZyh0YWJsZS0+c2dsLCBzZywgdGFibGUtPm5lbnRzLCBpKSB7CisJCXN0cnVjdCBwYWdlICpw
YWdlID0gc2dfcGFnZShzZyk7CisKKwkJX19mcmVlX3BhZ2VzKHBhZ2UsIGNvbXBvdW5kX29yZGVy
KHBhZ2UpKTsKKwl9CiAJc2dfZnJlZV90YWJsZSh0YWJsZSk7CiAJa2ZyZWUoYnVmZmVyKTsKIH0K
QEAgLTI4OSw2ICszMDAsMjYgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfYnVmX29wcyBzeXN0
ZW1faGVhcF9idWZfb3BzID0gewogCS5yZWxlYXNlID0gc3lzdGVtX2hlYXBfZG1hX2J1Zl9yZWxl
YXNlLAogfTsKIAorc3RhdGljIHN0cnVjdCBwYWdlICphbGxvY19sYXJnZXN0X2F2YWlsYWJsZSh1
bnNpZ25lZCBsb25nIHNpemUsCisJCQkJCSAgICB1bnNpZ25lZCBpbnQgbWF4X29yZGVyKQorewor
CXN0cnVjdCBwYWdlICpwYWdlOworCWludCBpOworCisJZm9yIChpID0gMDsgaSA8IE5VTV9PUkRF
UlM7IGkrKykgeworCQlpZiAoc2l6ZSA8ICAoUEFHRV9TSVpFIDw8IG9yZGVyc1tpXSkpCisJCQlj
b250aW51ZTsKKwkJaWYgKG1heF9vcmRlciA8IG9yZGVyc1tpXSkKKwkJCWNvbnRpbnVlOworCisJ
CXBhZ2UgPSBhbGxvY19wYWdlcyhvcmRlcl9mbGFnc1tpXSwgb3JkZXJzW2ldKTsKKwkJaWYgKCFw
YWdlKQorCQkJY29udGludWU7CisJCXJldHVybiBwYWdlOworCX0KKwlyZXR1cm4gTlVMTDsKK30K
Kwogc3RhdGljIGludCBzeXN0ZW1faGVhcF9hbGxvY2F0ZShzdHJ1Y3QgZG1hX2hlYXAgKmhlYXAs
CiAJCQkJdW5zaWduZWQgbG9uZyBsZW4sCiAJCQkJdW5zaWduZWQgbG9uZyBmZF9mbGFncywKQEAg
LTI5NiwxMSArMzI3LDEzIEBAIHN0YXRpYyBpbnQgc3lzdGVtX2hlYXBfYWxsb2NhdGUoc3RydWN0
IGRtYV9oZWFwICpoZWFwLAogewogCXN0cnVjdCBzeXN0ZW1faGVhcF9idWZmZXIgKmJ1ZmZlcjsK
IAlERUZJTkVfRE1BX0JVRl9FWFBPUlRfSU5GTyhleHBfaW5mbyk7CisJdW5zaWduZWQgbG9uZyBz
aXplX3JlbWFpbmluZyA9IGxlbjsKKwl1bnNpZ25lZCBpbnQgbWF4X29yZGVyID0gb3JkZXJzWzBd
OwogCXN0cnVjdCBkbWFfYnVmICpkbWFidWY7CiAJc3RydWN0IHNnX3RhYmxlICp0YWJsZTsKIAlz
dHJ1Y3Qgc2NhdHRlcmxpc3QgKnNnOwotCXBnb2ZmX3QgcGFnZWNvdW50OwotCXBnb2ZmX3QgcGc7
CisJc3RydWN0IGxpc3RfaGVhZCBwYWdlczsKKwlzdHJ1Y3QgcGFnZSAqcGFnZSwgKnRtcF9wYWdl
OwogCWludCBpLCByZXQgPSAtRU5PTUVNOwogCiAJYnVmZmVyID0ga3phbGxvYyhzaXplb2YoKmJ1
ZmZlciksIEdGUF9LRVJORUwpOwpAQCAtMzEyLDI1ICszNDUsMzUgQEAgc3RhdGljIGludCBzeXN0
ZW1faGVhcF9hbGxvY2F0ZShzdHJ1Y3QgZG1hX2hlYXAgKmhlYXAsCiAJYnVmZmVyLT5oZWFwID0g
aGVhcDsKIAlidWZmZXItPmxlbiA9IGxlbjsKIAotCXRhYmxlID0gJmJ1ZmZlci0+c2dfdGFibGU7
Ci0JcGFnZWNvdW50ID0gbGVuIC8gUEFHRV9TSVpFOwotCWlmIChzZ19hbGxvY190YWJsZSh0YWJs
ZSwgcGFnZWNvdW50LCBHRlBfS0VSTkVMKSkKLQkJZ290byBmcmVlX2J1ZmZlcjsKLQotCXNnID0g
dGFibGUtPnNnbDsKLQlmb3IgKHBnID0gMDsgcGcgPCBwYWdlY291bnQ7IHBnKyspIHsKLQkJc3Ry
dWN0IHBhZ2UgKnBhZ2U7CisJSU5JVF9MSVNUX0hFQUQoJnBhZ2VzKTsKKwlpID0gMDsKKwl3aGls
ZSAoc2l6ZV9yZW1haW5pbmcgPiAwKSB7CiAJCS8qCiAJCSAqIEF2b2lkIHRyeWluZyB0byBhbGxv
Y2F0ZSBtZW1vcnkgaWYgdGhlIHByb2Nlc3MKIAkJICogaGFzIGJlZW4ga2lsbGVkIGJ5IFNJR0tJ
TEwKIAkJICovCiAJCWlmIChmYXRhbF9zaWduYWxfcGVuZGluZyhjdXJyZW50KSkKLQkJCWdvdG8g
ZnJlZV9wYWdlczsKLQkJcGFnZSA9IGFsbG9jX3BhZ2UoR0ZQX0tFUk5FTCB8IF9fR0ZQX1pFUk8p
OworCQkJZ290byBmcmVlX2J1ZmZlcjsKKworCQlwYWdlID0gYWxsb2NfbGFyZ2VzdF9hdmFpbGFi
bGUoc2l6ZV9yZW1haW5pbmcsIG1heF9vcmRlcik7CiAJCWlmICghcGFnZSkKLQkJCWdvdG8gZnJl
ZV9wYWdlczsKKwkJCWdvdG8gZnJlZV9idWZmZXI7CisKKwkJbGlzdF9hZGRfdGFpbCgmcGFnZS0+
bHJ1LCAmcGFnZXMpOworCQlzaXplX3JlbWFpbmluZyAtPSBwYWdlX3NpemUocGFnZSk7CisJCW1h
eF9vcmRlciA9IGNvbXBvdW5kX29yZGVyKHBhZ2UpOworCQlpKys7CisJfQorCisJdGFibGUgPSAm
YnVmZmVyLT5zZ190YWJsZTsKKwlpZiAoc2dfYWxsb2NfdGFibGUodGFibGUsIGksIEdGUF9LRVJO
RUwpKQorCQlnb3RvIGZyZWVfYnVmZmVyOworCisJc2cgPSB0YWJsZS0+c2dsOworCWxpc3RfZm9y
X2VhY2hfZW50cnlfc2FmZShwYWdlLCB0bXBfcGFnZSwgJnBhZ2VzLCBscnUpIHsKIAkJc2dfc2V0
X3BhZ2Uoc2csIHBhZ2UsIHBhZ2Vfc2l6ZShwYWdlKSwgMCk7CiAJCXNnID0gc2dfbmV4dChzZyk7
CisJCWxpc3RfZGVsKCZwYWdlLT5scnUpOwogCX0KIAogCS8qIGNyZWF0ZSB0aGUgZG1hYnVmICov
CkBAIC0zNTAsMTQgKzM5MywxOCBAQCBzdGF0aWMgaW50IHN5c3RlbV9oZWFwX2FsbG9jYXRlKHN0
cnVjdCBkbWFfaGVhcCAqaGVhcCwKIAkJLyoganVzdCByZXR1cm4sIGFzIHB1dCB3aWxsIGNhbGwg
cmVsZWFzZSBhbmQgdGhhdCB3aWxsIGZyZWUgKi8KIAkJcmV0dXJuIHJldDsKIAl9Ci0KIAlyZXR1
cm4gcmV0OwogCiBmcmVlX3BhZ2VzOgotCWZvcl9lYWNoX3NndGFibGVfc2codGFibGUsIHNnLCBp
KQotCQlfX2ZyZWVfcGFnZShzZ19wYWdlKHNnKSk7CisJZm9yX2VhY2hfc2d0YWJsZV9zZyh0YWJs
ZSwgc2csIGkpIHsKKwkJc3RydWN0IHBhZ2UgKnAgPSBzZ19wYWdlKHNnKTsKKworCQlfX2ZyZWVf
cGFnZXMocCwgY29tcG91bmRfb3JkZXIocCkpOworCX0KIAlzZ19mcmVlX3RhYmxlKHRhYmxlKTsK
IGZyZWVfYnVmZmVyOgorCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShwYWdlLCB0bXBfcGFnZSwg
JnBhZ2VzLCBscnUpCisJCV9fZnJlZV9wYWdlcyhwYWdlLCBjb21wb3VuZF9vcmRlcihwYWdlKSk7
CiAJa2ZyZWUoYnVmZmVyKTsKIAogCXJldHVybiByZXQ7Ci0tIAoyLjE3LjEKCl9fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxp
c3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNr
dG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
