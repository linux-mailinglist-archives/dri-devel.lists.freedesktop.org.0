Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 2FCE1455DA
	for <lists+dri-devel@lfdr.de>; Fri, 14 Jun 2019 09:23:46 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E0CFF8972D;
	Fri, 14 Jun 2019 07:22:29 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-qt1-x842.google.com (mail-qt1-x842.google.com
 [IPv6:2607:f8b0:4864:20::842])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 332C6892F3
 for <dri-devel@lists.freedesktop.org>; Fri, 14 Jun 2019 00:44:57 +0000 (UTC)
Received: by mail-qt1-x842.google.com with SMTP id x47so569077qtk.11
 for <dri-devel@lists.freedesktop.org>; Thu, 13 Jun 2019 17:44:57 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=iQFZUVD3bm8q29tG8rKodDV9niV08KJ4TO1srbmenK4=;
 b=QVEZZk/7oA5suFvKWdFr3S915nP3ECei2qDew7rYezWyNJ8OG0ak9OHMSeOl5De2Y9
 D/9HKDhdzRirf4rCWKkGBfuei5MBJOOpzpKFdOpWuMPltS4wi9o5fzAXn14AEJ1jcL3O
 4KbFpYGAduKjF3V2GWIWwzrd1K/LB/yOHNoyNtNFILNuDIl7Dml/rJrA7TkLuAhSW3TS
 b2wBUeKc+F6cys7TAqrMcJKq3a7xXsHczNI9GSaOfifPYoeLWjxWT0/XwTOeCYKSx/jr
 +ZGcMQjHjbR/GxJs4uh8kjYGyuIUvYgOXDFsV5jwsGpMp9qvpttnXVunzeGHu/XIVt5Y
 YhBA==
X-Gm-Message-State: APjAAAWoWMSCLSSYueE4j2zcaCFt43OxbQNh47N7KmGN0VwsBIny2guz
 1VJHwMYgLI1qqf2Fvqvc7nTgyg==
X-Google-Smtp-Source: APXvYqw56kQGKLPlj2Zgzkw2ysxgtbRlSboLCdNQH17EQruEZjbScaFJD3FwSz5lL9I3GIRJGcwbsg==
X-Received: by 2002:a0c:afa2:: with SMTP id s31mr5894610qvc.186.1560473096316; 
 Thu, 13 Jun 2019 17:44:56 -0700 (PDT)
Received: from ziepe.ca
 (hlfxns017vw-156-34-55-100.dhcp-dynamic.fibreop.ns.bellaliant.net.
 [156.34.55.100])
 by smtp.gmail.com with ESMTPSA id l3sm683628qkd.49.2019.06.13.17.44.54
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Thu, 13 Jun 2019 17:44:54 -0700 (PDT)
Received: from jgg by mlx.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1hbaKr-0005Jq-Ni; Thu, 13 Jun 2019 21:44:53 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH v3 hmm 04/12] mm/hmm: Simplify hmm_get_or_create and make it
 reliable
Date: Thu, 13 Jun 2019 21:44:42 -0300
Message-Id: <20190614004450.20252-5-jgg@ziepe.ca>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190614004450.20252-1-jgg@ziepe.ca>
References: <20190614004450.20252-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Fri, 14 Jun 2019 07:21:24 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=iQFZUVD3bm8q29tG8rKodDV9niV08KJ4TO1srbmenK4=;
 b=UA1C5NPqvlm8z++G2laNCnwB/GWT7FWVDsQKpzNw396EnXD5grCbfeRcH4MVcv9Pxt
 Bw608pa0SQVwTZPesERpsVjDiheiUA0ZxpcaOhSCg3wFfLyCKPSY6m0rcqgkt0F7+Btu
 VcnvcuEPLZ4+31oNvXwgQ7Mzr5sdaFHqpO9DtB7bD2Mphja5lK5GoftxQttJJRITdM9l
 ZjsrOqKbZRdEDMQmdCny9EgekTtIr+yc7ps9gI2Z9j+YV7fGRjNJ2Dq2ZT34qRz8bx4L
 2H+VNusPv5/abMz/Jh+ee/Y2I8OCp7Q6Wc38Z0vyw+mbGlfjmn34SHlMrcpzNY0sbebl
 RR8A==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, Philip Yang <Philip.Yang@amd.com>,
 linux-rdma@vger.kernel.org, amd-gfx@lists.freedesktop.org, linux-mm@kvack.org,
 Jason Gunthorpe <jgg@mellanox.com>, dri-devel@lists.freedesktop.org,
 Ira Weiny <ira.weiny@intel.com>, Ben Skeggs <bskeggs@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKQXMgY29kZWQgdGhpcyBm
dW5jdGlvbiBjYW4gZmFsc2UtZmFpbCBpbiB2YXJpb3VzIHJhY3kgc2l0dWF0aW9ucy4gTWFrZSBp
dApyZWxpYWJsZSBhbmQgc2ltcGxlciBieSBydW5uaW5nIHVuZGVyIHRoZSB3cml0ZSBzaWRlIG9m
IHRoZSBtbWFwX3NlbSBhbmQKYXZvaWRpbmcgdGhlIGZhbHNlLWZhaWxpbmcgY29tcGFyZS9leGNo
YW5nZSBwYXR0ZXJuLiBEdWUgdG8gdGhlIG1tYXBfc2VtCnRoaXMgbm8gbG9uZ2VyIGhhcyB0byBh
dm9pZCByYWNpbmcgd2l0aCBhIDJuZCBwYXJhbGxlbApobW1fZ2V0X29yX2NyZWF0ZSgpLgoKVW5m
b3J0dW5hdGVseSB0aGlzIHN0aWxsIGhhcyB0byB1c2UgdGhlIHBhZ2VfdGFibGVfbG9jayBhcyB0
aGUKbm9uLXNsZWVwaW5nIGxvY2sgcHJvdGVjdGluZyBtbS0+aG1tLCBzaW5jZSB0aGUgY29udGV4
dHMgd2hlcmUgd2UgZnJlZSB0aGUKaG1tIGFyZSBpbmNvbXBhdGlibGUgd2l0aCBtbWFwX3NlbS4K
ClNpZ25lZC1vZmYtYnk6IEphc29uIEd1bnRob3JwZSA8amdnQG1lbGxhbm94LmNvbT4KUmV2aWV3
ZWQtYnk6IEpvaG4gSHViYmFyZCA8amh1YmJhcmRAbnZpZGlhLmNvbT4KUmV2aWV3ZWQtYnk6IFJh
bHBoIENhbXBiZWxsIDxyY2FtcGJlbGxAbnZpZGlhLmNvbT4KUmV2aWV3ZWQtYnk6IElyYSBXZWlu
eSA8aXJhLndlaW55QGludGVsLmNvbT4KVGVzdGVkLWJ5OiBQaGlsaXAgWWFuZyA8UGhpbGlwLllh
bmdAYW1kLmNvbT4KLS0tCnYyOgotIEZpeCBlcnJvciB1bndpbmQgb2YgbW1ncmFiIChKZXJvbWUp
Ci0gVXNlIGhtbSBsb2NhbCBpbnN0ZWFkIG9mIDJuZCBjb250YWluZXJfb2YgKEplcm9tZSkKdjM6
Ci0gQ2FuJ3QgdXNlIG1tYXBfc2VtIGluIHRoZSBTUkNVIGNhbGxiYWNrLCBrZWVwIHVzaW5nIHRo
ZQogIHBhZ2VfdGFibGVfbG9jayAoUGhpbGlwKQotLS0KIG1tL2htbS5jIHwgODQgKysrKysrKysr
KysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBj
aGFuZ2VkLCAzNiBpbnNlcnRpb25zKCspLCA0OCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9t
bS9obW0uYyBiL21tL2htbS5jCmluZGV4IDA4MGIxN2EyZTg3ZTJkLi40YzY0ZDRjMzJmNDgyNSAx
MDA2NDQKLS0tIGEvbW0vaG1tLmMKKysrIGIvbW0vaG1tLmMKQEAgLTMxLDE2ICszMSw2IEBACiAj
aWYgSVNfRU5BQkxFRChDT05GSUdfSE1NX01JUlJPUikKIHN0YXRpYyBjb25zdCBzdHJ1Y3QgbW11
X25vdGlmaWVyX29wcyBobW1fbW11X25vdGlmaWVyX29wczsKIAotc3RhdGljIGlubGluZSBzdHJ1
Y3QgaG1tICptbV9nZXRfaG1tKHN0cnVjdCBtbV9zdHJ1Y3QgKm1tKQotewotCXN0cnVjdCBobW0g
KmhtbSA9IFJFQURfT05DRShtbS0+aG1tKTsKLQotCWlmIChobW0gJiYga3JlZl9nZXRfdW5sZXNz
X3plcm8oJmhtbS0+a3JlZikpCi0JCXJldHVybiBobW07Ci0KLQlyZXR1cm4gTlVMTDsKLX0KLQog
LyoqCiAgKiBobW1fZ2V0X29yX2NyZWF0ZSAtIHJlZ2lzdGVyIEhNTSBhZ2FpbnN0IGFuIG1tIChI
TU0gaW50ZXJuYWwpCiAgKgpAQCAtNTUsMTEgKzQ1LDE5IEBAIHN0YXRpYyBpbmxpbmUgc3RydWN0
IGhtbSAqbW1fZ2V0X2htbShzdHJ1Y3QgbW1fc3RydWN0ICptbSkKICAqLwogc3RhdGljIHN0cnVj
dCBobW0gKmhtbV9nZXRfb3JfY3JlYXRlKHN0cnVjdCBtbV9zdHJ1Y3QgKm1tKQogewotCXN0cnVj
dCBobW0gKmhtbSA9IG1tX2dldF9obW0obW0pOwotCWJvb2wgY2xlYW51cCA9IGZhbHNlOworCXN0
cnVjdCBobW0gKmhtbTsKIAotCWlmIChobW0pCi0JCXJldHVybiBobW07CisJbG9ja2RlcF9hc3Nl
cnRfaGVsZF9leGNsdXNpdmUoJm1tLT5tbWFwX3NlbSk7CisKKwkvKiBBYnVzZSB0aGUgcGFnZV90
YWJsZV9sb2NrIHRvIGFsc28gcHJvdGVjdCBtbS0+aG1tLiAqLworCXNwaW5fbG9jaygmbW0tPnBh
Z2VfdGFibGVfbG9jayk7CisJaWYgKG1tLT5obW0pIHsKKwkJaWYgKGtyZWZfZ2V0X3VubGVzc196
ZXJvKCZtbS0+aG1tLT5rcmVmKSkgeworCQkJc3Bpbl91bmxvY2soJm1tLT5wYWdlX3RhYmxlX2xv
Y2spOworCQkJcmV0dXJuIG1tLT5obW07CisJCX0KKwl9CisJc3Bpbl91bmxvY2soJm1tLT5wYWdl
X3RhYmxlX2xvY2spOwogCiAJaG1tID0ga21hbGxvYyhzaXplb2YoKmhtbSksIEdGUF9LRVJORUwp
OwogCWlmICghaG1tKQpAQCAtNzQsNTcgKzcyLDQ3IEBAIHN0YXRpYyBzdHJ1Y3QgaG1tICpobW1f
Z2V0X29yX2NyZWF0ZShzdHJ1Y3QgbW1fc3RydWN0ICptbSkKIAlobW0tPm5vdGlmaWVycyA9IDA7
CiAJaG1tLT5kZWFkID0gZmFsc2U7CiAJaG1tLT5tbSA9IG1tOwotCW1tZ3JhYihobW0tPm1tKTsK
IAotCXNwaW5fbG9jaygmbW0tPnBhZ2VfdGFibGVfbG9jayk7Ci0JaWYgKCFtbS0+aG1tKQotCQlt
bS0+aG1tID0gaG1tOwotCWVsc2UKLQkJY2xlYW51cCA9IHRydWU7Ci0Jc3Bpbl91bmxvY2soJm1t
LT5wYWdlX3RhYmxlX2xvY2spOworCWhtbS0+bW11X25vdGlmaWVyLm9wcyA9ICZobW1fbW11X25v
dGlmaWVyX29wczsKKwlpZiAoX19tbXVfbm90aWZpZXJfcmVnaXN0ZXIoJmhtbS0+bW11X25vdGlm
aWVyLCBtbSkpIHsKKwkJa2ZyZWUoaG1tKTsKKwkJcmV0dXJuIE5VTEw7CisJfQogCi0JaWYgKGNs
ZWFudXApCi0JCWdvdG8gZXJyb3I7CisJbW1ncmFiKGhtbS0+bW0pOwogCiAJLyoKLQkgKiBXZSBz
aG91bGQgb25seSBnZXQgaGVyZSBpZiBob2xkIHRoZSBtbWFwX3NlbSBpbiB3cml0ZSBtb2RlIGll
IG9uCi0JICogcmVnaXN0cmF0aW9uIG9mIGZpcnN0IG1pcnJvciB0aHJvdWdoIGhtbV9taXJyb3Jf
cmVnaXN0ZXIoKQorCSAqIFdlIGhvbGQgdGhlIGV4Y2x1c2l2ZSBtbWFwX3NlbSBoZXJlIHNvIHdl
IGtub3cgdGhhdCBtbS0+aG1tIGlzCisJICogc3RpbGwgTlVMTCBvciAwIGtyZWYsIGFuZCBpcyBz
YWZlIHRvIHVwZGF0ZS4KIAkgKi8KLQlobW0tPm1tdV9ub3RpZmllci5vcHMgPSAmaG1tX21tdV9u
b3RpZmllcl9vcHM7Ci0JaWYgKF9fbW11X25vdGlmaWVyX3JlZ2lzdGVyKCZobW0tPm1tdV9ub3Rp
ZmllciwgbW0pKQotCQlnb3RvIGVycm9yX21tOwotCi0JcmV0dXJuIGhtbTsKLQotZXJyb3JfbW06
CiAJc3Bpbl9sb2NrKCZtbS0+cGFnZV90YWJsZV9sb2NrKTsKLQlpZiAobW0tPmhtbSA9PSBobW0p
Ci0JCW1tLT5obW0gPSBOVUxMOworCW1tLT5obW0gPSBobW07CiAJc3Bpbl91bmxvY2soJm1tLT5w
YWdlX3RhYmxlX2xvY2spOwotZXJyb3I6Ci0JbW1kcm9wKGhtbS0+bW0pOwotCWtmcmVlKGhtbSk7
Ci0JcmV0dXJuIE5VTEw7CisJcmV0dXJuIGhtbTsKIH0KIAogc3RhdGljIHZvaWQgaG1tX2ZyZWVf
cmN1KHN0cnVjdCByY3VfaGVhZCAqcmN1KQogewotCWtmcmVlKGNvbnRhaW5lcl9vZihyY3UsIHN0
cnVjdCBobW0sIHJjdSkpOworCXN0cnVjdCBobW0gKmhtbSA9IGNvbnRhaW5lcl9vZihyY3UsIHN0
cnVjdCBobW0sIHJjdSk7CisKKwkvKgorCSAqIFRoZSBtbS0+aG1tIHBvaW50ZXIgaXMga2VwdCB2
YWxpZCB3aGlsZSBub3RpZmllciBvcHMgY2FuIGJlIHJ1bm5pbmcKKwkgKiBzbyB0aGV5IGRvbid0
IGhhdmUgdG8gZGVhbCB3aXRoIGEgTlVMTCBtbS0+aG1tIHZhbHVlCisJICovCisJc3Bpbl9sb2Nr
KCZobW0tPm1tLT5wYWdlX3RhYmxlX2xvY2spOworCWlmIChobW0tPm1tLT5obW0gPT0gaG1tKQor
CQlobW0tPm1tLT5obW0gPSBOVUxMOworCXNwaW5fdW5sb2NrKCZobW0tPm1tLT5wYWdlX3RhYmxl
X2xvY2spOworCW1tZHJvcChobW0tPm1tKTsKKworCWtmcmVlKGhtbSk7CiB9CiAKIHN0YXRpYyB2
b2lkIGhtbV9mcmVlKHN0cnVjdCBrcmVmICprcmVmKQogewogCXN0cnVjdCBobW0gKmhtbSA9IGNv
bnRhaW5lcl9vZihrcmVmLCBzdHJ1Y3QgaG1tLCBrcmVmKTsKLQlzdHJ1Y3QgbW1fc3RydWN0ICpt
bSA9IGhtbS0+bW07Ci0KLQltbXVfbm90aWZpZXJfdW5yZWdpc3Rlcl9ub19yZWxlYXNlKCZobW0t
Pm1tdV9ub3RpZmllciwgbW0pOwogCi0Jc3Bpbl9sb2NrKCZtbS0+cGFnZV90YWJsZV9sb2NrKTsK
LQlpZiAobW0tPmhtbSA9PSBobW0pCi0JCW1tLT5obW0gPSBOVUxMOwotCXNwaW5fdW5sb2NrKCZt
bS0+cGFnZV90YWJsZV9sb2NrKTsKLQotCW1tZHJvcChobW0tPm1tKTsKKwltbXVfbm90aWZpZXJf
dW5yZWdpc3Rlcl9ub19yZWxlYXNlKCZobW0tPm1tdV9ub3RpZmllciwgaG1tLT5tbSk7CiAJbW11
X25vdGlmaWVyX2NhbGxfc3JjdSgmaG1tLT5yY3UsIGhtbV9mcmVlX3JjdSk7CiB9CiAKLS0gCjIu
MjEuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJp
LWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBz
Oi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
