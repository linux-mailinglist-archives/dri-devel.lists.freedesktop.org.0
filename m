Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 0EF93B076F
	for <lists+dri-devel@lfdr.de>; Thu, 12 Sep 2019 06:13:37 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 093016EB5C;
	Thu, 12 Sep 2019 04:12:26 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pl1-x641.google.com (mail-pl1-x641.google.com
 [IPv6:2607:f8b0:4864:20::641])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9D5F06E0E8
 for <dri-devel@lists.freedesktop.org>; Wed, 11 Sep 2019 18:14:15 +0000 (UTC)
Received: by mail-pl1-x641.google.com with SMTP id y10so10500716pll.7
 for <dri-devel@lists.freedesktop.org>; Wed, 11 Sep 2019 11:14:15 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=jXhdF34fWpCmU0rbmWA1E+x/O7viGYJ2RgC8HYIROiY=;
 b=nQWFHrArnZmGEEtUa3MWai8Diyx+Er8al7nSaPBLvbK8L/ai/2JTMQuHy6fiPAz6hQ
 DSkef8wAxzPKaAfUGxKb9j2kcgX8m9s1rxOpLt0QcRWL+X6UeUNUk7COwgEYXJvUEx74
 stEBCofczbgAizziD1aFrW2xVwD798w4Yz6f8FQetPrWogOA9uh5kb1B9syONyOeGQsQ
 NoS1sK4RCEPxbUx+8sDumg7OZ9129gVOQzHsv8QHa1Z4uqom3g75LiKJcCDSvmOVh8Nu
 UslCJBijobQ1OtxXpJy/89+nCitLpl08da/ZnZwqchwg2mvJLf6BseUCO2x/QjEuhfLX
 F/Ig==
X-Gm-Message-State: APjAAAUmAKsbugFUz+J4ByQ1n8Um0fWb30trZGtF+6Wo9DnjrXesLTF1
 7uS0t6SpQ7zysj9Lw0JWtIQ9hEDmo3I=
X-Google-Smtp-Source: APXvYqwijnVpSCyrOk2zNhhDUxXV/lyUbYRDrb2kuDeMwHY0Qts6nLLyXGJqlZOF6xxnhwAcdwSRMw==
X-Received: by 2002:a17:902:7c13:: with SMTP id
 x19mr39596513pll.322.1568225654889; 
 Wed, 11 Sep 2019 11:14:14 -0700 (PDT)
Received: from localhost ([2620:15c:202:1:e9ae:bd45:1bd9:e60d])
 by smtp.gmail.com with ESMTPSA id x8sm22730241pfn.106.2019.09.11.11.14.13
 (version=TLS1_3 cipher=TLS_AES_128_GCM_SHA256 bits=128/128);
 Wed, 11 Sep 2019 11:14:13 -0700 (PDT)
From: David Riley <davidriley@chromium.org>
To: dri-devel@lists.freedesktop.org, virtualization@lists.linux-foundation.org
Subject: [PATCH v4 2/2] drm/virtio: Use vmalloc for command buffer allocations.
Date: Wed, 11 Sep 2019 11:14:03 -0700
Message-Id: <20190911181403.40909-3-davidriley@chromium.org>
X-Mailer: git-send-email 2.23.0.237.gc6a4ce50a0-goog
In-Reply-To: <20190829212417.257397-1-davidriley@chromium.org>
References: <20190829212417.257397-1-davidriley@chromium.org>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=chromium.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=jXhdF34fWpCmU0rbmWA1E+x/O7viGYJ2RgC8HYIROiY=;
 b=RtnXpoYfLAC4rtL4bjrCmE3G/t40XxkLPu1f2NPVTKsBUY/Nn+kVJEeLhS+wDklRXZ
 Qp8eb+ZWa3o4lE4//hp7YBwKhX5JgdtLRGJp7rvmS4YG9U63+TwOiLej1RE6aJqn/EoD
 WYF2kwM264l5jO5pkiy3QQOg66CiAVVz9maZE=
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, linux-kernel@vger.kernel.org,
 Gurchetan Singh <gurchetansingh@chromium.org>,
 Gerd Hoffmann <kraxel@redhat.com>,
 =?UTF-8?q?St=C3=A9phane=20Marchesin?= <marcheu@chromium.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VXNlcnNwYWNlIHJlcXVlc3RlZCBjb21tYW5kIGJ1ZmZlciBhbGxvY2F0aW9ucyBjb3VsZCBiZSB0
b28gbGFyZ2UKdG8gbWFrZSBhcyBhIGNvbnRpZ3VvdXMgYWxsb2NhdGlvbi4gIFVzZSB2bWFsbG9j
IGlmIG5lY2Vzc2FyeSB0bwpzYXRpc2Z5IHRob3NlIGFsbG9jYXRpb25zLgoKU2lnbmVkLW9mZi1i
eTogRGF2aWQgUmlsZXkgPGRhdmlkcmlsZXlAY2hyb21pdW0ub3JnPgotLS0KIGRyaXZlcnMvZ3B1
L2RybS92aXJ0aW8vdmlydGdwdV9pb2N0bC5jIHwgIDQgKy0KIGRyaXZlcnMvZ3B1L2RybS92aXJ0
aW8vdmlydGdwdV92cS5jICAgIHwgNzggKysrKysrKysrKysrKysrKysrKysrKystLS0KIDIgZmls
ZXMgY2hhbmdlZCwgNzIgaW5zZXJ0aW9ucygrKSwgMTAgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2lvY3RsLmMgYi9kcml2ZXJzL2dwdS9k
cm0vdmlydGlvL3ZpcnRncHVfaW9jdGwuYwppbmRleCBmNTA4M2M1MzhmOWMuLjlhZjFlYzYyNDM0
ZiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2lvY3RsLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2lvY3RsLmMKQEAgLTE0Myw3ICsxNDMs
NyBAQCBzdGF0aWMgaW50IHZpcnRpb19ncHVfZXhlY2J1ZmZlcl9pb2N0bChzdHJ1Y3QgZHJtX2Rl
dmljZSAqZGV2LCB2b2lkICpkYXRhLAogCQkJZ290byBvdXRfdW51c2VkX2ZkOwogCX0KIAotCWJ1
ZiA9IG1lbWR1cF91c2VyKHU2NF90b191c2VyX3B0cihleGJ1Zi0+Y29tbWFuZCksIGV4YnVmLT5z
aXplKTsKKwlidWYgPSB2bWVtZHVwX3VzZXIodTY0X3RvX3VzZXJfcHRyKGV4YnVmLT5jb21tYW5k
KSwgZXhidWYtPnNpemUpOwogCWlmIChJU19FUlIoYnVmKSkgewogCQlyZXQgPSBQVFJfRVJSKGJ1
Zik7CiAJCWdvdG8gb3V0X3VucmVzdjsKQEAgLTE3Miw3ICsxNzIsNyBAQCBzdGF0aWMgaW50IHZp
cnRpb19ncHVfZXhlY2J1ZmZlcl9pb2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpk
YXRhLAogCXJldHVybiAwOwogCiBvdXRfbWVtZHVwOgotCWtmcmVlKGJ1Zik7CisJa3ZmcmVlKGJ1
Zik7CiBvdXRfdW5yZXN2OgogCWlmIChidWZsaXN0KQogCQl2aXJ0aW9fZ3B1X2FycmF5X3VubG9j
a19yZXN2KGJ1Zmxpc3QpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0
Z3B1X3ZxLmMgYi9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfdnEuYwppbmRleCA1YTY0
Yzc3NjEzOGQuLjlmOWI3ODJkZDMzMiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZpcnRp
by92aXJ0Z3B1X3ZxLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X3ZxLmMK
QEAgLTE1NSw3ICsxNTUsNyBAQCBzdGF0aWMgdm9pZCBmcmVlX3ZidWYoc3RydWN0IHZpcnRpb19n
cHVfZGV2aWNlICp2Z2RldiwKIHsKIAlpZiAodmJ1Zi0+cmVzcF9zaXplID4gTUFYX0lOTElORV9S
RVNQX1NJWkUpCiAJCWtmcmVlKHZidWYtPnJlc3BfYnVmKTsKLQlrZnJlZSh2YnVmLT5kYXRhX2J1
Zik7CisJa3ZmcmVlKHZidWYtPmRhdGFfYnVmKTsKIAlrbWVtX2NhY2hlX2ZyZWUodmdkZXYtPnZi
dWZzLCB2YnVmKTsKIH0KIApAQCAtMjU2LDEzICsyNTYsNTQgQEAgdm9pZCB2aXJ0aW9fZ3B1X2Rl
cXVldWVfY3Vyc29yX2Z1bmMoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQogCXdha2VfdXAoJnZn
ZGV2LT5jdXJzb3JxLmFja19xdWV1ZSk7CiB9CiAKKy8qIENyZWF0ZSBzZ190YWJsZSBmcm9tIGEg
dm1hbGxvYydkIGJ1ZmZlci4gKi8KK3N0YXRpYyBzdHJ1Y3Qgc2dfdGFibGUgKnZtYWxsb2NfdG9f
c2d0KGNoYXIgKmRhdGEsIHVpbnQzMl90IHNpemUsIGludCAqc2dfZW50cykKK3sKKwlpbnQgcmV0
LCBzLCBpOworCXN0cnVjdCBzZ190YWJsZSAqc2d0OworCXN0cnVjdCBzY2F0dGVybGlzdCAqc2c7
CisJc3RydWN0IHBhZ2UgKnBnOworCisJaWYgKFdBUk5fT04oIVBBR0VfQUxJR05FRChkYXRhKSkp
CisJCXJldHVybiBOVUxMOworCisJc2d0ID0ga21hbGxvYyhzaXplb2YoKnNndCksIEdGUF9LRVJO
RUwpOworCWlmICghc2d0KQorCQlyZXR1cm4gTlVMTDsKKworCSpzZ19lbnRzID0gRElWX1JPVU5E
X1VQKHNpemUsIFBBR0VfU0laRSk7CisJcmV0ID0gc2dfYWxsb2NfdGFibGUoc2d0LCAqc2dfZW50
cywgR0ZQX0tFUk5FTCk7CisJaWYgKHJldCkgeworCQlrZnJlZShzZ3QpOworCQlyZXR1cm4gTlVM
TDsKKwl9CisKKwlmb3JfZWFjaF9zZyhzZ3QtPnNnbCwgc2csICpzZ19lbnRzLCBpKSB7CisJCXBn
ID0gdm1hbGxvY190b19wYWdlKGRhdGEpOworCQlpZiAoIXBnKSB7CisJCQlzZ19mcmVlX3RhYmxl
KHNndCk7CisJCQlrZnJlZShzZ3QpOworCQkJcmV0dXJuIE5VTEw7CisJCX0KKworCQlzID0gbWlu
X3QoaW50LCBQQUdFX1NJWkUsIHNpemUpOworCQlzZ19zZXRfcGFnZShzZywgcGcsIHMsIDApOwor
CisJCXNpemUgLT0gczsKKwkJZGF0YSArPSBzOworCX0KKworCXJldHVybiBzZ3Q7Cit9CisKIHN0
YXRpYyBib29sIHZpcnRpb19ncHVfcXVldWVfY3RybF9idWZmZXJfbG9ja2VkKHN0cnVjdCB2aXJ0
aW9fZ3B1X2RldmljZSAqdmdkZXYsCi0JCQkJCQlzdHJ1Y3QgdmlydGlvX2dwdV92YnVmZmVyICp2
YnVmKQorCQkJCQkJc3RydWN0IHZpcnRpb19ncHVfdmJ1ZmZlciAqdmJ1ZiwKKwkJCQkJCXN0cnVj
dCBzY2F0dGVybGlzdCAqdm91dCkKIAkJX19yZWxlYXNlcygmdmdkZXYtPmN0cmxxLnFsb2NrKQog
CQlfX2FjcXVpcmVzKCZ2Z2Rldi0+Y3RybHEucWxvY2spCiB7CiAJc3RydWN0IHZpcnRxdWV1ZSAq
dnEgPSB2Z2Rldi0+Y3RybHEudnE7Ci0Jc3RydWN0IHNjYXR0ZXJsaXN0ICpzZ3NbM10sIHZjbWQs
IHZvdXQsIHZyZXNwOworCXN0cnVjdCBzY2F0dGVybGlzdCAqc2dzWzNdLCB2Y21kLCB2cmVzcDsK
IAlpbnQgb3V0Y250ID0gMCwgaW5jbnQgPSAwOwogCWJvb2wgbm90aWZ5ID0gZmFsc2U7CiAJaW50
IHJldDsKQEAgLTI3NCw5ICszMTUsOCBAQCBzdGF0aWMgYm9vbCB2aXJ0aW9fZ3B1X3F1ZXVlX2N0
cmxfYnVmZmVyX2xvY2tlZChzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogCXNnc1tv
dXRjbnQgKyBpbmNudF0gPSAmdmNtZDsKIAlvdXRjbnQrKzsKIAotCWlmICh2YnVmLT5kYXRhX3Np
emUpIHsKLQkJc2dfaW5pdF9vbmUoJnZvdXQsIHZidWYtPmRhdGFfYnVmLCB2YnVmLT5kYXRhX3Np
emUpOwotCQlzZ3Nbb3V0Y250ICsgaW5jbnRdID0gJnZvdXQ7CisJaWYgKHZvdXQpIHsKKwkJc2dz
W291dGNudCArIGluY250XSA9IHZvdXQ7CiAJCW91dGNudCsrOwogCX0KIApAQCAtMzA4LDcgKzM0
OCwyNCBAQCBzdGF0aWMgdm9pZCB2aXJ0aW9fZ3B1X3F1ZXVlX2ZlbmNlZF9jdHJsX2J1ZmZlcihz
dHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogCQkJCQkJc3RydWN0IHZpcnRpb19ncHVf
ZmVuY2UgKmZlbmNlKQogewogCXN0cnVjdCB2aXJ0cXVldWUgKnZxID0gdmdkZXYtPmN0cmxxLnZx
OworCXN0cnVjdCBzY2F0dGVybGlzdCAqdm91dCA9IE5VTEwsIHNnOworCXN0cnVjdCBzZ190YWJs
ZSAqc2d0ID0gTlVMTDsKIAlib29sIG5vdGlmeTsKKwlpbnQgb3V0Y250ID0gMDsKKworCWlmICh2
YnVmLT5kYXRhX3NpemUpIHsKKwkJaWYgKGlzX3ZtYWxsb2NfYWRkcih2YnVmLT5kYXRhX2J1Zikp
IHsKKwkJCXNndCA9IHZtYWxsb2NfdG9fc2d0KHZidWYtPmRhdGFfYnVmLCB2YnVmLT5kYXRhX3Np
emUsCisJCQkJCSAgICAgJm91dGNudCk7CisJCQlpZiAoIXNndCkKKwkJCQlyZXR1cm4gLUVOT01F
TTsKKwkJCXZvdXQgPSBzZ3QtPnNnbDsKKwkJfSBlbHNlIHsKKwkJCXNnX2luaXRfb25lKCZzZywg
dmJ1Zi0+ZGF0YV9idWYsIHZidWYtPmRhdGFfc2l6ZSk7CisJCQl2b3V0ID0gJnNnOworCQkJb3V0
Y250ID0gMTsKKwkJfQorCX0KIAogYWdhaW46CiAJc3Bpbl9sb2NrKCZ2Z2Rldi0+Y3RybHEucWxv
Y2spOwpAQCAtMzIxLDcgKzM3OCw3IEBAIHN0YXRpYyB2b2lkIHZpcnRpb19ncHVfcXVldWVfZmVu
Y2VkX2N0cmxfYnVmZmVyKHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAJICogdG8g
d2FpdCBmb3IgZnJlZSBzcGFjZSwgd2hpY2ggY2FuIHJlc3VsdCBpbiBmZW5jZSBpZHMgYmVpbmcK
IAkgKiBzdWJtaXR0ZWQgb3V0LW9mLW9yZGVyLgogCSAqLwotCWlmICh2cS0+bnVtX2ZyZWUgPCAz
KSB7CisJaWYgKHZxLT5udW1fZnJlZSA8IDIgKyBvdXRjbnQpIHsKIAkJc3Bpbl91bmxvY2soJnZn
ZGV2LT5jdHJscS5xbG9jayk7CiAJCXdhaXRfZXZlbnQodmdkZXYtPmN0cmxxLmFja19xdWV1ZSwg
dnEtPm51bV9mcmVlID49IDMpOwogCQlnb3RvIGFnYWluOwpAQCAtMzM0LDEwICszOTEsMTUgQEAg
c3RhdGljIHZvaWQgdmlydGlvX2dwdV9xdWV1ZV9mZW5jZWRfY3RybF9idWZmZXIoc3RydWN0IHZp
cnRpb19ncHVfZGV2aWNlICp2Z2RldiwKIAkJCXZpcnRpb19ncHVfYXJyYXlfdW5sb2NrX3Jlc3Yo
dmJ1Zi0+b2Jqcyk7CiAJCX0KIAl9Ci0Jbm90aWZ5ID0gdmlydGlvX2dwdV9xdWV1ZV9jdHJsX2J1
ZmZlcl9sb2NrZWQodmdkZXYsIHZidWYpOworCW5vdGlmeSA9IHZpcnRpb19ncHVfcXVldWVfY3Ry
bF9idWZmZXJfbG9ja2VkKHZnZGV2LCB2YnVmLCB2b3V0KTsKIAlzcGluX3VubG9jaygmdmdkZXYt
PmN0cmxxLnFsb2NrKTsKIAlpZiAobm90aWZ5KQogCQl2aXJ0cXVldWVfbm90aWZ5KHZnZGV2LT5j
dHJscS52cSk7CisKKwlpZiAoc2d0KSB7CisJCXNnX2ZyZWVfdGFibGUoc2d0KTsKKwkJa2ZyZWUo
c2d0KTsKKwl9CiB9CiAKIHN0YXRpYyB2b2lkIHZpcnRpb19ncHVfcXVldWVfY3RybF9idWZmZXIo
c3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKLS0gCjIuMjMuMC4xNjIuZzBiOWZiYjM3
MzQtZ29vZwoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
ZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
