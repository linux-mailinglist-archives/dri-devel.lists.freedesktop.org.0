Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 5C09DB73BC
	for <lists+dri-devel@lfdr.de>; Thu, 19 Sep 2019 09:10:25 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 895CD6F80E;
	Thu, 19 Sep 2019 07:10:23 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fanzine.igalia.com (fanzine.igalia.com [91.117.99.155])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3299B6F80E
 for <dri-devel@lists.freedesktop.org>; Thu, 19 Sep 2019 07:10:21 +0000 (UTC)
Received: from [192.168.12.205] (helo=localhost.localdomain)
 by fanzine.igalia.com with esmtpsa 
 (Cipher TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128) (Exim)
 id 1iAqa2-0002U5-EY; Thu, 19 Sep 2019 09:10:18 +0200
From: Iago Toral Quiroga <itoral@igalia.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v3] drm/v3d: clean caches at the end of render jobs on request
 from user space
Date: Thu, 19 Sep 2019 09:10:16 +0200
Message-Id: <20190919071016.4578-1-itoral@igalia.com>
X-Mailer: git-send-email 2.17.1
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; d=igalia.com; s=20170329; 
 h=Message-Id:Date:Subject:Cc:To:From;
 bh=gtfm2bD94JzyFf5rV5jTxXpmmdKstHmLRGHfZJ53mgE=; 
 b=GNueFhaD00XNTYIn4VwZpQu2dsdGoTYVcWrmBE5p8bXuA1MOqvPAxraDKRwdjG0m+kF5O/nOOUzC9c9ZGC2S+nw11DDcUkClu2CgxtYEloXmMf+3suv8wdXrzpvWGRuN6sIhvCVmiIFO7NE/vqCaULLPjEejAv7gRgso+S68nPVu8ZECccXsVbapAffFo9EIWG23PEdytub40PKk5Tv3EAHlWrj6/uqi4dVEh9ZGscYEIh8nJWvEQCUSPCdpP2RIcajaAhBnF1seBRsrrnd4HNSWAaunya+73R517um9oTMtgmXxKlaPEdWaQTCkS1QkwnLfE5rzV1N0IjQ4FyYoKQ==;
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Iago Toral Quiroga <itoral@igalia.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RXh0ZW5kcyB0aGUgdXNlciBzcGFjZSBpb2N0bCBmb3IgQ0wgc3VibWlzc2lvbnMgc28gaXQgY2Fu
IGluY2x1ZGUgYSByZXF1ZXN0CnRvIGZsdXNoIHRoZSBjYWNoZSBvbmNlIHRoZSBDTCBleGVjdXRp
b24gaGFzIGNvbXBsZXRlZC4gRml4ZXMgbWVtb3J5CndyaXRlIHZpb2xhdGlvbiBtZXNzYWdlcyBy
ZXBvcnRlZCBieSB0aGUga2VybmVsIGluIHdvcmtsb2FkcyBpbnZvbHZpbmcKc2hhZGVyIG1lbW9y
eSB3cml0ZXMgKFNTQk9zLCBzaGFkZXIgaW1hZ2VzLCBzY3JhdGNoLCBldGMpIHdoaWNoIHNvbWV0
aW1lcwphbHNvIGxlYWQgdG8gR1BVIHJlc2V0cyBkdXJpbmcgUGlnbGl0IGFuZCBDVFMgd29ya2xv
YWRzLgoKdjI6IGlmIHYzZF9qb2JfaW5pdCgpIGZhaWxzIHdlIG5lZWQgdG8ga2ZyZWUoKSB0aGUg
am9iIGluc3RlYWQgb2YKICAgIHYzZF9qb2JfcHV0KCkgaXQgKEVyaWMgQW5ob2x0KS4KCnYzIChF
cmljIEFuaG9sdCk6CiAgLSBEcm9wIF9GTEFHIHN1ZmZpeCBmcm9tIHRoZSBuZXcgZmxhZyBuYW1l
LgogIC0gQWRkIGEgbmV3IHBhcmFtIHNvIHVzZXJzcGFjZSBjYW4gdGVsbCB3aGV0aGVyIGNhY2hl
IGZsdXNoaW5nIGlzCiAgICBpbXBsZW1lbnRlZCBpbiB0aGUga2VybmVsLgoKU2lnbmVkLW9mZi1i
eTogSWFnbyBUb3JhbCBRdWlyb2dhIDxpdG9yYWxAaWdhbGlhLmNvbT4KUmV2aWV3ZWQtYnk6IEVy
aWMgQW5ob2x0IDxlcmljQGFuaG9sdC5uZXQ+Ckxpbms6IGh0dHBzOi8vcGF0Y2h3b3JrLmZyZWVk
ZXNrdG9wLm9yZy9wYXRjaC9tc2dpZC8yMDE5MDkxMjA4MzUxNi4xMzc5Ny0xLWl0b3JhbEBpZ2Fs
aWEuY29tCi0tLQogZHJpdmVycy9ncHUvZHJtL3YzZC92M2RfZHJ2LmMgfCAgMyArKwogZHJpdmVy
cy9ncHUvZHJtL3YzZC92M2RfZ2VtLmMgfCA1NCArKysrKysrKysrKysrKysrKysrKysrKysrKysr
Ky0tLS0tLQogaW5jbHVkZS91YXBpL2RybS92M2RfZHJtLmggICAgfCAgOCArKysrLS0KIDMgZmls
ZXMgY2hhbmdlZCwgNTQgaW5zZXJ0aW9ucygrKSwgMTEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL3YzZC92M2RfZHJ2LmMgYi9kcml2ZXJzL2dwdS9kcm0vdjNkL3Yz
ZF9kcnYuYwppbmRleCAzNTA2YWUyNzIzYWUuLmU5NGJmNzUzNjhiZSAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL3YzZC92M2RfZHJ2LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3YzZC92M2Rf
ZHJ2LmMKQEAgLTEyNiw2ICsxMjYsOSBAQCBzdGF0aWMgaW50IHYzZF9nZXRfcGFyYW1faW9jdGwo
c3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAljYXNlIERSTV9WM0RfUEFSQU1f
U1VQUE9SVFNfQ1NEOgogCQlhcmdzLT52YWx1ZSA9IHYzZF9oYXNfY3NkKHYzZCk7CiAJCXJldHVy
biAwOworCWNhc2UgRFJNX1YzRF9QQVJBTV9TVVBQT1JUU19DQUNIRV9GTFVTSDoKKwkJYXJncy0+
dmFsdWUgPSAxOworCQlyZXR1cm4gMDsKIAlkZWZhdWx0OgogCQlEUk1fREVCVUcoIlVua25vd24g
cGFyYW1ldGVyICVkXG4iLCBhcmdzLT5wYXJhbSk7CiAJCXJldHVybiAtRUlOVkFMOwpkaWZmIC0t
Z2l0IGEvZHJpdmVycy9ncHUvZHJtL3YzZC92M2RfZ2VtLmMgYi9kcml2ZXJzL2dwdS9kcm0vdjNk
L3YzZF9nZW0uYwppbmRleCBmYjMyY2RhMThmZmUuLjRjNGI1OWFlMmM4MSAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL3YzZC92M2RfZ2VtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3YzZC92
M2RfZ2VtLmMKQEAgLTUzMCwxMyArNTMwLDE2IEBAIHYzZF9zdWJtaXRfY2xfaW9jdGwoc3RydWN0
IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAlzdHJ1Y3QgZHJtX3YzZF9zdWJtaXRfY2wg
KmFyZ3MgPSBkYXRhOwogCXN0cnVjdCB2M2RfYmluX2pvYiAqYmluID0gTlVMTDsKIAlzdHJ1Y3Qg
djNkX3JlbmRlcl9qb2IgKnJlbmRlcjsKKwlzdHJ1Y3QgdjNkX2pvYiAqY2xlYW5fam9iID0gTlVM
TDsKKwlzdHJ1Y3QgdjNkX2pvYiAqbGFzdF9qb2I7CiAJc3RydWN0IHd3X2FjcXVpcmVfY3R4IGFj
cXVpcmVfY3R4OwogCWludCByZXQgPSAwOwogCiAJdHJhY2VfdjNkX3N1Ym1pdF9jbF9pb2N0bCgm
djNkLT5kcm0sIGFyZ3MtPnJjbF9zdGFydCwgYXJncy0+cmNsX2VuZCk7CiAKLQlpZiAoYXJncy0+
cGFkICE9IDApIHsKLQkJRFJNX0lORk8oInBhZCBtdXN0IGJlIHplcm86ICVkXG4iLCBhcmdzLT5w
YWQpOworCWlmIChhcmdzLT5mbGFncyAhPSAwICYmCisJICAgIGFyZ3MtPmZsYWdzICE9IERSTV9W
M0RfU1VCTUlUX0NMX0ZMVVNIX0NBQ0hFKSB7CisJCURSTV9JTkZPKCJpbnZhbGlkIGZsYWdzOiAl
ZFxuIiwgYXJncy0+ZmxhZ3MpOwogCQlyZXR1cm4gLUVJTlZBTDsKIAl9CiAKQEAgLTU3NiwxMiAr
NTc5LDMxIEBAIHYzZF9zdWJtaXRfY2xfaW9jdGwoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9p
ZCAqZGF0YSwKIAkJYmluLT5yZW5kZXIgPSByZW5kZXI7CiAJfQogCi0JcmV0ID0gdjNkX2xvb2t1
cF9ib3MoZGV2LCBmaWxlX3ByaXYsICZyZW5kZXItPmJhc2UsCisJaWYgKGFyZ3MtPmZsYWdzICYg
RFJNX1YzRF9TVUJNSVRfQ0xfRkxVU0hfQ0FDSEUpIHsKKwkJY2xlYW5fam9iID0ga2NhbGxvYygx
LCBzaXplb2YoKmNsZWFuX2pvYiksIEdGUF9LRVJORUwpOworCQlpZiAoIWNsZWFuX2pvYikgewor
CQkJcmV0ID0gLUVOT01FTTsKKwkJCWdvdG8gZmFpbDsKKwkJfQorCisJCXJldCA9IHYzZF9qb2Jf
aW5pdCh2M2QsIGZpbGVfcHJpdiwgY2xlYW5fam9iLCB2M2Rfam9iX2ZyZWUsIDApOworCQlpZiAo
cmV0KSB7CisJCQlrZnJlZShjbGVhbl9qb2IpOworCQkJY2xlYW5fam9iID0gTlVMTDsKKwkJCWdv
dG8gZmFpbDsKKwkJfQorCisJCWxhc3Rfam9iID0gY2xlYW5fam9iOworCX0gZWxzZSB7CisJCWxh
c3Rfam9iID0gJnJlbmRlci0+YmFzZTsKKwl9CisKKwlyZXQgPSB2M2RfbG9va3VwX2JvcyhkZXYs
IGZpbGVfcHJpdiwgbGFzdF9qb2IsCiAJCQkgICAgIGFyZ3MtPmJvX2hhbmRsZXMsIGFyZ3MtPmJv
X2hhbmRsZV9jb3VudCk7CiAJaWYgKHJldCkKIAkJZ290byBmYWlsOwogCi0JcmV0ID0gdjNkX2xv
Y2tfYm9fcmVzZXJ2YXRpb25zKCZyZW5kZXItPmJhc2UsICZhY3F1aXJlX2N0eCk7CisJcmV0ID0g
djNkX2xvY2tfYm9fcmVzZXJ2YXRpb25zKGxhc3Rfam9iLCAmYWNxdWlyZV9jdHgpOwogCWlmIChy
ZXQpCiAJCWdvdG8gZmFpbDsKIApAQCAtNjAwLDI4ICs2MjIsNDQgQEAgdjNkX3N1Ym1pdF9jbF9p
b2N0bChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCB2b2lkICpkYXRhLAogCXJldCA9IHYzZF9wdXNo
X2pvYih2M2RfcHJpdiwgJnJlbmRlci0+YmFzZSwgVjNEX1JFTkRFUik7CiAJaWYgKHJldCkKIAkJ
Z290byBmYWlsX3VucmVzZXJ2ZTsKKworCWlmIChjbGVhbl9qb2IpIHsKKwkJc3RydWN0IGRtYV9m
ZW5jZSAqcmVuZGVyX2ZlbmNlID0KKwkJCWRtYV9mZW5jZV9nZXQocmVuZGVyLT5iYXNlLmRvbmVf
ZmVuY2UpOworCQlyZXQgPSBkcm1fZ2VtX2ZlbmNlX2FycmF5X2FkZCgmY2xlYW5fam9iLT5kZXBz
LCByZW5kZXJfZmVuY2UpOworCQlpZiAocmV0KQorCQkJZ290byBmYWlsX3VucmVzZXJ2ZTsKKwkJ
cmV0ID0gdjNkX3B1c2hfam9iKHYzZF9wcml2LCBjbGVhbl9qb2IsIFYzRF9DQUNIRV9DTEVBTik7
CisJCWlmIChyZXQpCisJCQlnb3RvIGZhaWxfdW5yZXNlcnZlOworCX0KKwogCW11dGV4X3VubG9j
aygmdjNkLT5zY2hlZF9sb2NrKTsKIAogCXYzZF9hdHRhY2hfZmVuY2VzX2FuZF91bmxvY2tfcmVz
ZXJ2YXRpb24oZmlsZV9wcml2LAotCQkJCQkJICZyZW5kZXItPmJhc2UsCisJCQkJCQkgbGFzdF9q
b2IsCiAJCQkJCQkgJmFjcXVpcmVfY3R4LAogCQkJCQkJIGFyZ3MtPm91dF9zeW5jLAotCQkJCQkJ
IHJlbmRlci0+YmFzZS5kb25lX2ZlbmNlKTsKKwkJCQkJCSBsYXN0X2pvYi0+ZG9uZV9mZW5jZSk7
CiAKIAlpZiAoYmluKQogCQl2M2Rfam9iX3B1dCgmYmluLT5iYXNlKTsKIAl2M2Rfam9iX3B1dCgm
cmVuZGVyLT5iYXNlKTsKKwlpZiAoY2xlYW5fam9iKQorCQl2M2Rfam9iX3B1dChjbGVhbl9qb2Ip
OwogCiAJcmV0dXJuIDA7CiAKIGZhaWxfdW5yZXNlcnZlOgogCW11dGV4X3VubG9jaygmdjNkLT5z
Y2hlZF9sb2NrKTsKLQlkcm1fZ2VtX3VubG9ja19yZXNlcnZhdGlvbnMocmVuZGVyLT5iYXNlLmJv
LAotCQkJCSAgICByZW5kZXItPmJhc2UuYm9fY291bnQsICZhY3F1aXJlX2N0eCk7CisJZHJtX2dl
bV91bmxvY2tfcmVzZXJ2YXRpb25zKGxhc3Rfam9iLT5ibywKKwkJCQkgICAgbGFzdF9qb2ItPmJv
X2NvdW50LCAmYWNxdWlyZV9jdHgpOwogZmFpbDoKIAlpZiAoYmluKQogCQl2M2Rfam9iX3B1dCgm
YmluLT5iYXNlKTsKIAl2M2Rfam9iX3B1dCgmcmVuZGVyLT5iYXNlKTsKKwlpZiAoY2xlYW5fam9i
KQorCQl2M2Rfam9iX3B1dChjbGVhbl9qb2IpOwogCiAJcmV0dXJuIHJldDsKIH0KZGlmZiAtLWdp
dCBhL2luY2x1ZGUvdWFwaS9kcm0vdjNkX2RybS5oIGIvaW5jbHVkZS91YXBpL2RybS92M2RfZHJt
LmgKaW5kZXggNThmYmU0OGM5MWU5Li4xY2U3NDZlMjI4ZDkgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUv
dWFwaS9kcm0vdjNkX2RybS5oCisrKyBiL2luY2x1ZGUvdWFwaS9kcm0vdjNkX2RybS5oCkBAIC00
OCw2ICs0OCw4IEBAIGV4dGVybiAiQyIgewogI2RlZmluZSBEUk1fSU9DVExfVjNEX1NVQk1JVF9U
RlUgICAgICAgICAgRFJNX0lPVyhEUk1fQ09NTUFORF9CQVNFICsgRFJNX1YzRF9TVUJNSVRfVEZV
LCBzdHJ1Y3QgZHJtX3YzZF9zdWJtaXRfdGZ1KQogI2RlZmluZSBEUk1fSU9DVExfVjNEX1NVQk1J
VF9DU0QgICAgICAgICAgRFJNX0lPVyhEUk1fQ09NTUFORF9CQVNFICsgRFJNX1YzRF9TVUJNSVRf
Q1NELCBzdHJ1Y3QgZHJtX3YzZF9zdWJtaXRfY3NkKQogCisjZGVmaW5lIERSTV9WM0RfU1VCTUlU
X0NMX0ZMVVNIX0NBQ0hFICAgICAgICAgICAgIDB4MDEKKwogLyoqCiAgKiBzdHJ1Y3QgZHJtX3Yz
ZF9zdWJtaXRfY2wgLSBpb2N0bCBhcmd1bWVudCBmb3Igc3VibWl0dGluZyBjb21tYW5kcyB0byB0
aGUgM0QKICAqIGVuZ2luZS4KQEAgLTYxLDcgKzYzLDcgQEAgZXh0ZXJuICJDIiB7CiAgKiBmbHVz
aGVkIGJ5IHRoZSB0aW1lIHRoZSByZW5kZXIgZG9uZSBJUlEgaGFwcGVucywgd2hpY2ggaXMgdGhl
CiAgKiB0cmlnZ2VyIGZvciBvdXRfc3luYy4gIEFueSBkaXJ0eWluZyBvZiBjYWNoZWxpbmVzIGJ5
IHRoZSBqb2IgKG9ubHkKICAqIHBvc3NpYmxlIHVzaW5nIFRNVSB3cml0ZXMpIG11c3QgYmUgZmx1
c2hlZCBieSB0aGUgY2FsbGVyIHVzaW5nIHRoZQotICogQ0wncyBjYWNoZSBmbHVzaCBjb21tYW5k
cy4KKyAqIERSTV9WM0RfU1VCTUlUX0NMX0ZMVVNIX0NBQ0hFX0ZMQUcgZmxhZy4KICAqLwogc3Ry
dWN0IGRybV92M2Rfc3VibWl0X2NsIHsKIAkvKiBQb2ludGVyIHRvIHRoZSBiaW5uZXIgY29tbWFu
ZCBsaXN0LgpAQCAtMTI0LDggKzEyNiw3IEBAIHN0cnVjdCBkcm1fdjNkX3N1Ym1pdF9jbCB7CiAJ
LyogTnVtYmVyIG9mIEJPIGhhbmRsZXMgcGFzc2VkIGluIChzaXplIGlzIHRoYXQgdGltZXMgNCku
ICovCiAJX191MzIgYm9faGFuZGxlX2NvdW50OwogCi0JLyogUGFkLCBtdXN0IGJlIHplcm8tZmls
bGVkLiAqLwotCV9fdTMyIHBhZDsKKwlfX3UzMiBmbGFnczsKIH07CiAKIC8qKgpAQCAtMTkzLDYg
KzE5NCw3IEBAIGVudW0gZHJtX3YzZF9wYXJhbSB7CiAJRFJNX1YzRF9QQVJBTV9WM0RfQ09SRTBf
SURFTlQyLAogCURSTV9WM0RfUEFSQU1fU1VQUE9SVFNfVEZVLAogCURSTV9WM0RfUEFSQU1fU1VQ
UE9SVFNfQ1NELAorCURSTV9WM0RfUEFSQU1fU1VQUE9SVFNfQ0FDSEVfRkxVU0gsCiB9OwogCiBz
dHJ1Y3QgZHJtX3YzZF9nZXRfcGFyYW0gewotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1k
ZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcv
bWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
