Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 69555B6D3B
	for <lists+dri-devel@lfdr.de>; Wed, 18 Sep 2019 22:07:45 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BD7DD6FE93;
	Wed, 18 Sep 2019 20:07:42 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-yb1-xb44.google.com (mail-yb1-xb44.google.com
 [IPv6:2607:f8b0:4864:20::b44])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D60BC6FE85
 for <dri-devel@lists.freedesktop.org>; Wed, 18 Sep 2019 20:07:41 +0000 (UTC)
Received: by mail-yb1-xb44.google.com with SMTP id u68so483231ybg.1
 for <dri-devel@lists.freedesktop.org>; Wed, 18 Sep 2019 13:07:41 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=8wRVg7Xp6X9fH0kFWOO4JmqVs8YGObxnFzNWoZ7A1I4=;
 b=ko+K9Y9CPfS/QqyUQw1kjPNtb3ULgWJ+ltzJt/hvkthQb2ZOvTzDZU+hpMG9wIDjXU
 gu+ZuLbPJ73Zc07I0lnfLI4MVwfFHSltLiFX0QjEk5GkV+BnR+GC/27UvBdaAbsf4GA5
 0ra/PMi6yQvvi8+OM9Uo2x4UzxgZ2OuFXnO49/RdkMT4HIe4vac0S9fc9Rt4azG+lINW
 6GMpAQNpuWtGf94SjZbzzpINq6DaZvMgjUcG/kG6YRXnkMToZIH94pWuG6YxIQFNRLnV
 B60WvvofDjwDAjsGXWBDld03VgDbj5W8yQwFgwfpvoMquUWqJYBZmEeNb5Mm27bVvcxk
 X86Q==
X-Gm-Message-State: APjAAAUIXnKqYADb3voTiw5gsvb3LxVZhTg5X4P3Ibbe+lMZ4ot6aaUN
 yTDvb9s7til/w++Ptnb9qX/g/4Jh6Alozg==
X-Google-Smtp-Source: APXvYqxp93kVw5JZ6ziN8xitJxe4JOB8xsrtmFJlgaaZHb9kWTb2WQcrBfBg/UL18FVpSe/EetmYyg==
X-Received: by 2002:a25:2e44:: with SMTP id b4mr3154900ybn.9.1568837259968;
 Wed, 18 Sep 2019 13:07:39 -0700 (PDT)
Received: from rosewood.cam.corp.google.com
 ([2620:0:1013:11:89c6:2139:5435:371d])
 by smtp.gmail.com with ESMTPSA id 207sm1429317ywu.106.2019.09.18.13.07.39
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Wed, 18 Sep 2019 13:07:39 -0700 (PDT)
From: Sean Paul <sean@poorly.run>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v2 2/3] drm: Measure Self Refresh Entry/Exit times to avoid
 thrashing
Date: Wed, 18 Sep 2019 16:07:29 -0400
Message-Id: <20190918200734.149876-2-sean@poorly.run>
X-Mailer: git-send-email 2.23.0.237.gc6a4ce50a0-goog
In-Reply-To: <20190918200734.149876-1-sean@poorly.run>
References: <20190918200734.149876-1-sean@poorly.run>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=poorly.run; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=8wRVg7Xp6X9fH0kFWOO4JmqVs8YGObxnFzNWoZ7A1I4=;
 b=JQuBapSX6N+q1mvLBlG+ko3vJHHAReQ7+RKU3yLX8PMtWnaVC4/ePwCDnv7GNJlyu7
 5ufKPZlQCzxQ9sW8GoVcTdN27S1aYjJxUATQvTcg7SeRZX0lQiBzGTGnUvUp3OywcLL6
 DwiqhbAREYbkAySZMFBtgEhdPeLwqOCPvoQwEKkMNomCPbtDc9pMmUvVAVmUAO+q4eM/
 1S8XNWIN8qsRv6pVHT+mU4v/LbO3hi/oO1q18koj2TDm4uLVJz2aaOOQFxwrlYQd663U
 RJa1Ph7YnozA8evZr52kZ9iUmxvSDyuRh7qlvLdxFop0HltioB8rvx/7+Uq2nOO90V7S
 O/8w==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: linux-rockchip@lists.infradead.org,
 Maxime Ripard <maxime.ripard@bootlin.com>,
 Daniel Vetter <daniel.vetter@ffwll.ch>, linux-kernel@vger.kernel.org,
 David Airlie <airlied@linux.ie>, Sean Paul <seanpaul@chromium.org>,
 jekarl@iki.fi, Sean Paul <sean@poorly.run>,
 linux-arm-kernel@lists.infradead.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogU2VhbiBQYXVsIDxzZWFucGF1bEBjaHJvbWl1bS5vcmc+CgpDdXJyZW50bHkgdGhlIHNl
bGYgcmVmcmVzaCBpZGxlIHRpbWVyIGlzIGEgY29uc3Qgc2V0IGJ5IHRoZSBjcnRjLiBUaGlzCmlz
IGZpbmUgaWYgdGhlIHNlbGYgcmVmcmVzaCBlbnRyeS9leGl0IHRpbWVzIGFyZSB3ZWxsLWtub3du
IGZvciBhbGwKcGFuZWxzIHVzZWQgb24gdGhhdCBjcnRjLiBIb3dldmVyIHBhbmVscyBhbmQgd29y
a2xvYWRzIGNhbiB2YXJ5IHF1aXRlIGEKYml0LCBhbmQgYSB0aW1lb3V0IHdoaWNoIHdvcmtzIHdl
bGwgZm9yIG9uZSBkb2Vzbid0IHdvcmsgd2VsbCBmb3IKYW5vdGhlci4KCkluIHRoZSBleHRyZW1l
LCBpZiB0aGUgdGltZW91dCBpcyB0b28gc2hvcnQgd2UgY291bGQgZ2V0IGluIGEgc2l0dWF0aW9u
CndoZXJlIHRoZSBzZWxmIHJlZnJlc2ggZXhpdHMgYXJlIHRha2luZyBzbyBsb25nIHdlIHF1ZXVl
IHVwIGEgc2VsZiByZWZyZXNoCmVudHJ5IGJlZm9yZSB0aGUgZXhpdCBjb21taXQgaXMgZXZlbiBm
aW5pc2hlZC4KClRoaXMgcGF0Y2ggY2hhbmdlcyB0aGUgaWRsZSB0aW1lb3V0IHRvIGEgbW92aW5n
IGF2ZXJhZ2Ugb2YgdGhlIGVudHJ5CnRpbWVzICsgYSBtb3ZpbmcgYXZlcmFnZSBvZiBleGl0IHRp
bWVzICsgdGhlIGNydGMgY29uc3RhbnQuCgpUaGlzIHBhdGNoIHdhcyB0ZXN0ZWQgb24gcm9ja2No
aXAsIHdpdGggYSBrZXZpbiBDck9TIHBhbmVsIHRoZSBpZGxlCmRlbGF5IGF2ZXJhZ2VzIG91dCB0
byBhYm91dCB+MjM1bXMgKDM1IGVudHJ5ICsgMTAwIGV4aXQgKyAxMDAgY29uc3QpLiBPbgp0aGUg
c2FtZSBib2FyZCwgdGhlIGJvYiBwYW5lbCBpZGxlIGRlbGF5IGxhbmRzIGFyb3VuZCB+MzQwbXMg
KDkwIGVudHJ5CisgMTUwIGV4aXQgKyAxMDAgY29uc3QpLgoKV1JUIHRoZSBkZWRpY2F0ZWQgbXV0
ZXggaW4gc2VsZl9yZWZyZXNoX2RhdGEsIGl0IHdvdWxkIGJlIG5pY2UgaWYgd2UKY291bGQgcmVs
eSBvbiBkcm1fY3J0Yy5tdXRleCB0byBwcm90ZWN0IHRoZSBhdmVyYWdlIHRpbWVzLCBidXQgdGhl
cmUgYXJlCmEgZmV3IHJlYXNvbnMgd2h5IGEgc2VwYXJhdGUgbG9jayBpcyBhIGJldHRlciBjaG9p
Y2U6Ci0gV2UgY2FuJ3QgcmVseSBvbiBkcm1fY3J0Yy5tdXRleCBiZWluZyBoZWxkIGlmIHdlJ3Jl
IGRvaW5nIGEgbm9uYmxvY2tpbmcKICBjb21taXQKLSBXZSBjYW4ndCBncmFiIGRybV9jcnRjLm11
dGV4IHNpbmNlIGRybV9tb2Rlc2V0X2xvY2soKSBkb2Vzbid0IHRlbGwgdXMKICB3aGV0aGVyIHRo
ZSBsb2NrIHdhcyBhbHJlYWR5IGhlbGQgaW4gdGhlIGFjcXVpcmUgY29udGV4dCAoaXQgZWF0cwog
IC1FQUxSRUFEWSksIHNvIHdlIGNhbid0IHRlbGwgaWYgd2Ugc2hvdWxkIGRyb3AgaXQgb3Igbm90
Ci0gV2UgZG9uJ3QgbmVlZCBzdWNoIGEgaGVhdnktaGFuZGVkIGxvY2sgZm9yIHdoYXQgd2UncmUg
dHJ5aW5nIHRvIGRvLAogIGNvbW1pdCBvcmRlcmluZyBkb2Vzbid0IG1hdHRlciwgc28gYSBwb2lu
dC1vZi11c2UgbG9jayB3aWxsIGJlIGxlc3MKICBjb250ZW50aW91cwoKUmV2aWV3ZWQtYnk6IERh
bmllbCBWZXR0ZXIgPGRhbmllbC52ZXR0ZXJAZmZ3bGwuY2g+ClNpZ25lZC1vZmYtYnk6IFNlYW4g
UGF1bCA8c2VhbnBhdWxAY2hyb21pdW0ub3JnPgpMaW5rIHRvIHYxOiBodHRwczovL3BhdGNod29y
ay5mcmVlZGVza3RvcC5vcmcvcGF0Y2gvbXNnaWQvMjAxOTA5MTcyMDA0NDMuNjQ0ODEtMi1zZWFu
QHBvb3JseS5ydW4KCkNoYW5nZXMgaW4gdjI6Ci0gTWlncmF0ZSBsb2NraW5nIGV4cGxhbmF0aW9u
IGZyb20gY29tbWVudCB0byBjb21taXQgbXNnIChEYW5pZWwpCi0gVHVyZiBjb25zdGFudCBlbnRy
eSBkZWxheSBhbmQgbXVsdGlwbHkgdGhlIGF2ZyB0aW1lcyBieSAyIChEYW5pZWwpCi0tLQogZHJp
dmVycy9ncHUvZHJtL2RybV9hdG9taWNfaGVscGVyLmMgICAgICAgICB8IDIwICsrKysrKwogZHJp
dmVycy9ncHUvZHJtL2RybV9zZWxmX3JlZnJlc2hfaGVscGVyLmMgICB8IDcyICsrKysrKysrKysr
KysrKysrKystLQogZHJpdmVycy9ncHUvZHJtL3JvY2tjaGlwL3JvY2tjaGlwX2RybV92b3AuYyB8
ICA1ICstCiBpbmNsdWRlL2RybS9kcm1fc2VsZl9yZWZyZXNoX2hlbHBlci5oICAgICAgIHwgIDYg
Ky0KIDQgZmlsZXMgY2hhbmdlZCwgOTAgaW5zZXJ0aW9ucygrKSwgMTMgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2RybV9hdG9taWNfaGVscGVyLmMgYi9kcml2ZXJz
L2dwdS9kcm0vZHJtX2F0b21pY19oZWxwZXIuYwppbmRleCA5ZDdlNGRhNmMyOTIuLjNmMTNmYTlh
OWUyNCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2RybV9hdG9taWNfaGVscGVyLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2RybV9hdG9taWNfaGVscGVyLmMKQEAgLTI2LDYgKzI2LDcgQEAK
ICAqLwogCiAjaW5jbHVkZSA8bGludXgvZG1hLWZlbmNlLmg+CisjaW5jbHVkZSA8bGludXgva3Rp
bWUuaD4KIAogI2luY2x1ZGUgPGRybS9kcm1fYXRvbWljLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9h
dG9taWNfaGVscGVyLmg+CkBAIC0xNTcwLDkgKzE1NzEsMjMgQEAgc3RhdGljIHZvaWQgY29tbWl0
X3RhaWwoc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKm9sZF9zdGF0ZSkKIHsKIAlzdHJ1Y3QgZHJt
X2RldmljZSAqZGV2ID0gb2xkX3N0YXRlLT5kZXY7CiAJY29uc3Qgc3RydWN0IGRybV9tb2RlX2Nv
bmZpZ19oZWxwZXJfZnVuY3MgKmZ1bmNzOworCWt0aW1lX3Qgc3RhcnQ7CisJczY0IGNvbW1pdF90
aW1lX21zOwogCiAJZnVuY3MgPSBkZXYtPm1vZGVfY29uZmlnLmhlbHBlcl9wcml2YXRlOwogCisJ
LyoKKwkgKiBXZSdyZSBtZWFzdXJpbmcgdGhlIF9lbnRpcmVfIGNvbW1pdCwgc28gdGhlIHRpbWUg
d2lsbCB2YXJ5IGRlcGVuZGluZworCSAqIG9uIGhvdyBtYW55IGZlbmNlcyBhbmQgb2JqZWN0cyBh
cmUgaW52b2x2ZWQuIEZvciB0aGUgcHVycG9zZXMgb2Ygc2VsZgorCSAqIHJlZnJlc2gsIHRoaXMg
aXMgZGVzaXJhYmxlIHNpbmNlIGl0J2xsIGdpdmUgdXMgYW4gaWRlYSBvZiBob3cKKwkgKiBjb25n
ZXN0ZWQgdGhpbmdzIGFyZS4gVGhpcyB3aWxsIGluZm9ybSBvdXIgZGVjaXNpb24gb24gaG93IG9m
dGVuIHdlCisJICogc2hvdWxkIGVudGVyIHNlbGYgcmVmcmVzaCBhZnRlciBpZGxlLgorCSAqCisJ
ICogVGhlc2UgdGltZXMgd2lsbCBiZSBhdmVyYWdlZCBvdXQgaW4gdGhlIHNlbGYgcmVmcmVzaCBo
ZWxwZXJzIHRvIGF2b2lkCisJICogb3ZlcnJlYWN0aW5nIG92ZXIgb25lIG91dGxpZXIgZnJhbWUK
KwkgKi8KKwlzdGFydCA9IGt0aW1lX2dldCgpOworCiAJZHJtX2F0b21pY19oZWxwZXJfd2FpdF9m
b3JfZmVuY2VzKGRldiwgb2xkX3N0YXRlLCBmYWxzZSk7CiAKIAlkcm1fYXRvbWljX2hlbHBlcl93
YWl0X2Zvcl9kZXBlbmRlbmNpZXMob2xkX3N0YXRlKTsKQEAgLTE1ODIsNiArMTU5NywxMSBAQCBz
dGF0aWMgdm9pZCBjb21taXRfdGFpbChzdHJ1Y3QgZHJtX2F0b21pY19zdGF0ZSAqb2xkX3N0YXRl
KQogCWVsc2UKIAkJZHJtX2F0b21pY19oZWxwZXJfY29tbWl0X3RhaWwob2xkX3N0YXRlKTsKIAor
CWNvbW1pdF90aW1lX21zID0ga3RpbWVfbXNfZGVsdGEoa3RpbWVfZ2V0KCksIHN0YXJ0KTsKKwlp
ZiAoY29tbWl0X3RpbWVfbXMgPiAwKQorCQlkcm1fc2VsZl9yZWZyZXNoX2hlbHBlcl91cGRhdGVf
YXZnX3RpbWVzKG9sZF9zdGF0ZSwKKwkJCQkJCSAodW5zaWduZWQgbG9uZyljb21taXRfdGltZV9t
cyk7CisKIAlkcm1fYXRvbWljX2hlbHBlcl9jb21taXRfY2xlYW51cF9kb25lKG9sZF9zdGF0ZSk7
CiAKIAlkcm1fYXRvbWljX3N0YXRlX3B1dChvbGRfc3RhdGUpOwpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2RybV9zZWxmX3JlZnJlc2hfaGVscGVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJt
X3NlbGZfcmVmcmVzaF9oZWxwZXIuYwppbmRleCA5MDk1Y2ViZjIxNDcuLjY4ZjQ3NjVhNTg5NiAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2RybV9zZWxmX3JlZnJlc2hfaGVscGVyLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2RybV9zZWxmX3JlZnJlc2hfaGVscGVyLmMKQEAgLTUsNiArNSw3
IEBACiAgKiBBdXRob3JzOgogICogU2VhbiBQYXVsIDxzZWFucGF1bEBjaHJvbWl1bS5vcmc+CiAg
Ki8KKyNpbmNsdWRlIDxsaW51eC9hdmVyYWdlLmg+CiAjaW5jbHVkZSA8bGludXgvYml0b3BzLmg+
CiAjaW5jbHVkZSA8bGludXgvc2xhYi5oPgogI2luY2x1ZGUgPGxpbnV4L3dvcmtxdWV1ZS5oPgpA
QCAtNTAsMTAgKzUxLDE3IEBACiAgKiBhdG9taWNfY2hlY2sgd2hlbiAmZHJtX2NydGNfc3RhdGUu
c2VsZl9yZWZyZXNoX2FjdGl2ZSBpcyB0cnVlLgogICovCiAKKyNkZWZpbmUgU0VMRl9SRUZSRVNI
X0FWR19TRUVEX01TIDIwMAorCitERUNMQVJFX0VXTUEocHNyX3RpbWUsIDQsIDQpCisKIHN0cnVj
dCBkcm1fc2VsZl9yZWZyZXNoX2RhdGEgewogCXN0cnVjdCBkcm1fY3J0YyAqY3J0YzsKIAlzdHJ1
Y3QgZGVsYXllZF93b3JrIGVudHJ5X3dvcms7Ci0JdW5zaWduZWQgaW50IGVudHJ5X2RlbGF5X21z
OworCisJc3RydWN0IG11dGV4IGF2Z19tdXRleDsKKwlzdHJ1Y3QgZXdtYV9wc3JfdGltZSBlbnRy
eV9hdmdfbXM7CisJc3RydWN0IGV3bWFfcHNyX3RpbWUgZXhpdF9hdmdfbXM7CiB9OwogCiBzdGF0
aWMgdm9pZCBkcm1fc2VsZl9yZWZyZXNoX2hlbHBlcl9lbnRyeV93b3JrKHN0cnVjdCB3b3JrX3N0
cnVjdCAqd29yaykKQEAgLTEyMSw2ICsxMjksNDQgQEAgc3RhdGljIHZvaWQgZHJtX3NlbGZfcmVm
cmVzaF9oZWxwZXJfZW50cnlfd29yayhzdHJ1Y3Qgd29ya19zdHJ1Y3QgKndvcmspCiAJZHJtX21v
ZGVzZXRfYWNxdWlyZV9maW5pKCZjdHgpOwogfQogCisvKioKKyAqIGRybV9zZWxmX3JlZnJlc2hf
aGVscGVyX3VwZGF0ZV9hdmdfdGltZXMgLSBVcGRhdGVzIGEgY3J0YydzIFNSIHRpbWUgYXZlcmFn
ZXMKKyAqIEBzdGF0ZTogdGhlIHN0YXRlIHdoaWNoIGhhcyBqdXN0IGJlZW4gYXBwbGllZCB0byBo
YXJkd2FyZQorICogQGNvbW1pdF90aW1lX21zOiB0aGUgYW1vdW50IG9mIHRpbWUgaW4gbXMgdGhh
dCB0aGlzIGNvbW1pdCB0b29rIHRvIGNvbXBsZXRlCisgKgorICogQ2FsbGVkIGFmdGVyICZkcm1f
bW9kZV9jb25maWdfZnVuY3MuYXRvbWljX2NvbW1pdF90YWlsLCB0aGlzIGZ1bmN0aW9uIHdpbGwK
KyAqIHVwZGF0ZSB0aGUgYXZlcmFnZSBlbnRyeS9leGl0IHNlbGYgcmVmcmVzaCB0aW1lcyBvbiBz
ZWxmIHJlZnJlc2ggdHJhbnNpdGlvbnMuCisgKiBUaGVzZSBhdmVyYWdlcyB3aWxsIGJlIHVzZWQg
d2hlbiBjYWxjdWxhdGluZyBob3cgbG9uZyB0byBkZWxheSBiZWZvcmUKKyAqIGVudGVyaW5nIHNl
bGYgcmVmcmVzaCBtb2RlIGFmdGVyIGFjdGl2aXR5LgorICovCit2b2lkIGRybV9zZWxmX3JlZnJl
c2hfaGVscGVyX3VwZGF0ZV9hdmdfdGltZXMoc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRl
LAorCQkJCQkgICAgICB1bnNpZ25lZCBpbnQgY29tbWl0X3RpbWVfbXMpCit7CisJc3RydWN0IGRy
bV9jcnRjICpjcnRjOworCXN0cnVjdCBkcm1fY3J0Y19zdGF0ZSAqb2xkX2NydGNfc3RhdGUsICpu
ZXdfY3J0Y19zdGF0ZTsKKwlpbnQgaTsKKworCWZvcl9lYWNoX29sZG5ld19jcnRjX2luX3N0YXRl
KHN0YXRlLCBjcnRjLCBvbGRfY3J0Y19zdGF0ZSwKKwkJCQkgICAgICBuZXdfY3J0Y19zdGF0ZSwg
aSkgeworCQlzdHJ1Y3QgZHJtX3NlbGZfcmVmcmVzaF9kYXRhICpzcl9kYXRhID0gY3J0Yy0+c2Vs
Zl9yZWZyZXNoX2RhdGE7CisJCXN0cnVjdCBld21hX3Bzcl90aW1lICp0aW1lOworCisJCWlmIChv
bGRfY3J0Y19zdGF0ZS0+c2VsZl9yZWZyZXNoX2FjdGl2ZSA9PQorCQkgICAgbmV3X2NydGNfc3Rh
dGUtPnNlbGZfcmVmcmVzaF9hY3RpdmUpCisJCQljb250aW51ZTsKKworCQlpZiAobmV3X2NydGNf
c3RhdGUtPnNlbGZfcmVmcmVzaF9hY3RpdmUpCisJCQl0aW1lID0gJnNyX2RhdGEtPmVudHJ5X2F2
Z19tczsKKwkJZWxzZQorCQkJdGltZSA9ICZzcl9kYXRhLT5leGl0X2F2Z19tczsKKworCQltdXRl
eF9sb2NrKCZzcl9kYXRhLT5hdmdfbXV0ZXgpOworCQlld21hX3Bzcl90aW1lX2FkZCh0aW1lLCBj
b21taXRfdGltZV9tcyk7CisJCW11dGV4X3VubG9jaygmc3JfZGF0YS0+YXZnX211dGV4KTsKKwl9
Cit9CitFWFBPUlRfU1lNQk9MKGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX3VwZGF0ZV9hdmdfdGlt
ZXMpOworCiAvKioKICAqIGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX2FsdGVyX3N0YXRlIC0gQWx0
ZXJzIHRoZSBhdG9taWMgc3RhdGUgZm9yIFNSIGV4aXQKICAqIEBzdGF0ZTogdGhlIHN0YXRlIGN1
cnJlbnRseSBiZWluZyBjaGVja2VkCkBAIC0xNTIsNiArMTk4LDcgQEAgdm9pZCBkcm1fc2VsZl9y
ZWZyZXNoX2hlbHBlcl9hbHRlcl9zdGF0ZShzdHJ1Y3QgZHJtX2F0b21pY19zdGF0ZSAqc3RhdGUp
CiAKIAlmb3JfZWFjaF9uZXdfY3J0Y19pbl9zdGF0ZShzdGF0ZSwgY3J0YywgY3J0Y19zdGF0ZSwg
aSkgewogCQlzdHJ1Y3QgZHJtX3NlbGZfcmVmcmVzaF9kYXRhICpzcl9kYXRhOworCQl1bnNpZ25l
ZCBpbnQgZGVsYXk7CiAKIAkJLyogRG9uJ3QgdHJpZ2dlciB0aGUgZW50cnkgdGltZXIgd2hlbiB3
ZSdyZSBhbHJlYWR5IGluIFNSICovCiAJCWlmIChjcnRjX3N0YXRlLT5zZWxmX3JlZnJlc2hfYWN0
aXZlKQpAQCAtMTYxLDggKzIwOCwxMyBAQCB2b2lkIGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX2Fs
dGVyX3N0YXRlKHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkKIAkJaWYgKCFzcl9kYXRh
KQogCQkJY29udGludWU7CiAKKwkJbXV0ZXhfbG9jaygmc3JfZGF0YS0+YXZnX211dGV4KTsKKwkJ
ZGVsYXkgPSAoZXdtYV9wc3JfdGltZV9yZWFkKCZzcl9kYXRhLT5lbnRyeV9hdmdfbXMpICsKKwkJ
CSBld21hX3Bzcl90aW1lX3JlYWQoJnNyX2RhdGEtPmV4aXRfYXZnX21zKSkgKiAyOworCQltdXRl
eF91bmxvY2soJnNyX2RhdGEtPmF2Z19tdXRleCk7CisKIAkJbW9kX2RlbGF5ZWRfd29yayhzeXN0
ZW1fd3EsICZzcl9kYXRhLT5lbnRyeV93b3JrLAotCQkJCSBtc2Vjc190b19qaWZmaWVzKHNyX2Rh
dGEtPmVudHJ5X2RlbGF5X21zKSk7CisJCQkJIG1zZWNzX3RvX2ppZmZpZXMoZGVsYXkpKTsKIAl9
CiB9CiBFWFBPUlRfU1lNQk9MKGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX2FsdGVyX3N0YXRlKTsK
QEAgLTE3MCwxMiArMjIyLDEwIEBAIEVYUE9SVF9TWU1CT0woZHJtX3NlbGZfcmVmcmVzaF9oZWxw
ZXJfYWx0ZXJfc3RhdGUpOwogLyoqCiAgKiBkcm1fc2VsZl9yZWZyZXNoX2hlbHBlcl9pbml0IC0g
SW5pdGlhbGl6ZXMgc2VsZiByZWZyZXNoIGhlbHBlcnMgZm9yIGEgY3J0YwogICogQGNydGM6IHRo
ZSBjcnRjIHdoaWNoIHN1cHBvcnRzIHNlbGYgcmVmcmVzaCBzdXBwb3J0ZWQgZGlzcGxheXMKLSAq
IEBlbnRyeV9kZWxheV9tczogYW1vdW50IG9mIGluYWN0aXZpdHkgdG8gd2FpdCBiZWZvcmUgZW50
ZXJpbmcgc2VsZiByZWZyZXNoCiAgKgogICogUmV0dXJucyB6ZXJvIGlmIHN1Y2Nlc3NmdWwgb3Ig
LWVycm5vIG9uIGZhaWx1cmUKICAqLwotaW50IGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX2luaXQo
c3RydWN0IGRybV9jcnRjICpjcnRjLAotCQkJCSB1bnNpZ25lZCBpbnQgZW50cnlfZGVsYXlfbXMp
CitpbnQgZHJtX3NlbGZfcmVmcmVzaF9oZWxwZXJfaW5pdChzdHJ1Y3QgZHJtX2NydGMgKmNydGMp
CiB7CiAJc3RydWN0IGRybV9zZWxmX3JlZnJlc2hfZGF0YSAqc3JfZGF0YSA9IGNydGMtPnNlbGZf
cmVmcmVzaF9kYXRhOwogCkBAIC0xODksOCArMjM5LDE4IEBAIGludCBkcm1fc2VsZl9yZWZyZXNo
X2hlbHBlcl9pbml0KHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKIAogCUlOSVRfREVMQVlFRF9XT1JL
KCZzcl9kYXRhLT5lbnRyeV93b3JrLAogCQkJICBkcm1fc2VsZl9yZWZyZXNoX2hlbHBlcl9lbnRy
eV93b3JrKTsKLQlzcl9kYXRhLT5lbnRyeV9kZWxheV9tcyA9IGVudHJ5X2RlbGF5X21zOwogCXNy
X2RhdGEtPmNydGMgPSBjcnRjOworCW11dGV4X2luaXQoJnNyX2RhdGEtPmF2Z19tdXRleCk7CisJ
ZXdtYV9wc3JfdGltZV9pbml0KCZzcl9kYXRhLT5lbnRyeV9hdmdfbXMpOworCWV3bWFfcHNyX3Rp
bWVfaW5pdCgmc3JfZGF0YS0+ZXhpdF9hdmdfbXMpOworCisJLyoKKwkgKiBTZWVkIHRoZSBhdmVy
YWdlcyBzbyB0aGV5J3JlIG5vbi16ZXJvIChhbmQgc3VmZmljaWVudGx5IGxhcmdlCisJICogZm9y
IGV2ZW4gcG9vcmx5IHBlcmZvcm1pbmcgcGFuZWxzKS4gQXMgdGltZSBnb2VzIG9uLCB0aGlzIHdp
bGwgYmUKKwkgKiBhdmVyYWdlZCBvdXQgYW5kIHRoZSB2YWx1ZXMgd2lsbCB0cmVuZCB0byB0aGVp
ciB0cnVlIHZhbHVlLgorCSAqLworCWV3bWFfcHNyX3RpbWVfYWRkKCZzcl9kYXRhLT5lbnRyeV9h
dmdfbXMsIFNFTEZfUkVGUkVTSF9BVkdfU0VFRF9NUyk7CisJZXdtYV9wc3JfdGltZV9hZGQoJnNy
X2RhdGEtPmV4aXRfYXZnX21zLCBTRUxGX1JFRlJFU0hfQVZHX1NFRURfTVMpOwogCiAJY3J0Yy0+
c2VsZl9yZWZyZXNoX2RhdGEgPSBzcl9kYXRhOwogCXJldHVybiAwOwpkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL3JvY2tjaGlwL3JvY2tjaGlwX2RybV92b3AuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1fdm9wLmMKaW5kZXggMmY4MjFjNTgwMDdjLi42MTM0MDRm
ODY2NjggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9yb2NrY2hpcC9yb2NrY2hpcF9kcm1f
dm9wLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3JvY2tjaGlwL3JvY2tjaGlwX2RybV92b3AuYwpA
QCAtMzksOCArMzksNiBAQAogI2luY2x1ZGUgInJvY2tjaGlwX2RybV92b3AuaCIKICNpbmNsdWRl
ICJyb2NrY2hpcF9yZ2IuaCIKIAotI2RlZmluZSBWT1BfU0VMRl9SRUZSRVNIX0VOVFJZX0RFTEFZ
X01TIDEwMAotCiAjZGVmaW5lIFZPUF9XSU5fU0VUKHZvcCwgd2luLCBuYW1lLCB2KSBcCiAJCXZv
cF9yZWdfc2V0KHZvcCwgJndpbi0+cGh5LT5uYW1lLCB3aW4tPmJhc2UsIH4wLCB2LCAjbmFtZSkK
ICNkZWZpbmUgVk9QX1NDTF9TRVQodm9wLCB3aW4sIG5hbWUsIHYpIFwKQEAgLTE1NjMsOCArMTU2
MSw3IEBAIHN0YXRpYyBpbnQgdm9wX2NyZWF0ZV9jcnRjKHN0cnVjdCB2b3AgKnZvcCkKIAlpbml0
X2NvbXBsZXRpb24oJnZvcC0+bGluZV9mbGFnX2NvbXBsZXRpb24pOwogCWNydGMtPnBvcnQgPSBw
b3J0OwogCi0JcmV0ID0gZHJtX3NlbGZfcmVmcmVzaF9oZWxwZXJfaW5pdChjcnRjLAotCQkJCQkg
ICBWT1BfU0VMRl9SRUZSRVNIX0VOVFJZX0RFTEFZX01TKTsKKwlyZXQgPSBkcm1fc2VsZl9yZWZy
ZXNoX2hlbHBlcl9pbml0KGNydGMpOwogCWlmIChyZXQpCiAJCURSTV9ERVZfREVCVUdfS01TKHZv
cC0+ZGV2LAogCQkJIkZhaWxlZCB0byBpbml0ICVzIHdpdGggU1IgaGVscGVycyAlZCwgaWdub3Jp
bmdcbiIsCmRpZmYgLS1naXQgYS9pbmNsdWRlL2RybS9kcm1fc2VsZl9yZWZyZXNoX2hlbHBlci5o
IGIvaW5jbHVkZS9kcm0vZHJtX3NlbGZfcmVmcmVzaF9oZWxwZXIuaAppbmRleCAzOTdhNTgzY2Nj
YTcuLjViNzlkMjUzZmI0NiAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vZHJtX3NlbGZfcmVmcmVz
aF9oZWxwZXIuaAorKysgYi9pbmNsdWRlL2RybS9kcm1fc2VsZl9yZWZyZXNoX2hlbHBlci5oCkBA
IC0xMiw5ICsxMiw5IEBAIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlOwogc3RydWN0IGRybV9jcnRj
OwogCiB2b2lkIGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX2FsdGVyX3N0YXRlKHN0cnVjdCBkcm1f
YXRvbWljX3N0YXRlICpzdGF0ZSk7Cit2b2lkIGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX3VwZGF0
ZV9hdmdfdGltZXMoc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlLAorCQkJCQkgICAgICB1
bnNpZ25lZCBpbnQgY29tbWl0X3RpbWVfbXMpOwogCi1pbnQgZHJtX3NlbGZfcmVmcmVzaF9oZWxw
ZXJfaW5pdChzdHJ1Y3QgZHJtX2NydGMgKmNydGMsCi0JCQkJIHVuc2lnbmVkIGludCBlbnRyeV9k
ZWxheV9tcyk7Ci0KK2ludCBkcm1fc2VsZl9yZWZyZXNoX2hlbHBlcl9pbml0KHN0cnVjdCBkcm1f
Y3J0YyAqY3J0Yyk7CiB2b2lkIGRybV9zZWxmX3JlZnJlc2hfaGVscGVyX2NsZWFudXAoc3RydWN0
IGRybV9jcnRjICpjcnRjKTsKICNlbmRpZgotLSAKU2VhbiBQYXVsLCBTb2Z0d2FyZSBFbmdpbmVl
ciwgR29vZ2xlIC8gQ2hyb21pdW0gT1MKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2RyaS1kZXZlbA==
