Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id CC9209BE0D
	for <lists+dri-devel@lfdr.de>; Sat, 24 Aug 2019 15:38:21 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8DA006E0C3;
	Sat, 24 Aug 2019 13:38:17 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 523C96E0C3;
 Sat, 24 Aug 2019 13:38:15 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 18250863-1500050 
 for multiple; Sat, 24 Aug 2019 14:38:09 +0100
From: Chris Wilson <chris@chris-wilson.co.uk>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH] dma-buf: Extend selftests to exercise dma-fence-array
Date: Sat, 24 Aug 2019 14:38:06 +0100
Message-Id: <20190824133806.8473-1-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.23.0
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: intel-gfx@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

QSBwcmVsaW1pbmFyeSBzZXQgb2YgdGVzdHMgdG8gZXhlcmNpc2UgdGhlIGJhc2ljIGRtYS1mZW5j
ZSBBUEkgb24gdG9wIG9mCnN0cnVjdCBkbWFfZmVuY2VfYXJyYXkuCgpTaWduZWQtb2ZmLWJ5OiBD
aHJpcyBXaWxzb24gPGNocmlzQGNocmlzLXdpbHNvbi5jby51az4KLS0tCiBkcml2ZXJzL2RtYS1i
dWYvTWFrZWZpbGUgICAgICAgICAgICAgfCAgIDMgKy0KIGRyaXZlcnMvZG1hLWJ1Zi9zZWxmdGVz
dHMuaCAgICAgICAgICB8ICAgMSArCiBkcml2ZXJzL2RtYS1idWYvc3QtZG1hLWZlbmNlLWFycmF5
LmMgfCAzOTIgKysrKysrKysrKysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDM5
NSBpbnNlcnRpb25zKCspLCAxIGRlbGV0aW9uKC0pCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVy
cy9kbWEtYnVmL3N0LWRtYS1mZW5jZS1hcnJheS5jCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEt
YnVmL01ha2VmaWxlIGIvZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlCmluZGV4IDAzNDc5ZGEwNjQy
Mi4uODIyZmI2NWIxNGU0IDEwMDY0NAotLS0gYS9kcml2ZXJzL2RtYS1idWYvTWFrZWZpbGUKKysr
IGIvZHJpdmVycy9kbWEtYnVmL01ha2VmaWxlCkBAIC03LDYgKzcsNyBAQCBvYmotJChDT05GSUdf
VURNQUJVRikJCSs9IHVkbWFidWYubwogCiBkbWFidWZfc2VsZnRlc3RzLXkgOj0gXAogCXNlbGZ0
ZXN0Lm8gXAotCXN0LWRtYS1mZW5jZS5vCisJc3QtZG1hLWZlbmNlLm8gXAorCXN0LWRtYS1mZW5j
ZS1hcnJheS5vCiAKIG9iai0kKENPTkZJR19ETUFCVUZfU0VMRlRFU1RTKQkrPSBkbWFidWZfc2Vs
ZnRlc3RzLm8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9zZWxmdGVzdHMuaCBiL2RyaXZl
cnMvZG1hLWJ1Zi9zZWxmdGVzdHMuaAppbmRleCA1MzIwMzg2ZjAyZTUuLjEyMjQxYjJjMDNmMiAx
MDA2NDQKLS0tIGEvZHJpdmVycy9kbWEtYnVmL3NlbGZ0ZXN0cy5oCisrKyBiL2RyaXZlcnMvZG1h
LWJ1Zi9zZWxmdGVzdHMuaApAQCAtMTEsMyArMTEsNCBAQAogICovCiBzZWxmdGVzdChzYW5pdHlj
aGVjaywgX19zYW5pdHljaGVja19fKSAvKiBrZWVwIGZpcnN0IChpZ3Qgc2VsZmNoZWNrKSAqLwog
c2VsZnRlc3QoZG1hX2ZlbmNlLCBkbWFfZmVuY2UpCitzZWxmdGVzdChkbWFfZmVuY2VfYXJyYXks
IGRtYV9mZW5jZV9hcnJheSkKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZG1hLWJ1Zi9zdC1kbWEtZmVu
Y2UtYXJyYXkuYyBiL2RyaXZlcnMvZG1hLWJ1Zi9zdC1kbWEtZmVuY2UtYXJyYXkuYwpuZXcgZmls
ZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMDAwMDAuLjY4NWE1NjRhMjgyNgotLS0gL2Rldi9u
dWxsCisrKyBiL2RyaXZlcnMvZG1hLWJ1Zi9zdC1kbWEtZmVuY2UtYXJyYXkuYwpAQCAtMCwwICsx
LDM5MiBAQAorLyogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVCAqLworCisvKgorICogQ29w
eXJpZ2h0IMKpIDIwMTkgSW50ZWwgQ29ycG9yYXRpb24KKyAqLworCisjaW5jbHVkZSA8bGludXgv
ZGVsYXkuaD4KKyNpbmNsdWRlIDxsaW51eC9kbWEtZmVuY2UuaD4KKyNpbmNsdWRlIDxsaW51eC9k
bWEtZmVuY2UtYXJyYXkuaD4KKyNpbmNsdWRlIDxsaW51eC9rZXJuZWwuaD4KKyNpbmNsdWRlIDxs
aW51eC9rdGhyZWFkLmg+CisjaW5jbHVkZSA8bGludXgvc2NoZWQvc2lnbmFsLmg+CisjaW5jbHVk
ZSA8bGludXgvc2xhYi5oPgorI2luY2x1ZGUgPGxpbnV4L3NwaW5sb2NrLmg+CisKKyNpbmNsdWRl
ICJzZWxmdGVzdC5oIgorCitzdGF0aWMgc3RydWN0IGttZW1fY2FjaGUgKnNsYWJfZmVuY2VzOwor
CitzdGF0aWMgc3RydWN0IG1vY2tfZmVuY2UgeworCXN0cnVjdCBkbWFfZmVuY2UgYmFzZTsKKwlz
dHJ1Y3Qgc3BpbmxvY2sgbG9jazsKK30gKnRvX21vY2tfZmVuY2Uoc3RydWN0IGRtYV9mZW5jZSAq
ZikgeworCXJldHVybiBjb250YWluZXJfb2YoZiwgc3RydWN0IG1vY2tfZmVuY2UsIGJhc2UpOwor
fQorCitzdGF0aWMgY29uc3QgY2hhciAqbW9ja19uYW1lKHN0cnVjdCBkbWFfZmVuY2UgKmYpCit7
CisJcmV0dXJuICJtb2NrIjsKK30KKworc3RhdGljIHZvaWQgbW9ja19mZW5jZV9yZWxlYXNlKHN0
cnVjdCBkbWFfZmVuY2UgKmYpCit7CisJa21lbV9jYWNoZV9mcmVlKHNsYWJfZmVuY2VzLCB0b19t
b2NrX2ZlbmNlKGYpKTsKK30KKworc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFfZmVuY2Vfb3BzIG1v
Y2tfb3BzID0geworCS5nZXRfZHJpdmVyX25hbWUgPSBtb2NrX25hbWUsCisJLmdldF90aW1lbGlu
ZV9uYW1lID0gbW9ja19uYW1lLAorCS5yZWxlYXNlID0gbW9ja19mZW5jZV9yZWxlYXNlLAorfTsK
Kworc3RhdGljIHN0cnVjdCBkbWFfZmVuY2UgKm1vY2tfZmVuY2Uodm9pZCAqYXJnKQoreworCXN0
cnVjdCBtb2NrX2ZlbmNlICpmOworCisJZiA9IGttZW1fY2FjaGVfYWxsb2Moc2xhYl9mZW5jZXMs
IEdGUF9LRVJORUwpOworCWlmICghZikKKwkJcmV0dXJuIE5VTEw7CisKKwlzcGluX2xvY2tfaW5p
dCgmZi0+bG9jayk7CisJZG1hX2ZlbmNlX2luaXQoJmYtPmJhc2UsICZtb2NrX29wcywgJmYtPmxv
Y2ssIDAsIDApOworCisJcmV0dXJuICZmLT5iYXNlOworfQorCitzdGF0aWMgc3RydWN0IGRtYV9m
ZW5jZSAqc3R1Yl9mZW5jZSh2b2lkICphcmcpCit7CisJcmV0dXJuIGRtYV9mZW5jZV9nZXRfc3R1
YigpOworfQorCitzdGF0aWMgc3RydWN0IGRtYV9mZW5jZSAqc2FtZV9mZW5jZSh2b2lkICphcmcp
Cit7CisJcmV0dXJuIGRtYV9mZW5jZV9nZXQoYXJnKTsKK30KKworc3RhdGljIGludCBlbXB0eSh2
b2lkICphcmcpCit7CisJc3RydWN0IGRtYV9mZW5jZV9hcnJheSAqYXJyOworCWludCBlcnIgPSAw
OworCisJYXJyID0gZG1hX2ZlbmNlX2FycmF5X2NyZWF0ZSgwLCBOVUxMLCAwLCAwLCBmYWxzZSk7
CisJaWYgKCFhcnIpCisJCXJldHVybiAtRU5PTUVNOworCisJaWYgKCFkbWFfZmVuY2VfaXNfc2ln
bmFsZWQoJmFyci0+YmFzZSkpIHsKKwkJcHJfZXJyKCJFbXB0eSBkbWEtZmVuY2UtYXJyYXkgaXMg
bm90IHNpZ25hbGVkIVxuIik7CisJCWVyciA9IC1FSU5WQUw7CisJfQorCisJZG1hX2ZlbmNlX3B1
dCgmYXJyLT5iYXNlKTsKKwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgdm9pZCBmcmVlX2ZlbmNl
cyhpbnQgY291bnQsIHN0cnVjdCBkbWFfZmVuY2UgKipmZW5jZXMpCit7CisJd2hpbGUgKGNvdW50
LS0pCisJCWRtYV9mZW5jZV9wdXQoZmVuY2VzW2NvdW50XSk7CisJa2ZyZWUoZmVuY2VzKTsKK30K
Kworc3RhdGljIHN0cnVjdCBkbWFfZmVuY2UgKioKK2NyZWF0ZV9mZW5jZXMoaW50IGNvdW50LCBz
dHJ1Y3QgZG1hX2ZlbmNlICooKmN0b3IpKHZvaWQgKmFyZyksIHZvaWQgKmFyZykKK3sKKwlzdHJ1
Y3QgZG1hX2ZlbmNlICoqZmVuY2VzOworCWludCBpOworCisJZmVuY2VzID0ga21hbGxvY19hcnJh
eShjb3VudCwgc2l6ZW9mKCpmZW5jZXMpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWZlbmNlcykKKwkJ
cmV0dXJuIE5VTEw7CisKKwlmb3IgKGkgPSAwOyBpIDwgY291bnQ7IGkrKykgeworCQlmZW5jZXNb
aV0gPSBjdG9yKGFyZyk7CisJCWlmICghZmVuY2VzW2ldKSB7CisJCQlmcmVlX2ZlbmNlcyhpLCBm
ZW5jZXMpOworCQkJcmV0dXJuIE5VTEw7CisJCX0KKwl9CisKKwlyZXR1cm4gZmVuY2VzOworfQor
CitzdGF0aWMgaW50IHN0dWIodm9pZCAqYXJnKQoreworCXN0cnVjdCBkbWFfZmVuY2VfYXJyYXkg
KmFycjsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICoqZmVuY2VzOworCWludCBlcnIgPSAwOworCisJZmVu
Y2VzID0gY3JlYXRlX2ZlbmNlcygxLCBzdHViX2ZlbmNlLCBOVUxMKTsKKwlpZiAoIWZlbmNlcykK
KwkJcmV0dXJuIC1FTk9NRU07CisKKwlhcnIgPSBkbWFfZmVuY2VfYXJyYXlfY3JlYXRlKDEsIGZl
bmNlcywgMCwgMCwgZmFsc2UpOworCWlmICghYXJyKSB7CisJCWZyZWVfZmVuY2VzKDEsIGZlbmNl
cyk7CisJCXJldHVybiAtRU5PTUVNOworCX0KKworCWRtYV9mZW5jZV9lbmFibGVfc3dfc2lnbmFs
aW5nKCZhcnItPmJhc2UpOworCisJaWYgKCFkbWFfZmVuY2VfaXNfc2lnbmFsZWQoJmFyci0+YmFz
ZSkpIHsKKwkJcHJfZXJyKCJkbWEtZmVuY2UtYXJyYXkoc3R1YikgaXMgbm90IHNpZ25hbGVkIVxu
Iik7CisJCWVyciA9IC1FSU5WQUw7CisJfQorCisJZG1hX2ZlbmNlX3B1dCgmYXJyLT5iYXNlKTsK
KwlyZXR1cm4gZXJyOworfQorCitzdGF0aWMgaW50IHNpbmdsZSh2b2lkICphcmcpCit7CisJc3Ry
dWN0IGRtYV9mZW5jZV9hcnJheSAqYXJyOworCXN0cnVjdCBkbWFfZmVuY2UgKipmZW5jZXM7CisJ
aW50IGVyciA9IDA7CisKKwlmZW5jZXMgPSBjcmVhdGVfZmVuY2VzKDEsIG1vY2tfZmVuY2UsIE5V
TEwpOworCWlmICghZmVuY2VzKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWFyciA9IGRtYV9mZW5j
ZV9hcnJheV9jcmVhdGUoMSwgZmVuY2VzLCAwLCAwLCBmYWxzZSk7CisJaWYgKCFhcnIpIHsKKwkJ
ZnJlZV9mZW5jZXMoMSwgZmVuY2VzKTsKKwkJcmV0dXJuIC1FTk9NRU07CisJfQorCisJZG1hX2Zl
bmNlX2VuYWJsZV9zd19zaWduYWxpbmcoJmFyci0+YmFzZSk7CisKKwlpZiAoZG1hX2ZlbmNlX2lz
X3NpZ25hbGVkKCZhcnItPmJhc2UpKSB7CisJCXByX2VycigiZG1hLWZlbmNlLWFycmF5KHNpbmds
ZSkgaXMgc2lnbmFsZWQgdXBvbiBjcmVhdGlvbiFcbiIpOworCQllcnIgPSAtRUlOVkFMOworCX0K
KworCWRtYV9mZW5jZV9zaWduYWwoZmVuY2VzWzBdKTsKKworCWlmICghZG1hX2ZlbmNlX2lzX3Np
Z25hbGVkKCZhcnItPmJhc2UpKSB7CisJCXByX2VycigiZG1hLWZlbmNlLWFycmF5KHNpbmdsZSkg
aXMgbm90IHNpZ25hbGVkXG4iKTsKKwkJZXJyID0gLUVJTlZBTDsKKwl9CisKKwlkbWFfZmVuY2Vf
cHV0KCZhcnItPmJhc2UpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBpbnQgcGFpcih2b2lk
ICphcmcpCit7CisJc3RydWN0IGRtYV9mZW5jZV9hcnJheSAqYXJyOworCXN0cnVjdCBkbWFfZmVu
Y2UgKipmZW5jZXM7CisJaW50IGVyciA9IDA7CisKKwlmZW5jZXMgPSBjcmVhdGVfZmVuY2VzKDIs
IG1vY2tfZmVuY2UsIE5VTEwpOworCWlmICghZmVuY2VzKQorCQlyZXR1cm4gLUVOT01FTTsKKwor
CWFyciA9IGRtYV9mZW5jZV9hcnJheV9jcmVhdGUoMiwgZmVuY2VzLCAwLCAwLCBmYWxzZSk7CisJ
aWYgKCFhcnIpIHsKKwkJZnJlZV9mZW5jZXMoMiwgZmVuY2VzKTsKKwkJcmV0dXJuIC1FTk9NRU07
CisJfQorCisJZG1hX2ZlbmNlX2VuYWJsZV9zd19zaWduYWxpbmcoJmFyci0+YmFzZSk7CisKKwlp
ZiAoZG1hX2ZlbmNlX2lzX3NpZ25hbGVkKCZhcnItPmJhc2UpKSB7CisJCXByX2VycigiZG1hLWZl
bmNlLWFycmF5KHBhaXIpIGlzIHNpZ25hbGVkIHVwb24gY3JlYXRpb24hXG4iKTsKKwkJZXJyID0g
LUVJTlZBTDsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGZlbmNlc1swXSk7CisKKwlpZiAoZG1h
X2ZlbmNlX2lzX3NpZ25hbGVkKCZhcnItPmJhc2UpKSB7CisJCXByX2VycigiZG1hLWZlbmNlLWFy
cmF5KHBhaXIpIGlzIHNpZ25hbGVkIGFmdGVyIG9uZSBzaWduYWwhXG4iKTsKKwkJZXJyID0gLUVJ
TlZBTDsKKwl9CisKKwlkbWFfZmVuY2Vfc2lnbmFsKGZlbmNlc1swXSk7CisKKwlpZiAoZG1hX2Zl
bmNlX2lzX3NpZ25hbGVkKCZhcnItPmJhc2UpKSB7CisJCXByX2VycigiZG1hLWZlbmNlLWFycmF5
KHBhaXIpIGlzIHNpZ25hbGVkIGFmdGVyIGEgcmVwZWF0ZWQgc2lnbmFsIVxuIik7CisJCWVyciA9
IC1FSU5WQUw7CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmZW5jZXNbMV0pOworCisJaWYgKCFk
bWFfZmVuY2VfaXNfc2lnbmFsZWQoJmFyci0+YmFzZSkpIHsKKwkJcHJfZXJyKCJkbWEtZmVuY2Ut
YXJyYXkocGFpcikgaXMgbm90IHNpZ25hbGVkXG4iKTsKKwkJZXJyID0gLUVJTlZBTDsKKwl9CisK
KwlkbWFfZmVuY2VfcHV0KCZhcnItPmJhc2UpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBp
bnQgcmVwZWF0KHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlX2FycmF5ICphcnI7CisJ
c3RydWN0IGRtYV9mZW5jZSAqKmZlbmNlczsKKwlzdHJ1Y3QgZG1hX2ZlbmNlICpmOworCWludCBl
cnIgPSAwOworCisJZiA9IG1vY2tfZmVuY2UoTlVMTCk7CisJaWYgKCFmKQorCQlyZXR1cm4gLUVO
T01FTTsKKworCWZlbmNlcyA9IGNyZWF0ZV9mZW5jZXMoMiwgc2FtZV9mZW5jZSwgZik7CisJZG1h
X2ZlbmNlX3B1dChmKTsKKwlpZiAoIWZlbmNlcykKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlhcnIg
PSBkbWFfZmVuY2VfYXJyYXlfY3JlYXRlKDIsIGZlbmNlcywgMCwgMCwgZmFsc2UpOworCWlmICgh
YXJyKSB7CisJCWZyZWVfZmVuY2VzKDIsIGZlbmNlcyk7CisJCXJldHVybiAtRU5PTUVNOworCX0K
KworCWRtYV9mZW5jZV9lbmFibGVfc3dfc2lnbmFsaW5nKCZhcnItPmJhc2UpOworCisJaWYgKGRt
YV9mZW5jZV9pc19zaWduYWxlZCgmYXJyLT5iYXNlKSkgeworCQlwcl9lcnIoImRtYS1mZW5jZS1h
cnJheShwYWlyKSBpcyBzaWduYWxlZCB1cG9uIGNyZWF0aW9uIVxuIik7CisJCWVyciA9IC1FSU5W
QUw7CisJfQorCisJZG1hX2ZlbmNlX3NpZ25hbChmZW5jZXNbMF0pOworCisJaWYgKCFkbWFfZmVu
Y2VfaXNfc2lnbmFsZWQoJmFyci0+YmFzZSkpIHsKKwkJcHJfZXJyKCJkbWEtZmVuY2UtYXJyYXko
cGFpcikgaXMgbm90IHNpZ25hbGVkXG4iKTsKKwkJZXJyID0gLUVJTlZBTDsKKwl9CisKKwlkbWFf
ZmVuY2VfcHV0KCZhcnItPmJhc2UpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyBzdHJ1Y3Qg
ZG1hX2ZlbmNlICpjcmVhdGVfc3R1Yl9hcnJheSh2b2lkICphcmcpCit7CisJc3RydWN0IGRtYV9m
ZW5jZV9hcnJheSAqYXJyOworCXN0cnVjdCBkbWFfZmVuY2UgKipmZW5jZXM7CisKKwlmZW5jZXMg
PSBjcmVhdGVfZmVuY2VzKDEsIHN0dWJfZmVuY2UsIE5VTEwpOworCWlmICghZmVuY2VzKQorCQly
ZXR1cm4gTlVMTDsKKworCWFyciA9IGRtYV9mZW5jZV9hcnJheV9jcmVhdGUoMSwgZmVuY2VzLCAw
LCAwLCBmYWxzZSk7CisJaWYgKCFhcnIpIHsKKwkJZnJlZV9mZW5jZXMoMSwgZmVuY2VzKTsKKwkJ
cmV0dXJuIE5VTEw7CisJfQorCisJcmV0dXJuICZhcnItPmJhc2U7Cit9CisKK3N0YXRpYyBpbnQg
cmVjdXJzZV9zdHViKHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlX2FycmF5ICphcnI7
CisJc3RydWN0IGRtYV9mZW5jZSAqKmZlbmNlczsKKwlpbnQgZXJyID0gMDsKKworCWZlbmNlcyA9
IGNyZWF0ZV9mZW5jZXMoMSwgY3JlYXRlX3N0dWJfYXJyYXksIE5VTEwpOworCWlmICghZmVuY2Vz
KQorCQlyZXR1cm4gLUVOT01FTTsKKworCWFyciA9IGRtYV9mZW5jZV9hcnJheV9jcmVhdGUoMSwg
ZmVuY2VzLCAwLCAwLCBmYWxzZSk7CisJaWYgKCFhcnIpIHsKKwkJZnJlZV9mZW5jZXMoMSwgZmVu
Y2VzKTsKKwkJcmV0dXJuIC1FTk9NRU07CisJfQorCisJZG1hX2ZlbmNlX2VuYWJsZV9zd19zaWdu
YWxpbmcoJmFyci0+YmFzZSk7CisKKwlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZCgmYXJyLT5i
YXNlKSkgeworCQlwcl9lcnIoImRtYS1mZW5jZS1hcnJheShyZWN1cnNlLXN0dWIpIGlzIG5vdCBz
aWduYWxlZCFcbiIpOworCQllcnIgPSAtRUlOVkFMOworCX0KKworCWRtYV9mZW5jZV9wdXQoJmFy
ci0+YmFzZSk7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIHN0cnVjdCBkbWFfZmVuY2UgKmNy
ZWF0ZV9tb2NrX2FycmF5KHZvaWQgKmFyZykKK3sKKwlzdHJ1Y3QgZG1hX2ZlbmNlX2FycmF5ICph
cnI7CisJc3RydWN0IGRtYV9mZW5jZSAqKmZlbmNlczsKKworCWZlbmNlcyA9IGNyZWF0ZV9mZW5j
ZXMoMSwgc2FtZV9mZW5jZSwgYXJnKTsKKwlpZiAoIWZlbmNlcykKKwkJcmV0dXJuIE5VTEw7CisK
KwlhcnIgPSBkbWFfZmVuY2VfYXJyYXlfY3JlYXRlKDEsIGZlbmNlcywgMCwgMCwgZmFsc2UpOwor
CWlmICghYXJyKSB7CisJCWZyZWVfZmVuY2VzKDEsIGZlbmNlcyk7CisJCXJldHVybiBOVUxMOwor
CX0KKworCXJldHVybiAmYXJyLT5iYXNlOworfQorCitzdGF0aWMgaW50IHJlY3Vyc2VfbW9jayh2
b2lkICphcmcpCit7CisJc3RydWN0IGRtYV9mZW5jZV9hcnJheSAqYXJyOworCXN0cnVjdCBkbWFf
ZmVuY2UgKipmZW5jZXM7CisJc3RydWN0IGRtYV9mZW5jZSAqZjsKKwlpbnQgZXJyID0gMDsKKwor
CWYgPSBtb2NrX2ZlbmNlKE5VTEwpOworCWlmICghZikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlm
ZW5jZXMgPSBjcmVhdGVfZmVuY2VzKDEsIGNyZWF0ZV9tb2NrX2FycmF5LCBmKTsKKwlpZiAoIWZl
bmNlcykgeworCQlkbWFfZmVuY2VfcHV0KGYpOworCQlyZXR1cm4gLUVOT01FTTsKKwl9CisKKwlh
cnIgPSBkbWFfZmVuY2VfYXJyYXlfY3JlYXRlKDEsIGZlbmNlcywgMCwgMCwgZmFsc2UpOworCWlm
ICghYXJyKSB7CisJCWZyZWVfZmVuY2VzKDEsIGZlbmNlcyk7CisJCWRtYV9mZW5jZV9wdXQoZik7
CisJCXJldHVybiAtRU5PTUVNOworCX0KKworCWRtYV9mZW5jZV9lbmFibGVfc3dfc2lnbmFsaW5n
KCZhcnItPmJhc2UpOworCisJaWYgKGRtYV9mZW5jZV9pc19zaWduYWxlZCgmYXJyLT5iYXNlKSkg
eworCQlwcl9lcnIoImRtYS1mZW5jZS1hcnJheShyZWN1cnNlLW1vY2spIGlzIHNpZ25hbGVkIG9u
IGNvbnN0cnVjdGlvbiFcbiIpOworCQllcnIgPSAtRUlOVkFMOworCX0KKworCWRtYV9mZW5jZV9z
aWduYWwoZik7CisKKwlpZiAoIWRtYV9mZW5jZV9pc19zaWduYWxlZCgmYXJyLT5iYXNlKSkgewor
CQlwcl9lcnIoImRtYS1mZW5jZS1hcnJheShyZWN1cnNlLW1vY2spIGlzIG5vdCBzaWduYWxlZCFc
biIpOworCQllcnIgPSAtRUlOVkFMOworCX0KKworCWRtYV9mZW5jZV9wdXQoJmFyci0+YmFzZSk7
CisJZG1hX2ZlbmNlX3B1dChmKTsKKwlyZXR1cm4gZXJyOworfQorCitpbnQgZG1hX2ZlbmNlX2Fy
cmF5KHZvaWQpCit7CisJc3RhdGljIGNvbnN0IHN0cnVjdCBzdWJ0ZXN0IHRlc3RzW10gPSB7CisJ
CVNVQlRFU1QoZW1wdHkpLAorCQlTVUJURVNUKHN0dWIpLAorCQlTVUJURVNUKHNpbmdsZSksCisJ
CVNVQlRFU1QocGFpciksCisJCVNVQlRFU1QocmVwZWF0KSwKKwkJU1VCVEVTVChyZWN1cnNlX3N0
dWIpLAorCQlTVUJURVNUKHJlY3Vyc2VfbW9jayksCisJfTsKKwlpbnQgcmV0OworCisJc2xhYl9m
ZW5jZXMgPSBLTUVNX0NBQ0hFKG1vY2tfZmVuY2UsCisJCQkJIFNMQUJfVFlQRVNBRkVfQllfUkNV
IHwKKwkJCQkgU0xBQl9IV0NBQ0hFX0FMSUdOKTsKKwlpZiAoIXNsYWJfZmVuY2VzKQorCQlyZXR1
cm4gLUVOT01FTTsKKworCXJldCA9IHN1YnRlc3RzKHRlc3RzLCBOVUxMKTsKKworCWttZW1fY2Fj
aGVfZGVzdHJveShzbGFiX2ZlbmNlcyk7CisKKwlyZXR1cm4gcmV0OworfQotLSAKMi4yMy4wCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwg
bWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0
cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
