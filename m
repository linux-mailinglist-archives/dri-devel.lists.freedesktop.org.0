Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 86AA41CC21E
	for <lists+dri-devel@lfdr.de>; Sat,  9 May 2020 16:17:03 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id DBFF16E35D;
	Sat,  9 May 2020 14:16:51 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from asav22.altibox.net (asav22.altibox.net [109.247.116.9])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B4A9D6E362
 for <dri-devel@lists.freedesktop.org>; Sat,  9 May 2020 14:16:46 +0000 (UTC)
Received: from localhost.localdomain (unknown [81.166.168.211])
 (using TLSv1.2 with cipher ECDHE-RSA-AES128-SHA256 (128/128 bits))
 (No client certificate requested)
 (Authenticated sender: noralf.tronnes@ebnett.no)
 by asav22.altibox.net (Postfix) with ESMTPSA id C32C520194;
 Sat,  9 May 2020 16:16:44 +0200 (CEST)
From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
To: dri-devel@lists.freedesktop.org, linux-usb@vger.kernel.org,
 lee.jones@linaro.org
Subject: [PATCH v2 09/10] drm/gud: Add functionality for the USB gadget side
Date: Sat,  9 May 2020 16:16:18 +0200
Message-Id: <20200509141619.32970-10-noralf@tronnes.org>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20200509141619.32970-1-noralf@tronnes.org>
References: <20200509141619.32970-1-noralf@tronnes.org>
MIME-Version: 1.0
X-CMAE-Score: 0
X-CMAE-Analysis: v=2.3 cv=R7It5+ZX c=1 sm=1 tr=0
 a=OYZzhG0JTxDrWp/F2OJbnw==:117 a=OYZzhG0JTxDrWp/F2OJbnw==:17
 a=IkcTkHD0fZMA:10 a=M51BFTxLslgA:10 a=SJz97ENfAAAA:8
 a=JEiCMFymvXJ_tcOM5XYA:9 a=g-H6GvAlq0W4zGb9:21 a=eoMYUHcxvnIfTj1J:21
 a=QEXdDO2ut3YA:10 a=vFet0B0WnEQeilDPIY6i:22
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: jingoohan1@gmail.com, daniel.thompson@linaro.org, sam@ravnborg.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2UgdGhlIFVTQiBnYWRnZXQvZGV2aWNlIGhhcyB0byByZWFjaCBpbnRvIHRoZSBEUk0gaW50
ZXJuYWxzLCBwYXJ0IG9mCnRoZSBjb2RlIGlzIHBsYWNlZCBpbiB0aGUgRFJNIHN1YnN5c3RlbSBh
cyBhIHNlcGFyYXRlIG1vZHVsZS4gQWxsIGNhbGxzCmludG8gdGhpcyBtb2R1bGUgcnVucyBpbiBw
cm9jZXNzIGNvbnRleHQgYW5kIGFyZSBzZXJpYWxpemVkLCBleGNlcHQgb25lCmZ1bmN0aW9uIHRo
YXQgcnVucyBpbiBpbnRlcnJ1cHQgY29udGV4dC4KClNpbmNlIGJvdGggdGhlIGdhZGdldCBzaWRl
IGFuZCB0aGUgRFJNIHNpZGUgY2FuIGRpc2FibGUgdGhlIGdhZGdldCwKc3BlY2lhbCBjYXJlIGhh
cyBiZWVuIHRha2VuIHRvIG1ha2UgdGhhdCBzYWZlLgoKdjI6Ci0gVXNlIGRybV9jbGllbnRfbW9k
ZXNldF9kaXNhYmxlKCkKClNpZ25lZC1vZmYtYnk6IE5vcmFsZiBUcsO4bm5lcyA8bm9yYWxmQHRy
b25uZXMub3JnPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9ndWQvS2NvbmZpZyAgICAgICAgICB8ICAg
IDYgKwogZHJpdmVycy9ncHUvZHJtL2d1ZC9NYWtlZmlsZSAgICAgICAgIHwgICAgMSArCiBkcml2
ZXJzL2dwdS9kcm0vZ3VkL2d1ZF9kcm1fZ2FkZ2V0LmMgfCAxMTY1ICsrKysrKysrKysrKysrKysr
KysrKysrKysrCiBpbmNsdWRlL2RybS9ndWRfZHJtLmggICAgICAgICAgICAgICAgfCAgIDEzICsK
IDQgZmlsZXMgY2hhbmdlZCwgMTE4NSBpbnNlcnRpb25zKCspCiBjcmVhdGUgbW9kZSAxMDA2NDQg
ZHJpdmVycy9ncHUvZHJtL2d1ZC9ndWRfZHJtX2dhZGdldC5jCgpkaWZmIC0tZ2l0IGEvZHJpdmVy
cy9ncHUvZHJtL2d1ZC9LY29uZmlnIGIvZHJpdmVycy9ncHUvZHJtL2d1ZC9LY29uZmlnCmluZGV4
IDc2N2YxYzA2N2VkOS4uOWJiZjM5YWU2MTkxIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
Z3VkL0tjb25maWcKKysrIGIvZHJpdmVycy9ncHUvZHJtL2d1ZC9LY29uZmlnCkBAIC0xMiwzICsx
Miw5IEBAIGNvbmZpZyBEUk1fR1VECiAJICBhZGFwdGVycy4KIAogCSAgSWYgTSBpcyBzZWxlY3Rl
ZCB0aGUgbW9kdWxlIHdpbGwgYmUgY2FsbGVkIGd1ZF9kcm0uCisKK2NvbmZpZyBEUk1fR1VEX0dB
REdFVAorCXRyaXN0YXRlCisJZGVwZW5kcyBvbiBEUk0KKwlzZWxlY3QgTFo0X0RFQ09NUFJFU1MK
KwlzZWxlY3QgQkFDS0xJR0hUX0NMQVNTX0RFVklDRQpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL2d1ZC9NYWtlZmlsZSBiL2RyaXZlcnMvZ3B1L2RybS9ndWQvTWFrZWZpbGUKaW5kZXggNzNl
ZDdlZjNkYTk0Li5mYjVjZmJkOTNkMGYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9ndWQv
TWFrZWZpbGUKKysrIGIvZHJpdmVycy9ncHUvZHJtL2d1ZC9NYWtlZmlsZQpAQCAtMiwzICsyLDQg
QEAKIAogZ3VkX2RybS1vYmpzCQkJOj0gZ3VkX2RybV9kcnYubyBndWRfZHJtX3BpcGUubyBndWRf
ZHJtX2Nvbm5lY3Rvci5vCiBvYmotJChDT05GSUdfRFJNX0dVRCkJCSs9IGd1ZF9kcm0ubworb2Jq
LSQoQ09ORklHX0RSTV9HVURfR0FER0VUKQkrPSBndWRfZHJtX2dhZGdldC5vCmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vZ3VkL2d1ZF9kcm1fZ2FkZ2V0LmMgYi9kcml2ZXJzL2dwdS9kcm0v
Z3VkL2d1ZF9kcm1fZ2FkZ2V0LmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAw
MDAwLi42YmM0Mzg2MzRlZDMKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vZ3Vk
L2d1ZF9kcm1fZ2FkZ2V0LmMKQEAgLTAsMCArMSwxMTY1IEBACisvLyBTUERYLUxpY2Vuc2UtSWRl
bnRpZmllcjogR1BMLTIuMAorLyoKKyAqIENvcHlyaWdodCAyMDIwIE5vcmFsZiBUcsO4bm5lcwor
ICovCisKKyNpbmNsdWRlIDxsaW51eC9iYWNrbGlnaHQuaD4KKyNpbmNsdWRlIDxsaW51eC9kZWxh
eS5oPgorI2luY2x1ZGUgPGxpbnV4L2x6NC5oPgorI2luY2x1ZGUgPGxpbnV4L21vZHVsZS5oPgor
I2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxsaW51eC9zcGlubG9jay5oPgorI2lu
Y2x1ZGUgPGxpbnV4L3N0cmluZy5oPgorCisjaW5jbHVkZSA8ZHJtL2RybV9jbGllbnQuaD4KKyNp
bmNsdWRlIDxkcm0vZHJtX2Nvbm5lY3Rvci5oPgorI2luY2x1ZGUgPGRybS9kcm1fY3J0Yy5oPgor
I2luY2x1ZGUgPGRybS9kcm1fZm91cmNjLmg+CisjaW5jbHVkZSA8ZHJtL2RybV9tb2RlX29iamVj
dC5oPgorI2luY2x1ZGUgPGRybS9kcm1fcGxhbmUuaD4KKyNpbmNsdWRlIDxkcm0vZHJtX3JlY3Qu
aD4KKyNpbmNsdWRlIDxkcm0vZ3VkX2RybS5oPgorCisjaW5jbHVkZSAiZ3VkX2RybV9pbnRlcm5h
bC5oIgorCisvKgorICogQ29uY3VycmVuY3k6CisgKiBDYWxscyBpbnRvIHRoaXMgbW9kdWxlIGZy
b20gZl9ndWRfZHJtIGFyZSBzZXJpYWxpemVkIGFuZCBydW4gaW4gcHJvY2VzcworICogY29udGV4
dCBleGNlcHQgZ3VkX2RybV9nYWRnZXRfY3RybF9nZXQoKSB3aGljaCBpcyBydW4gaW4gaW50ZXJy
dXB0IGNvbnRleHQuCisgKgorICogVGVybWluYXRpb246CisgKiBBIERSTSBjbGllbnQgY2FuIG5v
dCByZWxlYXNlIGl0c2VsZiwgb25seSB0aGUgRFJNIGRyaXZlciB3aGljaCByZXNvdXJjZXMgdGhl
CisgKiBjbGllbnQgdXNlcyBjYW4gZG8gdGhhdC4KKyAqIFRoaXMgbWVhbnMgdGhhdCB0aGVyZSBh
cmUgMiBwYXRocyB0byBzdG9wIHRoZSBnYWRnZXQgZnVuY3Rpb246CisgKiAtIFVucmVnaXN0ZXJp
bmcgdGhlIERSTSBkcml2ZXIgKG1vZHVsZSB1bmxvYWQpCisgKiAtIERpc2FibGluZyB0aGUgVVNC
IGdhZGdldCAoY29uZmlnZnMgdW5iaW5kKQorICoKKyAqIEEgdXNlIGNvdW50ZXIgcHJvdGVjdHMg
dGhlIGdhZGdldCBzaG91bGQgdGhlIGNsaWVudCBnbyBhd2F5LiBBIGtyZWYgaXMgdXNlZAorICog
dG8gY29udHJvbCB0aGUgcmVsZWFzZSBvZiB0aGUgZ3VkX2RybV9nYWRnZXQgc3RydWN0dXJlIHNo
YXJlZCBieSB0aGUgMiBhY3RvcnMuCisgKgorICogQmFja2xpZ2h0OgorICogSWYgdGhlcmUncyBh
IGJhY2tsaWdodCBkZXZpY2UgaXQncyBhdHRhY2hlZCB0byB0aGUgZmlyc3QgY29ubmVjdG9yLgor
ICovCisKK3N0cnVjdCBndWRfZHJtX2dhZGdldF9jb25uZWN0b3IgeworCXN0cnVjdCBkcm1fY29u
bmVjdG9yICpjb25uZWN0b3I7CisKKwljb25zdCBzdHJ1Y3QgZ3VkX2RybV9wcm9wZXJ0eSAqcHJv
cGVydGllczsKKwl1bnNpZ25lZCBpbnQgbnVtX3Byb3BlcnRpZXM7CisJY29uc3QgY2hhciAqdHZf
bW9kZV9lbnVtX25hbWVzOworCXVuc2lnbmVkIGludCBudW1fdHZfbW9kZV9lbnVtX25hbWVzOwor
CXN0cnVjdCBiYWNrbGlnaHRfZGV2aWNlICpiYWNrbGlnaHQ7CisKKwlzcGlubG9ja190IGxvY2s7
IC8qIFByb3RlY3RzIHRoZSBmb2xsb3dpbmcgbWVtYmVyczogKi8KKwllbnVtIGRybV9jb25uZWN0
b3Jfc3RhdHVzIHN0YXR1czsKKwl1bnNpZ25lZCBpbnQgd2lkdGhfbW07CisJdW5zaWduZWQgaW50
IGhlaWdodF9tbTsKKwlzdHJ1Y3QgZ3VkX2RybV9kaXNwbGF5X21vZGUgKm1vZGVzOworCXVuc2ln
bmVkIGludCBudW1fbW9kZXM7CisJdm9pZCAqZWRpZDsKKwlzaXplX3QgZWRpZF9sZW47CisJYm9v
bCBjaGFuZ2VkOworfTsKKworc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0IHsKKwlzdHJ1Y3Qga3JlZiBy
ZWZjb3VudDsKKwlyZWZjb3VudF90IHVzZWNudDsKKwlzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgY2xp
ZW50OworCXN0cnVjdCBiYWNrbGlnaHRfZGV2aWNlICpiYWNrbGlnaHQ7CisKKwljb25zdCB1MzIg
KmZvcm1hdHM7CisJdW5zaWduZWQgaW50IGZvcm1hdF9jb3VudDsKKworCWNvbnN0IHN0cnVjdCBn
dWRfZHJtX3Byb3BlcnR5ICpwcm9wZXJ0aWVzOworCXVuc2lnbmVkIGludCBudW1fcHJvcGVydGll
czsKKworCXN0cnVjdCBndWRfZHJtX2dhZGdldF9jb25uZWN0b3IgKmNvbm5lY3RvcnM7CisJdW5z
aWduZWQgaW50IGNvbm5lY3Rvcl9jb3VudDsKKworCXN0cnVjdCBkcm1fcmVjdCBzZXRfYnVmZmVy
X3JlY3Q7CisJdTMyIHNldF9idWZmZXJfbGVuZ3RoOworCXU4IHNldF9idWZmZXJfY29tcHJlc3Np
b247CisJdTMyIHNldF9idWZmZXJfY29tcHJlc3NlZF9sZW5ndGg7CisKKwlzdHJ1Y3QgZHJtX2Ns
aWVudF9idWZmZXIgKmJ1ZmZlcjsKKwlzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlcl9j
aGVjazsKKwl1OCBicmlnaHRuZXNzOworCWJvb2wgY2hlY2tfb2s7CisKKwlzaXplX3QgbWF4X2J1
ZmZlcl9zaXplOworCXZvaWQgKndvcmtfYnVmOworfTsKKworc3RhdGljIGludCBndWRfZHJtX2dh
ZGdldF9wcm9iZV9jb25uZWN0b3Ioc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0X2Nvbm5lY3RvciAqZ2Nv
bm4pCit7CisJc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvciA9IGdjb25uLT5jb25uZWN0
b3I7CisJc3RydWN0IGd1ZF9kcm1fZGlzcGxheV9tb2RlICptb2RlcyA9IE5VTEw7CisJc3RydWN0
IGRybV9kZXZpY2UgKmRybSA9IGNvbm5lY3Rvci0+ZGV2OworCXN0cnVjdCBkcm1fZGlzcGxheV9t
b2RlICptb2RlOworCXZvaWQgKmVkaWRfZGF0YSwgKmVkaWQgPSBOVUxMOworCXVuc2lnbmVkIGlu
dCBudW1fbW9kZXMgPSAwOworCXNpemVfdCBlZGlkX2xlbiA9IDA7CisJdW5zaWduZWQgbG9uZyBm
bGFnczsKKwl1bnNpZ25lZCBpbnQgaSA9IDA7CisJaW50IHJldCA9IDA7CisKKwltdXRleF9sb2Nr
KCZkcm0tPm1vZGVfY29uZmlnLm11dGV4KTsKKworCWNvbm5lY3Rvci0+ZnVuY3MtPmZpbGxfbW9k
ZXMoY29ubmVjdG9yLAorCQkJCSAgICAgZHJtLT5tb2RlX2NvbmZpZy5tYXhfd2lkdGgsCisJCQkJ
ICAgICBkcm0tPm1vZGVfY29uZmlnLm1heF9oZWlnaHQpOworCisJbGlzdF9mb3JfZWFjaF9lbnRy
eShtb2RlLCAmY29ubmVjdG9yLT5tb2RlcywgaGVhZCkKKwkJbnVtX21vZGVzKys7CisKKwlpZiAo
IW51bV9tb2RlcykKKwkJZ290byB1cGRhdGU7CisKKwltb2RlcyA9IGttYWxsb2NfYXJyYXkobnVt
X21vZGVzLCBzaXplb2YoKm1vZGVzKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFtb2RlcykgeworCQly
ZXQgPSAtRU5PTUVNOworCQludW1fbW9kZXMgPSAwOworCQlnb3RvIHVwZGF0ZTsKKwl9CisKKwls
aXN0X2Zvcl9lYWNoX2VudHJ5KG1vZGUsICZjb25uZWN0b3ItPm1vZGVzLCBoZWFkKQorCQlndWRf
ZHJtX2Zyb21fZGlzcGxheV9tb2RlKCZtb2Rlc1tpKytdLCBtb2RlKTsKKworCWlmICghY29ubmVj
dG9yLT5lZGlkX2Jsb2JfcHRyKQorCQlnb3RvIHVwZGF0ZTsKKworCWVkaWRfZGF0YSA9IGNvbm5l
Y3Rvci0+ZWRpZF9ibG9iX3B0ci0+ZGF0YTsKKwllZGlkX2xlbiA9IGNvbm5lY3Rvci0+ZWRpZF9i
bG9iX3B0ci0+bGVuZ3RoOworCWlmICghZWRpZF9kYXRhIHx8ICFlZGlkX2xlbikgeworCQllZGlk
X2xlbiA9IDA7CisJCWdvdG8gdXBkYXRlOworCX0KKworCWVkaWQgPSBrbWVtZHVwKGVkaWRfZGF0
YSwgZWRpZF9sZW4sIEdGUF9LRVJORUwpOworCWlmICghZWRpZCkgeworCQlyZXQgPSAtRU5PTUVN
OworCQllZGlkX2xlbiA9IDA7CisJfQorCit1cGRhdGU6CisJc3Bpbl9sb2NrX2lycXNhdmUoJmdj
b25uLT5sb2NrLCBmbGFncyk7CisJaWYgKGdjb25uLT5zdGF0dXMgIT0gY29ubmVjdG9yLT5zdGF0
dXMgfHwgZ2Nvbm4tPm51bV9tb2RlcyAhPSBudW1fbW9kZXMgfHwKKwkgICAgZ2Nvbm4tPmVkaWRf
bGVuICE9IGVkaWRfbGVuIHx8CisJICAgIChnY29ubi0+bW9kZXMgJiYgbW9kZXMgJiYgbWVtY21w
KGdjb25uLT5tb2RlcywgbW9kZXMsIG51bV9tb2RlcyAqIHNpemVvZigqbW9kZXMpKSkgfHwKKwkg
ICAgKGdjb25uLT5lZGlkICYmIGVkaWQgJiYgbWVtY21wKGdjb25uLT5lZGlkLCBlZGlkLCBlZGlk
X2xlbikpKQorCQlnY29ubi0+Y2hhbmdlZCA9IHRydWU7CisJc3dhcChnY29ubi0+bW9kZXMsIG1v
ZGVzKTsKKwlnY29ubi0+bnVtX21vZGVzID0gbnVtX21vZGVzOworCXN3YXAoZ2Nvbm4tPmVkaWQs
IGVkaWQpOworCWdjb25uLT5lZGlkX2xlbiA9IGVkaWRfbGVuOworCWdjb25uLT53aWR0aF9tbSA9
IGNvbm5lY3Rvci0+ZGlzcGxheV9pbmZvLndpZHRoX21tOworCWdjb25uLT5oZWlnaHRfbW0gPSBj
b25uZWN0b3ItPmRpc3BsYXlfaW5mby5oZWlnaHRfbW07CisJZ2Nvbm4tPnN0YXR1cyA9IGNvbm5l
Y3Rvci0+c3RhdHVzOworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJmdjb25uLT5sb2NrLCBmbGFn
cyk7CisKKwltdXRleF91bmxvY2soJmRybS0+bW9kZV9jb25maWcubXV0ZXgpOworCisJa2ZyZWUo
ZWRpZCk7CisJa2ZyZWUobW9kZXMpOworCisJcmV0dXJuIHJldDsKK30KKworc3RhdGljIHZvaWQg
Z3VkX2RybV9nYWRnZXRfcHJvYmVfY29ubmVjdG9ycyhzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdk
ZykKK3sKKwl1bnNpZ25lZCBpbnQgaTsKKworCWZvciAoaSA9IDA7IGkgPCBnZGctPmNvbm5lY3Rv
cl9jb3VudDsgaSsrKQorCQlndWRfZHJtX2dhZGdldF9wcm9iZV9jb25uZWN0b3IoJmdkZy0+Y29u
bmVjdG9yc1tpXSk7Cit9CisKK3N0YXRpYyBib29sIGd1ZF9kcm1fZ2FkZ2V0X2NoZWNrX2J1ZmZl
cihzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywKKwkJCQkJc3RydWN0IGRybV9jbGllbnRfYnVm
ZmVyICpidWZmZXIsCisJCQkJCXN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICptb2RlLAorCQkJCQl1
MzIgZm9ybWF0KQoreworCXN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiOworCisJaWYgKCFidWZm
ZXIpCisJCXJldHVybiBmYWxzZTsKKworCWZiID0gYnVmZmVyLT5mYjsKKworCXJldHVybiBmYi0+
Zm9ybWF0LT5mb3JtYXQgPT0gZm9ybWF0ICYmCisJICAgICAgIGZiLT53aWR0aCA9PSBtb2RlLT5o
ZGlzcGxheSAmJiBmYi0+aGVpZ2h0ID09IG1vZGUtPnZkaXNwbGF5OworfQorCitzdGF0aWMgYm9v
bCBndWRfZHJtX2dhZGdldF9zZXRfY29ubmVjdG9yX3Byb3BlcnR5KHN0cnVjdCBkcm1fY2xpZW50
X2RldiAqY2xpZW50LAorCQkJCQkJICBzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqY29ubmVjdG9yLAor
CQkJCQkJICB1MTYgcHJvcCwgdTY0IHZhbCwgaW50ICpyZXQpCit7CisJc3RydWN0IGRybV9tb2Rl
X2NvbmZpZyAqY29uZmlnID0gJmNvbm5lY3Rvci0+ZGV2LT5tb2RlX2NvbmZpZzsKKwlzdHJ1Y3Qg
ZHJtX3Byb3BlcnR5ICpwcm9wZXJ0eTsKKworCXN3aXRjaCAocHJvcCkgeworCWNhc2UgR1VEX0RS
TV9QUk9QRVJUWV9UVl9TRUxFQ1RfU1VCQ09OTkVDVE9SOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+
dHZfc2VsZWN0X3N1YmNvbm5lY3Rvcl9wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBHVURfRFJN
X1BST1BFUlRZX1RWX0xFRlRfTUFSR0lOOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+dHZfbGVmdF9t
YXJnaW5fcHJvcGVydHk7CisJCWJyZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9SSUdI
VF9NQVJHSU46CisJCXByb3BlcnR5ID0gY29uZmlnLT50dl9yaWdodF9tYXJnaW5fcHJvcGVydHk7
CisJCWJyZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9UT1BfTUFSR0lOOgorCQlwcm9w
ZXJ0eSA9IGNvbmZpZy0+dHZfdG9wX21hcmdpbl9wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBH
VURfRFJNX1BST1BFUlRZX1RWX0JPVFRPTV9NQVJHSU46CisJCXByb3BlcnR5ID0gY29uZmlnLT50
dl9ib3R0b21fbWFyZ2luX3Byb3BlcnR5OworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fUFJPUEVS
VFlfVFZfTU9ERToKKwkJcHJvcGVydHkgPSBjb25maWctPnR2X21vZGVfcHJvcGVydHk7CisJCWJy
ZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9CUklHSFRORVNTOgorCQlwcm9wZXJ0eSA9
IGNvbmZpZy0+dHZfYnJpZ2h0bmVzc19wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBHVURfRFJN
X1BST1BFUlRZX1RWX0NPTlRSQVNUOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+dHZfY29udHJhc3Rf
cHJvcGVydHk7CisJCWJyZWFrOworCWNhc2UgR1VEX0RSTV9QUk9QRVJUWV9UVl9GTElDS0VSX1JF
RFVDVElPTjoKKwkJcHJvcGVydHkgPSBjb25maWctPnR2X2ZsaWNrZXJfcmVkdWN0aW9uX3Byb3Bl
cnR5OworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fUFJPUEVSVFlfVFZfT1ZFUlNDQU46CisJCXBy
b3BlcnR5ID0gY29uZmlnLT50dl9vdmVyc2Nhbl9wcm9wZXJ0eTsKKwkJYnJlYWs7CisJY2FzZSBH
VURfRFJNX1BST1BFUlRZX1RWX1NBVFVSQVRJT046CisJCXByb3BlcnR5ID0gY29uZmlnLT50dl9z
YXR1cmF0aW9uX3Byb3BlcnR5OworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fUFJPUEVSVFlfVFZf
SFVFOgorCQlwcm9wZXJ0eSA9IGNvbmZpZy0+dHZfaHVlX3Byb3BlcnR5OworCQlicmVhazsKKwlk
ZWZhdWx0OgorCQlyZXR1cm4gZmFsc2U7CisJfQorCisJKnJldCA9IGRybV9jbGllbnRfbW9kZXNl
dF9zZXRfcHJvcGVydHkoY2xpZW50LCAmY29ubmVjdG9yLT5iYXNlLCBwcm9wZXJ0eSwgdmFsKTsK
KworCXJldHVybiB0cnVlOworfQorCitzdGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2NoZWNrKHN0
cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnLCBzdHJ1Y3QgZ3VkX2RybV9yZXFfc2V0X3N0YXRlICpy
ZXEsCisJCQkJc2l6ZV90IHNpemUpCit7CisJc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQg
PSAmZ2RnLT5jbGllbnQ7CisJdTMyIGZvcm1hdCA9IGxlMzJfdG9fY3B1KHJlcS0+Zm9ybWF0KTsK
KwlzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlcjsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3Rv
ciAqY29ubmVjdG9yOworCXN0cnVjdCBkcm1fZGlzcGxheV9tb2RlIG1vZGU7CisJdW5zaWduZWQg
aW50IGk7CisJdm9pZCAqdmFkZHI7CisJaW50IHJldDsKKworCWlmIChzaXplIDwgc2l6ZW9mKHN0
cnVjdCBndWRfZHJtX3JlcV9zZXRfc3RhdGUpKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCWlmIChz
aXplICE9IHN0cnVjdF9zaXplKHJlcSwgcHJvcGVydGllcywgcmVxLT5udW1fcHJvcGVydGllcykp
CisJCXJldHVybiAtRUlOVkFMOworCisJbWVtc2V0KCZtb2RlLCAwLCBzaXplb2YobW9kZSkpOwor
CWd1ZF9kcm1fdG9fZGlzcGxheV9tb2RlKCZtb2RlLCAmcmVxLT5tb2RlKTsKKworCWdkZy0+Y2hl
Y2tfb2sgPSBmYWxzZTsKKworCWlmICghbW9kZS5oZGlzcGxheSB8fCAhZm9ybWF0KQorCQlyZXR1
cm4gLUVJTlZBTDsKKworCWlmIChyZXEtPmNvbm5lY3RvciA+PSBnZGctPmNvbm5lY3Rvcl9jb3Vu
dCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwljb25uZWN0b3IgPSBnZGctPmNvbm5lY3RvcnNbcmVx
LT5jb25uZWN0b3JdLmNvbm5lY3RvcjsKKworCWlmIChnZGctPmJ1ZmZlcl9jaGVjaykgeworCQlk
cm1fY2xpZW50X2ZyYW1lYnVmZmVyX2RlbGV0ZShnZGctPmJ1ZmZlcl9jaGVjayk7CisJCWdkZy0+
YnVmZmVyX2NoZWNrID0gTlVMTDsKKwl9CisKKwlpZiAoIWd1ZF9kcm1fZ2FkZ2V0X2NoZWNrX2J1
ZmZlcihnZGcsIGdkZy0+YnVmZmVyLCAmbW9kZSwgZm9ybWF0KSkgeworCQlidWZmZXIgPSBkcm1f
Y2xpZW50X2ZyYW1lYnVmZmVyX2NyZWF0ZShjbGllbnQsIG1vZGUuaGRpc3BsYXksIG1vZGUudmRp
c3BsYXksCisJCQkJCQkgICAgICAgZm9ybWF0KTsKKwkJaWYgKElTX0VSUihidWZmZXIpKQorCQkJ
cmV0dXJuIFBUUl9FUlIoYnVmZmVyKTsKKworCQl2YWRkciA9IGRybV9jbGllbnRfYnVmZmVyX3Zt
YXAoYnVmZmVyKTsKKwkJaWYgKElTX0VSUih2YWRkcikpIHsKKwkJCWRybV9jbGllbnRfZnJhbWVi
dWZmZXJfZGVsZXRlKGJ1ZmZlcik7CisJCQlyZXR1cm4gUFRSX0VSUih2YWRkcik7CisJCX0KKwor
CQlnZGctPmJ1ZmZlcl9jaGVjayA9IGJ1ZmZlcjsKKwl9IGVsc2UgeworCQlidWZmZXIgPSBnZGct
PmJ1ZmZlcjsKKwl9CisKKwlyZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfc2V0KGNsaWVudCwgY29u
bmVjdG9yLCAmbW9kZSwgYnVmZmVyLT5mYik7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKwor
CWZvciAoaSA9IDA7IGkgPCByZXEtPm51bV9wcm9wZXJ0aWVzOyBpKyspIHsKKwkJdTE2IHByb3Ag
PSBsZTE2X3RvX2NwdShyZXEtPnByb3BlcnRpZXNbaV0ucHJvcCk7CisJCXU2NCB2YWwgPSBsZTY0
X3RvX2NwdShyZXEtPnByb3BlcnRpZXNbaV0udmFsKTsKKworCQlpZiAoZ3VkX2RybV9nYWRnZXRf
c2V0X2Nvbm5lY3Rvcl9wcm9wZXJ0eShjbGllbnQsIGNvbm5lY3RvciwgcHJvcCwgdmFsLCAmcmV0
KSkgeworCQkJaWYgKHJldCkKKwkJCQlyZXR1cm4gcmV0OworCQkJY29udGludWU7CisJCX0KKwor
CQlzd2l0Y2ggKHByb3ApIHsKKwkJY2FzZSBHVURfRFJNX1BST1BFUlRZX0JBQ0tMSUdIVF9CUklH
SFRORVNTOgorCQkJaWYgKHZhbCA+IDEwMCkKKwkJCQlyZXR1cm4gLUVJTlZBTDsKKwkJCWdkZy0+
YnJpZ2h0bmVzcyA9IHZhbDsKKwkJCWJyZWFrOworCQljYXNlIEdVRF9EUk1fUFJPUEVSVFlfUk9U
QVRJT046CisJCQlyZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfc2V0X3JvdGF0aW9uKGNsaWVudCwg
dmFsKTsKKwkJCWJyZWFrOworCQlkZWZhdWx0OgorCQkJcHJfZXJyKCIlczogVW5rbm93biBwcm9w
ZXJ0eTogJXVcbiIsIF9fZnVuY19fLCBwcm9wKTsKKwkJCWNvbnRpbnVlOworCQl9CisKKwkJaWYg
KHJldCkKKwkJCXJldHVybiByZXQ7CisJfQorCisJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2No
ZWNrKCZnZGctPmNsaWVudCk7CisJaWYgKHJldCkKKwkJcmV0dXJuIHJldDsKKworCWdkZy0+Y2hl
Y2tfb2sgPSB0cnVlOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgZ3VkX2RybV9nYWRn
ZXRfY29tbWl0KHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnKQoreworCWludCByZXQ7CisKKwlp
ZiAoIWdkZy0+Y2hlY2tfb2spCisJCXJldHVybiAtRUlOVkFMOworCisJaWYgKGdkZy0+YmFja2xp
Z2h0KSB7CisJCWludCB2YWwsIG1heF9icmlnaHRuZXNzID0gZ2RnLT5iYWNrbGlnaHQtPnByb3Bz
Lm1heF9icmlnaHRuZXNzOworCisJCXZhbCA9IERJVjY0X1U2NF9ST1VORF9VUChnZGctPmJyaWdo
dG5lc3MgKiBtYXhfYnJpZ2h0bmVzcywgMTAwKTsKKwkJcmV0ID0gYmFja2xpZ2h0X2RldmljZV9z
ZXRfYnJpZ2h0bmVzcyhnZGctPmJhY2tsaWdodCwgdmFsKTsKKwkJaWYgKHJldCkKKwkJCXJldHVy
biByZXQ7CisJfQorCisJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdCgmZ2RnLT5jbGll
bnQpOworCWlmIChyZXQpCisJCXJldHVybiByZXQ7CisKKwlpZiAoZ2RnLT5idWZmZXJfY2hlY2sp
IHsKKwkJZHJtX2NsaWVudF9mcmFtZWJ1ZmZlcl9kZWxldGUoZ2RnLT5idWZmZXIpOworCQlnZGct
PmJ1ZmZlciA9IGdkZy0+YnVmZmVyX2NoZWNrOworCQlnZGctPmJ1ZmZlcl9jaGVjayA9IE5VTEw7
CisJfQorCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBzaXplX3QgZ3VkX2RybV9nYWRnZXRfd3Jp
dGVfYnVmZmVyX21lbWNweShzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlciwKKwkJCQkJ
CSBjb25zdCB2b2lkICpzcmMsIHNpemVfdCBsZW4sCisJCQkJCQkgc3RydWN0IGRybV9yZWN0ICpy
ZWN0KQoreworCXVuc2lnbmVkIGludCBjcHAgPSBidWZmZXItPmZiLT5mb3JtYXQtPmNwcFswXTsK
KwlzaXplX3QgZHN0X3BpdGNoID0gYnVmZmVyLT5mYi0+cGl0Y2hlc1swXTsKKwlzaXplX3Qgc3Jj
X3BpdGNoID0gZHJtX3JlY3Rfd2lkdGgocmVjdCkgKiBjcHA7CisJdW5zaWduZWQgaW50IHk7CisJ
dm9pZCAqZHN0OworCisJLyogR2V0IHRoZSBhZGRyZXNzLCBpdCdzIGFscmVhZHkgbWFwcGVkICov
CisJZHN0ID0gZHJtX2NsaWVudF9idWZmZXJfdm1hcChidWZmZXIpOworCWRzdCArPSByZWN0LT55
MSAqIGRzdF9waXRjaDsKKwlkc3QgKz0gcmVjdC0+eDEgKiBjcHA7CisKKwlmb3IgKHkgPSAwOyB5
IDwgZHJtX3JlY3RfaGVpZ2h0KHJlY3QpICYmIGxlbjsgeSsrKSB7CisJCXNyY19waXRjaCA9IG1p
bihzcmNfcGl0Y2gsIGxlbik7CisJCW1lbWNweShkc3QsIHNyYywgc3JjX3BpdGNoKTsKKwkJc3Jj
ICs9IHNyY19waXRjaDsKKwkJZHN0ICs9IGRzdF9waXRjaDsKKwkJbGVuIC09IHNyY19waXRjaDsK
Kwl9CisKKwlyZXR1cm4gbGVuOworfQorCitzdGF0aWMgYm9vbCBndWRfZHJtX2dhZGdldF9jaGVj
a19yZWN0KHN0cnVjdCBkcm1fY2xpZW50X2J1ZmZlciAqYnVmZmVyLCBzdHJ1Y3QgZHJtX3JlY3Qg
KnJlY3QpCit7CisJcmV0dXJuIGJ1ZmZlci0+ZmIgJiYgcmVjdC0+eDEgPCByZWN0LT54MiAmJiBy
ZWN0LT55MSA8IHJlY3QtPnkyICYmCisJICAgICAgIHJlY3QtPngyIDw9IGJ1ZmZlci0+ZmItPndp
ZHRoICYmIHJlY3QtPnkyIDw9IGJ1ZmZlci0+ZmItPmhlaWdodDsKK30KKworaW50IGd1ZF9kcm1f
Z2FkZ2V0X3dyaXRlX2J1ZmZlcihzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywgY29uc3Qgdm9p
ZCAqYnVmLCBzaXplX3QgbGVuKQoreworCXN0cnVjdCBkcm1fY2xpZW50X2J1ZmZlciAqYnVmZmVy
ID0gZ2RnLT5idWZmZXIgPyBnZGctPmJ1ZmZlciA6IGdkZy0+YnVmZmVyX2NoZWNrOworCXN0cnVj
dCBkcm1fcmVjdCAqcmVjdCA9ICZnZGctPnNldF9idWZmZXJfcmVjdDsKKwl1OCBjb21wcmVzc2lv
biA9IGdkZy0+c2V0X2J1ZmZlcl9jb21wcmVzc2lvbjsKKwlzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVy
ICpmYjsKKwlzaXplX3QgcmVtYWluOworCWludCByZXQ7CisKKwlwcl9kZWJ1ZygiJXM6IGxlbj0l
enUgY29tcHJlc3Npb249MHgleFxuIiwgX19mdW5jX18sIGxlbiwgY29tcHJlc3Npb24pOworCisJ
aWYgKFdBUk5fT05fT05DRSghYnVmZmVyKSkKKwkJcmV0dXJuIC1FTk9NRU07CisKKwlpZiAoIWd1
ZF9kcm1fZ2FkZ2V0X2NoZWNrX3JlY3QoYnVmZmVyLCByZWN0KSkgeworCQlwcl9lcnIoIiVzOiBS
ZWN0YW5nbGUgZG9lc24ndCBmaXRcbiIsIF9fZnVuY19fKTsKKwkJcmV0dXJuIC1FSU5WQUw7CisJ
fQorCisJZmIgPSBidWZmZXItPmZiOworCisJaWYgKGNvbXByZXNzaW9uICYgR1VEX0RSTV9DT01Q
UkVTU0lPTl9MWjQpIHsKKwkJaWYgKGxlbiAhPSBnZGctPnNldF9idWZmZXJfY29tcHJlc3NlZF9s
ZW5ndGgpIHsKKwkJCXByX2VycigiJXM6IEJ1ZmZlciBjb21wcmVzc2VkIGxlbiBkaWZmZXJzOiAl
enUgIT0gJXp1XG4iLAorCQkJICAgICAgIF9fZnVuY19fLCBsZW4sIGdkZy0+c2V0X2J1ZmZlcl9j
b21wcmVzc2VkX2xlbmd0aCk7CisJCQlyZXR1cm4gLUVJTlZBTDsKKwkJfQorCisJCXJldCA9IExa
NF9kZWNvbXByZXNzX3NhZmUoYnVmLCBnZGctPndvcmtfYnVmLCBsZW4sIGdkZy0+bWF4X2J1ZmZl
cl9zaXplKTsKKwkJaWYgKHJldCA8IDApIHsKKwkJCXByX2VycigiJXM6IEZhaWxlZCB0byBkZWNv
bXByZXNzIGJ1ZmZlclxuIiwgX19mdW5jX18pOworCQkJcmV0dXJuIC1FSU87CisJCX0KKworCQli
dWYgPSBnZGctPndvcmtfYnVmOworCQlsZW4gPSByZXQ7CisJfQorCisJaWYgKGxlbiAhPSBnZGct
PnNldF9idWZmZXJfbGVuZ3RoKSB7CisJCXByX2VycigiJXM6IEJ1ZmZlciBsZW4gZGlmZmVyczog
JXp1ICE9ICV6dVxuIiwKKwkJICAgICAgIF9fZnVuY19fLCBsZW4sIGdkZy0+c2V0X2J1ZmZlcl9s
ZW5ndGgpOworCQlyZXR1cm4gLUVJTlZBTDsKKwl9CisKKwlpZiAobGVuID4gKGRybV9yZWN0X3dp
ZHRoKHJlY3QpICogZHJtX3JlY3RfaGVpZ2h0KHJlY3QpICogZmItPmZvcm1hdC0+Y3BwWzBdKSkg
eworCQlwcl9lcnIoIiVzOiBCdWZmZXIgaXMgdG9vIGJpZyBmb3IgcmVjdGFuZ2xlXG4iLCBfX2Z1
bmNfXyk7CisJCXJldHVybiAtRUlOVkFMOworCX0KKworCXJlbWFpbiA9IGd1ZF9kcm1fZ2FkZ2V0
X3dyaXRlX2J1ZmZlcl9tZW1jcHkoYnVmZmVyLCBidWYsIGxlbiwgcmVjdCk7CisJaWYgKHJlbWFp
bikgeworCQlwcl9lcnIoIiVzOiBGYWlsZWQgdG8gd3JpdGUgYnVmZmVyOiByZW1haW49JXp1XG4i
LCBfX2Z1bmNfXywgcmVtYWluKTsKKwkJcmV0dXJuIC1FSU87CisJfQorCisJcmV0dXJuIGRybV9j
bGllbnRfZnJhbWVidWZmZXJfZmx1c2goYnVmZmVyLCByZWN0KTsKK30KK0VYUE9SVF9TWU1CT0wo
Z3VkX2RybV9nYWRnZXRfd3JpdGVfYnVmZmVyKTsKKworaW50IGd1ZF9kcm1fZ2FkZ2V0X3NldF9i
dWZmZXIoc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcsIHN0cnVjdCBndWRfZHJtX3JlcV9zZXRf
YnVmZmVyICpyZXEpCit7CisJdTMyIGNvbXByZXNzZWRfbGVuZ3RoID0gbGUzMl90b19jcHUocmVx
LT5jb21wcmVzc2VkX2xlbmd0aCk7CisJdTMyIGxlbmd0aCA9IGxlMzJfdG9fY3B1KHJlcS0+bGVu
Z3RoKTsKKwlzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlcjsKKwlzdHJ1Y3QgZHJtX3Jl
Y3QgcmVjdDsKKwlpbnQgcmV0ID0gMDsKKworCWlmICghcmVmY291bnRfaW5jX25vdF96ZXJvKCZn
ZGctPnVzZWNudCkpCisJCXJldHVybiAtRU5PREVWOworCisJYnVmZmVyID0gZ2RnLT5idWZmZXIg
PyBnZGctPmJ1ZmZlciA6IGdkZy0+YnVmZmVyX2NoZWNrOworCWlmICghYnVmZmVyKSB7CisJCXJl
dCA9IC1FTk9FTlQ7CisJCWdvdG8gb3V0OworCX0KKworCWRybV9yZWN0X2luaXQoJnJlY3QsIGxl
MzJfdG9fY3B1KHJlcS0+eCksIGxlMzJfdG9fY3B1KHJlcS0+eSksCisJCSAgICAgIGxlMzJfdG9f
Y3B1KHJlcS0+d2lkdGgpLCBsZTMyX3RvX2NwdShyZXEtPmhlaWdodCkpOworCisJcHJfZGVidWco
IiVzOiAiIERSTV9SRUNUX0ZNVCAiXG4iLCBfX2Z1bmNfXywgRFJNX1JFQ1RfQVJHKCZyZWN0KSk7
CisKKwlpZiAoIWd1ZF9kcm1fZ2FkZ2V0X2NoZWNrX3JlY3QoYnVmZmVyLCAmcmVjdCkpIHsKKwkJ
cmV0ID0gLUVJTlZBTDsKKwkJZ290byBvdXQ7CisJfQorCisJaWYgKHJlcS0+Y29tcHJlc3Npb24g
JiB+R1VEX0RSTV9DT01QUkVTU0lPTl9MWjQpIHsKKwkJcmV0ID0gLUVJTlZBTDsKKwkJZ290byBv
dXQ7CisJfQorCisJZ2RnLT5zZXRfYnVmZmVyX3JlY3QgPSByZWN0OworCWdkZy0+c2V0X2J1ZmZl
cl9sZW5ndGggPSBsZW5ndGg7CisKKwlpZiAocmVxLT5jb21wcmVzc2lvbikgeworCQlpZiAoIWNv
bXByZXNzZWRfbGVuZ3RoKSB7CisJCQlyZXQgPSAtRUlOVkFMOworCQkJZ290byBvdXQ7CisJCX0K
KwkJZ2RnLT5zZXRfYnVmZmVyX2NvbXByZXNzaW9uID0gcmVxLT5jb21wcmVzc2lvbjsKKwkJZ2Rn
LT5zZXRfYnVmZmVyX2NvbXByZXNzZWRfbGVuZ3RoID0gY29tcHJlc3NlZF9sZW5ndGg7CisJCWxl
bmd0aCA9IGNvbXByZXNzZWRfbGVuZ3RoOworCX0gZWxzZSB7CisJCWdkZy0+c2V0X2J1ZmZlcl9j
b21wcmVzc2lvbiA9IDA7CisJCWdkZy0+c2V0X2J1ZmZlcl9jb21wcmVzc2VkX2xlbmd0aCA9IDA7
CisJfQorb3V0OgorCXJlZmNvdW50X2RlYygmZ2RnLT51c2VjbnQpOworCisJcmV0dXJuIHJldCA/
IHJldCA6IGxlbmd0aDsKK30KK0VYUE9SVF9TWU1CT0woZ3VkX2RybV9nYWRnZXRfc2V0X2J1ZmZl
cik7CisKK3N0YXRpYyB2b2lkIGd1ZF9kcm1fZ2FkZ2V0X2RlbGV0ZV9idWZmZXJzKHN0cnVjdCBn
dWRfZHJtX2dhZGdldCAqZ2RnKQoreworCWRybV9jbGllbnRfZnJhbWVidWZmZXJfZGVsZXRlKGdk
Zy0+YnVmZmVyX2NoZWNrKTsKKwlkcm1fY2xpZW50X2ZyYW1lYnVmZmVyX2RlbGV0ZShnZGctPmJ1
ZmZlcik7CisJZ2RnLT5idWZmZXJfY2hlY2sgPSBOVUxMOworCWdkZy0+YnVmZmVyID0gTlVMTDsK
K30KKworaW50IGd1ZF9kcm1fZ2FkZ2V0X2Rpc2FibGVfcGlwZShzdHJ1Y3QgZ3VkX2RybV9nYWRn
ZXQgKmdkZykKK3sKKwlpbnQgcmV0OworCisJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2Rpc2Fi
bGUoJmdkZy0+Y2xpZW50KTsKKwlndWRfZHJtX2dhZGdldF9kZWxldGVfYnVmZmVycyhnZGcpOwor
CisJcmV0dXJuIHJldDsKK30KK0VYUE9SVF9TWU1CT0woZ3VkX2RybV9nYWRnZXRfZGlzYWJsZV9w
aXBlKTsKKworc3RhdGljIGludCBndWRfZHJtX2dhZGdldF9jdHJsX2dldF9kaXNwbGF5X2Rlc2Ny
aXB0b3Ioc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcsIHUxNiB2YWx1ZSwKKwkJCQkJCSAgICAg
IHZvaWQgKmRhdGEsIHNpemVfdCBzaXplKQoreworCXN0cnVjdCBkcm1fZGV2aWNlICpkcm0gPSBn
ZGctPmNsaWVudC5kZXY7CisJc3RydWN0IGd1ZF9kcm1fZGlzcGxheV9kZXNjcmlwdG9yIGRlc2M7
CisJdTggdHlwZSA9IHZhbHVlID4+IDg7CisJdTggaW5kZXggPSB2YWx1ZSAmIDB4ZmY7CisKKwlp
ZiAodHlwZSAhPSBHVURfRFJNX1VTQl9EVF9ESVNQTEFZIHx8IGluZGV4KQorCQlyZXR1cm4gLUVJ
TlZBTDsKKworCWRlc2MuYkxlbmd0aCA9IHNpemVvZihkZXNjKTsKKwlkZXNjLmJEZXNjcmlwdG9y
VHlwZSA9IEdVRF9EUk1fVVNCX0RUX0RJU1BMQVk7CisKKwlkZXNjLmJWZXJzaW9uID0gMTsKKwlk
ZXNjLmJNYXhCdWZmZXJTaXplT3JkZXIgPSBpbG9nMihnZGctPm1heF9idWZmZXJfc2l6ZSk7CisJ
ZGVzYy5ibUZsYWdzID0gMDsKKwlkZXNjLmJDb21wcmVzc2lvbiA9IEdVRF9EUk1fQ09NUFJFU1NJ
T05fTFo0OworCisJZGVzYy5kd01pbldpZHRoID0gY3B1X3RvX2xlMzIoZHJtLT5tb2RlX2NvbmZp
Zy5taW5fd2lkdGgpOworCWRlc2MuZHdNYXhXaWR0aCA9IGNwdV90b19sZTMyKGRybS0+bW9kZV9j
b25maWcubWF4X3dpZHRoKTsKKwlkZXNjLmR3TWluSGVpZ2h0ID0gY3B1X3RvX2xlMzIoZHJtLT5t
b2RlX2NvbmZpZy5taW5faGVpZ2h0KTsKKwlkZXNjLmR3TWF4SGVpZ2h0ID0gY3B1X3RvX2xlMzIo
ZHJtLT5tb2RlX2NvbmZpZy5tYXhfaGVpZ2h0KTsKKwlkZXNjLmJOdW1Gb3JtYXRzID0gZ2RnLT5m
b3JtYXRfY291bnQ7CisJZGVzYy5iTnVtUHJvcGVydGllcyA9IGdkZy0+bnVtX3Byb3BlcnRpZXM7
CisJZGVzYy5iTnVtQ29ubmVjdG9ycyA9IGdkZy0+Y29ubmVjdG9yX2NvdW50OworCisJc2l6ZSA9
IG1pbihzaXplLCBzaXplb2YoZGVzYykpOworCW1lbWNweShkYXRhLCAmZGVzYywgc2l6ZSk7CisK
KwlyZXR1cm4gc2l6ZTsKK30KKworc3RhdGljIHZvaWQgZ3VkX2RybV9nYWRnZXRfY3RybF9nZXRf
Zm9ybWF0cyhzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywgX19sZTMyICpmb3JtYXRzKQorewor
CXVuc2lnbmVkIGludCBpOworCisJZm9yIChpID0gMDsgaSA8IGdkZy0+Zm9ybWF0X2NvdW50OyBp
KyspCisJCWZvcm1hdHNbaV0gPSBjcHVfdG9fbGUzMihnZGctPmZvcm1hdHNbaV0pOworfQorCitz
dGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2N0cmxfZ2V0X2Nvbm5lY3RvcihzdHJ1Y3QgZ3VkX2Ry
bV9nYWRnZXQgKmdkZywgdW5zaWduZWQgaW50IGluZGV4LAorCQkJCQkgICAgIHN0cnVjdCBndWRf
ZHJtX3JlcV9nZXRfY29ubmVjdG9yICpkZXNjKQoreworCXN0cnVjdCBndWRfZHJtX2dhZGdldF9j
b25uZWN0b3IgKmdjb25uOworCisJaWYgKGluZGV4ID49IGdkZy0+Y29ubmVjdG9yX2NvdW50KQor
CQlyZXR1cm4gLUVJTlZBTDsKKworCW1lbXNldChkZXNjLCAwLCBzaXplb2YoKmRlc2MpKTsKKwor
CWdjb25uID0gJmdkZy0+Y29ubmVjdG9yc1tpbmRleF07CisKKwlkZXNjLT5jb25uZWN0b3JfdHlw
ZSA9IGdjb25uLT5jb25uZWN0b3ItPmNvbm5lY3Rvcl90eXBlOworCWRlc2MtPmZsYWdzID0gY3B1
X3RvX2xlMzIoR1VEX0RSTV9DT05ORUNUT1JfRkxBR1NfUE9MTCk7CisJZGVzYy0+bnVtX3Byb3Bl
cnRpZXMgPSBnY29ubi0+bnVtX3Byb3BlcnRpZXM7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGlj
IHN0cnVjdCBndWRfZHJtX2dhZGdldF9jb25uZWN0b3IgKgorZ3VkX2RybV9nYWRnZXRfZ2V0X2dj
b25uKHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnLCB1bnNpZ25lZCBpbnQgaW5kZXgpCit7CisJ
aWYgKGluZGV4ID49IGdkZy0+Y29ubmVjdG9yX2NvdW50KQorCQlyZXR1cm4gTlVMTDsKKworCXJl
dHVybiAmZ2RnLT5jb25uZWN0b3JzW2luZGV4XTsKK30KKworc3RhdGljIGludCBndWRfZHJtX2dh
ZGdldF9jdHJsX2dldF9jb25uZWN0b3Jfc3RhdHVzKHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2Rn
LCB1bnNpZ25lZCBpbnQgaW5kZXgsCisJCQkJCQkgICAgc3RydWN0IGd1ZF9kcm1fcmVxX2dldF9j
b25uZWN0b3Jfc3RhdHVzICpzdGF0dXMpCit7CisJc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0X2Nvbm5l
Y3RvciAqZ2Nvbm47CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKworCWdjb25uID0gZ3VkX2RybV9n
YWRnZXRfZ2V0X2djb25uKGdkZywgaW5kZXgpOworCWlmICghZ2Nvbm4pCisJCXJldHVybiAtRU5P
RU5UOworCisJbWVtc2V0KHN0YXR1cywgMCwgc2l6ZW9mKCpzdGF0dXMpKTsKKworCXNwaW5fbG9j
a19pcnFzYXZlKCZnY29ubi0+bG9jaywgZmxhZ3MpOworCXN0YXR1cy0+c3RhdHVzID0gZ2Nvbm4t
PnN0YXR1czsKKwlpZiAoZ2Nvbm4tPmNoYW5nZWQpIHsKKwkJc3RhdHVzLT5zdGF0dXMgfD0gR1VE
X0RSTV9DT05ORUNUT1JfU1RBVFVTX0NIQU5HRUQ7CisJCWdjb25uLT5jaGFuZ2VkID0gZmFsc2U7
CisJfQorCWlmIChnY29ubi0+bnVtX21vZGVzKQorCQlzdGF0dXMtPm51bV9tb2RlcyA9IGNwdV90
b19sZTE2KGdjb25uLT5udW1fbW9kZXMpOworCWlmIChnY29ubi0+ZWRpZF9sZW4pCisJCXN0YXR1
cy0+ZWRpZF9sZW4gPSBjcHVfdG9fbGUxNihnY29ubi0+ZWRpZF9sZW4pOworCXNwaW5fdW5sb2Nr
X2lycXJlc3RvcmUoJmdjb25uLT5sb2NrLCBmbGFncyk7CisKKwlyZXR1cm4gMDsKK30KKworLyog
VGhpcyBydW5zIGluIGludGVycnVwdCBjb250ZXh0ICovCitpbnQgZ3VkX2RybV9nYWRnZXRfY3Ry
bF9nZXQoc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcsIHU4IHJlcXVlc3QsCisJCQkgICAgdTE2
IGluZGV4LCB2b2lkICpkYXRhLCBzaXplX3Qgc2l6ZSkKK3sKKwlzdHJ1Y3QgZ3VkX2RybV9nYWRn
ZXRfY29ubmVjdG9yICpnY29ubjsKKwl1bnNpZ25lZCBsb25nIGZsYWdzOworCWludCByZXQgPSAt
RUlOVkFMOworCisJcHJfZGVidWcoIiVzOiByZXF1ZXN0PTB4JXggaW5kZXg9JXUgc2l6ZT0lenVc
biIsIF9fZnVuY19fLCByZXF1ZXN0LCBpbmRleCwgc2l6ZSk7CisKKwlpZiAoIXJlZmNvdW50X2lu
Y19ub3RfemVybygmZ2RnLT51c2VjbnQpKQorCQlyZXR1cm4gLUVOT0RFVjsKKworCWlmICghc2l6
ZSkKKwkJZ290byBvdXQ7CisKKwlzd2l0Y2ggKHJlcXVlc3QpIHsKKwljYXNlIFVTQl9SRVFfR0VU
X0RFU0NSSVBUT1I6CisJCXJldCA9IGd1ZF9kcm1fZ2FkZ2V0X2N0cmxfZ2V0X2Rpc3BsYXlfZGVz
Y3JpcHRvcihnZGcsIGluZGV4LCBkYXRhLCBzaXplKTsKKwkJYnJlYWs7CisJY2FzZSBHVURfRFJN
X1VTQl9SRVFfR0VUX0ZPUk1BVFM6CisJCWlmICghaW5kZXggJiYgc2l6ZSA9PSBnZGctPmZvcm1h
dF9jb3VudCAqIHNpemVvZih1MzIpKSB7CisJCQlndWRfZHJtX2dhZGdldF9jdHJsX2dldF9mb3Jt
YXRzKGdkZywgZGF0YSk7CisJCQlyZXQgPSAwOworCQl9CisJCWJyZWFrOworCWNhc2UgR1VEX0RS
TV9VU0JfUkVRX0dFVF9QUk9QRVJUSUVTOgorCQlpZiAoIWluZGV4ICYmIHNpemUgPT0gZ2RnLT5u
dW1fcHJvcGVydGllcyAqIHNpemVvZigqZ2RnLT5wcm9wZXJ0aWVzKSkgeworCQkJbWVtY3B5KGRh
dGEsIGdkZy0+cHJvcGVydGllcywgc2l6ZSk7CisJCQlyZXQgPSAwOworCQl9CisJCWJyZWFrOwor
CWNhc2UgR1VEX0RSTV9VU0JfUkVRX0dFVF9DT05ORUNUT1I6CisJCWlmIChzaXplID09IHNpemVv
ZihzdHJ1Y3QgZ3VkX2RybV9yZXFfZ2V0X2Nvbm5lY3RvcikpCisJCQlyZXQgPSBndWRfZHJtX2dh
ZGdldF9jdHJsX2dldF9jb25uZWN0b3IoZ2RnLCBpbmRleCwgZGF0YSk7CisJCWJyZWFrOworCWNh
c2UgR1VEX0RSTV9VU0JfUkVRX0dFVF9DT05ORUNUT1JfUFJPUEVSVElFUzoKKwkJZ2Nvbm4gPSBn
dWRfZHJtX2dhZGdldF9nZXRfZ2Nvbm4oZ2RnLCBpbmRleCk7CisJCWlmIChnY29ubiAmJiBzaXpl
ID09IGdjb25uLT5udW1fcHJvcGVydGllcyAqIHNpemVvZigqZ2Nvbm4tPnByb3BlcnRpZXMpKSB7
CisJCQltZW1jcHkoZGF0YSwgZ2Nvbm4tPnByb3BlcnRpZXMsIHNpemUpOworCQkJcmV0ID0gMDsK
KwkJfQorCQlicmVhazsKKwljYXNlIEdVRF9EUk1fVVNCX1JFUV9HRVRfQ09OTkVDVE9SX1RWX01P
REVfVkFMVUVTOgorCQlnY29ubiA9IGd1ZF9kcm1fZ2FkZ2V0X2dldF9nY29ubihnZGcsIGluZGV4
KTsKKwkJaWYgKGdjb25uICYmIHNpemUgPT0gZ2Nvbm4tPm51bV90dl9tb2RlX2VudW1fbmFtZXMg
KiBEUk1fUFJPUF9OQU1FX0xFTikgeworCQkJbWVtY3B5KGRhdGEsIGdjb25uLT50dl9tb2RlX2Vu
dW1fbmFtZXMsIHNpemUpOworCQkJcmV0ID0gMDsKKwkJfQorCQlicmVhazsKKwljYXNlIEdVRF9E
Uk1fVVNCX1JFUV9HRVRfQ09OTkVDVE9SX1NUQVRVUzoKKwkJaWYgKHNpemUgPT0gc2l6ZW9mKHN0
cnVjdCBndWRfZHJtX3JlcV9nZXRfY29ubmVjdG9yX3N0YXR1cykpCisJCQlyZXQgPSBndWRfZHJt
X2dhZGdldF9jdHJsX2dldF9jb25uZWN0b3Jfc3RhdHVzKGdkZywgaW5kZXgsIGRhdGEpOworCQli
cmVhazsKKwljYXNlIEdVRF9EUk1fVVNCX1JFUV9HRVRfQ09OTkVDVE9SX01PREVTOgorCQlnY29u
biA9IGd1ZF9kcm1fZ2FkZ2V0X2dldF9nY29ubihnZGcsIGluZGV4KTsKKwkJc3Bpbl9sb2NrX2ly
cXNhdmUoJmdjb25uLT5sb2NrLCBmbGFncyk7CisJCWlmIChnY29ubiAmJiBzaXplID09IGdjb25u
LT5udW1fbW9kZXMgKiBzaXplb2YoKmdjb25uLT5tb2RlcykpIHsKKwkJCW1lbWNweShkYXRhLCBn
Y29ubi0+bW9kZXMsIHNpemUpOworCQkJcmV0ID0gMDsKKwkJfQorCQlzcGluX3VubG9ja19pcnFy
ZXN0b3JlKCZnY29ubi0+bG9jaywgZmxhZ3MpOworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fVVNC
X1JFUV9HRVRfQ09OTkVDVE9SX0VESUQ6CisJCWdjb25uID0gZ3VkX2RybV9nYWRnZXRfZ2V0X2dj
b25uKGdkZywgaW5kZXgpOworCQlzcGluX2xvY2tfaXJxc2F2ZSgmZ2Nvbm4tPmxvY2ssIGZsYWdz
KTsKKwkJaWYgKGdjb25uICYmIHNpemUgPT0gZ2Nvbm4tPmVkaWRfbGVuKSB7CisJCQltZW1jcHko
ZGF0YSwgZ2Nvbm4tPmVkaWQsIHNpemUpOworCQkJcmV0ID0gMDsKKwkJfQorCQlzcGluX3VubG9j
a19pcnFyZXN0b3JlKCZnY29ubi0+bG9jaywgZmxhZ3MpOworCQlicmVhazsKKwl9CitvdXQ6CisJ
cmVmY291bnRfZGVjKCZnZGctPnVzZWNudCk7CisKKwlyZXR1cm4gIXJldCA/IHNpemUgOiByZXQ7
Cit9CitFWFBPUlRfU1lNQk9MKGd1ZF9kcm1fZ2FkZ2V0X2N0cmxfZ2V0KTsKKworaW50IGd1ZF9k
cm1fZ2FkZ2V0X2N0cmxfc2V0KHN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnLCB1OCByZXF1ZXN0
LAorCQkJICAgIHUxNiBpbmRleCwgdm9pZCAqZGF0YSwgc2l6ZV90IHNpemUpCit7CisJc3RydWN0
IGd1ZF9kcm1fZ2FkZ2V0X2Nvbm5lY3RvciAqZ2Nvbm47CisJaW50IGRwbXMsIHJldCA9IC1FSU5W
QUw7CisKKwlwcl9kZWJ1ZygiJXM6IHJlcXVlc3Q9MHgleCBpbmRleD0ldSBzaXplPSV6dVxuIiwg
X19mdW5jX18sIHJlcXVlc3QsIGluZGV4LCBzaXplKTsKKworCWlmICghcmVmY291bnRfaW5jX25v
dF96ZXJvKCZnZGctPnVzZWNudCkpCisJCXJldHVybiAtRU5PREVWOworCisJc3dpdGNoIChyZXF1
ZXN0KSB7CisJY2FzZSBHVURfRFJNX1VTQl9SRVFfU0VUX0NPTk5FQ1RPUl9GT1JDRV9ERVRFQ1Q6
CisJCWdjb25uID0gZ3VkX2RybV9nYWRnZXRfZ2V0X2djb25uKGdkZywgaW5kZXgpOworCQlpZiAo
Z2Nvbm4pCisJCQlyZXQgPSBndWRfZHJtX2dhZGdldF9wcm9iZV9jb25uZWN0b3IoZ2Nvbm4pOwor
CQlicmVhazsKKwljYXNlIEdVRF9EUk1fVVNCX1JFUV9TRVRfU1RBVEVfQ0hFQ0s6CisJCXJldCA9
IGd1ZF9kcm1fZ2FkZ2V0X2NoZWNrKGdkZywgZGF0YSwgc2l6ZSk7CisJCWJyZWFrOworCWNhc2Ug
R1VEX0RSTV9VU0JfUkVRX1NFVF9TVEFURV9DT01NSVQ6CisJCWlmICghc2l6ZSkKKwkJCXJldCA9
IGd1ZF9kcm1fZ2FkZ2V0X2NvbW1pdChnZGcpOworCQlicmVhazsKKwljYXNlIEdVRF9EUk1fVVNC
X1JFUV9TRVRfQ09OVFJPTExFUl9FTkFCTEU6CisJCWlmIChzaXplID09IHNpemVvZih1OCkpIHsK
KwkJCWlmICgqKHU4ICopZGF0YSA9PSAwKQorCQkJCXJldCA9IGd1ZF9kcm1fZ2FkZ2V0X2Rpc2Fi
bGVfcGlwZShnZGcpOworCQkJZWxzZQorCQkJCXJldCA9IDA7CisJCX0KKwkJYnJlYWs7CisJY2Fz
ZSBHVURfRFJNX1VTQl9SRVFfU0VUX0RJU1BMQVlfRU5BQkxFOgorCQlpZiAoc2l6ZSA9PSBzaXpl
b2YodTgpKSB7CisJCQlkcG1zID0gKih1OCAqKWRhdGEgPyBEUk1fTU9ERV9EUE1TX09OIDogRFJN
X01PREVfRFBNU19PRkY7CisJCQlyZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfZHBtcygmZ2RnLT5j
bGllbnQsIGRwbXMpOworCQl9CisJCWJyZWFrOworCX0KKworCXJlZmNvdW50X2RlYygmZ2RnLT51
c2VjbnQpOworCisJcmV0dXJuIHJldDsKK30KK0VYUE9SVF9TWU1CT0woZ3VkX2RybV9nYWRnZXRf
Y3RybF9zZXQpOworCitzdGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2dldF9mb3JtYXRzKHN0cnVj
dCBndWRfZHJtX2dhZGdldCAqZ2RnLCB1OCAqbWF4X2NwcCkKK3sKKwlzdHJ1Y3QgZHJtX2Rldmlj
ZSAqZHJtID0gZ2RnLT5jbGllbnQuZGV2OworCXN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lOworCXVu
c2lnbmVkIGludCBpOworCXUzMiAqZm9ybWF0czsKKwlpbnQgcmV0OworCisJKm1heF9jcHAgPSAw
OworCisJZHJtX2Zvcl9lYWNoX3BsYW5lKHBsYW5lLCBkcm0pIHsKKwkJaWYgKHBsYW5lLT50eXBl
ID09IERSTV9QTEFORV9UWVBFX1BSSU1BUlkpCisJCQlicmVhazsKKwl9CisKKwlmb3JtYXRzID0g
a2NhbGxvYyhwbGFuZS0+Zm9ybWF0X2NvdW50LCBzaXplb2YodTMyKSwgR0ZQX0tFUk5FTCk7CisJ
aWYgKCFmb3JtYXRzKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWZvciAoaSA9IDA7IGkgPCBwbGFu
ZS0+Zm9ybWF0X2NvdW50OyBpKyspIHsKKwkJY29uc3Qgc3RydWN0IGRybV9mb3JtYXRfaW5mbyAq
Zm10OworCisJCWZtdCA9IGRybV9mb3JtYXRfaW5mbyhwbGFuZS0+Zm9ybWF0X3R5cGVzW2ldKTsK
KwkJaWYgKGZtdC0+bnVtX3BsYW5lcyAhPSAxKQorCQkJY29udGludWU7CisKKwkJLyoKKwkJICog
U3VwcG9ydGluZyAyNC1iaXQgYnBwIHdvdWxkIGFkZCBjb21wbGV4aXR5IHNvIGRvbid0IGJvdGhl
ci4KKwkJICogSXQncyBoYXJkbHkgdXNlZCBhbmQgY29tcHJlc3Npb24gcmVtb3ZlcyBtdWNoIG9m
IHRoZSBnYWluLgorCQkgKi8KKwkJaWYgKGZtdC0+Y3BwWzBdID09IDMpCisJCQljb250aW51ZTsK
KworCQlpZiAoKm1heF9jcHAgPCBmbXQtPmNwcFswXSkKKwkJCSptYXhfY3BwID0gZm10LT5jcHBb
MF07CisKKwkJZm9ybWF0c1tnZGctPmZvcm1hdF9jb3VudCsrXSA9IHBsYW5lLT5mb3JtYXRfdHlw
ZXNbaV07CisJfQorCisJaWYgKCFnZGctPmZvcm1hdF9jb3VudCkgeworCQlyZXQgPSAtRU5PRU5U
OworCQlnb3RvIGVycl9mcmVlOworCX0KKworCWdkZy0+Zm9ybWF0cyA9IGZvcm1hdHM7CisKKwly
ZXR1cm4gMDsKKworZXJyX2ZyZWU6CisJa2ZyZWUoZm9ybWF0cyk7CisKKwlyZXR1cm4gcmV0Owor
fQorCitzdGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2dldF9yb3RhdGlvbl9wcm9wZXJ0eShzdHJ1
Y3QgZHJtX2RldmljZSAqZHJtLCB1MTYgKnByb3AsIHU2NCAqdmFsKQoreworCXN0cnVjdCBkcm1f
cHJvcGVydHlfZW51bSAqcHJvcF9lbnVtOworCXN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lOworCXVu
c2lnbmVkIGludCBudW1fcHJvcHMgPSAwOworCXUxNiBiaXRtYXNrID0gMDsKKworCWRybV9mb3Jf
ZWFjaF9wbGFuZShwbGFuZSwgZHJtKSB7CisJCWlmIChwbGFuZS0+dHlwZSA9PSBEUk1fUExBTkVf
VFlQRV9QUklNQVJZKQorCQkJYnJlYWs7CisJfQorCisJaWYgKCFwbGFuZS0+cm90YXRpb25fcHJv
cGVydHkpCisJCXJldHVybiAwOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeShwcm9wX2VudW0sICZw
bGFuZS0+cm90YXRpb25fcHJvcGVydHktPmVudW1fbGlzdCwgaGVhZCkgeworCQludW1fcHJvcHMr
KzsKKwkJYml0bWFzayB8PSBCSVQocHJvcF9lbnVtLT52YWx1ZSk7CisJfQorCisJKnByb3AgPSBH
VURfRFJNX1BST1BFUlRZX1JPVEFUSU9OOworCSp2YWwgPSBiaXRtYXNrOworCisJcmV0dXJuIDE7
Cit9CisKK3N0YXRpYyBpbnQgZ3VkX2RybV9nYWRnZXRfZ2V0X3Byb3BlcnRpZXMoc3RydWN0IGd1
ZF9kcm1fZ2FkZ2V0ICpnZGcpCit7CisJc3RydWN0IGd1ZF9kcm1fcHJvcGVydHkgKnByb3BlcnRp
ZXM7CisJdTE2IHByb3A7CisJdTY0IHZhbDsKKwlpbnQgcmV0OworCisJcmV0ID0gZ3VkX2RybV9n
YWRnZXRfZ2V0X3JvdGF0aW9uX3Byb3BlcnR5KGdkZy0+Y2xpZW50LmRldiwgJnByb3AsICZ2YWwp
OworCWlmIChyZXQgPD0gMCkKKwkJcmV0dXJuIHJldDsKKworCXByb3BlcnRpZXMgPSBrY2FsbG9j
KDEsIHNpemVvZigqcHJvcGVydGllcyksIEdGUF9LRVJORUwpOworCWlmICghcHJvcGVydGllcykK
KwkJcmV0dXJuIC1FTk9NRU07CisKKwlnZGctPnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOworCWdk
Zy0+bnVtX3Byb3BlcnRpZXMrKzsKKworCXByb3BlcnRpZXNbMF0ucHJvcCA9IGNwdV90b19sZTE2
KHByb3ApOworCXByb3BlcnRpZXNbMF0udmFsID0gY3B1X3RvX2xlNjQodmFsKTsKKworCXJldHVy
biAwOworfQorCitzdGF0aWMgaW50IGd1ZF9kcm1fZ2FkZ2V0X2dldF9jb25uZWN0b3JfcHJvcGVy
dGllcyhzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywKKwkJCQkJCSAgIHN0cnVjdCBndWRfZHJt
X2dhZGdldF9jb25uZWN0b3IgKmdjb25uKQoreworCXN0cnVjdCBkcm1fZGV2aWNlICpkcm0gPSBn
ZGctPmNsaWVudC5kZXY7CisJc3RydWN0IGRybV9tb2RlX2NvbmZpZyAqY29uZmlnID0gJmRybS0+
bW9kZV9jb25maWc7CisJc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvciA9IGdjb25uLT5j
b25uZWN0b3I7CisJc3RydWN0IGRybV9vYmplY3RfcHJvcGVydGllcyAqY29ubl9wcm9wcyA9IGNv
bm5lY3Rvci0+YmFzZS5wcm9wZXJ0aWVzOworCXN0cnVjdCBndWRfZHJtX3Byb3BlcnR5ICpwcm9w
ZXJ0aWVzOworCXVuc2lnbmVkIGludCBpLCByZXQgPSAwOworCXUxNiBwcm9wOworCXU2NCB2YWw7
CisKKwltdXRleF9sb2NrKCZkcm0tPm1vZGVfY29uZmlnLm11dGV4KTsKKworCWlmICghY29ubl9w
cm9wcy0+Y291bnQpCisJCWdvdG8gdW5sb2NrOworCisJLyogQWRkIHJvb20gZm9yIHBvc3NpYmxl
IGJhY2tsaWdodCAqLworCXByb3BlcnRpZXMgPSBrY2FsbG9jKGNvbm5fcHJvcHMtPmNvdW50ICsg
MSwgc2l6ZW9mKCpwcm9wZXJ0aWVzKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFwcm9wZXJ0aWVzKSB7
CisJCXJldCA9IC1FTk9NRU07CisJCWdvdG8gdW5sb2NrOworCX0KKworCWdjb25uLT5wcm9wZXJ0
aWVzID0gcHJvcGVydGllczsKKworCWZvciAoaSA9IDA7IGkgPCBjb25uX3Byb3BzLT5jb3VudDsg
aSsrKSB7CisJCXN0cnVjdCBkcm1fcHJvcGVydHkgKnByb3BlcnR5ID0gY29ubl9wcm9wcy0+cHJv
cGVydGllc1tpXTsKKworCQlpZiAocHJvcGVydHkgPT0gY29uZmlnLT50dl9zZWxlY3Rfc3ViY29u
bmVjdG9yX3Byb3BlcnR5KSB7CisJCQlwcm9wID0gR1VEX0RSTV9QUk9QRVJUWV9UVl9TRUxFQ1Rf
U1VCQ09OTkVDVE9SOworCQkJdmFsID0gY29ubmVjdG9yLT5zdGF0ZS0+dHYuc3ViY29ubmVjdG9y
OworCQl9IGVsc2UgaWYgKHByb3BlcnR5ID09IGNvbmZpZy0+dHZfbGVmdF9tYXJnaW5fcHJvcGVy
dHkpIHsKKwkJCXByb3AgPSBHVURfRFJNX1BST1BFUlRZX1RWX0xFRlRfTUFSR0lOOworCQkJdmFs
ID0gY29ubmVjdG9yLT5zdGF0ZS0+dHYubWFyZ2lucy5sZWZ0OworCQl9IGVsc2UgaWYgKHByb3Bl
cnR5ID09IGNvbmZpZy0+dHZfcmlnaHRfbWFyZ2luX3Byb3BlcnR5KSB7CisJCQlwcm9wID0gR1VE
X0RSTV9QUk9QRVJUWV9UVl9SSUdIVF9NQVJHSU47CisJCQl2YWwgPSBjb25uZWN0b3ItPnN0YXRl
LT50di5tYXJnaW5zLnJpZ2h0OworCQl9IGVsc2UgaWYgKHByb3BlcnR5ID09IGNvbmZpZy0+dHZf
dG9wX21hcmdpbl9wcm9wZXJ0eSkgeworCQkJcHJvcCA9IEdVRF9EUk1fUFJPUEVSVFlfVFZfVE9Q
X01BUkdJTjsKKwkJCXZhbCA9IGNvbm5lY3Rvci0+c3RhdGUtPnR2Lm1hcmdpbnMudG9wOworCQl9
IGVsc2UgaWYgKHByb3BlcnR5ID09IGNvbmZpZy0+dHZfYm90dG9tX21hcmdpbl9wcm9wZXJ0eSkg
eworCQkJcHJvcCA9IEdVRF9EUk1fUFJPUEVSVFlfVFZfQk9UVE9NX01BUkdJTjsKKwkJCXZhbCA9
IGNvbm5lY3Rvci0+c3RhdGUtPnR2Lm1hcmdpbnMuYm90dG9tOworCQl9IGVsc2UgaWYgKHByb3Bl
cnR5ID09IGNvbmZpZy0+dHZfbW9kZV9wcm9wZXJ0eSkgeworCQkJc3RydWN0IGRybV9wcm9wZXJ0
eV9lbnVtICpwcm9wX2VudW07CisJCQljaGFyICpidWY7CisKKwkJCWxpc3RfZm9yX2VhY2hfZW50
cnkocHJvcF9lbnVtLCAmcHJvcGVydHktPmVudW1fbGlzdCwgaGVhZCkKKwkJCQlnY29ubi0+bnVt
X3R2X21vZGVfZW51bV9uYW1lcysrOworCisJCQlpZiAoV0FSTl9PTighZ2Nvbm4tPm51bV90dl9t
b2RlX2VudW1fbmFtZXMpKSB7CisJCQkJcmV0ID0gLUVJTlZBTDsKKwkJCQlnb3RvIHVubG9jazsK
KwkJCX0KKworCQkJYnVmID0ga2NhbGxvYyhnY29ubi0+bnVtX3R2X21vZGVfZW51bV9uYW1lcywg
RFJNX1BST1BfTkFNRV9MRU4sIEdGUF9LRVJORUwpOworCQkJaWYgKCFidWYpIHsKKwkJCQlyZXQg
PSAtRU5PTUVNOworCQkJCWdvdG8gdW5sb2NrOworCQkJfQorCisJCQlnY29ubi0+dHZfbW9kZV9l
bnVtX25hbWVzID0gYnVmOworCisJCQlsaXN0X2Zvcl9lYWNoX2VudHJ5KHByb3BfZW51bSwgJnBy
b3BlcnR5LT5lbnVtX2xpc3QsIGhlYWQpIHsKKwkJCQlzdHJuY3B5KGJ1ZiwgcHJvcF9lbnVtLT5u
YW1lLCBEUk1fUFJPUF9OQU1FX0xFTik7CisJCQkJYnVmICs9IERSTV9QUk9QX05BTUVfTEVOOwor
CQkJfQorCisJCQlwcm9wID0gR1VEX0RSTV9QUk9QRVJUWV9UVl9NT0RFOworCQkJdmFsID0gY29u
bmVjdG9yLT5zdGF0ZS0+dHYubW9kZTsKKwkJCXZhbCB8PSBnY29ubi0+bnVtX3R2X21vZGVfZW51
bV9uYW1lcyA8PCBHVURfRFJNX1VTQl9DT05ORUNUT1JfVFZfTU9ERV9OVU1fU0hJRlQ7CisJCX0g
ZWxzZSBpZiAocHJvcGVydHkgPT0gY29uZmlnLT50dl9icmlnaHRuZXNzX3Byb3BlcnR5KSB7CisJ
CQlwcm9wID0gR1VEX0RSTV9QUk9QRVJUWV9UVl9CUklHSFRORVNTOworCQkJdmFsID0gY29ubmVj
dG9yLT5zdGF0ZS0+dHYuYnJpZ2h0bmVzczsKKwkJfSBlbHNlIGlmIChwcm9wZXJ0eSA9PSBjb25m
aWctPnR2X2NvbnRyYXN0X3Byb3BlcnR5KSB7CisJCQlwcm9wID0gR1VEX0RSTV9QUk9QRVJUWV9U
Vl9DT05UUkFTVDsKKwkJCXZhbCA9IGNvbm5lY3Rvci0+c3RhdGUtPnR2LmNvbnRyYXN0OworCQl9
IGVsc2UgaWYgKHByb3BlcnR5ID09IGNvbmZpZy0+dHZfZmxpY2tlcl9yZWR1Y3Rpb25fcHJvcGVy
dHkpIHsKKwkJCXByb3AgPSBHVURfRFJNX1BST1BFUlRZX1RWX0ZMSUNLRVJfUkVEVUNUSU9OOwor
CQkJdmFsID0gY29ubmVjdG9yLT5zdGF0ZS0+dHYuZmxpY2tlcl9yZWR1Y3Rpb247CisJCX0gZWxz
ZSBpZiAocHJvcGVydHkgPT0gY29uZmlnLT50dl9vdmVyc2Nhbl9wcm9wZXJ0eSkgeworCQkJcHJv
cCA9IEdVRF9EUk1fUFJPUEVSVFlfVFZfT1ZFUlNDQU47CisJCQl2YWwgPSBjb25uZWN0b3ItPnN0
YXRlLT50di5vdmVyc2NhbjsKKwkJfSBlbHNlIGlmIChwcm9wZXJ0eSA9PSBjb25maWctPnR2X3Nh
dHVyYXRpb25fcHJvcGVydHkpIHsKKwkJCXByb3AgPSBHVURfRFJNX1BST1BFUlRZX1RWX1NBVFVS
QVRJT047CisJCQl2YWwgPSBjb25uZWN0b3ItPnN0YXRlLT50di5zYXR1cmF0aW9uOworCQl9IGVs
c2UgaWYgKHByb3BlcnR5ID09IGNvbmZpZy0+dHZfaHVlX3Byb3BlcnR5KSB7CisJCQlwcm9wID0g
R1VEX0RSTV9QUk9QRVJUWV9UVl9IVUU7CisJCQl2YWwgPSBjb25uZWN0b3ItPnN0YXRlLT50di5o
dWU7CisJCX0gZWxzZSB7CisJCQljb250aW51ZTsKKwkJfQorCisJCXByb3BlcnRpZXNbZ2Nvbm4t
Pm51bV9wcm9wZXJ0aWVzXS5wcm9wID0gY3B1X3RvX2xlMTYocHJvcCk7CisJCXByb3BlcnRpZXNb
Z2Nvbm4tPm51bV9wcm9wZXJ0aWVzKytdLnZhbCA9IGNwdV90b19sZTY0KHZhbCk7CisJfQorCisJ
aWYgKCFjb25uZWN0b3ItPmluZGV4ICYmIGdkZy0+YmFja2xpZ2h0KSB7CisJCXN0cnVjdCBiYWNr
bGlnaHRfcHJvcGVydGllcyAqcHJvcHMgPSAmZ2RnLT5iYWNrbGlnaHQtPnByb3BzOworCisJCXBy
b3AgPSBHVURfRFJNX1BST1BFUlRZX0JBQ0tMSUdIVF9CUklHSFRORVNTOworCQl2YWwgPSBESVY2
NF9VNjRfUk9VTkRfVVAocHJvcHMtPmJyaWdodG5lc3MgKiAxMDAsIHByb3BzLT5tYXhfYnJpZ2h0
bmVzcyk7CisJCXByb3BlcnRpZXNbZ2Nvbm4tPm51bV9wcm9wZXJ0aWVzXS5wcm9wID0gY3B1X3Rv
X2xlMTYocHJvcCk7CisJCXByb3BlcnRpZXNbZ2Nvbm4tPm51bV9wcm9wZXJ0aWVzKytdLnZhbCA9
IGNwdV90b19sZTY0KHZhbCk7CisJCWdjb25uLT5iYWNrbGlnaHQgPSBnZGctPmJhY2tsaWdodDsK
Kwl9Cit1bmxvY2s6CisJbXV0ZXhfdW5sb2NrKCZkcm0tPm1vZGVfY29uZmlnLm11dGV4KTsKKwor
CXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBpbnQgZ3VkX2RybV9nYWRnZXRfZ2V0X2Nvbm5lY3Rv
cnMoc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcpCit7CisJc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0
X2Nvbm5lY3RvciAqY29ubmVjdG9ycyA9IE5VTEw7CisJc3RydWN0IGRybV9jb25uZWN0b3JfbGlz
dF9pdGVyIGNvbm5faXRlcjsKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZHJtID0gZ2RnLT5jbGllbnQu
ZGV2OworCXVuc2lnbmVkIGludCBjb25uZWN0b3JfY291bnQgPSAwOworCXN0cnVjdCBkcm1fY29u
bmVjdG9yICpjb25uZWN0b3I7CisJaW50IHJldCA9IDA7CisKKwlkcm1fY29ubmVjdG9yX2xpc3Rf
aXRlcl9iZWdpbihkcm0sICZjb25uX2l0ZXIpOworCWRybV9jbGllbnRfZm9yX2VhY2hfY29ubmVj
dG9yX2l0ZXIoY29ubmVjdG9yLCAmY29ubl9pdGVyKSB7CisJCXN0cnVjdCBndWRfZHJtX2dhZGdl
dF9jb25uZWN0b3IgKnRtcCwgKmdjb25uOworCisJCXRtcCA9IGtyZWFsbG9jKGNvbm5lY3RvcnMs
IChjb25uZWN0b3JfY291bnQgKyAxKSAqIHNpemVvZigqY29ubmVjdG9ycyksCisJCQkgICAgICAg
R0ZQX0tFUk5FTCB8IF9fR0ZQX1pFUk8pOworCQlpZiAoIXRtcCkgeworCQkJcmV0ID0gLUVOT01F
TTsKKwkJCWJyZWFrOworCQl9CisKKwkJY29ubmVjdG9ycyA9IHRtcDsKKwkJZHJtX2Nvbm5lY3Rv
cl9nZXQoY29ubmVjdG9yKTsKKwkJZ2Nvbm4gPSAmY29ubmVjdG9yc1tjb25uZWN0b3JfY291bnQr
K107CisJCWdjb25uLT5jb25uZWN0b3IgPSBjb25uZWN0b3I7CisJCXNwaW5fbG9ja19pbml0KCZn
Y29ubi0+bG9jayk7CisKKwkJcmV0ID0gZ3VkX2RybV9nYWRnZXRfZ2V0X2Nvbm5lY3Rvcl9wcm9w
ZXJ0aWVzKGdkZywgZ2Nvbm4pOworCQlpZiAocmV0KQorCQkJYnJlYWs7CisJfQorCWRybV9jb25u
ZWN0b3JfbGlzdF9pdGVyX2VuZCgmY29ubl9pdGVyKTsKKworCWdkZy0+Y29ubmVjdG9ycyA9IGNv
bm5lY3RvcnM7CisJZ2RnLT5jb25uZWN0b3JfY291bnQgPSBjb25uZWN0b3JfY291bnQ7CisKKwly
ZXR1cm4gcmV0OworfQorCitzdGF0aWMgdm9pZCBndWRfZHJtX2dhZGdldF9yZWxlYXNlKHN0cnVj
dCBrcmVmICprcmVmKQoreworCXN0cnVjdCBndWRfZHJtX2dhZGdldCAqZ2RnID0gY29udGFpbmVy
X29mKGtyZWYsIHN0cnVjdCBndWRfZHJtX2dhZGdldCwgcmVmY291bnQpOworCisJa2ZyZWUoZ2Rn
KTsKK30KKworc3RhdGljIHZvaWQgZ3VkX2RybV9nYWRnZXRfcHV0KHN0cnVjdCBndWRfZHJtX2dh
ZGdldCAqZ2RnKQoreworCWtyZWZfcHV0KCZnZGctPnJlZmNvdW50LCBndWRfZHJtX2dhZGdldF9y
ZWxlYXNlKTsKK30KKworc3RhdGljIHZvaWQgZ3VkX2RybV9nYWRnZXRfY2xpZW50X3VucmVnaXN0
ZXIoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpCit7CisJc3RydWN0IGd1ZF9kcm1fZ2Fk
Z2V0ICpnZGcgPSBjb250YWluZXJfb2YoY2xpZW50LCBzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQsIGNs
aWVudCk7CisJaW50IHRpbWVvdXQgPSAxMDAwMCAvIDUwOworCXVuc2lnbmVkIGludCBpOworCisJ
LyoKKwkgKiBJZiB1c2VjbnQgZG9lc24ndCBkcm9wIHRvIHplcm8sIHRyeSB3YWl0aW5nIGZvciB0
aGUgZ2FkZ2V0LCBidXQgd2UKKwkgKiBjYW4ndCBibG9jayB0aGUgRFJNIGRyaXZlciBmb3JldmVy
LiBUaGUgd29yc3QgY2FzZSB3YWl0IHRoZSBnYWRnZXQgc2lkZQorCSAqIGNhbiBoaXQgYXJlIHRl
bnMgb2Ygc2Vjb25kcyB0aHJvdWdoIHRoZSBjYWxsIHRvIGRybV9jbGllbnRfbW9kZXNldF9jb21t
aXQoKS4KKwkgKi8KKwlpZiAocmVmY291bnRfZGVjX2FuZF90ZXN0KCZnZGctPnVzZWNudCkpIHsK
KwkJZm9yICg7IHRpbWVvdXQgJiYgcmVmY291bnRfcmVhZCgmZ2RnLT51c2VjbnQpOyB0aW1lb3V0
LS0pCisJCQltc2xlZXAoNTApOworCX0KKworCWlmICghdGltZW91dCkgeworCQlwcl9lcnIoIiVz
OiBUaW1lb3V0IHdhaXRpbmcgZm9yIGdhZGdldCBzaWRlLCB3aWxsIGxlYWsgbWVtb3J5XG4iLCBf
X2Z1bmNfXyk7CisJCXJldHVybjsKKwl9CisKKwl2ZnJlZShnZGctPndvcmtfYnVmKTsKKwlrZnJl
ZShnZGctPmZvcm1hdHMpOworCWtmcmVlKGdkZy0+cHJvcGVydGllcyk7CisKKwlmb3IgKGkgPSAw
OyBpIDwgZ2RnLT5jb25uZWN0b3JfY291bnQ7IGkrKykgeworCQlzdHJ1Y3QgZ3VkX2RybV9nYWRn
ZXRfY29ubmVjdG9yICpnY29ubiA9ICZnZGctPmNvbm5lY3RvcnNbaV07CisKKwkJZHJtX2Nvbm5l
Y3Rvcl9wdXQoZ2Nvbm4tPmNvbm5lY3Rvcik7CisJCWtmcmVlKGdjb25uLT5wcm9wZXJ0aWVzKTsK
KwkJa2ZyZWUoZ2Nvbm4tPnR2X21vZGVfZW51bV9uYW1lcyk7CisJCWtmcmVlKGdjb25uLT5tb2Rl
cyk7CisJCWtmcmVlKGdjb25uLT5lZGlkKTsKKwl9CisJa2ZyZWUoZ2RnLT5jb25uZWN0b3JzKTsK
KworCWd1ZF9kcm1fZ2FkZ2V0X2RlbGV0ZV9idWZmZXJzKGdkZyk7CisJZHJtX2NsaWVudF9yZWxl
YXNlKGNsaWVudCk7CisJZ3VkX2RybV9nYWRnZXRfcHV0KGdkZyk7Cit9CisKK3N0YXRpYyBpbnQg
Z3VkX2RybV9nYWRnZXRfY2xpZW50X2hvdHBsdWcoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGll
bnQpCit7CisJc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcgPSBjb250YWluZXJfb2YoY2xpZW50
LCBzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQsIGNsaWVudCk7CisKKwlndWRfZHJtX2dhZGdldF9wcm9i
ZV9jb25uZWN0b3JzKGdkZyk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGNvbnN0IHN0cnVj
dCBkcm1fY2xpZW50X2Z1bmNzIGdkZ19jbGllbnRfZnVuY3MgPSB7CisJLm93bmVyCQk9IFRISVNf
TU9EVUxFLAorCS51bnJlZ2lzdGVyCT0gZ3VkX2RybV9nYWRnZXRfY2xpZW50X3VucmVnaXN0ZXIs
CisJLmhvdHBsdWcJPSBndWRfZHJtX2dhZGdldF9jbGllbnRfaG90cGx1ZywKK307CisKK3N0cnVj
dCBndWRfZHJtX2dhZGdldCAqZ3VkX2RybV9nYWRnZXRfaW5pdCh1bnNpZ25lZCBpbnQgbWlub3Jf
aWQsIGNvbnN0IGNoYXIgKmJhY2tsaWdodCwKKwkJCQkJICAgc2l6ZV90ICptYXhfYnVmZmVyX3Np
emUpCit7CisJc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpnZGc7CisJdTggbWF4X2NwcDsKKwlpbnQg
cmV0OworCisJZ2RnID0ga3phbGxvYyhzaXplb2YoKmdkZyksIEdGUF9LRVJORUwpOworCWlmICgh
Z2RnKQorCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKKworCXJldCA9IGRybV9jbGllbnRfaW5p
dF9mcm9tX2lkKG1pbm9yX2lkLCAmZ2RnLT5jbGllbnQsICJndWQtZHJtLWdhZGdldCIsICZnZGdf
Y2xpZW50X2Z1bmNzKTsKKwlpZiAocmV0KSB7CisJCXByX2VycigiRmFpbGVkIHRvIGFxdWlyZSBt
aW5vcj0ldVxuIiwgbWlub3JfaWQpOworCQlrZnJlZShnZGcpOworCQlyZXR1cm4gRVJSX1BUUihy
ZXQpOworCX0KKworCXJlZmNvdW50X3NldCgmZ2RnLT51c2VjbnQsIDEpOworCS8qIFRoZSBEUk0g
ZHJpdmVyICh0aHJvdWdoIHRoZSBjbGllbnQpIGFuZCBmX2d1ZF9kcm0gbmVlZCBvbmUgcmVmIGVh
Y2ggKi8KKwlrcmVmX2luaXQoJmdkZy0+cmVmY291bnQpOworCWtyZWZfZ2V0KCZnZGctPnJlZmNv
dW50KTsKKworCWlmIChiYWNrbGlnaHQpIHsKKwkJZ2RnLT5iYWNrbGlnaHQgPSBiYWNrbGlnaHRf
ZGV2aWNlX2dldF9ieV9uYW1lKGJhY2tsaWdodCk7CisJCWlmICghZ2RnLT5iYWNrbGlnaHQpIHsK
KwkJCXByX2VycigiRmFpbGVkIHRvIGZpbmQgYmFja2xpZ2h0OiAlc1xuIiwgYmFja2xpZ2h0KTsK
KwkJCXJldCA9IC1FTk9ERVY7CisJCQlnb3RvIGVycm9yX3JlbGVhc2U7CisJCX0KKwl9CisKKwly
ZXQgPSBndWRfZHJtX2dhZGdldF9nZXRfZm9ybWF0cyhnZGcsICZtYXhfY3BwKTsKKwlpZiAocmV0
KSB7CisJCXByX2VycigiRmFpbGVkIHRvIGdldCBmb3JtYXRzXG4iKTsKKwkJZ290byBlcnJvcl9y
ZWxlYXNlOworCX0KKworCSptYXhfYnVmZmVyX3NpemUgPSBnZGctPmNsaWVudC5kZXYtPm1vZGVf
Y29uZmlnLm1heF93aWR0aCAqCisJCQkgICBnZGctPmNsaWVudC5kZXYtPm1vZGVfY29uZmlnLm1h
eF9oZWlnaHQgKiBtYXhfY3BwOworCS8qIGZfZ3VkX2RybSB3aWxsIGttYWxsb2MgYSBidWZmZXIg
b2YgdGhpcyBzaXplICovCisJKm1heF9idWZmZXJfc2l6ZSA9IG1pbl90KHNpemVfdCwgKm1heF9i
dWZmZXJfc2l6ZSwgS01BTExPQ19NQVhfU0laRSk7CisKKwlnZGctPm1heF9idWZmZXJfc2l6ZSA9
ICptYXhfYnVmZmVyX3NpemU7CisJZ2RnLT53b3JrX2J1ZiA9IHZtYWxsb2MoZ2RnLT5tYXhfYnVm
ZmVyX3NpemUpOworCWlmICghZ2RnLT53b3JrX2J1ZikgeworCQlyZXQgPSAtRU5PTUVNOworCQln
b3RvIGVycm9yX3JlbGVhc2U7CisJfQorCisJcmV0ID0gZ3VkX2RybV9nYWRnZXRfZ2V0X3Byb3Bl
cnRpZXMoZ2RnKTsKKwlpZiAocmV0KSB7CisJCXByX2VycigiRmFpbGVkIHRvIGdldCBwcm9wZXJ0
aWVzXG4iKTsKKwkJZ290byBlcnJvcl9yZWxlYXNlOworCX0KKworCXJldCA9IGd1ZF9kcm1fZ2Fk
Z2V0X2dldF9jb25uZWN0b3JzKGdkZyk7CisJaWYgKHJldCkgeworCQlwcl9lcnIoIkZhaWxlZCB0
byBnZXQgY29ubmVjdG9yc1xuIik7CisJCWdvdG8gZXJyb3JfcmVsZWFzZTsKKwl9CisKKwlpZiAo
IWRybV9jbGllbnRfcmVnaXN0ZXIoJmdkZy0+Y2xpZW50KSkgeworCQlwcl9lcnIoIkRSTSBkZXZp
Y2UgaXMgZ29uZVxuIik7CisJCXJldCA9IC1FTk9ERVY7CisJCWdvdG8gZXJyb3JfcmVsZWFzZTsK
Kwl9CisKKwlndWRfZHJtX2dhZGdldF9wcm9iZV9jb25uZWN0b3JzKGdkZyk7CisKKwlyZXR1cm4g
Z2RnOworCitlcnJvcl9yZWxlYXNlOgorCWd1ZF9kcm1fZ2FkZ2V0X2NsaWVudF91bnJlZ2lzdGVy
KCZnZGctPmNsaWVudCk7CisJZ3VkX2RybV9nYWRnZXRfZmluaShnZGcpOworCisJcmV0dXJuIEVS
Ul9QVFIocmV0KTsKK30KK0VYUE9SVF9TWU1CT0woZ3VkX2RybV9nYWRnZXRfaW5pdCk7CisKK3Zv
aWQgZ3VkX2RybV9nYWRnZXRfZmluaShzdHJ1Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZykKK3sKKwli
YWNrbGlnaHRfcHV0KGdkZy0+YmFja2xpZ2h0KTsKKwlndWRfZHJtX2dhZGdldF9wdXQoZ2RnKTsK
K30KK0VYUE9SVF9TWU1CT0woZ3VkX2RybV9nYWRnZXRfZmluaSk7CisKK01PRFVMRV9BVVRIT1Io
Ik5vcmFsZiBUcsO4bm5lcyIpOworTU9EVUxFX0xJQ0VOU0UoIkdQTCIpOwpkaWZmIC0tZ2l0IGEv
aW5jbHVkZS9kcm0vZ3VkX2RybS5oIGIvaW5jbHVkZS9kcm0vZ3VkX2RybS5oCmluZGV4IDM2ZDM1
YmM3Y2ZmMi4uODY4NmI1OTYzMmFmIDEwMDY0NAotLS0gYS9pbmNsdWRlL2RybS9ndWRfZHJtLmgK
KysrIGIvaW5jbHVkZS9kcm0vZ3VkX2RybS5oCkBAIC0zNjEsNCArMzYxLDE3IEBAIHN0YXRpYyBp
bmxpbmUgdm9pZCBndWRfZHJtX3RvX2Rpc3BsYXlfbW9kZShzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9k
ZSAqZHN0LAogCWRybV9tb2RlX3NldF9uYW1lKGRzdCk7CiB9CiAKK3N0cnVjdCBndWRfZHJtX2dh
ZGdldDsKKworc3RydWN0IGd1ZF9kcm1fZ2FkZ2V0ICpndWRfZHJtX2dhZGdldF9pbml0KHVuc2ln
bmVkIGludCBtaW5vcl9pZCwgY29uc3QgY2hhciAqYmFja2xpZ2h0LAorCQkJCQkgICBzaXplX3Qg
Km1heF9idWZmZXJfc2l6ZSk7Cit2b2lkIGd1ZF9kcm1fZ2FkZ2V0X2Zpbmkoc3RydWN0IGd1ZF9k
cm1fZ2FkZ2V0ICpnZGcpOworaW50IGd1ZF9kcm1fZ2FkZ2V0X2Rpc2FibGVfcGlwZShzdHJ1Y3Qg
Z3VkX2RybV9nYWRnZXQgKmdkZyk7CitpbnQgZ3VkX2RybV9nYWRnZXRfY3RybF9nZXQoc3RydWN0
IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcsIHU4IHJlcXVlc3QsCisJCQkgICAgdTE2IGluZGV4LCB2b2lk
ICpkYXRhLCBzaXplX3Qgc2l6ZSk7CitpbnQgZ3VkX2RybV9nYWRnZXRfY3RybF9zZXQoc3RydWN0
IGd1ZF9kcm1fZ2FkZ2V0ICpnZGcsIHU4IHJlcXVlc3QsCisJCQkgICAgdTE2IGluZGV4LCB2b2lk
ICpkYXRhLCBzaXplX3Qgc2l6ZSk7CitpbnQgZ3VkX2RybV9nYWRnZXRfc2V0X2J1ZmZlcihzdHJ1
Y3QgZ3VkX2RybV9nYWRnZXQgKmdkZywgc3RydWN0IGd1ZF9kcm1fcmVxX3NldF9idWZmZXIgKnJl
cSk7CitpbnQgZ3VkX2RybV9nYWRnZXRfd3JpdGVfYnVmZmVyKHN0cnVjdCBndWRfZHJtX2dhZGdl
dCAqZ2RnLCBjb25zdCB2b2lkICpidWYsIHNpemVfdCBsZW4pOworCiAjZW5kaWYKLS0gCjIuMjMu
MAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRl
dmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8v
bGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVsCg==
