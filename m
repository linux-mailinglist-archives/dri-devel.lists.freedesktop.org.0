Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id AFE492C64F3
	for <lists+dri-devel@lfdr.de>; Fri, 27 Nov 2020 13:11:57 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 0A03B6ECA8;
	Fri, 27 Nov 2020 12:10:14 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga09.intel.com (mga09.intel.com [134.134.136.24])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E7A626ECAC;
 Fri, 27 Nov 2020 12:10:07 +0000 (UTC)
IronPort-SDR: Sxn2oYOZjCFpAkMTjJXPASeDf1i6apz6PZBGlJKWE1PI+KV7MzjmzAmKTr7j586PZOfC7aWysV
 c5mV7GLBSBDQ==
X-IronPort-AV: E=McAfee;i="6000,8403,9817"; a="172540768"
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="172540768"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga005.jf.intel.com ([10.7.209.41])
 by orsmga102.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:10:07 -0800
IronPort-SDR: 5U426cH1mLdXPfw8zgn0MGOf9xye9wWx1lLiugMZFNFuHnnxZTLX/hi8nIeAqdpmCpnS1++kh8
 4qjjyFT6PnMA==
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="548029236"
Received: from mjgleeso-mobl.ger.corp.intel.com (HELO
 mwauld-desk1.ger.corp.intel.com) ([10.251.85.2])
 by orsmga005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:10:06 -0800
From: Matthew Auld <matthew.auld@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [RFC PATCH 087/162] drm/i915: Delay publishing objects on the
 eviction lists
Date: Fri, 27 Nov 2020 12:06:03 +0000
Message-Id: <20201127120718.454037-88-matthew.auld@intel.com>
X-Mailer: git-send-email 2.26.2
In-Reply-To: <20201127120718.454037-1-matthew.auld@intel.com>
References: <20201127120718.454037-1-matthew.auld@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@intel.com>,
 dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogVGhvbWFzIEhlbGxzdHLDtm0gPHRob21hcy5oZWxsc3Ryb21AaW50ZWwuY29tPgoKV2hl
biBhbiBvYmplY3QgaXMgcHVibGlzaGVkIG9uIGFuIGV2aWN0aW9uIGxpc3QsIGl0J3MgY29uc2lk
ZXJlZCBmb3IKZXZpY3Rpb24gYW5kIGNhbiBiZSBsb2NrZWQgYnkgb3RoZXIgdGhyZWFkcy4gVGhp
cyBpcyBzdHJpY3RseSBub3QKbmVjZXNzYXJ5IHVudGlsIHRoZSBvYmplY3QgaGFzIHBhZ2VzLiBU
byBsaW1pdCBldmljdGlvbiBsb29rdXBzIHRoYXQKbmVlZCB0byBkaXNjYXJkIHRoZSBvYmplY3Qg
YW5kIGZhY2lsaXRhdGUgYSBsb25nZXIgcGVyaW9kIGR1cmluZwp3aGljaCB3ZSBjYW4gbG9jayB0
aGUgb2JqZWN0IGlzb2xhdGVkICh0cnlsb2NrIG9yIHd3IGxvY2sgd2l0aG91dApjaGFuY2Ugb2Yg
ZGVhZGxvY2sgb3IgaW50ZXJydXB0aW9uKSwgZGVsYXkgZXZpY3Rpb24gbGlzdCBwdWJsaXNoaW5n
CnVudGlsIHBhZ2VzIGFyZSBzZXQuIEFsc28gdGFrZSB0aGUgb2JqZWN0IG9mZiB0aGUgZXZpY3Rp
b24gbGlzdHMgd2hlbgpwYWdlcyBhcmUgdW5zZXQuIEZpbmFsbHkgbWFrZSBzdXJlIHRoYXQgYW4g
b2JqZWN0IGlzIGVpdGhlciBsb2NrZWQgb3IKaXNvbGF0ZWQgd2hlbiBldmljdGlvbiBsaXN0IG1h
bmlwdWxhdGlvbiBoYXBwZW5zLgoKU2lnbmVkLW9mZi1ieTogVGhvbWFzIEhlbGxzdHLDtm0gPHRo
b21hcy5oZWxsc3Ryb21AaW50ZWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBNYWFydGVuIExhbmtob3Jz
dCA8bWFhcnRlbi5sYW5raG9yc3RAbGludXguaW50ZWwuY29tPgpDYzogTWF0dGhldyBBdWxkIDxt
YXR0aGV3LmF1bGRAaW50ZWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1
X2dlbV9vYmplY3QuYyB8ICAyICsrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
cGFnZXMuYyAgfCAyMiArKysrKysrKysrKysrKysrKysrKystCiBkcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fcmVnaW9uLmMgfCAxOCArKy0tLS0tLS0tLS0tLS0tLS0KIDMgZmlsZXMg
Y2hhbmdlZCwgMjUgaW5zZXJ0aW9ucygrKSwgMTcgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jCmluZGV4IDA4ZDgwNmJiZjQ4ZS4uNTMyNmI0
YjVhOWY3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2Jq
ZWN0LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX29iamVjdC5jCkBA
IC02Niw2ICs2Niw3IEBAIHZvaWQgaTkxNV9nZW1fb2JqZWN0X2luaXQoc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKm9iaiwKIAlJTklUX0xJU1RfSEVBRCgmb2JqLT52bWEubGlzdCk7CiAKIAlJ
TklUX0xJU1RfSEVBRCgmb2JqLT5tbS5saW5rKTsKKwlJTklUX0xJU1RfSEVBRCgmb2JqLT5tbS5y
ZWdpb25fbGluayk7CiAKIAlJTklUX0xJU1RfSEVBRCgmb2JqLT5sdXRfbGlzdCk7CiAJc3Bpbl9s
b2NrX2luaXQoJm9iai0+bHV0X2xvY2spOwpAQCAtNzksNiArODAsNyBAQCB2b2lkIGk5MTVfZ2Vt
X29iamVjdF9pbml0KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJR0VNX0JVR19P
TihmbGFncyAmIH5JOTE1X0JPX0FMTE9DX0ZMQUdTKTsKIAlvYmotPmZsYWdzID0gZmxhZ3M7CiAK
KwlvYmotPm1tLnJlZ2lvbiA9IE5VTEw7CiAJb2JqLT5tbS5tYWR2ID0gSTkxNV9NQURWX1dJTExO
RUVEOwogCUlOSVRfUkFESVhfVFJFRSgmb2JqLT5tbS5nZXRfcGFnZS5yYWRpeCwgR0ZQX0tFUk5F
TCB8IF9fR0ZQX05PV0FSTik7CiAJbXV0ZXhfaW5pdCgmb2JqLT5tbS5nZXRfcGFnZS5sb2NrKTsK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9wYWdlcy5jIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX3BhZ2VzLmMKaW5kZXggNGE4YmU3NTk4
MzJiLi5lYWNhZDk3MWI5NTUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9wYWdlcy5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9w
YWdlcy5jCkBAIC0xNiw2ICsxNiw4IEBAIHZvaWQgX19pOTE1X2dlbV9vYmplY3Rfc2V0X3BhZ2Vz
KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiB7CiAJc3RydWN0IGRybV9pOTE1X3By
aXZhdGUgKmk5MTUgPSB0b19pOTE1KG9iai0+YmFzZS5kZXYpOwogCXVuc2lnbmVkIGxvbmcgc3Vw
cG9ydGVkID0gSU5URUxfSU5GTyhpOTE1KS0+cGFnZV9zaXplczsKKwlzdHJ1Y3QgaW50ZWxfbWVt
b3J5X3JlZ2lvbiAqbWVtOworCXN0cnVjdCBsaXN0X2hlYWQgKmxpc3Q7CiAJaW50IGk7CiAKIAlh
c3NlcnRfb2JqZWN0X2hlbGRfc2hhcmVkKG9iaik7CkBAIC02NCw3ICs2Niw2IEBAIHZvaWQgX19p
OTE1X2dlbV9vYmplY3Rfc2V0X3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmos
CiAJR0VNX0JVR19PTighSEFTX1BBR0VfU0laRVMoaTkxNSwgb2JqLT5tbS5wYWdlX3NpemVzLnNn
KSk7CiAKIAlpZiAoaTkxNV9nZW1fb2JqZWN0X2lzX3Nocmlua2FibGUob2JqKSkgewotCQlzdHJ1
Y3QgbGlzdF9oZWFkICpsaXN0OwogCQl1bnNpZ25lZCBsb25nIGZsYWdzOwogCiAJCWFzc2VydF9v
YmplY3RfaGVsZChvYmopOwpAQCAtODIsNiArODMsMTggQEAgdm9pZCBfX2k5MTVfZ2VtX29iamVj
dF9zZXRfcGFnZXMoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKIAkJYXRvbWljX3Nl
dCgmb2JqLT5tbS5zaHJpbmtfcGluLCAwKTsKIAkJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmaTkx
NS0+bW0ub2JqX2xvY2ssIGZsYWdzKTsKIAl9CisKKwltZW0gPSBvYmotPm1tLnJlZ2lvbjsKKwlp
ZiAobWVtKSB7CisJCW11dGV4X2xvY2soJm1lbS0+b2JqZWN0cy5sb2NrKTsKKwkJR0VNX1dBUk5f
T04oIWxpc3RfZW1wdHkoJm9iai0+bW0ucmVnaW9uX2xpbmspKTsKKwkJaWYgKG9iai0+bW0ubWFk
diAhPSBJOTE1X01BRFZfV0lMTE5FRUQpCisJCQlsaXN0ID0gJm1lbS0+b2JqZWN0cy5wdXJnZWFi
bGU7CisJCWVsc2UKKwkJCWxpc3QgPSAmbWVtLT5vYmplY3RzLmxpc3Q7CisJCWxpc3RfbW92ZV90
YWlsKCZvYmotPm1tLnJlZ2lvbl9saW5rLCBsaXN0KTsKKwkJbXV0ZXhfdW5sb2NrKCZtZW0tPm9i
amVjdHMubG9jayk7CisJfQogfQogCiBpbnQgX19fX2k5MTVfZ2VtX29iamVjdF9nZXRfcGFnZXMo
c3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaikKQEAgLTE5Miw2ICsyMDUsNyBAQCBzdGF0
aWMgdm9pZCB1bm1hcF9vYmplY3Qoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwgdm9p
ZCAqcHRyKQogc3RydWN0IHNnX3RhYmxlICoKIF9faTkxNV9nZW1fb2JqZWN0X3Vuc2V0X3BhZ2Vz
KHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmopCiB7CisJc3RydWN0IGludGVsX21lbW9y
eV9yZWdpb24gKm1lbSA9IG9iai0+bW0ucmVnaW9uOwogCXN0cnVjdCBzZ190YWJsZSAqcGFnZXM7
CiAKIAlhc3NlcnRfb2JqZWN0X2hlbGRfc2hhcmVkKG9iaik7CkBAIC0yMDUsNiArMjE5LDEyIEBA
IF9faTkxNV9nZW1fb2JqZWN0X3Vuc2V0X3BhZ2VzKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpvYmopCiAKIAlpOTE1X2dlbV9vYmplY3RfbWFrZV91bnNocmlua2FibGUob2JqKTsKIAorCWlm
IChtZW0pIHsKKwkJbXV0ZXhfbG9jaygmbWVtLT5vYmplY3RzLmxvY2spOworCQlsaXN0X2RlbF9p
bml0KCZvYmotPm1tLnJlZ2lvbl9saW5rKTsKKwkJbXV0ZXhfdW5sb2NrKCZtZW0tPm9iamVjdHMu
bG9jayk7CisJfQorCiAJaWYgKG9iai0+bW0ubWFwcGluZykgewogCQl1bm1hcF9vYmplY3Qob2Jq
LCBwYWdlX21hc2tfYml0cyhvYmotPm1tLm1hcHBpbmcpKTsKIAkJb2JqLT5tbS5tYXBwaW5nID0g
TlVMTDsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9yZWdp
b24uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9yZWdpb24uYwppbmRleCA2
YTk2NzQxMjUzYjMuLjU4YmY1ZjllMzE5OSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5
MTUvZ2VtL2k5MTVfZ2VtX3JlZ2lvbi5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9yZWdpb24uYwpAQCAtMTA1LDMwICsxMDUsMTYgQEAgdm9pZCBpOTE1X2dlbV9vYmpl
Y3RfaW5pdF9tZW1vcnlfcmVnaW9uKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICpvYmosCiAJ
CQkJCXN0cnVjdCBpbnRlbF9tZW1vcnlfcmVnaW9uICptZW0pCiB7CiAJSU5JVF9MSVNUX0hFQUQo
Jm9iai0+bW0uYmxvY2tzKTsKKwlXQVJOX09OKGk5MTVfZ2VtX29iamVjdF9oYXNfcGFnZXMob2Jq
KSk7CiAJb2JqLT5tbS5yZWdpb24gPSBpbnRlbF9tZW1vcnlfcmVnaW9uX2dldChtZW0pOwogCiAJ
aWYgKG9iai0+YmFzZS5zaXplIDw9IG1lbS0+bWluX3BhZ2Vfc2l6ZSkKIAkJb2JqLT5mbGFncyB8
PSBJOTE1X0JPX0FMTE9DX0NPTlRJR1VPVVM7Ci0KLQltdXRleF9sb2NrKCZtZW0tPm9iamVjdHMu
bG9jayk7Ci0KLQlpZiAob2JqLT5mbGFncyAmIEk5MTVfQk9fQUxMT0NfVk9MQVRJTEUpCi0JCWxp
c3RfYWRkKCZvYmotPm1tLnJlZ2lvbl9saW5rLCAmbWVtLT5vYmplY3RzLnB1cmdlYWJsZSk7Ci0J
ZWxzZQotCQlsaXN0X2FkZCgmb2JqLT5tbS5yZWdpb25fbGluaywgJm1lbS0+b2JqZWN0cy5saXN0
KTsKLQotCW11dGV4X3VubG9jaygmbWVtLT5vYmplY3RzLmxvY2spOwogfQogCiB2b2lkIGk5MTVf
Z2VtX29iamVjdF9yZWxlYXNlX21lbW9yeV9yZWdpb24oc3RydWN0IGRybV9pOTE1X2dlbV9vYmpl
Y3QgKm9iaikKIHsKLQlzdHJ1Y3QgaW50ZWxfbWVtb3J5X3JlZ2lvbiAqbWVtID0gb2JqLT5tbS5y
ZWdpb247Ci0KLQltdXRleF9sb2NrKCZtZW0tPm9iamVjdHMubG9jayk7Ci0JbGlzdF9kZWwoJm9i
ai0+bW0ucmVnaW9uX2xpbmspOwotCW11dGV4X3VubG9jaygmbWVtLT5vYmplY3RzLmxvY2spOwot
Ci0JaW50ZWxfbWVtb3J5X3JlZ2lvbl9wdXQobWVtKTsKKwlpbnRlbF9tZW1vcnlfcmVnaW9uX3B1
dChvYmotPm1tLnJlZ2lvbik7CiB9CiAKIHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0ICoKLS0g
CjIuMjYuMgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18K
ZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVsCg==
