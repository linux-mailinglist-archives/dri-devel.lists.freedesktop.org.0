Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C0EE3B8CB3
	for <lists+dri-devel@lfdr.de>; Fri, 20 Sep 2019 10:26:08 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9FF456FB63;
	Fri, 20 Sep 2019 08:26:05 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9A3836FB49;
 Fri, 20 Sep 2019 08:26:03 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id AE9702108;
 Fri, 20 Sep 2019 08:26:02 +0000 (UTC)
Received: from jason-ThinkPad-X1-Carbon-6th.redhat.com
 (ovpn-12-88.pek2.redhat.com [10.72.12.88])
 by smtp.corp.redhat.com (Postfix) with ESMTP id F1F5010016EB;
 Fri, 20 Sep 2019 08:24:32 +0000 (UTC)
From: Jason Wang <jasowang@redhat.com>
To: kvm@vger.kernel.org, linux-s390@vger.kernel.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 intel-gfx@lists.freedesktop.org, intel-gvt-dev@lists.freedesktop.org,
 kwankhede@nvidia.com, alex.williamson@redhat.com, mst@redhat.com,
 tiwei.bie@intel.com
Subject: [RFC PATCH V2 4/6] virtio: introudce a mdev based transport
Date: Fri, 20 Sep 2019 16:20:48 +0800
Message-Id: <20190920082050.19352-5-jasowang@redhat.com>
In-Reply-To: <20190920082050.19352-1-jasowang@redhat.com>
References: <20190920082050.19352-1-jasowang@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.71]); Fri, 20 Sep 2019 08:26:03 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: sebott@linux.ibm.com, airlied@linux.ie, Jason Wang <jasowang@redhat.com>,
 heiko.carstens@de.ibm.com, virtualization@lists.linux-foundation.org,
 rob.miller@broadcom.com, lulu@redhat.com, eperezma@redhat.com,
 pasic@linux.ibm.com, borntraeger@de.ibm.com, haotian.wang@sifive.com,
 zhi.a.wang@intel.com, farman@linux.ibm.com, idos@mellanox.com,
 gor@linux.ibm.com, cunming.liang@intel.com, rodrigo.vivi@intel.com,
 xiao.w.wang@intel.com, freude@linux.ibm.com, zhihong.wang@intel.com,
 akrowiak@linux.ibm.com, pmorel@linux.ibm.com, netdev@vger.kernel.org,
 cohuck@redhat.com, oberpar@linux.ibm.com, maxime.coquelin@redhat.com,
 lingshan.zhu@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRoIGludHJvZHVjZXMgYSBuZXcgbWRldiB0cmFuc3BvcnQgZm9yIHZpcnRpby4gVGhp
cyBpcyB1c2VkIHRvCnVzZSBrZXJuZWwgdmlydGlvIGRyaXZlciB0byBkcml2ZSB0aGUgbWVkaWF0
ZWQgZGV2aWNlIHRoYXQgaXMgY2FwYWJsZQpvZiBwb3B1bGF0aW5nIHZpcnRxdWV1ZSBkaXJlY3Rs
eS4KCkEgbmV3IHZpcnRpby1tZGV2IGRyaXZlciB3aWxsIGJlIHJlZ2lzdGVyZWQgdG8gdGhlIG1k
ZXYgYnVzLCB3aGVuIGEKbmV3IHZpcnRpby1tZGV2IGRldmljZSBpcyBwcm9iZWQsIGl0IHdpbGwg
cmVnaXN0ZXIgdGhlIGRldmljZSB3aXRoCm1kZXYgYmFzZWQgY29uZmlnIG9wcy4gVGhpcyBtZWFu
cywgdW5saWtlIHRoZSBleGlzdCBoYXJkd2FyZQp0cmFuc3BvcnQsIHRoaXMgaXMgYSBzb2Z0d2Fy
ZSB0cmFuc3BvcnQgYmV0d2VlbiBtZGV2IGRyaXZlciBhbmQgbWRldgpkZXZpY2UuIFRoZSB0cmFu
c3BvcnQgd2FzIGltcGxlbWVudGVkIHRocm91Z2ggZGV2aWNlIHNwZWNpZmljIG9wcwp3aGljaCBp
cyBhIHBhcnQgb2YgbWRldl9wYXJlbnRfb3BzIG5vdy4KClNpZ25lZC1vZmYtYnk6IEphc29uIFdh
bmcgPGphc293YW5nQHJlZGhhdC5jb20+Ci0tLQogZHJpdmVycy92ZmlvL21kZXYvS2NvbmZpZyAg
ICAgICB8ICAgNyArCiBkcml2ZXJzL3ZmaW8vbWRldi9NYWtlZmlsZSAgICAgIHwgICAxICsKIGRy
aXZlcnMvdmZpby9tZGV2L3ZpcnRpb19tZGV2LmMgfCA0MTggKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysKIDMgZmlsZXMgY2hhbmdlZCwgNDI2IGluc2VydGlvbnMoKykKIGNyZWF0ZSBt
b2RlIDEwMDY0NCBkcml2ZXJzL3ZmaW8vbWRldi92aXJ0aW9fbWRldi5jCgpkaWZmIC0tZ2l0IGEv
ZHJpdmVycy92ZmlvL21kZXYvS2NvbmZpZyBiL2RyaXZlcnMvdmZpby9tZGV2L0tjb25maWcKaW5k
ZXggNWRhMjdmMjEwMGY5Li5jNDg4YzMxZmMxMzcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvdmZpby9t
ZGV2L0tjb25maWcKKysrIGIvZHJpdmVycy92ZmlvL21kZXYvS2NvbmZpZwpAQCAtMTYsMyArMTYs
MTAgQEAgY29uZmlnIFZGSU9fTURFVl9ERVZJQ0UKIAlkZWZhdWx0IG4KIAloZWxwCiAJICBWRklP
IGJhc2VkIGRyaXZlciBmb3IgTWVkaWF0ZWQgZGV2aWNlcy4KKworY29uZmlnIFZJUlRJT19NREVW
X0RFVklDRQorCXRyaXN0YXRlICJWSVJUSU8gZHJpdmVyIGZvciBNZWRpYXRlZCBkZXZpY2VzIgor
CWRlcGVuZHMgb24gVkZJT19NREVWICYmIFZJUlRJTworCWRlZmF1bHQgbgorCWhlbHAKKwkgIFZJ
UlRJTyBiYXNlZCBkcml2ZXIgZm9yIE1lZGlhdGVkIGRldmljZXMuCmRpZmYgLS1naXQgYS9kcml2
ZXJzL3ZmaW8vbWRldi9NYWtlZmlsZSBiL2RyaXZlcnMvdmZpby9tZGV2L01ha2VmaWxlCmluZGV4
IDEwMTUxNmZkZjM3NS4uOTlkMzFlMjljMjNlIDEwMDY0NAotLS0gYS9kcml2ZXJzL3ZmaW8vbWRl
di9NYWtlZmlsZQorKysgYi9kcml2ZXJzL3ZmaW8vbWRldi9NYWtlZmlsZQpAQCAtNCwzICs0LDQg
QEAgbWRldi15IDo9IG1kZXZfY29yZS5vIG1kZXZfc3lzZnMubyBtZGV2X2RyaXZlci5vCiAKIG9i
ai0kKENPTkZJR19WRklPX01ERVYpICs9IG1kZXYubwogb2JqLSQoQ09ORklHX1ZGSU9fTURFVl9E
RVZJQ0UpICs9IHZmaW9fbWRldi5vCitvYmotJChDT05GSUdfVklSVElPX01ERVZfREVWSUNFKSAr
PSB2aXJ0aW9fbWRldi5vCmRpZmYgLS1naXQgYS9kcml2ZXJzL3ZmaW8vbWRldi92aXJ0aW9fbWRl
di5jIGIvZHJpdmVycy92ZmlvL21kZXYvdmlydGlvX21kZXYuYwpuZXcgZmlsZSBtb2RlIDEwMDY0
NAppbmRleCAwMDAwMDAwMDAwMDAuLmNlZTczZmUzOTJiYgotLS0gL2Rldi9udWxsCisrKyBiL2Ry
aXZlcnMvdmZpby9tZGV2L3ZpcnRpb19tZGV2LmMKQEAgLTAsMCArMSw0MTggQEAKKy8vIFNQRFgt
TGljZW5zZS1JZGVudGlmaWVyOiBHUEwtMi4wLW9ubHkKKy8qCisgKiBWSVJUSU8gYmFzZWQgZHJp
dmVyIGZvciBNZWRpYXRlZCBkZXZpY2UKKyAqCisgKiBDb3B5cmlnaHQgKGMpIDIwMTksIFJlZCBI
YXQuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCisgKiAgICAgQXV0aG9yOiBKYXNvbiBXYW5nIDxqYXNv
d2FuZ0ByZWRoYXQuY29tPgorICoKKyAqLworCisjaW5jbHVkZSA8bGludXgvaW5pdC5oPgorI2lu
Y2x1ZGUgPGxpbnV4L21vZHVsZS5oPgorI2luY2x1ZGUgPGxpbnV4L2RldmljZS5oPgorI2luY2x1
ZGUgPGxpbnV4L2tlcm5lbC5oPgorI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxs
aW51eC91dWlkLmg+CisjaW5jbHVkZSA8bGludXgvbWRldi5oPgorI2luY2x1ZGUgPGxpbnV4L3Zp
cnRpb19tZGV2Lmg+CisjaW5jbHVkZSA8bGludXgvdmlydGlvLmg+CisjaW5jbHVkZSA8bGludXgv
dmlydGlvX2NvbmZpZy5oPgorI2luY2x1ZGUgPGxpbnV4L3ZpcnRpb19yaW5nLmg+CisjaW5jbHVk
ZSAibWRldl9wcml2YXRlLmgiCisKKyNkZWZpbmUgRFJJVkVSX1ZFUlNJT04gICIwLjEiCisjZGVm
aW5lIERSSVZFUl9BVVRIT1IgICAiUmVkIEhhdCBDb3Jwb3JhdGlvbiIKKyNkZWZpbmUgRFJJVkVS
X0RFU0MgICAgICJWSVJUSU8gYmFzZWQgZHJpdmVyIGZvciBNZWRpYXRlZCBkZXZpY2UiCisKKyNk
ZWZpbmUgdG9fdmlydGlvX21kZXZfZGV2aWNlKGRldikgXAorCWNvbnRhaW5lcl9vZihkZXYsIHN0
cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UsIHZkZXYpCisKK3N0cnVjdCB2aXJ0aW9fbWRldl9kZXZp
Y2UgeworCXN0cnVjdCB2aXJ0aW9fZGV2aWNlIHZkZXY7CisJc3RydWN0IG1kZXZfZGV2aWNlICpt
ZGV2OworCXVuc2lnbmVkIGxvbmcgdmVyc2lvbjsKKworCXN0cnVjdCB2aXJ0cXVldWUgKip2cXM7
CisJc3BpbmxvY2tfdCBsb2NrOworfTsKKworc3RydWN0IHZpcnRpb19tZGV2X3ZxX2luZm8gewor
CS8qIHRoZSBhY3R1YWwgdmlydHF1ZXVlICovCisJc3RydWN0IHZpcnRxdWV1ZSAqdnE7CisKKwkv
KiB0aGUgbGlzdCBub2RlIGZvciB0aGUgdmlydHF1ZXVlcyBsaXN0ICovCisJc3RydWN0IGxpc3Rf
aGVhZCBub2RlOworfTsKKworc3RhdGljIHN0cnVjdCBtZGV2X2RldmljZSAqdm1fZ2V0X21kZXYo
c3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7CisJc3RydWN0IHZpcnRpb19tZGV2X2Rldmlj
ZSAqdm1fZGV2ID0gdG9fdmlydGlvX21kZXZfZGV2aWNlKHZkZXYpOworCXN0cnVjdCBtZGV2X2Rl
dmljZSAqbWRldiA9IHZtX2Rldi0+bWRldjsKKworCXJldHVybiBtZGV2OworfQorCitzdGF0aWMg
Y29uc3Qgc3RydWN0IHZpcnRpb19tZGV2X3BhcmVudF9vcHMKKyptZGV2X2dldF9wYXJlbnRfb3Bz
KHN0cnVjdCBtZGV2X2RldmljZSAqbWRldikKK3sKKwlzdHJ1Y3QgbWRldl9wYXJlbnQgKnBhcmVu
dCA9IG1kZXYtPnBhcmVudDsKKworCXJldHVybiBwYXJlbnQtPm9wcy0+ZGV2aWNlX29wczsKK30K
Kworc3RhdGljIHZvaWQgdmlydGlvX21kZXZfZ2V0KHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2
LCB1bnNpZ25lZCBvZmZzZXQsCisJCQkgICAgdm9pZCAqYnVmLCB1bnNpZ25lZCBsZW4pCit7CisJ
c3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3Ry
dWN0IHZpcnRpb19tZGV2X3BhcmVudF9vcHMgKm9wcyA9IG1kZXZfZ2V0X3BhcmVudF9vcHMobWRl
dik7CisKKwlvcHMtPmdldF9jb25maWcobWRldiwgb2Zmc2V0LCBidWYsIGxlbik7Cit9CisKK3N0
YXRpYyB2b2lkIHZpcnRpb19tZGV2X3NldChzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldiwgdW5z
aWduZWQgb2Zmc2V0LAorCQkJICAgIGNvbnN0IHZvaWQgKmJ1ZiwgdW5zaWduZWQgbGVuKQorewor
CXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0
cnVjdCB2aXJ0aW9fbWRldl9wYXJlbnRfb3BzICpvcHMgPSBtZGV2X2dldF9wYXJlbnRfb3BzKG1k
ZXYpOworCisJb3BzLT5zZXRfY29uZmlnKG1kZXYsIG9mZnNldCwgYnVmLCBsZW4pOworfQorCitz
dGF0aWMgdTMyIHZpcnRpb19tZGV2X2dlbmVyYXRpb24oc3RydWN0IHZpcnRpb19kZXZpY2UgKnZk
ZXYpCit7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJ
Y29uc3Qgc3RydWN0IHZpcnRpb19tZGV2X3BhcmVudF9vcHMgKm9wcyA9IG1kZXZfZ2V0X3BhcmVu
dF9vcHMobWRldik7CisKKwlyZXR1cm4gb3BzLT5nZXRfZ2VuZXJhdGlvbihtZGV2KTsKK30KKwor
c3RhdGljIHU4IHZpcnRpb19tZGV2X2dldF9zdGF0dXMoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZk
ZXYpCit7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJ
Y29uc3Qgc3RydWN0IHZpcnRpb19tZGV2X3BhcmVudF9vcHMgKm9wcyA9IG1kZXZfZ2V0X3BhcmVu
dF9vcHMobWRldik7CisKKwlyZXR1cm4gb3BzLT5nZXRfc3RhdHVzKG1kZXYpOworfQorCitzdGF0
aWMgdm9pZCB2aXJ0aW9fbWRldl9zZXRfc3RhdHVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2
LCB1OCBzdGF0dXMpCit7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYo
dmRldik7CisJY29uc3Qgc3RydWN0IHZpcnRpb19tZGV2X3BhcmVudF9vcHMgKm9wcyA9IG1kZXZf
Z2V0X3BhcmVudF9vcHMobWRldik7CisKKwlyZXR1cm4gb3BzLT5zZXRfc3RhdHVzKG1kZXYsIHN0
YXR1cyk7Cit9CisKK3N0YXRpYyB2b2lkIHZpcnRpb19tZGV2X3Jlc2V0KHN0cnVjdCB2aXJ0aW9f
ZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2
KHZkZXYpOworCWNvbnN0IHN0cnVjdCB2aXJ0aW9fbWRldl9wYXJlbnRfb3BzICpvcHMgPSBtZGV2
X2dldF9wYXJlbnRfb3BzKG1kZXYpOworCisJcmV0dXJuIG9wcy0+c2V0X3N0YXR1cyhtZGV2LCAw
KTsKK30KKworc3RhdGljIGJvb2wgdmlydGlvX21kZXZfbm90aWZ5KHN0cnVjdCB2aXJ0cXVldWUg
KnZxKQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZxLT52ZGV2
KTsKKwljb25zdCBzdHJ1Y3QgdmlydGlvX21kZXZfcGFyZW50X29wcyAqb3BzID0gbWRldl9nZXRf
cGFyZW50X29wcyhtZGV2KTsKKworCW9wcy0+a2lja192cShtZGV2LCB2cS0+aW5kZXgpOworCisJ
cmV0dXJuIHRydWU7Cit9CisKK3N0YXRpYyBpcnFyZXR1cm5fdCB2aXJ0aW9fbWRldl9jb25maWdf
Y2Iodm9pZCAqcHJpdmF0ZSkKK3sKKwlzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlICp2bV9kZXYg
PSBwcml2YXRlOworCisJdmlydGlvX2NvbmZpZ19jaGFuZ2VkKCZ2bV9kZXYtPnZkZXYpOworCisJ
cmV0dXJuIElSUV9IQU5ETEVEOworfQorCitzdGF0aWMgaXJxcmV0dXJuX3QgdmlydGlvX21kZXZf
dmlydHF1ZXVlX2NiKHZvaWQgKnByaXZhdGUpCit7CisJc3RydWN0IHZpcnRpb19tZGV2X3ZxX2lu
Zm8gKmluZm8gPSBwcml2YXRlOworCisJcmV0dXJuIHZyaW5nX2ludGVycnVwdCgwLCBpbmZvLT52
cSk7Cit9CisKKy8qIEZJWE1FOiByZXR1cm4gKi8KK3N0YXRpYyBzdHJ1Y3QgdmlydHF1ZXVlICoK
K3ZpcnRpb19tZGV2X3NldHVwX3ZxKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2LCB1bnNpZ25l
ZCBpbmRleCwKKwkJICAgICB2b2lkICgqY2FsbGJhY2spKHN0cnVjdCB2aXJ0cXVldWUgKnZxKSwK
KwkJICAgICBjb25zdCBjaGFyICpuYW1lLCBib29sIGN0eCkKK3sKKwlzdHJ1Y3QgbWRldl9kZXZp
Y2UgKm1kZXYgPSB2bV9nZXRfbWRldih2ZGV2KTsKKwljb25zdCBzdHJ1Y3QgdmlydGlvX21kZXZf
cGFyZW50X29wcyAqb3BzID0gbWRldl9nZXRfcGFyZW50X29wcyhtZGV2KTsKKwlzdHJ1Y3Qgdmly
dGlvX21kZXZfdnFfaW5mbyAqaW5mbzsKKwlzdHJ1Y3QgdmlydGlvX21kZXZfY2FsbGJhY2sgY2I7
CisJc3RydWN0IHZpcnRxdWV1ZSAqdnE7CisJdTMyIGFsaWduLCBudW07CisJdTY0IGRlc2NfYWRk
ciwgZHJpdmVyX2FkZHIsIGRldmljZV9hZGRyOworCWludCBlcnI7CisKKwlpZiAoIW5hbWUpCisJ
CXJldHVybiBOVUxMOworCisJLyogUXVldWUgc2hvdWxkbid0IGFscmVhZHkgYmUgc2V0IHVwLiAq
LworCWlmIChvcHMtPmdldF92cV9yZWFkeShtZGV2LCBpbmRleCkpIHsKKwkJZXJyID0gLUVOT0VO
VDsKKwkJZ290byBlcnJvcl9hdmFpbGFibGU7CisJfQorCisJLyogQWxsb2NhdGUgYW5kIGZpbGwg
b3V0IG91ciBhY3RpdmUgcXVldWUgZGVzY3JpcHRpb24gKi8KKwlpbmZvID0ga21hbGxvYyhzaXpl
b2YoKmluZm8pLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWluZm8pIHsKKwkJZXJyID0gLUVOT01FTTsK
KwkJZ290byBlcnJvcl9rbWFsbG9jOworCX0KKworCW51bSA9IG9wcy0+Z2V0X3F1ZXVlX21heCht
ZGV2KTsKKwlpZiAobnVtID09IDApIHsKKwkJZXJyID0gLUVOT0VOVDsKKwkJZ290byBlcnJvcl9u
ZXdfdmlydHF1ZXVlOworCX0KKworCS8qIENyZWF0ZSB0aGUgdnJpbmcgKi8KKwlhbGlnbiA9IG9w
cy0+Z2V0X3ZxX2FsaWduKG1kZXYpOworCXZxID0gdnJpbmdfY3JlYXRlX3ZpcnRxdWV1ZShpbmRl
eCwgbnVtLCBhbGlnbiwgdmRldiwKKwkJCQkgICAgdHJ1ZSwgdHJ1ZSwgY3R4LAorCQkJCSAgICB2
aXJ0aW9fbWRldl9ub3RpZnksIGNhbGxiYWNrLCBuYW1lKTsKKwlpZiAoIXZxKSB7CisJCWVyciA9
IC1FTk9NRU07CisJCWdvdG8gZXJyb3JfbmV3X3ZpcnRxdWV1ZTsKKwl9CisKKwkvKiBTZXR1cCB2
aXJ0cXVldWUgY2FsbGJhY2sgKi8KKwljYi5jYWxsYmFjayA9IHZpcnRpb19tZGV2X3ZpcnRxdWV1
ZV9jYjsKKwljYi5wcml2YXRlID0gaW5mbzsKKwlvcHMtPnNldF92cV9jYihtZGV2LCBpbmRleCwg
JmNiKTsKKwlvcHMtPnNldF92cV9udW0obWRldiwgaW5kZXgsIHZpcnRxdWV1ZV9nZXRfdnJpbmdf
c2l6ZSh2cSkpOworCisJZGVzY19hZGRyID0gdmlydHF1ZXVlX2dldF9kZXNjX2FkZHIodnEpOwor
CWRyaXZlcl9hZGRyID0gdmlydHF1ZXVlX2dldF9hdmFpbF9hZGRyKHZxKTsKKwlkZXZpY2VfYWRk
ciA9IHZpcnRxdWV1ZV9nZXRfdXNlZF9hZGRyKHZxKTsKKworCWlmIChvcHMtPnNldF92cV9hZGRy
ZXNzKG1kZXYsIGluZGV4LAorCQkJCWRlc2NfYWRkciwgZHJpdmVyX2FkZHIsCisJCQkJZGV2aWNl
X2FkZHIpKSB7CisJCWVyciA9IC1FSU5WQUw7CisJCWdvdG8gZXJyX3ZxOworCX0KKworCW9wcy0+
c2V0X3ZxX3JlYWR5KG1kZXYsIGluZGV4LCAxKTsKKworCXZxLT5wcml2ID0gaW5mbzsKKwlpbmZv
LT52cSA9IHZxOworCisJcmV0dXJuIHZxOworCitlcnJfdnE6CisJdnJpbmdfZGVsX3ZpcnRxdWV1
ZSh2cSk7CitlcnJvcl9uZXdfdmlydHF1ZXVlOgorCW9wcy0+c2V0X3ZxX3JlYWR5KG1kZXYsIGlu
ZGV4LCAwKTsKKwlXQVJOX09OKG9wcy0+Z2V0X3ZxX3JlYWR5KG1kZXYsIGluZGV4KSk7CisJa2Zy
ZWUoaW5mbyk7CitlcnJvcl9rbWFsbG9jOgorZXJyb3JfYXZhaWxhYmxlOgorCXJldHVybiBFUlJf
UFRSKGVycik7CisKK30KKworc3RhdGljIHZvaWQgdmlydGlvX21kZXZfZGVsX3ZxKHN0cnVjdCB2
aXJ0cXVldWUgKnZxKQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2
KHZxLT52ZGV2KTsKKwljb25zdCBzdHJ1Y3QgdmlydGlvX21kZXZfcGFyZW50X29wcyAqb3BzID0g
bWRldl9nZXRfcGFyZW50X29wcyhtZGV2KTsKKwlzdHJ1Y3QgdmlydGlvX21kZXZfdnFfaW5mbyAq
aW5mbyA9IHZxLT5wcml2OworCXVuc2lnbmVkIGludCBpbmRleCA9IHZxLT5pbmRleDsKKworCS8q
IFNlbGVjdCBhbmQgZGVhY3RpdmF0ZSB0aGUgcXVldWUgKi8KKwlvcHMtPnNldF92cV9yZWFkeSht
ZGV2LCBpbmRleCwgMCk7CisJV0FSTl9PTihvcHMtPmdldF92cV9yZWFkeShtZGV2LCBpbmRleCkp
OworCisJdnJpbmdfZGVsX3ZpcnRxdWV1ZSh2cSk7CisKKwlrZnJlZShpbmZvKTsKK30KKworc3Rh
dGljIHZvaWQgdmlydGlvX21kZXZfZGVsX3ZxcyhzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldikK
K3sKKwlzdHJ1Y3QgdmlydHF1ZXVlICp2cSwgKm47CisKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X3Nh
ZmUodnEsIG4sICZ2ZGV2LT52cXMsIGxpc3QpCisJCXZpcnRpb19tZGV2X2RlbF92cSh2cSk7CisK
KwlyZXR1cm47Cit9CisKK3N0YXRpYyBpbnQgdmlydGlvX21kZXZfZmluZF92cXMoc3RydWN0IHZp
cnRpb19kZXZpY2UgKnZkZXYsIHVuc2lnbmVkIG52cXMsCisJCQkJc3RydWN0IHZpcnRxdWV1ZSAq
dnFzW10sCisJCQkJdnFfY2FsbGJhY2tfdCAqY2FsbGJhY2tzW10sCisJCQkJY29uc3QgY2hhciAq
IGNvbnN0IG5hbWVzW10sCisJCQkJY29uc3QgYm9vbCAqY3R4LAorCQkJCXN0cnVjdCBpcnFfYWZm
aW5pdHkgKmRlc2MpCit7CisJc3RydWN0IHZpcnRpb19tZGV2X2RldmljZSAqdm1fZGV2ID0gdG9f
dmlydGlvX21kZXZfZGV2aWNlKHZkZXYpOworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZt
X2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCB2aXJ0aW9fbWRldl9wYXJlbnRfb3BzICpv
cHMgPSBtZGV2X2dldF9wYXJlbnRfb3BzKG1kZXYpOworCXN0cnVjdCB2aXJ0aW9fbWRldl9jYWxs
YmFjayBjYjsKKwlpbnQgaSwgZXJyLCBxdWV1ZV9pZHggPSAwOworCXZtX2Rldi0+dnFzID0ga21h
bGxvY19hcnJheShxdWV1ZV9pZHgsIHNpemVvZigqdm1fZGV2LT52cXMpLAorCQkJCSAgICBHRlBf
S0VSTkVMKTsKKwlpZiAoIXZtX2Rldi0+dnFzKQorCQlyZXR1cm4gLUVOT01FTTsKKworCWZvciAo
aSA9IDA7IGkgPCBudnFzOyArK2kpIHsKKwkJaWYgKCFuYW1lc1tpXSkgeworCQkJdnFzW2ldID0g
TlVMTDsKKwkJCWNvbnRpbnVlOworCQl9CisKKwkJdnFzW2ldID0gdmlydGlvX21kZXZfc2V0dXBf
dnEodmRldiwgcXVldWVfaWR4KyssCisJCQkJCSAgICAgIGNhbGxiYWNrc1tpXSwgbmFtZXNbaV0s
IGN0eCA/CisJCQkJCSAgICAgIGN0eFtpXSA6IGZhbHNlKTsKKwkJaWYgKElTX0VSUih2cXNbaV0p
KSB7CisJCQllcnIgPSBQVFJfRVJSKHZxc1tpXSk7CisJCQlnb3RvIGVycl9zZXR1cF92cTsKKwkJ
fQorCX0KKworCWNiLmNhbGxiYWNrID0gdmlydGlvX21kZXZfY29uZmlnX2NiOworCWNiLnByaXZh
dGUgPSB2bV9kZXY7CisJb3BzLT5zZXRfY29uZmlnX2NiKG1kZXYsICZjYik7CisKKwlyZXR1cm4g
MDsKKworZXJyX3NldHVwX3ZxOgorCWtmcmVlKHZtX2Rldi0+dnFzKTsKKwl2aXJ0aW9fbWRldl9k
ZWxfdnFzKHZkZXYpOworCXJldHVybiBlcnI7Cit9CisKK3N0YXRpYyB1NjQgdmlydGlvX21kZXZf
Z2V0X2ZlYXR1cmVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCBtZGV2
X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCB2aXJ0aW9f
bWRldl9wYXJlbnRfb3BzICpvcHMgPSBtZGV2X2dldF9wYXJlbnRfb3BzKG1kZXYpOworCisJcmV0
dXJuIG9wcy0+Z2V0X2ZlYXR1cmVzKG1kZXYpOworfQorCitzdGF0aWMgaW50IHZpcnRpb19tZGV2
X2ZpbmFsaXplX2ZlYXR1cmVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVj
dCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCB2
aXJ0aW9fbWRldl9wYXJlbnRfb3BzICpvcHMgPSBtZGV2X2dldF9wYXJlbnRfb3BzKG1kZXYpOwor
CisJLyogR2l2ZSB2aXJ0aW9fcmluZyBhIGNoYW5jZSB0byBhY2NlcHQgZmVhdHVyZXMuICovCisJ
dnJpbmdfdHJhbnNwb3J0X2ZlYXR1cmVzKHZkZXYpOworCisJcmV0dXJuIG9wcy0+c2V0X2ZlYXR1
cmVzKG1kZXYsIHZkZXYtPmZlYXR1cmVzKTsKK30KKworc3RhdGljIGNvbnN0IGNoYXIgKnZpcnRp
b19tZGV2X2J1c19uYW1lKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVjdCB2
aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2RldiA9IHRvX3ZpcnRpb19tZGV2X2RldmljZSh2ZGV2KTsK
KwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9kZXYtPm1kZXY7CisKKwlyZXR1cm4gZGV2
X25hbWUoJm1kZXYtPmRldik7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3QgdmlydGlvX2NvbmZp
Z19vcHMgdmlydGlvX21kZXZfY29uZmlnX29wcyA9IHsKKwkuZ2V0CQk9IHZpcnRpb19tZGV2X2dl
dCwKKwkuc2V0CQk9IHZpcnRpb19tZGV2X3NldCwKKwkuZ2VuZXJhdGlvbgk9IHZpcnRpb19tZGV2
X2dlbmVyYXRpb24sCisJLmdldF9zdGF0dXMJPSB2aXJ0aW9fbWRldl9nZXRfc3RhdHVzLAorCS5z
ZXRfc3RhdHVzCT0gdmlydGlvX21kZXZfc2V0X3N0YXR1cywKKwkucmVzZXQJCT0gdmlydGlvX21k
ZXZfcmVzZXQsCisJLmZpbmRfdnFzCT0gdmlydGlvX21kZXZfZmluZF92cXMsCisJLmRlbF92cXMJ
PSB2aXJ0aW9fbWRldl9kZWxfdnFzLAorCS5nZXRfZmVhdHVyZXMJPSB2aXJ0aW9fbWRldl9nZXRf
ZmVhdHVyZXMsCisJLmZpbmFsaXplX2ZlYXR1cmVzID0gdmlydGlvX21kZXZfZmluYWxpemVfZmVh
dHVyZXMsCisJLmJ1c19uYW1lCT0gdmlydGlvX21kZXZfYnVzX25hbWUsCit9OworCitzdGF0aWMg
dm9pZCB2aXJ0aW9fbWRldl9yZWxlYXNlX2RldihzdHJ1Y3QgZGV2aWNlICpfZCkKK3sKKwlzdHJ1
Y3QgdmlydGlvX2RldmljZSAqdmRldiA9CisJICAgICAgIGNvbnRhaW5lcl9vZihfZCwgc3RydWN0
IHZpcnRpb19kZXZpY2UsIGRldik7CisJc3RydWN0IHZpcnRpb19tZGV2X2RldmljZSAqdm1fZGV2
ID0KKwkgICAgICAgY29udGFpbmVyX29mKHZkZXYsIHN0cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2Us
IHZkZXYpOworCisJZGV2bV9rZnJlZShfZCwgdm1fZGV2KTsKK30KKworc3RhdGljIGludCB2aXJ0
aW9fbWRldl9wcm9iZShzdHJ1Y3QgZGV2aWNlICpkZXYpCit7CisJc3RydWN0IG1kZXZfZGV2aWNl
ICptZGV2ID0gdG9fbWRldl9kZXZpY2UoZGV2KTsKKwljb25zdCBzdHJ1Y3QgdmlydGlvX21kZXZf
cGFyZW50X29wcyAqb3BzID0gbWRldl9nZXRfcGFyZW50X29wcyhtZGV2KTsKKwlzdHJ1Y3Qgdmly
dGlvX21kZXZfZGV2aWNlICp2bV9kZXY7CisJaW50IHJjOworCisJdm1fZGV2ID0gZGV2bV9remFs
bG9jKGRldiwgc2l6ZW9mKCp2bV9kZXYpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIXZtX2RldikKKwkJ
cmV0dXJuIC1FTk9NRU07CisKKwl2bV9kZXYtPnZkZXYuZGV2LnBhcmVudCA9IGRldjsKKwl2bV9k
ZXYtPnZkZXYuZGV2LnJlbGVhc2UgPSB2aXJ0aW9fbWRldl9yZWxlYXNlX2RldjsKKwl2bV9kZXYt
PnZkZXYuY29uZmlnID0gJnZpcnRpb19tZGV2X2NvbmZpZ19vcHM7CisJdm1fZGV2LT5tZGV2ID0g
bWRldjsKKwl2bV9kZXYtPnZxcyA9IE5VTEw7CisJc3Bpbl9sb2NrX2luaXQoJnZtX2Rldi0+bG9j
ayk7CisKKwl2bV9kZXYtPnZlcnNpb24gPSBvcHMtPmdldF92ZXJzaW9uKG1kZXYpOworCWlmICh2
bV9kZXYtPnZlcnNpb24gIT0gMSkgeworCQlkZXZfZXJyKGRldiwgIlZlcnNpb24gJWxkIG5vdCBz
dXBwb3J0ZWQhXG4iLAorCQkJdm1fZGV2LT52ZXJzaW9uKTsKKwkJcmV0dXJuIC1FTlhJTzsKKwl9
CisKKwl2bV9kZXYtPnZkZXYuaWQuZGV2aWNlID0gb3BzLT5nZXRfZGV2aWNlX2lkKG1kZXYpOwor
CWlmICh2bV9kZXYtPnZkZXYuaWQuZGV2aWNlID09IDApCisJCXJldHVybiAtRU5PREVWOworCisJ
dm1fZGV2LT52ZGV2LmlkLnZlbmRvciA9IG9wcy0+Z2V0X3ZlbmRvcl9pZChtZGV2KTsKKwlyYyA9
IHJlZ2lzdGVyX3ZpcnRpb19kZXZpY2UoJnZtX2Rldi0+dmRldik7CisJaWYgKHJjKQorCQlwdXRf
ZGV2aWNlKGRldik7CisKKwlkZXZfc2V0X2RydmRhdGEoZGV2LCB2bV9kZXYpOworCisJcmV0dXJu
IHJjOworCit9CisKK3N0YXRpYyB2b2lkIHZpcnRpb19tZGV2X3JlbW92ZShzdHJ1Y3QgZGV2aWNl
ICpkZXYpCit7CisJc3RydWN0IHZpcnRpb19tZGV2X2RldmljZSAqdm1fZGV2ID0gZGV2X2dldF9k
cnZkYXRhKGRldik7CisKKwl1bnJlZ2lzdGVyX3ZpcnRpb19kZXZpY2UoJnZtX2Rldi0+dmRldik7
Cit9CisKK3N0YXRpYyBzdHJ1Y3QgbWRldl9jbGFzc19pZCBpZF90YWJsZVtdID0geworCXsgTURF
Vl9JRF9WSVJUSU8gfSwKKwl7IDAgfSwKK307CisKK3N0YXRpYyBzdHJ1Y3QgbWRldl9kcml2ZXIg
dmlydGlvX21kZXZfZHJpdmVyID0geworCS5uYW1lCT0gInZpcnRpb19tZGV2IiwKKwkucHJvYmUJ
PSB2aXJ0aW9fbWRldl9wcm9iZSwKKwkucmVtb3ZlCT0gdmlydGlvX21kZXZfcmVtb3ZlLAorCS5p
ZF90YWJsZSA9IGlkX3RhYmxlLAorfTsKKworc3RhdGljIGludCBfX2luaXQgdmlydGlvX21kZXZf
aW5pdCh2b2lkKQoreworCXJldHVybiBtZGV2X3JlZ2lzdGVyX2RyaXZlcigmdmlydGlvX21kZXZf
ZHJpdmVyLCBUSElTX01PRFVMRSk7Cit9CisKK3N0YXRpYyB2b2lkIF9fZXhpdCB2aXJ0aW9fbWRl
dl9leGl0KHZvaWQpCit7CisJbWRldl91bnJlZ2lzdGVyX2RyaXZlcigmdmlydGlvX21kZXZfZHJp
dmVyKTsKK30KKworbW9kdWxlX2luaXQodmlydGlvX21kZXZfaW5pdCkKK21vZHVsZV9leGl0KHZp
cnRpb19tZGV2X2V4aXQpCisKK01PRFVMRV9WRVJTSU9OKERSSVZFUl9WRVJTSU9OKTsKK01PRFVM
RV9MSUNFTlNFKCJHUEwgdjIiKTsKK01PRFVMRV9BVVRIT1IoRFJJVkVSX0FVVEhPUik7CitNT0RV
TEVfREVTQ1JJUFRJT04oRFJJVkVSX0RFU0MpOwotLSAKMi4xOS4xCgpfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRy
aS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5v
cmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWw=
