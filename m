Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 4F56EA3160
	for <lists+dri-devel@lfdr.de>; Fri, 30 Aug 2019 09:43:35 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8B87D6E0F1;
	Fri, 30 Aug 2019 07:43:32 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
X-Greylist: delayed 301 seconds by postgrey-1.36 at gabe;
 Fri, 30 Aug 2019 07:43:30 UTC
Received: from mailgw01.mediatek.com (unknown [210.61.82.183])
 by gabe.freedesktop.org (Postfix) with ESMTP id 879D66E0F1
 for <dri-devel@lists.freedesktop.org>; Fri, 30 Aug 2019 07:43:30 +0000 (UTC)
X-UUID: e61a9e31527d4d778db0297696002992-20190830
X-UUID: e61a9e31527d4d778db0297696002992-20190830
Received: from mtkcas07.mediatek.inc [(172.21.101.84)] by mailgw01.mediatek.com
 (envelope-from <bibby.hsieh@mediatek.com>)
 (Cellopoint E-mail Firewall v4.1.10 Build 0809 with TLS)
 with ESMTP id 454965638; Fri, 30 Aug 2019 15:38:24 +0800
Received: from mtkcas08.mediatek.inc (172.21.101.126) by
 mtkmbs05n1.mediatek.inc (172.21.101.15) with Microsoft SMTP Server (TLS) id
 15.0.1395.4; Fri, 30 Aug 2019 15:38:28 +0800
Received: from mtksdccf07.mediatek.inc (172.21.84.99) by mtkcas08.mediatek.inc
 (172.21.101.73) with Microsoft SMTP Server id 15.0.1395.4 via
 Frontend Transport; Fri, 30 Aug 2019 15:38:28 +0800
From: Bibby Hsieh <bibby.hsieh@mediatek.com>
To: David Airlie <airlied@linux.ie>, Matthias Brugger
 <matthias.bgg@gmail.com>, Daniel Vetter <daniel.vetter@ffwll.ch>,
 <dri-devel@lists.freedesktop.org>, <linux-mediatek@lists.infradead.org>
Subject: [PATCH 1/2] drm/mediatek: Only block updates to CRTCs that have a
 pending update
Date: Fri, 30 Aug 2019 15:38:18 +0800
Message-ID: <20190830073819.16566-2-bibby.hsieh@mediatek.com>
X-Mailer: git-send-email 2.18.0
In-Reply-To: <20190830073819.16566-1-bibby.hsieh@mediatek.com>
References: <20190830073819.16566-1-bibby.hsieh@mediatek.com>
MIME-Version: 1.0
X-MTK: N
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: drinkcat@chromium.org, linux-kernel@vger.kernel.org, tfiga@chromium.org,
 Thierry Reding <thierry.reding@gmail.com>,
 linux-arm-kernel@lists.infradead.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

Q3VycmVudGx5IHdlIHVzZSBhIHNpbmdsZSBtdXRleCB0byBhbGxvdyBvbmx5IGEgc2luZ2xlIGF0
b21pYwp1cGRhdGUgYXQgYSB0aW1lLiBJbiB0cnV0aCwgdGhvdWdoLCB3ZSByZWFsbHkgb25seSB3
YW50IHRvCmVuc3VyZSB0aGF0IG9ubHkgYSBzaW5nbGUgYXRvbWljIHVwZGF0ZSBpcyBhbGxvd2Vk
IHBlciBDUlRDLgoKSW4gb3RoZXIgd29yZHMsIGZvciBlYWNoIGF0b21pYyB1cGRhdGUsIHdlIG9u
bHkgYmxvY2sgaWYgdGhlcmUKaXMgYSBwZW5kaW5nIHVwZGF0ZSBmb3IgdGhlIENSVENzIGludm9s
dmVkLCBhbmQgZG9uJ3QgYmxvY2sgaWYKdGhlcmUgYXJlIG9ubHkgcGVuZGluZyB1cGRhdGVzIGZv
ciBvdGhlciBDUlRDcy4KCkZpeGVzOiAxMTlmNTE3MzYyOGEgKCJkcm0vbWVkaWF0ZWs6IEFkZCBE
Uk0gRHJpdmVyIGZvciBNZWRpYXRlayBTb0MgTVQ4MTczLiIpCgpTaWduZWQtb2ZmLWJ5OiBEYW5p
ZWwgS3VydHogPGRqa3VydHpAY2hyb21pdW0ub3JnPgpTaWduZWQtb2ZmLWJ5OiBCaWJieSBIc2ll
aCA8YmliYnkuaHNpZWhAbWVkaWF0ZWsuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9tZWRpYXRl
ay9tdGtfZHJtX2NydGMuYyB8ICAxNCArLQogZHJpdmVycy9ncHUvZHJtL21lZGlhdGVrL210a19k
cm1fZHJ2LmMgIHwgMTgyICsrKysrKysrKysrKysrKysrKysrKy0tLQogZHJpdmVycy9ncHUvZHJt
L21lZGlhdGVrL210a19kcm1fZHJ2LmggIHwgIDEyICstCiAzIGZpbGVzIGNoYW5nZWQsIDE4NCBp
bnNlcnRpb25zKCspLCAyNCBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vbWVkaWF0ZWsvbXRrX2RybV9jcnRjLmMgYi9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRr
X2RybV9jcnRjLmMKaW5kZXggYjU1OTcwYTI4NjlkLi43Njk3YjQwYmFhYzAgMTAwNjQ0Ci0tLSBh
L2RyaXZlcnMvZ3B1L2RybS9tZWRpYXRlay9tdGtfZHJtX2NydGMuYworKysgYi9kcml2ZXJzL2dw
dS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9jcnRjLmMKQEAgLTUsNiArNSw3IEBACiAKICNpbmNsdWRl
IDxhc20vYmFycmllci5oPgogI2luY2x1ZGUgPGRybS9kcm1QLmg+CisjaW5jbHVkZSA8ZHJtL2Ry
bV9hdG9taWMuaD4KICNpbmNsdWRlIDxkcm0vZHJtX2F0b21pY19oZWxwZXIuaD4KICNpbmNsdWRl
IDxkcm0vZHJtX3BsYW5lX2hlbHBlci5oPgogI2luY2x1ZGUgPGRybS9kcm1fcHJvYmVfaGVscGVy
Lmg+CkBAIC00NSw2ICs0Niw4IEBAIHN0cnVjdCBtdGtfZHJtX2NydGMgewogCXN0cnVjdCBtdGtf
ZGlzcF9tdXRleAkJKm11dGV4OwogCXVuc2lnbmVkIGludAkJCWRkcF9jb21wX25yOwogCXN0cnVj
dCBtdGtfZGRwX2NvbXAJCSoqZGRwX2NvbXA7CisKKwlzdHJ1Y3QgZHJtX2NydGNfc3RhdGUJCSpv
bGRfY3J0Y19zdGF0ZTsKIH07CiAKIHN0cnVjdCBtdGtfY3J0Y19zdGF0ZSB7CkBAIC0zNDMsNiAr
MzQ2LDcgQEAgc3RhdGljIHZvaWQgbXRrX2NydGNfZGRwX2h3X2Zpbmkoc3RydWN0IG10a19kcm1f
Y3J0YyAqbXRrX2NydGMpCiBzdGF0aWMgdm9pZCBtdGtfY3J0Y19kZHBfY29uZmlnKHN0cnVjdCBk
cm1fY3J0YyAqY3J0YykKIHsKIAlzdHJ1Y3QgbXRrX2RybV9jcnRjICptdGtfY3J0YyA9IHRvX210
a19jcnRjKGNydGMpOworCXN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICphdG9taWNfc3RhdGUgPSBt
dGtfY3J0Yy0+b2xkX2NydGNfc3RhdGUtPnN0YXRlOwogCXN0cnVjdCBtdGtfY3J0Y19zdGF0ZSAq
c3RhdGUgPSB0b19tdGtfY3J0Y19zdGF0ZShtdGtfY3J0Yy0+YmFzZS5zdGF0ZSk7CiAJc3RydWN0
IG10a19kZHBfY29tcCAqY29tcCA9IG10a19jcnRjLT5kZHBfY29tcFswXTsKIAl1bnNpZ25lZCBp
bnQgaTsKQEAgLTM4Miw2ICszODYsNyBAQCBzdGF0aWMgdm9pZCBtdGtfY3J0Y19kZHBfY29uZmln
KHN0cnVjdCBkcm1fY3J0YyAqY3J0YykKIAkJCX0KIAkJfQogCQltdGtfY3J0Yy0+cGVuZGluZ19w
bGFuZXMgPSBmYWxzZTsKKwkJbXRrX2F0b21pY19zdGF0ZV9wdXRfcXVldWUoYXRvbWljX3N0YXRl
KTsKIAl9CiB9CiAKQEAgLTQ1MSw2ICs0NTYsNyBAQCBzdGF0aWMgdm9pZCBtdGtfZHJtX2NydGNf
YXRvbWljX2JlZ2luKHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKIHN0YXRpYyB2b2lkIG10a19kcm1f
Y3J0Y19hdG9taWNfZmx1c2goc3RydWN0IGRybV9jcnRjICpjcnRjLAogCQkJCSAgICAgIHN0cnVj
dCBkcm1fY3J0Y19zdGF0ZSAqb2xkX2NydGNfc3RhdGUpCiB7CisJc3RydWN0IGRybV9hdG9taWNf
c3RhdGUgKm9sZF9hdG9taWNfc3RhdGUgPSBvbGRfY3J0Y19zdGF0ZS0+c3RhdGU7CiAJc3RydWN0
IG10a19kcm1fY3J0YyAqbXRrX2NydGMgPSB0b19tdGtfY3J0YyhjcnRjKTsKIAlzdHJ1Y3QgbXRr
X2RybV9wcml2YXRlICpwcml2ID0gY3J0Yy0+ZGV2LT5kZXZfcHJpdmF0ZTsKIAl1bnNpZ25lZCBp
bnQgcGVuZGluZ19wbGFuZXMgPSAwOwpAQCAtNDY5LDggKzQ3NSwxMyBAQCBzdGF0aWMgdm9pZCBt
dGtfZHJtX2NydGNfYXRvbWljX2ZsdXNoKHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKIAkJCXBlbmRp
bmdfcGxhbmVzIHw9IEJJVChpKTsKIAkJfQogCX0KLQlpZiAocGVuZGluZ19wbGFuZXMpCisKKwlp
ZiAocGVuZGluZ19wbGFuZXMpIHsKIAkJbXRrX2NydGMtPnBlbmRpbmdfcGxhbmVzID0gdHJ1ZTsK
KwkJZHJtX2F0b21pY19zdGF0ZV9nZXQob2xkX2F0b21pY19zdGF0ZSk7CisJCW10a19jcnRjLT5v
bGRfY3J0Y19zdGF0ZSA9IG9sZF9jcnRjX3N0YXRlOworCX0KKwogCWlmIChjcnRjLT5zdGF0ZS0+
Y29sb3JfbWdtdF9jaGFuZ2VkKQogCQlmb3IgKGkgPSAwOyBpIDwgbXRrX2NydGMtPmRkcF9jb21w
X25yOyBpKyspCiAJCQltdGtfZGRwX2dhbW1hX3NldChtdGtfY3J0Yy0+ZGRwX2NvbXBbaV0sIGNy
dGMtPnN0YXRlKTsKQEAgLTUyNiw2ICs1MzcsNyBAQCBzdGF0aWMgaW50IG10a19kcm1fY3J0Y19p
bml0KHN0cnVjdCBkcm1fZGV2aWNlICpkcm0sCiAKIHZvaWQgbXRrX2NydGNfZGRwX2lycShzdHJ1
Y3QgZHJtX2NydGMgKmNydGMsIHN0cnVjdCBtdGtfZGRwX2NvbXAgKmNvbXApCiB7CisKIAlzdHJ1
Y3QgbXRrX2RybV9jcnRjICptdGtfY3J0YyA9IHRvX210a19jcnRjKGNydGMpOwogCXN0cnVjdCBt
dGtfZHJtX3ByaXZhdGUgKnByaXYgPSBjcnRjLT5kZXYtPmRldl9wcml2YXRlOwogCmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kcnYuYyBiL2RyaXZlcnMvZ3B1
L2RybS9tZWRpYXRlay9tdGtfZHJtX2Rydi5jCmluZGV4IGMwOTI4YjY5ZGM0My4uYjAzMDhhM2E3
NDgzIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kcnYuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kcnYuYwpAQCAtMzEsMTEgKzMx
LDEyMCBAQAogI2RlZmluZSBEUklWRVJfTUFKT1IgMQogI2RlZmluZSBEUklWRVJfTUlOT1IgMAog
Ci1zdGF0aWMgdm9pZCBtdGtfYXRvbWljX3NjaGVkdWxlKHN0cnVjdCBtdGtfZHJtX3ByaXZhdGUg
KnByaXZhdGUsCitzdHJ1Y3QgbXRrX2F0b21pY19zdGF0ZSB7CisJc3RydWN0IGRybV9hdG9taWNf
c3RhdGUgYmFzZTsKKwlzdHJ1Y3QgbGlzdF9oZWFkIGxpc3Q7CisJc3RydWN0IHdvcmtfc3RydWN0
IHdvcms7Cit9OworCitzdGF0aWMgaW5saW5lIHN0cnVjdCBtdGtfYXRvbWljX3N0YXRlICp0b19t
dGtfc3RhdGUoc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnMpCit7CisJcmV0dXJuIGNvbnRhaW5l
cl9vZihzLCBzdHJ1Y3QgbXRrX2F0b21pY19zdGF0ZSwgYmFzZSk7Cit9CisKK3ZvaWQgbXRrX2F0
b21pY19zdGF0ZV9wdXRfcXVldWUoc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQorewor
CXN0cnVjdCBkcm1fZGV2aWNlICpkcm0gPSBzdGF0ZS0+ZGV2OworCXN0cnVjdCBtdGtfZHJtX3By
aXZhdGUgKm10a19kcm0gPSBkcm0tPmRldl9wcml2YXRlOworCXN0cnVjdCBtdGtfYXRvbWljX3N0
YXRlICptdGtfc3RhdGUgPSB0b19tdGtfc3RhdGUoc3RhdGUpOworCXVuc2lnbmVkIGxvbmcgZmxh
Z3M7CisKKwlzcGluX2xvY2tfaXJxc2F2ZSgmbXRrX2RybS0+dW5yZWZlcmVuY2UubG9jaywgZmxh
Z3MpOworCWxpc3RfYWRkX3RhaWwoJm10a19zdGF0ZS0+bGlzdCwgJm10a19kcm0tPnVucmVmZXJl
bmNlLmxpc3QpOworCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJm10a19kcm0tPnVucmVmZXJlbmNl
LmxvY2ssIGZsYWdzKTsKKworCXNjaGVkdWxlX3dvcmsoJm10a19kcm0tPnVucmVmZXJlbmNlLndv
cmspOworfQorCitzdGF0aWMgdWludDMyX3QgbXRrX2F0b21pY19jcnRjX21hc2soc3RydWN0IGRy
bV9kZXZpY2UgKmRybSwKKwkJCQkgICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkK
K3sKKwl1aW50MzJfdCBjcnRjX21hc2s7CisJaW50IGk7CisKKwlmb3IgKGkgPSAwLCBjcnRjX21h
c2sgPSAwOyBpIDwgZHJtLT5tb2RlX2NvbmZpZy5udW1fY3J0YzsgaSsrKSB7CisJCXN0cnVjdCBk
cm1fY3J0YyAqY3J0YyA9IHN0YXRlLT5jcnRjc1tpXS5wdHI7CisKKwkJaWYgKGNydGMpCisJCQlj
cnRjX21hc2sgfD0gKDEgPDwgZHJtX2NydGNfaW5kZXgoY3J0YykpOworCX0KKworCXJldHVybiBj
cnRjX21hc2s7Cit9CisKKy8qCisgKiBCbG9jayB1bnRpbCBzcGVjaWZpZWQgY3J0Y3MgYXJlIG5v
IGxvbmdlciBwZW5kaW5nIHVwZGF0ZSwgYW5kIGF0b21pY2FsbHkKKyAqIG1hcmsgdGhlbSBhcyBw
ZW5kaW5nIHVwZGF0ZS4KKyAqLworc3RhdGljIGludCBtdGtfYXRvbWljX2dldF9jcnRjcyhzdHJ1
Y3QgZHJtX2RldmljZSAqZHJtLAorCQkJCXN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSkK
K3sKKwlzdHJ1Y3QgbXRrX2RybV9wcml2YXRlICpwcml2YXRlID0gZHJtLT5kZXZfcHJpdmF0ZTsK
Kwl1aW50MzJfdCBjcnRjX21hc2s7CisJaW50IHJldDsKKworCWNydGNfbWFzayA9IG10a19hdG9t
aWNfY3J0Y19tYXNrKGRybSwgc3RhdGUpOworCisJLyoKKwkgKiBXYWl0IGZvciBhbGwgcGVuZGlu
ZyB1cGRhdGVzIHRvIGNvbXBsZXRlIGZvciB0aGUgc2V0IG9mIGNydGNzIGJlaW5nCisJICogY2hh
bmdlZCBpbiB0aGlzIGF0b21pYyBjb21taXQKKwkgKi8KKwlzcGluX2xvY2soJnByaXZhdGUtPmNv
bW1pdC5jcnRjc19ldmVudC5sb2NrKTsKKwlyZXQgPSB3YWl0X2V2ZW50X2ludGVycnVwdGlibGVf
bG9ja2VkKHByaXZhdGUtPmNvbW1pdC5jcnRjc19ldmVudCwKKwkJCSEocHJpdmF0ZS0+Y29tbWl0
LmNydGNzICYgY3J0Y19tYXNrKSk7CisJaWYgKHJldCA9PSAwKQorCQlwcml2YXRlLT5jb21taXQu
Y3J0Y3MgfD0gY3J0Y19tYXNrOworCXNwaW5fdW5sb2NrKCZwcml2YXRlLT5jb21taXQuY3J0Y3Nf
ZXZlbnQubG9jayk7CisKKwlyZXR1cm4gcmV0OworfQorCisvKgorICogTWFyayBzcGVjaWZpZWQg
Y3J0Y3MgYXMgbm8gbG9uZ2VyIHBlbmRpbmcgdXBkYXRlLgorICovCitzdGF0aWMgdm9pZCBtdGtf
YXRvbWljX3B1dF9jcnRjcyhzdHJ1Y3QgZHJtX2RldmljZSAqZHJtLAorCQkJCSBzdHJ1Y3QgZHJt
X2F0b21pY19zdGF0ZSAqc3RhdGUpCit7CisJc3RydWN0IG10a19kcm1fcHJpdmF0ZSAqcHJpdmF0
ZSA9IGRybS0+ZGV2X3ByaXZhdGU7CisJdWludDMyX3QgY3J0Y19tYXNrOworCisJY3J0Y19tYXNr
ID0gbXRrX2F0b21pY19jcnRjX21hc2soZHJtLCBzdGF0ZSk7CisKKwlzcGluX2xvY2soJnByaXZh
dGUtPmNvbW1pdC5jcnRjc19ldmVudC5sb2NrKTsKKwlwcml2YXRlLT5jb21taXQuY3J0Y3MgJj0g
fmNydGNfbWFzazsKKwl3YWtlX3VwX2FsbF9sb2NrZWQoJnByaXZhdGUtPmNvbW1pdC5jcnRjc19l
dmVudCk7CisJc3Bpbl91bmxvY2soJnByaXZhdGUtPmNvbW1pdC5jcnRjc19ldmVudC5sb2NrKTsK
K30KKworc3RhdGljIHZvaWQgbXRrX3VucmVmZXJlbmNlX3dvcmsoc3RydWN0IHdvcmtfc3RydWN0
ICp3b3JrKQoreworCXN0cnVjdCBtdGtfZHJtX3ByaXZhdGUgKm10a19kcm0gPSBjb250YWluZXJf
b2Yod29yaywKKwkJCXN0cnVjdCBtdGtfZHJtX3ByaXZhdGUsIHVucmVmZXJlbmNlLndvcmspOwor
CXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisJc3RydWN0IG10a19hdG9taWNfc3RhdGUgKnN0YXRlLCAq
dG1wOworCisJLyoKKwkgKiBmcmFtZWJ1ZmZlcnMgY2Fubm90IGJlIHVucmVmZXJlbmNlZCBpbiBh
dG9taWMgY29udGV4dC4KKwkgKiBUaGVyZWZvcmUsIG9ubHkgaG9sZCB0aGUgc3BpbmxvY2sgd2hl
biBpdGVyYXRpbmcgdW5yZWZlcmVuY2VfbGlzdCwKKwkgKiBhbmQgZHJvcCBpdCB3aGVuIGRvaW5n
IHRoZSB1bnJlZmVyZW5jZS4KKwkgKi8KKwlzcGluX2xvY2tfaXJxc2F2ZSgmbXRrX2RybS0+dW5y
ZWZlcmVuY2UubG9jaywgZmxhZ3MpOworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShzdGF0ZSwg
dG1wLCAmbXRrX2RybS0+dW5yZWZlcmVuY2UubGlzdCwgbGlzdCkgeworCQlsaXN0X2RlbCgmc3Rh
dGUtPmxpc3QpOworCQlzcGluX3VubG9ja19pcnFyZXN0b3JlKCZtdGtfZHJtLT51bnJlZmVyZW5j
ZS5sb2NrLCBmbGFncyk7CisJCWRybV9hdG9taWNfc3RhdGVfcHV0KCZzdGF0ZS0+YmFzZSk7CisJ
CXNwaW5fbG9ja19pcnFzYXZlKCZtdGtfZHJtLT51bnJlZmVyZW5jZS5sb2NrLCBmbGFncyk7CisJ
fQorCXNwaW5fdW5sb2NrX2lycXJlc3RvcmUoJm10a19kcm0tPnVucmVmZXJlbmNlLmxvY2ssIGZs
YWdzKTsKK30KKworCitzdGF0aWMgdm9pZCBtdGtfYXRvbWljX3NjaGVkdWxlKHN0cnVjdCBkcm1f
ZGV2aWNlICpkcm0sCiAJCQkJc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQogewotCXBy
aXZhdGUtPmNvbW1pdC5zdGF0ZSA9IHN0YXRlOwotCXNjaGVkdWxlX3dvcmsoJnByaXZhdGUtPmNv
bW1pdC53b3JrKTsKKwlzdHJ1Y3QgbXRrX2F0b21pY19zdGF0ZSAqbXRrX3N0YXRlID0gdG9fbXRr
X3N0YXRlKHN0YXRlKTsKKworCXNjaGVkdWxlX3dvcmsoJm10a19zdGF0ZS0+d29yayk7CiB9CiAK
IHN0YXRpYyB2b2lkIG10a19hdG9taWNfd2FpdF9mb3JfZmVuY2VzKHN0cnVjdCBkcm1fYXRvbWlj
X3N0YXRlICpzdGF0ZSkKQEAgLTQ4LDEzICsxNTcsMTAgQEAgc3RhdGljIHZvaWQgbXRrX2F0b21p
Y193YWl0X2Zvcl9mZW5jZXMoc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQogCQltdGtf
ZmJfd2FpdChuZXdfcGxhbmVfc3RhdGUtPmZiKTsKIH0KIAotc3RhdGljIHZvaWQgbXRrX2F0b21p
Y19jb21wbGV0ZShzdHJ1Y3QgbXRrX2RybV9wcml2YXRlICpwcml2YXRlLAorc3RhdGljIHZvaWQg
bXRrX2F0b21pY19jb21wbGV0ZShzdHJ1Y3QgZHJtX2RldmljZSAqZHJtLAogCQkJCXN0cnVjdCBk
cm1fYXRvbWljX3N0YXRlICpzdGF0ZSkKIHsKLQlzdHJ1Y3QgZHJtX2RldmljZSAqZHJtID0gcHJp
dmF0ZS0+ZHJtOwotCiAJbXRrX2F0b21pY193YWl0X2Zvcl9mZW5jZXMoc3RhdGUpOwotCiAJLyoK
IAkgKiBNZWRpYXRlayBkcm0gc3VwcG9ydHMgcnVudGltZSBQTSwgc28gcGxhbmUgcmVnaXN0ZXJz
IGNhbm5vdCBiZQogCSAqIHdyaXR0ZW4gd2hlbiB0aGVpciBjcnRjIGlzIGRpc2FibGVkLgpAQCAt
NzcsNTMgKzE4Myw4NiBAQCBzdGF0aWMgdm9pZCBtdGtfYXRvbWljX2NvbXBsZXRlKHN0cnVjdCBt
dGtfZHJtX3ByaXZhdGUgKnByaXZhdGUsCiAJZHJtX2F0b21pY19oZWxwZXJfd2FpdF9mb3JfdmJs
YW5rcyhkcm0sIHN0YXRlKTsKIAogCWRybV9hdG9taWNfaGVscGVyX2NsZWFudXBfcGxhbmVzKGRy
bSwgc3RhdGUpOworCW10a19hdG9taWNfcHV0X2NydGNzKGRybSwgc3RhdGUpOworCiAJZHJtX2F0
b21pY19zdGF0ZV9wdXQoc3RhdGUpOwogfQogCiBzdGF0aWMgdm9pZCBtdGtfYXRvbWljX3dvcmso
c3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQogewotCXN0cnVjdCBtdGtfZHJtX3ByaXZhdGUgKnBy
aXZhdGUgPSBjb250YWluZXJfb2Yod29yaywKLQkJCXN0cnVjdCBtdGtfZHJtX3ByaXZhdGUsIGNv
bW1pdC53b3JrKTsKKwlzdHJ1Y3QgbXRrX2F0b21pY19zdGF0ZSAqbXRrX3N0YXRlID0gY29udGFp
bmVyX29mKHdvcmssCisJCQlzdHJ1Y3QgbXRrX2F0b21pY19zdGF0ZSwgd29yayk7CisJc3RydWN0
IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlID0gJm10a19zdGF0ZS0+YmFzZTsKKwlzdHJ1Y3QgZHJt
X2RldmljZSAqZHJtID0gc3RhdGUtPmRldjsKIAotCW10a19hdG9taWNfY29tcGxldGUocHJpdmF0
ZSwgcHJpdmF0ZS0+Y29tbWl0LnN0YXRlKTsKKwltdGtfYXRvbWljX2NvbXBsZXRlKGRybSwgc3Rh
dGUpOwogfQogCiBzdGF0aWMgaW50IG10a19hdG9taWNfY29tbWl0KHN0cnVjdCBkcm1fZGV2aWNl
ICpkcm0sCiAJCQkgICAgIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICpzdGF0ZSwKIAkJCSAgICAg
Ym9vbCBhc3luYykKIHsKLQlzdHJ1Y3QgbXRrX2RybV9wcml2YXRlICpwcml2YXRlID0gZHJtLT5k
ZXZfcHJpdmF0ZTsKIAlpbnQgcmV0OwogCiAJcmV0ID0gZHJtX2F0b21pY19oZWxwZXJfcHJlcGFy
ZV9wbGFuZXMoZHJtLCBzdGF0ZSk7CiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsKIAotCW11dGV4
X2xvY2soJnByaXZhdGUtPmNvbW1pdC5sb2NrKTsKLQlmbHVzaF93b3JrKCZwcml2YXRlLT5jb21t
aXQud29yayk7CisJcmV0ID0gbXRrX2F0b21pY19nZXRfY3J0Y3MoZHJtLCBzdGF0ZSk7CisJaWYg
KHJldCkgeworCQlkcm1fYXRvbWljX2hlbHBlcl9jbGVhbnVwX3BsYW5lcyhkcm0sIHN0YXRlKTsK
KwkJcmV0dXJuIHJldDsKKwl9CiAKIAlyZXQgPSBkcm1fYXRvbWljX2hlbHBlcl9zd2FwX3N0YXRl
KHN0YXRlLCB0cnVlKTsKIAlpZiAocmV0KSB7Ci0JCW11dGV4X3VubG9jaygmcHJpdmF0ZS0+Y29t
bWl0LmxvY2spOwogCQlkcm1fYXRvbWljX2hlbHBlcl9jbGVhbnVwX3BsYW5lcyhkcm0sIHN0YXRl
KTsKIAkJcmV0dXJuIHJldDsKIAl9CiAKIAlkcm1fYXRvbWljX3N0YXRlX2dldChzdGF0ZSk7CiAJ
aWYgKGFzeW5jKQotCQltdGtfYXRvbWljX3NjaGVkdWxlKHByaXZhdGUsIHN0YXRlKTsKKwkJbXRr
X2F0b21pY19zY2hlZHVsZShkcm0sIHN0YXRlKTsKIAllbHNlCi0JCW10a19hdG9taWNfY29tcGxl
dGUocHJpdmF0ZSwgc3RhdGUpOwotCi0JbXV0ZXhfdW5sb2NrKCZwcml2YXRlLT5jb21taXQubG9j
ayk7CisJCW10a19hdG9taWNfY29tcGxldGUoZHJtLCBzdGF0ZSk7CiAKIAlyZXR1cm4gMDsKIH0K
IAorc3RhdGljIHN0cnVjdCBkcm1fYXRvbWljX3N0YXRlICptdGtfZHJtX2F0b21pY19zdGF0ZV9h
bGxvYygKKwkJc3RydWN0IGRybV9kZXZpY2UgKmRldikKK3sKKwlzdHJ1Y3QgbXRrX2F0b21pY19z
dGF0ZSAqbXRrX3N0YXRlOworCisJbXRrX3N0YXRlID0ga3phbGxvYyhzaXplb2YoKm10a19zdGF0
ZSksIEdGUF9LRVJORUwpOworCWlmICghbXRrX3N0YXRlKQorCQlyZXR1cm4gTlVMTDsKKworCWlm
IChkcm1fYXRvbWljX3N0YXRlX2luaXQoZGV2LCAmbXRrX3N0YXRlLT5iYXNlKSA8IDApIHsKKwkJ
a2ZyZWUobXRrX3N0YXRlKTsKKwkJcmV0dXJuIE5VTEw7CisJfQorCisJSU5JVF9MSVNUX0hFQUQo
Jm10a19zdGF0ZS0+bGlzdCk7CisJSU5JVF9XT1JLKCZtdGtfc3RhdGUtPndvcmssIG10a19hdG9t
aWNfd29yayk7CisKKwlyZXR1cm4gJm10a19zdGF0ZS0+YmFzZTsKK30KKworc3RhdGljIHZvaWQg
bXRrX2RybV9hdG9taWNfc3RhdGVfZnJlZShzdHJ1Y3QgZHJtX2F0b21pY19zdGF0ZSAqc3RhdGUp
Cit7CisJc3RydWN0IG10a19hdG9taWNfc3RhdGUgKm10a19zdGF0ZSA9IHRvX210a19zdGF0ZShz
dGF0ZSk7CisKKwlkcm1fYXRvbWljX3N0YXRlX2RlZmF1bHRfcmVsZWFzZShzdGF0ZSk7CisJa2Zy
ZWUobXRrX3N0YXRlKTsKK30KKwogc3RhdGljIGNvbnN0IHN0cnVjdCBkcm1fbW9kZV9jb25maWdf
ZnVuY3MgbXRrX2RybV9tb2RlX2NvbmZpZ19mdW5jcyA9IHsKIAkuZmJfY3JlYXRlID0gbXRrX2Ry
bV9tb2RlX2ZiX2NyZWF0ZSwKIAkuYXRvbWljX2NoZWNrID0gZHJtX2F0b21pY19oZWxwZXJfY2hl
Y2ssCiAJLmF0b21pY19jb21taXQgPSBtdGtfYXRvbWljX2NvbW1pdCwKKwkuYXRvbWljX3N0YXRl
X2FsbG9jID0gbXRrX2RybV9hdG9taWNfc3RhdGVfYWxsb2MsCisJLmF0b21pY19zdGF0ZV9mcmVl
ID0gbXRrX2RybV9hdG9taWNfc3RhdGVfZnJlZQogfTsKIAogc3RhdGljIGNvbnN0IGVudW0gbXRr
X2RkcF9jb21wX2lkIG10MjcwMV9tdGtfZGRwX21haW5bXSA9IHsKQEAgLTMxOSw2ICs0NTgsMTEg
QEAgc3RhdGljIGludCBtdGtfZHJtX2ttc19pbml0KHN0cnVjdCBkcm1fZGV2aWNlICpkcm0pCiAJ
ZHJtX2ttc19oZWxwZXJfcG9sbF9pbml0KGRybSk7CiAJZHJtX21vZGVfY29uZmlnX3Jlc2V0KGRy
bSk7CiAKKwlJTklUX1dPUksoJnByaXZhdGUtPnVucmVmZXJlbmNlLndvcmssIG10a191bnJlZmVy
ZW5jZV93b3JrKTsKKwlJTklUX0xJU1RfSEVBRCgmcHJpdmF0ZS0+dW5yZWZlcmVuY2UubGlzdCk7
CisJc3Bpbl9sb2NrX2luaXQoJnByaXZhdGUtPnVucmVmZXJlbmNlLmxvY2spOworCWluaXRfd2Fp
dHF1ZXVlX2hlYWQoJnByaXZhdGUtPmNvbW1pdC5jcnRjc19ldmVudCk7CisKIAlyZXR1cm4gMDsK
IAogZXJyX2NvbXBvbmVudF91bmJpbmQ6CkBAIC01MDQsOCArNjQ4LDYgQEAgc3RhdGljIGludCBt
dGtfZHJtX3Byb2JlKHN0cnVjdCBwbGF0Zm9ybV9kZXZpY2UgKnBkZXYpCiAJaWYgKCFwcml2YXRl
KQogCQlyZXR1cm4gLUVOT01FTTsKIAotCW11dGV4X2luaXQoJnByaXZhdGUtPmNvbW1pdC5sb2Nr
KTsKLQlJTklUX1dPUksoJnByaXZhdGUtPmNvbW1pdC53b3JrLCBtdGtfYXRvbWljX3dvcmspOwog
CXByaXZhdGUtPmRhdGEgPSBvZl9kZXZpY2VfZ2V0X21hdGNoX2RhdGEoZGV2KTsKIAogCW1lbSA9
IHBsYXRmb3JtX2dldF9yZXNvdXJjZShwZGV2LCBJT1JFU09VUkNFX01FTSwgMCk7CmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kcnYuaCBiL2RyaXZlcnMvZ3B1
L2RybS9tZWRpYXRlay9tdGtfZHJtX2Rydi5oCmluZGV4IDgyM2JhNDA4MWMxOC4uMDkzNGY4M2I4
NjBkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kcnYuaAor
KysgYi9kcml2ZXJzL2dwdS9kcm0vbWVkaWF0ZWsvbXRrX2RybV9kcnYuaApAQCAtNDgsMTIgKzQ4
LDE2IEBAIHN0cnVjdCBtdGtfZHJtX3ByaXZhdGUgewogCWNvbnN0IHN0cnVjdCBtdGtfbW1zeXNf
ZHJpdmVyX2RhdGEgKmRhdGE7CiAKIAlzdHJ1Y3QgewotCQlzdHJ1Y3QgZHJtX2F0b21pY19zdGF0
ZSAqc3RhdGU7Ci0JCXN0cnVjdCB3b3JrX3N0cnVjdCB3b3JrOwotCQlzdHJ1Y3QgbXV0ZXggbG9j
azsKKwkJdWludDMyX3QgY3J0Y3M7CisJCXdhaXRfcXVldWVfaGVhZF90IGNydGNzX2V2ZW50Owog
CX0gY29tbWl0OwogCiAJc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN1c3BlbmRfc3RhdGU7CisJ
c3RydWN0IHsKKwkJc3RydWN0IHdvcmtfc3RydWN0CXdvcms7CisJCXN0cnVjdCBsaXN0X2hlYWQJ
bGlzdDsKKwkJc3BpbmxvY2tfdAkJbG9jazsKKwl9IHVucmVmZXJlbmNlOwogfTsKIAogZXh0ZXJu
IHN0cnVjdCBwbGF0Zm9ybV9kcml2ZXIgbXRrX2RkcF9kcml2ZXI7CkBAIC02NCw0ICs2OCw2IEBA
IGV4dGVybiBzdHJ1Y3QgcGxhdGZvcm1fZHJpdmVyIG10a19kcGlfZHJpdmVyOwogZXh0ZXJuIHN0
cnVjdCBwbGF0Zm9ybV9kcml2ZXIgbXRrX2RzaV9kcml2ZXI7CiBleHRlcm4gc3RydWN0IHBsYXRm
b3JtX2RyaXZlciBtdGtfbWlwaV90eF9kcml2ZXI7CiAKK3ZvaWQgbXRrX2F0b21pY19zdGF0ZV9w
dXRfcXVldWUoc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKTsKKwogI2VuZGlmIC8qIE1U
S19EUk1fRFJWX0ggKi8KLS0gCjIuMTguMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vZHJpLWRldmVs
