Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 0E4BCD899A
	for <lists+dri-devel@lfdr.de>; Wed, 16 Oct 2019 09:34:35 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1C56B6E8D7;
	Wed, 16 Oct 2019 07:34:24 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pg1-x543.google.com (mail-pg1-x543.google.com
 [IPv6:2607:f8b0:4864:20::543])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8255D6E87C
 for <dri-devel@lists.freedesktop.org>; Tue, 15 Oct 2019 18:16:25 +0000 (UTC)
Received: by mail-pg1-x543.google.com with SMTP id i76so12636013pgc.0
 for <dri-devel@lists.freedesktop.org>; Tue, 15 Oct 2019 11:16:25 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=jB/ndDNYI+4jh+CyWUF8UUfKQRLegAjGY1TRhiwKQXc=;
 b=AcjxwJ6V2xqIG48vXGi+64hFFS6YOAjijW9hAJ9dKkTwcJwQKcyVonYc1KYimKqpXs
 s3OrP6WUbcrX/mM7tX8uQ8aUD7DJKTDn/6yumCgr8lipcOsOu7kdWT9wv7oqW2w09OlC
 /bH7TShzePFFTnrBppNQAzr3yaxqNGO74UwcYWhcsFTEuRlyuNIWEKwryVYEihe+/c96
 Q5bZcG8zqeNX2Cak+EHqVS4N6Z4JzPTI/8J6A1k8b5hXSqBhBD34CKqpy+stGMoJJOxR
 smRiPBnUXmx45CNpsMrj0ykugKHacC+MwR2TKAQ/TtyaEHrr0xi/w/xmLR7EdWPr7mjl
 N7XQ==
X-Gm-Message-State: APjAAAWPKqdId8gKuoBXNCGzLHvQmujVqGfNLWUzmRo1caLbIXD+SdaH
 QLBF/3d9qUCk/LQhOy5GoStDpQ==
X-Google-Smtp-Source: APXvYqzLw7qtOZsBkXKaKR/Fb8zQC8nnhEWIaTLX6At+LhdX97lMepUUiy2XZX4q9vCtVxZ/O5lS6Q==
X-Received: by 2002:a63:df42:: with SMTP id h2mr37595089pgj.405.1571163384987; 
 Tue, 15 Oct 2019 11:16:24 -0700 (PDT)
Received: from ziepe.ca ([24.114.26.129])
 by smtp.gmail.com with ESMTPSA id z23sm20143091pgu.16.2019.10.15.11.16.24
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Tue, 15 Oct 2019 11:16:24 -0700 (PDT)
Received: from jgg by jggl.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1iKRJT-0002CV-Kz; Tue, 15 Oct 2019 15:12:51 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH hmm 10/15] nouveau: use mmu_notifier directly for
 invalidate_range_start
Date: Tue, 15 Oct 2019 15:12:37 -0300
Message-Id: <20191015181242.8343-11-jgg@ziepe.ca>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191015181242.8343-1-jgg@ziepe.ca>
References: <20191015181242.8343-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Wed, 16 Oct 2019 07:33:45 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=jB/ndDNYI+4jh+CyWUF8UUfKQRLegAjGY1TRhiwKQXc=;
 b=N4xJngJrShT1OxrKZbQG9x6/yIb5+79QBiXMj1lpmIcL+BJccHYhAJs9kTMIr+CtlM
 wX90Z46B912pvyDptdl0AatmwpW5GMmcel8Labgi3qBpGf96/w/VoFYav9X0152CyVpb
 5Tzuj4SUI/KJEjr/d+92doYCmzSDxQWYQ24Ez5JQGlY08HObkSo4R2WD86x6YtlIEFLw
 jLMbUrbdK4SZKnAbYeaMSBA9CiTskJ0B2jxrt15tzXpQ0p1n+sHjuQQK/PhfEJOBE+W2
 y+BkaJmtSv766ZBaY+cXiywFTwg+yrL4Ct6ojugqh5NLwR0mBvk37pN31PrbMjFdwGPv
 Qc0w==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, linux-rdma@vger.kernel.org,
 nouveau@lists.freedesktop.org, amd-gfx@lists.freedesktop.org,
 linux-mm@kvack.org, Jason Gunthorpe <jgg@mellanox.com>,
 dri-devel@lists.freedesktop.org, Ben Skeggs <bskeggs@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKVGhlcmUgaXMgbm8gcmVh
c29uIHRvIGdldCB0aGUgaW52YWxpZGF0ZV9yYW5nZV9zdGFydCgpIGNhbGxiYWNrIHZpYSBhbgpp
bmRpcmVjdGlvbiB0aHJvdWdoIGhtbV9taXJyb3IsIGp1c3QgcmVnaXN0ZXIgYSBub3JtYWwgbm90
aWZpZXIgZGlyZWN0bHkuCgpDYzogQmVuIFNrZWdncyA8YnNrZWdnc0ByZWRoYXQuY29tPgpDYzog
ZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpDYzogbm91dmVhdUBsaXN0cy5mcmVlZGVz
a3RvcC5vcmcKQ2M6IFJhbHBoIENhbXBiZWxsIDxyY2FtcGJlbGxAbnZpZGlhLmNvbT4KU2lnbmVk
LW9mZi1ieTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgotLS0KIGRyaXZlcnMv
Z3B1L2RybS9ub3V2ZWF1L25vdXZlYXVfc3ZtLmMgfCA5NSArKysrKysrKysrKysrKysrKystLS0t
LS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA2MyBpbnNlcnRpb25zKCspLCAzMiBkZWxldGlvbnMoLSkK
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X3N2bS5jIGIvZHJp
dmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVhdV9zdm0uYwppbmRleCA2NjhkNGJkMGMxMThmMS4u
NTc3Zjg4MTE5MjVhNTkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25vdXZl
YXVfc3ZtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVhdV9zdm0uYwpAQCAt
ODgsNiArODgsNyBAQCBub3V2ZWF1X2l2bW1fZmluZChzdHJ1Y3Qgbm91dmVhdV9zdm0gKnN2bSwg
dTY0IGluc3QpCiB9CiAKIHN0cnVjdCBub3V2ZWF1X3N2bW0geworCXN0cnVjdCBtbXVfbm90aWZp
ZXIgbm90aWZpZXI7CiAJc3RydWN0IG5vdXZlYXVfdm1tICp2bW07CiAJc3RydWN0IHsKIAkJdW5z
aWduZWQgbG9uZyBzdGFydDsKQEAgLTk2LDcgKzk3LDYgQEAgc3RydWN0IG5vdXZlYXVfc3ZtbSB7
CiAKIAlzdHJ1Y3QgbXV0ZXggbXV0ZXg7CiAKLQlzdHJ1Y3QgbW1fc3RydWN0ICptbTsKIAlzdHJ1
Y3QgaG1tX21pcnJvciBtaXJyb3I7CiB9OwogCkBAIC0yNTEsMTAgKzI1MSwxMSBAQCBub3V2ZWF1
X3N2bW1faW52YWxpZGF0ZShzdHJ1Y3Qgbm91dmVhdV9zdm1tICpzdm1tLCB1NjQgc3RhcnQsIHU2
NCBsaW1pdCkKIH0KIAogc3RhdGljIGludAotbm91dmVhdV9zdm1tX3N5bmNfY3B1X2RldmljZV9w
YWdldGFibGVzKHN0cnVjdCBobW1fbWlycm9yICptaXJyb3IsCi0JCQkJCWNvbnN0IHN0cnVjdCBt
bXVfbm90aWZpZXJfcmFuZ2UgKnVwZGF0ZSkKK25vdXZlYXVfc3ZtbV9pbnZhbGlkYXRlX3Jhbmdl
X3N0YXJ0KHN0cnVjdCBtbXVfbm90aWZpZXIgKm1uLAorCQkJCSAgICBjb25zdCBzdHJ1Y3QgbW11
X25vdGlmaWVyX3JhbmdlICp1cGRhdGUpCiB7Ci0Jc3RydWN0IG5vdXZlYXVfc3ZtbSAqc3ZtbSA9
IGNvbnRhaW5lcl9vZihtaXJyb3IsIHR5cGVvZigqc3ZtbSksIG1pcnJvcik7CisJc3RydWN0IG5v
dXZlYXVfc3ZtbSAqc3ZtbSA9CisJCWNvbnRhaW5lcl9vZihtbiwgc3RydWN0IG5vdXZlYXVfc3Zt
bSwgbm90aWZpZXIpOwogCXVuc2lnbmVkIGxvbmcgc3RhcnQgPSB1cGRhdGUtPnN0YXJ0OwogCXVu
c2lnbmVkIGxvbmcgbGltaXQgPSB1cGRhdGUtPmVuZDsKIApAQCAtMjY0LDYgKzI2NSw5IEBAIG5v
dXZlYXVfc3ZtbV9zeW5jX2NwdV9kZXZpY2VfcGFnZXRhYmxlcyhzdHJ1Y3QgaG1tX21pcnJvciAq
bWlycm9yLAogCVNWTU1fREJHKHN2bW0sICJpbnZhbGlkYXRlICUwMTZseC0lMDE2bHgiLCBzdGFy
dCwgbGltaXQpOwogCiAJbXV0ZXhfbG9jaygmc3ZtbS0+bXV0ZXgpOworCWlmICh1bmxpa2VseSgh
c3ZtbS0+dm1tKSkKKwkJZ290byBvdXQ7CisKIAlpZiAobGltaXQgPiBzdm1tLT51bm1hbmFnZWQu
c3RhcnQgJiYgc3RhcnQgPCBzdm1tLT51bm1hbmFnZWQubGltaXQpIHsKIAkJaWYgKHN0YXJ0IDwg
c3ZtbS0+dW5tYW5hZ2VkLnN0YXJ0KSB7CiAJCQlub3V2ZWF1X3N2bW1faW52YWxpZGF0ZShzdm1t
LCBzdGFydCwKQEAgLTI3MywxOSArMjc3LDMxIEBAIG5vdXZlYXVfc3ZtbV9zeW5jX2NwdV9kZXZp
Y2VfcGFnZXRhYmxlcyhzdHJ1Y3QgaG1tX21pcnJvciAqbWlycm9yLAogCX0KIAogCW5vdXZlYXVf
c3ZtbV9pbnZhbGlkYXRlKHN2bW0sIHN0YXJ0LCBsaW1pdCk7CisKK291dDoKIAltdXRleF91bmxv
Y2soJnN2bW0tPm11dGV4KTsKIAlyZXR1cm4gMDsKIH0KIAotc3RhdGljIHZvaWQKLW5vdXZlYXVf
c3ZtbV9yZWxlYXNlKHN0cnVjdCBobW1fbWlycm9yICptaXJyb3IpCitzdGF0aWMgdm9pZCBub3V2
ZWF1X3N2bW1fZnJlZV9ub3RpZmllcihzdHJ1Y3QgbW11X25vdGlmaWVyICptbikKK3sKKwlrZnJl
ZShjb250YWluZXJfb2YobW4sIHN0cnVjdCBub3V2ZWF1X3N2bW0sIG5vdGlmaWVyKSk7Cit9CisK
K3N0YXRpYyBjb25zdCBzdHJ1Y3QgbW11X25vdGlmaWVyX29wcyBub3V2ZWF1X21uX29wcyA9IHsK
KwkuaW52YWxpZGF0ZV9yYW5nZV9zdGFydCA9IG5vdXZlYXVfc3ZtbV9pbnZhbGlkYXRlX3Jhbmdl
X3N0YXJ0LAorCS5mcmVlX25vdGlmaWVyID0gbm91dmVhdV9zdm1tX2ZyZWVfbm90aWZpZXIsCit9
OworCitzdGF0aWMgaW50Citub3V2ZWF1X3N2bW1fc3luY19jcHVfZGV2aWNlX3BhZ2V0YWJsZXMo
c3RydWN0IGhtbV9taXJyb3IgKm1pcnJvciwKKwkJCQkJY29uc3Qgc3RydWN0IG1tdV9ub3RpZmll
cl9yYW5nZSAqdXBkYXRlKQogeworCXJldHVybiAwOwogfQogCi1zdGF0aWMgY29uc3Qgc3RydWN0
IGhtbV9taXJyb3Jfb3BzCi1ub3V2ZWF1X3N2bW0gPSB7CitzdGF0aWMgY29uc3Qgc3RydWN0IGht
bV9taXJyb3Jfb3BzIG5vdXZlYXVfc3ZtbSA9IHsKIAkuc3luY19jcHVfZGV2aWNlX3BhZ2V0YWJs
ZXMgPSBub3V2ZWF1X3N2bW1fc3luY19jcHVfZGV2aWNlX3BhZ2V0YWJsZXMsCi0JLnJlbGVhc2Ug
PSBub3V2ZWF1X3N2bW1fcmVsZWFzZSwKIH07CiAKIHZvaWQKQEAgLTI5NCw3ICszMTAsMTAgQEAg
bm91dmVhdV9zdm1tX2Zpbmkoc3RydWN0IG5vdXZlYXVfc3ZtbSAqKnBzdm1tKQogCXN0cnVjdCBu
b3V2ZWF1X3N2bW0gKnN2bW0gPSAqcHN2bW07CiAJaWYgKHN2bW0pIHsKIAkJaG1tX21pcnJvcl91
bnJlZ2lzdGVyKCZzdm1tLT5taXJyb3IpOwotCQlrZnJlZSgqcHN2bW0pOworCQltdXRleF9sb2Nr
KCZzdm1tLT5tdXRleCk7CisJCXN2bW0tPnZtbSA9IE5VTEw7CisJCW11dGV4X3VubG9jaygmc3Zt
bS0+bXV0ZXgpOworCQltbXVfbm90aWZpZXJfcHV0KCZzdm1tLT5ub3RpZmllcik7CiAJCSpwc3Zt
bSA9IE5VTEw7CiAJfQogfQpAQCAtMzIwLDcgKzMzOSw3IEBAIG5vdXZlYXVfc3ZtbV9pbml0KHN0
cnVjdCBkcm1fZGV2aWNlICpkZXYsIHZvaWQgKmRhdGEsCiAJbXV0ZXhfbG9jaygmY2xpLT5tdXRl
eCk7CiAJaWYgKGNsaS0+c3ZtLmNsaSkgewogCQlyZXQgPSAtRUJVU1k7Ci0JCWdvdG8gZG9uZTsK
KwkJZ290byBvdXRfZnJlZTsKIAl9CiAKIAkvKiBBbGxvY2F0ZSBhIG5ldyBHUFUgVk1NIHRoYXQg
Y2FuIHN1cHBvcnQgU1ZNIChtYW5hZ2VkIGJ5IHRoZQpAQCAtMzM1LDI0ICszNTQsMzMgQEAgbm91
dmVhdV9zdm1tX2luaXQoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdm9pZCAqZGF0YSwKIAkJCQku
ZmF1bHRfcmVwbGF5ID0gdHJ1ZSwKIAkJCSAgICB9LCBzaXplb2Yoc3RydWN0IGdwMTAwX3ZtbV92
MCksICZjbGktPnN2bS52bW0pOwogCWlmIChyZXQpCi0JCWdvdG8gZG9uZTsKKwkJZ290byBvdXRf
ZnJlZTsKIAotCS8qIEVuYWJsZSBITU0gbWlycm9yaW5nIG9mIENQVSBhZGRyZXNzLXNwYWNlIHRv
IFZNTS4gKi8KLQlzdm1tLT5tbSA9IGdldF90YXNrX21tKGN1cnJlbnQpOwotCWRvd25fd3JpdGUo
JnN2bW0tPm1tLT5tbWFwX3NlbSk7CisJZG93bl93cml0ZSgmY3VycmVudC0+bW0tPm1tYXBfc2Vt
KTsKIAlzdm1tLT5taXJyb3Iub3BzID0gJm5vdXZlYXVfc3ZtbTsKLQlyZXQgPSBobW1fbWlycm9y
X3JlZ2lzdGVyKCZzdm1tLT5taXJyb3IsIHN2bW0tPm1tKTsKLQlpZiAocmV0ID09IDApIHsKLQkJ
Y2xpLT5zdm0uc3ZtbSA9IHN2bW07Ci0JCWNsaS0+c3ZtLmNsaSA9IGNsaTsKLQl9Ci0JdXBfd3Jp
dGUoJnN2bW0tPm1tLT5tbWFwX3NlbSk7Ci0JbW1wdXQoc3ZtbS0+bW0pOworCXJldCA9IGhtbV9t
aXJyb3JfcmVnaXN0ZXIoJnN2bW0tPm1pcnJvciwgY3VycmVudC0+bW0pOworCWlmIChyZXQpCisJ
CWdvdG8gb3V0X21tX3VubG9jazsKIAotZG9uZToKKwlzdm1tLT5ub3RpZmllci5vcHMgPSAmbm91
dmVhdV9tbl9vcHM7CisJcmV0ID0gX19tbXVfbm90aWZpZXJfcmVnaXN0ZXIoJnN2bW0tPm5vdGlm
aWVyLCBjdXJyZW50LT5tbSk7CiAJaWYgKHJldCkKLQkJbm91dmVhdV9zdm1tX2ZpbmkoJnN2bW0p
OworCQlnb3RvIG91dF9obW1fdW5yZWdpc3RlcjsKKwkvKiBOb3RlLCBvd25lcnNoaXAgb2Ygc3Zt
bSB0cmFuc2ZlcnMgdG8gbW11X25vdGlmaWVyICovCisKKwljbGktPnN2bS5zdm1tID0gc3ZtbTsK
KwljbGktPnN2bS5jbGkgPSBjbGk7CisJdXBfd3JpdGUoJmN1cnJlbnQtPm1tLT5tbWFwX3NlbSk7
CiAJbXV0ZXhfdW5sb2NrKCZjbGktPm11dGV4KTsKKwlyZXR1cm4gMDsKKworb3V0X2htbV91bnJl
Z2lzdGVyOgorCWhtbV9taXJyb3JfdW5yZWdpc3Rlcigmc3ZtbS0+bWlycm9yKTsKK291dF9tbV91
bmxvY2s6CisJdXBfd3JpdGUoJmN1cnJlbnQtPm1tLT5tbWFwX3NlbSk7CitvdXRfZnJlZToKKwlt
dXRleF91bmxvY2soJmNsaS0+bXV0ZXgpOworCWtmcmVlKHN2bW0pOwogCXJldHVybiByZXQ7CiB9
CiAKQEAgLTQ5NCwxMiArNTIyLDEyIEBAIG5vdXZlYXVfcmFuZ2VfZmF1bHQoc3RydWN0IG5vdXZl
YXVfc3ZtbSAqc3ZtbSwgc3RydWN0IGhtbV9yYW5nZSAqcmFuZ2UpCiAKIAlyZXQgPSBobW1fcmFu
Z2VfcmVnaXN0ZXIocmFuZ2UsICZzdm1tLT5taXJyb3IpOwogCWlmIChyZXQpIHsKLQkJdXBfcmVh
ZCgmc3ZtbS0+bW0tPm1tYXBfc2VtKTsKKwkJdXBfcmVhZCgmc3ZtbS0+bm90aWZpZXIubW0tPm1t
YXBfc2VtKTsKIAkJcmV0dXJuIChpbnQpcmV0OwogCX0KIAogCWlmICghaG1tX3JhbmdlX3dhaXRf
dW50aWxfdmFsaWQocmFuZ2UsIEhNTV9SQU5HRV9ERUZBVUxUX1RJTUVPVVQpKSB7Ci0JCXVwX3Jl
YWQoJnN2bW0tPm1tLT5tbWFwX3NlbSk7CisJCXVwX3JlYWQoJnN2bW0tPm5vdGlmaWVyLm1tLT5t
bWFwX3NlbSk7CiAJCXJldHVybiAtRUJVU1k7CiAJfQogCkBAIC01MDcsNyArNTM1LDcgQEAgbm91
dmVhdV9yYW5nZV9mYXVsdChzdHJ1Y3Qgbm91dmVhdV9zdm1tICpzdm1tLCBzdHJ1Y3QgaG1tX3Jh
bmdlICpyYW5nZSkKIAlpZiAocmV0IDw9IDApIHsKIAkJaWYgKHJldCA9PSAwKQogCQkJcmV0ID0g
LUVCVVNZOwotCQl1cF9yZWFkKCZzdm1tLT5tbS0+bW1hcF9zZW0pOworCQl1cF9yZWFkKCZzdm1t
LT5ub3RpZmllci5tbS0+bW1hcF9zZW0pOwogCQlobW1fcmFuZ2VfdW5yZWdpc3RlcihyYW5nZSk7
CiAJCXJldHVybiByZXQ7CiAJfQpAQCAtNTg3LDEyICs2MTUsMTUgQEAgbm91dmVhdV9zdm1fZmF1
bHQoc3RydWN0IG52aWZfbm90aWZ5ICpub3RpZnkpCiAJYXJncy5pLnAudmVyc2lvbiA9IDA7CiAK
IAlmb3IgKGZpID0gMDsgZm4gPSBmaSArIDEsIGZpIDwgYnVmZmVyLT5mYXVsdF9ucjsgZmkgPSBm
bikgeworCQlzdHJ1Y3QgbW1fc3RydWN0ICptbTsKKwogCQkvKiBDYW5jZWwgYW55IGZhdWx0cyBm
cm9tIG5vbi1TVk0gY2hhbm5lbHMuICovCiAJCWlmICghKHN2bW0gPSBidWZmZXItPmZhdWx0W2Zp
XS0+c3ZtbSkpIHsKIAkJCW5vdXZlYXVfc3ZtX2ZhdWx0X2NhbmNlbF9mYXVsdChzdm0sIGJ1ZmZl
ci0+ZmF1bHRbZmldKTsKIAkJCWNvbnRpbnVlOwogCQl9CiAJCVNWTU1fREJHKHN2bW0sICJhZGRy
ICUwMTZsbHgiLCBidWZmZXItPmZhdWx0W2ZpXS0+YWRkcik7CisJCW1tID0gc3ZtbS0+bm90aWZp
ZXIubW07CiAKIAkJLyogV2UgdHJ5IGFuZCBncm91cCBoYW5kbGluZyBvZiBmYXVsdHMgd2l0aGlu
IGEgc21hbGwKIAkJICogd2luZG93IGludG8gYSBzaW5nbGUgdXBkYXRlLgpAQCAtNjA5LDExICs2
NDAsMTEgQEAgbm91dmVhdV9zdm1fZmF1bHQoc3RydWN0IG52aWZfbm90aWZ5ICpub3RpZnkpCiAJ
CS8qIEludGVyc2VjdCBmYXVsdCB3aW5kb3cgd2l0aCB0aGUgQ1BVIFZNQSwgY2FuY2VsbGluZwog
CQkgKiB0aGUgZmF1bHQgaWYgdGhlIGFkZHJlc3MgaXMgaW52YWxpZC4KIAkJICovCi0JCWRvd25f
cmVhZCgmc3ZtbS0+bW0tPm1tYXBfc2VtKTsKLQkJdm1hID0gZmluZF92bWFfaW50ZXJzZWN0aW9u
KHN2bW0tPm1tLCBzdGFydCwgbGltaXQpOworCQlkb3duX3JlYWQoJm1tLT5tbWFwX3NlbSk7CisJ
CXZtYSA9IGZpbmRfdm1hX2ludGVyc2VjdGlvbihtbSwgc3RhcnQsIGxpbWl0KTsKIAkJaWYgKCF2
bWEpIHsKIAkJCVNWTU1fRVJSKHN2bW0sICJ3bmR3ICUwMTZsbHgtJTAxNmxseCIsIHN0YXJ0LCBs
aW1pdCk7Ci0JCQl1cF9yZWFkKCZzdm1tLT5tbS0+bW1hcF9zZW0pOworCQkJdXBfcmVhZCgmbW0t
Pm1tYXBfc2VtKTsKIAkJCW5vdXZlYXVfc3ZtX2ZhdWx0X2NhbmNlbF9mYXVsdChzdm0sIGJ1ZmZl
ci0+ZmF1bHRbZmldKTsKIAkJCWNvbnRpbnVlOwogCQl9CkBAIC02MjMsNyArNjU0LDcgQEAgbm91
dmVhdV9zdm1fZmF1bHQoc3RydWN0IG52aWZfbm90aWZ5ICpub3RpZnkpCiAKIAkJaWYgKGJ1ZmZl
ci0+ZmF1bHRbZmldLT5hZGRyICE9IHN0YXJ0KSB7CiAJCQlTVk1NX0VSUihzdm1tLCAiYWRkciAl
MDE2bGx4IiwgYnVmZmVyLT5mYXVsdFtmaV0tPmFkZHIpOwotCQkJdXBfcmVhZCgmc3ZtbS0+bW0t
Pm1tYXBfc2VtKTsKKwkJCXVwX3JlYWQoJm1tLT5tbWFwX3NlbSk7CiAJCQlub3V2ZWF1X3N2bV9m
YXVsdF9jYW5jZWxfZmF1bHQoc3ZtLCBidWZmZXItPmZhdWx0W2ZpXSk7CiAJCQljb250aW51ZTsK
IAkJfQpAQCAtNzA0LDcgKzczNSw3IEBAIG5vdXZlYXVfc3ZtX2ZhdWx0KHN0cnVjdCBudmlmX25v
dGlmeSAqbm90aWZ5KQogCQkJCQkJTlVMTCk7CiAJCQlzdm1tLT52bW0tPnZtbS5vYmplY3QuY2xp
ZW50LT5zdXBlciA9IGZhbHNlOwogCQkJbXV0ZXhfdW5sb2NrKCZzdm1tLT5tdXRleCk7Ci0JCQl1
cF9yZWFkKCZzdm1tLT5tbS0+bW1hcF9zZW0pOworCQkJdXBfcmVhZCgmbW0tPm1tYXBfc2VtKTsK
IAkJfQogCiAJCS8qIENhbmNlbCBhbnkgZmF1bHRzIGluIHRoZSB3aW5kb3cgd2hvc2UgcGFnZXMg
ZGlkbid0IG1hbmFnZQotLSAKMi4yMy4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9kcmktZGV2ZWw=
