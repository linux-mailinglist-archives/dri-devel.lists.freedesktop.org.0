Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id D3F0030F8B
	for <lists+dri-devel@lfdr.de>; Fri, 31 May 2019 16:02:24 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2D8A4895C1;
	Fri, 31 May 2019 14:02:16 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from smtp.domeneshop.no (smtp.domeneshop.no
 [IPv6:2a01:5b40:0:3005::1])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1FFD5894E3;
 Fri, 31 May 2019 14:02:01 +0000 (UTC)
Received: from 211.81-166-168.customer.lyse.net ([81.166.168.211]:52318
 helo=localhost.localdomain)
 by smtp.domeneshop.no with esmtpsa (TLS1.2:ECDHE_RSA_AES_128_CBC_SHA1:128)
 (Exim 4.84_2) (envelope-from <noralf@tronnes.org>)
 id 1hWi6Y-0002XY-OL; Fri, 31 May 2019 16:01:58 +0200
From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v7 7/8] drm/fb-helper: Move out modeset config code
Date: Fri, 31 May 2019 16:01:16 +0200
Message-Id: <20190531140117.37751-8-noralf@tronnes.org>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190531140117.37751-1-noralf@tronnes.org>
References: <20190531140117.37751-1-noralf@tronnes.org>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; d=tronnes.org; s=ds201810; 
 h=Content-Transfer-Encoding:Content-Type:MIME-Version:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From;
 bh=udcaKfwGPYJ5ZYyb3RnUbb1Oj5dY/4WJN7wA2joaQp0=; 
 b=RmQz6vJB5fD6vBKnmPqhERmnzF3jBwILv2Zbg8Ss3vYL052em/IRYFRhwQigxCKCnpFSOX4tEFjU44S+xgDPxljXRdqp9yfueZ1GLpYIyDMJlfi1twjPNk/N7xv2/FncvxSVSj/wEpvVDcBL2bn8tou8XhAEPVZ2jTMz5EZQD/cg7od3aDJFUud9SjkLwdaolMK8GZMbuq3um/arfhZaj7c/ARkRYXu0pdTvIbnDmXCJ40zHiSR86MWQ7RiCYCo/ZwSTXxwkqnaI5XkA3QO7UNOXvpupTEzHpvVxrATpK5i8GHxHrAX1JMUEwKjxD6AHo1oSOmn7aR0SExObPwBeXA==;
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Maxime Ripard <maxime.ripard@bootlin.com>, intel-gfx@lists.freedesktop.org,
 Sam Ravnborg <sam@ravnborg.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

Tm8gZnVuY3Rpb25hbCBjaGFuZ2VzLCBqdXN0IG1vdmluZyBjb2RlIGFzLWlzIGFuZCBmaXhpbmcg
aW5jbHVkZXMuCgpTaWduZWQtb2ZmLWJ5OiBOb3JhbGYgVHLDuG5uZXMgPG5vcmFsZkB0cm9ubmVz
Lm9yZz4KUmV2aWV3ZWQtYnk6IE1heGltZSBSaXBhcmQgPG1heGltZS5yaXBhcmRAYm9vdGxpbi5j
b20+ClJldmlld2VkLWJ5OiBTYW0gUmF2bmJvcmcgPHNhbUByYXZuYm9yZy5vcmc+Ci0tLQogZHJp
dmVycy9ncHUvZHJtL2RybV9jbGllbnRfbW9kZXNldC5jIHwgNzA3ICsrKysrKysrKysrKysrKysr
KysrKysrKysrLQogZHJpdmVycy9ncHUvZHJtL2RybV9mYl9oZWxwZXIuYyAgICAgIHwgNjkyIC0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiBpbmNsdWRlL2RybS9kcm1fY2xpZW50LmggICAgICAg
ICAgICAgfCAgIDUgKy0KIDMgZmlsZXMgY2hhbmdlZCwgNzAyIGluc2VydGlvbnMoKyksIDcwMiBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2NsaWVudF9tb2Rl
c2V0LmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2NsaWVudF9tb2Rlc2V0LmMKaW5kZXggYjE5ODRm
OTAxYTZkLi4wMDZiZjczOTBlN2QgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9kcm1fY2xp
ZW50X21vZGVzZXQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2NsaWVudF9tb2Rlc2V0LmMK
QEAgLTEzLDEzICsxMywyMiBAQAogCiAjaW5jbHVkZSA8ZHJtL2RybV9hdG9taWMuaD4KICNpbmNs
dWRlIDxkcm0vZHJtX2NsaWVudC5oPgorI2luY2x1ZGUgPGRybS9kcm1fY29ubmVjdG9yLmg+CiAj
aW5jbHVkZSA8ZHJtL2RybV9jcnRjLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9kZXZpY2UuaD4KICNp
bmNsdWRlIDxkcm0vZHJtX2Rydi5oPgorI2luY2x1ZGUgPGRybS9kcm1fZW5jb2Rlci5oPgorI2lu
Y2x1ZGUgPGRybS9kcm1fcHJpbnQuaD4KIAogI2luY2x1ZGUgImRybV9jcnRjX2ludGVybmFsLmgi
CiAjaW5jbHVkZSAiZHJtX2ludGVybmFsLmgiCiAKKyNkZWZpbmUgRFJNX0NMSUVOVF9NQVhfQ0xP
TkVEX0NPTk5FQ1RPUlMJOAorCitzdHJ1Y3QgZHJtX2NsaWVudF9vZmZzZXQgeworCWludCB4LCB5
OworfTsKKwogaW50IGRybV9jbGllbnRfbW9kZXNldF9jcmVhdGUoc3RydWN0IGRybV9jbGllbnRf
ZGV2ICpjbGllbnQpCiB7CiAJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVudC0+ZGV2OwpA
QCAtNTgsNyArNjcsNyBAQCBpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2NyZWF0ZShzdHJ1Y3QgZHJt
X2NsaWVudF9kZXYgKmNsaWVudCkKIAlyZXR1cm4gLUVOT01FTTsKIH0KIAotdm9pZCBkcm1fY2xp
ZW50X21vZGVzZXRfcmVsZWFzZShzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCkKK3N0YXRp
YyB2b2lkIGRybV9jbGllbnRfbW9kZXNldF9yZWxlYXNlKHN0cnVjdCBkcm1fY2xpZW50X2RldiAq
Y2xpZW50KQogewogCXN0cnVjdCBkcm1fbW9kZV9zZXQgKm1vZGVzZXQ7CiAJdW5zaWduZWQgaW50
IGk7CkBAIC03NSw4ICs4NCw2IEBAIHZvaWQgZHJtX2NsaWVudF9tb2Rlc2V0X3JlbGVhc2Uoc3Ry
dWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpCiAJCW1vZGVzZXQtPm51bV9jb25uZWN0b3JzID0g
MDsKIAl9CiB9Ci0vKiBUT0RPOiBSZW1vdmUgZXhwb3J0IHdoZW4gbW9kZXNldCBjb2RlIGhhcyBi
ZWVuIG1vdmVkIG92ZXIgKi8KLUVYUE9SVF9TWU1CT0woZHJtX2NsaWVudF9tb2Rlc2V0X3JlbGVh
c2UpOwogCiB2b2lkIGRybV9jbGllbnRfbW9kZXNldF9mcmVlKHN0cnVjdCBkcm1fY2xpZW50X2Rl
diAqY2xpZW50KQogewpAQCAtOTUsNyArMTAyLDggQEAgdm9pZCBkcm1fY2xpZW50X21vZGVzZXRf
ZnJlZShzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCkKIAlrZnJlZShjbGllbnQtPm1vZGVz
ZXRzKTsKIH0KIAotc3RydWN0IGRybV9tb2RlX3NldCAqZHJtX2NsaWVudF9maW5kX21vZGVzZXQo
c3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQsIHN0cnVjdCBkcm1fY3J0YyAqY3J0YykKK3N0
YXRpYyBzdHJ1Y3QgZHJtX21vZGVfc2V0ICoKK2RybV9jbGllbnRfZmluZF9tb2Rlc2V0KHN0cnVj
dCBkcm1fY2xpZW50X2RldiAqY2xpZW50LCBzdHJ1Y3QgZHJtX2NydGMgKmNydGMpCiB7CiAJc3Ry
dWN0IGRybV9tb2RlX3NldCAqbW9kZXNldDsKIApAQCAtMTA1LDggKzExMyw2OTUgQEAgc3RydWN0
IGRybV9tb2RlX3NldCAqZHJtX2NsaWVudF9maW5kX21vZGVzZXQoc3RydWN0IGRybV9jbGllbnRf
ZGV2ICpjbGllbnQsIHN0cnUKIAogCXJldHVybiBOVUxMOwogfQotLyogVE9ETzogUmVtb3ZlIGV4
cG9ydCB3aGVuIG1vZGVzZXQgY29kZSBoYXMgYmVlbiBtb3ZlZCBvdmVyICovCi1FWFBPUlRfU1lN
Qk9MKGRybV9jbGllbnRfZmluZF9tb2Rlc2V0KTsKKworc3RhdGljIHN0cnVjdCBkcm1fZGlzcGxh
eV9tb2RlICoKK2RybV9jb25uZWN0b3JfaGFzX3ByZWZlcnJlZF9tb2RlKHN0cnVjdCBkcm1fY29u
bmVjdG9yICpjb25uZWN0b3IsIGludCB3aWR0aCwgaW50IGhlaWdodCkKK3sKKwlzdHJ1Y3QgZHJt
X2Rpc3BsYXlfbW9kZSAqbW9kZTsKKworCWxpc3RfZm9yX2VhY2hfZW50cnkobW9kZSwgJmNvbm5l
Y3Rvci0+bW9kZXMsIGhlYWQpIHsKKwkJaWYgKG1vZGUtPmhkaXNwbGF5ID4gd2lkdGggfHwKKwkJ
ICAgIG1vZGUtPnZkaXNwbGF5ID4gaGVpZ2h0KQorCQkJY29udGludWU7CisJCWlmIChtb2RlLT50
eXBlICYgRFJNX01PREVfVFlQRV9QUkVGRVJSRUQpCisJCQlyZXR1cm4gbW9kZTsKKwl9CisJcmV0
dXJuIE5VTEw7Cit9CisKK3N0YXRpYyBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqCitkcm1fY29u
bmVjdG9yX3BpY2tfY21kbGluZV9tb2RlKHN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3Ip
Cit7CisJc3RydWN0IGRybV9jbWRsaW5lX21vZGUgKmNtZGxpbmVfbW9kZTsKKwlzdHJ1Y3QgZHJt
X2Rpc3BsYXlfbW9kZSAqbW9kZTsKKwlib29sIHByZWZlcl9ub25faW50ZXJsYWNlOworCisJY21k
bGluZV9tb2RlID0gJmNvbm5lY3Rvci0+Y21kbGluZV9tb2RlOworCWlmIChjbWRsaW5lX21vZGUt
PnNwZWNpZmllZCA9PSBmYWxzZSkKKwkJcmV0dXJuIE5VTEw7CisKKwkvKiBhdHRlbXB0IHRvIGZp
bmQgYSBtYXRjaGluZyBtb2RlIGluIHRoZSBsaXN0IG9mIG1vZGVzCisJICogIHdlIGhhdmUgZ290
dGVuIHNvIGZhciwgaWYgbm90IGFkZCBhIENWVCBtb2RlIHRoYXQgY29uZm9ybXMKKwkgKi8KKwlp
ZiAoY21kbGluZV9tb2RlLT5yYiB8fCBjbWRsaW5lX21vZGUtPm1hcmdpbnMpCisJCWdvdG8gY3Jl
YXRlX21vZGU7CisKKwlwcmVmZXJfbm9uX2ludGVybGFjZSA9ICFjbWRsaW5lX21vZGUtPmludGVy
bGFjZTsKK2FnYWluOgorCWxpc3RfZm9yX2VhY2hfZW50cnkobW9kZSwgJmNvbm5lY3Rvci0+bW9k
ZXMsIGhlYWQpIHsKKwkJLyogY2hlY2sgd2lkdGgvaGVpZ2h0ICovCisJCWlmIChtb2RlLT5oZGlz
cGxheSAhPSBjbWRsaW5lX21vZGUtPnhyZXMgfHwKKwkJICAgIG1vZGUtPnZkaXNwbGF5ICE9IGNt
ZGxpbmVfbW9kZS0+eXJlcykKKwkJCWNvbnRpbnVlOworCisJCWlmIChjbWRsaW5lX21vZGUtPnJl
ZnJlc2hfc3BlY2lmaWVkKSB7CisJCQlpZiAobW9kZS0+dnJlZnJlc2ggIT0gY21kbGluZV9tb2Rl
LT5yZWZyZXNoKQorCQkJCWNvbnRpbnVlOworCQl9CisKKwkJaWYgKGNtZGxpbmVfbW9kZS0+aW50
ZXJsYWNlKSB7CisJCQlpZiAoIShtb2RlLT5mbGFncyAmIERSTV9NT0RFX0ZMQUdfSU5URVJMQUNF
KSkKKwkJCQljb250aW51ZTsKKwkJfSBlbHNlIGlmIChwcmVmZXJfbm9uX2ludGVybGFjZSkgewor
CQkJaWYgKG1vZGUtPmZsYWdzICYgRFJNX01PREVfRkxBR19JTlRFUkxBQ0UpCisJCQkJY29udGlu
dWU7CisJCX0KKwkJcmV0dXJuIG1vZGU7CisJfQorCisJaWYgKHByZWZlcl9ub25faW50ZXJsYWNl
KSB7CisJCXByZWZlcl9ub25faW50ZXJsYWNlID0gZmFsc2U7CisJCWdvdG8gYWdhaW47CisJfQor
CitjcmVhdGVfbW9kZToKKwltb2RlID0gZHJtX21vZGVfY3JlYXRlX2Zyb21fY21kbGluZV9tb2Rl
KGNvbm5lY3Rvci0+ZGV2LCBjbWRsaW5lX21vZGUpOworCWxpc3RfYWRkKCZtb2RlLT5oZWFkLCAm
Y29ubmVjdG9yLT5tb2Rlcyk7CisKKwlyZXR1cm4gbW9kZTsKK30KKworc3RhdGljIGJvb2wgZHJt
X2Nvbm5lY3Rvcl9lbmFibGVkKHN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IsIGJvb2wg
c3RyaWN0KQoreworCWJvb2wgZW5hYmxlOworCisJaWYgKGNvbm5lY3Rvci0+ZGlzcGxheV9pbmZv
Lm5vbl9kZXNrdG9wKQorCQlyZXR1cm4gZmFsc2U7CisKKwlpZiAoc3RyaWN0KQorCQllbmFibGUg
PSBjb25uZWN0b3ItPnN0YXR1cyA9PSBjb25uZWN0b3Jfc3RhdHVzX2Nvbm5lY3RlZDsKKwllbHNl
CisJCWVuYWJsZSA9IGNvbm5lY3Rvci0+c3RhdHVzICE9IGNvbm5lY3Rvcl9zdGF0dXNfZGlzY29u
bmVjdGVkOworCisJcmV0dXJuIGVuYWJsZTsKK30KKworc3RhdGljIHZvaWQgZHJtX2NsaWVudF9j
b25uZWN0b3JzX2VuYWJsZWQoc3RydWN0IGRybV9jb25uZWN0b3IgKipjb25uZWN0b3JzLAorCQkJ
CQkgIHVuc2lnbmVkIGludCBjb25uZWN0b3JfY291bnQsCisJCQkJCSAgYm9vbCAqZW5hYmxlZCkK
K3sKKwlib29sIGFueV9lbmFibGVkID0gZmFsc2U7CisJc3RydWN0IGRybV9jb25uZWN0b3IgKmNv
bm5lY3RvcjsKKwlpbnQgaSA9IDA7CisKKwlmb3IgKGkgPSAwOyBpIDwgY29ubmVjdG9yX2NvdW50
OyBpKyspIHsKKwkJY29ubmVjdG9yID0gY29ubmVjdG9yc1tpXTsKKwkJZW5hYmxlZFtpXSA9IGRy
bV9jb25uZWN0b3JfZW5hYmxlZChjb25uZWN0b3IsIHRydWUpOworCQlEUk1fREVCVUdfS01TKCJj
b25uZWN0b3IgJWQgZW5hYmxlZD8gJXNcbiIsIGNvbm5lY3Rvci0+YmFzZS5pZCwKKwkJCSAgICAg
IGNvbm5lY3Rvci0+ZGlzcGxheV9pbmZvLm5vbl9kZXNrdG9wID8gIm5vbiBkZXNrdG9wIiA6IGVu
YWJsZWRbaV0gPyAieWVzIiA6ICJubyIpOworCisJCWFueV9lbmFibGVkIHw9IGVuYWJsZWRbaV07
CisJfQorCisJaWYgKGFueV9lbmFibGVkKQorCQlyZXR1cm47CisKKwlmb3IgKGkgPSAwOyBpIDwg
Y29ubmVjdG9yX2NvdW50OyBpKyspCisJCWVuYWJsZWRbaV0gPSBkcm1fY29ubmVjdG9yX2VuYWJs
ZWQoY29ubmVjdG9yc1tpXSwgZmFsc2UpOworfQorCitzdGF0aWMgYm9vbCBkcm1fY2xpZW50X3Rh
cmdldF9jbG9uZWQoc3RydWN0IGRybV9kZXZpY2UgKmRldiwKKwkJCQkgICAgIHN0cnVjdCBkcm1f
Y29ubmVjdG9yICoqY29ubmVjdG9ycywKKwkJCQkgICAgIHVuc2lnbmVkIGludCBjb25uZWN0b3Jf
Y291bnQsCisJCQkJICAgICBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqKm1vZGVzLAorCQkJCSAg
ICAgc3RydWN0IGRybV9jbGllbnRfb2Zmc2V0ICpvZmZzZXRzLAorCQkJCSAgICAgYm9vbCAqZW5h
YmxlZCwgaW50IHdpZHRoLCBpbnQgaGVpZ2h0KQoreworCWludCBjb3VudCwgaSwgajsKKwlib29s
IGNhbl9jbG9uZSA9IGZhbHNlOworCXN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICpkbXRfbW9kZSwg
Km1vZGU7CisKKwkvKiBvbmx5IGNvbnRlbXBsYXRlIGNsb25pbmcgaW4gdGhlIHNpbmdsZSBjcnRj
IGNhc2UgKi8KKwlpZiAoZGV2LT5tb2RlX2NvbmZpZy5udW1fY3J0YyA+IDEpCisJCXJldHVybiBm
YWxzZTsKKworCWNvdW50ID0gMDsKKwlmb3IgKGkgPSAwOyBpIDwgY29ubmVjdG9yX2NvdW50OyBp
KyspIHsKKwkJaWYgKGVuYWJsZWRbaV0pCisJCQljb3VudCsrOworCX0KKworCS8qIG9ubHkgY29u
dGVtcGxhdGUgY2xvbmluZyBpZiBtb3JlIHRoYW4gb25lIGNvbm5lY3RvciBpcyBlbmFibGVkICov
CisJaWYgKGNvdW50IDw9IDEpCisJCXJldHVybiBmYWxzZTsKKworCS8qIGNoZWNrIHRoZSBjb21t
YW5kIGxpbmUgb3IgaWYgbm90aGluZyBjb21tb24gcGljayAxMDI0eDc2OCAqLworCWNhbl9jbG9u
ZSA9IHRydWU7CisJZm9yIChpID0gMDsgaSA8IGNvbm5lY3Rvcl9jb3VudDsgaSsrKSB7CisJCWlm
ICghZW5hYmxlZFtpXSkKKwkJCWNvbnRpbnVlOworCQltb2Rlc1tpXSA9IGRybV9jb25uZWN0b3Jf
cGlja19jbWRsaW5lX21vZGUoY29ubmVjdG9yc1tpXSk7CisJCWlmICghbW9kZXNbaV0pIHsKKwkJ
CWNhbl9jbG9uZSA9IGZhbHNlOworCQkJYnJlYWs7CisJCX0KKwkJZm9yIChqID0gMDsgaiA8IGk7
IGorKykgeworCQkJaWYgKCFlbmFibGVkW2pdKQorCQkJCWNvbnRpbnVlOworCQkJaWYgKCFkcm1f
bW9kZV9tYXRjaChtb2Rlc1tqXSwgbW9kZXNbaV0sCisJCQkJCSAgICBEUk1fTU9ERV9NQVRDSF9U
SU1JTkdTIHwKKwkJCQkJICAgIERSTV9NT0RFX01BVENIX0NMT0NLIHwKKwkJCQkJICAgIERSTV9N
T0RFX01BVENIX0ZMQUdTIHwKKwkJCQkJICAgIERSTV9NT0RFX01BVENIXzNEX0ZMQUdTKSkKKwkJ
CQljYW5fY2xvbmUgPSBmYWxzZTsKKwkJfQorCX0KKworCWlmIChjYW5fY2xvbmUpIHsKKwkJRFJN
X0RFQlVHX0tNUygiY2FuIGNsb25lIHVzaW5nIGNvbW1hbmQgbGluZVxuIik7CisJCXJldHVybiB0
cnVlOworCX0KKworCS8qIHRyeSBhbmQgZmluZCBhIDEwMjR4NzY4IG1vZGUgb24gZWFjaCBjb25u
ZWN0b3IgKi8KKwljYW5fY2xvbmUgPSB0cnVlOworCWRtdF9tb2RlID0gZHJtX21vZGVfZmluZF9k
bXQoZGV2LCAxMDI0LCA3NjgsIDYwLCBmYWxzZSk7CisKKwlmb3IgKGkgPSAwOyBpIDwgY29ubmVj
dG9yX2NvdW50OyBpKyspIHsKKwkJaWYgKCFlbmFibGVkW2ldKQorCQkJY29udGludWU7CisKKwkJ
bGlzdF9mb3JfZWFjaF9lbnRyeShtb2RlLCAmY29ubmVjdG9yc1tpXS0+bW9kZXMsIGhlYWQpIHsK
KwkJCWlmIChkcm1fbW9kZV9tYXRjaChtb2RlLCBkbXRfbW9kZSwKKwkJCQkJICAgRFJNX01PREVf
TUFUQ0hfVElNSU5HUyB8CisJCQkJCSAgIERSTV9NT0RFX01BVENIX0NMT0NLIHwKKwkJCQkJICAg
RFJNX01PREVfTUFUQ0hfRkxBR1MgfAorCQkJCQkgICBEUk1fTU9ERV9NQVRDSF8zRF9GTEFHUykp
CisJCQkJbW9kZXNbaV0gPSBtb2RlOworCQl9CisJCWlmICghbW9kZXNbaV0pCisJCQljYW5fY2xv
bmUgPSBmYWxzZTsKKwl9CisKKwlpZiAoY2FuX2Nsb25lKSB7CisJCURSTV9ERUJVR19LTVMoImNh
biBjbG9uZSB1c2luZyAxMDI0eDc2OFxuIik7CisJCXJldHVybiB0cnVlOworCX0KKwlEUk1fSU5G
Tygia21zOiBjYW4ndCBlbmFibGUgY2xvbmluZyB3aGVuIHdlIHByb2JhYmx5IHdhbnRlZCB0by5c
biIpOworCXJldHVybiBmYWxzZTsKK30KKworc3RhdGljIGludCBkcm1fY2xpZW50X2dldF90aWxl
X29mZnNldHMoc3RydWN0IGRybV9jb25uZWN0b3IgKipjb25uZWN0b3JzLAorCQkJCSAgICAgICB1
bnNpZ25lZCBpbnQgY29ubmVjdG9yX2NvdW50LAorCQkJCSAgICAgICBzdHJ1Y3QgZHJtX2Rpc3Bs
YXlfbW9kZSAqKm1vZGVzLAorCQkJCSAgICAgICBzdHJ1Y3QgZHJtX2NsaWVudF9vZmZzZXQgKm9m
ZnNldHMsCisJCQkJICAgICAgIGludCBpZHgsCisJCQkJICAgICAgIGludCBoX2lkeCwgaW50IHZf
aWR4KQoreworCXN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3I7CisJaW50IGk7CisJaW50
IGhvZmZzZXQgPSAwLCB2b2Zmc2V0ID0gMDsKKworCWZvciAoaSA9IDA7IGkgPCBjb25uZWN0b3Jf
Y291bnQ7IGkrKykgeworCQljb25uZWN0b3IgPSBjb25uZWN0b3JzW2ldOworCQlpZiAoIWNvbm5l
Y3Rvci0+aGFzX3RpbGUpCisJCQljb250aW51ZTsKKworCQlpZiAoIW1vZGVzW2ldICYmIChoX2lk
eCB8fCB2X2lkeCkpIHsKKwkJCURSTV9ERUJVR19LTVMoIm5vIG1vZGVzIGZvciBjb25uZWN0b3Ig
dGlsZWQgJWQgJWRcbiIsIGksCisJCQkJICAgICAgY29ubmVjdG9yLT5iYXNlLmlkKTsKKwkJCWNv
bnRpbnVlOworCQl9CisJCWlmIChjb25uZWN0b3ItPnRpbGVfaF9sb2MgPCBoX2lkeCkKKwkJCWhv
ZmZzZXQgKz0gbW9kZXNbaV0tPmhkaXNwbGF5OworCisJCWlmIChjb25uZWN0b3ItPnRpbGVfdl9s
b2MgPCB2X2lkeCkKKwkJCXZvZmZzZXQgKz0gbW9kZXNbaV0tPnZkaXNwbGF5OworCX0KKwlvZmZz
ZXRzW2lkeF0ueCA9IGhvZmZzZXQ7CisJb2Zmc2V0c1tpZHhdLnkgPSB2b2Zmc2V0OworCURSTV9E
RUJVR19LTVMoInJldHVybmVkICVkICVkIGZvciAlZCAlZFxuIiwgaG9mZnNldCwgdm9mZnNldCwg
aF9pZHgsIHZfaWR4KTsKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGJvb2wgZHJtX2NsaWVudF90
YXJnZXRfcHJlZmVycmVkKHN0cnVjdCBkcm1fY29ubmVjdG9yICoqY29ubmVjdG9ycywKKwkJCQkJ
dW5zaWduZWQgaW50IGNvbm5lY3Rvcl9jb3VudCwKKwkJCQkJc3RydWN0IGRybV9kaXNwbGF5X21v
ZGUgKiptb2RlcywKKwkJCQkJc3RydWN0IGRybV9jbGllbnRfb2Zmc2V0ICpvZmZzZXRzLAorCQkJ
CQlib29sICplbmFibGVkLCBpbnQgd2lkdGgsIGludCBoZWlnaHQpCit7CisJY29uc3QgdTY0IG1h
c2sgPSBCSVRfVUxMKGNvbm5lY3Rvcl9jb3VudCkgLSAxOworCXN0cnVjdCBkcm1fY29ubmVjdG9y
ICpjb25uZWN0b3I7CisJdTY0IGNvbm5fY29uZmlndXJlZCA9IDA7CisJaW50IHRpbGVfcGFzcyA9
IDA7CisJaW50IGk7CisKK3JldHJ5OgorCWZvciAoaSA9IDA7IGkgPCBjb25uZWN0b3JfY291bnQ7
IGkrKykgeworCQljb25uZWN0b3IgPSBjb25uZWN0b3JzW2ldOworCisJCWlmIChjb25uX2NvbmZp
Z3VyZWQgJiBCSVRfVUxMKGkpKQorCQkJY29udGludWU7CisKKwkJaWYgKGVuYWJsZWRbaV0gPT0g
ZmFsc2UpIHsKKwkJCWNvbm5fY29uZmlndXJlZCB8PSBCSVRfVUxMKGkpOworCQkJY29udGludWU7
CisJCX0KKworCQkvKiBmaXJzdCBwYXNzIG92ZXIgYWxsIHRoZSB1bnRpbGVkIGNvbm5lY3RvcnMg
Ki8KKwkJaWYgKHRpbGVfcGFzcyA9PSAwICYmIGNvbm5lY3Rvci0+aGFzX3RpbGUpCisJCQljb250
aW51ZTsKKworCQlpZiAodGlsZV9wYXNzID09IDEpIHsKKwkJCWlmIChjb25uZWN0b3ItPnRpbGVf
aF9sb2MgIT0gMCB8fAorCQkJICAgIGNvbm5lY3Rvci0+dGlsZV92X2xvYyAhPSAwKQorCQkJCWNv
bnRpbnVlOworCisJCX0gZWxzZSB7CisJCQlpZiAoY29ubmVjdG9yLT50aWxlX2hfbG9jICE9IHRp
bGVfcGFzcyAtIDEgJiYKKwkJCSAgICBjb25uZWN0b3ItPnRpbGVfdl9sb2MgIT0gdGlsZV9wYXNz
IC0gMSkKKwkJCS8qIGlmIHRoaXMgdGlsZV9wYXNzIGRvZXNuJ3QgY292ZXIgYW55IG9mIHRoZSB0
aWxlcyAtIGtlZXAgZ29pbmcgKi8KKwkJCQljb250aW51ZTsKKworCQkJLyoKKwkJCSAqIGZpbmQg
dGhlIHRpbGUgb2Zmc2V0cyBmb3IgdGhpcyBwYXNzIC0gbmVlZCB0byBmaW5kCisJCQkgKiBhbGwg
dGlsZXMgbGVmdCBhbmQgYWJvdmUKKwkJCSAqLworCQkJZHJtX2NsaWVudF9nZXRfdGlsZV9vZmZz
ZXRzKGNvbm5lY3RvcnMsIGNvbm5lY3Rvcl9jb3VudCwgbW9kZXMsIG9mZnNldHMsIGksCisJCQkJ
CQkgICAgY29ubmVjdG9yLT50aWxlX2hfbG9jLCBjb25uZWN0b3ItPnRpbGVfdl9sb2MpOworCQl9
CisJCURSTV9ERUJVR19LTVMoImxvb2tpbmcgZm9yIGNtZGxpbmUgbW9kZSBvbiBjb25uZWN0b3Ig
JWRcbiIsCisJCQkgICAgICBjb25uZWN0b3ItPmJhc2UuaWQpOworCisJCS8qIGdvdCBmb3IgY29t
bWFuZCBsaW5lIG1vZGUgZmlyc3QgKi8KKwkJbW9kZXNbaV0gPSBkcm1fY29ubmVjdG9yX3BpY2tf
Y21kbGluZV9tb2RlKGNvbm5lY3Rvcik7CisJCWlmICghbW9kZXNbaV0pIHsKKwkJCURSTV9ERUJV
R19LTVMoImxvb2tpbmcgZm9yIHByZWZlcnJlZCBtb2RlIG9uIGNvbm5lY3RvciAlZCAlZFxuIiwK
KwkJCQkgICAgICBjb25uZWN0b3ItPmJhc2UuaWQsIGNvbm5lY3Rvci0+dGlsZV9ncm91cCA/IGNv
bm5lY3Rvci0+dGlsZV9ncm91cC0+aWQgOiAwKTsKKwkJCW1vZGVzW2ldID0gZHJtX2Nvbm5lY3Rv
cl9oYXNfcHJlZmVycmVkX21vZGUoY29ubmVjdG9yLCB3aWR0aCwgaGVpZ2h0KTsKKwkJfQorCQkv
KiBObyBwcmVmZXJyZWQgbW9kZXMsIHBpY2sgb25lIG9mZiB0aGUgbGlzdCAqLworCQlpZiAoIW1v
ZGVzW2ldICYmICFsaXN0X2VtcHR5KCZjb25uZWN0b3ItPm1vZGVzKSkgeworCQkJbGlzdF9mb3Jf
ZWFjaF9lbnRyeShtb2Rlc1tpXSwgJmNvbm5lY3Rvci0+bW9kZXMsIGhlYWQpCisJCQkJYnJlYWs7
CisJCX0KKwkJRFJNX0RFQlVHX0tNUygiZm91bmQgbW9kZSAlc1xuIiwgbW9kZXNbaV0gPyBtb2Rl
c1tpXS0+bmFtZSA6CisJCQkgICJub25lIik7CisJCWNvbm5fY29uZmlndXJlZCB8PSBCSVRfVUxM
KGkpOworCX0KKworCWlmICgoY29ubl9jb25maWd1cmVkICYgbWFzaykgIT0gbWFzaykgeworCQl0
aWxlX3Bhc3MrKzsKKwkJZ290byByZXRyeTsKKwl9CisJcmV0dXJuIHRydWU7Cit9CisKK3N0YXRp
YyBib29sIGNvbm5lY3Rvcl9oYXNfcG9zc2libGVfY3J0YyhzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAq
Y29ubmVjdG9yLAorCQkJCQlzdHJ1Y3QgZHJtX2NydGMgKmNydGMpCit7CisJc3RydWN0IGRybV9l
bmNvZGVyICplbmNvZGVyOworCWludCBpOworCisJZHJtX2Nvbm5lY3Rvcl9mb3JfZWFjaF9wb3Nz
aWJsZV9lbmNvZGVyKGNvbm5lY3RvciwgZW5jb2RlciwgaSkgeworCQlpZiAoZW5jb2Rlci0+cG9z
c2libGVfY3J0Y3MgJiBkcm1fY3J0Y19tYXNrKGNydGMpKQorCQkJcmV0dXJuIHRydWU7CisJfQor
CisJcmV0dXJuIGZhbHNlOworfQorCitzdGF0aWMgaW50IGRybV9jbGllbnRfcGlja19jcnRjcyhz
dHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCwKKwkJCQkgc3RydWN0IGRybV9jb25uZWN0b3Ig
Kipjb25uZWN0b3JzLAorCQkJCSB1bnNpZ25lZCBpbnQgY29ubmVjdG9yX2NvdW50LAorCQkJCSBz
dHJ1Y3QgZHJtX2NydGMgKipiZXN0X2NydGNzLAorCQkJCSBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9k
ZSAqKm1vZGVzLAorCQkJCSBpbnQgbiwgaW50IHdpZHRoLCBpbnQgaGVpZ2h0KQoreworCXN0cnVj
dCBkcm1fZGV2aWNlICpkZXYgPSBjbGllbnQtPmRldjsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAq
Y29ubmVjdG9yOworCWludCBteV9zY29yZSwgYmVzdF9zY29yZSwgc2NvcmU7CisJc3RydWN0IGRy
bV9jcnRjICoqY3J0Y3MsICpjcnRjOworCXN0cnVjdCBkcm1fbW9kZV9zZXQgKm1vZGVzZXQ7CisJ
aW50IG87CisKKwlpZiAobiA9PSBjb25uZWN0b3JfY291bnQpCisJCXJldHVybiAwOworCisJY29u
bmVjdG9yID0gY29ubmVjdG9yc1tuXTsKKworCWJlc3RfY3J0Y3Nbbl0gPSBOVUxMOworCWJlc3Rf
c2NvcmUgPSBkcm1fY2xpZW50X3BpY2tfY3J0Y3MoY2xpZW50LCBjb25uZWN0b3JzLCBjb25uZWN0
b3JfY291bnQsCisJCQkJCSAgIGJlc3RfY3J0Y3MsIG1vZGVzLCBuICsgMSwgd2lkdGgsIGhlaWdo
dCk7CisJaWYgKG1vZGVzW25dID09IE5VTEwpCisJCXJldHVybiBiZXN0X3Njb3JlOworCisJY3J0
Y3MgPSBrY2FsbG9jKGNvbm5lY3Rvcl9jb3VudCwgc2l6ZW9mKCpjcnRjcyksIEdGUF9LRVJORUwp
OworCWlmICghY3J0Y3MpCisJCXJldHVybiBiZXN0X3Njb3JlOworCisJbXlfc2NvcmUgPSAxOwor
CWlmIChjb25uZWN0b3ItPnN0YXR1cyA9PSBjb25uZWN0b3Jfc3RhdHVzX2Nvbm5lY3RlZCkKKwkJ
bXlfc2NvcmUrKzsKKwlpZiAoY29ubmVjdG9yLT5jbWRsaW5lX21vZGUuc3BlY2lmaWVkKQorCQlt
eV9zY29yZSsrOworCWlmIChkcm1fY29ubmVjdG9yX2hhc19wcmVmZXJyZWRfbW9kZShjb25uZWN0
b3IsIHdpZHRoLCBoZWlnaHQpKQorCQlteV9zY29yZSsrOworCisJLyoKKwkgKiBzZWxlY3QgYSBj
cnRjIGZvciB0aGlzIGNvbm5lY3RvciBhbmQgdGhlbiBhdHRlbXB0IHRvIGNvbmZpZ3VyZQorCSAq
IHJlbWFpbmluZyBjb25uZWN0b3JzCisJICovCisJZHJtX2NsaWVudF9mb3JfZWFjaF9tb2Rlc2V0
KG1vZGVzZXQsIGNsaWVudCkgeworCQljcnRjID0gbW9kZXNldC0+Y3J0YzsKKworCQlpZiAoIWNv
bm5lY3Rvcl9oYXNfcG9zc2libGVfY3J0Yyhjb25uZWN0b3IsIGNydGMpKQorCQkJY29udGludWU7
CisKKwkJZm9yIChvID0gMDsgbyA8IG47IG8rKykKKwkJCWlmIChiZXN0X2NydGNzW29dID09IGNy
dGMpCisJCQkJYnJlYWs7CisKKwkJaWYgKG8gPCBuKSB7CisJCQkvKiBpZ25vcmUgY2xvbmluZyB1
bmxlc3Mgb25seSBhIHNpbmdsZSBjcnRjICovCisJCQlpZiAoZGV2LT5tb2RlX2NvbmZpZy5udW1f
Y3J0YyA+IDEpCisJCQkJY29udGludWU7CisKKwkJCWlmICghZHJtX21vZGVfZXF1YWwobW9kZXNb
b10sIG1vZGVzW25dKSkKKwkJCQljb250aW51ZTsKKwkJfQorCisJCWNydGNzW25dID0gY3J0YzsK
KwkJbWVtY3B5KGNydGNzLCBiZXN0X2NydGNzLCBuICogc2l6ZW9mKCpjcnRjcykpOworCQlzY29y
ZSA9IG15X3Njb3JlICsgZHJtX2NsaWVudF9waWNrX2NydGNzKGNsaWVudCwgY29ubmVjdG9ycywg
Y29ubmVjdG9yX2NvdW50LAorCQkJCQkJCSBjcnRjcywgbW9kZXMsIG4gKyAxLCB3aWR0aCwgaGVp
Z2h0KTsKKwkJaWYgKHNjb3JlID4gYmVzdF9zY29yZSkgeworCQkJYmVzdF9zY29yZSA9IHNjb3Jl
OworCQkJbWVtY3B5KGJlc3RfY3J0Y3MsIGNydGNzLCBjb25uZWN0b3JfY291bnQgKiBzaXplb2Yo
KmNydGNzKSk7CisJCX0KKwl9CisKKwlrZnJlZShjcnRjcyk7CisJcmV0dXJuIGJlc3Rfc2NvcmU7
Cit9CisKKy8qIFRyeSB0byByZWFkIHRoZSBCSU9TIGRpc3BsYXkgY29uZmlndXJhdGlvbiBhbmQg
dXNlIGl0IGZvciB0aGUgaW5pdGlhbCBjb25maWcgKi8KK3N0YXRpYyBib29sIGRybV9jbGllbnRf
ZmlybXdhcmVfY29uZmlnKHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50LAorCQkJCSAgICAg
ICBzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqKmNvbm5lY3RvcnMsCisJCQkJICAgICAgIHVuc2lnbmVk
IGludCBjb25uZWN0b3JfY291bnQsCisJCQkJICAgICAgIHN0cnVjdCBkcm1fY3J0YyAqKmNydGNz
LAorCQkJCSAgICAgICBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqKm1vZGVzLAorCQkJCSAgICAg
ICBzdHJ1Y3QgZHJtX2NsaWVudF9vZmZzZXQgKm9mZnNldHMsCisJCQkJICAgICAgIGJvb2wgKmVu
YWJsZWQsIGludCB3aWR0aCwgaW50IGhlaWdodCkKK3sKKwl1bnNpZ25lZCBpbnQgY291bnQgPSBt
aW5fdCh1bnNpZ25lZCBpbnQsIGNvbm5lY3Rvcl9jb3VudCwgQklUU19QRVJfTE9ORyk7CisJdW5z
aWduZWQgbG9uZyBjb25uX2NvbmZpZ3VyZWQsIGNvbm5fc2VxLCBtYXNrOworCXN0cnVjdCBkcm1f
ZGV2aWNlICpkZXYgPSBjbGllbnQtPmRldjsKKwlpbnQgaSwgajsKKwlib29sICpzYXZlX2VuYWJs
ZWQ7CisJYm9vbCBmYWxsYmFjayA9IHRydWUsIHJldCA9IHRydWU7CisJaW50IG51bV9jb25uZWN0
b3JzX2VuYWJsZWQgPSAwOworCWludCBudW1fY29ubmVjdG9yc19kZXRlY3RlZCA9IDA7CisJc3Ry
dWN0IGRybV9tb2Rlc2V0X2FjcXVpcmVfY3R4IGN0eDsKKworCWlmICghZHJtX2Rydl91c2VzX2F0
b21pY19tb2Rlc2V0KGRldikpCisJCXJldHVybiBmYWxzZTsKKworCXNhdmVfZW5hYmxlZCA9IGtj
YWxsb2MoY291bnQsIHNpemVvZihib29sKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFzYXZlX2VuYWJs
ZWQpCisJCXJldHVybiBmYWxzZTsKKworCWRybV9tb2Rlc2V0X2FjcXVpcmVfaW5pdCgmY3R4LCAw
KTsKKworCXdoaWxlIChkcm1fbW9kZXNldF9sb2NrX2FsbF9jdHgoZGV2LCAmY3R4KSAhPSAwKQor
CQlkcm1fbW9kZXNldF9iYWNrb2ZmKCZjdHgpOworCisJbWVtY3B5KHNhdmVfZW5hYmxlZCwgZW5h
YmxlZCwgY291bnQpOworCW1hc2sgPSBHRU5NQVNLKGNvdW50IC0gMSwgMCk7CisJY29ubl9jb25m
aWd1cmVkID0gMDsKK3JldHJ5OgorCWNvbm5fc2VxID0gY29ubl9jb25maWd1cmVkOworCWZvciAo
aSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CisJCXN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0
b3I7CisJCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcjsKKwkJc3RydWN0IGRybV9jcnRjICpu
ZXdfY3J0YzsKKworCQljb25uZWN0b3IgPSBjb25uZWN0b3JzW2ldOworCisJCWlmIChjb25uX2Nv
bmZpZ3VyZWQgJiBCSVQoaSkpCisJCQljb250aW51ZTsKKworCQlpZiAoY29ubl9zZXEgPT0gMCAm
JiAhY29ubmVjdG9yLT5oYXNfdGlsZSkKKwkJCWNvbnRpbnVlOworCisJCWlmIChjb25uZWN0b3It
PnN0YXR1cyA9PSBjb25uZWN0b3Jfc3RhdHVzX2Nvbm5lY3RlZCkKKwkJCW51bV9jb25uZWN0b3Jz
X2RldGVjdGVkKys7CisKKwkJaWYgKCFlbmFibGVkW2ldKSB7CisJCQlEUk1fREVCVUdfS01TKCJj
b25uZWN0b3IgJXMgbm90IGVuYWJsZWQsIHNraXBwaW5nXG4iLAorCQkJCSAgICAgIGNvbm5lY3Rv
ci0+bmFtZSk7CisJCQljb25uX2NvbmZpZ3VyZWQgfD0gQklUKGkpOworCQkJY29udGludWU7CisJ
CX0KKworCQlpZiAoY29ubmVjdG9yLT5mb3JjZSA9PSBEUk1fRk9SQ0VfT0ZGKSB7CisJCQlEUk1f
REVCVUdfS01TKCJjb25uZWN0b3IgJXMgaXMgZGlzYWJsZWQgYnkgdXNlciwgc2tpcHBpbmdcbiIs
CisJCQkJICAgICAgY29ubmVjdG9yLT5uYW1lKTsKKwkJCWVuYWJsZWRbaV0gPSBmYWxzZTsKKwkJ
CWNvbnRpbnVlOworCQl9CisKKwkJZW5jb2RlciA9IGNvbm5lY3Rvci0+c3RhdGUtPmJlc3RfZW5j
b2RlcjsKKwkJaWYgKCFlbmNvZGVyIHx8IFdBUk5fT04oIWNvbm5lY3Rvci0+c3RhdGUtPmNydGMp
KSB7CisJCQlpZiAoY29ubmVjdG9yLT5mb3JjZSA+IERSTV9GT1JDRV9PRkYpCisJCQkJZ290byBi
YWlsOworCisJCQlEUk1fREVCVUdfS01TKCJjb25uZWN0b3IgJXMgaGFzIG5vIGVuY29kZXIgb3Ig
Y3J0Yywgc2tpcHBpbmdcbiIsCisJCQkJICAgICAgY29ubmVjdG9yLT5uYW1lKTsKKwkJCWVuYWJs
ZWRbaV0gPSBmYWxzZTsKKwkJCWNvbm5fY29uZmlndXJlZCB8PSBCSVQoaSk7CisJCQljb250aW51
ZTsKKwkJfQorCisJCW51bV9jb25uZWN0b3JzX2VuYWJsZWQrKzsKKworCQluZXdfY3J0YyA9IGNv
bm5lY3Rvci0+c3RhdGUtPmNydGM7CisKKwkJLyoKKwkJICogTWFrZSBzdXJlIHdlJ3JlIG5vdCB0
cnlpbmcgdG8gZHJpdmUgbXVsdGlwbGUgY29ubmVjdG9ycworCQkgKiB3aXRoIGEgc2luZ2xlIENS
VEMsIHNpbmNlIG91ciBjbG9uaW5nIHN1cHBvcnQgbWF5IG5vdAorCQkgKiBtYXRjaCB0aGUgQklP
Uy4KKwkJICovCisJCWZvciAoaiA9IDA7IGogPCBjb3VudDsgaisrKSB7CisJCQlpZiAoY3J0Y3Nb
al0gPT0gbmV3X2NydGMpIHsKKwkJCQlEUk1fREVCVUdfS01TKCJmYWxsYmFjazogY2xvbmVkIGNv
bmZpZ3VyYXRpb25cbiIpOworCQkJCWdvdG8gYmFpbDsKKwkJCX0KKwkJfQorCisJCURSTV9ERUJV
R19LTVMoImxvb2tpbmcgZm9yIGNtZGxpbmUgbW9kZSBvbiBjb25uZWN0b3IgJXNcbiIsCisJCQkg
ICAgICBjb25uZWN0b3ItPm5hbWUpOworCisJCS8qIGdvIGZvciBjb21tYW5kIGxpbmUgbW9kZSBm
aXJzdCAqLworCQltb2Rlc1tpXSA9IGRybV9jb25uZWN0b3JfcGlja19jbWRsaW5lX21vZGUoY29u
bmVjdG9yKTsKKworCQkvKiB0cnkgZm9yIHByZWZlcnJlZCBuZXh0ICovCisJCWlmICghbW9kZXNb
aV0pIHsKKwkJCURSTV9ERUJVR19LTVMoImxvb2tpbmcgZm9yIHByZWZlcnJlZCBtb2RlIG9uIGNv
bm5lY3RvciAlcyAlZFxuIiwKKwkJCQkgICAgICBjb25uZWN0b3ItPm5hbWUsIGNvbm5lY3Rvci0+
aGFzX3RpbGUpOworCQkJbW9kZXNbaV0gPSBkcm1fY29ubmVjdG9yX2hhc19wcmVmZXJyZWRfbW9k
ZShjb25uZWN0b3IsIHdpZHRoLCBoZWlnaHQpOworCQl9CisKKwkJLyogTm8gcHJlZmVycmVkIG1v
ZGUgbWFya2VkIGJ5IHRoZSBFRElEPyBBcmUgdGhlcmUgYW55IG1vZGVzPyAqLworCQlpZiAoIW1v
ZGVzW2ldICYmICFsaXN0X2VtcHR5KCZjb25uZWN0b3ItPm1vZGVzKSkgeworCQkJRFJNX0RFQlVH
X0tNUygidXNpbmcgZmlyc3QgbW9kZSBsaXN0ZWQgb24gY29ubmVjdG9yICVzXG4iLAorCQkJCSAg
ICAgIGNvbm5lY3Rvci0+bmFtZSk7CisJCQltb2Rlc1tpXSA9IGxpc3RfZmlyc3RfZW50cnkoJmNv
bm5lY3Rvci0+bW9kZXMsCisJCQkJCQkgICAgc3RydWN0IGRybV9kaXNwbGF5X21vZGUsCisJCQkJ
CQkgICAgaGVhZCk7CisJCX0KKworCQkvKiBsYXN0IHJlc29ydDogdXNlIGN1cnJlbnQgbW9kZSAq
LworCQlpZiAoIW1vZGVzW2ldKSB7CisJCQkvKgorCQkJICogSU1QT1JUQU5UOiBXZSB3YW50IHRv
IHVzZSB0aGUgYWRqdXN0ZWQgbW9kZSAoaS5lLgorCQkJICogYWZ0ZXIgdGhlIHBhbmVsIGZpdHRl
ciB1cHNjYWxpbmcpIGFzIHRoZSBpbml0aWFsCisJCQkgKiBjb25maWcsIG5vdCB0aGUgaW5wdXQg
bW9kZSwgd2hpY2ggaXMgd2hhdCBjcnRjLT5tb2RlCisJCQkgKiB1c3VhbGx5IGNvbnRhaW5zLiBC
dXQgc2luY2Ugb3VyIGN1cnJlbnQKKwkJCSAqIGNvZGUgcHV0cyBhIG1vZGUgZGVyaXZlZCBmcm9t
IHRoZSBwb3N0LXBmaXQgdGltaW5ncworCQkJICogaW50byBjcnRjLT5tb2RlIHRoaXMgd29ya3Mg
b3V0IGNvcnJlY3RseS4KKwkJCSAqCisJCQkgKiBUaGlzIGlzIGNydGMtPm1vZGUgYW5kIG5vdCBj
cnRjLT5zdGF0ZS0+bW9kZSBmb3IgdGhlCisJCQkgKiBmYXN0Ym9vdCBjaGVjayB0byB3b3JrIGNv
cnJlY3RseS4KKwkJCSAqLworCQkJRFJNX0RFQlVHX0tNUygibG9va2luZyBmb3IgY3VycmVudCBt
b2RlIG9uIGNvbm5lY3RvciAlc1xuIiwKKwkJCQkgICAgICBjb25uZWN0b3ItPm5hbWUpOworCQkJ
bW9kZXNbaV0gPSAmY29ubmVjdG9yLT5zdGF0ZS0+Y3J0Yy0+bW9kZTsKKwkJfQorCQljcnRjc1tp
XSA9IG5ld19jcnRjOworCisJCURSTV9ERUJVR19LTVMoImNvbm5lY3RvciAlcyBvbiBbQ1JUQzol
ZDolc106ICVkeCVkJXNcbiIsCisJCQkgICAgICBjb25uZWN0b3ItPm5hbWUsCisJCQkgICAgICBj
b25uZWN0b3ItPnN0YXRlLT5jcnRjLT5iYXNlLmlkLAorCQkJICAgICAgY29ubmVjdG9yLT5zdGF0
ZS0+Y3J0Yy0+bmFtZSwKKwkJCSAgICAgIG1vZGVzW2ldLT5oZGlzcGxheSwgbW9kZXNbaV0tPnZk
aXNwbGF5LAorCQkJICAgICAgbW9kZXNbaV0tPmZsYWdzICYgRFJNX01PREVfRkxBR19JTlRFUkxB
Q0UgPyAiaSIgOiAiIik7CisKKwkJZmFsbGJhY2sgPSBmYWxzZTsKKwkJY29ubl9jb25maWd1cmVk
IHw9IEJJVChpKTsKKwl9CisKKwlpZiAoKGNvbm5fY29uZmlndXJlZCAmIG1hc2spICE9IG1hc2sg
JiYgY29ubl9jb25maWd1cmVkICE9IGNvbm5fc2VxKQorCQlnb3RvIHJldHJ5OworCisJLyoKKwkg
KiBJZiB0aGUgQklPUyBkaWRuJ3QgZW5hYmxlIGV2ZXJ5dGhpbmcgaXQgY291bGQsIGZhbGwgYmFj
ayB0byBoYXZlIHRoZQorCSAqIHNhbWUgdXNlciBleHBlcmllbmNpbmcgb2YgbGlnaHRpbmcgdXAg
YXMgbXVjaCBhcyBwb3NzaWJsZSBsaWtlIHRoZQorCSAqIGZiZGV2IGhlbHBlciBsaWJyYXJ5Lgor
CSAqLworCWlmIChudW1fY29ubmVjdG9yc19lbmFibGVkICE9IG51bV9jb25uZWN0b3JzX2RldGVj
dGVkICYmCisJICAgIG51bV9jb25uZWN0b3JzX2VuYWJsZWQgPCBkZXYtPm1vZGVfY29uZmlnLm51
bV9jcnRjKSB7CisJCURSTV9ERUJVR19LTVMoImZhbGxiYWNrOiBOb3QgYWxsIG91dHB1dHMgZW5h
YmxlZFxuIik7CisJCURSTV9ERUJVR19LTVMoIkVuYWJsZWQ6ICVpLCBkZXRlY3RlZDogJWlcbiIs
IG51bV9jb25uZWN0b3JzX2VuYWJsZWQsCisJCQkgICAgICBudW1fY29ubmVjdG9yc19kZXRlY3Rl
ZCk7CisJCWZhbGxiYWNrID0gdHJ1ZTsKKwl9CisKKwlpZiAoZmFsbGJhY2spIHsKK2JhaWw6CisJ
CURSTV9ERUJVR19LTVMoIk5vdCB1c2luZyBmaXJtd2FyZSBjb25maWd1cmF0aW9uXG4iKTsKKwkJ
bWVtY3B5KGVuYWJsZWQsIHNhdmVfZW5hYmxlZCwgY291bnQpOworCQlyZXQgPSBmYWxzZTsKKwl9
CisKKwlkcm1fbW9kZXNldF9kcm9wX2xvY2tzKCZjdHgpOworCWRybV9tb2Rlc2V0X2FjcXVpcmVf
ZmluaSgmY3R4KTsKKworCWtmcmVlKHNhdmVfZW5hYmxlZCk7CisJcmV0dXJuIHJldDsKK30KKwor
LyoqCisgKiBkcm1fY2xpZW50X21vZGVzZXRfcHJvYmUoKSAtIFByb2JlIGZvciBkaXNwbGF5cwor
ICogQGNsaWVudDogRFJNIGNsaWVudAorICogQHdpZHRoOiBNYXhpbXVtIGRpc3BsYXkgbW9kZSB3
aWR0aCAob3B0aW9uYWwpCisgKiBAaGVpZ2h0OiBNYXhpbXVtIGRpc3BsYXkgbW9kZSBoZWlnaHQg
KG9wdGlvbmFsKQorICoKKyAqIFRoaXMgZnVuY3Rpb24gc2V0cyB1cCBkaXNwbGF5IHBpcGVsaW5l
cyBmb3IgZW5hYmxlZCBjb25uZWN0b3JzIGFuZCBzdG9yZXMgdGhlCisgKiBjb25maWcgaW4gdGhl
IGNsaWVudCdzIG1vZGVzZXQgYXJyYXkuCisgKgorICogUmV0dXJuczoKKyAqIFplcm8gb24gc3Vj
Y2VzcyBvciBuZWdhdGl2ZSBlcnJvciBjb2RlIG9uIGZhaWx1cmUuCisgKi8KK2ludCBkcm1fY2xp
ZW50X21vZGVzZXRfcHJvYmUoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQsIHVuc2lnbmVk
IGludCB3aWR0aCwgdW5zaWduZWQgaW50IGhlaWdodCkKK3sKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3Rv
ciAqY29ubmVjdG9yLCAqKmNvbm5lY3RvcnMgPSBOVUxMOworCXN0cnVjdCBkcm1fY29ubmVjdG9y
X2xpc3RfaXRlciBjb25uX2l0ZXI7CisJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVudC0+
ZGV2OworCXVuc2lnbmVkIGludCB0b3RhbF9tb2Rlc19jb3VudCA9IDA7CisJc3RydWN0IGRybV9j
bGllbnRfb2Zmc2V0ICpvZmZzZXRzOworCXVuc2lnbmVkIGludCBjb25uZWN0b3JfY291bnQgPSAw
OworCXN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICoqbW9kZXM7CisJc3RydWN0IGRybV9jcnRjICoq
Y3J0Y3M7CisJaW50IGksIHJldCA9IDA7CisJYm9vbCAqZW5hYmxlZDsKKworCURSTV9ERUJVR19L
TVMoIlxuIik7CisKKwlpZiAoIXdpZHRoKQorCQl3aWR0aCA9IGRldi0+bW9kZV9jb25maWcubWF4
X3dpZHRoOworCWlmICghaGVpZ2h0KQorCQloZWlnaHQgPSBkZXYtPm1vZGVfY29uZmlnLm1heF9o
ZWlnaHQ7CisKKwlkcm1fY29ubmVjdG9yX2xpc3RfaXRlcl9iZWdpbihkZXYsICZjb25uX2l0ZXIp
OworCWRybV9jbGllbnRfZm9yX2VhY2hfY29ubmVjdG9yX2l0ZXIoY29ubmVjdG9yLCAmY29ubl9p
dGVyKSB7CisJCXN0cnVjdCBkcm1fY29ubmVjdG9yICoqdG1wOworCisJCXRtcCA9IGtyZWFsbG9j
KGNvbm5lY3RvcnMsIChjb25uZWN0b3JfY291bnQgKyAxKSAqIHNpemVvZigqY29ubmVjdG9ycyks
IEdGUF9LRVJORUwpOworCQlpZiAoIXRtcCkgeworCQkJcmV0ID0gLUVOT01FTTsKKwkJCWdvdG8g
ZnJlZV9jb25uZWN0b3JzOworCQl9CisKKwkJY29ubmVjdG9ycyA9IHRtcDsKKwkJZHJtX2Nvbm5l
Y3Rvcl9nZXQoY29ubmVjdG9yKTsKKwkJY29ubmVjdG9yc1tjb25uZWN0b3JfY291bnQrK10gPSBj
b25uZWN0b3I7CisJfQorCWRybV9jb25uZWN0b3JfbGlzdF9pdGVyX2VuZCgmY29ubl9pdGVyKTsK
KworCWlmICghY29ubmVjdG9yX2NvdW50KQorCQlyZXR1cm4gMDsKKworCWNydGNzID0ga2NhbGxv
Yyhjb25uZWN0b3JfY291bnQsIHNpemVvZigqY3J0Y3MpLCBHRlBfS0VSTkVMKTsKKwltb2RlcyA9
IGtjYWxsb2MoY29ubmVjdG9yX2NvdW50LCBzaXplb2YoKm1vZGVzKSwgR0ZQX0tFUk5FTCk7CisJ
b2Zmc2V0cyA9IGtjYWxsb2MoY29ubmVjdG9yX2NvdW50LCBzaXplb2YoKm9mZnNldHMpLCBHRlBf
S0VSTkVMKTsKKwllbmFibGVkID0ga2NhbGxvYyhjb25uZWN0b3JfY291bnQsIHNpemVvZihib29s
KSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFjcnRjcyB8fCAhbW9kZXMgfHwgIWVuYWJsZWQgfHwgIW9m
ZnNldHMpIHsKKwkJRFJNX0VSUk9SKCJNZW1vcnkgYWxsb2NhdGlvbiBmYWlsZWRcbiIpOworCQly
ZXQgPSAtRU5PTUVNOworCQlnb3RvIG91dDsKKwl9CisKKwltdXRleF9sb2NrKCZjbGllbnQtPm1v
ZGVzZXRfbXV0ZXgpOworCisJbXV0ZXhfbG9jaygmZGV2LT5tb2RlX2NvbmZpZy5tdXRleCk7CisJ
Zm9yIChpID0gMDsgaSA8IGNvbm5lY3Rvcl9jb3VudDsgaSsrKQorCQl0b3RhbF9tb2Rlc19jb3Vu
dCArPSBjb25uZWN0b3JzW2ldLT5mdW5jcy0+ZmlsbF9tb2Rlcyhjb25uZWN0b3JzW2ldLCB3aWR0
aCwgaGVpZ2h0KTsKKwlpZiAoIXRvdGFsX21vZGVzX2NvdW50KQorCQlEUk1fREVCVUdfS01TKCJO
byBjb25uZWN0b3JzIHJlcG9ydGVkIGNvbm5lY3RlZCB3aXRoIG1vZGVzXG4iKTsKKwlkcm1fY2xp
ZW50X2Nvbm5lY3RvcnNfZW5hYmxlZChjb25uZWN0b3JzLCBjb25uZWN0b3JfY291bnQsIGVuYWJs
ZWQpOworCisJaWYgKCFkcm1fY2xpZW50X2Zpcm13YXJlX2NvbmZpZyhjbGllbnQsIGNvbm5lY3Rv
cnMsIGNvbm5lY3Rvcl9jb3VudCwgY3J0Y3MsCisJCQkJCW1vZGVzLCBvZmZzZXRzLCBlbmFibGVk
LCB3aWR0aCwgaGVpZ2h0KSkgeworCQltZW1zZXQobW9kZXMsIDAsIGNvbm5lY3Rvcl9jb3VudCAq
IHNpemVvZigqbW9kZXMpKTsKKwkJbWVtc2V0KGNydGNzLCAwLCBjb25uZWN0b3JfY291bnQgKiBz
aXplb2YoKmNydGNzKSk7CisJCW1lbXNldChvZmZzZXRzLCAwLCBjb25uZWN0b3JfY291bnQgKiBz
aXplb2YoKm9mZnNldHMpKTsKKworCQlpZiAoIWRybV9jbGllbnRfdGFyZ2V0X2Nsb25lZChkZXYs
IGNvbm5lY3RvcnMsIGNvbm5lY3Rvcl9jb3VudCwgbW9kZXMsCisJCQkJCSAgICAgIG9mZnNldHMs
IGVuYWJsZWQsIHdpZHRoLCBoZWlnaHQpICYmCisJCSAgICAhZHJtX2NsaWVudF90YXJnZXRfcHJl
ZmVycmVkKGNvbm5lY3RvcnMsIGNvbm5lY3Rvcl9jb3VudCwgbW9kZXMsCisJCQkJCQkgb2Zmc2V0
cywgZW5hYmxlZCwgd2lkdGgsIGhlaWdodCkpCisJCQlEUk1fRVJST1IoIlVuYWJsZSB0byBmaW5k
IGluaXRpYWwgbW9kZXNcbiIpOworCisJCURSTV9ERUJVR19LTVMoInBpY2tpbmcgQ1JUQ3MgZm9y
ICVkeCVkIGNvbmZpZ1xuIiwKKwkJCSAgICAgIHdpZHRoLCBoZWlnaHQpOworCisJCWRybV9jbGll
bnRfcGlja19jcnRjcyhjbGllbnQsIGNvbm5lY3RvcnMsIGNvbm5lY3Rvcl9jb3VudCwKKwkJCQkg
ICAgICBjcnRjcywgbW9kZXMsIDAsIHdpZHRoLCBoZWlnaHQpOworCX0KKwltdXRleF91bmxvY2so
JmRldi0+bW9kZV9jb25maWcubXV0ZXgpOworCisJZHJtX2NsaWVudF9tb2Rlc2V0X3JlbGVhc2Uo
Y2xpZW50KTsKKworCWZvciAoaSA9IDA7IGkgPCBjb25uZWN0b3JfY291bnQ7IGkrKykgeworCQlz
dHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqbW9kZSA9IG1vZGVzW2ldOworCQlzdHJ1Y3QgZHJtX2Ny
dGMgKmNydGMgPSBjcnRjc1tpXTsKKwkJc3RydWN0IGRybV9jbGllbnRfb2Zmc2V0ICpvZmZzZXQg
PSAmb2Zmc2V0c1tpXTsKKworCQlpZiAobW9kZSAmJiBjcnRjKSB7CisJCQlzdHJ1Y3QgZHJtX21v
ZGVfc2V0ICptb2Rlc2V0ID0gZHJtX2NsaWVudF9maW5kX21vZGVzZXQoY2xpZW50LCBjcnRjKTsK
KwkJCXN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IgPSBjb25uZWN0b3JzW2ldOworCisJ
CQlEUk1fREVCVUdfS01TKCJkZXNpcmVkIG1vZGUgJXMgc2V0IG9uIGNydGMgJWQgKCVkLCVkKVxu
IiwKKwkJCQkgICAgICBtb2RlLT5uYW1lLCBjcnRjLT5iYXNlLmlkLCBvZmZzZXQtPngsIG9mZnNl
dC0+eSk7CisKKwkJCWlmIChXQVJOX09OX09OQ0UobW9kZXNldC0+bnVtX2Nvbm5lY3RvcnMgPT0g
RFJNX0NMSUVOVF9NQVhfQ0xPTkVEX0NPTk5FQ1RPUlMgfHwKKwkJCQkJIChkZXYtPm1vZGVfY29u
ZmlnLm51bV9jcnRjID4gMSAmJiBtb2Rlc2V0LT5udW1fY29ubmVjdG9ycyA9PSAxKSkpIHsKKwkJ
CQlyZXQgPSAtRUlOVkFMOworCQkJCWJyZWFrOworCQkJfQorCisJCQltb2Rlc2V0LT5tb2RlID0g
ZHJtX21vZGVfZHVwbGljYXRlKGRldiwgbW9kZSk7CisJCQlkcm1fY29ubmVjdG9yX2dldChjb25u
ZWN0b3IpOworCQkJbW9kZXNldC0+Y29ubmVjdG9yc1ttb2Rlc2V0LT5udW1fY29ubmVjdG9ycysr
XSA9IGNvbm5lY3RvcjsKKwkJCW1vZGVzZXQtPnggPSBvZmZzZXQtPng7CisJCQltb2Rlc2V0LT55
ID0gb2Zmc2V0LT55OworCQl9CisJfQorCisJbXV0ZXhfdW5sb2NrKCZjbGllbnQtPm1vZGVzZXRf
bXV0ZXgpOworb3V0OgorCWtmcmVlKGNydGNzKTsKKwlrZnJlZShtb2Rlcyk7CisJa2ZyZWUob2Zm
c2V0cyk7CisJa2ZyZWUoZW5hYmxlZCk7CitmcmVlX2Nvbm5lY3RvcnM6CisJZm9yIChpID0gMDsg
aSA8IGNvbm5lY3Rvcl9jb3VudDsgaSsrKQorCQlkcm1fY29ubmVjdG9yX3B1dChjb25uZWN0b3Jz
W2ldKTsKKwlrZnJlZShjb25uZWN0b3JzKTsKKworCXJldHVybiByZXQ7Cit9CitFWFBPUlRfU1lN
Qk9MKGRybV9jbGllbnRfbW9kZXNldF9wcm9iZSk7CiAKIC8qKgogICogZHJtX2NsaWVudF9wYW5l
bF9yb3RhdGlvbigpIC0gQ2hlY2sgcGFuZWwgb3JpZW50YXRpb24KZGlmZiAtLWdpdCBhL2RyaXZl
cnMvZ3B1L2RybS9kcm1fZmJfaGVscGVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2ZiX2hlbHBl
ci5jCmluZGV4IGU3ZjQxZTVkOTI0Yy4uOTQ2Y2FlMTk2NDc1IDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vZHJtX2ZiX2hlbHBlci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmJfaGVs
cGVyLmMKQEAgLTQ4LDEwICs0OCw2IEBACiAKICNpbmNsdWRlICJkcm1faW50ZXJuYWwuaCIKIAot
c3RydWN0IGRybV9jbGllbnRfb2Zmc2V0IHsKLQlpbnQgeCwgeTsKLX07Ci0KIHN0YXRpYyBib29s
IGRybV9mYmRldl9lbXVsYXRpb24gPSB0cnVlOwogbW9kdWxlX3BhcmFtX25hbWVkKGZiZGV2X2Vt
dWxhdGlvbiwgZHJtX2ZiZGV2X2VtdWxhdGlvbiwgYm9vbCwgMDYwMCk7CiBNT0RVTEVfUEFSTV9E
RVNDKGZiZGV2X2VtdWxhdGlvbiwKQEAgLTE3MDMsNjk0ICsxNjk5LDYgQEAgdm9pZCBkcm1fZmJf
aGVscGVyX2ZpbGxfaW5mbyhzdHJ1Y3QgZmJfaW5mbyAqaW5mbywKIH0KIEVYUE9SVF9TWU1CT0wo
ZHJtX2ZiX2hlbHBlcl9maWxsX2luZm8pOwogCi1zdGF0aWMgc3RydWN0IGRybV9kaXNwbGF5X21v
ZGUgKgotZHJtX2Nvbm5lY3Rvcl9oYXNfcHJlZmVycmVkX21vZGUoc3RydWN0IGRybV9jb25uZWN0
b3IgKmNvbm5lY3RvciwgaW50IHdpZHRoLCBpbnQgaGVpZ2h0KQotewotCXN0cnVjdCBkcm1fZGlz
cGxheV9tb2RlICptb2RlOwotCi0JbGlzdF9mb3JfZWFjaF9lbnRyeShtb2RlLCAmY29ubmVjdG9y
LT5tb2RlcywgaGVhZCkgewotCQlpZiAobW9kZS0+aGRpc3BsYXkgPiB3aWR0aCB8fAotCQkgICAg
bW9kZS0+dmRpc3BsYXkgPiBoZWlnaHQpCi0JCQljb250aW51ZTsKLQkJaWYgKG1vZGUtPnR5cGUg
JiBEUk1fTU9ERV9UWVBFX1BSRUZFUlJFRCkKLQkJCXJldHVybiBtb2RlOwotCX0KLQlyZXR1cm4g
TlVMTDsKLX0KLQotc3RhdGljIHN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICoKLWRybV9jb25uZWN0
b3JfcGlja19jbWRsaW5lX21vZGUoc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvcikKLXsK
LQlzdHJ1Y3QgZHJtX2NtZGxpbmVfbW9kZSAqY21kbGluZV9tb2RlOwotCXN0cnVjdCBkcm1fZGlz
cGxheV9tb2RlICptb2RlOwotCWJvb2wgcHJlZmVyX25vbl9pbnRlcmxhY2U7Ci0KLQljbWRsaW5l
X21vZGUgPSAmY29ubmVjdG9yLT5jbWRsaW5lX21vZGU7Ci0JaWYgKGNtZGxpbmVfbW9kZS0+c3Bl
Y2lmaWVkID09IGZhbHNlKQotCQlyZXR1cm4gTlVMTDsKLQotCS8qIGF0dGVtcHQgdG8gZmluZCBh
IG1hdGNoaW5nIG1vZGUgaW4gdGhlIGxpc3Qgb2YgbW9kZXMKLQkgKiAgd2UgaGF2ZSBnb3R0ZW4g
c28gZmFyLCBpZiBub3QgYWRkIGEgQ1ZUIG1vZGUgdGhhdCBjb25mb3JtcwotCSAqLwotCWlmIChj
bWRsaW5lX21vZGUtPnJiIHx8IGNtZGxpbmVfbW9kZS0+bWFyZ2lucykKLQkJZ290byBjcmVhdGVf
bW9kZTsKLQotCXByZWZlcl9ub25faW50ZXJsYWNlID0gIWNtZGxpbmVfbW9kZS0+aW50ZXJsYWNl
OwotYWdhaW46Ci0JbGlzdF9mb3JfZWFjaF9lbnRyeShtb2RlLCAmY29ubmVjdG9yLT5tb2Rlcywg
aGVhZCkgewotCQkvKiBjaGVjayB3aWR0aC9oZWlnaHQgKi8KLQkJaWYgKG1vZGUtPmhkaXNwbGF5
ICE9IGNtZGxpbmVfbW9kZS0+eHJlcyB8fAotCQkgICAgbW9kZS0+dmRpc3BsYXkgIT0gY21kbGlu
ZV9tb2RlLT55cmVzKQotCQkJY29udGludWU7Ci0KLQkJaWYgKGNtZGxpbmVfbW9kZS0+cmVmcmVz
aF9zcGVjaWZpZWQpIHsKLQkJCWlmIChtb2RlLT52cmVmcmVzaCAhPSBjbWRsaW5lX21vZGUtPnJl
ZnJlc2gpCi0JCQkJY29udGludWU7Ci0JCX0KLQotCQlpZiAoY21kbGluZV9tb2RlLT5pbnRlcmxh
Y2UpIHsKLQkJCWlmICghKG1vZGUtPmZsYWdzICYgRFJNX01PREVfRkxBR19JTlRFUkxBQ0UpKQot
CQkJCWNvbnRpbnVlOwotCQl9IGVsc2UgaWYgKHByZWZlcl9ub25faW50ZXJsYWNlKSB7Ci0JCQlp
ZiAobW9kZS0+ZmxhZ3MgJiBEUk1fTU9ERV9GTEFHX0lOVEVSTEFDRSkKLQkJCQljb250aW51ZTsK
LQkJfQotCQlyZXR1cm4gbW9kZTsKLQl9Ci0KLQlpZiAocHJlZmVyX25vbl9pbnRlcmxhY2UpIHsK
LQkJcHJlZmVyX25vbl9pbnRlcmxhY2UgPSBmYWxzZTsKLQkJZ290byBhZ2FpbjsKLQl9Ci0KLWNy
ZWF0ZV9tb2RlOgotCW1vZGUgPSBkcm1fbW9kZV9jcmVhdGVfZnJvbV9jbWRsaW5lX21vZGUoY29u
bmVjdG9yLT5kZXYsIGNtZGxpbmVfbW9kZSk7Ci0JbGlzdF9hZGQoJm1vZGUtPmhlYWQsICZjb25u
ZWN0b3ItPm1vZGVzKTsKLQotCXJldHVybiBtb2RlOwotfQotCi1zdGF0aWMgYm9vbCBkcm1fY29u
bmVjdG9yX2VuYWJsZWQoc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvciwgYm9vbCBzdHJp
Y3QpCi17Ci0JYm9vbCBlbmFibGU7Ci0KLQlpZiAoY29ubmVjdG9yLT5kaXNwbGF5X2luZm8ubm9u
X2Rlc2t0b3ApCi0JCXJldHVybiBmYWxzZTsKLQotCWlmIChzdHJpY3QpCi0JCWVuYWJsZSA9IGNv
bm5lY3Rvci0+c3RhdHVzID09IGNvbm5lY3Rvcl9zdGF0dXNfY29ubmVjdGVkOwotCWVsc2UKLQkJ
ZW5hYmxlID0gY29ubmVjdG9yLT5zdGF0dXMgIT0gY29ubmVjdG9yX3N0YXR1c19kaXNjb25uZWN0
ZWQ7Ci0KLQlyZXR1cm4gZW5hYmxlOwotfQotCi1zdGF0aWMgdm9pZCBkcm1fY2xpZW50X2Nvbm5l
Y3RvcnNfZW5hYmxlZChzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqKmNvbm5lY3RvcnMsCi0JCQkJCSAg
dW5zaWduZWQgaW50IGNvbm5lY3Rvcl9jb3VudCwKLQkJCQkJICBib29sICplbmFibGVkKQotewot
CWJvb2wgYW55X2VuYWJsZWQgPSBmYWxzZTsKLQlzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqY29ubmVj
dG9yOwotCWludCBpID0gMDsKLQotCWZvciAoaSA9IDA7IGkgPCBjb25uZWN0b3JfY291bnQ7IGkr
KykgewotCQljb25uZWN0b3IgPSBjb25uZWN0b3JzW2ldOwotCQllbmFibGVkW2ldID0gZHJtX2Nv
bm5lY3Rvcl9lbmFibGVkKGNvbm5lY3RvciwgdHJ1ZSk7Ci0JCURSTV9ERUJVR19LTVMoImNvbm5l
Y3RvciAlZCBlbmFibGVkPyAlc1xuIiwgY29ubmVjdG9yLT5iYXNlLmlkLAotCQkJICAgICAgY29u
bmVjdG9yLT5kaXNwbGF5X2luZm8ubm9uX2Rlc2t0b3AgPyAibm9uIGRlc2t0b3AiIDogZW5hYmxl
ZFtpXSA/ICJ5ZXMiIDogIm5vIik7Ci0KLQkJYW55X2VuYWJsZWQgfD0gZW5hYmxlZFtpXTsKLQl9
Ci0KLQlpZiAoYW55X2VuYWJsZWQpCi0JCXJldHVybjsKLQotCWZvciAoaSA9IDA7IGkgPCBjb25u
ZWN0b3JfY291bnQ7IGkrKykKLQkJZW5hYmxlZFtpXSA9IGRybV9jb25uZWN0b3JfZW5hYmxlZChj
b25uZWN0b3JzW2ldLCBmYWxzZSk7Ci19Ci0KLXN0YXRpYyBib29sIGRybV9jbGllbnRfdGFyZ2V0
X2Nsb25lZChzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LAotCQkJCSAgICAgc3RydWN0IGRybV9jb25u
ZWN0b3IgKipjb25uZWN0b3JzLAotCQkJCSAgICAgdW5zaWduZWQgaW50IGNvbm5lY3Rvcl9jb3Vu
dCwKLQkJCQkgICAgIHN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICoqbW9kZXMsCi0JCQkJICAgICBz
dHJ1Y3QgZHJtX2NsaWVudF9vZmZzZXQgKm9mZnNldHMsCi0JCQkJICAgICBib29sICplbmFibGVk
LCBpbnQgd2lkdGgsIGludCBoZWlnaHQpCi17Ci0JaW50IGNvdW50LCBpLCBqOwotCWJvb2wgY2Fu
X2Nsb25lID0gZmFsc2U7Ci0Jc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKmRtdF9tb2RlLCAqbW9k
ZTsKLQotCS8qIG9ubHkgY29udGVtcGxhdGUgY2xvbmluZyBpbiB0aGUgc2luZ2xlIGNydGMgY2Fz
ZSAqLwotCWlmIChkZXYtPm1vZGVfY29uZmlnLm51bV9jcnRjID4gMSkKLQkJcmV0dXJuIGZhbHNl
OwotCi0JY291bnQgPSAwOwotCWZvciAoaSA9IDA7IGkgPCBjb25uZWN0b3JfY291bnQ7IGkrKykg
ewotCQlpZiAoZW5hYmxlZFtpXSkKLQkJCWNvdW50Kys7Ci0JfQotCi0JLyogb25seSBjb250ZW1w
bGF0ZSBjbG9uaW5nIGlmIG1vcmUgdGhhbiBvbmUgY29ubmVjdG9yIGlzIGVuYWJsZWQgKi8KLQlp
ZiAoY291bnQgPD0gMSkKLQkJcmV0dXJuIGZhbHNlOwotCi0JLyogY2hlY2sgdGhlIGNvbW1hbmQg
bGluZSBvciBpZiBub3RoaW5nIGNvbW1vbiBwaWNrIDEwMjR4NzY4ICovCi0JY2FuX2Nsb25lID0g
dHJ1ZTsKLQlmb3IgKGkgPSAwOyBpIDwgY29ubmVjdG9yX2NvdW50OyBpKyspIHsKLQkJaWYgKCFl
bmFibGVkW2ldKQotCQkJY29udGludWU7Ci0JCW1vZGVzW2ldID0gZHJtX2Nvbm5lY3Rvcl9waWNr
X2NtZGxpbmVfbW9kZShjb25uZWN0b3JzW2ldKTsKLQkJaWYgKCFtb2Rlc1tpXSkgewotCQkJY2Fu
X2Nsb25lID0gZmFsc2U7Ci0JCQlicmVhazsKLQkJfQotCQlmb3IgKGogPSAwOyBqIDwgaTsgaisr
KSB7Ci0JCQlpZiAoIWVuYWJsZWRbal0pCi0JCQkJY29udGludWU7Ci0JCQlpZiAoIWRybV9tb2Rl
X21hdGNoKG1vZGVzW2pdLCBtb2Rlc1tpXSwKLQkJCQkJICAgIERSTV9NT0RFX01BVENIX1RJTUlO
R1MgfAotCQkJCQkgICAgRFJNX01PREVfTUFUQ0hfQ0xPQ0sgfAotCQkJCQkgICAgRFJNX01PREVf
TUFUQ0hfRkxBR1MgfAotCQkJCQkgICAgRFJNX01PREVfTUFUQ0hfM0RfRkxBR1MpKQotCQkJCWNh
bl9jbG9uZSA9IGZhbHNlOwotCQl9Ci0JfQotCi0JaWYgKGNhbl9jbG9uZSkgewotCQlEUk1fREVC
VUdfS01TKCJjYW4gY2xvbmUgdXNpbmcgY29tbWFuZCBsaW5lXG4iKTsKLQkJcmV0dXJuIHRydWU7
Ci0JfQotCi0JLyogdHJ5IGFuZCBmaW5kIGEgMTAyNHg3NjggbW9kZSBvbiBlYWNoIGNvbm5lY3Rv
ciAqLwotCWNhbl9jbG9uZSA9IHRydWU7Ci0JZG10X21vZGUgPSBkcm1fbW9kZV9maW5kX2RtdChk
ZXYsIDEwMjQsIDc2OCwgNjAsIGZhbHNlKTsKLQotCWZvciAoaSA9IDA7IGkgPCBjb25uZWN0b3Jf
Y291bnQ7IGkrKykgewotCQlpZiAoIWVuYWJsZWRbaV0pCi0JCQljb250aW51ZTsKLQotCQlsaXN0
X2Zvcl9lYWNoX2VudHJ5KG1vZGUsICZjb25uZWN0b3JzW2ldLT5tb2RlcywgaGVhZCkgewotCQkJ
aWYgKGRybV9tb2RlX21hdGNoKG1vZGUsIGRtdF9tb2RlLAotCQkJCQkgICBEUk1fTU9ERV9NQVRD
SF9USU1JTkdTIHwKLQkJCQkJICAgRFJNX01PREVfTUFUQ0hfQ0xPQ0sgfAotCQkJCQkgICBEUk1f
TU9ERV9NQVRDSF9GTEFHUyB8Ci0JCQkJCSAgIERSTV9NT0RFX01BVENIXzNEX0ZMQUdTKSkKLQkJ
CQltb2Rlc1tpXSA9IG1vZGU7Ci0JCX0KLQkJaWYgKCFtb2Rlc1tpXSkKLQkJCWNhbl9jbG9uZSA9
IGZhbHNlOwotCX0KLQotCWlmIChjYW5fY2xvbmUpIHsKLQkJRFJNX0RFQlVHX0tNUygiY2FuIGNs
b25lIHVzaW5nIDEwMjR4NzY4XG4iKTsKLQkJcmV0dXJuIHRydWU7Ci0JfQotCURSTV9JTkZPKCJr
bXM6IGNhbid0IGVuYWJsZSBjbG9uaW5nIHdoZW4gd2UgcHJvYmFibHkgd2FudGVkIHRvLlxuIik7
Ci0JcmV0dXJuIGZhbHNlOwotfQotCi1zdGF0aWMgaW50IGRybV9jbGllbnRfZ2V0X3RpbGVfb2Zm
c2V0cyhzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqKmNvbm5lY3RvcnMsCi0JCQkJICAgICAgIHVuc2ln
bmVkIGludCBjb25uZWN0b3JfY291bnQsCi0JCQkJICAgICAgIHN0cnVjdCBkcm1fZGlzcGxheV9t
b2RlICoqbW9kZXMsCi0JCQkJICAgICAgIHN0cnVjdCBkcm1fY2xpZW50X29mZnNldCAqb2Zmc2V0
cywKLQkJCQkgICAgICAgaW50IGlkeCwKLQkJCQkgICAgICAgaW50IGhfaWR4LCBpbnQgdl9pZHgp
Ci17Ci0Jc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvcjsKLQlpbnQgaTsKLQlpbnQgaG9m
ZnNldCA9IDAsIHZvZmZzZXQgPSAwOwotCi0JZm9yIChpID0gMDsgaSA8IGNvbm5lY3Rvcl9jb3Vu
dDsgaSsrKSB7Ci0JCWNvbm5lY3RvciA9IGNvbm5lY3RvcnNbaV07Ci0JCWlmICghY29ubmVjdG9y
LT5oYXNfdGlsZSkKLQkJCWNvbnRpbnVlOwotCi0JCWlmICghbW9kZXNbaV0gJiYgKGhfaWR4IHx8
IHZfaWR4KSkgewotCQkJRFJNX0RFQlVHX0tNUygibm8gbW9kZXMgZm9yIGNvbm5lY3RvciB0aWxl
ZCAlZCAlZFxuIiwgaSwKLQkJCQkgICAgICBjb25uZWN0b3ItPmJhc2UuaWQpOwotCQkJY29udGlu
dWU7Ci0JCX0KLQkJaWYgKGNvbm5lY3Rvci0+dGlsZV9oX2xvYyA8IGhfaWR4KQotCQkJaG9mZnNl
dCArPSBtb2Rlc1tpXS0+aGRpc3BsYXk7Ci0KLQkJaWYgKGNvbm5lY3Rvci0+dGlsZV92X2xvYyA8
IHZfaWR4KQotCQkJdm9mZnNldCArPSBtb2Rlc1tpXS0+dmRpc3BsYXk7Ci0JfQotCW9mZnNldHNb
aWR4XS54ID0gaG9mZnNldDsKLQlvZmZzZXRzW2lkeF0ueSA9IHZvZmZzZXQ7Ci0JRFJNX0RFQlVH
X0tNUygicmV0dXJuZWQgJWQgJWQgZm9yICVkICVkXG4iLCBob2Zmc2V0LCB2b2Zmc2V0LCBoX2lk
eCwgdl9pZHgpOwotCXJldHVybiAwOwotfQotCi1zdGF0aWMgYm9vbCBkcm1fY2xpZW50X3Rhcmdl
dF9wcmVmZXJyZWQoc3RydWN0IGRybV9jb25uZWN0b3IgKipjb25uZWN0b3JzLAotCQkJCQl1bnNp
Z25lZCBpbnQgY29ubmVjdG9yX2NvdW50LAotCQkJCQlzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAq
Km1vZGVzLAotCQkJCQlzdHJ1Y3QgZHJtX2NsaWVudF9vZmZzZXQgKm9mZnNldHMsCi0JCQkJCWJv
b2wgKmVuYWJsZWQsIGludCB3aWR0aCwgaW50IGhlaWdodCkKLXsKLQljb25zdCB1NjQgbWFzayA9
IEJJVF9VTEwoY29ubmVjdG9yX2NvdW50KSAtIDE7Ci0Jc3RydWN0IGRybV9jb25uZWN0b3IgKmNv
bm5lY3RvcjsKLQl1NjQgY29ubl9jb25maWd1cmVkID0gMDsKLQlpbnQgdGlsZV9wYXNzID0gMDsK
LQlpbnQgaTsKLQotcmV0cnk6Ci0JZm9yIChpID0gMDsgaSA8IGNvbm5lY3Rvcl9jb3VudDsgaSsr
KSB7Ci0JCWNvbm5lY3RvciA9IGNvbm5lY3RvcnNbaV07Ci0KLQkJaWYgKGNvbm5fY29uZmlndXJl
ZCAmIEJJVF9VTEwoaSkpCi0JCQljb250aW51ZTsKLQotCQlpZiAoZW5hYmxlZFtpXSA9PSBmYWxz
ZSkgewotCQkJY29ubl9jb25maWd1cmVkIHw9IEJJVF9VTEwoaSk7Ci0JCQljb250aW51ZTsKLQkJ
fQotCi0JCS8qIGZpcnN0IHBhc3Mgb3ZlciBhbGwgdGhlIHVudGlsZWQgY29ubmVjdG9ycyAqLwot
CQlpZiAodGlsZV9wYXNzID09IDAgJiYgY29ubmVjdG9yLT5oYXNfdGlsZSkKLQkJCWNvbnRpbnVl
OwotCi0JCWlmICh0aWxlX3Bhc3MgPT0gMSkgewotCQkJaWYgKGNvbm5lY3Rvci0+dGlsZV9oX2xv
YyAhPSAwIHx8Ci0JCQkgICAgY29ubmVjdG9yLT50aWxlX3ZfbG9jICE9IDApCi0JCQkJY29udGlu
dWU7Ci0KLQkJfSBlbHNlIHsKLQkJCWlmIChjb25uZWN0b3ItPnRpbGVfaF9sb2MgIT0gdGlsZV9w
YXNzIC0gMSAmJgotCQkJICAgIGNvbm5lY3Rvci0+dGlsZV92X2xvYyAhPSB0aWxlX3Bhc3MgLSAx
KQotCQkJLyogaWYgdGhpcyB0aWxlX3Bhc3MgZG9lc24ndCBjb3ZlciBhbnkgb2YgdGhlIHRpbGVz
IC0ga2VlcCBnb2luZyAqLwotCQkJCWNvbnRpbnVlOwotCi0JCQkvKgotCQkJICogZmluZCB0aGUg
dGlsZSBvZmZzZXRzIGZvciB0aGlzIHBhc3MgLSBuZWVkIHRvIGZpbmQKLQkJCSAqIGFsbCB0aWxl
cyBsZWZ0IGFuZCBhYm92ZQotCQkJICovCi0JCQlkcm1fY2xpZW50X2dldF90aWxlX29mZnNldHMo
Y29ubmVjdG9ycywgY29ubmVjdG9yX2NvdW50LCBtb2Rlcywgb2Zmc2V0cywgaSwKLQkJCQkJCSAg
ICBjb25uZWN0b3ItPnRpbGVfaF9sb2MsIGNvbm5lY3Rvci0+dGlsZV92X2xvYyk7Ci0JCX0KLQkJ
RFJNX0RFQlVHX0tNUygibG9va2luZyBmb3IgY21kbGluZSBtb2RlIG9uIGNvbm5lY3RvciAlZFxu
IiwKLQkJCSAgICAgIGNvbm5lY3Rvci0+YmFzZS5pZCk7Ci0KLQkJLyogZ290IGZvciBjb21tYW5k
IGxpbmUgbW9kZSBmaXJzdCAqLwotCQltb2Rlc1tpXSA9IGRybV9jb25uZWN0b3JfcGlja19jbWRs
aW5lX21vZGUoY29ubmVjdG9yKTsKLQkJaWYgKCFtb2Rlc1tpXSkgewotCQkJRFJNX0RFQlVHX0tN
UygibG9va2luZyBmb3IgcHJlZmVycmVkIG1vZGUgb24gY29ubmVjdG9yICVkICVkXG4iLAotCQkJ
CSAgICAgIGNvbm5lY3Rvci0+YmFzZS5pZCwgY29ubmVjdG9yLT50aWxlX2dyb3VwID8gY29ubmVj
dG9yLT50aWxlX2dyb3VwLT5pZCA6IDApOwotCQkJbW9kZXNbaV0gPSBkcm1fY29ubmVjdG9yX2hh
c19wcmVmZXJyZWRfbW9kZShjb25uZWN0b3IsIHdpZHRoLCBoZWlnaHQpOwotCQl9Ci0JCS8qIE5v
IHByZWZlcnJlZCBtb2RlcywgcGljayBvbmUgb2ZmIHRoZSBsaXN0ICovCi0JCWlmICghbW9kZXNb
aV0gJiYgIWxpc3RfZW1wdHkoJmNvbm5lY3Rvci0+bW9kZXMpKSB7Ci0JCQlsaXN0X2Zvcl9lYWNo
X2VudHJ5KG1vZGVzW2ldLCAmY29ubmVjdG9yLT5tb2RlcywgaGVhZCkKLQkJCQlicmVhazsKLQkJ
fQotCQlEUk1fREVCVUdfS01TKCJmb3VuZCBtb2RlICVzXG4iLCBtb2Rlc1tpXSA/IG1vZGVzW2ld
LT5uYW1lIDoKLQkJCSAgIm5vbmUiKTsKLQkJY29ubl9jb25maWd1cmVkIHw9IEJJVF9VTEwoaSk7
Ci0JfQotCi0JaWYgKChjb25uX2NvbmZpZ3VyZWQgJiBtYXNrKSAhPSBtYXNrKSB7Ci0JCXRpbGVf
cGFzcysrOwotCQlnb3RvIHJldHJ5OwotCX0KLQlyZXR1cm4gdHJ1ZTsKLX0KLQotc3RhdGljIGJv
b2wgY29ubmVjdG9yX2hhc19wb3NzaWJsZV9jcnRjKHN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25u
ZWN0b3IsCi0JCQkJCXN0cnVjdCBkcm1fY3J0YyAqY3J0YykKLXsKLQlzdHJ1Y3QgZHJtX2VuY29k
ZXIgKmVuY29kZXI7Ci0JaW50IGk7Ci0KLQlkcm1fY29ubmVjdG9yX2Zvcl9lYWNoX3Bvc3NpYmxl
X2VuY29kZXIoY29ubmVjdG9yLCBlbmNvZGVyLCBpKSB7Ci0JCWlmIChlbmNvZGVyLT5wb3NzaWJs
ZV9jcnRjcyAmIGRybV9jcnRjX21hc2soY3J0YykpCi0JCQlyZXR1cm4gdHJ1ZTsKLQl9Ci0KLQly
ZXR1cm4gZmFsc2U7Ci19Ci0KLXN0YXRpYyBpbnQgZHJtX2NsaWVudF9waWNrX2NydGNzKHN0cnVj
dCBkcm1fY2xpZW50X2RldiAqY2xpZW50LAotCQkJCSBzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqKmNv
bm5lY3RvcnMsCi0JCQkJIHVuc2lnbmVkIGludCBjb25uZWN0b3JfY291bnQsCi0JCQkJIHN0cnVj
dCBkcm1fY3J0YyAqKmJlc3RfY3J0Y3MsCi0JCQkJIHN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICoq
bW9kZXMsCi0JCQkJIGludCBuLCBpbnQgd2lkdGgsIGludCBoZWlnaHQpCi17Ci0Jc3RydWN0IGRy
bV9kZXZpY2UgKmRldiA9IGNsaWVudC0+ZGV2OwotCXN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25u
ZWN0b3I7Ci0JaW50IG15X3Njb3JlLCBiZXN0X3Njb3JlLCBzY29yZTsKLQlzdHJ1Y3QgZHJtX2Ny
dGMgKipjcnRjcywgKmNydGM7Ci0Jc3RydWN0IGRybV9tb2RlX3NldCAqbW9kZXNldDsKLQlpbnQg
bzsKLQotCWlmIChuID09IGNvbm5lY3Rvcl9jb3VudCkKLQkJcmV0dXJuIDA7Ci0KLQljb25uZWN0
b3IgPSBjb25uZWN0b3JzW25dOwotCi0JYmVzdF9jcnRjc1tuXSA9IE5VTEw7Ci0JYmVzdF9zY29y
ZSA9IGRybV9jbGllbnRfcGlja19jcnRjcyhjbGllbnQsIGNvbm5lY3RvcnMsIGNvbm5lY3Rvcl9j
b3VudCwKLQkJCQkJICAgYmVzdF9jcnRjcywgbW9kZXMsIG4gKyAxLCB3aWR0aCwgaGVpZ2h0KTsK
LQlpZiAobW9kZXNbbl0gPT0gTlVMTCkKLQkJcmV0dXJuIGJlc3Rfc2NvcmU7Ci0KLQljcnRjcyA9
IGtjYWxsb2MoY29ubmVjdG9yX2NvdW50LCBzaXplb2YoKmNydGNzKSwgR0ZQX0tFUk5FTCk7Ci0J
aWYgKCFjcnRjcykKLQkJcmV0dXJuIGJlc3Rfc2NvcmU7Ci0KLQlteV9zY29yZSA9IDE7Ci0JaWYg
KGNvbm5lY3Rvci0+c3RhdHVzID09IGNvbm5lY3Rvcl9zdGF0dXNfY29ubmVjdGVkKQotCQlteV9z
Y29yZSsrOwotCWlmIChjb25uZWN0b3ItPmNtZGxpbmVfbW9kZS5zcGVjaWZpZWQpCi0JCW15X3Nj
b3JlKys7Ci0JaWYgKGRybV9jb25uZWN0b3JfaGFzX3ByZWZlcnJlZF9tb2RlKGNvbm5lY3Rvciwg
d2lkdGgsIGhlaWdodCkpCi0JCW15X3Njb3JlKys7Ci0KLQkvKgotCSAqIHNlbGVjdCBhIGNydGMg
Zm9yIHRoaXMgY29ubmVjdG9yIGFuZCB0aGVuIGF0dGVtcHQgdG8gY29uZmlndXJlCi0JICogcmVt
YWluaW5nIGNvbm5lY3RvcnMKLQkgKi8KLQlkcm1fY2xpZW50X2Zvcl9lYWNoX21vZGVzZXQobW9k
ZXNldCwgY2xpZW50KSB7Ci0JCWNydGMgPSBtb2Rlc2V0LT5jcnRjOwotCi0JCWlmICghY29ubmVj
dG9yX2hhc19wb3NzaWJsZV9jcnRjKGNvbm5lY3RvciwgY3J0YykpCi0JCQljb250aW51ZTsKLQot
CQlmb3IgKG8gPSAwOyBvIDwgbjsgbysrKQotCQkJaWYgKGJlc3RfY3J0Y3Nbb10gPT0gY3J0YykK
LQkJCQlicmVhazsKLQotCQlpZiAobyA8IG4pIHsKLQkJCS8qIGlnbm9yZSBjbG9uaW5nIHVubGVz
cyBvbmx5IGEgc2luZ2xlIGNydGMgKi8KLQkJCWlmIChkZXYtPm1vZGVfY29uZmlnLm51bV9jcnRj
ID4gMSkKLQkJCQljb250aW51ZTsKLQotCQkJaWYgKCFkcm1fbW9kZV9lcXVhbChtb2Rlc1tvXSwg
bW9kZXNbbl0pKQotCQkJCWNvbnRpbnVlOwotCQl9Ci0KLQkJY3J0Y3Nbbl0gPSBjcnRjOwotCQlt
ZW1jcHkoY3J0Y3MsIGJlc3RfY3J0Y3MsIG4gKiBzaXplb2YoKmNydGNzKSk7Ci0JCXNjb3JlID0g
bXlfc2NvcmUgKyBkcm1fY2xpZW50X3BpY2tfY3J0Y3MoY2xpZW50LCBjb25uZWN0b3JzLCBjb25u
ZWN0b3JfY291bnQsCi0JCQkJCQkJIGNydGNzLCBtb2RlcywgbiArIDEsIHdpZHRoLCBoZWlnaHQp
OwotCQlpZiAoc2NvcmUgPiBiZXN0X3Njb3JlKSB7Ci0JCQliZXN0X3Njb3JlID0gc2NvcmU7Ci0J
CQltZW1jcHkoYmVzdF9jcnRjcywgY3J0Y3MsIGNvbm5lY3Rvcl9jb3VudCAqIHNpemVvZigqY3J0
Y3MpKTsKLQkJfQotCX0KLQotCWtmcmVlKGNydGNzKTsKLQlyZXR1cm4gYmVzdF9zY29yZTsKLX0K
LQotLyogVHJ5IHRvIHJlYWQgdGhlIEJJT1MgZGlzcGxheSBjb25maWd1cmF0aW9uIGFuZCB1c2Ug
aXQgZm9yIHRoZSBpbml0aWFsIGNvbmZpZyAqLwotc3RhdGljIGJvb2wgZHJtX2NsaWVudF9maXJt
d2FyZV9jb25maWcoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQsCi0JCQkJICAgICAgIHN0
cnVjdCBkcm1fY29ubmVjdG9yICoqY29ubmVjdG9ycywKLQkJCQkgICAgICAgdW5zaWduZWQgaW50
IGNvbm5lY3Rvcl9jb3VudCwKLQkJCQkgICAgICAgc3RydWN0IGRybV9jcnRjICoqY3J0Y3MsCi0J
CQkJICAgICAgIHN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICoqbW9kZXMsCi0JCQkJICAgICAgIHN0
cnVjdCBkcm1fY2xpZW50X29mZnNldCAqb2Zmc2V0cywKLQkJCQkgICAgICAgYm9vbCAqZW5hYmxl
ZCwgaW50IHdpZHRoLCBpbnQgaGVpZ2h0KQotewotCXVuc2lnbmVkIGludCBjb3VudCA9IG1pbl90
KHVuc2lnbmVkIGludCwgY29ubmVjdG9yX2NvdW50LCBCSVRTX1BFUl9MT05HKTsKLQl1bnNpZ25l
ZCBsb25nIGNvbm5fY29uZmlndXJlZCwgY29ubl9zZXEsIG1hc2s7Ci0Jc3RydWN0IGRybV9kZXZp
Y2UgKmRldiA9IGNsaWVudC0+ZGV2OwotCWludCBpLCBqOwotCWJvb2wgKnNhdmVfZW5hYmxlZDsK
LQlib29sIGZhbGxiYWNrID0gdHJ1ZSwgcmV0ID0gdHJ1ZTsKLQlpbnQgbnVtX2Nvbm5lY3RvcnNf
ZW5hYmxlZCA9IDA7Ci0JaW50IG51bV9jb25uZWN0b3JzX2RldGVjdGVkID0gMDsKLQlzdHJ1Y3Qg
ZHJtX21vZGVzZXRfYWNxdWlyZV9jdHggY3R4OwotCi0JaWYgKCFkcm1fZHJ2X3VzZXNfYXRvbWlj
X21vZGVzZXQoZGV2KSkKLQkJcmV0dXJuIGZhbHNlOwotCi0Jc2F2ZV9lbmFibGVkID0ga2NhbGxv
Yyhjb3VudCwgc2l6ZW9mKGJvb2wpLCBHRlBfS0VSTkVMKTsKLQlpZiAoIXNhdmVfZW5hYmxlZCkK
LQkJcmV0dXJuIGZhbHNlOwotCi0JZHJtX21vZGVzZXRfYWNxdWlyZV9pbml0KCZjdHgsIDApOwot
Ci0Jd2hpbGUgKGRybV9tb2Rlc2V0X2xvY2tfYWxsX2N0eChkZXYsICZjdHgpICE9IDApCi0JCWRy
bV9tb2Rlc2V0X2JhY2tvZmYoJmN0eCk7Ci0KLQltZW1jcHkoc2F2ZV9lbmFibGVkLCBlbmFibGVk
LCBjb3VudCk7Ci0JbWFzayA9IEdFTk1BU0soY291bnQgLSAxLCAwKTsKLQljb25uX2NvbmZpZ3Vy
ZWQgPSAwOwotcmV0cnk6Ci0JY29ubl9zZXEgPSBjb25uX2NvbmZpZ3VyZWQ7Ci0JZm9yIChpID0g
MDsgaSA8IGNvdW50OyBpKyspIHsKLQkJc3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvcjsK
LQkJc3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVyOwotCQlzdHJ1Y3QgZHJtX2NydGMgKm5ld19j
cnRjOwotCi0JCWNvbm5lY3RvciA9IGNvbm5lY3RvcnNbaV07Ci0KLQkJaWYgKGNvbm5fY29uZmln
dXJlZCAmIEJJVChpKSkKLQkJCWNvbnRpbnVlOwotCi0JCWlmIChjb25uX3NlcSA9PSAwICYmICFj
b25uZWN0b3ItPmhhc190aWxlKQotCQkJY29udGludWU7Ci0KLQkJaWYgKGNvbm5lY3Rvci0+c3Rh
dHVzID09IGNvbm5lY3Rvcl9zdGF0dXNfY29ubmVjdGVkKQotCQkJbnVtX2Nvbm5lY3RvcnNfZGV0
ZWN0ZWQrKzsKLQotCQlpZiAoIWVuYWJsZWRbaV0pIHsKLQkJCURSTV9ERUJVR19LTVMoImNvbm5l
Y3RvciAlcyBub3QgZW5hYmxlZCwgc2tpcHBpbmdcbiIsCi0JCQkJICAgICAgY29ubmVjdG9yLT5u
YW1lKTsKLQkJCWNvbm5fY29uZmlndXJlZCB8PSBCSVQoaSk7Ci0JCQljb250aW51ZTsKLQkJfQot
Ci0JCWlmIChjb25uZWN0b3ItPmZvcmNlID09IERSTV9GT1JDRV9PRkYpIHsKLQkJCURSTV9ERUJV
R19LTVMoImNvbm5lY3RvciAlcyBpcyBkaXNhYmxlZCBieSB1c2VyLCBza2lwcGluZ1xuIiwKLQkJ
CQkgICAgICBjb25uZWN0b3ItPm5hbWUpOwotCQkJZW5hYmxlZFtpXSA9IGZhbHNlOwotCQkJY29u
dGludWU7Ci0JCX0KLQotCQllbmNvZGVyID0gY29ubmVjdG9yLT5zdGF0ZS0+YmVzdF9lbmNvZGVy
OwotCQlpZiAoIWVuY29kZXIgfHwgV0FSTl9PTighY29ubmVjdG9yLT5zdGF0ZS0+Y3J0YykpIHsK
LQkJCWlmIChjb25uZWN0b3ItPmZvcmNlID4gRFJNX0ZPUkNFX09GRikKLQkJCQlnb3RvIGJhaWw7
Ci0KLQkJCURSTV9ERUJVR19LTVMoImNvbm5lY3RvciAlcyBoYXMgbm8gZW5jb2RlciBvciBjcnRj
LCBza2lwcGluZ1xuIiwKLQkJCQkgICAgICBjb25uZWN0b3ItPm5hbWUpOwotCQkJZW5hYmxlZFtp
XSA9IGZhbHNlOwotCQkJY29ubl9jb25maWd1cmVkIHw9IEJJVChpKTsKLQkJCWNvbnRpbnVlOwot
CQl9Ci0KLQkJbnVtX2Nvbm5lY3RvcnNfZW5hYmxlZCsrOwotCi0JCW5ld19jcnRjID0gY29ubmVj
dG9yLT5zdGF0ZS0+Y3J0YzsKLQotCQkvKgotCQkgKiBNYWtlIHN1cmUgd2UncmUgbm90IHRyeWlu
ZyB0byBkcml2ZSBtdWx0aXBsZSBjb25uZWN0b3JzCi0JCSAqIHdpdGggYSBzaW5nbGUgQ1JUQywg
c2luY2Ugb3VyIGNsb25pbmcgc3VwcG9ydCBtYXkgbm90Ci0JCSAqIG1hdGNoIHRoZSBCSU9TLgot
CQkgKi8KLQkJZm9yIChqID0gMDsgaiA8IGNvdW50OyBqKyspIHsKLQkJCWlmIChjcnRjc1tqXSA9
PSBuZXdfY3J0YykgewotCQkJCURSTV9ERUJVR19LTVMoImZhbGxiYWNrOiBjbG9uZWQgY29uZmln
dXJhdGlvblxuIik7Ci0JCQkJZ290byBiYWlsOwotCQkJfQotCQl9Ci0KLQkJRFJNX0RFQlVHX0tN
UygibG9va2luZyBmb3IgY21kbGluZSBtb2RlIG9uIGNvbm5lY3RvciAlc1xuIiwKLQkJCSAgICAg
IGNvbm5lY3Rvci0+bmFtZSk7Ci0KLQkJLyogZ28gZm9yIGNvbW1hbmQgbGluZSBtb2RlIGZpcnN0
ICovCi0JCW1vZGVzW2ldID0gZHJtX2Nvbm5lY3Rvcl9waWNrX2NtZGxpbmVfbW9kZShjb25uZWN0
b3IpOwotCi0JCS8qIHRyeSBmb3IgcHJlZmVycmVkIG5leHQgKi8KLQkJaWYgKCFtb2Rlc1tpXSkg
ewotCQkJRFJNX0RFQlVHX0tNUygibG9va2luZyBmb3IgcHJlZmVycmVkIG1vZGUgb24gY29ubmVj
dG9yICVzICVkXG4iLAotCQkJCSAgICAgIGNvbm5lY3Rvci0+bmFtZSwgY29ubmVjdG9yLT5oYXNf
dGlsZSk7Ci0JCQltb2Rlc1tpXSA9IGRybV9jb25uZWN0b3JfaGFzX3ByZWZlcnJlZF9tb2RlKGNv
bm5lY3Rvciwgd2lkdGgsIGhlaWdodCk7Ci0JCX0KLQotCQkvKiBObyBwcmVmZXJyZWQgbW9kZSBt
YXJrZWQgYnkgdGhlIEVESUQ/IEFyZSB0aGVyZSBhbnkgbW9kZXM/ICovCi0JCWlmICghbW9kZXNb
aV0gJiYgIWxpc3RfZW1wdHkoJmNvbm5lY3Rvci0+bW9kZXMpKSB7Ci0JCQlEUk1fREVCVUdfS01T
KCJ1c2luZyBmaXJzdCBtb2RlIGxpc3RlZCBvbiBjb25uZWN0b3IgJXNcbiIsCi0JCQkJICAgICAg
Y29ubmVjdG9yLT5uYW1lKTsKLQkJCW1vZGVzW2ldID0gbGlzdF9maXJzdF9lbnRyeSgmY29ubmVj
dG9yLT5tb2RlcywKLQkJCQkJCSAgICBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSwKLQkJCQkJCSAg
ICBoZWFkKTsKLQkJfQotCi0JCS8qIGxhc3QgcmVzb3J0OiB1c2UgY3VycmVudCBtb2RlICovCi0J
CWlmICghbW9kZXNbaV0pIHsKLQkJCS8qCi0JCQkgKiBJTVBPUlRBTlQ6IFdlIHdhbnQgdG8gdXNl
IHRoZSBhZGp1c3RlZCBtb2RlIChpLmUuCi0JCQkgKiBhZnRlciB0aGUgcGFuZWwgZml0dGVyIHVw
c2NhbGluZykgYXMgdGhlIGluaXRpYWwKLQkJCSAqIGNvbmZpZywgbm90IHRoZSBpbnB1dCBtb2Rl
LCB3aGljaCBpcyB3aGF0IGNydGMtPm1vZGUKLQkJCSAqIHVzdWFsbHkgY29udGFpbnMuIEJ1dCBz
aW5jZSBvdXIgY3VycmVudAotCQkJICogY29kZSBwdXRzIGEgbW9kZSBkZXJpdmVkIGZyb20gdGhl
IHBvc3QtcGZpdCB0aW1pbmdzCi0JCQkgKiBpbnRvIGNydGMtPm1vZGUgdGhpcyB3b3JrcyBvdXQg
Y29ycmVjdGx5LgotCQkJICoKLQkJCSAqIFRoaXMgaXMgY3J0Yy0+bW9kZSBhbmQgbm90IGNydGMt
PnN0YXRlLT5tb2RlIGZvciB0aGUKLQkJCSAqIGZhc3Rib290IGNoZWNrIHRvIHdvcmsgY29ycmVj
dGx5LgotCQkJICovCi0JCQlEUk1fREVCVUdfS01TKCJsb29raW5nIGZvciBjdXJyZW50IG1vZGUg
b24gY29ubmVjdG9yICVzXG4iLAotCQkJCSAgICAgIGNvbm5lY3Rvci0+bmFtZSk7Ci0JCQltb2Rl
c1tpXSA9ICZjb25uZWN0b3ItPnN0YXRlLT5jcnRjLT5tb2RlOwotCQl9Ci0JCWNydGNzW2ldID0g
bmV3X2NydGM7Ci0KLQkJRFJNX0RFQlVHX0tNUygiY29ubmVjdG9yICVzIG9uIFtDUlRDOiVkOiVz
XTogJWR4JWQlc1xuIiwKLQkJCSAgICAgIGNvbm5lY3Rvci0+bmFtZSwKLQkJCSAgICAgIGNvbm5l
Y3Rvci0+c3RhdGUtPmNydGMtPmJhc2UuaWQsCi0JCQkgICAgICBjb25uZWN0b3ItPnN0YXRlLT5j
cnRjLT5uYW1lLAotCQkJICAgICAgbW9kZXNbaV0tPmhkaXNwbGF5LCBtb2Rlc1tpXS0+dmRpc3Bs
YXksCi0JCQkgICAgICBtb2Rlc1tpXS0+ZmxhZ3MgJiBEUk1fTU9ERV9GTEFHX0lOVEVSTEFDRSA/
ICJpIiA6ICIiKTsKLQotCQlmYWxsYmFjayA9IGZhbHNlOwotCQljb25uX2NvbmZpZ3VyZWQgfD0g
QklUKGkpOwotCX0KLQotCWlmICgoY29ubl9jb25maWd1cmVkICYgbWFzaykgIT0gbWFzayAmJiBj
b25uX2NvbmZpZ3VyZWQgIT0gY29ubl9zZXEpCi0JCWdvdG8gcmV0cnk7Ci0KLQkvKgotCSAqIElm
IHRoZSBCSU9TIGRpZG4ndCBlbmFibGUgZXZlcnl0aGluZyBpdCBjb3VsZCwgZmFsbCBiYWNrIHRv
IGhhdmUgdGhlCi0JICogc2FtZSB1c2VyIGV4cGVyaWVuY2luZyBvZiBsaWdodGluZyB1cCBhcyBt
dWNoIGFzIHBvc3NpYmxlIGxpa2UgdGhlCi0JICogZmJkZXYgaGVscGVyIGxpYnJhcnkuCi0JICov
Ci0JaWYgKG51bV9jb25uZWN0b3JzX2VuYWJsZWQgIT0gbnVtX2Nvbm5lY3RvcnNfZGV0ZWN0ZWQg
JiYKLQkgICAgbnVtX2Nvbm5lY3RvcnNfZW5hYmxlZCA8IGRldi0+bW9kZV9jb25maWcubnVtX2Ny
dGMpIHsKLQkJRFJNX0RFQlVHX0tNUygiZmFsbGJhY2s6IE5vdCBhbGwgb3V0cHV0cyBlbmFibGVk
XG4iKTsKLQkJRFJNX0RFQlVHX0tNUygiRW5hYmxlZDogJWksIGRldGVjdGVkOiAlaVxuIiwgbnVt
X2Nvbm5lY3RvcnNfZW5hYmxlZCwKLQkJCSAgICAgIG51bV9jb25uZWN0b3JzX2RldGVjdGVkKTsK
LQkJZmFsbGJhY2sgPSB0cnVlOwotCX0KLQotCWlmIChmYWxsYmFjaykgewotYmFpbDoKLQkJRFJN
X0RFQlVHX0tNUygiTm90IHVzaW5nIGZpcm13YXJlIGNvbmZpZ3VyYXRpb25cbiIpOwotCQltZW1j
cHkoZW5hYmxlZCwgc2F2ZV9lbmFibGVkLCBjb3VudCk7Ci0JCXJldCA9IGZhbHNlOwotCX0KLQot
CWRybV9tb2Rlc2V0X2Ryb3BfbG9ja3MoJmN0eCk7Ci0JZHJtX21vZGVzZXRfYWNxdWlyZV9maW5p
KCZjdHgpOwotCi0Ja2ZyZWUoc2F2ZV9lbmFibGVkKTsKLQlyZXR1cm4gcmV0OwotfQotCi0vKioK
LSAqIGRybV9jbGllbnRfbW9kZXNldF9wcm9iZSgpIC0gUHJvYmUgZm9yIGRpc3BsYXlzCi0gKiBA
Y2xpZW50OiBEUk0gY2xpZW50Ci0gKiBAd2lkdGg6IE1heGltdW0gZGlzcGxheSBtb2RlIHdpZHRo
IChvcHRpb25hbCkKLSAqIEBoZWlnaHQ6IE1heGltdW0gZGlzcGxheSBtb2RlIGhlaWdodCAob3B0
aW9uYWwpCi0gKgotICogVGhpcyBmdW5jdGlvbiBzZXRzIHVwIGRpc3BsYXkgcGlwZWxpbmVzIGZv
ciBlbmFibGVkIGNvbm5lY3RvcnMgYW5kIHN0b3JlcyB0aGUKLSAqIGNvbmZpZyBpbiB0aGUgY2xp
ZW50J3MgbW9kZXNldCBhcnJheS4KLSAqCi0gKiBSZXR1cm5zOgotICogWmVybyBvbiBzdWNjZXNz
IG9yIG5lZ2F0aXZlIGVycm9yIGNvZGUgb24gZmFpbHVyZS4KLSAqLwotaW50IGRybV9jbGllbnRf
bW9kZXNldF9wcm9iZShzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCwgdW5zaWduZWQgaW50
IHdpZHRoLCB1bnNpZ25lZCBpbnQgaGVpZ2h0KQotewotCXN0cnVjdCBkcm1fY29ubmVjdG9yICpj
b25uZWN0b3IsICoqY29ubmVjdG9ycyA9IE5VTEw7Ci0Jc3RydWN0IGRybV9jb25uZWN0b3JfbGlz
dF9pdGVyIGNvbm5faXRlcjsKLQlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gY2xpZW50LT5kZXY7
Ci0JdW5zaWduZWQgaW50IHRvdGFsX21vZGVzX2NvdW50ID0gMDsKLQlzdHJ1Y3QgZHJtX2NsaWVu
dF9vZmZzZXQgKm9mZnNldHM7Ci0JdW5zaWduZWQgaW50IGNvbm5lY3Rvcl9jb3VudCA9IDA7Ci0J
c3RydWN0IGRybV9kaXNwbGF5X21vZGUgKiptb2RlczsKLQlzdHJ1Y3QgZHJtX2NydGMgKipjcnRj
czsKLQlpbnQgaSwgcmV0ID0gMDsKLQlib29sICplbmFibGVkOwotCi0JRFJNX0RFQlVHX0tNUygi
XG4iKTsKLQotCWlmICghd2lkdGgpCi0JCXdpZHRoID0gZGV2LT5tb2RlX2NvbmZpZy5tYXhfd2lk
dGg7Ci0JaWYgKCFoZWlnaHQpCi0JCWhlaWdodCA9IGRldi0+bW9kZV9jb25maWcubWF4X2hlaWdo
dDsKLQotCWRybV9jb25uZWN0b3JfbGlzdF9pdGVyX2JlZ2luKGRldiwgJmNvbm5faXRlcik7Ci0J
ZHJtX2NsaWVudF9mb3JfZWFjaF9jb25uZWN0b3JfaXRlcihjb25uZWN0b3IsICZjb25uX2l0ZXIp
IHsKLQkJc3RydWN0IGRybV9jb25uZWN0b3IgKip0bXA7Ci0KLQkJdG1wID0ga3JlYWxsb2MoY29u
bmVjdG9ycywgKGNvbm5lY3Rvcl9jb3VudCArIDEpICogc2l6ZW9mKCpjb25uZWN0b3JzKSwgR0ZQ
X0tFUk5FTCk7Ci0JCWlmICghdG1wKSB7Ci0JCQlyZXQgPSAtRU5PTUVNOwotCQkJZ290byBmcmVl
X2Nvbm5lY3RvcnM7Ci0JCX0KLQotCQljb25uZWN0b3JzID0gdG1wOwotCQlkcm1fY29ubmVjdG9y
X2dldChjb25uZWN0b3IpOwotCQljb25uZWN0b3JzW2Nvbm5lY3Rvcl9jb3VudCsrXSA9IGNvbm5l
Y3RvcjsKLQl9Ci0JZHJtX2Nvbm5lY3Rvcl9saXN0X2l0ZXJfZW5kKCZjb25uX2l0ZXIpOwotCi0J
aWYgKCFjb25uZWN0b3JfY291bnQpCi0JCXJldHVybiAwOwotCi0JY3J0Y3MgPSBrY2FsbG9jKGNv
bm5lY3Rvcl9jb3VudCwgc2l6ZW9mKCpjcnRjcyksIEdGUF9LRVJORUwpOwotCW1vZGVzID0ga2Nh
bGxvYyhjb25uZWN0b3JfY291bnQsIHNpemVvZigqbW9kZXMpLCBHRlBfS0VSTkVMKTsKLQlvZmZz
ZXRzID0ga2NhbGxvYyhjb25uZWN0b3JfY291bnQsIHNpemVvZigqb2Zmc2V0cyksIEdGUF9LRVJO
RUwpOwotCWVuYWJsZWQgPSBrY2FsbG9jKGNvbm5lY3Rvcl9jb3VudCwgc2l6ZW9mKGJvb2wpLCBH
RlBfS0VSTkVMKTsKLQlpZiAoIWNydGNzIHx8ICFtb2RlcyB8fCAhZW5hYmxlZCB8fCAhb2Zmc2V0
cykgewotCQlEUk1fRVJST1IoIk1lbW9yeSBhbGxvY2F0aW9uIGZhaWxlZFxuIik7Ci0JCXJldCA9
IC1FTk9NRU07Ci0JCWdvdG8gb3V0OwotCX0KLQotCW11dGV4X2xvY2soJmNsaWVudC0+bW9kZXNl
dF9tdXRleCk7Ci0KLQltdXRleF9sb2NrKCZkZXYtPm1vZGVfY29uZmlnLm11dGV4KTsKLQlmb3Ig
KGkgPSAwOyBpIDwgY29ubmVjdG9yX2NvdW50OyBpKyspCi0JCXRvdGFsX21vZGVzX2NvdW50ICs9
IGNvbm5lY3RvcnNbaV0tPmZ1bmNzLT5maWxsX21vZGVzKGNvbm5lY3RvcnNbaV0sIHdpZHRoLCBo
ZWlnaHQpOwotCWlmICghdG90YWxfbW9kZXNfY291bnQpCi0JCURSTV9ERUJVR19LTVMoIk5vIGNv
bm5lY3RvcnMgcmVwb3J0ZWQgY29ubmVjdGVkIHdpdGggbW9kZXNcbiIpOwotCWRybV9jbGllbnRf
Y29ubmVjdG9yc19lbmFibGVkKGNvbm5lY3RvcnMsIGNvbm5lY3Rvcl9jb3VudCwgZW5hYmxlZCk7
Ci0KLQlpZiAoIWRybV9jbGllbnRfZmlybXdhcmVfY29uZmlnKGNsaWVudCwgY29ubmVjdG9ycywg
Y29ubmVjdG9yX2NvdW50LCBjcnRjcywKLQkJCQkJbW9kZXMsIG9mZnNldHMsIGVuYWJsZWQsIHdp
ZHRoLCBoZWlnaHQpKSB7Ci0JCW1lbXNldChtb2RlcywgMCwgY29ubmVjdG9yX2NvdW50ICogc2l6
ZW9mKCptb2RlcykpOwotCQltZW1zZXQoY3J0Y3MsIDAsIGNvbm5lY3Rvcl9jb3VudCAqIHNpemVv
ZigqY3J0Y3MpKTsKLQkJbWVtc2V0KG9mZnNldHMsIDAsIGNvbm5lY3Rvcl9jb3VudCAqIHNpemVv
Zigqb2Zmc2V0cykpOwotCi0JCWlmICghZHJtX2NsaWVudF90YXJnZXRfY2xvbmVkKGRldiwgY29u
bmVjdG9ycywgY29ubmVjdG9yX2NvdW50LCBtb2RlcywKLQkJCQkJICAgICAgb2Zmc2V0cywgZW5h
YmxlZCwgd2lkdGgsIGhlaWdodCkgJiYKLQkJICAgICFkcm1fY2xpZW50X3RhcmdldF9wcmVmZXJy
ZWQoY29ubmVjdG9ycywgY29ubmVjdG9yX2NvdW50LCBtb2RlcywKLQkJCQkJCSBvZmZzZXRzLCBl
bmFibGVkLCB3aWR0aCwgaGVpZ2h0KSkKLQkJCURSTV9FUlJPUigiVW5hYmxlIHRvIGZpbmQgaW5p
dGlhbCBtb2Rlc1xuIik7Ci0KLQkJRFJNX0RFQlVHX0tNUygicGlja2luZyBDUlRDcyBmb3IgJWR4
JWQgY29uZmlnXG4iLAotCQkJICAgICAgd2lkdGgsIGhlaWdodCk7Ci0KLQkJZHJtX2NsaWVudF9w
aWNrX2NydGNzKGNsaWVudCwgY29ubmVjdG9ycywgY29ubmVjdG9yX2NvdW50LAotCQkJCSAgICAg
IGNydGNzLCBtb2RlcywgMCwgd2lkdGgsIGhlaWdodCk7Ci0JfQotCW11dGV4X3VubG9jaygmZGV2
LT5tb2RlX2NvbmZpZy5tdXRleCk7Ci0KLQlkcm1fY2xpZW50X21vZGVzZXRfcmVsZWFzZShjbGll
bnQpOwotCi0JZm9yIChpID0gMDsgaSA8IGNvbm5lY3Rvcl9jb3VudDsgaSsrKSB7Ci0JCXN0cnVj
dCBkcm1fZGlzcGxheV9tb2RlICptb2RlID0gbW9kZXNbaV07Ci0JCXN0cnVjdCBkcm1fY3J0YyAq
Y3J0YyA9IGNydGNzW2ldOwotCQlzdHJ1Y3QgZHJtX2NsaWVudF9vZmZzZXQgKm9mZnNldCA9ICZv
ZmZzZXRzW2ldOwotCi0JCWlmIChtb2RlICYmIGNydGMpIHsKLQkJCXN0cnVjdCBkcm1fbW9kZV9z
ZXQgKm1vZGVzZXQgPSBkcm1fY2xpZW50X2ZpbmRfbW9kZXNldChjbGllbnQsIGNydGMpOwotCQkJ
c3RydWN0IGRybV9jb25uZWN0b3IgKmNvbm5lY3RvciA9IGNvbm5lY3RvcnNbaV07Ci0KLQkJCURS
TV9ERUJVR19LTVMoImRlc2lyZWQgbW9kZSAlcyBzZXQgb24gY3J0YyAlZCAoJWQsJWQpXG4iLAot
CQkJCSAgICAgIG1vZGUtPm5hbWUsIGNydGMtPmJhc2UuaWQsIG9mZnNldC0+eCwgb2Zmc2V0LT55
KTsKLQotCQkJaWYgKFdBUk5fT05fT05DRShtb2Rlc2V0LT5udW1fY29ubmVjdG9ycyA9PSBEUk1f
Q0xJRU5UX01BWF9DTE9ORURfQ09OTkVDVE9SUyB8fAotCQkJCQkgKGRldi0+bW9kZV9jb25maWcu
bnVtX2NydGMgPiAxICYmIG1vZGVzZXQtPm51bV9jb25uZWN0b3JzID09IDEpKSkgewotCQkJCXJl
dCA9IC1FSU5WQUw7Ci0JCQkJYnJlYWs7Ci0JCQl9Ci0KLQkJCW1vZGVzZXQtPm1vZGUgPSBkcm1f
bW9kZV9kdXBsaWNhdGUoZGV2LCBtb2RlKTsKLQkJCWRybV9jb25uZWN0b3JfZ2V0KGNvbm5lY3Rv
cik7Ci0JCQltb2Rlc2V0LT5jb25uZWN0b3JzW21vZGVzZXQtPm51bV9jb25uZWN0b3JzKytdID0g
Y29ubmVjdG9yOwotCQkJbW9kZXNldC0+eCA9IG9mZnNldC0+eDsKLQkJCW1vZGVzZXQtPnkgPSBv
ZmZzZXQtPnk7Ci0JCX0KLQl9Ci0KLQltdXRleF91bmxvY2soJmNsaWVudC0+bW9kZXNldF9tdXRl
eCk7Ci1vdXQ6Ci0Ja2ZyZWUoY3J0Y3MpOwotCWtmcmVlKG1vZGVzKTsKLQlrZnJlZShvZmZzZXRz
KTsKLQlrZnJlZShlbmFibGVkKTsKLWZyZWVfY29ubmVjdG9yczoKLQlmb3IgKGkgPSAwOyBpIDwg
Y29ubmVjdG9yX2NvdW50OyBpKyspCi0JCWRybV9jb25uZWN0b3JfcHV0KGNvbm5lY3RvcnNbaV0p
OwotCWtmcmVlKGNvbm5lY3RvcnMpOwotCi0JcmV0dXJuIHJldDsKLX0KLQogLyoKICAqIFRoaXMg
aXMgYSBjb250aW51YXRpb24gb2YgZHJtX3NldHVwX2NydGNzKCkgdGhhdCBzZXRzIHVwIGFueXRo
aW5nIHJlbGF0ZWQKICAqIHRvIHRoZSBmcmFtZWJ1ZmZlci4gRHVyaW5nIGluaXRpYWxpemF0aW9u
LCBkcm1fc2V0dXBfY3J0Y3MoKSBpcyBjYWxsZWQgYmVmb3JlCmRpZmYgLS1naXQgYS9pbmNsdWRl
L2RybS9kcm1fY2xpZW50LmggYi9pbmNsdWRlL2RybS9kcm1fY2xpZW50LmgKaW5kZXggOGQ5NDg4
MGJiZTI1Li5mMmQ1ZWQ3NDU3MzMgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvZHJtL2RybV9jbGllbnQu
aAorKysgYi9pbmNsdWRlL2RybS9kcm1fY2xpZW50LmgKQEAgLTE4LDggKzE4LDYgQEAgc3RydWN0
IGRybV9nZW1fb2JqZWN0Owogc3RydWN0IGRybV9taW5vcjsKIHN0cnVjdCBtb2R1bGU7CiAKLSNk
ZWZpbmUgRFJNX0NMSUVOVF9NQVhfQ0xPTkVEX0NPTk5FQ1RPUlMJOAotCiAvKioKICAqIHN0cnVj
dCBkcm1fY2xpZW50X2Z1bmNzIC0gRFJNIGNsaWVudCBjYWxsYmFja3MKICAqLwpAQCAtMTU0LDgg
KzE1Miw3IEBAIHZvaWQgZHJtX2NsaWVudF9mcmFtZWJ1ZmZlcl9kZWxldGUoc3RydWN0IGRybV9j
bGllbnRfYnVmZmVyICpidWZmZXIpOwogCiBpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2NyZWF0ZShz
dHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCk7CiB2b2lkIGRybV9jbGllbnRfbW9kZXNldF9m
cmVlKHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50KTsKLXZvaWQgZHJtX2NsaWVudF9tb2Rl
c2V0X3JlbGVhc2Uoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpOwotc3RydWN0IGRybV9t
b2RlX3NldCAqZHJtX2NsaWVudF9maW5kX21vZGVzZXQoc3RydWN0IGRybV9jbGllbnRfZGV2ICpj
bGllbnQsIHN0cnVjdCBkcm1fY3J0YyAqY3J0Yyk7CitpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X3By
b2JlKHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50LCB1bnNpZ25lZCBpbnQgd2lkdGgsIHVu
c2lnbmVkIGludCBoZWlnaHQpOwogYm9vbCBkcm1fY2xpZW50X3BhbmVsX3JvdGF0aW9uKHN0cnVj
dCBkcm1fbW9kZV9zZXQgKm1vZGVzZXQsIHVuc2lnbmVkIGludCAqcm90YXRpb24pOwogaW50IGRy
bV9jbGllbnRfbW9kZXNldF9jb21taXRfZm9yY2Uoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGll
bnQpOwogaW50IGRybV9jbGllbnRfbW9kZXNldF9jb21taXQoc3RydWN0IGRybV9jbGllbnRfZGV2
ICpjbGllbnQpOwotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVl
ZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5m
by9kcmktZGV2ZWw=
