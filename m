Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id EF44C2796B6
	for <lists+dri-devel@lfdr.de>; Sat, 26 Sep 2020 06:25:08 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 3D8386ED95;
	Sat, 26 Sep 2020 04:25:05 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pj1-x1043.google.com (mail-pj1-x1043.google.com
 [IPv6:2607:f8b0:4864:20::1043])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 058F76E133
 for <dri-devel@lists.freedesktop.org>; Sat, 26 Sep 2020 04:25:01 +0000 (UTC)
Received: by mail-pj1-x1043.google.com with SMTP id kk9so488861pjb.2
 for <dri-devel@lists.freedesktop.org>; Fri, 25 Sep 2020 21:25:01 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=q/YHFkJjnrzpougboI5H9Mm3RBmSahSsWVWvUb6SAeY=;
 b=pYshy51K50oZf9Caenwo7Vuah8DqJtbjU74d8OWrnajJ3wXbRD1+qQHDhBmzF5Qx0T
 0/iMUp5K7BYEV91ZGP3/iMCUyZoSahF377/2Nz+Z8xEwcPQdnKHkRmSmyCHxwoLjxgGA
 izkCHUHyzWUVeYuWKue9lojLJzZPeH7tAcNjuW7jXRpS5CAJ3GoaD7ip5+p8/z/qodl1
 QObOiQGpmp9x2dSHZv8QZv90j1qWpfNlKfGfUCyGxBg1XMMtSvCQA9Jz6WXghLzBbvFv
 9TUiXBFMnHxg8lklqJLcRLvXYySPlXDS5zNlERERZghAklqgyW148Ax8dBYBsVssF82E
 LoLw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=q/YHFkJjnrzpougboI5H9Mm3RBmSahSsWVWvUb6SAeY=;
 b=Bc1KSGtvcNy99LG7c4iO/QwgsDHDgMgktJ/4qTFqiVF/Yky00db0Lfh0nWey0BxNMc
 T1kcP370kK3Sfr3ySDUZiANAgbVKuCAaUKw40O7AQw98yt4vaIBpz15auhfePzIDUekE
 FH1qjkpBa/gbAZIJcpfQlNZQgFqd1Scx8D1RBdM3smnzZmzdJnM0J3NcVRMTc5OHEZ7z
 h+TgExB368Ii0qVPl+vcmt4v0NoTZeXsXvvyXIZQqhsZMK1HYHb+wVLJcwF88bz3+t/S
 vhnDRAxY6V0G/oBq9OMQy8jxA/uDJf44FLZGKZnbbEmXFc5t4+IgfsDnh4tDKYOW8QgV
 nhPQ==
X-Gm-Message-State: AOAM533qaRNHiTl32ry/Bd51N0FHQYzpy/DxgGcJqCMWeWTvDL/M8ErM
 4mF187XHqQwMVl6QywuExxBHNg==
X-Google-Smtp-Source: ABdhPJyezNoUAo89S8cL5s0K0ZQlVU56nzJuFtG9yIunTjup+PAhqX2pDoDhIGA3V6oo0lGSUEQdyg==
X-Received: by 2002:a17:90a:3984:: with SMTP id
 z4mr659973pjb.131.1601094300525; 
 Fri, 25 Sep 2020 21:25:00 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 a5sm3585886pgk.13.2020.09.25.21.24.58
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 25 Sep 2020 21:24:59 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [RFC][PATCH 2/6] dma-buf: heaps: Move heap-helper logic into the
 cma_heap implementation
Date: Sat, 26 Sep 2020 04:24:49 +0000
Message-Id: <20200926042453.67517-3-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20200926042453.67517-1-john.stultz@linaro.org>
References: <20200926042453.67517-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sandeep Patil <sspatil@google.com>, dri-devel@lists.freedesktop.org,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 Suren Baghdasaryan <surenb@google.com>, linux-media@vger.kernel.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2UgdGhlIGhlYXAtaGVscGVycyBsb2dpYyBlbmRlZCB1cCBub3QgYmVpbmcgYXMgZ2VuZXJp
YyBhcwpob3BlZCwgbW92ZSB0aGUgaGVhcC1oZWxwZXJzIGRtYV9idWZfb3BzIGltcGxlbWVudGF0
aW9ucyBpbnRvCnRoZSBjbWFfaGVhcCBkaXJlY3RseS4KClRoaXMgd2lsbCBhbGxvdyB1cyB0byBy
ZW1vdmUgdGhlIGhlYXBfaGVscGVycyBjb2RlIGluIGEgZm9sbG93aW5nCnBhdGNoLgoKQ2M6IFN1
bWl0IFNlbXdhbCA8c3VtaXQuc2Vtd2FsQGxpbmFyby5vcmc+CkNjOiBMaWFtIE1hcmsgPGxtYXJr
QGNvZGVhdXJvcmEub3JnPgpDYzogTGF1cmEgQWJib3R0IDxsYWJib3R0QGtlcm5lbC5vcmc+CkNj
OiBCcmlhbiBTdGFya2V5IDxCcmlhbi5TdGFya2V5QGFybS5jb20+CkNjOiBIcmlkeWEgVmFsc2Fy
YWp1IDxocmlkeWFAZ29vZ2xlLmNvbT4KQ2M6IFN1cmVuIEJhZ2hkYXNhcnlhbiA8c3VyZW5iQGdv
b2dsZS5jb20+CkNjOiBTYW5kZWVwIFBhdGlsIDxzc3BhdGlsQGdvb2dsZS5jb20+CkNjOiDDmHJq
YW4gRWlkZSA8b3JqYW4uZWlkZUBhcm0uY29tPgpDYzogUm9iaW4gTXVycGh5IDxyb2Jpbi5tdXJw
aHlAYXJtLmNvbT4KQ2M6IEV6ZXF1aWVsIEdhcmNpYSA8ZXplcXVpZWxAY29sbGFib3JhLmNvbT4K
Q2M6IFNpbW9uIFNlciA8Y29udGFjdEBlbWVyc2lvbi5mcj4KQ2M6IEphbWVzIEpvbmVzIDxqYWpv
bmVzQG52aWRpYS5jb20+CkNjOiBsaW51eC1tZWRpYUB2Z2VyLmtlcm5lbC5vcmcKQ2M6IGRyaS1k
ZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKU2lnbmVkLW9mZi1ieTogSm9obiBTdHVsdHogPGpv
aG4uc3R1bHR6QGxpbmFyby5vcmc+Ci0tLQogZHJpdmVycy9kbWEtYnVmL2hlYXBzL2NtYV9oZWFw
LmMgfCAzMjIgKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tLQogMSBmaWxlIGNoYW5nZWQs
IDI3MCBpbnNlcnRpb25zKCspLCA1MiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJz
L2RtYS1idWYvaGVhcHMvY21hX2hlYXAuYyBiL2RyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9jbWFfaGVh
cC5jCmluZGV4IDYyNmNmN2ZkMDMzYS4uM2FkZmRiZWQwODI5IDEwMDY0NAotLS0gYS9kcml2ZXJz
L2RtYS1idWYvaGVhcHMvY21hX2hlYXAuYworKysgYi9kcml2ZXJzL2RtYS1idWYvaGVhcHMvY21h
X2hlYXAuYwpAQCAtMiw3NiArMiwyOTEgQEAKIC8qCiAgKiBETUFCVUYgQ01BIGhlYXAgZXhwb3J0
ZXIKICAqCi0gKiBDb3B5cmlnaHQgKEMpIDIwMTIsIDIwMTkgTGluYXJvIEx0ZC4KKyAqIENvcHly
aWdodCAoQykgMjAxMiwgMjAxOSwgMjAyMCBMaW5hcm8gTHRkLgogICogQXV0aG9yOiA8YmVuamFt
aW4uZ2FpZ25hcmRAbGluYXJvLm9yZz4gZm9yIFNULUVyaWNzc29uLgorICoKKyAqIEFsc28gdXRp
bGl6aW5nIHBhcnRzIG9mIEFuZHJldyBEYXZpcycgU1JBTSBoZWFwOgorICogQ29weXJpZ2h0IChD
KSAyMDE5IFRleGFzIEluc3RydW1lbnRzIEluY29ycG9yYXRlZCAtIGh0dHA6Ly93d3cudGkuY29t
LworICoJQW5kcmV3IEYuIERhdmlzIDxhZmRAdGkuY29tPgogICovCi0KICNpbmNsdWRlIDxsaW51
eC9jbWEuaD4KLSNpbmNsdWRlIDxsaW51eC9kZXZpY2UuaD4KICNpbmNsdWRlIDxsaW51eC9kbWEt
YnVmLmg+Ci0jaW5jbHVkZSA8bGludXgvZG1hLWhlYXAuaD4KICNpbmNsdWRlIDxsaW51eC9kbWEt
Y29udGlndW91cy5oPgorI2luY2x1ZGUgPGxpbnV4L2RtYS1oZWFwLmg+CisjaW5jbHVkZSA8bGlu
dXgvZG1hLW1hcHBpbmcuaD4KICNpbmNsdWRlIDxsaW51eC9lcnIuaD4KLSNpbmNsdWRlIDxsaW51
eC9lcnJuby5oPgogI2luY2x1ZGUgPGxpbnV4L2hpZ2htZW0uaD4KKyNpbmNsdWRlIDxsaW51eC9p
by5oPgorI2luY2x1ZGUgPGxpbnV4L21tLmg+CiAjaW5jbHVkZSA8bGludXgvbW9kdWxlLmg+Ci0j
aW5jbHVkZSA8bGludXgvc2xhYi5oPgogI2luY2x1ZGUgPGxpbnV4L3NjYXR0ZXJsaXN0Lmg+Ci0j
aW5jbHVkZSA8bGludXgvc2NoZWQvc2lnbmFsLmg+CisjaW5jbHVkZSA8bGludXgvc2xhYi5oPgog
Ci0jaW5jbHVkZSAiaGVhcC1oZWxwZXJzLmgiCiAKIHN0cnVjdCBjbWFfaGVhcCB7CiAJc3RydWN0
IGRtYV9oZWFwICpoZWFwOwogCXN0cnVjdCBjbWEgKmNtYTsKIH07CiAKLXN0YXRpYyB2b2lkIGNt
YV9oZWFwX2ZyZWUoc3RydWN0IGhlYXBfaGVscGVyX2J1ZmZlciAqYnVmZmVyKQorc3RydWN0IGNt
YV9oZWFwX2J1ZmZlciB7CisJc3RydWN0IGNtYV9oZWFwICpoZWFwOworCXN0cnVjdCBsaXN0X2hl
YWQgYXR0YWNobWVudHM7CisJc3RydWN0IG11dGV4IGxvY2s7CisJdW5zaWduZWQgbG9uZyBsZW47
CisJc3RydWN0IHBhZ2UgKmNtYV9wYWdlczsKKwlzdHJ1Y3QgcGFnZSAqKnBhZ2VzOworCXBnb2Zm
X3QgcGFnZWNvdW50OworCWludCB2bWFwX2NudDsKKwl2b2lkICp2YWRkcjsKK307CisKK3N0cnVj
dCBkbWFfaGVhcF9hdHRhY2htZW50IHsKKwlzdHJ1Y3QgZGV2aWNlICpkZXY7CisJc3RydWN0IHNn
X3RhYmxlIHRhYmxlOworCXN0cnVjdCBsaXN0X2hlYWQgbGlzdDsKK307CisKK3N0YXRpYyBpbnQg
Y21hX2hlYXBfYXR0YWNoKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCisJCQkgICBzdHJ1Y3QgZG1h
X2J1Zl9hdHRhY2htZW50ICphdHRhY2htZW50KQogewotCXN0cnVjdCBjbWFfaGVhcCAqY21hX2hl
YXAgPSBkbWFfaGVhcF9nZXRfZHJ2ZGF0YShidWZmZXItPmhlYXApOwotCXVuc2lnbmVkIGxvbmcg
bnJfcGFnZXMgPSBidWZmZXItPnBhZ2Vjb3VudDsKLQlzdHJ1Y3QgcGFnZSAqY21hX3BhZ2VzID0g
YnVmZmVyLT5wcml2X3ZpcnQ7CisJc3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyID0gZG1h
YnVmLT5wcml2OworCXN0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50ICphOworCWludCByZXQ7CiAK
LQkvKiBmcmVlIHBhZ2UgbGlzdCAqLwotCWtmcmVlKGJ1ZmZlci0+cGFnZXMpOwotCS8qIHJlbGVh
c2UgbWVtb3J5ICovCi0JY21hX3JlbGVhc2UoY21hX2hlYXAtPmNtYSwgY21hX3BhZ2VzLCBucl9w
YWdlcyk7CisJYSA9IGt6YWxsb2Moc2l6ZW9mKCphKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFhKQor
CQlyZXR1cm4gLUVOT01FTTsKKworCXJldCA9IHNnX2FsbG9jX3RhYmxlX2Zyb21fcGFnZXMoJmEt
PnRhYmxlLCBidWZmZXItPnBhZ2VzLAorCQkJCQlidWZmZXItPnBhZ2Vjb3VudCwgMCwKKwkJCQkJ
YnVmZmVyLT5wYWdlY291bnQgPDwgUEFHRV9TSElGVCwKKwkJCQkJR0ZQX0tFUk5FTCk7CisJaWYg
KHJldCkgeworCQlrZnJlZShhKTsKKwkJcmV0dXJuIHJldDsKKwl9CisKKwlhLT5kZXYgPSBhdHRh
Y2htZW50LT5kZXY7CisJSU5JVF9MSVNUX0hFQUQoJmEtPmxpc3QpOworCisJYXR0YWNobWVudC0+
cHJpdiA9IGE7CisKKwltdXRleF9sb2NrKCZidWZmZXItPmxvY2spOworCWxpc3RfYWRkKCZhLT5s
aXN0LCAmYnVmZmVyLT5hdHRhY2htZW50cyk7CisJbXV0ZXhfdW5sb2NrKCZidWZmZXItPmxvY2sp
OworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyB2b2lkIGNtYV9oZWFwX2RldGF0Y2goc3RydWN0
IGRtYV9idWYgKmRtYWJ1ZiwKKwkJCSAgICAgc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0
YWNobWVudCkKK3sKKwlzdHJ1Y3QgY21hX2hlYXBfYnVmZmVyICpidWZmZXIgPSBkbWFidWYtPnBy
aXY7CisJc3RydWN0IGRtYV9oZWFwX2F0dGFjaG1lbnQgKmEgPSBhdHRhY2htZW50LT5wcml2Owor
CisJbXV0ZXhfbG9jaygmYnVmZmVyLT5sb2NrKTsKKwlsaXN0X2RlbCgmYS0+bGlzdCk7CisJbXV0
ZXhfdW5sb2NrKCZidWZmZXItPmxvY2spOworCisJc2dfZnJlZV90YWJsZSgmYS0+dGFibGUpOwor
CWtmcmVlKGEpOworfQorCitzdGF0aWMgc3RydWN0IHNnX3RhYmxlICpjbWFfaGVhcF9tYXBfZG1h
X2J1ZihzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhY2htZW50LAorCQkJCQkgICAgIGVu
dW0gZG1hX2RhdGFfZGlyZWN0aW9uIGRpcmVjdGlvbikKK3sKKwlzdHJ1Y3QgZG1hX2hlYXBfYXR0
YWNobWVudCAqYSA9IGF0dGFjaG1lbnQtPnByaXY7CisJc3RydWN0IHNnX3RhYmxlICp0YWJsZSA9
ICZhLT50YWJsZTsKKworCWlmICghZG1hX21hcF9zZyhhdHRhY2htZW50LT5kZXYsIHRhYmxlLT5z
Z2wsIHRhYmxlLT5uZW50cywKKwkJCWRpcmVjdGlvbikpCisJCXRhYmxlID0gRVJSX1BUUigtRU5P
TUVNKTsKKwlyZXR1cm4gdGFibGU7Cit9CisKK3N0YXRpYyB2b2lkIGNtYV9oZWFwX3VubWFwX2Rt
YV9idWYoc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqYXR0YWNobWVudCwKKwkJCQkgICBzdHJ1
Y3Qgc2dfdGFibGUgKnRhYmxlLAorCQkJCSAgIGVudW0gZG1hX2RhdGFfZGlyZWN0aW9uIGRpcmVj
dGlvbikKK3sKKwlkbWFfdW5tYXBfc2coYXR0YWNobWVudC0+ZGV2LCB0YWJsZS0+c2dsLCB0YWJs
ZS0+bmVudHMsIGRpcmVjdGlvbik7Cit9CisKK3N0YXRpYyBpbnQgY21hX2hlYXBfZG1hX2J1Zl9i
ZWdpbl9jcHVfYWNjZXNzKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCisJCQkJCSAgICAgZW51bSBk
bWFfZGF0YV9kaXJlY3Rpb24gZGlyZWN0aW9uKQoreworCXN0cnVjdCBjbWFfaGVhcF9idWZmZXIg
KmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKKwlzdHJ1Y3QgZG1hX2hlYXBfYXR0YWNobWVudCAqYTsK
KwlpbnQgcmV0ID0gMDsKKworCWlmIChidWZmZXItPnZtYXBfY250KQorCQlpbnZhbGlkYXRlX2tl
cm5lbF92bWFwX3JhbmdlKGJ1ZmZlci0+dmFkZHIsIGJ1ZmZlci0+bGVuKTsKKworCW11dGV4X2xv
Y2soJmJ1ZmZlci0+bG9jayk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShhLCAmYnVmZmVyLT5hdHRh
Y2htZW50cywgbGlzdCkgeworCQlkbWFfc3luY19zZ19mb3JfY3B1KGEtPmRldiwgYS0+dGFibGUu
c2dsLCBhLT50YWJsZS5uZW50cywKKwkJCQkgICAgZGlyZWN0aW9uKTsKKwl9CisJbXV0ZXhfdW5s
b2NrKCZidWZmZXItPmxvY2spOworCisJcmV0dXJuIHJldDsKK30KKworc3RhdGljIGludCBjbWFf
aGVhcF9kbWFfYnVmX2VuZF9jcHVfYWNjZXNzKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCisJCQkJ
CSAgIGVudW0gZG1hX2RhdGFfZGlyZWN0aW9uIGRpcmVjdGlvbikKK3sKKwlzdHJ1Y3QgY21hX2hl
YXBfYnVmZmVyICpidWZmZXIgPSBkbWFidWYtPnByaXY7CisJc3RydWN0IGRtYV9oZWFwX2F0dGFj
aG1lbnQgKmE7CisKKwlpZiAoYnVmZmVyLT52bWFwX2NudCkKKwkJZmx1c2hfa2VybmVsX3ZtYXBf
cmFuZ2UoYnVmZmVyLT52YWRkciwgYnVmZmVyLT5sZW4pOworCisJbXV0ZXhfbG9jaygmYnVmZmVy
LT5sb2NrKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5KGEsICZidWZmZXItPmF0dGFjaG1lbnRzLCBs
aXN0KSB7CisJCWRtYV9zeW5jX3NnX2Zvcl9kZXZpY2UoYS0+ZGV2LCBhLT50YWJsZS5zZ2wsIGEt
PnRhYmxlLm5lbnRzLAorCQkJCSAgICAgICBkaXJlY3Rpb24pOworCX0KKwltdXRleF91bmxvY2so
JmJ1ZmZlci0+bG9jayk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIHZtX2ZhdWx0X3QgY21h
X2hlYXBfdm1fZmF1bHQoc3RydWN0IHZtX2ZhdWx0ICp2bWYpCit7CisJc3RydWN0IHZtX2FyZWFf
c3RydWN0ICp2bWEgPSB2bWYtPnZtYTsKKwlzdHJ1Y3QgY21hX2hlYXBfYnVmZmVyICpidWZmZXIg
PSB2bWEtPnZtX3ByaXZhdGVfZGF0YTsKKworCWlmICh2bWYtPnBnb2ZmID4gYnVmZmVyLT5wYWdl
Y291bnQpCisJCXJldHVybiBWTV9GQVVMVF9TSUdCVVM7CisKKwl2bWYtPnBhZ2UgPSBidWZmZXIt
PnBhZ2VzW3ZtZi0+cGdvZmZdOworCWdldF9wYWdlKHZtZi0+cGFnZSk7CisKKwlyZXR1cm4gMDsK
K30KKworc3RhdGljIGNvbnN0IHN0cnVjdCB2bV9vcGVyYXRpb25zX3N0cnVjdCBkbWFfaGVhcF92
bV9vcHMgPSB7CisJLmZhdWx0ID0gY21hX2hlYXBfdm1fZmF1bHQsCit9OworCitzdGF0aWMgaW50
IGNtYV9oZWFwX21tYXAoc3RydWN0IGRtYV9idWYgKmRtYWJ1Ziwgc3RydWN0IHZtX2FyZWFfc3Ry
dWN0ICp2bWEpCit7CisJc3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyID0gZG1hYnVmLT5w
cml2OworCisJaWYgKCh2bWEtPnZtX2ZsYWdzICYgKFZNX1NIQVJFRCB8IFZNX01BWVNIQVJFKSkg
PT0gMCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwl2bWEtPnZtX29wcyA9ICZkbWFfaGVhcF92bV9v
cHM7CisJdm1hLT52bV9wcml2YXRlX2RhdGEgPSBidWZmZXI7CisKKwlyZXR1cm4gMDsKK30KKwor
c3RhdGljIHZvaWQgKmNtYV9oZWFwX2RvX3ZtYXAoc3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVm
ZmVyKQoreworCXZvaWQgKnZhZGRyOworCisJdmFkZHIgPSB2bWFwKGJ1ZmZlci0+cGFnZXMsIGJ1
ZmZlci0+cGFnZWNvdW50LCBWTV9NQVAsIFBBR0VfS0VSTkVMKTsKKwlpZiAoIXZhZGRyKQorCQly
ZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKKworCXJldHVybiB2YWRkcjsKK30KKworc3RhdGljIHZv
aWQgKmNtYV9oZWFwX3ZtYXAoc3RydWN0IGRtYV9idWYgKmRtYWJ1ZikKK3sKKwlzdHJ1Y3QgY21h
X2hlYXBfYnVmZmVyICpidWZmZXIgPSBkbWFidWYtPnByaXY7CisJdm9pZCAqdmFkZHI7CisKKwlt
dXRleF9sb2NrKCZidWZmZXItPmxvY2spOworCWlmIChidWZmZXItPnZtYXBfY250KSB7CisJCWJ1
ZmZlci0+dm1hcF9jbnQrKzsKKwkJcmV0dXJuIGJ1ZmZlci0+dmFkZHI7CisJfQorCisJdmFkZHIg
PSBjbWFfaGVhcF9kb192bWFwKGJ1ZmZlcik7CisJaWYgKElTX0VSUih2YWRkcikpCisJCXJldHVy
biB2YWRkcjsKKworCWJ1ZmZlci0+dmFkZHIgPSB2YWRkcjsKKwlidWZmZXItPnZtYXBfY250Kys7
CisJbXV0ZXhfdW5sb2NrKCZidWZmZXItPmxvY2spOworCisJcmV0dXJuIHZhZGRyOworfQorCitz
dGF0aWMgdm9pZCBjbWFfaGVhcF92dW5tYXAoc3RydWN0IGRtYV9idWYgKmRtYWJ1Ziwgdm9pZCAq
dmFkZHIpCit7CisJc3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyID0gZG1hYnVmLT5wcml2
OworCisJbXV0ZXhfbG9jaygmYnVmZmVyLT5sb2NrKTsKKwlpZiAoIS0tYnVmZmVyLT52bWFwX2Nu
dCkgeworCQl2dW5tYXAoYnVmZmVyLT52YWRkcik7CisJCWJ1ZmZlci0+dmFkZHIgPSBOVUxMOwor
CX0KKwltdXRleF91bmxvY2soJmJ1ZmZlci0+bG9jayk7Cit9CisKK3N0YXRpYyB2b2lkIGNtYV9o
ZWFwX2RtYV9idWZfcmVsZWFzZShzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmKQoreworCXN0cnVjdCBj
bWFfaGVhcF9idWZmZXIgKmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKKwlzdHJ1Y3QgY21hX2hlYXAg
KmNtYV9oZWFwID0gYnVmZmVyLT5oZWFwOworCisJaWYgKGJ1ZmZlci0+dm1hcF9jbnQgPiAwKSB7
CisJCVdBUk4oMSwgIiVzOiBidWZmZXIgc3RpbGwgbWFwcGVkIGluIHRoZSBrZXJuZWxcbiIsIF9f
ZnVuY19fKTsKKwkJdnVubWFwKGJ1ZmZlci0+dmFkZHIpOworCX0KKworCWNtYV9yZWxlYXNlKGNt
YV9oZWFwLT5jbWEsIGJ1ZmZlci0+Y21hX3BhZ2VzLCBidWZmZXItPnBhZ2Vjb3VudCk7CiAJa2Zy
ZWUoYnVmZmVyKTsKIH0KIAotLyogZG1hYnVmIGhlYXAgQ01BIG9wZXJhdGlvbnMgZnVuY3Rpb25z
ICovCitjb25zdCBzdHJ1Y3QgZG1hX2J1Zl9vcHMgY21hX2hlYXBfYnVmX29wcyA9IHsKKwkuYXR0
YWNoID0gY21hX2hlYXBfYXR0YWNoLAorCS5kZXRhY2ggPSBjbWFfaGVhcF9kZXRhdGNoLAorCS5t
YXBfZG1hX2J1ZiA9IGNtYV9oZWFwX21hcF9kbWFfYnVmLAorCS51bm1hcF9kbWFfYnVmID0gY21h
X2hlYXBfdW5tYXBfZG1hX2J1ZiwKKwkuYmVnaW5fY3B1X2FjY2VzcyA9IGNtYV9oZWFwX2RtYV9i
dWZfYmVnaW5fY3B1X2FjY2VzcywKKwkuZW5kX2NwdV9hY2Nlc3MgPSBjbWFfaGVhcF9kbWFfYnVm
X2VuZF9jcHVfYWNjZXNzLAorCS5tbWFwID0gY21hX2hlYXBfbW1hcCwKKwkudm1hcCA9IGNtYV9o
ZWFwX3ZtYXAsCisJLnZ1bm1hcCA9IGNtYV9oZWFwX3Z1bm1hcCwKKwkucmVsZWFzZSA9IGNtYV9o
ZWFwX2RtYV9idWZfcmVsZWFzZSwKK307CisKIHN0YXRpYyBpbnQgY21hX2hlYXBfYWxsb2NhdGUo
c3RydWN0IGRtYV9oZWFwICpoZWFwLAotCQkJICAgICB1bnNpZ25lZCBsb25nIGxlbiwKLQkJCSAg
ICAgdW5zaWduZWQgbG9uZyBmZF9mbGFncywKLQkJCSAgICAgdW5zaWduZWQgbG9uZyBoZWFwX2Zs
YWdzKQorCQkJCSAgdW5zaWduZWQgbG9uZyBsZW4sCisJCQkJICB1bnNpZ25lZCBsb25nIGZkX2Zs
YWdzLAorCQkJCSAgdW5zaWduZWQgbG9uZyBoZWFwX2ZsYWdzKQogewogCXN0cnVjdCBjbWFfaGVh
cCAqY21hX2hlYXAgPSBkbWFfaGVhcF9nZXRfZHJ2ZGF0YShoZWFwKTsKLQlzdHJ1Y3QgaGVhcF9o
ZWxwZXJfYnVmZmVyICpoZWxwZXJfYnVmZmVyOwotCXN0cnVjdCBwYWdlICpjbWFfcGFnZXM7CisJ
c3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyOworCURFRklORV9ETUFfQlVGX0VYUE9SVF9J
TkZPKGV4cF9pbmZvKTsKIAlzaXplX3Qgc2l6ZSA9IFBBR0VfQUxJR04obGVuKTsKLQl1bnNpZ25l
ZCBsb25nIG5yX3BhZ2VzID0gc2l6ZSA+PiBQQUdFX1NISUZUOworCXBnb2ZmX3QgcGFnZWNvdW50
ID0gc2l6ZSA+PiBQQUdFX1NISUZUOwogCXVuc2lnbmVkIGxvbmcgYWxpZ24gPSBnZXRfb3JkZXIo
c2l6ZSk7CisJc3RydWN0IHBhZ2UgKmNtYV9wYWdlczsKIAlzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVm
OwotCWludCByZXQgPSAtRU5PTUVNOwogCXBnb2ZmX3QgcGc7CisJaW50IHJldDsKIAotCWlmIChh
bGlnbiA+IENPTkZJR19DTUFfQUxJR05NRU5UKQotCQlhbGlnbiA9IENPTkZJR19DTUFfQUxJR05N
RU5UOwotCi0JaGVscGVyX2J1ZmZlciA9IGt6YWxsb2Moc2l6ZW9mKCpoZWxwZXJfYnVmZmVyKSwg
R0ZQX0tFUk5FTCk7Ci0JaWYgKCFoZWxwZXJfYnVmZmVyKQorCWJ1ZmZlciA9IGt6YWxsb2Moc2l6
ZW9mKCpidWZmZXIpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWJ1ZmZlcikKIAkJcmV0dXJuIC1FTk9N
RU07CiAKLQlpbml0X2hlYXBfaGVscGVyX2J1ZmZlcihoZWxwZXJfYnVmZmVyLCBjbWFfaGVhcF9m
cmVlKTsKLQloZWxwZXJfYnVmZmVyLT5oZWFwID0gaGVhcDsKLQloZWxwZXJfYnVmZmVyLT5zaXpl
ID0gbGVuOworCUlOSVRfTElTVF9IRUFEKCZidWZmZXItPmF0dGFjaG1lbnRzKTsKKwltdXRleF9p
bml0KCZidWZmZXItPmxvY2spOworCWJ1ZmZlci0+bGVuID0gc2l6ZTsKIAotCWNtYV9wYWdlcyA9
IGNtYV9hbGxvYyhjbWFfaGVhcC0+Y21hLCBucl9wYWdlcywgYWxpZ24sIGZhbHNlKTsKKwlpZiAo
YWxpZ24gPiBDT05GSUdfQ01BX0FMSUdOTUVOVCkKKwkJYWxpZ24gPSBDT05GSUdfQ01BX0FMSUdO
TUVOVDsKKworCWNtYV9wYWdlcyA9IGNtYV9hbGxvYyhjbWFfaGVhcC0+Y21hLCBwYWdlY291bnQs
IGFsaWduLCBmYWxzZSk7CiAJaWYgKCFjbWFfcGFnZXMpCi0JCWdvdG8gZnJlZV9idWY7CisJCWdv
dG8gZnJlZV9idWZmZXI7CiAKKwkvKiBDbGVhciB0aGUgY21hIHBhZ2VzICovCiAJaWYgKFBhZ2VI
aWdoTWVtKGNtYV9wYWdlcykpIHsKLQkJdW5zaWduZWQgbG9uZyBucl9jbGVhcl9wYWdlcyA9IG5y
X3BhZ2VzOworCQl1bnNpZ25lZCBsb25nIG5yX2NsZWFyX3BhZ2VzID0gcGFnZWNvdW50OwogCQlz
dHJ1Y3QgcGFnZSAqcGFnZSA9IGNtYV9wYWdlczsKIAogCQl3aGlsZSAobnJfY2xlYXJfcGFnZXMg
PiAwKSB7CkBAIC04NSw3ICszMDAsNiBAQCBzdGF0aWMgaW50IGNtYV9oZWFwX2FsbG9jYXRlKHN0
cnVjdCBkbWFfaGVhcCAqaGVhcCwKIAkJCSAqLwogCQkJaWYgKGZhdGFsX3NpZ25hbF9wZW5kaW5n
KGN1cnJlbnQpKQogCQkJCWdvdG8gZnJlZV9jbWE7Ci0KIAkJCXBhZ2UrKzsKIAkJCW5yX2NsZWFy
X3BhZ2VzLS07CiAJCX0KQEAgLTkzLDI4ICszMDcsMzAgQEAgc3RhdGljIGludCBjbWFfaGVhcF9h
bGxvY2F0ZShzdHJ1Y3QgZG1hX2hlYXAgKmhlYXAsCiAJCW1lbXNldChwYWdlX2FkZHJlc3MoY21h
X3BhZ2VzKSwgMCwgc2l6ZSk7CiAJfQogCi0JaGVscGVyX2J1ZmZlci0+cGFnZWNvdW50ID0gbnJf
cGFnZXM7Ci0JaGVscGVyX2J1ZmZlci0+cGFnZXMgPSBrbWFsbG9jX2FycmF5KGhlbHBlcl9idWZm
ZXItPnBhZ2Vjb3VudCwKLQkJCQkJICAgICBzaXplb2YoKmhlbHBlcl9idWZmZXItPnBhZ2VzKSwK
LQkJCQkJICAgICBHRlBfS0VSTkVMKTsKLQlpZiAoIWhlbHBlcl9idWZmZXItPnBhZ2VzKSB7CisJ
YnVmZmVyLT5wYWdlcyA9IGttYWxsb2NfYXJyYXkocGFnZWNvdW50LCBzaXplb2YoKmJ1ZmZlci0+
cGFnZXMpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWJ1ZmZlci0+cGFnZXMpIHsKIAkJcmV0ID0gLUVO
T01FTTsKIAkJZ290byBmcmVlX2NtYTsKIAl9CiAKLQlmb3IgKHBnID0gMDsgcGcgPCBoZWxwZXJf
YnVmZmVyLT5wYWdlY291bnQ7IHBnKyspCi0JCWhlbHBlcl9idWZmZXItPnBhZ2VzW3BnXSA9ICZj
bWFfcGFnZXNbcGddOworCWZvciAocGcgPSAwOyBwZyA8IHBhZ2Vjb3VudDsgcGcrKykKKwkJYnVm
ZmVyLT5wYWdlc1twZ10gPSAmY21hX3BhZ2VzW3BnXTsKKworCWJ1ZmZlci0+Y21hX3BhZ2VzID0g
Y21hX3BhZ2VzOworCWJ1ZmZlci0+aGVhcCA9IGNtYV9oZWFwOworCWJ1ZmZlci0+cGFnZWNvdW50
ID0gcGFnZWNvdW50OwogCiAJLyogY3JlYXRlIHRoZSBkbWFidWYgKi8KLQlkbWFidWYgPSBoZWFw
X2hlbHBlcl9leHBvcnRfZG1hYnVmKGhlbHBlcl9idWZmZXIsIGZkX2ZsYWdzKTsKKwlleHBfaW5m
by5vcHMgPSAmY21hX2hlYXBfYnVmX29wczsKKwlleHBfaW5mby5zaXplID0gYnVmZmVyLT5sZW47
CisJZXhwX2luZm8uZmxhZ3MgPSBmZF9mbGFnczsKKwlleHBfaW5mby5wcml2ID0gYnVmZmVyOwor
CWRtYWJ1ZiA9IGRtYV9idWZfZXhwb3J0KCZleHBfaW5mbyk7CiAJaWYgKElTX0VSUihkbWFidWYp
KSB7CiAJCXJldCA9IFBUUl9FUlIoZG1hYnVmKTsKIAkJZ290byBmcmVlX3BhZ2VzOwogCX0KIAot
CWhlbHBlcl9idWZmZXItPmRtYWJ1ZiA9IGRtYWJ1ZjsKLQloZWxwZXJfYnVmZmVyLT5wcml2X3Zp
cnQgPSBjbWFfcGFnZXM7Ci0KIAlyZXQgPSBkbWFfYnVmX2ZkKGRtYWJ1ZiwgZmRfZmxhZ3MpOwog
CWlmIChyZXQgPCAwKSB7CiAJCWRtYV9idWZfcHV0KGRtYWJ1Zik7CkBAIC0xMjUsMTUgKzM0MSwx
NiBAQCBzdGF0aWMgaW50IGNtYV9oZWFwX2FsbG9jYXRlKHN0cnVjdCBkbWFfaGVhcCAqaGVhcCwK
IAlyZXR1cm4gcmV0OwogCiBmcmVlX3BhZ2VzOgotCWtmcmVlKGhlbHBlcl9idWZmZXItPnBhZ2Vz
KTsKKwlrZnJlZShidWZmZXItPnBhZ2VzKTsKIGZyZWVfY21hOgotCWNtYV9yZWxlYXNlKGNtYV9o
ZWFwLT5jbWEsIGNtYV9wYWdlcywgbnJfcGFnZXMpOwotZnJlZV9idWY6Ci0Ja2ZyZWUoaGVscGVy
X2J1ZmZlcik7CisJY21hX3JlbGVhc2UoY21hX2hlYXAtPmNtYSwgY21hX3BhZ2VzLCBwYWdlY291
bnQpOworZnJlZV9idWZmZXI6CisJa2ZyZWUoYnVmZmVyKTsKKwogCXJldHVybiByZXQ7CiB9CiAK
LXN0YXRpYyBjb25zdCBzdHJ1Y3QgZG1hX2hlYXBfb3BzIGNtYV9oZWFwX29wcyA9IHsKK3N0YXRp
YyBzdHJ1Y3QgZG1hX2hlYXBfb3BzIGNtYV9oZWFwX29wcyA9IHsKIAkuYWxsb2NhdGUgPSBjbWFf
aGVhcF9hbGxvY2F0ZSwKIH07CiAKQEAgLTE3NSwzICszOTIsNCBAQCBzdGF0aWMgaW50IGFkZF9k
ZWZhdWx0X2NtYV9oZWFwKHZvaWQpCiBtb2R1bGVfaW5pdChhZGRfZGVmYXVsdF9jbWFfaGVhcCk7
CiBNT0RVTEVfREVTQ1JJUFRJT04oIkRNQS1CVUYgQ01BIEhlYXAiKTsKIE1PRFVMRV9MSUNFTlNF
KCJHUEwgdjIiKTsKKwotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9kcmktZGV2ZWwK
