Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id D05EB4979C
	for <lists+dri-devel@lfdr.de>; Tue, 18 Jun 2019 04:46:04 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 68CB089D8D;
	Tue, 18 Jun 2019 02:46:02 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-qk1-x742.google.com (mail-qk1-x742.google.com
 [IPv6:2607:f8b0:4864:20::742])
 by gabe.freedesktop.org (Postfix) with ESMTPS id B7F1889D8D
 for <dri-devel@lists.freedesktop.org>; Tue, 18 Jun 2019 02:46:00 +0000 (UTC)
Received: by mail-qk1-x742.google.com with SMTP id d15so7608340qkl.4
 for <dri-devel@lists.freedesktop.org>; Mon, 17 Jun 2019 19:46:00 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:date:from:to:cc:subject:message-id:references
 :mime-version:content-disposition:in-reply-to:user-agent;
 bh=hnmSbaPYoH9LcJj1HTI+NTdpL8T7oL5uLDV7aWkGRYw=;
 b=j9QgpBz0TAvmemQrjP3zRq6wPTA48452SmWp1z3QQ8xfTlSGcrb5KNzBlDWODbD3Wv
 KpnRc/ef+YxT1CQbI62UOew6sP//qwW0drUCBVBapThbwQIaweumJv4OG9aA16kNJNXH
 G8UY+zNitM6CfMhJfCJ74RzMlYGjbN2atGJYmC4JXMjH0UHbimdRwAWWFaVPaWy2y3Nh
 lYKS1eSdnK+uCOByppYrKbbtI6WGYbJP9hJauTjXkjPDwiTM8X5J/TITAaFxnyeKwr68
 fHT9XpTRjN7qfAuvu1XjuwOqz3yuOXEH+IQGHnHsDm7VMT0BRuQZmslFEcKe07jOV+Vu
 qxuw==
X-Gm-Message-State: APjAAAVoQRaLDdS7NeRwM84YbOVY/jMHiGuXkanIXRnrEGTb79yJkPRH
 6i6YKRpUW0kTDbPUw2mDrZE=
X-Google-Smtp-Source: APXvYqz5ZSIcXaacdr9jK2qHSKWsTQi7aoWbIa4fZxY/5ixtQBQYHqTqT3rg/e1mEMmfOtMjvNg+zA==
X-Received: by 2002:a05:620a:16ba:: with SMTP id
 s26mr19866476qkj.301.1560825959838; 
 Mon, 17 Jun 2019 19:45:59 -0700 (PDT)
Received: from smtp.gmail.com ([187.121.151.146])
 by smtp.gmail.com with ESMTPSA id 41sm9866593qtp.32.2019.06.17.19.45.56
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Mon, 17 Jun 2019 19:45:59 -0700 (PDT)
Date: Mon, 17 Jun 2019 23:45:55 -0300
From: Rodrigo Siqueira <rodrigosiqueiramelo@gmail.com>
To: Brian Starkey <brian.starkey@arm.com>,
 Liviu Dudau <liviu.dudau@arm.com>, Daniel Vetter <daniel@ffwll.ch>,
 Haneen Mohammed <hamohammed.sa@gmail.com>, Simon Ser <contact@emersion.fr>
Subject: [PATCH V2 5/5] drm/vkms: Add support for writeback
Message-ID: <4787369d4927fa709da050e7481e48102842fd97.1560820888.git.rodrigosiqueiramelo@gmail.com>
References: <cover.1560820888.git.rodrigosiqueiramelo@gmail.com>
MIME-Version: 1.0
Content-Disposition: inline
In-Reply-To: <cover.1560820888.git.rodrigosiqueiramelo@gmail.com>
User-Agent: NeoMutt/20180716
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=date:from:to:cc:subject:message-id:references:mime-version
 :content-disposition:in-reply-to:user-agent;
 bh=hnmSbaPYoH9LcJj1HTI+NTdpL8T7oL5uLDV7aWkGRYw=;
 b=SEpfCcNYyPV3gc7A0i6Ms3EhPuoD6JobPTWX9G8KOv5NY4bsZB14/9dR/bw58P/83h
 p/BR9eTKXzcGKyI+kIYmdSMV8hTsBkRXWFGBdFVIuEJlzjt8PTgIsWwTGCLhSuPUA231
 e/2YdhYMTzJjoPDGbMQOjtd+V1uZdTN39ypP3Ln7aTpKyWGY0vB7GG3wQwUzCwzhhsOW
 FhY/Tc7Q0/1/H3YGNfTZP+pTM4ZboPbBFM9tVGpvomJT2UxJBlwoVqWqhvCXMi7TP/JR
 VKzZRysvEs8Zvt2zHS3wK3C1+0mMHPra6tbZu0EPkLXGSpGTMoRAGb4NybcJKOGVW0c3
 vOQA==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBpbXBsZW1lbnRzIHRoZSBuZWNlc3NhcnkgZnVuY3Rpb25zIHRvIGFkZCB3cml0
ZWJhY2sgc3VwcG9ydApmb3Igdmttcy4gVGhpcyBmZWF0dXJlIGlzIHVzZWZ1bCBmb3IgdGVzdGlu
ZyBjb21wb3NpdG9ycyBpZiB5b3UgZG9uJ3QKaGF2ZSBoYXJkd2FyZSB3aXRoIHdyaXRlYmFjayBz
dXBwb3J0LgoKQ2hhbmdlIGluIFYyOgotIFJld29yayBzaWduYWwgY29tcGxldGlvbiAoQnJpYW4p
Ci0gSW50ZWdyYXRlcyB3cml0ZWJhY2sgd2l0aCBhY3RpdmVfcGxhbmVzIChEYW5pZWwpCi0gQ29t
cG9zZSBjdXJzb3IgKERhbmllbCkKClNpZ25lZC1vZmYtYnk6IFJvZHJpZ28gU2lxdWVpcmEgPHJv
ZHJpZ29zaXF1ZWlyYW1lbG9AZ21haWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS92a21zL01h
a2VmaWxlICAgICAgICAgfCAgIDMgKy0KIGRyaXZlcnMvZ3B1L2RybS92a21zL3ZrbXNfZHJ2LmMg
ICAgICAgfCAgIDcgKysKIGRyaXZlcnMvZ3B1L2RybS92a21zL3ZrbXNfZHJ2LmggICAgICAgfCAg
IDYgKwogZHJpdmVycy9ncHUvZHJtL3ZrbXMvdmttc19vdXRwdXQuYyAgICB8ICAgNiArCiBkcml2
ZXJzL2dwdS9kcm0vdmttcy92a21zX3dyaXRlYmFjay5jIHwgMTY2ICsrKysrKysrKysrKysrKysr
KysrKysrKysrCiA1IGZpbGVzIGNoYW5nZWQsIDE4NyBpbnNlcnRpb25zKCspLCAxIGRlbGV0aW9u
KC0pCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy9ncHUvZHJtL3ZrbXMvdmttc193cml0ZWJh
Y2suYwoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92a21zL01ha2VmaWxlIGIvZHJpdmVy
cy9ncHUvZHJtL3ZrbXMvTWFrZWZpbGUKaW5kZXggYjRjMDQwODU0YmQ2Li4wOTFlNmZhNjQzZDEg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS92a21zL01ha2VmaWxlCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS92a21zL01ha2VmaWxlCkBAIC02LDYgKzYsNyBAQCB2a21zLXkgOj0gXAogCXZrbXNf
Y3J0Yy5vIFwKIAl2a21zX2dlbS5vIFwKIAl2a21zX2NvbXBvc2VyLm8gXAotCXZrbXNfY3JjLm8K
Kwl2a21zX2NyYy5vIFwKKwl2a21zX3dyaXRlYmFjay5vCiAKIG9iai0kKENPTkZJR19EUk1fVktN
UykgKz0gdmttcy5vCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdmttcy92a21zX2Rydi5j
IGIvZHJpdmVycy9ncHUvZHJtL3ZrbXMvdmttc19kcnYuYwppbmRleCA5NjZiM2Q2NTMxODkuLmQ4
NzA3NzlhYmY5ZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3ZrbXMvdmttc19kcnYuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vdmttcy92a21zX2Rydi5jCkBAIC0zMCw2ICszMCwxMCBAQCBi
b29sIGVuYWJsZV9jdXJzb3I7CiBtb2R1bGVfcGFyYW1fbmFtZWQoZW5hYmxlX2N1cnNvciwgZW5h
YmxlX2N1cnNvciwgYm9vbCwgMDQ0NCk7CiBNT0RVTEVfUEFSTV9ERVNDKGVuYWJsZV9jdXJzb3Is
ICJFbmFibGUvRGlzYWJsZSBjdXJzb3Igc3VwcG9ydCIpOwogCitib29sIGVuYWJsZV93cml0ZWJh
Y2s7Cittb2R1bGVfcGFyYW1fbmFtZWQoZW5hYmxlX3dyaXRlYmFjaywgZW5hYmxlX3dyaXRlYmFj
aywgYm9vbCwgMDQ0NCk7CitNT0RVTEVfUEFSTV9ERVNDKGVuYWJsZV93cml0ZWJhY2ssICJFbmFi
bGUvRGlzYWJsZSB3cml0ZWJhY2sgY29ubmVjdG9yIik7CisKIHN0YXRpYyBjb25zdCBzdHJ1Y3Qg
ZmlsZV9vcGVyYXRpb25zIHZrbXNfZHJpdmVyX2ZvcHMgPSB7CiAJLm93bmVyCQk9IFRISVNfTU9E
VUxFLAogCS5vcGVuCQk9IGRybV9vcGVuLApAQCAtMTU4LDYgKzE2Miw5IEBAIHN0YXRpYyBpbnQg
X19pbml0IHZrbXNfaW5pdCh2b2lkKQogCQlnb3RvIG91dF9maW5pOwogCX0KIAorCWlmIChlbmFi
bGVfd3JpdGViYWNrKQorCQlEUk1fSU5GTygiV3JpdGViYWNrIGNvbm5lY3RvciBlbmFibGVkIik7
CisKIAlyZXQgPSB2a21zX21vZGVzZXRfaW5pdCh2a21zX2RldmljZSk7CiAJaWYgKHJldCkKIAkJ
Z290byBvdXRfZmluaTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92a21zL3ZrbXNfZHJ2
LmggYi9kcml2ZXJzL2dwdS9kcm0vdmttcy92a21zX2Rydi5oCmluZGV4IGFkNjNkYmU1ZTk5NC4u
YmYzZmE3MzdiM2Q3IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmttcy92a21zX2Rydi5o
CisrKyBiL2RyaXZlcnMvZ3B1L2RybS92a21zL3ZrbXNfZHJ2LmgKQEAgLTcsNiArNyw3IEBACiAj
aW5jbHVkZSA8ZHJtL2RybS5oPgogI2luY2x1ZGUgPGRybS9kcm1fZ2VtLmg+CiAjaW5jbHVkZSA8
ZHJtL2RybV9lbmNvZGVyLmg+CisjaW5jbHVkZSA8ZHJtL2RybV93cml0ZWJhY2suaD4KICNpbmNs
dWRlIDxsaW51eC9ocnRpbWVyLmg+CiAKICNkZWZpbmUgWFJFU19NSU4gICAgMjAKQEAgLTE5LDYg
KzIwLDcgQEAKICNkZWZpbmUgWVJFU19NQVggIDgxOTIKIAogZXh0ZXJuIGJvb2wgZW5hYmxlX2N1
cnNvcjsKK2V4dGVybiBib29sIGVuYWJsZV93cml0ZWJhY2s7CiAKIHN0cnVjdCB2a21zX2RhdGEg
ewogCXN0cnVjdCBkcm1fZnJhbWVidWZmZXIgZmI7CkBAIC02Myw2ICs2NSw3IEBAIHN0cnVjdCB2
a21zX291dHB1dCB7CiAJc3RydWN0IGRybV9jcnRjIGNydGM7CiAJc3RydWN0IGRybV9lbmNvZGVy
IGVuY29kZXI7CiAJc3RydWN0IGRybV9jb25uZWN0b3IgY29ubmVjdG9yOworCXN0cnVjdCBkcm1f
d3JpdGViYWNrX2Nvbm5lY3RvciB3Yl9jb25uZWN0b3I7CiAJc3RydWN0IGhydGltZXIgdmJsYW5r
X2hydGltZXI7CiAJa3RpbWVfdCBwZXJpb2RfbnM7CiAJc3RydWN0IGRybV9wZW5kaW5nX3ZibGFu
a19ldmVudCAqZXZlbnQ7CkBAIC0xNDMsNCArMTQ2LDcgQEAgaW50IHZrbXNfdmVyaWZ5X2NyY19z
b3VyY2Uoc3RydWN0IGRybV9jcnRjICpjcnRjLCBjb25zdCBjaGFyICpzb3VyY2VfbmFtZSwKIAkJ
CSAgIHNpemVfdCAqdmFsdWVzX2NudCk7CiB2b2lkIHZrbXNfY3JjX3dvcmtfaGFuZGxlKHN0cnVj
dCB3b3JrX3N0cnVjdCAqd29yayk7CiAKKy8qIFdyaXRlYmFjayAqLworaW50IGVuYWJsZV93cml0
ZWJhY2tfY29ubmVjdG9yKHN0cnVjdCB2a21zX2RldmljZSAqdmttc2Rldik7CisKICNlbmRpZiAv
KiBfVktNU19EUlZfSF8gKi8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS92a21zL3ZrbXNf
b3V0cHV0LmMgYi9kcml2ZXJzL2dwdS9kcm0vdmttcy92a21zX291dHB1dC5jCmluZGV4IGZiMTk0
MWE2NTIyYy4uM2IwOTNhZThmMzczIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmttcy92
a21zX291dHB1dC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS92a21zL3ZrbXNfb3V0cHV0LmMKQEAg
LTg0LDYgKzg0LDEyIEBAIGludCB2a21zX291dHB1dF9pbml0KHN0cnVjdCB2a21zX2RldmljZSAq
dmttc2RldiwgaW50IGluZGV4KQogCQlnb3RvIGVycl9hdHRhY2g7CiAJfQogCisJaWYgKGVuYWJs
ZV93cml0ZWJhY2spIHsKKwkJcmV0ID0gZW5hYmxlX3dyaXRlYmFja19jb25uZWN0b3Iodmttc2Rl
dik7CisJCWlmIChyZXQpCisJCQlEUk1fRVJST1IoIkZhaWxlZCB0byBpbml0IHdyaXRlYmFjayBj
b25uZWN0b3JcbiIpOworCX0KKwogCWRybV9tb2RlX2NvbmZpZ19yZXNldChkZXYpOwogCiAJcmV0
dXJuIDA7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdmttcy92a21zX3dyaXRlYmFjay5j
IGIvZHJpdmVycy9ncHUvZHJtL3ZrbXMvdmttc193cml0ZWJhY2suYwpuZXcgZmlsZSBtb2RlIDEw
MDY0NAppbmRleCAwMDAwMDAwMDAwMDAuLjU2NjMyZWIzOTNjYgotLS0gL2Rldi9udWxsCisrKyBi
L2RyaXZlcnMvZ3B1L2RybS92a21zL3ZrbXNfd3JpdGViYWNrLmMKQEAgLTAsMCArMSwxNjYgQEAK
Ky8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBHUEwtMi4wKworCisjaW5jbHVkZSAidmttc19k
cnYuaCIKKyNpbmNsdWRlICJ2a21zX2NvbXBvc2VyLmgiCisjaW5jbHVkZSA8ZHJtL2RybV93cml0
ZWJhY2suaD4KKyNpbmNsdWRlIDxkcm0vZHJtX3Byb2JlX2hlbHBlci5oPgorI2luY2x1ZGUgPGRy
bS9kcm1fYXRvbWljX2hlbHBlci5oPgorI2luY2x1ZGUgPGRybS9kcm1fZ2VtX2ZyYW1lYnVmZmVy
X2hlbHBlci5oPgorCitzdGF0aWMgY29uc3QgdTMyIHZrbXNfd2JfZm9ybWF0c1tdID0geworCURS
TV9GT1JNQVRfWFJHQjg4ODgsCit9OworCitzdGF0aWMgY29uc3Qgc3RydWN0IGRybV9jb25uZWN0
b3JfZnVuY3Mgdmttc193Yl9jb25uZWN0b3JfZnVuY3MgPSB7CisJLmZpbGxfbW9kZXMgPSBkcm1f
aGVscGVyX3Byb2JlX3NpbmdsZV9jb25uZWN0b3JfbW9kZXMsCisJLmRlc3Ryb3kgPSBkcm1fY29u
bmVjdG9yX2NsZWFudXAsCisJLnJlc2V0ID0gZHJtX2F0b21pY19oZWxwZXJfY29ubmVjdG9yX3Jl
c2V0LAorCS5hdG9taWNfZHVwbGljYXRlX3N0YXRlID0gZHJtX2F0b21pY19oZWxwZXJfY29ubmVj
dG9yX2R1cGxpY2F0ZV9zdGF0ZSwKKwkuYXRvbWljX2Rlc3Ryb3lfc3RhdGUgPSBkcm1fYXRvbWlj
X2hlbHBlcl9jb25uZWN0b3JfZGVzdHJveV9zdGF0ZSwKK307CisKK3N0YXRpYyBpbnQgdmttc193
Yl9lbmNvZGVyX2F0b21pY19jaGVjayhzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29kZXIsCisJCQkJ
CXN0cnVjdCBkcm1fY3J0Y19zdGF0ZSAqY3J0Y19zdGF0ZSwKKwkJCQkJc3RydWN0IGRybV9jb25u
ZWN0b3Jfc3RhdGUgKmNvbm5fc3RhdGUpCit7CisJc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmI7
CisJY29uc3Qgc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKm1vZGUgPSAmY3J0Y19zdGF0ZS0+bW9k
ZTsKKworCWlmICghY29ubl9zdGF0ZS0+d3JpdGViYWNrX2pvYiB8fCAhY29ubl9zdGF0ZS0+d3Jp
dGViYWNrX2pvYi0+ZmIpCisJCXJldHVybiAwOworCisJZmIgPSBjb25uX3N0YXRlLT53cml0ZWJh
Y2tfam9iLT5mYjsKKwlpZiAoZmItPndpZHRoICE9IG1vZGUtPmhkaXNwbGF5IHx8IGZiLT5oZWln
aHQgIT0gbW9kZS0+dmRpc3BsYXkpIHsKKwkJRFJNX0RFQlVHX0tNUygiSW52YWxpZCBmcmFtZWJ1
ZmZlciBzaXplICV1eCV1XG4iLAorCQkJICAgICAgZmItPndpZHRoLCBmYi0+aGVpZ2h0KTsKKwkJ
cmV0dXJuIC1FSU5WQUw7CisJfQorCisJaWYgKGZiLT5mb3JtYXQtPmZvcm1hdCAhPSBEUk1fRk9S
TUFUX1hSR0I4ODg4KSB7CisJCXN0cnVjdCBkcm1fZm9ybWF0X25hbWVfYnVmIGZvcm1hdF9uYW1l
OworCisJCURSTV9ERUJVR19LTVMoIkludmFsaWQgcGl4ZWwgZm9ybWF0ICVzXG4iLAorCQkJICAg
ICAgZHJtX2dldF9mb3JtYXRfbmFtZShmYi0+Zm9ybWF0LT5mb3JtYXQsCisJCQkJCQkgICZmb3Jt
YXRfbmFtZSkpOworCQlyZXR1cm4gLUVJTlZBTDsKKwl9CisKKwlyZXR1cm4gMDsKK30KKworc3Rh
dGljIGNvbnN0IHN0cnVjdCBkcm1fZW5jb2Rlcl9oZWxwZXJfZnVuY3Mgdmttc193Yl9lbmNvZGVy
X2hlbHBlcl9mdW5jcyA9IHsKKwkuYXRvbWljX2NoZWNrID0gdmttc193Yl9lbmNvZGVyX2F0b21p
Y19jaGVjaywKK307CisKK3N0YXRpYyBpbnQgdmttc193Yl9jb25uZWN0b3JfZ2V0X21vZGVzKHN0
cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IpCit7CisJc3RydWN0IGRybV9kZXZpY2UgKmRl
diA9IGNvbm5lY3Rvci0+ZGV2OworCisJcmV0dXJuIGRybV9hZGRfbW9kZXNfbm9lZGlkKGNvbm5l
Y3RvciwgZGV2LT5tb2RlX2NvbmZpZy5tYXhfd2lkdGgsCisJCQkJICAgIGRldi0+bW9kZV9jb25m
aWcubWF4X2hlaWdodCk7Cit9CisKK3N0YXRpYyBpbnQgdmttc193Yl9wcmVwYXJlX2pvYihzdHJ1
Y3QgZHJtX3dyaXRlYmFja19jb25uZWN0b3IgKndiX2Nvbm5lY3RvciwKKwkJCSAgICAgICBzdHJ1
Y3QgZHJtX3dyaXRlYmFja19qb2IgKmpvYikKK3sKKwlzdHJ1Y3Qgdmttc19nZW1fb2JqZWN0ICp2
a21zX29iajsKKwlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKmdlbV9vYmo7CisJaW50IHJldDsKKwor
CWlmICgham9iLT5mYikKKwkJcmV0dXJuIDA7CisKKwlnZW1fb2JqID0gZHJtX2dlbV9mYl9nZXRf
b2JqKGpvYi0+ZmIsIDApOworCXJldCA9IHZrbXNfZ2VtX3ZtYXAoZ2VtX29iaik7CisJaWYgKHJl
dCkgeworCQlEUk1fRVJST1IoInZtYXAgZmFpbGVkOiAlZFxuIiwgcmV0KTsKKwkJcmV0dXJuIHJl
dDsKKwl9CisKKwl2a21zX29iaiA9IGRybV9nZW1fdG9fdmttc19nZW0oZ2VtX29iaik7CisJam9i
LT5wcml2ID0gdmttc19vYmotPnZhZGRyOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyB2b2lk
IHZrbXNfd2JfY2xlYW51cF9qb2Ioc3RydWN0IGRybV93cml0ZWJhY2tfY29ubmVjdG9yICpjb25u
ZWN0b3IsCisJCQkJc3RydWN0IGRybV93cml0ZWJhY2tfam9iICpqb2IpCit7CisJc3RydWN0IGRy
bV9nZW1fb2JqZWN0ICpnZW1fb2JqOworCisJaWYgKCFqb2ItPmZiKQorCQlyZXR1cm47CisKKwln
ZW1fb2JqID0gZHJtX2dlbV9mYl9nZXRfb2JqKGpvYi0+ZmIsIDApOworCXZrbXNfZ2VtX3Z1bm1h
cChnZW1fb2JqKTsKK30KKworc3RhdGljIHZvaWQgdmttc193Yl9hdG9taWNfY29tbWl0KHN0cnVj
dCBkcm1fY29ubmVjdG9yICpjb25uLAorCQkJCSAgc3RydWN0IGRybV9jb25uZWN0b3Jfc3RhdGUg
KnN0YXRlKQoreworCXN0cnVjdCB2a21zX2RldmljZSAqdmttc2RldiA9IGRybV9kZXZpY2VfdG9f
dmttc19kZXZpY2UoY29ubi0+ZGV2KTsKKwlzdHJ1Y3Qgdmttc19vdXRwdXQgKm91dHB1dCA9ICZ2
a21zZGV2LT5vdXRwdXQ7CisJc3RydWN0IHZrbXNfY3J0Y19zdGF0ZSAqY3J0Y19zdGF0ZSA9IG91
dHB1dC0+Y3JjX3N0YXRlOworCXN0cnVjdCBkcm1fd3JpdGViYWNrX2Nvbm5lY3RvciAqd2JfY29u
biA9ICZvdXRwdXQtPndiX2Nvbm5lY3RvcjsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3Rvcl9zdGF0ZSAq
Y29ubl9zdGF0ZSA9IHdiX2Nvbm4tPmJhc2Uuc3RhdGU7CisJdm9pZCAqcHJpdl9kYXRhID0gY29u
bl9zdGF0ZS0+d3JpdGViYWNrX2pvYi0+cHJpdjsKKwlzdHJ1Y3Qgdmttc19kYXRhICpwcmltYXJ5
X2RhdGEgPSBOVUxMOworCXN0cnVjdCB2a21zX2RhdGEgKmN1cnNvcl9kYXRhID0gTlVMTDsKKwlz
dHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYiA9IE5VTEw7CisJc3RydWN0IHZrbXNfZ2VtX29iamVj
dCAqdmttc19vYmo7CisJc3RydWN0IGRybV9nZW1fb2JqZWN0ICpnZW1fb2JqOworCisJaWYgKCFj
b25uX3N0YXRlKQorCQlyZXR1cm47CisKKwlpZiAoIWNvbm5fc3RhdGUtPndyaXRlYmFja19qb2Ig
fHwgIWNvbm5fc3RhdGUtPndyaXRlYmFja19qb2ItPmZiKSB7CisJCURSTV9ERUJVR19EUklWRVIo
IkRpc2FibGUgd3JpdGViYWNrXG4iKTsKKwkJcmV0dXJuOworCX0KKworCWlmIChjcnRjX3N0YXRl
LT5udW1fYWN0aXZlX3BsYW5lcyA+PSAxKQorCQlwcmltYXJ5X2RhdGEgPSBjcnRjX3N0YXRlLT5h
Y3RpdmVfcGxhbmVzWzBdLT5kYXRhOworCisJaWYgKGNydGNfc3RhdGUtPm51bV9hY3RpdmVfcGxh
bmVzID09IDIpCisJCWN1cnNvcl9kYXRhID0gY3J0Y19zdGF0ZS0+YWN0aXZlX3BsYW5lc1sxXS0+
ZGF0YTsKKworCWlmICghcHJpbWFyeV9kYXRhKQorCQlyZXR1cm47CisKKwlmYiA9ICZwcmltYXJ5
X2RhdGEtPmZiOworCWdlbV9vYmogPSBkcm1fZ2VtX2ZiX2dldF9vYmooZmIsIDApOworCXZrbXNf
b2JqID0gZHJtX2dlbV90b192a21zX2dlbShnZW1fb2JqKTsKKworCWlmICghdmttc19vYmotPnZh
ZGRyIHx8ICFwcml2X2RhdGEpCisJCXJldHVybjsKKworCWRybV93cml0ZWJhY2tfcXVldWVfam9i
KHdiX2Nvbm4sIHN0YXRlKTsKKworCW1lbWNweShwcml2X2RhdGEsIHZrbXNfb2JqLT52YWRkciwg
dmttc19vYmotPmdlbS5zaXplKTsKKwlpZiAoY3Vyc29yX2RhdGEpCisJCWNvbXBvc2VfY3Vyc29y
KGN1cnNvcl9kYXRhLCBwcmltYXJ5X2RhdGEsIHByaXZfZGF0YSk7CisKKwlkcm1fd3JpdGViYWNr
X3NpZ25hbF9jb21wbGV0aW9uKHdiX2Nvbm4sIDApOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0
IGRybV9jb25uZWN0b3JfaGVscGVyX2Z1bmNzIHZrbXNfd2JfY29ubl9oZWxwZXJfZnVuY3MgPSB7
CisJLmdldF9tb2RlcyA9IHZrbXNfd2JfY29ubmVjdG9yX2dldF9tb2RlcywKKwkucHJlcGFyZV93
cml0ZWJhY2tfam9iID0gdmttc193Yl9wcmVwYXJlX2pvYiwKKwkuY2xlYW51cF93cml0ZWJhY2tf
am9iID0gdmttc193Yl9jbGVhbnVwX2pvYiwKKwkuYXRvbWljX2NvbW1pdCA9IHZrbXNfd2JfYXRv
bWljX2NvbW1pdCwKK307CisKK2ludCBlbmFibGVfd3JpdGViYWNrX2Nvbm5lY3RvcihzdHJ1Y3Qg
dmttc19kZXZpY2UgKnZrbXNkZXYpCit7CisJc3RydWN0IGRybV93cml0ZWJhY2tfY29ubmVjdG9y
ICp3YiA9ICZ2a21zZGV2LT5vdXRwdXQud2JfY29ubmVjdG9yOworCisJdmttc2Rldi0+b3V0cHV0
LndiX2Nvbm5lY3Rvci5lbmNvZGVyLnBvc3NpYmxlX2NydGNzID0gMTsKKwlkcm1fY29ubmVjdG9y
X2hlbHBlcl9hZGQoJndiLT5iYXNlLCAmdmttc193Yl9jb25uX2hlbHBlcl9mdW5jcyk7CisKKwly
ZXR1cm4gZHJtX3dyaXRlYmFja19jb25uZWN0b3JfaW5pdCgmdmttc2Rldi0+ZHJtLCB3YiwKKwkJ
CQkJICAgICZ2a21zX3diX2Nvbm5lY3Rvcl9mdW5jcywKKwkJCQkJICAgICZ2a21zX3diX2VuY29k
ZXJfaGVscGVyX2Z1bmNzLAorCQkJCQkgICAgdmttc193Yl9mb3JtYXRzLAorCQkJCQkgICAgQVJS
QVlfU0laRSh2a21zX3diX2Zvcm1hdHMpKTsKK30KKwotLSAKMi4yMS4wCl9fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QK
ZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9w
Lm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
