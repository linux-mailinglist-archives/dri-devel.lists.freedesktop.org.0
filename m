Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id AF795114DE1
	for <lists+dri-devel@lfdr.de>; Fri,  6 Dec 2019 10:00:24 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9BE866F97F;
	Fri,  6 Dec 2019 09:00:11 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 by gabe.freedesktop.org (Postfix) with ESMTPS id CFD2E6F979
 for <dri-devel@lists.freedesktop.org>; Fri,  6 Dec 2019 09:00:00 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id DEAEBB251;
 Fri,  6 Dec 2019 08:59:58 +0000 (UTC)
From: Thomas Zimmermann <tzimmermann@suse.de>
To: airlied@redhat.com, daniel@ffwll.ch, sam@ravnborg.org, kraxel@redhat.com,
 emil.velikov@collabora.com, noralf@tronnes.org, zboszor@pr.hu
Subject: [PATCH v2 6/7] drm/udl: Begin/end access to imported buffers in
 damage-handler
Date: Fri,  6 Dec 2019 09:59:53 +0100
Message-Id: <20191206085954.9697-7-tzimmermann@suse.de>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191206085954.9697-1-tzimmermann@suse.de>
References: <20191206085954.9697-1-tzimmermann@suse.de>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Thomas Zimmermann <tzimmermann@suse.de>, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhlIGRhbWFnZS1oYW5kbGVyIGNvZGUgbm93IGludm9rZXMgZG1hX2J1Zl97YmVnaW4sZW5kfV9h
Y2Nlc3MoKQpmb3IgaW1wb3J0ZWQgYnVmZmVycy4gVGhlc2UgY2FsbHMgd2VyZSBtaXNzaW5nIGZy
b20gdGhlIHBhZ2UtZmxpcAphbmQgbW9kZXNldHRpbmcgY29kZSBwYXRocy4gVGhlIHBhdGNoIGFs
c28gZml4ZXMgYW4gYnVnIGluIHRoZQpvcmlnbmFsIHdoZXJlIGFuIGVycm9yIGNvZGUgd2FzIG92
ZXJ3cml0dGVuIGJ5IHRoZSByZXN1bHQgb2YKZG1hX2J1Zl9lbmRfY3B1X2FjY2VzcygpLgoKdjI6
CgkqIG9ubHkgcmV0dXJuIGFuIGVycm9yIGNvZGUgZnJvbSBkbWFfYnVmX2VuZF9jcHVfYWNjZXNz
KCkgaWYKCSAgbm8gb3RoZXIgZXJyb3IgY29kZSBoYXMgYmVlbiBzZXQgYmVmb3JlCgpTaWduZWQt
b2ZmLWJ5OiBUaG9tYXMgWmltbWVybWFubiA8dHppbW1lcm1hbm5Ac3VzZS5kZT4KUmV2aWV3ZWQt
Ynk6IEVtaWwgVmVsaWtvdiA8ZW1pbC52ZWxpa292QGNvbGxhYm9yYS5jb20+CkFja2VkLWJ5OiBH
ZXJkIEhvZmZtYW5uIDxrcmF4ZWxAcmVkaGF0LmNvbT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vdWRs
L3VkbF9mYi5jIHwgNDMgKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0tLS0tCiAxIGZp
bGUgY2hhbmdlZCwgMjMgaW5zZXJ0aW9ucygrKSwgMjAgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfZmIuYyBiL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRs
X2ZiLmMKaW5kZXggNDgyNzg2ZWVlYTZjLi4wZjgzYTZmYzEwNTYgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS91ZGwvdWRsX2ZiLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfZmIu
YwpAQCAtOTIsNyArOTIsOCBAQCBpbnQgdWRsX2hhbmRsZV9kYW1hZ2Uoc3RydWN0IGRybV9mcmFt
ZWJ1ZmZlciAqZmIsIGludCB4LCBpbnQgeSwKIHsKIAlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0g
ZmItPmRldjsKIAlzdHJ1Y3QgdWRsX2RldmljZSAqdWRsID0gdG9fdWRsKGRldik7Ci0JaW50IGks
IHJldDsKKwlzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICppbXBvcnRfYXR0YWNoID0gZmItPm9i
alswXS0+aW1wb3J0X2F0dGFjaDsKKwlpbnQgaSwgcmV0LCB0bXBfcmV0OwogCWNoYXIgKmNtZDsK
IAlzdHJ1Y3QgdXJiICp1cmI7CiAJc3RydWN0IGRybV9yZWN0IGNsaXA7CkBAIC0xMTcsMTUgKzEx
OCwyMiBAQCBpbnQgdWRsX2hhbmRsZV9kYW1hZ2Uoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIs
IGludCB4LCBpbnQgeSwKIAllbHNlIGlmICgoY2xpcC54MiA+IGZiLT53aWR0aCkgfHwgKGNsaXAu
eTIgPiBmYi0+aGVpZ2h0KSkKIAkJcmV0dXJuIC1FSU5WQUw7CiAKKwlpZiAoaW1wb3J0X2F0dGFj
aCkgeworCQlyZXQgPSBkbWFfYnVmX2JlZ2luX2NwdV9hY2Nlc3MoaW1wb3J0X2F0dGFjaC0+ZG1h
YnVmLAorCQkJCQkgICAgICAgRE1BX0ZST01fREVWSUNFKTsKKwkJaWYgKHJldCkKKwkJCXJldHVy
biByZXQ7CisJfQorCiAJdmFkZHIgPSBkcm1fZ2VtX3NobWVtX3ZtYXAoZmItPm9ialswXSk7CiAJ
aWYgKElTX0VSUih2YWRkcikpIHsKIAkJRFJNX0VSUk9SKCJmYWlsZWQgdG8gdm1hcCBmYlxuIik7
Ci0JCXJldHVybiAwOworCQlnb3RvIG91dF9kbWFfYnVmX2VuZF9jcHVfYWNjZXNzOwogCX0KIAog
CXVyYiA9IHVkbF9nZXRfdXJiKGRldik7CiAJaWYgKCF1cmIpCi0JCWdvdG8gb3V0OworCQlnb3Rv
IG91dF9kcm1fZ2VtX3NobWVtX3Z1bm1hcDsKIAljbWQgPSB1cmItPnRyYW5zZmVyX2J1ZmZlcjsK
IAogCWZvciAoaSA9IGNsaXAueTE7IGkgPCBjbGlwLnkyOyBpKyspIHsKQEAgLTEzNiw3ICsxNDQs
NyBAQCBpbnQgdWRsX2hhbmRsZV9kYW1hZ2Uoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIsIGlu
dCB4LCBpbnQgeSwKIAkJaWYgKHVkbF9yZW5kZXJfaGxpbmUoZGV2LCBsb2dfYnBwLCAmdXJiLCAo
Y2hhciAqKXZhZGRyLAogCQkJCSAgICAgJmNtZCwgYnl0ZV9vZmZzZXQsIGRldl9ieXRlX29mZnNl
dCwKIAkJCQkgICAgIGJ5dGVfd2lkdGgpKQotCQkJZ290byBvdXQ7CisJCQlnb3RvIG91dF9kcm1f
Z2VtX3NobWVtX3Z1bm1hcDsKIAl9CiAKIAlpZiAoY21kID4gKGNoYXIgKikgdXJiLT50cmFuc2Zl
cl9idWZmZXIpIHsKQEAgLTE0OSwxMCArMTU3LDE5IEBAIGludCB1ZGxfaGFuZGxlX2RhbWFnZShz
dHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYiwgaW50IHgsIGludCB5LAogCX0gZWxzZQogCQl1ZGxf
dXJiX2NvbXBsZXRpb24odXJiKTsKIAotb3V0OgorCXJldCA9IDA7CisKK291dF9kcm1fZ2VtX3No
bWVtX3Z1bm1hcDoKIAlkcm1fZ2VtX3NobWVtX3Z1bm1hcChmYi0+b2JqWzBdLCB2YWRkcik7Citv
dXRfZG1hX2J1Zl9lbmRfY3B1X2FjY2VzczoKKwlpZiAoaW1wb3J0X2F0dGFjaCkgeworCQl0bXBf
cmV0ID0gZG1hX2J1Zl9lbmRfY3B1X2FjY2VzcyhpbXBvcnRfYXR0YWNoLT5kbWFidWYsCisJCQkJ
CQkgRE1BX0ZST01fREVWSUNFKTsKKwkJaWYgKHRtcF9yZXQgJiYgIXJldCkKKwkJCXJldCA9IHRt
cF9yZXQ7IC8qIG9ubHkgdXBkYXRlIHJldCBpZiBub3Qgc2V0IHlldCAqLworCX0KIAotCXJldHVy
biAwOworCXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyBpbnQgdWRsX3VzZXJfZnJhbWVidWZmZXJf
ZGlydHkoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIsCkBAIC0xNjIsNyArMTc5LDYgQEAgc3Rh
dGljIGludCB1ZGxfdXNlcl9mcmFtZWJ1ZmZlcl9kaXJ0eShzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVy
ICpmYiwKIAkJCQkgICAgICB1bnNpZ25lZCBudW1fY2xpcHMpCiB7CiAJc3RydWN0IHVkbF9kZXZp
Y2UgKnVkbCA9IGZiLT5kZXYtPmRldl9wcml2YXRlOwotCXN0cnVjdCBkbWFfYnVmX2F0dGFjaG1l
bnQgKmltcG9ydF9hdHRhY2g7CiAJaW50IGk7CiAJaW50IHJldCA9IDA7CiAKQEAgLTE3NSwxNSAr
MTkxLDYgQEAgc3RhdGljIGludCB1ZGxfdXNlcl9mcmFtZWJ1ZmZlcl9kaXJ0eShzdHJ1Y3QgZHJt
X2ZyYW1lYnVmZmVyICpmYiwKIAl9CiAJc3Bpbl91bmxvY2soJnVkbC0+YWN0aXZlX2ZiXzE2X2xv
Y2spOwogCi0JaW1wb3J0X2F0dGFjaCA9IGZiLT5vYmpbMF0tPmltcG9ydF9hdHRhY2g7Ci0KLQlp
ZiAoaW1wb3J0X2F0dGFjaCkgewotCQlyZXQgPSBkbWFfYnVmX2JlZ2luX2NwdV9hY2Nlc3MoaW1w
b3J0X2F0dGFjaC0+ZG1hYnVmLAotCQkJCQkgICAgICAgRE1BX0ZST01fREVWSUNFKTsKLQkJaWYg
KHJldCkKLQkJCWdvdG8gdW5sb2NrOwotCX0KLQogCWZvciAoaSA9IDA7IGkgPCBudW1fY2xpcHM7
IGkrKykgewogCQlyZXQgPSB1ZGxfaGFuZGxlX2RhbWFnZShmYiwgY2xpcHNbaV0ueDEsIGNsaXBz
W2ldLnkxLAogCQkJCQljbGlwc1tpXS54MiAtIGNsaXBzW2ldLngxLApAQCAtMTkyLDEwICsxOTks
NiBAQCBzdGF0aWMgaW50IHVkbF91c2VyX2ZyYW1lYnVmZmVyX2RpcnR5KHN0cnVjdCBkcm1fZnJh
bWVidWZmZXIgKmZiLAogCQkJYnJlYWs7CiAJfQogCi0JaWYgKGltcG9ydF9hdHRhY2gpCi0JCXJl
dCA9IGRtYV9idWZfZW5kX2NwdV9hY2Nlc3MoaW1wb3J0X2F0dGFjaC0+ZG1hYnVmLAotCQkJCQkg
ICAgIERNQV9GUk9NX0RFVklDRSk7Ci0KICB1bmxvY2s6CiAJZHJtX21vZGVzZXRfdW5sb2NrX2Fs
bChmYi0+ZGV2KTsKIAotLSAKMi4yMy4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9kcmktZGV2ZWw=
