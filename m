Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 8811DA7536
	for <lists+dri-devel@lfdr.de>; Tue,  3 Sep 2019 22:47:55 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 639AC898C4;
	Tue,  3 Sep 2019 20:47:47 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5D2E2898E4;
 Tue,  3 Sep 2019 20:47:43 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id E2184C058CBD;
 Tue,  3 Sep 2019 20:47:42 +0000 (UTC)
Received: from malachite.bss.redhat.com (dhcp-10-20-1-34.bss.redhat.com
 [10.20.1.34])
 by smtp.corp.redhat.com (Postfix) with ESMTP id B48781001956;
 Tue,  3 Sep 2019 20:47:41 +0000 (UTC)
From: Lyude Paul <lyude@redhat.com>
To: dri-devel@lists.freedesktop.org, nouveau@lists.freedesktop.org,
 amd-gfx@lists.freedesktop.org
Subject: [PATCH v2 03/27] drm/dp_mst: Destroy MSTBs asynchronously
Date: Tue,  3 Sep 2019 16:45:41 -0400
Message-Id: <20190903204645.25487-4-lyude@redhat.com>
In-Reply-To: <20190903204645.25487-1-lyude@redhat.com>
References: <20190903204645.25487-1-lyude@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.32]); Tue, 03 Sep 2019 20:47:43 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, Sean Paul <sean@poorly.run>,
 linux-kernel@vger.kernel.org, Maxime Ripard <mripard@kernel.org>,
 Juston Li <juston.li@intel.com>, Harry Wentland <hwentlan@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2hlbiByZXByb2JpbmcgYW4gTVNUIHRvcG9sb2d5IGR1cmluZyByZXN1bWUsIHdlIGhhdmUgdG8g
YWNjb3VudCBmb3IgdGhlCmZhY3QgdGhhdCB3aGlsZSB3ZSB3ZXJlIHN1c3BlbmRlZCBpdCdzIHBv
c3NpYmxlIHRoYXQgbXN0YnMgbWF5IGhhdmUgYmVlbgpyZW1vdmVkIGZyb20gYW55IHBvcnRzIGlu
IHRoZSB0b3BvbG9neS4gU2luY2UgaXRlcmF0aW5nIGRvd253YXJkcyBpbiB0aGUKdG9wb2xvZ3kg
cmVxdWlyZXMgdGhhdCB3ZSBob2xkICZtZ3ItPmxvY2ssIGRlc3Ryb3lpbmcgTVNUQnMgZnJvbSB0
aGlzCmNvbnRleHQgd291bGQgcmVzdWx0IGluIGF0dGVtcHRpbmcgdG8gbG9jayAmbWdyLT5sb2Nr
IGEgc2Vjb25kIHRpbWUgYW5kCmRlYWRsb2NraW5nLgoKU28sIGZpeCB0aGlzIGJ5IGZpcnN0IG1v
dmluZyBkZXN0cnVjdGlvbiBvZiBNU1RCcyBpbnRvCmRlc3Ryb3lfY29ubmVjdG9yX3dvcmssIHRo
ZW4gcmVuYW1lIGRlc3Ryb3lfY29ubmVjdG9yX3dvcmsgYW5kIGZyaWVuZHMKdG8gcmVmbGVjdCB0
aGF0IHRoZXkgbm93IGRlc3Ryb3kgYm90aCBwb3J0cyBhbmQgbXN0YnMuCgpDaGFuZ2VzIHNpbmNl
IHYxOgoqIHMvZGVzdHJveV9jb25uZWN0b3JfbGlzdC9kZXN0cm95X3BvcnRfbGlzdC8KICBzL2Nv
bm5lY3Rvcl9kZXN0cm95X2xvY2svZGVsYXllZF9kZXN0cm95X2xvY2svCiAgcy9jb25uZWN0b3Jf
ZGVzdHJveV93b3JrL2RlbGF5ZWRfZGVzdHJveV93b3JrLwogIHMvZHJtX2RwX2ZpbmlzaF9kZXN0
cm95X2JyYW5jaF9kZXZpY2UvZHJtX2RwX2RlbGF5ZWRfZGVzdHJveV9tc3RiLwogIHMvZHJtX2Rw
X2ZpbmlzaF9kZXN0cm95X3BvcnQvZHJtX2RwX2RlbGF5ZWRfZGVzdHJveV9wb3J0LwogIC0gZGFu
dmV0CiogVXNlIHR3byBsb29wcyBpbiBkcm1fZHBfZGVsYXllZF9kZXN0cm95X3dvcmsoKSAtIGRh
bnZldAoqIEJldHRlciBleHBsYWluIHdoeSB3ZSBuZWVkIHRvIGRvIHRoaXMgLSBkYW52ZXQKKiBV
c2UgY2FuY2VsX3dvcmtfc3luYygpIGluc3RlYWQgb2YgZmx1c2hfd29yaygpIC0gZmx1c2hfd29y
aygpIGRvZXNuJ3QKICBhY2NvdW50IGZvciB3b3JrIHJlcXVlaW5nCgpDYzogSnVzdG9uIExpIDxq
dXN0b24ubGlAaW50ZWwuY29tPgpDYzogSW1yZSBEZWFrIDxpbXJlLmRlYWtAaW50ZWwuY29tPgpD
YzogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4KQ2M6IEhh
cnJ5IFdlbnRsYW5kIDxod2VudGxhbkBhbWQuY29tPgpDYzogRGFuaWVsIFZldHRlciA8ZGFuaWVs
QGZmd2xsLmNoPgpTaWduZWQtb2ZmLWJ5OiBMeXVkZSBQYXVsIDxseXVkZUByZWRoYXQuY29tPgot
LS0KIGRyaXZlcnMvZ3B1L2RybS9kcm1fZHBfbXN0X3RvcG9sb2d5LmMgfCAxNjIgKysrKysrKysr
KysrKysrKystLS0tLS0tLS0KIGluY2x1ZGUvZHJtL2RybV9kcF9tc3RfaGVscGVyLmggICAgICAg
fCAgMjYgKysrLS0KIDIgZmlsZXMgY2hhbmdlZCwgMTI3IGluc2VydGlvbnMoKyksIDYxIGRlbGV0
aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9kcm1fZHBfbXN0X3RvcG9sb2d5
LmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5jCmluZGV4IDMwNTRlYzYy
MjUwNi4uNzM4ZjI2MGQ0YjE1IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2RwX21z
dF90b3BvbG9neS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZHBfbXN0X3RvcG9sb2d5LmMK
QEAgLTExMTMsMzQgKzExMTMsMTcgQEAgc3RhdGljIHZvaWQgZHJtX2RwX2Rlc3Ryb3lfbXN0X2Jy
YW5jaF9kZXZpY2Uoc3RydWN0IGtyZWYgKmtyZWYpCiAJc3RydWN0IGRybV9kcF9tc3RfYnJhbmNo
ICptc3RiID0KIAkJY29udGFpbmVyX29mKGtyZWYsIHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCwg
dG9wb2xvZ3lfa3JlZik7CiAJc3RydWN0IGRybV9kcF9tc3RfdG9wb2xvZ3lfbWdyICptZ3IgPSBt
c3RiLT5tZ3I7Ci0Jc3RydWN0IGRybV9kcF9tc3RfcG9ydCAqcG9ydCwgKnRtcDsKLQlib29sIHdh
a2VfdHggPSBmYWxzZTsKIAotCW11dGV4X2xvY2soJm1nci0+bG9jayk7Ci0JbGlzdF9mb3JfZWFj
aF9lbnRyeV9zYWZlKHBvcnQsIHRtcCwgJm1zdGItPnBvcnRzLCBuZXh0KSB7Ci0JCWxpc3RfZGVs
KCZwb3J0LT5uZXh0KTsKLQkJZHJtX2RwX21zdF90b3BvbG9neV9wdXRfcG9ydChwb3J0KTsKLQl9
Ci0JbXV0ZXhfdW5sb2NrKCZtZ3ItPmxvY2spOwotCi0JLyogZHJvcCBhbnkgdHggc2xvdHMgbXNn
ICovCi0JbXV0ZXhfbG9jaygmbXN0Yi0+bWdyLT5xbG9jayk7Ci0JaWYgKG1zdGItPnR4X3Nsb3Rz
WzBdKSB7Ci0JCW1zdGItPnR4X3Nsb3RzWzBdLT5zdGF0ZSA9IERSTV9EUF9TSURFQkFORF9UWF9U
SU1FT1VUOwotCQltc3RiLT50eF9zbG90c1swXSA9IE5VTEw7Ci0JCXdha2VfdHggPSB0cnVlOwot
CX0KLQlpZiAobXN0Yi0+dHhfc2xvdHNbMV0pIHsKLQkJbXN0Yi0+dHhfc2xvdHNbMV0tPnN0YXRl
ID0gRFJNX0RQX1NJREVCQU5EX1RYX1RJTUVPVVQ7Ci0JCW1zdGItPnR4X3Nsb3RzWzFdID0gTlVM
TDsKLQkJd2FrZV90eCA9IHRydWU7Ci0JfQotCW11dGV4X3VubG9jaygmbXN0Yi0+bWdyLT5xbG9j
ayk7CisJSU5JVF9MSVNUX0hFQUQoJm1zdGItPmRlc3Ryb3lfbmV4dCk7CiAKLQlpZiAod2FrZV90
eCkKLQkJd2FrZV91cF9hbGwoJm1zdGItPm1nci0+dHhfd2FpdHEpOwotCi0JZHJtX2RwX21zdF9w
dXRfbXN0Yl9tYWxsb2MobXN0Yik7CisJLyoKKwkgKiBUaGlzIGNhbiBnZXQgY2FsbGVkIHVuZGVy
IG1nci0+bXV0ZXgsIHNvIHdlIG5lZWQgdG8gcGVyZm9ybSB0aGUKKwkgKiBhY3R1YWwgZGVzdHJ1
Y3Rpb24gb2YgdGhlIG1zdGIgaW4gYW5vdGhlciB3b3JrZXIKKwkgKi8KKwltdXRleF9sb2NrKCZt
Z3ItPmRlbGF5ZWRfZGVzdHJveV9sb2NrKTsKKwlsaXN0X2FkZCgmbXN0Yi0+ZGVzdHJveV9uZXh0
LCAmbWdyLT5kZXN0cm95X2JyYW5jaF9kZXZpY2VfbGlzdCk7CisJbXV0ZXhfdW5sb2NrKCZtZ3It
PmRlbGF5ZWRfZGVzdHJveV9sb2NrKTsKKwlzY2hlZHVsZV93b3JrKCZtZ3ItPmRlbGF5ZWRfZGVz
dHJveV93b3JrKTsKIH0KIAogLyoqCkBAIC0xMjU1LDEwICsxMjM4LDEwIEBAIHN0YXRpYyB2b2lk
IGRybV9kcF9kZXN0cm95X3BvcnQoc3RydWN0IGtyZWYgKmtyZWYpCiAJCQkgKiB3ZSBtaWdodCBi
ZSBob2xkaW5nIHRoZSBtb2RlX2NvbmZpZy5tdXRleAogCQkJICogZnJvbSBhbiBFRElEIHJldHJp
ZXZhbCAqLwogCi0JCQltdXRleF9sb2NrKCZtZ3ItPmRlc3Ryb3lfY29ubmVjdG9yX2xvY2spOwot
CQkJbGlzdF9hZGQoJnBvcnQtPm5leHQsICZtZ3ItPmRlc3Ryb3lfY29ubmVjdG9yX2xpc3QpOwot
CQkJbXV0ZXhfdW5sb2NrKCZtZ3ItPmRlc3Ryb3lfY29ubmVjdG9yX2xvY2spOwotCQkJc2NoZWR1
bGVfd29yaygmbWdyLT5kZXN0cm95X2Nvbm5lY3Rvcl93b3JrKTsKKwkJCW11dGV4X2xvY2soJm1n
ci0+ZGVsYXllZF9kZXN0cm95X2xvY2spOworCQkJbGlzdF9hZGQoJnBvcnQtPm5leHQsICZtZ3It
PmRlc3Ryb3lfcG9ydF9saXN0KTsKKwkJCW11dGV4X3VubG9jaygmbWdyLT5kZWxheWVkX2Rlc3Ry
b3lfbG9jayk7CisJCQlzY2hlZHVsZV93b3JrKCZtZ3ItPmRlbGF5ZWRfZGVzdHJveV93b3JrKTsK
IAkJCXJldHVybjsKIAkJfQogCQkvKiBubyBuZWVkIHRvIGNsZWFuIHVwIHZjcGkKQEAgLTI3OTIs
NyArMjc3NSw3IEBAIHZvaWQgZHJtX2RwX21zdF90b3BvbG9neV9tZ3Jfc3VzcGVuZChzdHJ1Y3Qg
ZHJtX2RwX21zdF90b3BvbG9neV9tZ3IgKm1ncikKIAkJCSAgIERQX01TVF9FTiB8IERQX1VQU1RS
RUFNX0lTX1NSQyk7CiAJbXV0ZXhfdW5sb2NrKCZtZ3ItPmxvY2spOwogCWZsdXNoX3dvcmsoJm1n
ci0+d29yayk7Ci0JZmx1c2hfd29yaygmbWdyLT5kZXN0cm95X2Nvbm5lY3Rvcl93b3JrKTsKKwlm
bHVzaF93b3JrKCZtZ3ItPmRlbGF5ZWRfZGVzdHJveV93b3JrKTsKIH0KIEVYUE9SVF9TWU1CT0wo
ZHJtX2RwX21zdF90b3BvbG9neV9tZ3Jfc3VzcGVuZCk7CiAKQEAgLTM3NDAsMzQgKzM3MjMsMTA0
IEBAIHN0YXRpYyB2b2lkIGRybV9kcF90eF93b3JrKHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykK
IAltdXRleF91bmxvY2soJm1nci0+cWxvY2spOwogfQogCi1zdGF0aWMgdm9pZCBkcm1fZHBfZGVz
dHJveV9jb25uZWN0b3Jfd29yayhzdHJ1Y3Qgd29ya19zdHJ1Y3QgKndvcmspCitzdGF0aWMgaW5s
aW5lIHZvaWQKK2RybV9kcF9kZWxheWVkX2Rlc3Ryb3lfcG9ydChzdHJ1Y3QgZHJtX2RwX21zdF9w
b3J0ICpwb3J0KQogewotCXN0cnVjdCBkcm1fZHBfbXN0X3RvcG9sb2d5X21nciAqbWdyID0gY29u
dGFpbmVyX29mKHdvcmssIHN0cnVjdCBkcm1fZHBfbXN0X3RvcG9sb2d5X21nciwgZGVzdHJveV9j
b25uZWN0b3Jfd29yayk7Ci0Jc3RydWN0IGRybV9kcF9tc3RfcG9ydCAqcG9ydDsKLQlib29sIHNl
bmRfaG90cGx1ZyA9IGZhbHNlOworCXBvcnQtPm1nci0+Y2JzLT5kZXN0cm95X2Nvbm5lY3Rvcihw
b3J0LT5tZ3IsIHBvcnQtPmNvbm5lY3Rvcik7CisKKwlkcm1fZHBfcG9ydF90ZWFyZG93bl9wZHQo
cG9ydCwgcG9ydC0+cGR0KTsKKwlwb3J0LT5wZHQgPSBEUF9QRUVSX0RFVklDRV9OT05FOworCisJ
ZHJtX2RwX21zdF9wdXRfcG9ydF9tYWxsb2MocG9ydCk7Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9p
ZAorZHJtX2RwX2RlbGF5ZWRfZGVzdHJveV9tc3RiKHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAq
bXN0YikKK3sKKwlzdHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3IgKm1nciA9IG1zdGItPm1n
cjsKKwlzdHJ1Y3QgZHJtX2RwX21zdF9wb3J0ICpwb3J0LCAqdG1wOworCWJvb2wgd2FrZV90eCA9
IGZhbHNlOworCisJbXV0ZXhfbG9jaygmbWdyLT5sb2NrKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5
X3NhZmUocG9ydCwgdG1wLCAmbXN0Yi0+cG9ydHMsIG5leHQpIHsKKwkJbGlzdF9kZWwoJnBvcnQt
Pm5leHQpOworCQlkcm1fZHBfbXN0X3RvcG9sb2d5X3B1dF9wb3J0KHBvcnQpOworCX0KKwltdXRl
eF91bmxvY2soJm1nci0+bG9jayk7CisKKwkvKiBkcm9wIGFueSB0eCBzbG90cyBtc2cgKi8KKwlt
dXRleF9sb2NrKCZtc3RiLT5tZ3ItPnFsb2NrKTsKKwlpZiAobXN0Yi0+dHhfc2xvdHNbMF0pIHsK
KwkJbXN0Yi0+dHhfc2xvdHNbMF0tPnN0YXRlID0gRFJNX0RQX1NJREVCQU5EX1RYX1RJTUVPVVQ7
CisJCW1zdGItPnR4X3Nsb3RzWzBdID0gTlVMTDsKKwkJd2FrZV90eCA9IHRydWU7CisJfQorCWlm
IChtc3RiLT50eF9zbG90c1sxXSkgeworCQltc3RiLT50eF9zbG90c1sxXS0+c3RhdGUgPSBEUk1f
RFBfU0lERUJBTkRfVFhfVElNRU9VVDsKKwkJbXN0Yi0+dHhfc2xvdHNbMV0gPSBOVUxMOworCQl3
YWtlX3R4ID0gdHJ1ZTsKKwl9CisJbXV0ZXhfdW5sb2NrKCZtc3RiLT5tZ3ItPnFsb2NrKTsKKwor
CWlmICh3YWtlX3R4KQorCQl3YWtlX3VwX2FsbCgmbXN0Yi0+bWdyLT50eF93YWl0cSk7CisKKwlk
cm1fZHBfbXN0X3B1dF9tc3RiX21hbGxvYyhtc3RiKTsKK30KKworc3RhdGljIHZvaWQgZHJtX2Rw
X2RlbGF5ZWRfZGVzdHJveV93b3JrKHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykKK3sKKwlzdHJ1
Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3IgKm1nciA9CisJCWNvbnRhaW5lcl9vZih3b3JrLCBz
dHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3IsCisJCQkgICAgIGRlbGF5ZWRfZGVzdHJveV93
b3JrKTsKKwlib29sIHNlbmRfaG90cGx1ZyA9IGZhbHNlLCBnb19hZ2FpbjsKKwogCS8qCiAJICog
Tm90IGEgcmVndWxhciBsaXN0IHRyYXZlcnNlIGFzIHdlIGhhdmUgdG8gZHJvcCB0aGUgZGVzdHJv
eQotCSAqIGNvbm5lY3RvciBsb2NrIGJlZm9yZSBkZXN0cm95aW5nIHRoZSBjb25uZWN0b3IsIHRv
IGF2b2lkIEFCLT5CQQorCSAqIGNvbm5lY3RvciBsb2NrIGJlZm9yZSBkZXN0cm95aW5nIHRoZSBt
c3RiL3BvcnQsIHRvIGF2b2lkIEFCLT5CQQogCSAqIG9yZGVyaW5nIGJldHdlZW4gdGhpcyBsb2Nr
IGFuZCB0aGUgY29uZmlnIG11dGV4LgogCSAqLwotCWZvciAoOzspIHsKLQkJbXV0ZXhfbG9jaygm
bWdyLT5kZXN0cm95X2Nvbm5lY3Rvcl9sb2NrKTsKLQkJcG9ydCA9IGxpc3RfZmlyc3RfZW50cnlf
b3JfbnVsbCgmbWdyLT5kZXN0cm95X2Nvbm5lY3Rvcl9saXN0LCBzdHJ1Y3QgZHJtX2RwX21zdF9w
b3J0LCBuZXh0KTsKLQkJaWYgKCFwb3J0KSB7Ci0JCQltdXRleF91bmxvY2soJm1nci0+ZGVzdHJv
eV9jb25uZWN0b3JfbG9jayk7Ci0JCQlicmVhazsKKwlkbyB7CisJCWdvX2FnYWluID0gZmFsc2U7
CisKKwkJZm9yICg7OykgeworCQkJc3RydWN0IGRybV9kcF9tc3RfYnJhbmNoICptc3RiOworCisJ
CQltdXRleF9sb2NrKCZtZ3ItPmRlbGF5ZWRfZGVzdHJveV9sb2NrKTsKKwkJCW1zdGIgPSBsaXN0
X2ZpcnN0X2VudHJ5X29yX251bGwoJm1nci0+ZGVzdHJveV9icmFuY2hfZGV2aWNlX2xpc3QsCisJ
CQkJCQkJc3RydWN0IGRybV9kcF9tc3RfYnJhbmNoLAorCQkJCQkJCWRlc3Ryb3lfbmV4dCk7CisJ
CQlpZiAobXN0YikKKwkJCQlsaXN0X2RlbCgmbXN0Yi0+ZGVzdHJveV9uZXh0KTsKKwkJCW11dGV4
X3VubG9jaygmbWdyLT5kZWxheWVkX2Rlc3Ryb3lfbG9jayk7CisKKwkJCWlmICghbXN0YikKKwkJ
CQlicmVhazsKKworCQkJZHJtX2RwX2RlbGF5ZWRfZGVzdHJveV9tc3RiKG1zdGIpOworCQkJZ29f
YWdhaW4gPSB0cnVlOwogCQl9Ci0JCWxpc3RfZGVsKCZwb3J0LT5uZXh0KTsKLQkJbXV0ZXhfdW5s
b2NrKCZtZ3ItPmRlc3Ryb3lfY29ubmVjdG9yX2xvY2spOwogCi0JCW1nci0+Y2JzLT5kZXN0cm95
X2Nvbm5lY3RvcihtZ3IsIHBvcnQtPmNvbm5lY3Rvcik7CisJCWZvciAoOzspIHsKKwkJCXN0cnVj
dCBkcm1fZHBfbXN0X3BvcnQgKnBvcnQ7CiAKLQkJZHJtX2RwX3BvcnRfdGVhcmRvd25fcGR0KHBv
cnQsIHBvcnQtPnBkdCk7Ci0JCXBvcnQtPnBkdCA9IERQX1BFRVJfREVWSUNFX05PTkU7CisJCQlt
dXRleF9sb2NrKCZtZ3ItPmRlbGF5ZWRfZGVzdHJveV9sb2NrKTsKKwkJCXBvcnQgPSBsaXN0X2Zp
cnN0X2VudHJ5X29yX251bGwoJm1nci0+ZGVzdHJveV9wb3J0X2xpc3QsCisJCQkJCQkJc3RydWN0
IGRybV9kcF9tc3RfcG9ydCwKKwkJCQkJCQluZXh0KTsKKwkJCWlmIChwb3J0KQorCQkJCWxpc3Rf
ZGVsKCZwb3J0LT5uZXh0KTsKKwkJCW11dGV4X3VubG9jaygmbWdyLT5kZWxheWVkX2Rlc3Ryb3lf
bG9jayk7CisKKwkJCWlmICghcG9ydCkKKwkJCQlicmVhazsKKworCQkJZHJtX2RwX2RlbGF5ZWRf
ZGVzdHJveV9wb3J0KHBvcnQpOworCQkJc2VuZF9ob3RwbHVnID0gdHJ1ZTsKKwkJCWdvX2FnYWlu
ID0gdHJ1ZTsKKwkJfQorCX0gd2hpbGUgKGdvX2FnYWluKTsKIAotCQlkcm1fZHBfbXN0X3B1dF9w
b3J0X21hbGxvYyhwb3J0KTsKLQkJc2VuZF9ob3RwbHVnID0gdHJ1ZTsKLQl9CiAJaWYgKHNlbmRf
aG90cGx1ZykKIAkJZHJtX2ttc19oZWxwZXJfaG90cGx1Z19ldmVudChtZ3ItPmRldik7CiB9CkBA
IC0zOTU3LDEyICs0MDEwLDEzIEBAIGludCBkcm1fZHBfbXN0X3RvcG9sb2d5X21ncl9pbml0KHN0
cnVjdCBkcm1fZHBfbXN0X3RvcG9sb2d5X21nciAqbWdyLAogCW11dGV4X2luaXQoJm1nci0+bG9j
ayk7CiAJbXV0ZXhfaW5pdCgmbWdyLT5xbG9jayk7CiAJbXV0ZXhfaW5pdCgmbWdyLT5wYXlsb2Fk
X2xvY2spOwotCW11dGV4X2luaXQoJm1nci0+ZGVzdHJveV9jb25uZWN0b3JfbG9jayk7CisJbXV0
ZXhfaW5pdCgmbWdyLT5kZWxheWVkX2Rlc3Ryb3lfbG9jayk7CiAJSU5JVF9MSVNUX0hFQUQoJm1n
ci0+dHhfbXNnX2Rvd25xKTsKLQlJTklUX0xJU1RfSEVBRCgmbWdyLT5kZXN0cm95X2Nvbm5lY3Rv
cl9saXN0KTsKKwlJTklUX0xJU1RfSEVBRCgmbWdyLT5kZXN0cm95X3BvcnRfbGlzdCk7CisJSU5J
VF9MSVNUX0hFQUQoJm1nci0+ZGVzdHJveV9icmFuY2hfZGV2aWNlX2xpc3QpOwogCUlOSVRfV09S
SygmbWdyLT53b3JrLCBkcm1fZHBfbXN0X2xpbmtfcHJvYmVfd29yayk7CiAJSU5JVF9XT1JLKCZt
Z3ItPnR4X3dvcmssIGRybV9kcF90eF93b3JrKTsKLQlJTklUX1dPUksoJm1nci0+ZGVzdHJveV9j
b25uZWN0b3Jfd29yaywgZHJtX2RwX2Rlc3Ryb3lfY29ubmVjdG9yX3dvcmspOworCUlOSVRfV09S
SygmbWdyLT5kZWxheWVkX2Rlc3Ryb3lfd29yaywgZHJtX2RwX2RlbGF5ZWRfZGVzdHJveV93b3Jr
KTsKIAlpbml0X3dhaXRxdWV1ZV9oZWFkKCZtZ3ItPnR4X3dhaXRxKTsKIAltZ3ItPmRldiA9IGRl
djsKIAltZ3ItPmF1eCA9IGF1eDsKQEAgLTQwMDUsNyArNDA1OSw3IEBAIHZvaWQgZHJtX2RwX21z
dF90b3BvbG9neV9tZ3JfZGVzdHJveShzdHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3IgKm1n
cikKIHsKIAlkcm1fZHBfbXN0X3RvcG9sb2d5X21ncl9zZXRfbXN0KG1nciwgZmFsc2UpOwogCWZs
dXNoX3dvcmsoJm1nci0+d29yayk7Ci0JZmx1c2hfd29yaygmbWdyLT5kZXN0cm95X2Nvbm5lY3Rv
cl93b3JrKTsKKwljYW5jZWxfd29ya19zeW5jKCZtZ3ItPmRlbGF5ZWRfZGVzdHJveV93b3JrKTsK
IAltdXRleF9sb2NrKCZtZ3ItPnBheWxvYWRfbG9jayk7CiAJa2ZyZWUobWdyLT5wYXlsb2Fkcyk7
CiAJbWdyLT5wYXlsb2FkcyA9IE5VTEw7CmRpZmYgLS1naXQgYS9pbmNsdWRlL2RybS9kcm1fZHBf
bXN0X2hlbHBlci5oIGIvaW5jbHVkZS9kcm0vZHJtX2RwX21zdF9oZWxwZXIuaAppbmRleCBmYzM0
OTIwNGE3MWIuLjRhNDUwN2ZlOTI4ZCAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vZHJtX2RwX21z
dF9oZWxwZXIuaAorKysgYi9pbmNsdWRlL2RybS9kcm1fZHBfbXN0X2hlbHBlci5oCkBAIC0xNDMs
NiArMTQzLDEyIEBAIHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCB7CiAJICovCiAJc3RydWN0IGty
ZWYgbWFsbG9jX2tyZWY7CiAKKwkvKioKKwkgKiBAZGVzdHJveV9uZXh0OiBsaW5rZWQtbGlzdCBl
bnRyeSB1c2VkIGJ5CisJICogZHJtX2RwX2RlbGF5ZWRfZGVzdHJveV93b3JrKCkKKwkgKi8KKwlz
dHJ1Y3QgbGlzdF9oZWFkIGRlc3Ryb3lfbmV4dDsKKwogCXU4IHJhZFs4XTsKIAl1OCBsY3Q7CiAJ
aW50IG51bV9wb3J0czsKQEAgLTU3NSwxOCArNTgxLDI0IEBAIHN0cnVjdCBkcm1fZHBfbXN0X3Rv
cG9sb2d5X21nciB7CiAJc3RydWN0IHdvcmtfc3RydWN0IHR4X3dvcms7CiAKIAkvKioKLQkgKiBA
ZGVzdHJveV9jb25uZWN0b3JfbGlzdDogTGlzdCBvZiB0byBiZSBkZXN0cm95ZWQgY29ubmVjdG9y
cy4KKwkgKiBAZGVzdHJveV9wb3J0X2xpc3Q6IExpc3Qgb2YgdG8gYmUgZGVzdHJveWVkIGNvbm5l
Y3RvcnMuCisJICovCisJc3RydWN0IGxpc3RfaGVhZCBkZXN0cm95X3BvcnRfbGlzdDsKKwkvKioK
KwkgKiBAZGVzdHJveV9icmFuY2hfZGV2aWNlX2xpc3Q6IExpc3Qgb2YgdG8gYmUgZGVzdHJveWVk
IGJyYW5jaAorCSAqIGRldmljZXMuCiAJICovCi0Jc3RydWN0IGxpc3RfaGVhZCBkZXN0cm95X2Nv
bm5lY3Rvcl9saXN0OworCXN0cnVjdCBsaXN0X2hlYWQgZGVzdHJveV9icmFuY2hfZGV2aWNlX2xp
c3Q7CiAJLyoqCi0JICogQGRlc3Ryb3lfY29ubmVjdG9yX2xvY2s6IFByb3RlY3RzIEBjb25uZWN0
b3JfbGlzdC4KKwkgKiBAZGVsYXllZF9kZXN0cm95X2xvY2s6IFByb3RlY3RzIEBkZXN0cm95X3Bv
cnRfbGlzdCBhbmQKKwkgKiBAZGVzdHJveV9icmFuY2hfZGV2aWNlX2xpc3QuCiAJICovCi0Jc3Ry
dWN0IG11dGV4IGRlc3Ryb3lfY29ubmVjdG9yX2xvY2s7CisJc3RydWN0IG11dGV4IGRlbGF5ZWRf
ZGVzdHJveV9sb2NrOwogCS8qKgotCSAqIEBkZXN0cm95X2Nvbm5lY3Rvcl93b3JrOiBXb3JrIGl0
ZW0gdG8gZGVzdHJveSBjb25uZWN0b3JzLiBOZWVkZWQgdG8KLQkgKiBhdm9pZCBsb2NraW5nIGlu
dmVyc2lvbi4KKwkgKiBAZGVsYXllZF9kZXN0cm95X3dvcms6IFdvcmsgaXRlbSB0byBkZXN0cm95
IE1TVCBwb3J0IGFuZCBicmFuY2gKKwkgKiBkZXZpY2VzLCBuZWVkZWQgdG8gYXZvaWQgbG9ja2lu
ZyBpbnZlcnNpb24uCiAJICovCi0Jc3RydWN0IHdvcmtfc3RydWN0IGRlc3Ryb3lfY29ubmVjdG9y
X3dvcms7CisJc3RydWN0IHdvcmtfc3RydWN0IGRlbGF5ZWRfZGVzdHJveV93b3JrOwogfTsKIAog
aW50IGRybV9kcF9tc3RfdG9wb2xvZ3lfbWdyX2luaXQoc3RydWN0IGRybV9kcF9tc3RfdG9wb2xv
Z3lfbWdyICptZ3IsCi0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2RyaS1kZXZlbA==
