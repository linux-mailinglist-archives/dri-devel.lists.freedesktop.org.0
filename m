Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id F114E11D6A8
	for <lists+dri-devel@lfdr.de>; Thu, 12 Dec 2019 20:03:00 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B40556E139;
	Thu, 12 Dec 2019 19:02:43 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-yb1-xb41.google.com (mail-yb1-xb41.google.com
 [IPv6:2607:f8b0:4864:20::b41])
 by gabe.freedesktop.org (Postfix) with ESMTPS id CD40B6E122
 for <dri-devel@lists.freedesktop.org>; Thu, 12 Dec 2019 19:02:40 +0000 (UTC)
Received: by mail-yb1-xb41.google.com with SMTP id d34so877810yba.10
 for <dri-devel@lists.freedesktop.org>; Thu, 12 Dec 2019 11:02:40 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=poorly.run; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=B59JiOsuU+6Z9/Pg9GVc8XuLtqDK4voDlfHRSDfUne4=;
 b=PAWNwMTIuHWEgDR9kTy+FpwsTSz1dIB/KVdDITxkWFUyHgSe27uSFGSjE3bcxFZyM5
 bA8qomdYKlt53zjA/P/oVyXDCbdQdtWOwY8Afnwh6UC+0989Lrg2O9XGunDr2MrGoZYF
 mbWDyXV1Swcd56EppeOUWifS823bcag1EUjdXcQxJ9WcOnpq1RLTyKS8efVTjHXMKxQ2
 yS54bcRs9Q1pQcTlyuQPsX4zf98RU4ia9ytUV/QupJHwk91FtVUBMpsz/niEBL5azNcr
 CvMPFR3q+TPaL7hH66mSGNoOYClRr8XqUC2rxv67rMerll+ZGfsTPW2TlSlQYYJ8zX33
 QMog==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=B59JiOsuU+6Z9/Pg9GVc8XuLtqDK4voDlfHRSDfUne4=;
 b=PAr8AcWsPXk0Jpk2JuFsn5AHhPa2uFO9EmBUCH/0ez7sBIULAq7yCXcqDJ4mIIs4pQ
 UD9BvRNK+XooLUCsgRn4I9Cgw4C/0mgNS+yYSQNRoHtPcHT7oxXRNRU+jwPU7Wom8DpR
 tK3KVq6Wi6KgJfXoJmKO+2g3bbLRNOBQLXeAAPz9GZzmmQZ1j323ve0pmt9s0krKf94f
 gR1iPRB2hRSSIGsQ+ctSvYHDI8mwHERYrMgEsySYaVDvgRdbOx7basLJ68r8voJTXn/H
 5NfBofcv+Mw9Srk8lEsGWvytRCn3lopdntZqG57n5ntLKt45RGGfdsoh2A+rUqnpkphh
 gxmA==
X-Gm-Message-State: APjAAAWq/Oe8hXTKw7dj0f5J/1tcXtKi2whUZ55hZjdNywV5UJ8Vwj58
 b78Z6xAvrK0SDYoR5tPiIQZPKi5zxEkfhQ==
X-Google-Smtp-Source: APXvYqw4gMcurZfgmKLdAoD2CYqI2lbNOMsl4PqpvVHdq0QKzC0/RGibuprwEIOIMDSfJJpRFowhhg==
X-Received: by 2002:a25:7c45:: with SMTP id x66mr5034770ybc.297.1576177359525; 
 Thu, 12 Dec 2019 11:02:39 -0800 (PST)
Received: from localhost ([2620:0:1013:11:1e1:4760:6ce4:fc64])
 by smtp.gmail.com with ESMTPSA id v38sm2618704ywh.63.2019.12.12.11.02.38
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Thu, 12 Dec 2019 11:02:39 -0800 (PST)
From: Sean Paul <sean@poorly.run>
To: dri-devel@lists.freedesktop.org,
	intel-gfx@lists.freedesktop.org
Subject: [PATCH v2 04/12] drm/i915: Intercept Aksv writes in the aux hooks
Date: Thu, 12 Dec 2019 14:02:22 -0500
Message-Id: <20191212190230.188505-5-sean@poorly.run>
X-Mailer: git-send-email 2.24.1.735.g03f4e72817-goog
In-Reply-To: <20191212190230.188505-1-sean@poorly.run>
References: <20191212190230.188505-1-sean@poorly.run>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: daniel.vetter@ffwll.ch, rodrigo.vivi@intel.com,
 Sean Paul <seanpaul@chromium.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogU2VhbiBQYXVsIDxzZWFucGF1bEBjaHJvbWl1bS5vcmc+CgpJbnN0ZWFkIG9mIGhhbmQg
cm9sbGluZyB0aGUgdHJhbnNmZXIgb3Vyc2VsdmVzIGluIHRoZSBoZGNwIGhvb2ssIGluc3BlY3QK
YXV4IG1lc3NhZ2VzIGFuZCBhZGQgdGhlIGFrc3YgZmxhZyBpbiB0aGUgYXV4IHRyYW5zZmVyIGhv
b2suCgpJSVJDLCB0aGlzIHdhcyB0aGUgb3JpZ2luYWwgaW1wbGVtZW50YXRpb24gYW5kIGZvbGtz
IHdhbnRlZCB0aGlzIGhhY2sgdG8KYmUgaXNvbGF0ZWQgdG8gdGhlIGhkY3AgY29kZSwgd2hpY2gg
bWFrZXMgc2Vuc2UuCgpIb3dldmVyIGluIHRlc3RpbmcgYW4gTEcgbW9uaXRvciBvbiBteSBkZXNr
LCBJIG5vdGljZWQgaXQgd2FzIHBhc3NpbmcKYmFjayBhIERFRkVSIHJlcGx5LiBUaGlzIHdhc24n
dCBoYW5kbGVkIGluIG91ciBoYW5kLXJvbGxlZCBjb2RlIGFuZCBIRENQCmF1dGggd2FzIGZhaWxp
bmcgYXMgYSByZXN1bHQuIEluc3RlYWQgb2YgY29weS9wYXN0aW5nIGFsbCBvZiB0aGUgcmV0cnkK
bG9naWMgYW5kIGRlbGF5cyBmcm9tIGRybSBkcCBoZWxwZXJzLCBsZXQncyBqdXN0IHVzZSB0aGUg
aGVscGVycyBhbmQgaGlkZQp0aGUgYWtzdiBzZWxlY3QgYXMgYmVzdCBhcyB3ZSBjYW4uCgpSZXZp
ZXdlZC1ieTogVmlsbGUgU3lyasOkbMOkIDx2aWxsZS5zeXJqYWxhQGxpbnV4LmludGVsLmNvbT4K
U2lnbmVkLW9mZi1ieTogU2VhbiBQYXVsIDxzZWFucGF1bEBjaHJvbWl1bS5vcmc+Ckxpbms6IGh0
dHBzOi8vcGF0Y2h3b3JrLmZyZWVkZXNrdG9wLm9yZy9wYXRjaC9tc2dpZC8yMDE5MTIwMzE3MzYz
OC45NDkxOS0zLXNlYW5AcG9vcmx5LnJ1biAjdjEKCkNoYW5nZXMgaW4gdjI6Ci1SZW1vdmUgJ2dl
bmVyYXRlJyBpbiBpbnRlbF9kcF9hdXhfZ2VuZXJhdGVfeGZlcl9mbGFncywgbWFrZSBhcmcgY29u
c3QgKFZpbGxlKQotQnVuZGxlIEFrc3YgaWYgc3RhdGVtZW50IHRvZ2V0aGVyIChWaWxsZSkKLVJl
bmFtZSAndHhidWYnIHRvICdha3N2JyAoVmlsbGUpCi0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUv
ZGlzcGxheS9pbnRlbF9kcC5jIHwgNjIgKysrKysrKysrKysrLS0tLS0tLS0tLS0tLQogMSBmaWxl
IGNoYW5nZWQsIDI5IGluc2VydGlvbnMoKyksIDMzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBh
L2RyaXZlcnMvZ3B1L2RybS9pOTE1L2Rpc3BsYXkvaW50ZWxfZHAuYyBiL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2Rpc3BsYXkvaW50ZWxfZHAuYwppbmRleCBmZTMxYmJmZDZjNjIuLjU1NzYxOTNiNGZl
ZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kcC5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2Rpc3BsYXkvaW50ZWxfZHAuYwpAQCAtMTUxNSwxMiAr
MTUxNSwyNyBAQCBpbnRlbF9kcF9hdXhfaGVhZGVyKHU4IHR4YnVmW0hFQURFUl9TSVpFXSwKIAl0
eGJ1ZlszXSA9IG1zZy0+c2l6ZSAtIDE7CiB9CiAKK3N0YXRpYyB1MzIgaW50ZWxfZHBfYXV4X3hm
ZXJfZmxhZ3MoY29uc3Qgc3RydWN0IGRybV9kcF9hdXhfbXNnICptc2cpCit7CisJLyoKKwkgKiBJ
ZiB3ZSdyZSB0cnlpbmcgdG8gc2VuZCB0aGUgSERDUCBBa3N2LCB3ZSBuZWVkIHRvIHNldCBhIHRo
ZSBBa3N2CisJICogc2VsZWN0IGJpdCB0byBpbmZvcm0gdGhlIGhhcmR3YXJlIHRvIHNlbmQgdGhl
IEFrc3YgYWZ0ZXIgb3VyIGhlYWRlcgorCSAqIHNpbmNlIHdlIGNhbid0IGFjY2VzcyB0aGF0IGRh
dGEgZnJvbSBzb2Z0d2FyZS4KKwkgKi8KKwlpZiAoKG1zZy0+cmVxdWVzdCAmIH5EUF9BVVhfSTJD
X01PVCkgPT0gRFBfQVVYX05BVElWRV9XUklURSAmJgorCSAgICBtc2ctPmFkZHJlc3MgPT0gRFBf
QVVYX0hEQ1BfQUtTVikKKwkJcmV0dXJuIERQX0FVWF9DSF9DVExfQVVYX0FLU1ZfU0VMRUNUOwor
CisJcmV0dXJuIDA7Cit9CisKIHN0YXRpYyBzc2l6ZV90CiBpbnRlbF9kcF9hdXhfdHJhbnNmZXIo
c3RydWN0IGRybV9kcF9hdXggKmF1eCwgc3RydWN0IGRybV9kcF9hdXhfbXNnICptc2cpCiB7CiAJ
c3RydWN0IGludGVsX2RwICppbnRlbF9kcCA9IGNvbnRhaW5lcl9vZihhdXgsIHN0cnVjdCBpbnRl
bF9kcCwgYXV4KTsKIAl1OCB0eGJ1ZlsyMF0sIHJ4YnVmWzIwXTsKIAlzaXplX3QgdHhzaXplLCBy
eHNpemU7CisJdTMyIGZsYWdzID0gaW50ZWxfZHBfYXV4X3hmZXJfZmxhZ3MobXNnKTsKIAlpbnQg
cmV0OwogCiAJaW50ZWxfZHBfYXV4X2hlYWRlcih0eGJ1ZiwgbXNnKTsKQEAgLTE1NDEsNyArMTU1
Niw3IEBAIGludGVsX2RwX2F1eF90cmFuc2ZlcihzdHJ1Y3QgZHJtX2RwX2F1eCAqYXV4LCBzdHJ1
Y3QgZHJtX2RwX2F1eF9tc2cgKm1zZykKIAkJCW1lbWNweSh0eGJ1ZiArIEhFQURFUl9TSVpFLCBt
c2ctPmJ1ZmZlciwgbXNnLT5zaXplKTsKIAogCQlyZXQgPSBpbnRlbF9kcF9hdXhfeGZlcihpbnRl
bF9kcCwgdHhidWYsIHR4c2l6ZSwKLQkJCQkJcnhidWYsIHJ4c2l6ZSwgMCk7CisJCQkJCXJ4YnVm
LCByeHNpemUsIGZsYWdzKTsKIAkJaWYgKHJldCA+IDApIHsKIAkJCW1zZy0+cmVwbHkgPSByeGJ1
ZlswXSA+PiA0OwogCkBAIC0xNTY0LDcgKzE1NzksNyBAQCBpbnRlbF9kcF9hdXhfdHJhbnNmZXIo
c3RydWN0IGRybV9kcF9hdXggKmF1eCwgc3RydWN0IGRybV9kcF9hdXhfbXNnICptc2cpCiAJCQly
ZXR1cm4gLUUyQklHOwogCiAJCXJldCA9IGludGVsX2RwX2F1eF94ZmVyKGludGVsX2RwLCB0eGJ1
ZiwgdHhzaXplLAotCQkJCQlyeGJ1ZiwgcnhzaXplLCAwKTsKKwkJCQkJcnhidWYsIHJ4c2l6ZSwg
ZmxhZ3MpOwogCQlpZiAocmV0ID4gMCkgewogCQkJbXNnLT5yZXBseSA9IHJ4YnVmWzBdID4+IDQ7
CiAJCQkvKgpAQCAtNTkwNCwxNyArNTkxOSw5IEBAIHN0YXRpYwogaW50IGludGVsX2RwX2hkY3Bf
d3JpdGVfYW5fYWtzdihzdHJ1Y3QgaW50ZWxfZGlnaXRhbF9wb3J0ICppbnRlbF9kaWdfcG9ydCwK
IAkJCQl1OCAqYW4pCiB7Ci0Jc3RydWN0IGludGVsX2RwICppbnRlbF9kcCA9IGVuY190b19pbnRl
bF9kcCgmaW50ZWxfZGlnX3BvcnQtPmJhc2UuYmFzZSk7Ci0Jc3RhdGljIGNvbnN0IHN0cnVjdCBk
cm1fZHBfYXV4X21zZyBtc2cgPSB7Ci0JCS5yZXF1ZXN0ID0gRFBfQVVYX05BVElWRV9XUklURSwK
LQkJLmFkZHJlc3MgPSBEUF9BVVhfSERDUF9BS1NWLAotCQkuc2l6ZSA9IERSTV9IRENQX0tTVl9M
RU4sCi0JfTsKLQl1OCB0eGJ1ZltIRUFERVJfU0laRSArIERSTV9IRENQX0tTVl9MRU5dID0ge30s
IHJ4YnVmWzJdLCByZXBseSA9IDA7CisJdTggYWtzdltEUk1fSERDUF9LU1ZfTEVOXSA9IHt9Owog
CXNzaXplX3QgZHBjZF9yZXQ7Ci0JaW50IHJldDsKIAotCS8qIE91dHB1dCBBbiBmaXJzdCwgdGhh
dCdzIGVhc3kgKi8KIAlkcGNkX3JldCA9IGRybV9kcF9kcGNkX3dyaXRlKCZpbnRlbF9kaWdfcG9y
dC0+ZHAuYXV4LCBEUF9BVVhfSERDUF9BTiwKIAkJCQkgICAgIGFuLCBEUk1fSERDUF9BTl9MRU4p
OwogCWlmIChkcGNkX3JldCAhPSBEUk1fSERDUF9BTl9MRU4pIHsKQEAgLTU5MjQsMjkgKzU5MzEs
MTggQEAgaW50IGludGVsX2RwX2hkY3Bfd3JpdGVfYW5fYWtzdihzdHJ1Y3QgaW50ZWxfZGlnaXRh
bF9wb3J0ICppbnRlbF9kaWdfcG9ydCwKIAl9CiAKIAkvKgotCSAqIFNpbmNlIEFrc3YgaXMgT2gt
U28tU2VjcmV0LCB3ZSBjYW4ndCBhY2Nlc3MgaXQgaW4gc29mdHdhcmUuIFNvIGluCi0JICogb3Jk
ZXIgdG8gZ2V0IGl0IG9uIHRoZSB3aXJlLCB3ZSBuZWVkIHRvIGNyZWF0ZSB0aGUgQVVYIGhlYWRl
ciBhcyBpZgotCSAqIHdlIHdlcmUgd3JpdGluZyB0aGUgZGF0YSwgYW5kIHRoZW4gdGlja2xlIHRo
ZSBoYXJkd2FyZSB0byBvdXRwdXQgdGhlCi0JICogZGF0YSBvbmNlIHRoZSBoZWFkZXIgaXMgc2Vu
dCBvdXQuCisJICogU2luY2UgQWtzdiBpcyBPaC1Tby1TZWNyZXQsIHdlIGNhbid0IGFjY2VzcyBp
dCBpbiBzb2Z0d2FyZS4gU28gd2UKKwkgKiBzZW5kIGFuIGVtcHR5IGJ1ZmZlciBvZiB0aGUgY29y
cmVjdCBsZW5ndGggdGhyb3VnaCB0aGUgRFAgaGVscGVycy4gT24KKwkgKiB0aGUgb3RoZXIgc2lk
ZSwgaW4gdGhlIHRyYW5zZmVyIGhvb2ssIHdlJ2xsIGdlbmVyYXRlIGEgZmxhZyBiYXNlZCBvbgor
CSAqIHRoZSBkZXN0aW5hdGlvbiBhZGRyZXNzIHdoaWNoIHdpbGwgdGlja2xlIHRoZSBoYXJkd2Fy
ZSB0byBvdXRwdXQgdGhlCisJICogQWtzdiBvbiBvdXIgYmVoYWxmIGFmdGVyIHRoZSBoZWFkZXIg
aXMgc2VudC4KIAkgKi8KLQlpbnRlbF9kcF9hdXhfaGVhZGVyKHR4YnVmLCAmbXNnKTsKLQotCXJl
dCA9IGludGVsX2RwX2F1eF94ZmVyKGludGVsX2RwLCB0eGJ1ZiwgSEVBREVSX1NJWkUgKyBtc2cu
c2l6ZSwKLQkJCQlyeGJ1Ziwgc2l6ZW9mKHJ4YnVmKSwKLQkJCQlEUF9BVVhfQ0hfQ1RMX0FVWF9B
S1NWX1NFTEVDVCk7Ci0JaWYgKHJldCA8IDApIHsKLQkJRFJNX0RFQlVHX0tNUygiV3JpdGUgQWtz
diBvdmVyIERQL0FVWCBmYWlsZWQgKCVkKVxuIiwgcmV0KTsKLQkJcmV0dXJuIHJldDsKLQl9IGVs
c2UgaWYgKHJldCA9PSAwKSB7Ci0JCURSTV9ERUJVR19LTVMoIkFrc3Ygd3JpdGUgb3ZlciBEUC9B
VVggd2FzIGVtcHR5XG4iKTsKLQkJcmV0dXJuIC1FSU87Ci0JfQotCi0JcmVwbHkgPSAocnhidWZb
MF0gPj4gNCkgJiBEUF9BVVhfTkFUSVZFX1JFUExZX01BU0s7Ci0JaWYgKHJlcGx5ICE9IERQX0FV
WF9OQVRJVkVfUkVQTFlfQUNLKSB7Ci0JCURSTV9ERUJVR19LTVMoIkFrc3Ygd3JpdGU6IG5vIERQ
X0FVWF9OQVRJVkVfUkVQTFlfQUNLICV4XG4iLAotCQkJICAgICAgcmVwbHkpOwotCQlyZXR1cm4g
LUVJTzsKKwlkcGNkX3JldCA9IGRybV9kcF9kcGNkX3dyaXRlKCZpbnRlbF9kaWdfcG9ydC0+ZHAu
YXV4LCBEUF9BVVhfSERDUF9BS1NWLAorCQkJCSAgICAgYWtzdiwgRFJNX0hEQ1BfS1NWX0xFTik7
CisJaWYgKGRwY2RfcmV0ICE9IERSTV9IRENQX0tTVl9MRU4pIHsKKwkJRFJNX0RFQlVHX0tNUygi
RmFpbGVkIHRvIHdyaXRlIEFrc3Ygb3ZlciBEUC9BVVggKCV6ZClcbiIsCisJCQkgICAgICBkcGNk
X3JldCk7CisJCXJldHVybiBkcGNkX3JldCA+PSAwID8gLUVJTyA6IGRwY2RfcmV0OwogCX0KIAly
ZXR1cm4gMDsKIH0KLS0gClNlYW4gUGF1bCwgU29mdHdhcmUgRW5naW5lZXIsIEdvb2dsZSAvIENo
cm9taXVtIE9TCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
XwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcK
aHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
