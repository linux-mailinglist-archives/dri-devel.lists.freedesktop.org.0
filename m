Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 4B6022BBD08
	for <lists+dri-devel@lfdr.de>; Sat, 21 Nov 2020 05:50:16 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 6D2FC6E96B;
	Sat, 21 Nov 2020 04:50:11 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pg1-x542.google.com (mail-pg1-x542.google.com
 [IPv6:2607:f8b0:4864:20::542])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E03CB6E968
 for <dri-devel@lists.freedesktop.org>; Sat, 21 Nov 2020 04:50:07 +0000 (UTC)
Received: by mail-pg1-x542.google.com with SMTP id q34so9120452pgb.11
 for <dri-devel@lists.freedesktop.org>; Fri, 20 Nov 2020 20:50:07 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=GHpNF24q+TKBy5NU/YkjHOD8mOY77JiRU3YsnIt/B8o=;
 b=DCrKMrkRfr7pIobw9eFJ61OTFy8o6Mk8c8usKaJebs3hYGzyI5mm34lx1W72BDn0UK
 dKdVA/2b9wj9YUyc9BfAwlnPFRJr22kYTlUxkWP63lnGSM2R19BlOAk8Lhubi33p6YpL
 kXuTKlemDSfqrc1QgkebjmI37vhXwgvwEP1jBfPOommMfZx/kgfGlYw9nnm8JmY3HyAV
 6HeKjrzWn1NdMz+c1iEKZg+0Lmu8981vgxxf/ZNA0TtWE2Cs/b4MuEuD9P2Q+RhHg7VK
 j0MbY+VVkmT/L2UXflqd/WIknCoxH15HI5OUthHmf1uRAfLVqVwytjq8VsJF3DHT8CPk
 vRWw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=GHpNF24q+TKBy5NU/YkjHOD8mOY77JiRU3YsnIt/B8o=;
 b=lO3NLZFKMczp0MUU92qMMvYvNR5Qiv1y+KCLTc0SC2vL8SuaiuAwR1u9it8X4VbDYC
 8+8rzQHSGOUtT9OFXwVQRasy7ayXNwR9ch8kiVr71IlpuGCxTJY7C9YOM951k15ERD21
 blniJ3JzFstPfoCzP5MO05SQkdI6Wwa3rpcJG7x4UVxqIC+Zc/CgVQcMPU9ECdS/F1uZ
 mmkLpOmB0LrhcxOeXYyXflSXRX1VJpr7JhW2O9+Eo6mf6kC5rskv467QgD8RpXKlQDB8
 NNpD/gZFi2Kkdbw8gc/AlS8g3rPoKtyd9I9b3I0w0v06sVBS6gxM1vQFFdmFUT+Ndx27
 wC/w==
X-Gm-Message-State: AOAM532YlPGZN2kn5AS3F4OTmr+rP2oxeFg0yxRTuPjNJXWMSXSGKK+Y
 jpE4ScqMSubdF+E+LsDINZJ+Vw==
X-Google-Smtp-Source: ABdhPJxSUX5Zw8O37YM9KJak58EF62vq3SMAbc0DS/2cMEpBj1/bbfbSKiiRQQWrDtlqY+wdoqzfSw==
X-Received: by 2002:a17:90a:12cc:: with SMTP id
 b12mr13258284pjg.150.1605934207573; 
 Fri, 20 Nov 2020 20:50:07 -0800 (PST)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 w196sm5407692pfd.177.2020.11.20.20.50.06
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 20 Nov 2020 20:50:07 -0800 (PST)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v6 5/5] dma-buf: system_heap: Allocate higher order pages if
 available
Date: Sat, 21 Nov 2020 04:49:55 +0000
Message-Id: <20201121044955.58215-6-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20201121044955.58215-1-john.stultz@linaro.org>
References: <20201121044955.58215-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sandeep Patil <sspatil@google.com>, dri-devel@lists.freedesktop.org,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Chris Goldsworthy <cgoldswo@codeaurora.org>,
 Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 linux-media@vger.kernel.org, Suren Baghdasaryan <surenb@google.com>,
 Daniel Mentz <danielmentz@google.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2hpbGUgdGhlIHN5c3RlbSBoZWFwIGNhbiByZXR1cm4gbm9uLWNvbnRpZ3VvdXMgcGFnZXMsCnRy
eSB0byBhbGxvY2F0ZSBsYXJnZXIgb3JkZXIgcGFnZXMgaWYgcG9zc2libGUuCgpUaGlzIHdpbGwg
YWxsb3cgc2xpZ2h0IHBlcmZvcm1hbmNlIGdhaW5zIGFuZCBtYWtlIGltcGxlbWVudGluZwpwYWdl
IHBvb2xpbmcgZWFzaWVyLgoKQ2M6IFN1bWl0IFNlbXdhbCA8c3VtaXQuc2Vtd2FsQGxpbmFyby5v
cmc+CkNjOiBMaWFtIE1hcmsgPGxtYXJrQGNvZGVhdXJvcmEub3JnPgpDYzogTGF1cmEgQWJib3R0
IDxsYWJib3R0QGtlcm5lbC5vcmc+CkNjOiBCcmlhbiBTdGFya2V5IDxCcmlhbi5TdGFya2V5QGFy
bS5jb20+CkNjOiBIcmlkeWEgVmFsc2FyYWp1IDxocmlkeWFAZ29vZ2xlLmNvbT4KQ2M6IFN1cmVu
IEJhZ2hkYXNhcnlhbiA8c3VyZW5iQGdvb2dsZS5jb20+CkNjOiBTYW5kZWVwIFBhdGlsIDxzc3Bh
dGlsQGdvb2dsZS5jb20+CkNjOiBEYW5pZWwgTWVudHogPGRhbmllbG1lbnR6QGdvb2dsZS5jb20+
CkNjOiBDaHJpcyBHb2xkc3dvcnRoeSA8Y2dvbGRzd29AY29kZWF1cm9yYS5vcmc+CkNjOiDDmHJq
YW4gRWlkZSA8b3JqYW4uZWlkZUBhcm0uY29tPgpDYzogUm9iaW4gTXVycGh5IDxyb2Jpbi5tdXJw
aHlAYXJtLmNvbT4KQ2M6IEV6ZXF1aWVsIEdhcmNpYSA8ZXplcXVpZWxAY29sbGFib3JhLmNvbT4K
Q2M6IFNpbW9uIFNlciA8Y29udGFjdEBlbWVyc2lvbi5mcj4KQ2M6IEphbWVzIEpvbmVzIDxqYWpv
bmVzQG52aWRpYS5jb20+CkNjOiBsaW51eC1tZWRpYUB2Z2VyLmtlcm5lbC5vcmcKQ2M6IGRyaS1k
ZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKUmV2aWV3ZWQtYnk6IEJyaWFuIFN0YXJrZXkgPGJy
aWFuLnN0YXJrZXlAYXJtLmNvbT4KU2lnbmVkLW9mZi1ieTogSm9obiBTdHVsdHogPGpvaG4uc3R1
bHR6QGxpbmFyby5vcmc+Ci0tLQp2MzoKKiBVc2UgcGFnZV9zaXplKCkgcmF0aGVyIHRoZW4gb3Bl
bmNvZGluZyBpdAp2NToKKiBBZGQgY29tbWVudCBleHBsYWluaW5nIG9yZGVyIHNpemUgcmF0aW9u
YWwKLS0tCiBkcml2ZXJzL2RtYS1idWYvaGVhcHMvc3lzdGVtX2hlYXAuYyB8IDg5ICsrKysrKysr
KysrKysrKysrKysrKysrLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNzEgaW5zZXJ0aW9ucygrKSwg
MTggZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL2hlYXBzL3N5c3Rl
bV9oZWFwLmMgYi9kcml2ZXJzL2RtYS1idWYvaGVhcHMvc3lzdGVtX2hlYXAuYwppbmRleCBiMWE3
YjM1NTEzMmYuLmRlMjc1YjdmZjFlZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9kbWEtYnVmL2hlYXBz
L3N5c3RlbV9oZWFwLmMKKysrIGIvZHJpdmVycy9kbWEtYnVmL2hlYXBzL3N5c3RlbV9oZWFwLmMK
QEAgLTQwLDYgKzQwLDIwIEBAIHN0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50IHsKIAlib29sIG1h
cHBlZDsKIH07CiAKKyNkZWZpbmUgSElHSF9PUkRFUl9HRlAgICgoKEdGUF9ISUdIVVNFUiB8IF9f
R0ZQX1pFUk8gfCBfX0dGUF9OT1dBUk4gXAorCQkJCXwgX19HRlBfTk9SRVRSWSkgJiB+X19HRlBf
UkVDTEFJTSkgXAorCQkJCXwgX19HRlBfQ09NUCkKKyNkZWZpbmUgTE9XX09SREVSX0dGUCAoR0ZQ
X0hJR0hVU0VSIHwgX19HRlBfWkVSTyB8IF9fR0ZQX0NPTVApCitzdGF0aWMgZ2ZwX3Qgb3JkZXJf
ZmxhZ3NbXSA9IHtISUdIX09SREVSX0dGUCwgTE9XX09SREVSX0dGUCwgTE9XX09SREVSX0dGUH07
CisvKgorICogVGhlIHNlbGVjdGlvbiBvZiB0aGUgb3JkZXJzIHVzZWQgZm9yIGFsbG9jYXRpb24g
KDFNQiwgNjRLLCA0SykgaXMgZGVzaWduZWQKKyAqIHRvIG1hdGNoIHdpdGggdGhlIHNpemVzIG9m
dGVuIGZvdW5kIGluIElPTU1Vcy4gVXNpbmcgb3JkZXIgNCBwYWdlcyBpbnN0ZWFkCisgKiBvZiBv
cmRlciAwIHBhZ2VzIGNhbiBzaWduaWZpY2FudGx5IGltcHJvdmUgdGhlIHBlcmZvcm1hbmNlIG9m
IG1hbnkgSU9NTVVzCisgKiBieSByZWR1Y2luZyBUTEIgcHJlc3N1cmUgYW5kIHRpbWUgc3BlbnQg
dXBkYXRpbmcgcGFnZSB0YWJsZXMuCisgKi8KK3N0YXRpYyBjb25zdCB1bnNpZ25lZCBpbnQgb3Jk
ZXJzW10gPSB7OCwgNCwgMH07CisjZGVmaW5lIE5VTV9PUkRFUlMgQVJSQVlfU0laRShvcmRlcnMp
CisKIHN0YXRpYyBzdHJ1Y3Qgc2dfdGFibGUgKmR1cF9zZ190YWJsZShzdHJ1Y3Qgc2dfdGFibGUg
KnRhYmxlKQogewogCXN0cnVjdCBzZ190YWJsZSAqbmV3X3RhYmxlOwpAQCAtMjcyLDggKzI4Niwx
MSBAQCBzdGF0aWMgdm9pZCBzeXN0ZW1faGVhcF9kbWFfYnVmX3JlbGVhc2Uoc3RydWN0IGRtYV9i
dWYgKmRtYWJ1ZikKIAlpbnQgaTsKIAogCXRhYmxlID0gJmJ1ZmZlci0+c2dfdGFibGU7Ci0JZm9y
X2VhY2hfc2d0YWJsZV9zZyh0YWJsZSwgc2csIGkpCi0JCV9fZnJlZV9wYWdlKHNnX3BhZ2Uoc2cp
KTsKKwlmb3JfZWFjaF9zZyh0YWJsZS0+c2dsLCBzZywgdGFibGUtPm5lbnRzLCBpKSB7CisJCXN0
cnVjdCBwYWdlICpwYWdlID0gc2dfcGFnZShzZyk7CisKKwkJX19mcmVlX3BhZ2VzKHBhZ2UsIGNv
bXBvdW5kX29yZGVyKHBhZ2UpKTsKKwl9CiAJc2dfZnJlZV90YWJsZSh0YWJsZSk7CiAJa2ZyZWUo
YnVmZmVyKTsKIH0KQEAgLTI5MSw2ICszMDgsMjYgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBkbWFf
YnVmX29wcyBzeXN0ZW1faGVhcF9idWZfb3BzID0gewogCS5yZWxlYXNlID0gc3lzdGVtX2hlYXBf
ZG1hX2J1Zl9yZWxlYXNlLAogfTsKIAorc3RhdGljIHN0cnVjdCBwYWdlICphbGxvY19sYXJnZXN0
X2F2YWlsYWJsZSh1bnNpZ25lZCBsb25nIHNpemUsCisJCQkJCSAgICB1bnNpZ25lZCBpbnQgbWF4
X29yZGVyKQoreworCXN0cnVjdCBwYWdlICpwYWdlOworCWludCBpOworCisJZm9yIChpID0gMDsg
aSA8IE5VTV9PUkRFUlM7IGkrKykgeworCQlpZiAoc2l6ZSA8ICAoUEFHRV9TSVpFIDw8IG9yZGVy
c1tpXSkpCisJCQljb250aW51ZTsKKwkJaWYgKG1heF9vcmRlciA8IG9yZGVyc1tpXSkKKwkJCWNv
bnRpbnVlOworCisJCXBhZ2UgPSBhbGxvY19wYWdlcyhvcmRlcl9mbGFnc1tpXSwgb3JkZXJzW2ld
KTsKKwkJaWYgKCFwYWdlKQorCQkJY29udGludWU7CisJCXJldHVybiBwYWdlOworCX0KKwlyZXR1
cm4gTlVMTDsKK30KKwogc3RhdGljIGludCBzeXN0ZW1faGVhcF9hbGxvY2F0ZShzdHJ1Y3QgZG1h
X2hlYXAgKmhlYXAsCiAJCQkJdW5zaWduZWQgbG9uZyBsZW4sCiAJCQkJdW5zaWduZWQgbG9uZyBm
ZF9mbGFncywKQEAgLTI5OCwxMSArMzM1LDEzIEBAIHN0YXRpYyBpbnQgc3lzdGVtX2hlYXBfYWxs
b2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAogewogCXN0cnVjdCBzeXN0ZW1faGVhcF9idWZm
ZXIgKmJ1ZmZlcjsKIAlERUZJTkVfRE1BX0JVRl9FWFBPUlRfSU5GTyhleHBfaW5mbyk7CisJdW5z
aWduZWQgbG9uZyBzaXplX3JlbWFpbmluZyA9IGxlbjsKKwl1bnNpZ25lZCBpbnQgbWF4X29yZGVy
ID0gb3JkZXJzWzBdOwogCXN0cnVjdCBkbWFfYnVmICpkbWFidWY7CiAJc3RydWN0IHNnX3RhYmxl
ICp0YWJsZTsKIAlzdHJ1Y3Qgc2NhdHRlcmxpc3QgKnNnOwotCXBnb2ZmX3QgcGFnZWNvdW50Owot
CXBnb2ZmX3QgcGc7CisJc3RydWN0IGxpc3RfaGVhZCBwYWdlczsKKwlzdHJ1Y3QgcGFnZSAqcGFn
ZSwgKnRtcF9wYWdlOwogCWludCBpLCByZXQgPSAtRU5PTUVNOwogCiAJYnVmZmVyID0ga3phbGxv
YyhzaXplb2YoKmJ1ZmZlciksIEdGUF9LRVJORUwpOwpAQCAtMzE0LDI1ICszNTMsMzUgQEAgc3Rh
dGljIGludCBzeXN0ZW1faGVhcF9hbGxvY2F0ZShzdHJ1Y3QgZG1hX2hlYXAgKmhlYXAsCiAJYnVm
ZmVyLT5oZWFwID0gaGVhcDsKIAlidWZmZXItPmxlbiA9IGxlbjsKIAotCXRhYmxlID0gJmJ1ZmZl
ci0+c2dfdGFibGU7Ci0JcGFnZWNvdW50ID0gbGVuIC8gUEFHRV9TSVpFOwotCWlmIChzZ19hbGxv
Y190YWJsZSh0YWJsZSwgcGFnZWNvdW50LCBHRlBfS0VSTkVMKSkKLQkJZ290byBmcmVlX2J1ZmZl
cjsKLQotCXNnID0gdGFibGUtPnNnbDsKLQlmb3IgKHBnID0gMDsgcGcgPCBwYWdlY291bnQ7IHBn
KyspIHsKLQkJc3RydWN0IHBhZ2UgKnBhZ2U7CisJSU5JVF9MSVNUX0hFQUQoJnBhZ2VzKTsKKwlp
ID0gMDsKKwl3aGlsZSAoc2l6ZV9yZW1haW5pbmcgPiAwKSB7CiAJCS8qCiAJCSAqIEF2b2lkIHRy
eWluZyB0byBhbGxvY2F0ZSBtZW1vcnkgaWYgdGhlIHByb2Nlc3MKIAkJICogaGFzIGJlZW4ga2ls
bGVkIGJ5IFNJR0tJTEwKIAkJICovCiAJCWlmIChmYXRhbF9zaWduYWxfcGVuZGluZyhjdXJyZW50
KSkKLQkJCWdvdG8gZnJlZV9wYWdlczsKLQkJcGFnZSA9IGFsbG9jX3BhZ2UoR0ZQX0tFUk5FTCB8
IF9fR0ZQX1pFUk8pOworCQkJZ290byBmcmVlX2J1ZmZlcjsKKworCQlwYWdlID0gYWxsb2NfbGFy
Z2VzdF9hdmFpbGFibGUoc2l6ZV9yZW1haW5pbmcsIG1heF9vcmRlcik7CiAJCWlmICghcGFnZSkK
LQkJCWdvdG8gZnJlZV9wYWdlczsKKwkJCWdvdG8gZnJlZV9idWZmZXI7CisKKwkJbGlzdF9hZGRf
dGFpbCgmcGFnZS0+bHJ1LCAmcGFnZXMpOworCQlzaXplX3JlbWFpbmluZyAtPSBwYWdlX3NpemUo
cGFnZSk7CisJCW1heF9vcmRlciA9IGNvbXBvdW5kX29yZGVyKHBhZ2UpOworCQlpKys7CisJfQor
CisJdGFibGUgPSAmYnVmZmVyLT5zZ190YWJsZTsKKwlpZiAoc2dfYWxsb2NfdGFibGUodGFibGUs
IGksIEdGUF9LRVJORUwpKQorCQlnb3RvIGZyZWVfYnVmZmVyOworCisJc2cgPSB0YWJsZS0+c2ds
OworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShwYWdlLCB0bXBfcGFnZSwgJnBhZ2VzLCBscnUp
IHsKIAkJc2dfc2V0X3BhZ2Uoc2csIHBhZ2UsIHBhZ2Vfc2l6ZShwYWdlKSwgMCk7CiAJCXNnID0g
c2dfbmV4dChzZyk7CisJCWxpc3RfZGVsKCZwYWdlLT5scnUpOwogCX0KIAogCS8qIGNyZWF0ZSB0
aGUgZG1hYnVmICovCkBAIC0zNTIsMTQgKzQwMSwxOCBAQCBzdGF0aWMgaW50IHN5c3RlbV9oZWFw
X2FsbG9jYXRlKHN0cnVjdCBkbWFfaGVhcCAqaGVhcCwKIAkJLyoganVzdCByZXR1cm4sIGFzIHB1
dCB3aWxsIGNhbGwgcmVsZWFzZSBhbmQgdGhhdCB3aWxsIGZyZWUgKi8KIAkJcmV0dXJuIHJldDsK
IAl9Ci0KIAlyZXR1cm4gcmV0OwogCiBmcmVlX3BhZ2VzOgotCWZvcl9lYWNoX3NndGFibGVfc2co
dGFibGUsIHNnLCBpKQotCQlfX2ZyZWVfcGFnZShzZ19wYWdlKHNnKSk7CisJZm9yX2VhY2hfc2d0
YWJsZV9zZyh0YWJsZSwgc2csIGkpIHsKKwkJc3RydWN0IHBhZ2UgKnAgPSBzZ19wYWdlKHNnKTsK
KworCQlfX2ZyZWVfcGFnZXMocCwgY29tcG91bmRfb3JkZXIocCkpOworCX0KIAlzZ19mcmVlX3Rh
YmxlKHRhYmxlKTsKIGZyZWVfYnVmZmVyOgorCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShwYWdl
LCB0bXBfcGFnZSwgJnBhZ2VzLCBscnUpCisJCV9fZnJlZV9wYWdlcyhwYWdlLCBjb21wb3VuZF9v
cmRlcihwYWdlKSk7CiAJa2ZyZWUoYnVmZmVyKTsKIAogCXJldHVybiByZXQ7Ci0tIAoyLjE3LjEK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZl
bCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
