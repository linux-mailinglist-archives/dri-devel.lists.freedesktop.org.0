Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 9F70014857E
	for <lists+dri-devel@lfdr.de>; Fri, 24 Jan 2020 13:56:48 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A533E6FA63;
	Fri, 24 Jan 2020 12:56:42 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8BCFC6E395;
 Fri, 24 Jan 2020 12:56:38 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19995096-1500050 
 for multiple; Fri, 24 Jan 2020 12:56:29 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH 2/2] drm: Avoid drm_global_mutex for simple inc/dec of
 dev->open_count
Date: Fri, 24 Jan 2020 12:56:27 +0000
Message-Id: <20200124125627.125042-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.25.0
In-Reply-To: <20200124125627.125042-1-chris@chris-wilson.co.uk>
References: <20200124125627.125042-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: daniel.vetter@ffwll.ch, intel-gfx@lists.freedesktop.org,
 =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas_os@shipmail.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2UgZHJtX2dsb2JhbF9tdXRleCBpcyBhIHRydWUgZ2xvYmFsIG11dGV4IGFjcm9zcyBkZXZp
Y2VzLCB3ZSBkb24ndAp3YW50IHRvIGFjcXVpcmUgaXQgdW5sZXNzIGFic29sdXRlbHkgbmVjZXNz
YXJ5LiBGb3IgbWFpbnRhaW5pbmcgdGhlCmRldmljZSBsb2NhbCBvcGVuX2NvdW50LCB3ZSBjYW4g
dXNlIGF0b21pYyBvcGVyYXRpb25zIG9uIHRoZSBjb3VudGVyCml0c2VsZiwgZXhjZXB0IHdoZW4g
bWFraW5nIHRoZSB0cmFuc2l0aW9uIHRvL2Zyb20gMC4gSGVyZSwgd2UgdGFja2xlIHRoZQplYXN5
IHBvcnRpb24gb2YgZGVsYXlpbmcgYWNxdWlyaW5nIHRoZSBkcm1fZ2xvYmFsX211dGV4IGZvciB0
aGUgZmluYWwKcmVsZWFzZSBieSB1c2luZyBhdG9taWNfZGVjX2FuZF9tdXRleF9sb2NrKCksIGxl
YXZpbmcgdGhlIGdsb2JhbApzZXJpYWxpc2F0aW9uIGFjcm9zcyB0aGUgZGV2aWNlIG9wZW5zLgoK
U2lnbmVkLW9mZi1ieTogQ2hyaXMgV2lsc29uIDxjaHJpc0BjaHJpcy13aWxzb24uY28udWs+CkNj
OiBUaG9tYXMgSGVsbHN0csO2bSAoVk13YXJlKSA8dGhvbWFzX29zQHNoaXBtYWlsLm9yZz4KLS0t
CiBkcml2ZXJzL2dwdS9kcm0vYW1kL2FtZGdwdS9hbWRncHVfZGV2aWNlLmMgfCAgMiArLQogZHJp
dmVycy9ncHUvZHJtL2RybV9maWxlLmMgICAgICAgICAgICAgICAgIHwgMTQgKysrKysrLS0tLS0t
LS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfc3dpdGNoZXJvby5jICAgICB8ICAyICstCiBk
cml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X3ZnYS5jICAgICAgfCAgMiArLQogZHJpdmVy
cy9ncHUvZHJtL3JhZGVvbi9yYWRlb25fZGV2aWNlLmMgICAgIHwgIDIgKy0KIGluY2x1ZGUvZHJt
L2RybV9kZXZpY2UuaCAgICAgICAgICAgICAgICAgICB8ICAyICstCiA2IGZpbGVzIGNoYW5nZWQs
IDExIGluc2VydGlvbnMoKyksIDEzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV9kZXZpY2UuYyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQv
YW1kZ3B1L2FtZGdwdV9kZXZpY2UuYwppbmRleCA1M2Q4ODIwMDAxMDEuLmMzYzAzNTZkZmE2MSAx
MDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvYW1kZ3B1X2RldmljZS5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L2FtZGdwdV9kZXZpY2UuYwpAQCAtMTEzNiw3
ICsxMTM2LDcgQEAgc3RhdGljIGJvb2wgYW1kZ3B1X3N3aXRjaGVyb29fY2FuX3N3aXRjaChzdHJ1
Y3QgcGNpX2RldiAqcGRldikKIAkqIGxvY2tpbmcgaW52ZXJzaW9uIHdpdGggdGhlIGRyaXZlciBs
b2FkIHBhdGguIEFuZCB0aGUgYWNjZXNzIGhlcmUgaXMKIAkqIGNvbXBsZXRlbHkgcmFjeSBhbnl3
YXkuIFNvIGRvbid0IGJvdGhlciB3aXRoIGxvY2tpbmcgZm9yIG5vdy4KIAkqLwotCXJldHVybiBk
ZXYtPm9wZW5fY291bnQgPT0gMDsKKwlyZXR1cm4gYXRvbWljX3JlYWQoJmRldi0+b3Blbl9jb3Vu
dCkgPT0gMDsKIH0KIAogc3RhdGljIGNvbnN0IHN0cnVjdCB2Z2Ffc3dpdGNoZXJvb19jbGllbnRf
b3BzIGFtZGdwdV9zd2l0Y2hlcm9vX29wcyA9IHsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9kcm1fZmlsZS5jIGIvZHJpdmVycy9ncHUvZHJtL2RybV9maWxlLmMKaW5kZXggZTI1MzA2YzQ5
Y2M2Li5jNGU5ZWY4NmM1ODkgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmlsZS5j
CisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmlsZS5jCkBAIC0yMjAsNyArMjIwLDcgQEAgdm9p
ZCBkcm1fZmlsZV9mcmVlKHN0cnVjdCBkcm1fZmlsZSAqZmlsZSkKIAlEUk1fREVCVUcoInBpZCA9
ICVkLCBkZXZpY2UgPSAweCVseCwgb3Blbl9jb3VudCA9ICVkXG4iLAogCQkgIHRhc2tfcGlkX25y
KGN1cnJlbnQpLAogCQkgIChsb25nKW9sZF9lbmNvZGVfZGV2KGZpbGUtPm1pbm9yLT5rZGV2LT5k
ZXZ0KSwKLQkJICBSRUFEX09OQ0UoZGV2LT5vcGVuX2NvdW50KSk7CisJCSAgYXRvbWljX3JlYWQo
JmRldi0+b3Blbl9jb3VudCkpOwogCiAJaWYgKGRybV9jb3JlX2NoZWNrX2ZlYXR1cmUoZGV2LCBE
UklWRVJfTEVHQUNZKSAmJgogCSAgICBkZXYtPmRyaXZlci0+cHJlY2xvc2UpCkBAIC0zNzksNyAr
Mzc5LDcgQEAgaW50IGRybV9vcGVuKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpm
aWxwKQogCQlyZXR1cm4gUFRSX0VSUihtaW5vcik7CiAKIAlkZXYgPSBtaW5vci0+ZGV2OwotCWlm
ICghZGV2LT5vcGVuX2NvdW50KyspCisJaWYgKCFhdG9taWNfZmV0Y2hfaW5jKCZkZXYtPm9wZW5f
Y291bnQpKQogCQluZWVkX3NldHVwID0gMTsKIAogCS8qIHNoYXJlIGFkZHJlc3Nfc3BhY2UgYWNy
b3NzIGFsbCBjaGFyLWRldnMgb2YgYSBzaW5nbGUgZGV2aWNlICovCkBAIC0zOTgsNyArMzk4LDcg
QEAgaW50IGRybV9vcGVuKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmaWxwKQog
CXJldHVybiAwOwogCiBlcnJfdW5kbzoKLQlkZXYtPm9wZW5fY291bnQtLTsKKwlhdG9taWNfZGVj
KCZkZXYtPm9wZW5fY291bnQpOwogCWRybV9taW5vcl9yZWxlYXNlKG1pbm9yKTsKIAlyZXR1cm4g
cmV0Y29kZTsKIH0KQEAgLTQ0MCwxMSArNDQwLDExIEBAIGludCBkcm1fcmVsZWFzZShzdHJ1Y3Qg
aW5vZGUgKmlub2RlLCBzdHJ1Y3QgZmlsZSAqZmlscCkKIAogCW11dGV4X2xvY2soJmRybV9nbG9i
YWxfbXV0ZXgpOwogCi0JRFJNX0RFQlVHKCJvcGVuX2NvdW50ID0gJWRcbiIsIGRldi0+b3Blbl9j
b3VudCk7CisJRFJNX0RFQlVHKCJvcGVuX2NvdW50ID0gJWRcbiIsIGF0b21pY19yZWFkKCZkZXYt
Pm9wZW5fY291bnQpKTsKIAogCWRybV9jbG9zZV9oZWxwZXIoZmlscCk7CiAKLQlpZiAoIS0tZGV2
LT5vcGVuX2NvdW50KQorCWlmIChhdG9taWNfZGVjX2FuZF90ZXN0KCZkZXYtPm9wZW5fY291bnQp
KQogCQlkcm1fbGFzdGNsb3NlKGRldik7CiAKIAltdXRleF91bmxvY2soJmRybV9nbG9iYWxfbXV0
ZXgpOwpAQCAtNDc4LDEwICs0NzgsOCBAQCBpbnQgZHJtX3JlbGVhc2Vfbm9nbG9iYWwoc3RydWN0
IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUgKmZpbHApCiAKIAlkcm1fY2xvc2VfaGVscGVyKGZp
bHApOwogCi0JbXV0ZXhfbG9jaygmZHJtX2dsb2JhbF9tdXRleCk7Ci0JaWYgKCEtLWRldi0+b3Bl
bl9jb3VudCkKKwlpZiAoYXRvbWljX2RlY19hbmRfbXV0ZXhfbG9jaygmZGV2LT5vcGVuX2NvdW50
LCAmZHJtX2dsb2JhbF9tdXRleCkpCiAJCWRybV9sYXN0Y2xvc2UoZGV2KTsKLQltdXRleF91bmxv
Y2soJmRybV9nbG9iYWxfbXV0ZXgpOwogCiAJZHJtX21pbm9yX3JlbGVhc2UobWlub3IpOwogCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3N3aXRjaGVyb28uYyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2k5MTVfc3dpdGNoZXJvby5jCmluZGV4IDM5Yzc5ZTFjNWI1Mi4uZWQ2
OWI1ZDRhMzc1IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3N3aXRjaGVy
b28uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pOTE1X3N3aXRjaGVyb28uYwpAQCAtNDMs
NyArNDMsNyBAQCBzdGF0aWMgYm9vbCBpOTE1X3N3aXRjaGVyb29fY2FuX3N3aXRjaChzdHJ1Y3Qg
cGNpX2RldiAqcGRldikKIAkgKiBsb2NraW5nIGludmVyc2lvbiB3aXRoIHRoZSBkcml2ZXIgbG9h
ZCBwYXRoLiBBbmQgdGhlIGFjY2VzcyBoZXJlIGlzCiAJICogY29tcGxldGVseSByYWN5IGFueXdh
eS4gU28gZG9uJ3QgYm90aGVyIHdpdGggbG9ja2luZyBmb3Igbm93LgogCSAqLwotCXJldHVybiBp
OTE1ICYmIGk5MTUtPmRybS5vcGVuX2NvdW50ID09IDA7CisJcmV0dXJuIGk5MTUgJiYgYXRvbWlj
X3JlYWQoJmk5MTUtPmRybS5vcGVuX2NvdW50KSA9PSAwOwogfQogCiBzdGF0aWMgY29uc3Qgc3Ry
dWN0IHZnYV9zd2l0Y2hlcm9vX2NsaWVudF9vcHMgaTkxNV9zd2l0Y2hlcm9vX29wcyA9IHsKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25vdXZlYXVfdmdhLmMgYi9kcml2ZXJz
L2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X3ZnYS5jCmluZGV4IGQ4NjVkOGFlYWMzYy4uYzg1ZGQ4
YWZhM2MzIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X3ZnYS5j
CisrKyBiL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25vdXZlYXVfdmdhLmMKQEAgLTcyLDcgKzcy
LDcgQEAgbm91dmVhdV9zd2l0Y2hlcm9vX2Nhbl9zd2l0Y2goc3RydWN0IHBjaV9kZXYgKnBkZXYp
CiAJICogbG9ja2luZyBpbnZlcnNpb24gd2l0aCB0aGUgZHJpdmVyIGxvYWQgcGF0aC4gQW5kIHRo
ZSBhY2Nlc3MgaGVyZSBpcwogCSAqIGNvbXBsZXRlbHkgcmFjeSBhbnl3YXkuIFNvIGRvbid0IGJv
dGhlciB3aXRoIGxvY2tpbmcgZm9yIG5vdy4KIAkgKi8KLQlyZXR1cm4gZGV2LT5vcGVuX2NvdW50
ID09IDA7CisJcmV0dXJuIGF0b21pY19yZWFkKCZkZXYtPm9wZW5fY291bnQpID09IDA7CiB9CiAK
IHN0YXRpYyBjb25zdCBzdHJ1Y3QgdmdhX3N3aXRjaGVyb29fY2xpZW50X29wcwpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL3JhZGVvbi9yYWRlb25fZGV2aWNlLmMgYi9kcml2ZXJzL2dwdS9k
cm0vcmFkZW9uL3JhZGVvbl9kZXZpY2UuYwppbmRleCBhNTIyZTA5MjAzOGIuLjI2NmUzY2JiZDA5
YiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3JhZGVvbi9yYWRlb25fZGV2aWNlLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL3JhZGVvbi9yYWRlb25fZGV2aWNlLmMKQEAgLTEyNjMsNyArMTI2
Myw3IEBAIHN0YXRpYyBib29sIHJhZGVvbl9zd2l0Y2hlcm9vX2Nhbl9zd2l0Y2goc3RydWN0IHBj
aV9kZXYgKnBkZXYpCiAJICogbG9ja2luZyBpbnZlcnNpb24gd2l0aCB0aGUgZHJpdmVyIGxvYWQg
cGF0aC4gQW5kIHRoZSBhY2Nlc3MgaGVyZSBpcwogCSAqIGNvbXBsZXRlbHkgcmFjeSBhbnl3YXku
IFNvIGRvbid0IGJvdGhlciB3aXRoIGxvY2tpbmcgZm9yIG5vdy4KIAkgKi8KLQlyZXR1cm4gZGV2
LT5vcGVuX2NvdW50ID09IDA7CisJcmV0dXJuIGF0b21pY19yZWFkKCZkZXYtPm9wZW5fY291bnQp
ID09IDA7CiB9CiAKIHN0YXRpYyBjb25zdCBzdHJ1Y3QgdmdhX3N3aXRjaGVyb29fY2xpZW50X29w
cyByYWRlb25fc3dpdGNoZXJvb19vcHMgPSB7CmRpZmYgLS1naXQgYS9pbmNsdWRlL2RybS9kcm1f
ZGV2aWNlLmggYi9pbmNsdWRlL2RybS9kcm1fZGV2aWNlLmgKaW5kZXggMWFjZmMzYmJkM2ZiLi5i
YjYwYTk0OWY0MTYgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvZHJtL2RybV9kZXZpY2UuaAorKysgYi9p
bmNsdWRlL2RybS9kcm1fZGV2aWNlLmgKQEAgLTE0NCw3ICsxNDQsNyBAQCBzdHJ1Y3QgZHJtX2Rl
dmljZSB7CiAJICogVXNhZ2UgY291bnRlciBmb3Igb3V0c3RhbmRpbmcgZmlsZXMgb3BlbiwKIAkg
KiBwcm90ZWN0ZWQgYnkgZHJtX2dsb2JhbF9tdXRleAogCSAqLwotCWludCBvcGVuX2NvdW50Owor
CWF0b21pY190IG9wZW5fY291bnQ7CiAKIAkvKiogQGZpbGVsaXN0X211dGV4OiBQcm90ZWN0cyBA
ZmlsZWxpc3QuICovCiAJc3RydWN0IG11dGV4IGZpbGVsaXN0X211dGV4OwotLSAKMi4yNS4wCgpf
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwg
bWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0
cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
