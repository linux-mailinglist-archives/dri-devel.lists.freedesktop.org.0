Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 07192B07A4
	for <lists+dri-devel@lfdr.de>; Thu, 12 Sep 2019 06:14:56 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 513656EB81;
	Thu, 12 Sep 2019 04:12:42 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from hqemgate15.nvidia.com (hqemgate15.nvidia.com [216.228.121.64])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 830986E0E8;
 Wed, 11 Sep 2019 22:28:49 +0000 (UTC)
Received: from hqpgpgate102.nvidia.com (Not Verified[216.228.121.13]) by
 hqemgate15.nvidia.com (using TLS: TLSv1.2, DES-CBC3-SHA)
 id <B5d7975250002>; Wed, 11 Sep 2019 15:28:53 -0700
Received: from hqmail.nvidia.com ([172.20.161.6])
 by hqpgpgate102.nvidia.com (PGP Universal service);
 Wed, 11 Sep 2019 15:28:49 -0700
X-PGP-Universal: processed;
 by hqpgpgate102.nvidia.com on Wed, 11 Sep 2019 15:28:49 -0700
Received: from HQMAIL101.nvidia.com (172.20.187.10) by HQMAIL107.nvidia.com
 (172.20.187.13) with Microsoft SMTP Server (TLS) id 15.0.1473.3; Wed, 11 Sep
 2019 22:28:44 +0000
Received: from hqnvemgw01.nvidia.com (172.20.150.20) by HQMAIL101.nvidia.com
 (172.20.187.10) with Microsoft SMTP Server (TLS) id 15.0.1473.3 via Frontend
 Transport; Wed, 11 Sep 2019 22:28:44 +0000
Received: from rcampbell-dev.nvidia.com (Not Verified[10.110.48.66]) by
 hqnvemgw01.nvidia.com with Trustwave SEG (v7, 5, 8, 10121)
 id <B5d79751b0001>; Wed, 11 Sep 2019 15:28:43 -0700
From: Ralph Campbell <rcampbell@nvidia.com>
To: <linux-mm@kvack.org>
Subject: [PATCH 1/4] mm/hmm: make full use of walk_page_range()
Date: Wed, 11 Sep 2019 15:28:26 -0700
Message-ID: <20190911222829.28874-2-rcampbell@nvidia.com>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190911222829.28874-1-rcampbell@nvidia.com>
References: <20190911222829.28874-1-rcampbell@nvidia.com>
MIME-Version: 1.0
X-NVConfidentiality: public
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=nvidia.com; s=n1; 
 t=1568240933; bh=b0VnDa9P0GKyNEg9iOk3eOIvkV4/HZzZEBTmbi87opU=;
 h=X-PGP-Universal:From:To:CC:Subject:Date:Message-ID:X-Mailer:
 In-Reply-To:References:MIME-Version:X-NVConfidentiality:
 Content-Type:Content-Transfer-Encoding;
 b=NqNMdxLTXaIBY11JKg1HYUZzeesFC50JIFmaBIh6k/v25D5mncaLp7OFXsa4XwAtn
 UaHM0eOqWokTFYPnoGG4loKzhH0SmsRM3SfZCKi3PpFZ+QvkfKzIud6pv5YlRaEy4V
 WebVloNbU6FTF+pPmtxJmlItSD0CTv+5mUiNN56Ajw4bccxiOa7txd+vCoPizHuYNu
 cB5eEnpLJXhsAoRngfxIOPw00XuhjT/rLXCBmhF5Y6IJ/SBrt0EuzoWvHVeu1aRosU
 PqqLaLLp5052QDQQ1yNA+aBB4KUT8bhhpYA+0Qyd9oNLTC3oLcQrsN7WjagwguFANj
 bhUur4L5uRwmA==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Ralph Campbell <rcampbell@nvidia.com>, nouveau@lists.freedesktop.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 =?UTF-8?q?J=C3=A9r=C3=B4me=20Glisse?= <jglisse@redhat.com>,
 Jason Gunthorpe <jgg@mellanox.com>, amd-gfx@lists.freedesktop.org,
 Andrew Morton <akpm@linux-foundation.org>, Christoph Hellwig <hch@lst.de>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

aG1tX3JhbmdlX2ZhdWx0KCkgY2FsbHMgZmluZF92bWEoKSBhbmQgd2Fsa19wYWdlX3JhbmdlKCkg
aW4gYSBsb29wLgpUaGlzIGlzIHVubmVjZXNzYXJ5IGR1cGxpY2F0aW9uIHNpbmNlIHdhbGtfcGFn
ZV9yYW5nZSgpIGNhbGxzIGZpbmRfdm1hKCkKaW4gYSBsb29wIGFscmVhZHkuClNpbXBsaWZ5IGht
bV9yYW5nZV9mYXVsdCgpIGJ5IGRlZmluaW5nIGEgd2Fsa190ZXN0KCkgY2FsbGJhY2sgZnVuY3Rp
b24KdG8gZmlsdGVyIHVuaGFuZGxlZCB2bWFzLgpUaGlzIGFsc28gZml4ZXMgYSBidWcgd2hlcmUg
aG1tX3JhbmdlX2ZhdWx0KCkgd2FzIG5vdCBjaGVja2luZwpzdGFydCA+PSB2bWEtPnZtX3N0YXJ0
IGJlZm9yZSBjaGVja2luZyB2bWEtPnZtX2ZsYWdzIHNvIGhtbV9yYW5nZV9mYXVsdCgpCmNvdWxk
IHJldHVybiBhbiBlcnJvciBiYXNlZCBvbiB0aGUgd3Jvbmcgdm1hIGZvciB0aGUgcmVxdWVzdGVk
IHJhbmdlLgoKU2lnbmVkLW9mZi1ieTogUmFscGggQ2FtcGJlbGwgPHJjYW1wYmVsbEBudmlkaWEu
Y29tPgpDYzogIkrDqXLDtG1lIEdsaXNzZSIgPGpnbGlzc2VAcmVkaGF0LmNvbT4KQ2M6IEphc29u
IEd1bnRob3JwZSA8amdnQG1lbGxhbm94LmNvbT4KQ2M6IENocmlzdG9waCBIZWxsd2lnIDxoY2hA
bHN0LmRlPgotLS0KIG1tL2htbS5jIHwgMTEzICsrKysrKysrKysrKysrKysrKysrKysrKy0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA1MCBpbnNlcnRpb25z
KCspLCA2MyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9tbS9obW0uYyBiL21tL2htbS5jCmlu
ZGV4IDkwMmY1ZmE2YmY5My4uMDYwNDFkNDM5OWZmIDEwMDY0NAotLS0gYS9tbS9obW0uYworKysg
Yi9tbS9obW0uYwpAQCAtMjUyLDE4ICsyNTIsMTcgQEAgc3RhdGljIGludCBobW1fdm1hX2RvX2Zh
dWx0KHN0cnVjdCBtbV93YWxrICp3YWxrLCB1bnNpZ25lZCBsb25nIGFkZHIsCiAJcmV0dXJuIC1F
RkFVTFQ7CiB9CiAKLXN0YXRpYyBpbnQgaG1tX3BmbnNfYmFkKHVuc2lnbmVkIGxvbmcgYWRkciwK
LQkJCXVuc2lnbmVkIGxvbmcgZW5kLAotCQkJc3RydWN0IG1tX3dhbGsgKndhbGspCitzdGF0aWMg
aW50IGhtbV9wZm5zX2ZpbGwodW5zaWduZWQgbG9uZyBhZGRyLAorCQkJIHVuc2lnbmVkIGxvbmcg
ZW5kLAorCQkJIHN0cnVjdCBobW1fcmFuZ2UgKnJhbmdlLAorCQkJIGVudW0gaG1tX3Bmbl92YWx1
ZV9lIHZhbHVlKQogewotCXN0cnVjdCBobW1fdm1hX3dhbGsgKmhtbV92bWFfd2FsayA9IHdhbGst
PnByaXZhdGU7Ci0Jc3RydWN0IGhtbV9yYW5nZSAqcmFuZ2UgPSBobW1fdm1hX3dhbGstPnJhbmdl
OwogCXVpbnQ2NF90ICpwZm5zID0gcmFuZ2UtPnBmbnM7CiAJdW5zaWduZWQgbG9uZyBpOwogCiAJ
aSA9IChhZGRyIC0gcmFuZ2UtPnN0YXJ0KSA+PiBQQUdFX1NISUZUOwogCWZvciAoOyBhZGRyIDwg
ZW5kOyBhZGRyICs9IFBBR0VfU0laRSwgaSsrKQotCQlwZm5zW2ldID0gcmFuZ2UtPnZhbHVlc1tI
TU1fUEZOX0VSUk9SXTsKKwkJcGZuc1tpXSA9IHJhbmdlLT52YWx1ZXNbdmFsdWVdOwogCiAJcmV0
dXJuIDA7CiB9CkBAIC01ODQsNyArNTgzLDcgQEAgc3RhdGljIGludCBobW1fdm1hX3dhbGtfcG1k
KHBtZF90ICpwbWRwLAogCQl9CiAJCXJldHVybiAwOwogCX0gZWxzZSBpZiAoIXBtZF9wcmVzZW50
KHBtZCkpCi0JCXJldHVybiBobW1fcGZuc19iYWQoc3RhcnQsIGVuZCwgd2Fsayk7CisJCXJldHVy
biBobW1fcGZuc19maWxsKHN0YXJ0LCBlbmQsIHJhbmdlLCBITU1fUEZOX0VSUk9SKTsKIAogCWlm
IChwbWRfZGV2bWFwKHBtZCkgfHwgcG1kX3RyYW5zX2h1Z2UocG1kKSkgewogCQkvKgpAQCAtNjEy
LDcgKzYxMSw3IEBAIHN0YXRpYyBpbnQgaG1tX3ZtYV93YWxrX3BtZChwbWRfdCAqcG1kcCwKIAkg
KiByZWNvdmVyLgogCSAqLwogCWlmIChwbWRfYmFkKHBtZCkpCi0JCXJldHVybiBobW1fcGZuc19i
YWQoc3RhcnQsIGVuZCwgd2Fsayk7CisJCXJldHVybiBobW1fcGZuc19maWxsKHN0YXJ0LCBlbmQs
IHJhbmdlLCBITU1fUEZOX0VSUk9SKTsKIAogCXB0ZXAgPSBwdGVfb2Zmc2V0X21hcChwbWRwLCBh
ZGRyKTsKIAlpID0gKGFkZHIgLSByYW5nZS0+c3RhcnQpID4+IFBBR0VfU0hJRlQ7CkBAIC03NzAs
MTMgKzc2OSwzNiBAQCBzdGF0aWMgaW50IGhtbV92bWFfd2Fsa19odWdldGxiX2VudHJ5KHB0ZV90
ICpwdGUsIHVuc2lnbmVkIGxvbmcgaG1hc2ssCiAjZGVmaW5lIGhtbV92bWFfd2Fsa19odWdldGxi
X2VudHJ5IE5VTEwKICNlbmRpZiAvKiBDT05GSUdfSFVHRVRMQl9QQUdFICovCiAKLXN0YXRpYyB2
b2lkIGhtbV9wZm5zX2NsZWFyKHN0cnVjdCBobW1fcmFuZ2UgKnJhbmdlLAotCQkJICAgdWludDY0
X3QgKnBmbnMsCi0JCQkgICB1bnNpZ25lZCBsb25nIGFkZHIsCi0JCQkgICB1bnNpZ25lZCBsb25n
IGVuZCkKK3N0YXRpYyBpbnQgaG1tX3ZtYV93YWxrX3Rlc3QodW5zaWduZWQgbG9uZyBzdGFydCwK
KwkJCSAgICAgdW5zaWduZWQgbG9uZyBlbmQsCisJCQkgICAgIHN0cnVjdCBtbV93YWxrICp3YWxr
KQogewotCWZvciAoOyBhZGRyIDwgZW5kOyBhZGRyICs9IFBBR0VfU0laRSwgcGZucysrKQotCQkq
cGZucyA9IHJhbmdlLT52YWx1ZXNbSE1NX1BGTl9OT05FXTsKKwlzdHJ1Y3QgaG1tX3ZtYV93YWxr
ICpobW1fdm1hX3dhbGsgPSB3YWxrLT5wcml2YXRlOworCXN0cnVjdCBobW1fcmFuZ2UgKnJhbmdl
ID0gaG1tX3ZtYV93YWxrLT5yYW5nZTsKKwlzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSA9IHdh
bGstPnZtYTsKKworCS8qIElmIHJhbmdlIGlzIG5vIGxvbmdlciB2YWxpZCwgZm9yY2UgcmV0cnku
ICovCisJaWYgKCFyYW5nZS0+dmFsaWQpCisJCXJldHVybiAtRUJVU1k7CisKKwkvKgorCSAqIFNr
aXAgdm1hIHJhbmdlcyB0aGF0IGRvbid0IGhhdmUgc3RydWN0IHBhZ2UgYmFja2luZyB0aGVtIG9y
CisJICogbWFwIEkvTyBkZXZpY2VzIGRpcmVjdGx5LgorCSAqLworCWlmICh2bWEtPnZtX2ZsYWdz
ICYgKFZNX0lPIHwgVk1fUEZOTUFQIHwgVk1fTUlYRURNQVApKQorCQlyZXR1cm4gLUVGQVVMVDsK
KworCS8qCisJICogSWYgdGhlIHZtYSBkb2VzIG5vdCBhbGxvdyByZWFkIGFjY2VzcywgdGhlbiBh
c3N1bWUgdGhhdCBpdCBkb2VzIG5vdAorCSAqIGFsbG93IHdyaXRlIGFjY2VzcyBlaXRoZXIuIEhN
TSBkb2VzIG5vdCBzdXBwb3J0IGFyY2hpdGVjdHVyZXMKKwkgKiB0aGF0IGFsbG93IHdyaXRlIHdp
dGhvdXQgcmVhZC4KKwkgKi8KKwlpZiAoISh2bWEtPnZtX2ZsYWdzICYgVk1fUkVBRCkpIHsKKwkJ
KHZvaWQpIGhtbV9wZm5zX2ZpbGwoc3RhcnQsIGVuZCwgcmFuZ2UsIEhNTV9QRk5fTk9ORSk7CisJ
CXJldHVybiAtRVBFUk07CisJfQorCisJcmV0dXJuIDA7CiB9CiAKIC8qCkBAIC04NTcsNiArODc5
LDcgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBtbV93YWxrX29wcyBobW1fd2Fsa19vcHMgPSB7CiAJ
LnBtZF9lbnRyeQk9IGhtbV92bWFfd2Fsa19wbWQsCiAJLnB0ZV9ob2xlCT0gaG1tX3ZtYV93YWxr
X2hvbGUsCiAJLmh1Z2V0bGJfZW50cnkJPSBobW1fdm1hX3dhbGtfaHVnZXRsYl9lbnRyeSwKKwku
dGVzdF93YWxrCT0gaG1tX3ZtYV93YWxrX3Rlc3QsCiB9OwogCiAvKioKQEAgLTg4OSw2MyArOTEy
LDI3IEBAIHN0YXRpYyBjb25zdCBzdHJ1Y3QgbW1fd2Fsa19vcHMgaG1tX3dhbGtfb3BzID0gewog
ICovCiBsb25nIGhtbV9yYW5nZV9mYXVsdChzdHJ1Y3QgaG1tX3JhbmdlICpyYW5nZSwgdW5zaWdu
ZWQgaW50IGZsYWdzKQogewotCWNvbnN0IHVuc2lnbmVkIGxvbmcgZGV2aWNlX3ZtYSA9IFZNX0lP
IHwgVk1fUEZOTUFQIHwgVk1fTUlYRURNQVA7Ci0JdW5zaWduZWQgbG9uZyBzdGFydCA9IHJhbmdl
LT5zdGFydCwgZW5kOwotCXN0cnVjdCBobW1fdm1hX3dhbGsgaG1tX3ZtYV93YWxrOworCXVuc2ln
bmVkIGxvbmcgc3RhcnQgPSByYW5nZS0+c3RhcnQ7CisJc3RydWN0IGhtbV92bWFfd2FsayBobW1f
dm1hX3dhbGsgPSB7CisJCS5yYW5nZSA9IHJhbmdlLAorCQkubGFzdCA9IHN0YXJ0LAorCQkuZmxh
Z3MgPSBmbGFncywKKwl9OwogCXN0cnVjdCBobW0gKmhtbSA9IHJhbmdlLT5obW07Ci0Jc3RydWN0
IHZtX2FyZWFfc3RydWN0ICp2bWE7CiAJaW50IHJldDsKIAogCWxvY2tkZXBfYXNzZXJ0X2hlbGQo
JmhtbS0+bW11X25vdGlmaWVyLm1tLT5tbWFwX3NlbSk7CiAKIAlkbyB7Ci0JCS8qIElmIHJhbmdl
IGlzIG5vIGxvbmdlciB2YWxpZCBmb3JjZSByZXRyeS4gKi8KLQkJaWYgKCFyYW5nZS0+dmFsaWQp
Ci0JCQlyZXR1cm4gLUVCVVNZOwotCi0JCXZtYSA9IGZpbmRfdm1hKGhtbS0+bW11X25vdGlmaWVy
Lm1tLCBzdGFydCk7Ci0JCWlmICh2bWEgPT0gTlVMTCB8fCAodm1hLT52bV9mbGFncyAmIGRldmlj
ZV92bWEpKQotCQkJcmV0dXJuIC1FRkFVTFQ7Ci0KLQkJaWYgKCEodm1hLT52bV9mbGFncyAmIFZN
X1JFQUQpKSB7Ci0JCQkvKgotCQkJICogSWYgdm1hIGRvIG5vdCBhbGxvdyByZWFkIGFjY2Vzcywg
dGhlbiBhc3N1bWUgdGhhdCBpdAotCQkJICogZG9lcyBub3QgYWxsb3cgd3JpdGUgYWNjZXNzLCBl
aXRoZXIuIEhNTSBkb2VzIG5vdAotCQkJICogc3VwcG9ydCBhcmNoaXRlY3R1cmUgdGhhdCBhbGxv
dyB3cml0ZSB3aXRob3V0IHJlYWQuCi0JCQkgKi8KLQkJCWhtbV9wZm5zX2NsZWFyKHJhbmdlLCBy
YW5nZS0+cGZucywKLQkJCQlyYW5nZS0+c3RhcnQsIHJhbmdlLT5lbmQpOwotCQkJcmV0dXJuIC1F
UEVSTTsKLQkJfQorCQlyZXQgPSB3YWxrX3BhZ2VfcmFuZ2UoaG1tLT5tbXVfbm90aWZpZXIubW0s
IHN0YXJ0LCByYW5nZS0+ZW5kLAorCQkJCSAgICAgICZobW1fd2Fsa19vcHMsICZobW1fdm1hX3dh
bGspOworCQlzdGFydCA9IGhtbV92bWFfd2Fsay5sYXN0OwogCi0JCWhtbV92bWFfd2Fsay5wZ21h
cCA9IE5VTEw7Ci0JCWhtbV92bWFfd2Fsay5sYXN0ID0gc3RhcnQ7Ci0JCWhtbV92bWFfd2Fsay5m
bGFncyA9IGZsYWdzOwotCQlobW1fdm1hX3dhbGsucmFuZ2UgPSByYW5nZTsKLQkJZW5kID0gbWlu
KHJhbmdlLT5lbmQsIHZtYS0+dm1fZW5kKTsKKwkJLyogS2VlcCB0cnlpbmcgd2hpbGUgdGhlIHJh
bmdlIGlzIHZhbGlkLiAqLworCX0gd2hpbGUgKHJldCA9PSAtRUJVU1kgJiYgcmFuZ2UtPnZhbGlk
KTsKIAotCQl3YWxrX3BhZ2VfcmFuZ2Uodm1hLT52bV9tbSwgc3RhcnQsIGVuZCwgJmhtbV93YWxr
X29wcywKLQkJCQkmaG1tX3ZtYV93YWxrKTsKLQotCQlkbyB7Ci0JCQlyZXQgPSB3YWxrX3BhZ2Vf
cmFuZ2Uodm1hLT52bV9tbSwgc3RhcnQsIGVuZCwKLQkJCQkJJmhtbV93YWxrX29wcywgJmhtbV92
bWFfd2Fsayk7Ci0JCQlzdGFydCA9IGhtbV92bWFfd2Fsay5sYXN0OwotCi0JCQkvKiBLZWVwIHRy
eWluZyB3aGlsZSB0aGUgcmFuZ2UgaXMgdmFsaWQuICovCi0JCX0gd2hpbGUgKHJldCA9PSAtRUJV
U1kgJiYgcmFuZ2UtPnZhbGlkKTsKLQotCQlpZiAocmV0KSB7Ci0JCQl1bnNpZ25lZCBsb25nIGk7
Ci0KLQkJCWkgPSAoaG1tX3ZtYV93YWxrLmxhc3QgLSByYW5nZS0+c3RhcnQpID4+IFBBR0VfU0hJ
RlQ7Ci0JCQlobW1fcGZuc19jbGVhcihyYW5nZSwgJnJhbmdlLT5wZm5zW2ldLAotCQkJCWhtbV92
bWFfd2Fsay5sYXN0LCByYW5nZS0+ZW5kKTsKLQkJCXJldHVybiByZXQ7Ci0JCX0KLQkJc3RhcnQg
PSBlbmQ7Ci0KLQl9IHdoaWxlIChzdGFydCA8IHJhbmdlLT5lbmQpOworCWlmIChyZXQpCisJCXJl
dHVybiByZXQ7CiAKIAlyZXR1cm4gKGhtbV92bWFfd2Fsay5sYXN0IC0gcmFuZ2UtPnN0YXJ0KSA+
PiBQQUdFX1NISUZUOwogfQotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0
cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9s
aXN0aW5mby9kcmktZGV2ZWw=
