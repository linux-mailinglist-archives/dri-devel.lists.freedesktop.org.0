Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 14949B27E8
	for <lists+dri-devel@lfdr.de>; Sat, 14 Sep 2019 00:05:28 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 70B9E6F477;
	Fri, 13 Sep 2019 22:05:25 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8D8466F475;
 Fri, 13 Sep 2019 22:05:23 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx01.intmail.prod.int.phx2.redhat.com
 [10.5.11.11])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 20B2710CC1EC;
 Fri, 13 Sep 2019 22:05:23 +0000 (UTC)
Received: from malachite.bss.redhat.com (dhcp-10-20-1-34.bss.redhat.com
 [10.20.1.34])
 by smtp.corp.redhat.com (Postfix) with ESMTP id F0E6C600CE;
 Fri, 13 Sep 2019 22:05:21 +0000 (UTC)
From: Lyude Paul <lyude@redhat.com>
To: nouveau@lists.freedesktop.org
Subject: [PATCH 3/4] drm/nouveau: dispnv50: Use less encoders by making mstos
 per-head
Date: Fri, 13 Sep 2019 18:03:52 -0400
Message-Id: <20190913220355.6883-3-lyude@redhat.com>
In-Reply-To: <20190913220355.6883-1-lyude@redhat.com>
References: <20190913220355.6883-1-lyude@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.11
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.65]); Fri, 13 Sep 2019 22:05:23 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>,
 Peteris Rudzusiks <peteris.rudzusiks@gmail.com>, linux-kernel@vger.kernel.org,
 dri-devel@lists.freedesktop.org, Ben Skeggs <bskeggs@redhat.com>,
 Sam Ravnborg <sam@ravnborg.org>,
 Laurent Pinchart <laurent.pinchart@ideasonboard.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

Q3VycmVudGx5LCBmb3IgZXZlcnkgc2luZ2xlIE1TVCBjYXBhYmxlIERSTSBjb25uZWN0b3Igd2Ug
Y3JlYXRlIGEgc2V0IG9mCmZha2UgZW5jb2RlcnMsIG9uZSBmb3IgZWFjaCBwb3NzaWJsZSBoZWFk
LiBVbmZvcnR1bmF0ZWx5IHRoaXMgZW5kcyB1cApiZWluZyBhIGh1Z2Ugd2FzdGUgb2YgZW5jb2Rl
cnMuIFdoaWxlIHRoaXMgY3VycmVudGx5IGlzbid0IGNhdXNpbmcgdXMKYW55IHByb2JsZW1zLCBp
dCdzIGV4dHJlbWVseSBjbG9zZSB0byBkb2luZyBzby4KClRoZSBUaGlua1BhZCBQNzEgaXMgYSBn
b29kIGV4YW1wbGUgb2YgdGhpcy4gT3JpZ2luYWxseSB3aGVuIHRyeWluZyB0bwpmaWd1cmUgb3V0
IHdoeSBub3V2ZWF1IHdhcyBmYWlsaW5nIHRvIGxvYWQgb24gdGhpcyBsYXB0b3AsIEkgZGlzY292
ZXJlZAppdCB3YXMgYmVjYXVzZSBub3V2ZWF1IHdhcyBjcmVhdGluZyB0b28gbWFueSBlbmNvZGVy
cy4gVGhpcyBlbmRlZCB1cApiZWluZyBiZWNhdXNlIHdlIHdlcmUgbWlzdGFrZW5seSBjcmVhdGlu
ZyBNU1QgZW5jb2RlcnMgZm9yIHRoZSBlRFAgcG9ydCwKaG93ZXZlciB3ZSBhcmUgc3RpbGwgZXh0
cmVtZWx5IGNsb3NlIHRvIGhpdHRpbmcgdGhlIGVuY29kZXIgbGltaXQgb24KdGhpcyBtYWNoaW5l
IGFzIGl0IGV4cG9zZXMgMSBlRFAgcG9ydCBhbmQgNSBEUCBwb3J0cywgcmVzdWx0aW5nIGluIDMx
CmVuY29kZXJzLgoKU28gd2hpbGUgdGhpcyBmaXggZGlkbid0IGVuZCB1cCBiZWluZyBuZWNlc3Nh
cnkgdG8gZml4IHRoZSBQNzEsIHdlIHN0aWxsCm5lZWQgdG8gaW1wbGVtZW50IHRoaXMgc28gdGhh
dCB3ZSBhdm9pZCBoaXR0aW5nIHRoZSBlbmNvZGVyIGxpbWl0IGZvcgp2YWxpZCBkaXNwbGF5IGNv
bmZpZ3VyYXRpb25zIGluIHRoZSBldmVudCB0aGF0IHNvbWUgbWFjaGluZSB3aXRoIG1vcmUKY29u
bmVjdG9ycyB0aGVuIHRoaXMgYmVjb21lcyBhdmFpbGFibGUuIFBsdXMsIHdlIGRvbid0IHdhbnQg
dG8gbGV0IGdvb2QKY29kZSBnbyB0byB3YXN0ZSA6KQoKU28sIHVzZSBsZXNzIGVuY29kZXJzIGJ5
IG9ubHkgY3JlYXRpbmcgb25lIE1TVE8gcGVyIGhlYWQuIFRoZW4sIGF0dGFjaAplYWNoIG5ldyBN
U1RDIHRvIGVhY2ggTVNUTyB3aGljaCBjb3JyZXNwb25kcyB0byBhIGhlYWQgdGhhdCBpdCdzIHBh
cmVudApEUCBwb3J0IGlzIGNhcGFibGUgb2YgdXNpbmcuIFRoaXMgYnJpbmdzIHRoZSBudW1iZXIg
b2YgZW5jb2RlcnMgd2UKcmVnaXN0ZXIgb24gdGhlIFRoaW5rUGFkIFA3MSBmcm9tIDMxLCBkb3du
IHRvIGp1c3QgMTUuIFlheSEKClNpZ25lZC1vZmYtYnk6IEx5dWRlIFBhdWwgPGx5dWRlQHJlZGhh
dC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvZGlzcG52NTAvZGlzcC5jIHwgOTIg
KysrKysrKysrKysrKysrLS0tLS0tLS0tLQogZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvZGlzcG52
NTAvZGlzcC5oIHwgIDIgKwogZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvZGlzcG52NTAvaGVhZC5j
IHwgMTcgKysrLS0KIGRyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2hlYWQuaCB8ICAz
ICstCiA0IGZpbGVzIGNoYW5nZWQsIDY4IGluc2VydGlvbnMoKyksIDQ2IGRlbGV0aW9ucygtKQoK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2Rpc3AuYyBiL2Ry
aXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2Rpc3AuYwppbmRleCBhM2YzNTBmZGZhOGMu
LmQyM2FjMTM3NjNiNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvZGlzcG52
NTAvZGlzcC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2Rpc3AuYwpA
QCAtNjUwLDcgKzY1MCw2IEBAIHN0cnVjdCBudjUwX21zdG0gewogCXN0cnVjdCBub3V2ZWF1X2Vu
Y29kZXIgKm91dHA7CiAKIAlzdHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3IgbWdyOwotCXN0
cnVjdCBudjUwX21zdG8gKm1zdG9bNF07CiAKIAlib29sIG1vZGlmaWVkOwogCWJvb2wgZGlzYWJs
ZWQ7CkBAIC03MTYsNyArNzE1LDYgQEAgbnY1MF9tc3RvX2NsZWFudXAoc3RydWN0IG52NTBfbXN0
byAqbXN0bykKIAlkcm1fZHBfbXN0X2RlYWxsb2NhdGVfdmNwaSgmbXN0bS0+bWdyLCBtc3RjLT5w
b3J0KTsKIAogCW1zdG8tPm1zdGMgPSBOVUxMOwotCW1zdG8tPmhlYWQgPSBOVUxMOwogCW1zdG8t
PmRpc2FibGVkID0gZmFsc2U7CiB9CiAKQEAgLTg0Niw3ICs4NDQsNiBAQCBudjUwX21zdG9fZW5h
YmxlKHN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcikKIAogCW1zdG0tPm91dHAtPnVwZGF0ZSht
c3RtLT5vdXRwLCBoZWFkLT5iYXNlLmluZGV4LCBhcm1oLCBwcm90bywgZGVwdGgpOwogCi0JbXN0
by0+aGVhZCA9IGhlYWQ7CiAJbXN0by0+bXN0YyA9IG1zdGM7CiAJbXN0bS0+bW9kaWZpZWQgPSB0
cnVlOwogfQpAQCAtODg3LDM3ICs4ODQsNDAgQEAgbnY1MF9tc3RvID0gewogCS5kZXN0cm95ID0g
bnY1MF9tc3RvX2Rlc3Ryb3ksCiB9OwogCi1zdGF0aWMgaW50Ci1udjUwX21zdG9fbmV3KHN0cnVj
dCBkcm1fZGV2aWNlICpkZXYsIHUzMiBoZWFkcywgY29uc3QgY2hhciAqbmFtZSwgaW50IGlkLAot
CSAgICAgIHN0cnVjdCBudjUwX21zdG8gKipwbXN0bykKK3N0YXRpYyBzdHJ1Y3QgbnY1MF9tc3Rv
ICoKK252NTBfbXN0b19uZXcoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IG52NTBfaGVh
ZCAqaGVhZCwgaW50IGlkKQogewogCXN0cnVjdCBudjUwX21zdG8gKm1zdG87CiAJaW50IHJldDsK
IAotCWlmICghKG1zdG8gPSAqcG1zdG8gPSBremFsbG9jKHNpemVvZigqbXN0byksIEdGUF9LRVJO
RUwpKSkKLQkJcmV0dXJuIC1FTk9NRU07CisJbXN0byA9IGt6YWxsb2Moc2l6ZW9mKCptc3RvKSwg
R0ZQX0tFUk5FTCk7CisJaWYgKCFtc3RvKQorCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKIAog
CXJldCA9IGRybV9lbmNvZGVyX2luaXQoZGV2LCAmbXN0by0+ZW5jb2RlciwgJm52NTBfbXN0bywK
LQkJCSAgICAgICBEUk1fTU9ERV9FTkNPREVSX0RQTVNULCAiJXMtbXN0LSVkIiwgbmFtZSwgaWQp
OworCQkJICAgICAgIERSTV9NT0RFX0VOQ09ERVJfRFBNU1QsICJtc3QtJWQiLCBpZCk7CiAJaWYg
KHJldCkgewotCQlrZnJlZSgqcG1zdG8pOwotCQkqcG1zdG8gPSBOVUxMOwotCQlyZXR1cm4gcmV0
OworCQlrZnJlZShtc3RvKTsKKwkJcmV0dXJuIEVSUl9QVFIocmV0KTsKIAl9CiAKIAlkcm1fZW5j
b2Rlcl9oZWxwZXJfYWRkKCZtc3RvLT5lbmNvZGVyLCAmbnY1MF9tc3RvX2hlbHApOwotCW1zdG8t
PmVuY29kZXIucG9zc2libGVfY3J0Y3MgPSBoZWFkczsKLQlyZXR1cm4gMDsKKwltc3RvLT5lbmNv
ZGVyLnBvc3NpYmxlX2NydGNzID0gZHJtX2NydGNfbWFzaygmaGVhZC0+YmFzZS5iYXNlKTsKKwlt
c3RvLT5oZWFkID0gaGVhZDsKKwlyZXR1cm4gbXN0bzsKIH0KIAogc3RhdGljIHN0cnVjdCBkcm1f
ZW5jb2RlciAqCiBudjUwX21zdGNfYXRvbWljX2Jlc3RfZW5jb2RlcihzdHJ1Y3QgZHJtX2Nvbm5l
Y3RvciAqY29ubmVjdG9yLAogCQkJICAgICAgc3RydWN0IGRybV9jb25uZWN0b3Jfc3RhdGUgKmNv
bm5lY3Rvcl9zdGF0ZSkKIHsKLQlzdHJ1Y3QgbnY1MF9oZWFkICpoZWFkID0gbnY1MF9oZWFkKGNv
bm5lY3Rvcl9zdGF0ZS0+Y3J0Yyk7CiAJc3RydWN0IG52NTBfbXN0YyAqbXN0YyA9IG52NTBfbXN0
Yyhjb25uZWN0b3IpOworCXN0cnVjdCBkcm1fY3J0YyAqY3J0YyA9IGNvbm5lY3Rvcl9zdGF0ZS0+
Y3J0YzsKIAotCXJldHVybiAmbXN0Yy0+bXN0bS0+bXN0b1toZWFkLT5iYXNlLmluZGV4XS0+ZW5j
b2RlcjsKKwlpZiAoIShtc3RjLT5tc3RtLT5vdXRwLT5kY2ItPmhlYWRzICYgZHJtX2NydGNfbWFz
ayhjcnRjKSkpCisJCXJldHVybiBOVUxMOworCisJcmV0dXJuICZudjUwX2hlYWQoY3J0YyktPm1z
dG8tPmVuY29kZXI7CiB9CiAKIHN0YXRpYyBlbnVtIGRybV9tb2RlX3N0YXR1cwpAQCAtMTAzNiw4
ICsxMDM2LDkgQEAgbnY1MF9tc3RjX25ldyhzdHJ1Y3QgbnY1MF9tc3RtICptc3RtLCBzdHJ1Y3Qg
ZHJtX2RwX21zdF9wb3J0ICpwb3J0LAogCSAgICAgIGNvbnN0IGNoYXIgKnBhdGgsIHN0cnVjdCBu
djUwX21zdGMgKipwbXN0YykKIHsKIAlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gbXN0bS0+b3V0
cC0+YmFzZS5iYXNlLmRldjsKKwlzdHJ1Y3QgZHJtX2NydGMgKmNydGM7CiAJc3RydWN0IG52NTBf
bXN0YyAqbXN0YzsKLQlpbnQgcmV0LCBpOworCWludCByZXQ7CiAKIAlpZiAoIShtc3RjID0gKnBt
c3RjID0ga3phbGxvYyhzaXplb2YoKm1zdGMpLCBHRlBfS0VSTkVMKSkpCiAJCXJldHVybiAtRU5P
TUVNOwpAQCAtMTA1Nyw4ICsxMDU4LDEzIEBAIG52NTBfbXN0Y19uZXcoc3RydWN0IG52NTBfbXN0
bSAqbXN0bSwgc3RydWN0IGRybV9kcF9tc3RfcG9ydCAqcG9ydCwKIAltc3RjLT5jb25uZWN0b3Iu
ZnVuY3MtPnJlc2V0KCZtc3RjLT5jb25uZWN0b3IpOwogCW5vdXZlYXVfY29ubl9hdHRhY2hfcHJv
cGVydGllcygmbXN0Yy0+Y29ubmVjdG9yKTsKIAotCWZvciAoaSA9IDA7IGkgPCBBUlJBWV9TSVpF
KG1zdG0tPm1zdG8pICYmIG1zdG0tPm1zdG9baV07IGkrKykKLQkJZHJtX2Nvbm5lY3Rvcl9hdHRh
Y2hfZW5jb2RlcigmbXN0Yy0+Y29ubmVjdG9yLCAmbXN0bS0+bXN0b1tpXS0+ZW5jb2Rlcik7CisJ
ZHJtX2Zvcl9lYWNoX2NydGMoY3J0YywgZGV2KSB7CisJCWlmICghKG1zdG0tPm91dHAtPmRjYi0+
aGVhZHMgJiBkcm1fY3J0Y19tYXNrKGNydGMpKSkKKwkJCWNvbnRpbnVlOworCisJCWRybV9jb25u
ZWN0b3JfYXR0YWNoX2VuY29kZXIoJm1zdGMtPmNvbm5lY3RvciwKKwkJCQkJICAgICAmbnY1MF9o
ZWFkKGNydGMpLT5tc3RvLT5lbmNvZGVyKTsKKwl9CiAKIAlkcm1fb2JqZWN0X2F0dGFjaF9wcm9w
ZXJ0eSgmbXN0Yy0+Y29ubmVjdG9yLmJhc2UsIGRldi0+bW9kZV9jb25maWcucGF0aF9wcm9wZXJ0
eSwgMCk7CiAJZHJtX29iamVjdF9hdHRhY2hfcHJvcGVydHkoJm1zdGMtPmNvbm5lY3Rvci5iYXNl
LCBkZXYtPm1vZGVfY29uZmlnLnRpbGVfcHJvcGVydHksIDApOwpAQCAtMTMzMiw3ICsxMzM4LDcg
QEAgbnY1MF9tc3RtX25ldyhzdHJ1Y3Qgbm91dmVhdV9lbmNvZGVyICpvdXRwLCBzdHJ1Y3QgZHJt
X2RwX2F1eCAqYXV4LCBpbnQgYXV4X21heCwKIAljb25zdCBpbnQgbWF4X3BheWxvYWRzID0gaHdl
aWdodDgob3V0cC0+ZGNiLT5oZWFkcyk7CiAJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IG91dHAt
PmJhc2UuYmFzZS5kZXY7CiAJc3RydWN0IG52NTBfbXN0bSAqbXN0bTsKLQlpbnQgcmV0LCBpOwor
CWludCByZXQ7CiAJdTggZHBjZDsKIAogCS8qIFRoaXMgaXMgYSB3b3JrYXJvdW5kIGZvciBzb21l
IG1vbml0b3JzIG5vdCBmdW5jdGlvbmluZwpAQCAtMTM1NSwxMyArMTM2MSw2IEBAIG52NTBfbXN0
bV9uZXcoc3RydWN0IG5vdXZlYXVfZW5jb2RlciAqb3V0cCwgc3RydWN0IGRybV9kcF9hdXggKmF1
eCwgaW50IGF1eF9tYXgsCiAJaWYgKHJldCkKIAkJcmV0dXJuIHJldDsKIAotCWZvciAoaSA9IDA7
IGkgPCBtYXhfcGF5bG9hZHM7IGkrKykgewotCQlyZXQgPSBudjUwX21zdG9fbmV3KGRldiwgb3V0
cC0+ZGNiLT5oZWFkcywgb3V0cC0+YmFzZS5iYXNlLm5hbWUsCi0JCQkJICAgIGksICZtc3RtLT5t
c3RvW2ldKTsKLQkJaWYgKHJldCkKLQkJCXJldHVybiByZXQ7Ci0JfQotCiAJcmV0dXJuIDA7CiB9
CiAKQEAgLTE1NDAsMTcgKzE1MzksMjQgQEAgbnY1MF9zb3JfZnVuYyA9IHsKIAkuZGVzdHJveSA9
IG52NTBfc29yX2Rlc3Ryb3ksCiB9OwogCitzdGF0aWMgYm9vbCBudjUwX2hhc19tc3Qoc3RydWN0
IG5vdXZlYXVfZHJtICpkcm0pCit7CisJc3RydWN0IG52a21fYmlvcyAqYmlvcyA9IG52eHhfYmlv
cygmZHJtLT5jbGllbnQuZGV2aWNlKTsKKwl1MzIgZGF0YTsKKwl1OCB2ZXIsIGhkciwgY250LCBs
ZW47CisKKwlkYXRhID0gbnZiaW9zX2RwX3RhYmxlKGJpb3MsICZ2ZXIsICZoZHIsICZjbnQsICZs
ZW4pOworCXJldHVybiBkYXRhICYmIHZlciA+PSAweDQwICYmIChudmJpb3NfcmQwOChiaW9zLCBk
YXRhICsgMHgwOCkgJiAweDA0KTsKK30KKwogc3RhdGljIGludAogbnY1MF9zb3JfY3JlYXRlKHN0
cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IsIHN0cnVjdCBkY2Jfb3V0cHV0ICpkY2JlKQog
ewogCXN0cnVjdCBub3V2ZWF1X2Nvbm5lY3RvciAqbnZfY29ubmVjdG9yID0gbm91dmVhdV9jb25u
ZWN0b3IoY29ubmVjdG9yKTsKIAlzdHJ1Y3Qgbm91dmVhdV9kcm0gKmRybSA9IG5vdXZlYXVfZHJt
KGNvbm5lY3Rvci0+ZGV2KTsKLQlzdHJ1Y3QgbnZrbV9iaW9zICpiaW9zID0gbnZ4eF9iaW9zKCZk
cm0tPmNsaWVudC5kZXZpY2UpOwogCXN0cnVjdCBudmttX2kyYyAqaTJjID0gbnZ4eF9pMmMoJmRy
bS0+Y2xpZW50LmRldmljZSk7CiAJc3RydWN0IG5vdXZlYXVfZW5jb2RlciAqbnZfZW5jb2RlcjsK
IAlzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29kZXI7Ci0JdTggdmVyLCBoZHIsIGNudCwgbGVuOwot
CXUzMiBkYXRhOwogCWludCB0eXBlLCByZXQ7CiAKIAlzd2l0Y2ggKGRjYmUtPnR5cGUpIHsKQEAg
LTE1OTUsMTAgKzE2MDEsOSBAQCBudjUwX3Nvcl9jcmVhdGUoc3RydWN0IGRybV9jb25uZWN0b3Ig
KmNvbm5lY3Rvciwgc3RydWN0IGRjYl9vdXRwdXQgKmRjYmUpCiAJCX0KIAogCQlpZiAobnZfY29u
bmVjdG9yLT50eXBlICE9IERDQl9DT05ORUNUT1JfZURQICYmCi0JCSAgICAoZGF0YSA9IG52Ymlv
c19kcF90YWJsZShiaW9zLCAmdmVyLCAmaGRyLCAmY250LCAmbGVuKSkgJiYKLQkJICAgIHZlciA+
PSAweDQwICYmIChudmJpb3NfcmQwOChiaW9zLCBkYXRhICsgMHgwOCkgJiAweDA0KSkgewotCQkJ
cmV0ID0gbnY1MF9tc3RtX25ldyhudl9lbmNvZGVyLCAmbnZfY29ubmVjdG9yLT5hdXgsIDE2LAot
CQkJCQkgICAgbnZfY29ubmVjdG9yLT5iYXNlLmJhc2UuaWQsCisJCSAgICBudjUwX2hhc19tc3Qo
ZHJtKSkgeworCQkJcmV0ID0gbnY1MF9tc3RtX25ldyhudl9lbmNvZGVyLCAmbnZfY29ubmVjdG9y
LT5hdXgsCisJCQkJCSAgICAxNiwgbnZfY29ubmVjdG9yLT5iYXNlLmJhc2UuaWQsCiAJCQkJCSAg
ICAmbnZfZW5jb2Rlci0+ZHAubXN0bSk7CiAJCQlpZiAocmV0KQogCQkJCXJldHVybiByZXQ7CkBA
IC0yMjk0LDYgKzIyOTksNyBAQCBudjUwX2Rpc3BsYXlfY3JlYXRlKHN0cnVjdCBkcm1fZGV2aWNl
ICpkZXYpCiAJc3RydWN0IG52NTBfZGlzcCAqZGlzcDsKIAlzdHJ1Y3QgZGNiX291dHB1dCAqZGNi
ZTsKIAlpbnQgY3J0Y3MsIHJldCwgaTsKKwlib29sIGhhc19tc3QgPSBudjUwX2hhc19tc3QoZHJt
KTsKIAogCWRpc3AgPSBremFsbG9jKHNpemVvZigqZGlzcCksIEdGUF9LRVJORUwpOwogCWlmICgh
ZGlzcCkKQEAgLTIzNDIsMTEgKzIzNDgsMjUgQEAgbnY1MF9kaXNwbGF5X2NyZWF0ZShzdHJ1Y3Qg
ZHJtX2RldmljZSAqZGV2KQogCQljcnRjcyA9IDB4MzsKIAogCWZvciAoaSA9IDA7IGkgPCBmbHMo
Y3J0Y3MpOyBpKyspIHsKKwkJc3RydWN0IG52NTBfaGVhZCAqaGVhZDsKKwogCQlpZiAoIShjcnRj
cyAmICgxIDw8IGkpKSkKIAkJCWNvbnRpbnVlOwotCQlyZXQgPSBudjUwX2hlYWRfY3JlYXRlKGRl
diwgaSk7Ci0JCWlmIChyZXQpCisKKwkJaGVhZCA9IG52NTBfaGVhZF9jcmVhdGUoZGV2LCBpKTsK
KwkJaWYgKElTX0VSUihoZWFkKSkgeworCQkJcmV0ID0gUFRSX0VSUihoZWFkKTsKIAkJCWdvdG8g
b3V0OworCQl9CisKKwkJaWYgKGhhc19tc3QpIHsKKwkJCWhlYWQtPm1zdG8gPSBudjUwX21zdG9f
bmV3KGRldiwgaGVhZCwgaSk7CisJCQlpZiAoSVNfRVJSKGhlYWQtPm1zdG8pKSB7CisJCQkJcmV0
ID0gUFRSX0VSUihoZWFkLT5tc3RvKTsKKwkJCQloZWFkLT5tc3RvID0gTlVMTDsKKwkJCQlnb3Rv
IG91dDsKKwkJCX0KKwkJfQogCX0KIAogCS8qIGNyZWF0ZSBlbmNvZGVyL2Nvbm5lY3RvciBvYmpl
Y3RzIGJhc2VkIG9uIFZCSU9TIERDQiB0YWJsZSAqLwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL25vdXZlYXUvZGlzcG52NTAvZGlzcC5oIGIvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvZGlz
cG52NTAvZGlzcC5oCmluZGV4IDdjNDFiMDU5OWQxYS4uYjE2ZjRhYTA5ZTAyIDEwMDY0NAotLS0g
YS9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9kaXNwbnY1MC9kaXNwLmgKKysrIGIvZHJpdmVycy9n
cHUvZHJtL25vdXZlYXUvZGlzcG52NTAvZGlzcC5oCkBAIC00LDYgKzQsOCBAQAogCiAjaW5jbHVk
ZSAibm91dmVhdV9kaXNwbGF5LmgiCiAKK3N0cnVjdCBudjUwX21zdG87CisKIHN0cnVjdCBudjUw
X2Rpc3AgewogCXN0cnVjdCBudmlmX2Rpc3AgKmRpc3A7CiAJc3RydWN0IG52NTBfY29yZSAqY29y
ZTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2hlYWQuYyBi
L2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2hlYWQuYwppbmRleCA3MWMyM2JmMWZl
MjUuLmJkMmY2YmY1ZWRmZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvZGlz
cG52NTAvaGVhZC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2hlYWQu
YwpAQCAtNDc0LDcgKzQ3NCw3IEBAIG52NTBfaGVhZF9mdW5jID0gewogCS5hdG9taWNfZGVzdHJv
eV9zdGF0ZSA9IG52NTBfaGVhZF9hdG9taWNfZGVzdHJveV9zdGF0ZSwKIH07CiAKLWludAorc3Ry
dWN0IG52NTBfaGVhZCAqCiBudjUwX2hlYWRfY3JlYXRlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYs
IGludCBpbmRleCkKIHsKIAlzdHJ1Y3Qgbm91dmVhdV9kcm0gKmRybSA9IG5vdXZlYXVfZHJtKGRl
dik7CkBAIC00ODYsNyArNDg2LDcgQEAgbnY1MF9oZWFkX2NyZWF0ZShzdHJ1Y3QgZHJtX2Rldmlj
ZSAqZGV2LCBpbnQgaW5kZXgpCiAKIAloZWFkID0ga3phbGxvYyhzaXplb2YoKmhlYWQpLCBHRlBf
S0VSTkVMKTsKIAlpZiAoIWhlYWQpCi0JCXJldHVybiAtRU5PTUVNOworCQlyZXR1cm4gRVJSX1BU
UigtRU5PTUVNKTsKIAogCWhlYWQtPmZ1bmMgPSBkaXNwLT5jb3JlLT5mdW5jLT5oZWFkOwogCWhl
YWQtPmJhc2UuaW5kZXggPSBpbmRleDsKQEAgLTUwNCw3ICs1MDQsNyBAQCBudjUwX2hlYWRfY3Jl
YXRlKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsIGludCBpbmRleCkKIAkJcmV0ID0gbnY1MF9jdXJz
X25ldyhkcm0sIGhlYWQtPmJhc2UuaW5kZXgsICZjdXJzKTsKIAlpZiAocmV0KSB7CiAJCWtmcmVl
KGhlYWQpOwotCQlyZXR1cm4gcmV0OworCQlyZXR1cm4gRVJSX1BUUihyZXQpOwogCX0KIAogCWNy
dGMgPSAmaGVhZC0+YmFzZS5iYXNlOwpAQCAtNTE5LDEyICs1MTksMTEgQEAgbnY1MF9oZWFkX2Ny
ZWF0ZShzdHJ1Y3QgZHJtX2RldmljZSAqZGV2LCBpbnQgaW5kZXgpCiAKIAlpZiAoaGVhZC0+ZnVu
Yy0+b2x1dF9zZXQpIHsKIAkJcmV0ID0gbnY1MF9sdXRfaW5pdChkaXNwLCAmZHJtLT5jbGllbnQu
bW11LCAmaGVhZC0+b2x1dCk7Ci0JCWlmIChyZXQpCi0JCQlnb3RvIG91dDsKKwkJaWYgKHJldCkg
eworCQkJbnY1MF9oZWFkX2Rlc3Ryb3koY3J0Yyk7CisJCQlyZXR1cm4gRVJSX1BUUihyZXQpOwor
CQl9CiAJfQogCi1vdXQ6Ci0JaWYgKHJldCkKLQkJbnY1MF9oZWFkX2Rlc3Ryb3koY3J0Yyk7Ci0J
cmV0dXJuIHJldDsKKwlyZXR1cm4gaGVhZDsKIH0KZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2Ry
bS9ub3V2ZWF1L2Rpc3BudjUwL2hlYWQuaCBiL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L2Rpc3Bu
djUwL2hlYWQuaAppbmRleCBkMWMwMDJmNTM0ZDQuLmYzMWVmNWUwN2Y0MyAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvZGlzcG52NTAvaGVhZC5oCisrKyBiL2RyaXZlcnMvZ3B1
L2RybS9ub3V2ZWF1L2Rpc3BudjUwL2hlYWQuaApAQCAtMTEsOSArMTEsMTAgQEAgc3RydWN0IG52
NTBfaGVhZCB7CiAJY29uc3Qgc3RydWN0IG52NTBfaGVhZF9mdW5jICpmdW5jOwogCXN0cnVjdCBu
b3V2ZWF1X2NydGMgYmFzZTsKIAlzdHJ1Y3QgbnY1MF9sdXQgb2x1dDsKKwlzdHJ1Y3QgbnY1MF9t
c3RvICptc3RvOwogfTsKIAotaW50IG52NTBfaGVhZF9jcmVhdGUoc3RydWN0IGRybV9kZXZpY2Ug
KiwgaW50IGluZGV4KTsKK3N0cnVjdCBudjUwX2hlYWQgKm52NTBfaGVhZF9jcmVhdGUoc3RydWN0
IGRybV9kZXZpY2UgKiwgaW50IGluZGV4KTsKIHZvaWQgbnY1MF9oZWFkX2ZsdXNoX3NldChzdHJ1
Y3QgbnY1MF9oZWFkICosIHN0cnVjdCBudjUwX2hlYWRfYXRvbSAqKTsKIHZvaWQgbnY1MF9oZWFk
X2ZsdXNoX2NscihzdHJ1Y3QgbnY1MF9oZWFkICosIHN0cnVjdCBudjUwX2hlYWRfYXRvbSAqLCBi
b29sIHkpOwogCi0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L2RyaS1kZXZlbA==
