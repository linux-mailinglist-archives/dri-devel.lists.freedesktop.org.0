Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C42C72CBCF
	for <lists+dri-devel@lfdr.de>; Tue, 28 May 2019 18:26:18 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E3DA26E22A;
	Tue, 28 May 2019 16:26:06 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x441.google.com (mail-wr1-x441.google.com
 [IPv6:2a00:1450:4864:20::441])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 952C96E21D;
 Tue, 28 May 2019 16:26:04 +0000 (UTC)
Received: by mail-wr1-x441.google.com with SMTP id c2so5742833wrm.8;
 Tue, 28 May 2019 09:26:04 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=Si8jP9ZwNKru6t4EQB1CQ7N1I/q9HhaLwNMrV21Yz3k=;
 b=bw6hl2PiJILLIV3CI84m2T5reh4FehRaDDj1CBehulL9DyLKtN9tqaUsm6fNfYERvd
 ktyBYwf0NxDGA2uMcER7MM9Jg6oUo3yQV+IOG/ASYjkKtX03vZBvuqG+Dt+wSVtiIAqG
 vzCFqHgZmbLf8ogjoU6Fr4smzAg/ZHWFJAFq1dsNMKeqDibXgIlSBfqZy2zv3AwagN6c
 1cHgkkweRuZtdDRYiz5G2wQhGSG3qORXO84ZOqw01I2iRYR1u3ghGwgAyt0naloC0qeW
 EAzHnm41DgtZf8E/0DPo20zn2DhdW07XDmirO7pdmgk3tZgaF8jtND2X5PL/qIYKMmEz
 KW/Q==
X-Gm-Message-State: APjAAAXvyGPFlccVLaazaYSHYXsQlfyZ9lzbcV3M7y5xWoFJFAsZozkP
 FlWQiMphTxNL/yUlQjuF9hR1skCs
X-Google-Smtp-Source: APXvYqypNMrQ1ZxgIlspGVU21BHj1WbLRlLEVz1LzEcfeyDjIVTKwAMz5aACCTIVovYHITc+7rsCOg==
X-Received: by 2002:adf:b6a5:: with SMTP id j37mr75639955wre.4.1559060763086; 
 Tue, 28 May 2019 09:26:03 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:3163:ab92:73d9:6693])
 by smtp.gmail.com with ESMTPSA id f10sm28835470wrg.24.2019.05.28.09.26.02
 (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
 Tue, 28 May 2019 09:26:02 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: David1.Zhou@amd.com, Marek.Olsak@amd.com, Prike.Liang@amd.com,
 dri-devel@lists.freedesktop.org, amd-gfx@lists.freedesktop.org
Subject: [PATCH 05/10] drm/ttm: immediately move BOs to the new LRU v2
Date: Tue, 28 May 2019 18:25:52 +0200
Message-Id: <20190528162557.1280-5-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190528162557.1280-1-christian.koenig@amd.com>
References: <20190528162557.1280-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references:mime-version
 :content-transfer-encoding;
 bh=Si8jP9ZwNKru6t4EQB1CQ7N1I/q9HhaLwNMrV21Yz3k=;
 b=Z7c7RZD56WU01LFGOvxewHwvFsNkPjyFXyHV+kwa0zIqgNr2rDJUlPlEuZLHFVWDHh
 hQ62oqbNuRFg8Kp00n2Y7fSD0db3hGxZGVsS6P2gTIF8ee7b80uVONd3yzACkjUdavUF
 Uo3lnBYfBTFxXZvvV7cAaCwFhMzdY9rVOV1Rcbx7Si0/5VS74aqRc7zb+Ja6MyInyIDH
 Wz0xmvzHFeA1m+2yvlisvBgmwCt3JO4FCI45h1rKZXoTNmFJZliKlPu1VTObMVNv+4qd
 9kKnXjhvmd7uLBZq1YQPtwwL/rWjdvBGCk0NpB91tzgga3MUl8el2ODwTCd4QWx0FZ4a
 4UxQ==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

TW92ZSBCT3Mgd2hpY2ggYXJlIGN1cnJlbnRseSBpbiBhIGxvd2VyIGRvbWFpbiB0byB0aGUgbmV3
CkxSVSBiZWZvcmUgYWxsb2NhdGluZyBiYWNraW5nIHNwYWNlIHdoaWxlIHZhbGlkYXRpbmcuCgpU
aGlzIG1ha2VzIHN1cmUgdGhhdCB3ZSBhbHdheXMgaGF2ZSBlbm91Z2ggZW50cmllcyBvbiB0aGUK
TFJVIHRvIGFsbG93IGZvciBvdGhlciBwcm9jZXNzZXMgdG8gd2FpdCBmb3IgYW4gb3BlcmF0aW9u
CnRvIGNvbXBsZXRlLgoKdjI6IGdlbmVyYWxpemUgdGhlIHRlc3QKClNpZ25lZC1vZmYtYnk6IENo
cmlzdGlhbiBLw7ZuaWcgPGNocmlzdGlhbi5rb2VuaWdAYW1kLmNvbT4KLS0tCiBkcml2ZXJzL2dw
dS9kcm0vdHRtL3R0bV9iby5jIHwgNDMgKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0tLS0t
LS0tCiAxIGZpbGUgY2hhbmdlZCwgMzMgaW5zZXJ0aW9ucygrKSwgMTAgZGVsZXRpb25zKC0pCgpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3R0bS90dG1fYm8uYyBiL2RyaXZlcnMvZ3B1L2Ry
bS90dG0vdHRtX2JvLmMKaW5kZXggMGRiYjIzYjBkZWRkLi4zYmMzMWRhMWRmNjcgMTAwNjQ0Ci0t
LSBhL2RyaXZlcnMvZ3B1L2RybS90dG0vdHRtX2JvLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3R0
bS90dG1fYm8uYwpAQCAtMTY2LDIwICsxNjYsMjIgQEAgc3RhdGljIHZvaWQgdHRtX2JvX3JlbGVh
c2VfbGlzdChzdHJ1Y3Qga3JlZiAqbGlzdF9rcmVmKQogCXR0bV9tZW1fZ2xvYmFsX2ZyZWUoYmRl
di0+Z2xvYi0+bWVtX2dsb2IsIGFjY19zaXplKTsKIH0KIAotdm9pZCB0dG1fYm9fYWRkX3RvX2xy
dShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvKQorc3RhdGljIHZvaWQgdHRtX2JvX2FkZF9t
ZW1fdG9fbHJ1KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCisJCQkJICBzdHJ1Y3QgdHRt
X21lbV9yZWcgKm1lbSkKIHsKIAlzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiA9IGJvLT5iZGV2
OwogCXN0cnVjdCB0dG1fbWVtX3R5cGVfbWFuYWdlciAqbWFuOwogCiAJcmVzZXJ2YXRpb25fb2Jq
ZWN0X2Fzc2VydF9oZWxkKGJvLT5yZXN2KTsKKwlCVUdfT04oIWxpc3RfZW1wdHkoJmJvLT5scnUp
KTsKIAogCWlmICghbGlzdF9lbXB0eSgmYm8tPmxydSkpCiAJCXJldHVybjsKIAotCWlmIChiby0+
bWVtLnBsYWNlbWVudCAmIFRUTV9QTF9GTEFHX05PX0VWSUNUKQorCWlmIChtZW0tPnBsYWNlbWVu
dCAmIFRUTV9QTF9GTEFHX05PX0VWSUNUKQogCQlyZXR1cm47CiAKLQltYW4gPSAmYmRldi0+bWFu
W2JvLT5tZW0ubWVtX3R5cGVdOworCW1hbiA9ICZiZGV2LT5tYW5bbWVtLT5tZW1fdHlwZV07CiAJ
bGlzdF9hZGRfdGFpbCgmYm8tPmxydSwgJm1hbi0+bHJ1W2JvLT5wcmlvcml0eV0pOwogCWtyZWZf
Z2V0KCZiby0+bGlzdF9rcmVmKTsKIApAQCAtMTg5LDYgKzE5MSwxMSBAQCB2b2lkIHR0bV9ib19h
ZGRfdG9fbHJ1KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8pCiAJCWtyZWZfZ2V0KCZiby0+
bGlzdF9rcmVmKTsKIAl9CiB9CisKK3ZvaWQgdHRtX2JvX2FkZF90b19scnUoc3RydWN0IHR0bV9i
dWZmZXJfb2JqZWN0ICpibykKK3sKKwl0dG1fYm9fYWRkX21lbV90b19scnUoYm8sICZiby0+bWVt
KTsKK30KIEVYUE9SVF9TWU1CT0wodHRtX2JvX2FkZF90b19scnUpOwogCiBzdGF0aWMgdm9pZCB0
dG1fYm9fcmVmX2J1ZyhzdHJ1Y3Qga3JlZiAqbGlzdF9rcmVmKQpAQCAtMTAwMSw2ICsxMDA4LDE0
IEBAIHN0YXRpYyBpbnQgdHRtX2JvX21lbV9wbGFjZW1lbnQoc3RydWN0IHR0bV9idWZmZXJfb2Jq
ZWN0ICpibywKIAogCW1lbS0+bWVtX3R5cGUgPSBtZW1fdHlwZTsKIAltZW0tPnBsYWNlbWVudCA9
IGN1cl9mbGFnczsKKworCWlmIChiby0+bWVtLm1lbV90eXBlIDwgbWVtX3R5cGUgJiYgIWxpc3Rf
ZW1wdHkoJmJvLT5scnUpKSB7CisJCXNwaW5fbG9jaygmYm8tPmJkZXYtPmdsb2ItPmxydV9sb2Nr
KTsKKwkJdHRtX2JvX2RlbF9mcm9tX2xydShibyk7CisJCXR0bV9ib19hZGRfbWVtX3RvX2xydShi
bywgbWVtKTsKKwkJc3Bpbl91bmxvY2soJmJvLT5iZGV2LT5nbG9iLT5scnVfbG9jayk7CisJfQor
CiAJcmV0dXJuIDA7CiB9CiAKQEAgLTEwMzQsNyArMTA0OSw3IEBAIGludCB0dG1fYm9fbWVtX3Nw
YWNlKHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJCWlmIChyZXQgPT0gLUVCVVNZKQog
CQkJY29udGludWU7CiAJCWlmIChyZXQpCi0JCQlyZXR1cm4gcmV0OworCQkJZ290byBlcnJvcjsK
IAogCQl0eXBlX2ZvdW5kID0gdHJ1ZTsKIAkJbWVtLT5tbV9ub2RlID0gTlVMTDsKQEAgLTEwNDQs
MTMgKzEwNTksMTMgQEAgaW50IHR0bV9ib19tZW1fc3BhY2Uoc3RydWN0IHR0bV9idWZmZXJfb2Jq
ZWN0ICpibywKIAkJbWFuID0gJmJkZXYtPm1hblttZW0tPm1lbV90eXBlXTsKIAkJcmV0ID0gKCpt
YW4tPmZ1bmMtPmdldF9ub2RlKShtYW4sIGJvLCBwbGFjZSwgbWVtKTsKIAkJaWYgKHVubGlrZWx5
KHJldCkpCi0JCQlyZXR1cm4gcmV0OworCQkJZ290byBlcnJvcjsKIAogCQlpZiAobWVtLT5tbV9u
b2RlKSB7CiAJCQlyZXQgPSB0dG1fYm9fYWRkX21vdmVfZmVuY2UoYm8sIG1hbiwgbWVtKTsKIAkJ
CWlmICh1bmxpa2VseShyZXQpKSB7CiAJCQkJKCptYW4tPmZ1bmMtPnB1dF9ub2RlKShtYW4sIG1l
bSk7Ci0JCQkJcmV0dXJuIHJldDsKKwkJCQlnb3RvIGVycm9yOwogCQkJfQogCQkJcmV0dXJuIDA7
CiAJCX0KQEAgLTEwNjMsNyArMTA3OCw3IEBAIGludCB0dG1fYm9fbWVtX3NwYWNlKHN0cnVjdCB0
dG1fYnVmZmVyX29iamVjdCAqYm8sCiAJCWlmIChyZXQgPT0gLUVCVVNZKQogCQkJY29udGludWU7
CiAJCWlmIChyZXQpCi0JCQlyZXR1cm4gcmV0OworCQkJZ290byBlcnJvcjsKIAogCQl0eXBlX2Zv
dW5kID0gdHJ1ZTsKIAkJbWVtLT5tbV9ub2RlID0gTlVMTDsKQEAgLTEwNzUsMTUgKzEwOTAsMjMg
QEAgaW50IHR0bV9ib19tZW1fc3BhY2Uoc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywKIAkJ
CXJldHVybiAwOwogCiAJCWlmIChyZXQgJiYgcmV0ICE9IC1FQlVTWSkKLQkJCXJldHVybiByZXQ7
CisJCQlnb3RvIGVycm9yOwogCX0KIAorCXJldCA9IC1FTk9NRU07CiAJaWYgKCF0eXBlX2ZvdW5k
KSB7CiAJCXByX2VycihUVE1fUEZYICJObyBjb21wYXRpYmxlIG1lbW9yeSB0eXBlIGZvdW5kXG4i
KTsKLQkJcmV0dXJuIC1FSU5WQUw7CisJCXJldCA9IC1FSU5WQUw7CiAJfQogCi0JcmV0dXJuIC1F
Tk9NRU07CitlcnJvcjoKKwlpZiAoYm8tPm1lbS5tZW1fdHlwZSA9PSBUVE1fUExfU1lTVEVNICYm
ICFsaXN0X2VtcHR5KCZiby0+bHJ1KSkgeworCQlzcGluX2xvY2soJmJvLT5iZGV2LT5nbG9iLT5s
cnVfbG9jayk7CisJCXR0bV9ib19tb3ZlX3RvX2xydV90YWlsKGJvLCBOVUxMKTsKKwkJc3Bpbl91
bmxvY2soJmJvLT5iZGV2LT5nbG9iLT5scnVfbG9jayk7CisJfQorCisJcmV0dXJuIHJldDsKIH0K
IEVYUE9SVF9TWU1CT0wodHRtX2JvX21lbV9zcGFjZSk7CiAKLS0gCjIuMTcuMQoKX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcg
bGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRl
c2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
