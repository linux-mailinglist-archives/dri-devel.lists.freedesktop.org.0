Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id DA8FD11039D
	for <lists+dri-devel@lfdr.de>; Tue,  3 Dec 2019 18:37:10 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9ED3E6EA37;
	Tue,  3 Dec 2019 17:37:08 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-yb1-xb41.google.com (mail-yb1-xb41.google.com
 [IPv6:2607:f8b0:4864:20::b41])
 by gabe.freedesktop.org (Postfix) with ESMTPS id F29896EA38
 for <dri-devel@lists.freedesktop.org>; Tue,  3 Dec 2019 17:37:06 +0000 (UTC)
Received: by mail-yb1-xb41.google.com with SMTP id o22so1312513ybg.6
 for <dri-devel@lists.freedesktop.org>; Tue, 03 Dec 2019 09:37:06 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=X6sNlVpgJqZUTF2LBDVfN2KTo3rKVtV7s8d4MgGBrfw=;
 b=FjgKa1CXkhJBTMNeiEGjIwn2XjbH8VsXBshqAE1hAfriLX0BXLle/Jxm4X0/LDaRzy
 uMmxaR1aBUlRO4bsw4ptR9+XvAOZWpYriBeEvuOyM89hIpjNiXZsujZtVWYGNAgs6Bly
 h/0f6IstTr+qwtZABAT+O1RZfAsWoqjZGuqQtr08tdcBFBJP5kVacUDnfb9qfgzmvNVg
 z9K82MREa8evVYHHhcZ3I8hyY1P1oHuC/cR0f6QDWTF+Ib+F1clA93A+8vAQVMSsVn/w
 HSDmnsUNs+QEGCk25yW7M+MWLCGdjW6B1BftCic2cjbTWu7MO5uxbZgfdj28qjoo2VUS
 566A==
X-Gm-Message-State: APjAAAXVvzCBLIQ1vpYQpRmHVlFA2nlcYCiBBn4ldJVvD2Pb59vDFh4n
 h7phwSivMB9THUBDvMzRe52eYdUCNCKScg==
X-Google-Smtp-Source: APXvYqwrYDr7iNgEM1SWLZi/pYA9DfnE9DJ3vVKeHlVWG0u5mpHYDQm6vWTYSGLc6nS7YrDj3ue3lw==
X-Received: by 2002:a5b:443:: with SMTP id s3mr5184402ybp.197.1575394625799;
 Tue, 03 Dec 2019 09:37:05 -0800 (PST)
Received: from rosewood.cam.corp.google.com
 ([2620:0:1013:11:89c6:2139:5435:371d])
 by smtp.gmail.com with ESMTPSA id g190sm1729426ywf.41.2019.12.03.09.37.05
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 03 Dec 2019 09:37:05 -0800 (PST)
From: Sean Paul <sean@poorly.run>
To: dri-devel@lists.freedesktop.org, intel-gfx@lists.freedesktop.org,
 ramalingm.c@intel.com
Subject: [PATCH 02/11] drm/i915: Intercept Aksv writes in the aux hooks
Date: Tue,  3 Dec 2019 12:36:25 -0500
Message-Id: <20191203173638.94919-3-sean@poorly.run>
X-Mailer: git-send-email 2.24.0.393.g34dc348eaf-goog
In-Reply-To: <20191203173638.94919-1-sean@poorly.run>
References: <20191203173638.94919-1-sean@poorly.run>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=poorly.run; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=X6sNlVpgJqZUTF2LBDVfN2KTo3rKVtV7s8d4MgGBrfw=;
 b=RwAWrscCqcMya1X9tIqHH5wnB6nWBRFhjyTj6QmoW1RgHHI5TanAQ7YmntUOlvCdQJ
 2C3uQ4QYT+s/uHX4moi9HbxNr+5x+C+JIl9fSnQ6KtgMTlbRS036FLUjdRyco4P4/qwM
 xFcurqbNROtmEHWq39n0O39IImvEWsJ2R83bEBt1t/an0JciM0Ej+GZkmYJMQi0LE7C8
 QmPr0elj4s7pzmxmpF6GVrmy7GQnVUyxTiHb/x1t42ULA5YnOof0egnV6/6OFAkMz1DL
 zfHgTKuvbeN6SA4fi35i5KeMdJQqha+FMNRe4AJEw5f3Pq1I9aLSXmcKOMGXz0DuDFcI
 jSBg==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, Sean Paul <seanpaul@chromium.org>,
 Rodrigo Vivi <rodrigo.vivi@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogU2VhbiBQYXVsIDxzZWFucGF1bEBjaHJvbWl1bS5vcmc+CgpJbnN0ZWFkIG9mIGhhbmQg
cm9sbGluZyB0aGUgdHJhbnNmZXIgb3Vyc2VsdmVzIGluIHRoZSBoZGNwIGhvb2ssIGluc3BlY3QK
YXV4IG1lc3NhZ2VzIGFuZCBhZGQgdGhlIGFrc3YgZmxhZyBpbiB0aGUgYXV4IHRyYW5zZmVyIGhv
b2suCgpJSVJDLCB0aGlzIHdhcyB0aGUgb3JpZ2luYWwgaW1wbGVtZW50YXRpb24gYW5kIGZvbGtz
IHdhbnRlZCB0aGlzIGhhY2sgdG8KYmUgaXNvbGF0ZWQgdG8gdGhlIGhkY3AgY29kZSwgd2hpY2gg
bWFrZXMgc2Vuc2UuCgpIb3dldmVyIGluIHRlc3RpbmcgYW4gTEcgbW9uaXRvciBvbiBteSBkZXNr
LCBJIG5vdGljZWQgaXQgd2FzIHBhc3NpbmcKYmFjayBhIERFRkVSIHJlcGx5LiBUaGlzIHdhc24n
dCBoYW5kbGVkIGluIG91ciBoYW5kLXJvbGxlZCBjb2RlIGFuZCBIRENQCmF1dGggd2FzIGZhaWxp
bmcgYXMgYSByZXN1bHQuIEluc3RlYWQgb2YgY29weS9wYXN0aW5nIGFsbCBvZiB0aGUgcmV0cnkK
bG9naWMgYW5kIGRlbGF5cyBmcm9tIGRybSBkcCBoZWxwZXJzLCBsZXQncyBqdXN0IHVzZSB0aGUg
aGVscGVycyBhbmQgaGlkZQp0aGUgYWtzdiBzZWxlY3QgYXMgYmVzdCBhcyB3ZSBjYW4uCgpTaWdu
ZWQtb2ZmLWJ5OiBTZWFuIFBhdWwgPHNlYW5wYXVsQGNocm9taXVtLm9yZz4KLS0tCiBkcml2ZXJz
L2dwdS9kcm0vaTkxNS9kaXNwbGF5L2ludGVsX2RwLmMgfCA2NCArKysrKysrKysrKystLS0tLS0t
LS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMzEgaW5zZXJ0aW9ucygrKSwgMzMgZGVsZXRpb25zKC0p
CgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kcC5jIGIv
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kcC5jCmluZGV4IGQ5NThlNzg5YWI5
Ni4uN2E0MDdjNjUxZmIyIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9kaXNwbGF5
L2ludGVsX2RwLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9kcC5j
CkBAIC0xNTE1LDEyICsxNTE1LDI5IEBAIGludGVsX2RwX2F1eF9oZWFkZXIodTggdHhidWZbSEVB
REVSX1NJWkVdLAogCXR4YnVmWzNdID0gbXNnLT5zaXplIC0gMTsKIH0KIAorc3RhdGljIHUzMiBp
bnRlbF9kcF9hdXhfZ2VuZXJhdGVfeGZlcl9mbGFncyhzdHJ1Y3QgZHJtX2RwX2F1eF9tc2cgKm1z
ZykKK3sKKwlpZiAoKG1zZy0+cmVxdWVzdCAmIH5EUF9BVVhfSTJDX01PVCkgIT0gRFBfQVVYX05B
VElWRV9XUklURSkKKwkJcmV0dXJuIDA7CisKKwkvKgorCSAqIElmIHdlJ3JlIHRyeWluZyB0byBz
ZW5kIHRoZSBIRENQIEFrc3YsIHdlIG5lZWQgdG8gc2V0IGEgdGhlIEFrc3YKKwkgKiBzZWxlY3Qg
Yml0IHRvIGluZm9ybSB0aGUgaGFyZHdhcmUgdG8gc2VuZCB0aGUgQWtzdiBhZnRlciBvdXIgaGVh
ZGVyCisJICogc2luY2Ugd2UgY2FuJ3QgYWNjZXNzIHRoYXQgZGF0YSBmcm9tIHNvZnR3YXJlLgor
CSAqLworCWlmIChtc2ctPmFkZHJlc3MgPT0gRFBfQVVYX0hEQ1BfQUtTVikKKwkJcmV0dXJuIERQ
X0FVWF9DSF9DVExfQVVYX0FLU1ZfU0VMRUNUOworCisJcmV0dXJuIDA7Cit9CisKIHN0YXRpYyBz
c2l6ZV90CiBpbnRlbF9kcF9hdXhfdHJhbnNmZXIoc3RydWN0IGRybV9kcF9hdXggKmF1eCwgc3Ry
dWN0IGRybV9kcF9hdXhfbXNnICptc2cpCiB7CiAJc3RydWN0IGludGVsX2RwICppbnRlbF9kcCA9
IGNvbnRhaW5lcl9vZihhdXgsIHN0cnVjdCBpbnRlbF9kcCwgYXV4KTsKIAl1OCB0eGJ1ZlsyMF0s
IHJ4YnVmWzIwXTsKIAlzaXplX3QgdHhzaXplLCByeHNpemU7CisJdTMyIGZsYWdzID0gaW50ZWxf
ZHBfYXV4X2dlbmVyYXRlX3hmZXJfZmxhZ3MobXNnKTsKIAlpbnQgcmV0OwogCiAJaW50ZWxfZHBf
YXV4X2hlYWRlcih0eGJ1ZiwgbXNnKTsKQEAgLTE1NDEsNyArMTU1OCw3IEBAIGludGVsX2RwX2F1
eF90cmFuc2ZlcihzdHJ1Y3QgZHJtX2RwX2F1eCAqYXV4LCBzdHJ1Y3QgZHJtX2RwX2F1eF9tc2cg
Km1zZykKIAkJCW1lbWNweSh0eGJ1ZiArIEhFQURFUl9TSVpFLCBtc2ctPmJ1ZmZlciwgbXNnLT5z
aXplKTsKIAogCQlyZXQgPSBpbnRlbF9kcF9hdXhfeGZlcihpbnRlbF9kcCwgdHhidWYsIHR4c2l6
ZSwKLQkJCQkJcnhidWYsIHJ4c2l6ZSwgMCk7CisJCQkJCXJ4YnVmLCByeHNpemUsIGZsYWdzKTsK
IAkJaWYgKHJldCA+IDApIHsKIAkJCW1zZy0+cmVwbHkgPSByeGJ1ZlswXSA+PiA0OwogCkBAIC0x
NTY0LDcgKzE1ODEsNyBAQCBpbnRlbF9kcF9hdXhfdHJhbnNmZXIoc3RydWN0IGRybV9kcF9hdXgg
KmF1eCwgc3RydWN0IGRybV9kcF9hdXhfbXNnICptc2cpCiAJCQlyZXR1cm4gLUUyQklHOwogCiAJ
CXJldCA9IGludGVsX2RwX2F1eF94ZmVyKGludGVsX2RwLCB0eGJ1ZiwgdHhzaXplLAotCQkJCQly
eGJ1ZiwgcnhzaXplLCAwKTsKKwkJCQkJcnhidWYsIHJ4c2l6ZSwgZmxhZ3MpOwogCQlpZiAocmV0
ID4gMCkgewogCQkJbXNnLT5yZXBseSA9IHJ4YnVmWzBdID4+IDQ7CiAJCQkvKgpAQCAtNTg1OCwx
NyArNTg3NSw5IEBAIHN0YXRpYwogaW50IGludGVsX2RwX2hkY3Bfd3JpdGVfYW5fYWtzdihzdHJ1
Y3QgaW50ZWxfZGlnaXRhbF9wb3J0ICppbnRlbF9kaWdfcG9ydCwKIAkJCQl1OCAqYW4pCiB7Ci0J
c3RydWN0IGludGVsX2RwICppbnRlbF9kcCA9IGVuY190b19pbnRlbF9kcCgmaW50ZWxfZGlnX3Bv
cnQtPmJhc2UuYmFzZSk7Ci0Jc3RhdGljIGNvbnN0IHN0cnVjdCBkcm1fZHBfYXV4X21zZyBtc2cg
PSB7Ci0JCS5yZXF1ZXN0ID0gRFBfQVVYX05BVElWRV9XUklURSwKLQkJLmFkZHJlc3MgPSBEUF9B
VVhfSERDUF9BS1NWLAotCQkuc2l6ZSA9IERSTV9IRENQX0tTVl9MRU4sCi0JfTsKLQl1OCB0eGJ1
ZltIRUFERVJfU0laRSArIERSTV9IRENQX0tTVl9MRU5dID0ge30sIHJ4YnVmWzJdLCByZXBseSA9
IDA7CisJdTggdHhidWZbRFJNX0hEQ1BfS1NWX0xFTl0gPSB7fTsKIAlzc2l6ZV90IGRwY2RfcmV0
OwotCWludCByZXQ7CiAKLQkvKiBPdXRwdXQgQW4gZmlyc3QsIHRoYXQncyBlYXN5ICovCiAJZHBj
ZF9yZXQgPSBkcm1fZHBfZHBjZF93cml0ZSgmaW50ZWxfZGlnX3BvcnQtPmRwLmF1eCwgRFBfQVVY
X0hEQ1BfQU4sCiAJCQkJICAgICBhbiwgRFJNX0hEQ1BfQU5fTEVOKTsKIAlpZiAoZHBjZF9yZXQg
IT0gRFJNX0hEQ1BfQU5fTEVOKSB7CkBAIC01ODc4LDI5ICs1ODg3LDE4IEBAIGludCBpbnRlbF9k
cF9oZGNwX3dyaXRlX2FuX2Frc3Yoc3RydWN0IGludGVsX2RpZ2l0YWxfcG9ydCAqaW50ZWxfZGln
X3BvcnQsCiAJfQogCiAJLyoKLQkgKiBTaW5jZSBBa3N2IGlzIE9oLVNvLVNlY3JldCwgd2UgY2Fu
J3QgYWNjZXNzIGl0IGluIHNvZnR3YXJlLiBTbyBpbgotCSAqIG9yZGVyIHRvIGdldCBpdCBvbiB0
aGUgd2lyZSwgd2UgbmVlZCB0byBjcmVhdGUgdGhlIEFVWCBoZWFkZXIgYXMgaWYKLQkgKiB3ZSB3
ZXJlIHdyaXRpbmcgdGhlIGRhdGEsIGFuZCB0aGVuIHRpY2tsZSB0aGUgaGFyZHdhcmUgdG8gb3V0
cHV0IHRoZQotCSAqIGRhdGEgb25jZSB0aGUgaGVhZGVyIGlzIHNlbnQgb3V0LgorCSAqIFNpbmNl
IEFrc3YgaXMgT2gtU28tU2VjcmV0LCB3ZSBjYW4ndCBhY2Nlc3MgaXQgaW4gc29mdHdhcmUuIFNv
IHdlCisJICogc2VuZCBhbiBlbXB0eSBidWZmZXIgb2YgdGhlIGNvcnJlY3QgbGVuZ3RoIHRocm91
Z2ggdGhlIERQIGhlbHBlcnMuIE9uCisJICogdGhlIG90aGVyIHNpZGUsIGluIHRoZSB0cmFuc2Zl
ciBob29rLCB3ZSdsbCBnZW5lcmF0ZSBhIGZsYWcgYmFzZWQgb24KKwkgKiB0aGUgZGVzdGluYXRp
b24gYWRkcmVzcyB3aGljaCB3aWxsIHRpY2tsZSB0aGUgaGFyZHdhcmUgdG8gb3V0cHV0IHRoZQor
CSAqIEFrc3Ygb24gb3VyIGJlaGFsZiBhZnRlciB0aGUgaGVhZGVyIGlzIHNlbnQuCiAJICovCi0J
aW50ZWxfZHBfYXV4X2hlYWRlcih0eGJ1ZiwgJm1zZyk7Ci0KLQlyZXQgPSBpbnRlbF9kcF9hdXhf
eGZlcihpbnRlbF9kcCwgdHhidWYsIEhFQURFUl9TSVpFICsgbXNnLnNpemUsCi0JCQkJcnhidWYs
IHNpemVvZihyeGJ1ZiksCi0JCQkJRFBfQVVYX0NIX0NUTF9BVVhfQUtTVl9TRUxFQ1QpOwotCWlm
IChyZXQgPCAwKSB7Ci0JCURSTV9ERUJVR19LTVMoIldyaXRlIEFrc3Ygb3ZlciBEUC9BVVggZmFp
bGVkICglZClcbiIsIHJldCk7Ci0JCXJldHVybiByZXQ7Ci0JfSBlbHNlIGlmIChyZXQgPT0gMCkg
ewotCQlEUk1fREVCVUdfS01TKCJBa3N2IHdyaXRlIG92ZXIgRFAvQVVYIHdhcyBlbXB0eVxuIik7
Ci0JCXJldHVybiAtRUlPOwotCX0KLQotCXJlcGx5ID0gKHJ4YnVmWzBdID4+IDQpICYgRFBfQVVY
X05BVElWRV9SRVBMWV9NQVNLOwotCWlmIChyZXBseSAhPSBEUF9BVVhfTkFUSVZFX1JFUExZX0FD
SykgewotCQlEUk1fREVCVUdfS01TKCJBa3N2IHdyaXRlOiBubyBEUF9BVVhfTkFUSVZFX1JFUExZ
X0FDSyAleFxuIiwKLQkJCSAgICAgIHJlcGx5KTsKLQkJcmV0dXJuIC1FSU87CisJZHBjZF9yZXQg
PSBkcm1fZHBfZHBjZF93cml0ZSgmaW50ZWxfZGlnX3BvcnQtPmRwLmF1eCwgRFBfQVVYX0hEQ1Bf
QUtTViwKKwkJCQkgICAgIHR4YnVmLCBEUk1fSERDUF9LU1ZfTEVOKTsKKwlpZiAoZHBjZF9yZXQg
IT0gRFJNX0hEQ1BfS1NWX0xFTikgeworCQlEUk1fREVCVUdfS01TKCJGYWlsZWQgdG8gd3JpdGUg
QWtzdiBvdmVyIERQL0FVWCAoJXpkKVxuIiwKKwkJCSAgICAgIGRwY2RfcmV0KTsKKwkJcmV0dXJu
IGRwY2RfcmV0ID49IDAgPyAtRUlPIDogZHBjZF9yZXQ7CiAJfQogCXJldHVybiAwOwogfQotLSAK
U2VhbiBQYXVsLCBTb2Z0d2FyZSBFbmdpbmVlciwgR29vZ2xlIC8gQ2hyb21pdW0gT1MKCl9fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWls
aW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZy
ZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
