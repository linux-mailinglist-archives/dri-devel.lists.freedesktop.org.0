Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 2E33A30F8A
	for <lists+dri-devel@lfdr.de>; Fri, 31 May 2019 16:02:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BD086895B5;
	Fri, 31 May 2019 14:02:15 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from smtp.domeneshop.no (smtp.domeneshop.no
 [IPv6:2a01:5b40:0:3005::1])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E954E894DD;
 Fri, 31 May 2019 14:01:59 +0000 (UTC)
Received: from 211.81-166-168.customer.lyse.net ([81.166.168.211]:52318
 helo=localhost.localdomain)
 by smtp.domeneshop.no with esmtpsa (TLS1.2:ECDHE_RSA_AES_128_CBC_SHA1:128)
 (Exim 4.84_2) (envelope-from <noralf@tronnes.org>)
 id 1hWi6X-0002XY-UQ; Fri, 31 May 2019 16:01:58 +0200
From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v7 4/8] drm/fb-helper: Move out commit code
Date: Fri, 31 May 2019 16:01:13 +0200
Message-Id: <20190531140117.37751-5-noralf@tronnes.org>
X-Mailer: git-send-email 2.20.1
In-Reply-To: <20190531140117.37751-1-noralf@tronnes.org>
References: <20190531140117.37751-1-noralf@tronnes.org>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; d=tronnes.org; s=ds201810; 
 h=Content-Transfer-Encoding:Content-Type:MIME-Version:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From;
 bh=zokEJa37mllwgfoaYJ7EhpSaO2LN+cRiz3sim1EhFQs=; 
 b=LZp87bQOtSNToJackU9vWdWiWcRNedDynkV1YG+z1uKB13To/hWGYee3wF1l180m1M8/HylGTP6jwLkJxTW6p0p2SaGkLA9MhJQ2GEqN3uHiJY0KlW8sejfYb5Stwg/4UOK3M+UYc17iomY2Gn85grMQRim8fYD8kxvjhPL1rLM3CGPeepo4YBvy7C0SKwYonwgjW2V67PtxVAxcsQfnccXVeO9IucvpCYYzmsJNyrv87bo9crBXjAkBEoSdYVVDT9Vsbr8VSHYuREN1R45JMO9dBnDSfb6cwQzfs1PJQco0OWYT/g3cm4sHR65B40x4sxTEssC3uadLOpPVtTLEVQ==;
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: intel-gfx@lists.freedesktop.org, Sam Ravnborg <sam@ravnborg.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

TW92ZSB0aGUgbW9kZXNldCBjb21taXQgY29kZSB0byBkcm1fY2xpZW50X21vZGVzZXQuCk5vIGNo
YW5nZXMgZXhjZXB0IGV4cG9ydGluZyBBUEkuCgp2NzogRXhwb3J0IGRybV9jbGllbnRfcGFuZWxf
cm90YXRpb24oKSAoR2VyZCBIb2ZmbWFubikKdjI6IE1vdmUgdG8gZHJtX2NsaWVudF9tb2Rlc2V0
LmMgaW5zdGVhZCBvZiBkcm1fY2xpZW50LmMKClNpZ25lZC1vZmYtYnk6IE5vcmFsZiBUcsO4bm5l
cyA8bm9yYWxmQHRyb25uZXMub3JnPgpSZXZpZXdlZC1ieTogU2FtIFJhdm5ib3JnIDxzYW1AcmF2
bmJvcmcub3JnPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9kcm1fY2xpZW50X21vZGVzZXQuYyB8IDI4
OCArKysrKysrKysrKysrKysrKysrKysrKysrKysKIGRyaXZlcnMvZ3B1L2RybS9kcm1fZmJfaGVs
cGVyLmMgICAgICB8IDI4MiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogaW5jbHVkZS9kcm0v
ZHJtX2NsaWVudC5oICAgICAgICAgICAgIHwgICA0ICsKIDMgZmlsZXMgY2hhbmdlZCwgMjkyIGlu
c2VydGlvbnMoKyksIDI4MiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vZHJtX2NsaWVudF9tb2Rlc2V0LmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2NsaWVudF9tb2Rl
c2V0LmMKaW5kZXggNjY3NzBlZDMyOTllLi5iMTk4NGY5MDFhNmQgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9kcm1fY2xpZW50X21vZGVzZXQuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vZHJt
X2NsaWVudF9tb2Rlc2V0LmMKQEAgLTExLDkgKzExLDE0IEBACiAjaW5jbHVkZSA8bGludXgvbXV0
ZXguaD4KICNpbmNsdWRlIDxsaW51eC9zbGFiLmg+CiAKKyNpbmNsdWRlIDxkcm0vZHJtX2F0b21p
Yy5oPgogI2luY2x1ZGUgPGRybS9kcm1fY2xpZW50Lmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9jcnRj
Lmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9kZXZpY2UuaD4KKyNpbmNsdWRlIDxkcm0vZHJtX2Rydi5o
PgorCisjaW5jbHVkZSAiZHJtX2NydGNfaW50ZXJuYWwuaCIKKyNpbmNsdWRlICJkcm1faW50ZXJu
YWwuaCIKIAogaW50IGRybV9jbGllbnRfbW9kZXNldF9jcmVhdGUoc3RydWN0IGRybV9jbGllbnRf
ZGV2ICpjbGllbnQpCiB7CkBAIC0xMDIsMyArMTA3LDI4NiBAQCBzdHJ1Y3QgZHJtX21vZGVfc2V0
ICpkcm1fY2xpZW50X2ZpbmRfbW9kZXNldChzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVudCwg
c3RydQogfQogLyogVE9ETzogUmVtb3ZlIGV4cG9ydCB3aGVuIG1vZGVzZXQgY29kZSBoYXMgYmVl
biBtb3ZlZCBvdmVyICovCiBFWFBPUlRfU1lNQk9MKGRybV9jbGllbnRfZmluZF9tb2Rlc2V0KTsK
KworLyoqCisgKiBkcm1fY2xpZW50X3BhbmVsX3JvdGF0aW9uKCkgLSBDaGVjayBwYW5lbCBvcmll
bnRhdGlvbgorICogQG1vZGVzZXQ6IERSTSBtb2Rlc2V0CisgKiBAcm90YXRpb246IFJldHVybmVk
IHJvdGF0aW9uIHZhbHVlCisgKgorICogVGhpcyBmdW5jdGlvbiBjaGVja3MgaWYgdGhlIHByaW1h
cnkgcGxhbmUgaW4gQG1vZGVzZXQgY2FuIGh3IHJvdGF0ZSB0byBtYXRjaAorICogdGhlIHBhbmVs
IG9yaWVudGF0aW9uIG9uIGl0cyBjb25uZWN0b3IuCisgKgorICogTm90ZTogQ3VycmVudGx5IG9u
bHkgMCBhbmQgMTgwIGRlZ3JlZXMgYXJlIHN1cHBvcnRlZC4KKyAqCisgKiBSZXR1cm46CisgKiBU
cnVlIGlmIHRoZSBwbGFuZSBjYW4gZG8gdGhlIHJvdGF0aW9uLCBmYWxzZSBvdGhlcndpc2UuCisg
Ki8KK2Jvb2wgZHJtX2NsaWVudF9wYW5lbF9yb3RhdGlvbihzdHJ1Y3QgZHJtX21vZGVfc2V0ICpt
b2Rlc2V0LCB1bnNpZ25lZCBpbnQgKnJvdGF0aW9uKQoreworCXN0cnVjdCBkcm1fY29ubmVjdG9y
ICpjb25uZWN0b3IgPSBtb2Rlc2V0LT5jb25uZWN0b3JzWzBdOworCXN0cnVjdCBkcm1fcGxhbmUg
KnBsYW5lID0gbW9kZXNldC0+Y3J0Yy0+cHJpbWFyeTsKKwl1NjQgdmFsaWRfbWFzayA9IDA7CisJ
dW5zaWduZWQgaW50IGk7CisKKwlpZiAoIW1vZGVzZXQtPm51bV9jb25uZWN0b3JzKQorCQlyZXR1
cm4gZmFsc2U7CisKKwlzd2l0Y2ggKGNvbm5lY3Rvci0+ZGlzcGxheV9pbmZvLnBhbmVsX29yaWVu
dGF0aW9uKSB7CisJY2FzZSBEUk1fTU9ERV9QQU5FTF9PUklFTlRBVElPTl9CT1RUT01fVVA6CisJ
CSpyb3RhdGlvbiA9IERSTV9NT0RFX1JPVEFURV8xODA7CisJCWJyZWFrOworCWNhc2UgRFJNX01P
REVfUEFORUxfT1JJRU5UQVRJT05fTEVGVF9VUDoKKwkJKnJvdGF0aW9uID0gRFJNX01PREVfUk9U
QVRFXzkwOworCQlicmVhazsKKwljYXNlIERSTV9NT0RFX1BBTkVMX09SSUVOVEFUSU9OX1JJR0hU
X1VQOgorCQkqcm90YXRpb24gPSBEUk1fTU9ERV9ST1RBVEVfMjcwOworCQlicmVhazsKKwlkZWZh
dWx0OgorCQkqcm90YXRpb24gPSBEUk1fTU9ERV9ST1RBVEVfMDsKKwl9CisKKwkvKgorCSAqIFRP
RE86IHN1cHBvcnQgOTAgLyAyNzAgZGVncmVlIGhhcmR3YXJlIHJvdGF0aW9uLAorCSAqIGRlcGVu
ZGluZyBvbiB0aGUgaGFyZHdhcmUgdGhpcyBtYXkgcmVxdWlyZSB0aGUgZnJhbWVidWZmZXIKKwkg
KiB0byBiZSBpbiBhIHNwZWNpZmljIHRpbGluZyBmb3JtYXQuCisJICovCisJaWYgKCpyb3RhdGlv
biAhPSBEUk1fTU9ERV9ST1RBVEVfMTgwIHx8ICFwbGFuZS0+cm90YXRpb25fcHJvcGVydHkpCisJ
CXJldHVybiBmYWxzZTsKKworCWZvciAoaSA9IDA7IGkgPCBwbGFuZS0+cm90YXRpb25fcHJvcGVy
dHktPm51bV92YWx1ZXM7IGkrKykKKwkJdmFsaWRfbWFzayB8PSAoMVVMTCA8PCBwbGFuZS0+cm90
YXRpb25fcHJvcGVydHktPnZhbHVlc1tpXSk7CisKKwlpZiAoISgqcm90YXRpb24gJiB2YWxpZF9t
YXNrKSkKKwkJcmV0dXJuIGZhbHNlOworCisJcmV0dXJuIHRydWU7Cit9CitFWFBPUlRfU1lNQk9M
KGRybV9jbGllbnRfcGFuZWxfcm90YXRpb24pOworCitzdGF0aWMgaW50IGRybV9jbGllbnRfbW9k
ZXNldF9jb21taXRfYXRvbWljKHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50LCBib29sIGFj
dGl2ZSkKK3sKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gY2xpZW50LT5kZXY7CisJc3RydWN0
IGRybV9wbGFuZV9zdGF0ZSAqcGxhbmVfc3RhdGU7CisJc3RydWN0IGRybV9wbGFuZSAqcGxhbmU7
CisJc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlOworCXN0cnVjdCBkcm1fbW9kZXNldF9h
Y3F1aXJlX2N0eCBjdHg7CisJc3RydWN0IGRybV9tb2RlX3NldCAqbW9kZV9zZXQ7CisJaW50IHJl
dDsKKworCWRybV9tb2Rlc2V0X2FjcXVpcmVfaW5pdCgmY3R4LCAwKTsKKworCXN0YXRlID0gZHJt
X2F0b21pY19zdGF0ZV9hbGxvYyhkZXYpOworCWlmICghc3RhdGUpIHsKKwkJcmV0ID0gLUVOT01F
TTsKKwkJZ290byBvdXRfY3R4OworCX0KKworCXN0YXRlLT5hY3F1aXJlX2N0eCA9ICZjdHg7City
ZXRyeToKKwlkcm1fZm9yX2VhY2hfcGxhbmUocGxhbmUsIGRldikgeworCQlwbGFuZV9zdGF0ZSA9
IGRybV9hdG9taWNfZ2V0X3BsYW5lX3N0YXRlKHN0YXRlLCBwbGFuZSk7CisJCWlmIChJU19FUlIo
cGxhbmVfc3RhdGUpKSB7CisJCQlyZXQgPSBQVFJfRVJSKHBsYW5lX3N0YXRlKTsKKwkJCWdvdG8g
b3V0X3N0YXRlOworCQl9CisKKwkJcGxhbmVfc3RhdGUtPnJvdGF0aW9uID0gRFJNX01PREVfUk9U
QVRFXzA7CisKKwkJLyogZGlzYWJsZSBub24tcHJpbWFyeTogKi8KKwkJaWYgKHBsYW5lLT50eXBl
ID09IERSTV9QTEFORV9UWVBFX1BSSU1BUlkpCisJCQljb250aW51ZTsKKworCQlyZXQgPSBfX2Ry
bV9hdG9taWNfaGVscGVyX2Rpc2FibGVfcGxhbmUocGxhbmUsIHBsYW5lX3N0YXRlKTsKKwkJaWYg
KHJldCAhPSAwKQorCQkJZ290byBvdXRfc3RhdGU7CisJfQorCisJZHJtX2NsaWVudF9mb3JfZWFj
aF9tb2Rlc2V0KG1vZGVfc2V0LCBjbGllbnQpIHsKKwkJc3RydWN0IGRybV9wbGFuZSAqcHJpbWFy
eSA9IG1vZGVfc2V0LT5jcnRjLT5wcmltYXJ5OworCQl1bnNpZ25lZCBpbnQgcm90YXRpb247CisK
KwkJaWYgKGRybV9jbGllbnRfcGFuZWxfcm90YXRpb24obW9kZV9zZXQsICZyb3RhdGlvbikpIHsK
KwkJCS8qIENhbm5vdCBmYWlsIGFzIHdlJ3ZlIGFscmVhZHkgZ290dGVuIHRoZSBwbGFuZSBzdGF0
ZSBhYm92ZSAqLworCQkJcGxhbmVfc3RhdGUgPSBkcm1fYXRvbWljX2dldF9uZXdfcGxhbmVfc3Rh
dGUoc3RhdGUsIHByaW1hcnkpOworCQkJcGxhbmVfc3RhdGUtPnJvdGF0aW9uID0gcm90YXRpb247
CisJCX0KKworCQlyZXQgPSBfX2RybV9hdG9taWNfaGVscGVyX3NldF9jb25maWcobW9kZV9zZXQs
IHN0YXRlKTsKKwkJaWYgKHJldCAhPSAwKQorCQkJZ290byBvdXRfc3RhdGU7CisKKwkJLyoKKwkJ
ICogX19kcm1fYXRvbWljX2hlbHBlcl9zZXRfY29uZmlnKCkgc2V0cyBhY3RpdmUgd2hlbiBhCisJ
CSAqIG1vZGUgaXMgc2V0LCB1bmNvbmRpdGlvbmFsbHkgY2xlYXIgaXQgaWYgd2UgZm9yY2UgRFBN
UyBvZmYKKwkJICovCisJCWlmICghYWN0aXZlKSB7CisJCQlzdHJ1Y3QgZHJtX2NydGMgKmNydGMg
PSBtb2RlX3NldC0+Y3J0YzsKKwkJCXN0cnVjdCBkcm1fY3J0Y19zdGF0ZSAqY3J0Y19zdGF0ZSA9
IGRybV9hdG9taWNfZ2V0X25ld19jcnRjX3N0YXRlKHN0YXRlLCBjcnRjKTsKKworCQkJY3J0Y19z
dGF0ZS0+YWN0aXZlID0gZmFsc2U7CisJCX0KKwl9CisKKwlyZXQgPSBkcm1fYXRvbWljX2NvbW1p
dChzdGF0ZSk7CisKK291dF9zdGF0ZToKKwlpZiAocmV0ID09IC1FREVBRExLKQorCQlnb3RvIGJh
Y2tvZmY7CisKKwlkcm1fYXRvbWljX3N0YXRlX3B1dChzdGF0ZSk7CitvdXRfY3R4OgorCWRybV9t
b2Rlc2V0X2Ryb3BfbG9ja3MoJmN0eCk7CisJZHJtX21vZGVzZXRfYWNxdWlyZV9maW5pKCZjdHgp
OworCisJcmV0dXJuIHJldDsKKworYmFja29mZjoKKwlkcm1fYXRvbWljX3N0YXRlX2NsZWFyKHN0
YXRlKTsKKwlkcm1fbW9kZXNldF9iYWNrb2ZmKCZjdHgpOworCisJZ290byByZXRyeTsKK30KKwor
c3RhdGljIGludCBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2xlZ2FjeShzdHJ1Y3QgZHJtX2Ns
aWVudF9kZXYgKmNsaWVudCkKK3sKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gY2xpZW50LT5k
ZXY7CisJc3RydWN0IGRybV9tb2RlX3NldCAqbW9kZV9zZXQ7CisJc3RydWN0IGRybV9wbGFuZSAq
cGxhbmU7CisJaW50IHJldCA9IDA7CisKKwlkcm1fbW9kZXNldF9sb2NrX2FsbChkZXYpOworCWRy
bV9mb3JfZWFjaF9wbGFuZShwbGFuZSwgZGV2KSB7CisJCWlmIChwbGFuZS0+dHlwZSAhPSBEUk1f
UExBTkVfVFlQRV9QUklNQVJZKQorCQkJZHJtX3BsYW5lX2ZvcmNlX2Rpc2FibGUocGxhbmUpOwor
CisJCWlmIChwbGFuZS0+cm90YXRpb25fcHJvcGVydHkpCisJCQlkcm1fbW9kZV9wbGFuZV9zZXRf
b2JqX3Byb3AocGxhbmUsCisJCQkJCQkgICAgcGxhbmUtPnJvdGF0aW9uX3Byb3BlcnR5LAorCQkJ
CQkJICAgIERSTV9NT0RFX1JPVEFURV8wKTsKKwl9CisKKwlkcm1fY2xpZW50X2Zvcl9lYWNoX21v
ZGVzZXQobW9kZV9zZXQsIGNsaWVudCkgeworCQlzdHJ1Y3QgZHJtX2NydGMgKmNydGMgPSBtb2Rl
X3NldC0+Y3J0YzsKKworCQlpZiAoY3J0Yy0+ZnVuY3MtPmN1cnNvcl9zZXQyKSB7CisJCQlyZXQg
PSBjcnRjLT5mdW5jcy0+Y3Vyc29yX3NldDIoY3J0YywgTlVMTCwgMCwgMCwgMCwgMCwgMCk7CisJ
CQlpZiAocmV0KQorCQkJCWdvdG8gb3V0OworCQl9IGVsc2UgaWYgKGNydGMtPmZ1bmNzLT5jdXJz
b3Jfc2V0KSB7CisJCQlyZXQgPSBjcnRjLT5mdW5jcy0+Y3Vyc29yX3NldChjcnRjLCBOVUxMLCAw
LCAwLCAwKTsKKwkJCWlmIChyZXQpCisJCQkJZ290byBvdXQ7CisJCX0KKworCQlyZXQgPSBkcm1f
bW9kZV9zZXRfY29uZmlnX2ludGVybmFsKG1vZGVfc2V0KTsKKwkJaWYgKHJldCkKKwkJCWdvdG8g
b3V0OworCX0KK291dDoKKwlkcm1fbW9kZXNldF91bmxvY2tfYWxsKGRldik7CisKKwlyZXR1cm4g
cmV0OworfQorCisvKioKKyAqIGRybV9jbGllbnRfbW9kZXNldF9jb21taXRfZm9yY2UoKSAtIEZv
cmNlIGNvbW1pdCBDUlRDIGNvbmZpZ3VyYXRpb24KKyAqIEBjbGllbnQ6IERSTSBjbGllbnQKKyAq
CisgKiBDb21taXQgbW9kZXNldCBjb25maWd1cmF0aW9uIHRvIGNydGNzIHdpdGhvdXQgY2hlY2tp
bmcgaWYgdGhlcmUgaXMgYSBEUk0gbWFzdGVyLgorICoKKyAqIFJldHVybnM6CisgKiBaZXJvIG9u
IHN1Y2Nlc3Mgb3IgbmVnYXRpdmUgZXJyb3IgY29kZSBvbiBmYWlsdXJlLgorICovCitpbnQgZHJt
X2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9mb3JjZShzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVu
dCkKK3sKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gY2xpZW50LT5kZXY7CisJaW50IHJldDsK
KworCW11dGV4X2xvY2soJmNsaWVudC0+bW9kZXNldF9tdXRleCk7CisJaWYgKGRybV9kcnZfdXNl
c19hdG9taWNfbW9kZXNldChkZXYpKQorCQlyZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0
X2F0b21pYyhjbGllbnQsIHRydWUpOworCWVsc2UKKwkJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0
X2NvbW1pdF9sZWdhY3koY2xpZW50KTsKKwltdXRleF91bmxvY2soJmNsaWVudC0+bW9kZXNldF9t
dXRleCk7CisKKwlyZXR1cm4gcmV0OworfQorRVhQT1JUX1NZTUJPTChkcm1fY2xpZW50X21vZGVz
ZXRfY29tbWl0X2ZvcmNlKTsKKworLyoqCisgKiBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0KCkg
LSBDb21taXQgQ1JUQyBjb25maWd1cmF0aW9uCisgKiBAY2xpZW50OiBEUk0gY2xpZW50CisgKgor
ICogQ29tbWl0IG1vZGVzZXQgY29uZmlndXJhdGlvbiB0byBjcnRjcy4KKyAqCisgKiBSZXR1cm5z
OgorICogWmVybyBvbiBzdWNjZXNzIG9yIG5lZ2F0aXZlIGVycm9yIGNvZGUgb24gZmFpbHVyZS4K
KyAqLworaW50IGRybV9jbGllbnRfbW9kZXNldF9jb21taXQoc3RydWN0IGRybV9jbGllbnRfZGV2
ICpjbGllbnQpCit7CisJc3RydWN0IGRybV9kZXZpY2UgKmRldiA9IGNsaWVudC0+ZGV2OworCWlu
dCByZXQ7CisKKwlpZiAoIWRybV9tYXN0ZXJfaW50ZXJuYWxfYWNxdWlyZShkZXYpKQorCQlyZXR1
cm4gLUVCVVNZOworCisJcmV0ID0gZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9mb3JjZShjbGll
bnQpOworCisJZHJtX21hc3Rlcl9pbnRlcm5hbF9yZWxlYXNlKGRldik7CisKKwlyZXR1cm4gcmV0
OworfQorRVhQT1JUX1NZTUJPTChkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0KTsKKworc3RhdGlj
IHZvaWQgZHJtX2NsaWVudF9tb2Rlc2V0X2RwbXNfbGVnYWN5KHN0cnVjdCBkcm1fY2xpZW50X2Rl
diAqY2xpZW50LCBpbnQgZHBtc19tb2RlKQoreworCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBj
bGllbnQtPmRldjsKKwlzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqY29ubmVjdG9yOworCXN0cnVjdCBk
cm1fbW9kZV9zZXQgKm1vZGVzZXQ7CisJaW50IGo7CisKKwlkcm1fbW9kZXNldF9sb2NrX2FsbChk
ZXYpOworCWRybV9jbGllbnRfZm9yX2VhY2hfbW9kZXNldChtb2Rlc2V0LCBjbGllbnQpIHsKKwkJ
aWYgKCFtb2Rlc2V0LT5jcnRjLT5lbmFibGVkKQorCQkJY29udGludWU7CisKKwkJZm9yIChqID0g
MDsgaiA8IG1vZGVzZXQtPm51bV9jb25uZWN0b3JzOyBqKyspIHsKKwkJCWNvbm5lY3RvciA9IG1v
ZGVzZXQtPmNvbm5lY3RvcnNbal07CisJCQljb25uZWN0b3ItPmZ1bmNzLT5kcG1zKGNvbm5lY3Rv
ciwgZHBtc19tb2RlKTsKKwkJCWRybV9vYmplY3RfcHJvcGVydHlfc2V0X3ZhbHVlKCZjb25uZWN0
b3ItPmJhc2UsCisJCQkJZGV2LT5tb2RlX2NvbmZpZy5kcG1zX3Byb3BlcnR5LCBkcG1zX21vZGUp
OworCQl9CisJfQorCWRybV9tb2Rlc2V0X3VubG9ja19hbGwoZGV2KTsKK30KKworLyoqCisgKiBk
cm1fY2xpZW50X21vZGVzZXRfZHBtcygpIC0gU2V0IERQTVMgbW9kZQorICogQGNsaWVudDogRFJN
IGNsaWVudAorICogQG1vZGU6IERQTVMgbW9kZQorICoKKyAqIE5vdGU6IEZvciBhdG9taWMgZHJp
dmVycyBAbW9kZSBpcyByZWR1Y2VkIHRvIG9uL29mZi4KKyAqCisgKiBSZXR1cm5zOgorICogWmVy
byBvbiBzdWNjZXNzIG9yIG5lZ2F0aXZlIGVycm9yIGNvZGUgb24gZmFpbHVyZS4KKyAqLworaW50
IGRybV9jbGllbnRfbW9kZXNldF9kcG1zKHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50LCBp
bnQgbW9kZSkKK3sKKwlzdHJ1Y3QgZHJtX2RldmljZSAqZGV2ID0gY2xpZW50LT5kZXY7CisJaW50
IHJldCA9IDA7CisKKwlpZiAoIWRybV9tYXN0ZXJfaW50ZXJuYWxfYWNxdWlyZShkZXYpKQorCQly
ZXR1cm4gLUVCVVNZOworCisJbXV0ZXhfbG9jaygmY2xpZW50LT5tb2Rlc2V0X211dGV4KTsKKwlp
ZiAoZHJtX2Rydl91c2VzX2F0b21pY19tb2Rlc2V0KGRldikpCisJCXJldCA9IGRybV9jbGllbnRf
bW9kZXNldF9jb21taXRfYXRvbWljKGNsaWVudCwgbW9kZSA9PSBEUk1fTU9ERV9EUE1TX09OKTsK
KwllbHNlCisJCWRybV9jbGllbnRfbW9kZXNldF9kcG1zX2xlZ2FjeShjbGllbnQsIG1vZGUpOwor
CW11dGV4X3VubG9jaygmY2xpZW50LT5tb2Rlc2V0X211dGV4KTsKKworCWRybV9tYXN0ZXJfaW50
ZXJuYWxfcmVsZWFzZShkZXYpOworCisJcmV0dXJuIHJldDsKK30KK0VYUE9SVF9TWU1CT0woZHJt
X2NsaWVudF9tb2Rlc2V0X2RwbXMpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2RybV9m
Yl9oZWxwZXIuYyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmJfaGVscGVyLmMKaW5kZXggNjQ4MDBk
NDM4MzdkLi43YjM4ODY3NGE0NTYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9kcm1fZmJf
aGVscGVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2RybV9mYl9oZWxwZXIuYwpAQCAtMzgsNyAr
MzgsNiBAQAogI2luY2x1ZGUgPGxpbnV4L3ZtYWxsb2MuaD4KIAogI2luY2x1ZGUgPGRybS9kcm1f
YXRvbWljLmg+Ci0jaW5jbHVkZSA8ZHJtL2RybV9hdG9taWNfaGVscGVyLmg+CiAjaW5jbHVkZSA8
ZHJtL2RybV9jcnRjLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9jcnRjX2hlbHBlci5oPgogI2luY2x1
ZGUgPGRybS9kcm1fZHJ2Lmg+CkBAIC00Nyw4ICs0Niw2IEBACiAjaW5jbHVkZSA8ZHJtL2RybV9w
cmludC5oPgogI2luY2x1ZGUgPGRybS9kcm1fdmJsYW5rLmg+CiAKLSNpbmNsdWRlICJkcm1fY3J0
Y19oZWxwZXJfaW50ZXJuYWwuaCIKLSNpbmNsdWRlICJkcm1fY3J0Y19pbnRlcm5hbC5oIgogI2lu
Y2x1ZGUgImRybV9pbnRlcm5hbC5oIgogCiBzdGF0aWMgYm9vbCBkcm1fZmJkZXZfZW11bGF0aW9u
ID0gdHJ1ZTsKQEAgLTM5MywyMzMgKzM5MCw2IEBAIGludCBkcm1fZmJfaGVscGVyX2RlYnVnX2xl
YXZlKHN0cnVjdCBmYl9pbmZvICppbmZvKQogfQogRVhQT1JUX1NZTUJPTChkcm1fZmJfaGVscGVy
X2RlYnVnX2xlYXZlKTsKIAotLyoqCi0gKiBkcm1fY2xpZW50X3BhbmVsX3JvdGF0aW9uKCkgLSBD
aGVjayBwYW5lbCBvcmllbnRhdGlvbgotICogQG1vZGVzZXQ6IERSTSBtb2Rlc2V0Ci0gKiBAcm90
YXRpb246IFJldHVybmVkIHJvdGF0aW9uIHZhbHVlCi0gKgotICogVGhpcyBmdW5jdGlvbiBjaGVj
a3MgaWYgdGhlIHByaW1hcnkgcGxhbmUgaW4gQG1vZGVzZXQgY2FuIGh3IHJvdGF0ZSB0byBtYXRj
aAotICogdGhlIHBhbmVsIG9yaWVudGF0aW9uIG9uIGl0cyBjb25uZWN0b3IuCi0gKgotICogTm90
ZTogQ3VycmVudGx5IG9ubHkgMCBhbmQgMTgwIGRlZ3JlZXMgYXJlIHN1cHBvcnRlZC4KLSAqCi0g
KiBSZXR1cm46Ci0gKiBUcnVlIGlmIHRoZSBwbGFuZSBjYW4gZG8gdGhlIHJvdGF0aW9uLCBmYWxz
ZSBvdGhlcndpc2UuCi0gKi8KLWJvb2wgZHJtX2NsaWVudF9wYW5lbF9yb3RhdGlvbihzdHJ1Y3Qg
ZHJtX21vZGVfc2V0ICptb2Rlc2V0LCB1bnNpZ25lZCBpbnQgKnJvdGF0aW9uKQotewotCXN0cnVj
dCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IgPSBtb2Rlc2V0LT5jb25uZWN0b3JzWzBdOwotCXN0
cnVjdCBkcm1fcGxhbmUgKnBsYW5lID0gbW9kZXNldC0+Y3J0Yy0+cHJpbWFyeTsKLQl1NjQgdmFs
aWRfbWFzayA9IDA7Ci0JdW5zaWduZWQgaW50IGk7Ci0KLQlpZiAoIW1vZGVzZXQtPm51bV9jb25u
ZWN0b3JzKQotCQlyZXR1cm4gZmFsc2U7Ci0KLQlzd2l0Y2ggKGNvbm5lY3Rvci0+ZGlzcGxheV9p
bmZvLnBhbmVsX29yaWVudGF0aW9uKSB7Ci0JY2FzZSBEUk1fTU9ERV9QQU5FTF9PUklFTlRBVElP
Tl9CT1RUT01fVVA6Ci0JCSpyb3RhdGlvbiA9IERSTV9NT0RFX1JPVEFURV8xODA7Ci0JCWJyZWFr
OwotCWNhc2UgRFJNX01PREVfUEFORUxfT1JJRU5UQVRJT05fTEVGVF9VUDoKLQkJKnJvdGF0aW9u
ID0gRFJNX01PREVfUk9UQVRFXzkwOwotCQlicmVhazsKLQljYXNlIERSTV9NT0RFX1BBTkVMX09S
SUVOVEFUSU9OX1JJR0hUX1VQOgotCQkqcm90YXRpb24gPSBEUk1fTU9ERV9ST1RBVEVfMjcwOwot
CQlicmVhazsKLQlkZWZhdWx0OgotCQkqcm90YXRpb24gPSBEUk1fTU9ERV9ST1RBVEVfMDsKLQl9
Ci0KLQkvKgotCSAqIFRPRE86IHN1cHBvcnQgOTAgLyAyNzAgZGVncmVlIGhhcmR3YXJlIHJvdGF0
aW9uLAotCSAqIGRlcGVuZGluZyBvbiB0aGUgaGFyZHdhcmUgdGhpcyBtYXkgcmVxdWlyZSB0aGUg
ZnJhbWVidWZmZXIKLQkgKiB0byBiZSBpbiBhIHNwZWNpZmljIHRpbGluZyBmb3JtYXQuCi0JICov
Ci0JaWYgKCpyb3RhdGlvbiAhPSBEUk1fTU9ERV9ST1RBVEVfMTgwIHx8ICFwbGFuZS0+cm90YXRp
b25fcHJvcGVydHkpCi0JCXJldHVybiBmYWxzZTsKLQotCWZvciAoaSA9IDA7IGkgPCBwbGFuZS0+
cm90YXRpb25fcHJvcGVydHktPm51bV92YWx1ZXM7IGkrKykKLQkJdmFsaWRfbWFzayB8PSAoMVVM
TCA8PCBwbGFuZS0+cm90YXRpb25fcHJvcGVydHktPnZhbHVlc1tpXSk7Ci0KLQlpZiAoISgqcm90
YXRpb24gJiB2YWxpZF9tYXNrKSkKLQkJcmV0dXJuIGZhbHNlOwotCi0JcmV0dXJuIHRydWU7Ci19
Ci0KLXN0YXRpYyBpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9hdG9taWMoc3RydWN0IGRy
bV9jbGllbnRfZGV2ICpjbGllbnQsIGJvb2wgYWN0aXZlKQotewotCXN0cnVjdCBkcm1fZGV2aWNl
ICpkZXYgPSBjbGllbnQtPmRldjsKLQlzdHJ1Y3QgZHJtX3BsYW5lX3N0YXRlICpwbGFuZV9zdGF0
ZTsKLQlzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZTsKLQlzdHJ1Y3QgZHJtX2F0b21pY19zdGF0ZSAq
c3RhdGU7Ci0Jc3RydWN0IGRybV9tb2Rlc2V0X2FjcXVpcmVfY3R4IGN0eDsKLQlzdHJ1Y3QgZHJt
X21vZGVfc2V0ICptb2RlX3NldDsKLQlpbnQgcmV0OwotCi0JZHJtX21vZGVzZXRfYWNxdWlyZV9p
bml0KCZjdHgsIDApOwotCi0Jc3RhdGUgPSBkcm1fYXRvbWljX3N0YXRlX2FsbG9jKGRldik7Ci0J
aWYgKCFzdGF0ZSkgewotCQlyZXQgPSAtRU5PTUVNOwotCQlnb3RvIG91dF9jdHg7Ci0JfQotCi0J
c3RhdGUtPmFjcXVpcmVfY3R4ID0gJmN0eDsKLXJldHJ5OgotCWRybV9mb3JfZWFjaF9wbGFuZShw
bGFuZSwgZGV2KSB7Ci0JCXBsYW5lX3N0YXRlID0gZHJtX2F0b21pY19nZXRfcGxhbmVfc3RhdGUo
c3RhdGUsIHBsYW5lKTsKLQkJaWYgKElTX0VSUihwbGFuZV9zdGF0ZSkpIHsKLQkJCXJldCA9IFBU
Ul9FUlIocGxhbmVfc3RhdGUpOwotCQkJZ290byBvdXRfc3RhdGU7Ci0JCX0KLQotCQlwbGFuZV9z
dGF0ZS0+cm90YXRpb24gPSBEUk1fTU9ERV9ST1RBVEVfMDsKLQotCQkvKiBkaXNhYmxlIG5vbi1w
cmltYXJ5OiAqLwotCQlpZiAocGxhbmUtPnR5cGUgPT0gRFJNX1BMQU5FX1RZUEVfUFJJTUFSWSkK
LQkJCWNvbnRpbnVlOwotCi0JCXJldCA9IF9fZHJtX2F0b21pY19oZWxwZXJfZGlzYWJsZV9wbGFu
ZShwbGFuZSwgcGxhbmVfc3RhdGUpOwotCQlpZiAocmV0ICE9IDApCi0JCQlnb3RvIG91dF9zdGF0
ZTsKLQl9Ci0KLQlkcm1fY2xpZW50X2Zvcl9lYWNoX21vZGVzZXQobW9kZV9zZXQsIGNsaWVudCkg
ewotCQlzdHJ1Y3QgZHJtX3BsYW5lICpwcmltYXJ5ID0gbW9kZV9zZXQtPmNydGMtPnByaW1hcnk7
Ci0JCXVuc2lnbmVkIGludCByb3RhdGlvbjsKLQotCQlpZiAoZHJtX2NsaWVudF9wYW5lbF9yb3Rh
dGlvbihtb2RlX3NldCwgJnJvdGF0aW9uKSkgewotCQkJLyogQ2Fubm90IGZhaWwgYXMgd2UndmUg
YWxyZWFkeSBnb3R0ZW4gdGhlIHBsYW5lIHN0YXRlIGFib3ZlICovCi0JCQlwbGFuZV9zdGF0ZSA9
IGRybV9hdG9taWNfZ2V0X25ld19wbGFuZV9zdGF0ZShzdGF0ZSwgcHJpbWFyeSk7Ci0JCQlwbGFu
ZV9zdGF0ZS0+cm90YXRpb24gPSByb3RhdGlvbjsKLQkJfQotCi0JCXJldCA9IF9fZHJtX2F0b21p
Y19oZWxwZXJfc2V0X2NvbmZpZyhtb2RlX3NldCwgc3RhdGUpOwotCQlpZiAocmV0ICE9IDApCi0J
CQlnb3RvIG91dF9zdGF0ZTsKLQotCQkvKgotCQkgKiBfX2RybV9hdG9taWNfaGVscGVyX3NldF9j
b25maWcoKSBzZXRzIGFjdGl2ZSB3aGVuIGEKLQkJICogbW9kZSBpcyBzZXQsIHVuY29uZGl0aW9u
YWxseSBjbGVhciBpdCBpZiB3ZSBmb3JjZSBEUE1TIG9mZgotCQkgKi8KLQkJaWYgKCFhY3RpdmUp
IHsKLQkJCXN0cnVjdCBkcm1fY3J0YyAqY3J0YyA9IG1vZGVfc2V0LT5jcnRjOwotCQkJc3RydWN0
IGRybV9jcnRjX3N0YXRlICpjcnRjX3N0YXRlID0gZHJtX2F0b21pY19nZXRfbmV3X2NydGNfc3Rh
dGUoc3RhdGUsIGNydGMpOwotCi0JCQljcnRjX3N0YXRlLT5hY3RpdmUgPSBmYWxzZTsKLQkJfQot
CX0KLQotCXJldCA9IGRybV9hdG9taWNfY29tbWl0KHN0YXRlKTsKLQotb3V0X3N0YXRlOgotCWlm
IChyZXQgPT0gLUVERUFETEspCi0JCWdvdG8gYmFja29mZjsKLQotCWRybV9hdG9taWNfc3RhdGVf
cHV0KHN0YXRlKTsKLW91dF9jdHg6Ci0JZHJtX21vZGVzZXRfZHJvcF9sb2NrcygmY3R4KTsKLQlk
cm1fbW9kZXNldF9hY3F1aXJlX2ZpbmkoJmN0eCk7Ci0KLQlyZXR1cm4gcmV0OwotCi1iYWNrb2Zm
OgotCWRybV9hdG9taWNfc3RhdGVfY2xlYXIoc3RhdGUpOwotCWRybV9tb2Rlc2V0X2JhY2tvZmYo
JmN0eCk7Ci0KLQlnb3RvIHJldHJ5OwotfQotCi1zdGF0aWMgaW50IGRybV9jbGllbnRfbW9kZXNl
dF9jb21taXRfbGVnYWN5KHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50KQotewotCXN0cnVj
dCBkcm1fZGV2aWNlICpkZXYgPSBjbGllbnQtPmRldjsKLQlzdHJ1Y3QgZHJtX21vZGVfc2V0ICpt
b2RlX3NldDsKLQlzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZTsKLQlpbnQgcmV0ID0gMDsKLQotCWRy
bV9tb2Rlc2V0X2xvY2tfYWxsKGRldik7Ci0JZHJtX2Zvcl9lYWNoX3BsYW5lKHBsYW5lLCBkZXYp
IHsKLQkJaWYgKHBsYW5lLT50eXBlICE9IERSTV9QTEFORV9UWVBFX1BSSU1BUlkpCi0JCQlkcm1f
cGxhbmVfZm9yY2VfZGlzYWJsZShwbGFuZSk7Ci0KLQkJaWYgKHBsYW5lLT5yb3RhdGlvbl9wcm9w
ZXJ0eSkKLQkJCWRybV9tb2RlX3BsYW5lX3NldF9vYmpfcHJvcChwbGFuZSwKLQkJCQkJCSAgICBw
bGFuZS0+cm90YXRpb25fcHJvcGVydHksCi0JCQkJCQkgICAgRFJNX01PREVfUk9UQVRFXzApOwot
CX0KLQotCWRybV9jbGllbnRfZm9yX2VhY2hfbW9kZXNldChtb2RlX3NldCwgY2xpZW50KSB7Ci0J
CXN0cnVjdCBkcm1fY3J0YyAqY3J0YyA9IG1vZGVfc2V0LT5jcnRjOwotCi0JCWlmIChjcnRjLT5m
dW5jcy0+Y3Vyc29yX3NldDIpIHsKLQkJCXJldCA9IGNydGMtPmZ1bmNzLT5jdXJzb3Jfc2V0Mihj
cnRjLCBOVUxMLCAwLCAwLCAwLCAwLCAwKTsKLQkJCWlmIChyZXQpCi0JCQkJZ290byBvdXQ7Ci0J
CX0gZWxzZSBpZiAoY3J0Yy0+ZnVuY3MtPmN1cnNvcl9zZXQpIHsKLQkJCXJldCA9IGNydGMtPmZ1
bmNzLT5jdXJzb3Jfc2V0KGNydGMsIE5VTEwsIDAsIDAsIDApOwotCQkJaWYgKHJldCkKLQkJCQln
b3RvIG91dDsKLQkJfQotCi0JCXJldCA9IGRybV9tb2RlX3NldF9jb25maWdfaW50ZXJuYWwobW9k
ZV9zZXQpOwotCQlpZiAocmV0KQotCQkJZ290byBvdXQ7Ci0JfQotb3V0OgotCWRybV9tb2Rlc2V0
X3VubG9ja19hbGwoZGV2KTsKLQotCXJldHVybiByZXQ7Ci19Ci0KLS8qKgotICogZHJtX2NsaWVu
dF9tb2Rlc2V0X2NvbW1pdF9mb3JjZSgpIC0gRm9yY2UgY29tbWl0IENSVEMgY29uZmlndXJhdGlv
bgotICogQGNsaWVudDogRFJNIGNsaWVudAotICoKLSAqIENvbW1pdCBtb2Rlc2V0IGNvbmZpZ3Vy
YXRpb24gdG8gY3J0Y3Mgd2l0aG91dCBjaGVja2luZyBpZiB0aGVyZSBpcyBhIERSTSBtYXN0ZXIu
Ci0gKgotICogUmV0dXJuczoKLSAqIFplcm8gb24gc3VjY2VzcyBvciBuZWdhdGl2ZSBlcnJvciBj
b2RlIG9uIGZhaWx1cmUuCi0gKi8KLWludCBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2ZvcmNl
KHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50KQotewotCXN0cnVjdCBkcm1fZGV2aWNlICpk
ZXYgPSBjbGllbnQtPmRldjsKLQlpbnQgcmV0OwotCi0JbXV0ZXhfbG9jaygmY2xpZW50LT5tb2Rl
c2V0X211dGV4KTsKLQlpZiAoZHJtX2Rydl91c2VzX2F0b21pY19tb2Rlc2V0KGRldikpCi0JCXJl
dCA9IGRybV9jbGllbnRfbW9kZXNldF9jb21taXRfYXRvbWljKGNsaWVudCwgdHJ1ZSk7Ci0JZWxz
ZQotCQlyZXQgPSBkcm1fY2xpZW50X21vZGVzZXRfY29tbWl0X2xlZ2FjeShjbGllbnQpOwotCW11
dGV4X3VubG9jaygmY2xpZW50LT5tb2Rlc2V0X211dGV4KTsKLQotCXJldHVybiByZXQ7Ci19Ci0K
LS8qKgotICogZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdCgpIC0gQ29tbWl0IENSVEMgY29uZmln
dXJhdGlvbgotICogQGNsaWVudDogRFJNIGNsaWVudAotICoKLSAqIENvbW1pdCBtb2Rlc2V0IGNv
bmZpZ3VyYXRpb24gdG8gY3J0Y3MuCi0gKgotICogUmV0dXJuczoKLSAqIFplcm8gb24gc3VjY2Vz
cyBvciBuZWdhdGl2ZSBlcnJvciBjb2RlIG9uIGZhaWx1cmUuCi0gKi8KLWludCBkcm1fY2xpZW50
X21vZGVzZXRfY29tbWl0KHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50KQotewotCXN0cnVj
dCBkcm1fZGV2aWNlICpkZXYgPSBjbGllbnQtPmRldjsKLQlpbnQgcmV0OwotCi0JaWYgKCFkcm1f
bWFzdGVyX2ludGVybmFsX2FjcXVpcmUoZGV2KSkKLQkJcmV0dXJuIC1FQlVTWTsKLQotCXJldCA9
IGRybV9jbGllbnRfbW9kZXNldF9jb21taXRfZm9yY2UoY2xpZW50KTsKLQotCWRybV9tYXN0ZXJf
aW50ZXJuYWxfcmVsZWFzZShkZXYpOwotCi0JcmV0dXJuIHJldDsKLX0KLQogLyoqCiAgKiBkcm1f
ZmJfaGVscGVyX3Jlc3RvcmVfZmJkZXZfbW9kZV91bmxvY2tlZCAtIHJlc3RvcmUgZmJkZXYgY29u
ZmlndXJhdGlvbgogICogQGZiX2hlbHBlcjogZHJpdmVyLWFsbG9jYXRlZCBmYmRldiBoZWxwZXIs
IGNhbiBiZSBOVUxMCkBAIC03MTksNTggKzQ4OSw2IEBAIHN0YXRpYyBzdHJ1Y3Qgc3lzcnFfa2V5
X29wIHN5c3JxX2RybV9mYl9oZWxwZXJfcmVzdG9yZV9vcCA9IHsKIHN0YXRpYyBzdHJ1Y3Qgc3lz
cnFfa2V5X29wIHN5c3JxX2RybV9mYl9oZWxwZXJfcmVzdG9yZV9vcCA9IHsgfTsKICNlbmRpZgog
Ci1zdGF0aWMgdm9pZCBkcm1fY2xpZW50X21vZGVzZXRfZHBtc19sZWdhY3koc3RydWN0IGRybV9j
bGllbnRfZGV2ICpjbGllbnQsIGludCBkcG1zX21vZGUpCi17Ci0Jc3RydWN0IGRybV9kZXZpY2Ug
KmRldiA9IGNsaWVudC0+ZGV2OwotCXN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3I7Ci0J
c3RydWN0IGRybV9tb2RlX3NldCAqbW9kZXNldDsKLQlpbnQgajsKLQotCWRybV9tb2Rlc2V0X2xv
Y2tfYWxsKGRldik7Ci0JZHJtX2NsaWVudF9mb3JfZWFjaF9tb2Rlc2V0KG1vZGVzZXQsIGNsaWVu
dCkgewotCQlpZiAoIW1vZGVzZXQtPmNydGMtPmVuYWJsZWQpCi0JCQljb250aW51ZTsKLQotCQlm
b3IgKGogPSAwOyBqIDwgbW9kZXNldC0+bnVtX2Nvbm5lY3RvcnM7IGorKykgewotCQkJY29ubmVj
dG9yID0gbW9kZXNldC0+Y29ubmVjdG9yc1tqXTsKLQkJCWNvbm5lY3Rvci0+ZnVuY3MtPmRwbXMo
Y29ubmVjdG9yLCBkcG1zX21vZGUpOwotCQkJZHJtX29iamVjdF9wcm9wZXJ0eV9zZXRfdmFsdWUo
JmNvbm5lY3Rvci0+YmFzZSwKLQkJCQlkZXYtPm1vZGVfY29uZmlnLmRwbXNfcHJvcGVydHksIGRw
bXNfbW9kZSk7Ci0JCX0KLQl9Ci0JZHJtX21vZGVzZXRfdW5sb2NrX2FsbChkZXYpOwotfQotCi0v
KioKLSAqIGRybV9jbGllbnRfbW9kZXNldF9kcG1zKCkgLSBTZXQgRFBNUyBtb2RlCi0gKiBAY2xp
ZW50OiBEUk0gY2xpZW50Ci0gKiBAbW9kZTogRFBNUyBtb2RlCi0gKgotICogTm90ZTogRm9yIGF0
b21pYyBkcml2ZXJzIEBtb2RlIGlzIHJlZHVjZWQgdG8gb24vb2ZmLgotICoKLSAqIFJldHVybnM6
Ci0gKiBaZXJvIG9uIHN1Y2Nlc3Mgb3IgbmVnYXRpdmUgZXJyb3IgY29kZSBvbiBmYWlsdXJlLgot
ICovCi1pbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2RwbXMoc3RydWN0IGRybV9jbGllbnRfZGV2ICpj
bGllbnQsIGludCBtb2RlKQotewotCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBjbGllbnQtPmRl
djsKLQlpbnQgcmV0ID0gMDsKLQotCWlmICghZHJtX21hc3Rlcl9pbnRlcm5hbF9hY3F1aXJlKGRl
dikpCi0JCXJldHVybiAtRUJVU1k7Ci0KLQltdXRleF9sb2NrKCZjbGllbnQtPm1vZGVzZXRfbXV0
ZXgpOwotCWlmIChkcm1fZHJ2X3VzZXNfYXRvbWljX21vZGVzZXQoZGV2KSkKLQkJcmV0ID0gZHJt
X2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9hdG9taWMoY2xpZW50LCBtb2RlID09IERSTV9NT0RFX0RQ
TVNfT04pOwotCWVsc2UKLQkJZHJtX2NsaWVudF9tb2Rlc2V0X2RwbXNfbGVnYWN5KGNsaWVudCwg
bW9kZSk7Ci0JbXV0ZXhfdW5sb2NrKCZjbGllbnQtPm1vZGVzZXRfbXV0ZXgpOwotCi0JZHJtX21h
c3Rlcl9pbnRlcm5hbF9yZWxlYXNlKGRldik7Ci0KLQlyZXR1cm4gcmV0OwotfQotCiBzdGF0aWMg
dm9pZCBkcm1fZmJfaGVscGVyX2RwbXMoc3RydWN0IGZiX2luZm8gKmluZm8sIGludCBkcG1zX21v
ZGUpCiB7CiAJc3RydWN0IGRybV9mYl9oZWxwZXIgKmZiX2hlbHBlciA9IGluZm8tPnBhcjsKZGlm
ZiAtLWdpdCBhL2luY2x1ZGUvZHJtL2RybV9jbGllbnQuaCBiL2luY2x1ZGUvZHJtL2RybV9jbGll
bnQuaAppbmRleCA4N2JlOWFlYjFmZTAuLjZjZjQ4NDE5Zjc3ZiAxMDA2NDQKLS0tIGEvaW5jbHVk
ZS9kcm0vZHJtX2NsaWVudC5oCisrKyBiL2luY2x1ZGUvZHJtL2RybV9jbGllbnQuaApAQCAtMTU1
LDYgKzE1NSwxMCBAQCBpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2NyZWF0ZShzdHJ1Y3QgZHJtX2Ns
aWVudF9kZXYgKmNsaWVudCk7CiB2b2lkIGRybV9jbGllbnRfbW9kZXNldF9mcmVlKHN0cnVjdCBk
cm1fY2xpZW50X2RldiAqY2xpZW50KTsKIHZvaWQgZHJtX2NsaWVudF9tb2Rlc2V0X3JlbGVhc2Uo
c3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQpOwogc3RydWN0IGRybV9tb2RlX3NldCAqZHJt
X2NsaWVudF9maW5kX21vZGVzZXQoc3RydWN0IGRybV9jbGllbnRfZGV2ICpjbGllbnQsIHN0cnVj
dCBkcm1fY3J0YyAqY3J0Yyk7Citib29sIGRybV9jbGllbnRfcGFuZWxfcm90YXRpb24oc3RydWN0
IGRybV9tb2RlX3NldCAqbW9kZXNldCwgdW5zaWduZWQgaW50ICpyb3RhdGlvbik7CitpbnQgZHJt
X2NsaWVudF9tb2Rlc2V0X2NvbW1pdF9mb3JjZShzdHJ1Y3QgZHJtX2NsaWVudF9kZXYgKmNsaWVu
dCk7CitpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2NvbW1pdChzdHJ1Y3QgZHJtX2NsaWVudF9kZXYg
KmNsaWVudCk7CitpbnQgZHJtX2NsaWVudF9tb2Rlc2V0X2RwbXMoc3RydWN0IGRybV9jbGllbnRf
ZGV2ICpjbGllbnQsIGludCBtb2RlKTsKIAogLyoqCiAgKiBkcm1fY2xpZW50X2Zvcl9lYWNoX21v
ZGVzZXQoKSAtIEl0ZXJhdGUgb3ZlciBjbGllbnQgbW9kZXNldHMKLS0gCjIuMjAuMQoKX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxp
bmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJl
ZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
