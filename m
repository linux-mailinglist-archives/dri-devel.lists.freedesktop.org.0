Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B4F22DFBCA
	for <lists+dri-devel@lfdr.de>; Tue, 22 Oct 2019 04:39:59 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id AEAB86E33C;
	Tue, 22 Oct 2019 02:39:39 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from us-smtp-1.mimecast.com (us-smtp-delivery-1.mimecast.com
 [205.139.110.120])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C31AB6E338
 for <dri-devel@lists.freedesktop.org>; Tue, 22 Oct 2019 02:39:34 +0000 (UTC)
Received: from mimecast-mx01.redhat.com (mimecast-mx01.redhat.com
 [209.132.183.4]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-322-qR7bjEg4PsiI7ovS9UyfFw-1; Mon, 21 Oct 2019 22:39:28 -0400
Received: from smtp.corp.redhat.com (int-mx01.intmail.prod.int.phx2.redhat.com
 [10.5.11.11])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mimecast-mx01.redhat.com (Postfix) with ESMTPS id E4D4980183E;
 Tue, 22 Oct 2019 02:39:25 +0000 (UTC)
Received: from malachite.redhat.com (ovpn-120-98.rdu2.redhat.com
 [10.10.120.98])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 5024E60126;
 Tue, 22 Oct 2019 02:39:22 +0000 (UTC)
From: Lyude Paul <lyude@redhat.com>
To: dri-devel@lists.freedesktop.org, amd-gfx@lists.freedesktop.org,
 nouveau@lists.freedesktop.org, intel-gfx@lists.freedesktop.org
Subject: [PATCH v5 03/14] drm/dp_mst: Refactor pdt setup/teardown,
 add more locking
Date: Mon, 21 Oct 2019 22:35:58 -0400
Message-Id: <20191022023641.8026-4-lyude@redhat.com>
In-Reply-To: <20191022023641.8026-1-lyude@redhat.com>
References: <20191022023641.8026-1-lyude@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.11
X-MC-Unique: qR7bjEg4PsiI7ovS9UyfFw-1
X-Mimecast-Spam-Score: 0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=redhat.com; 
 s=mimecast20190719; t=1571711972;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=ldA+AbIFIpkUtA1uahHeNuAYUSYSp7wzYpnTWoOE15w=;
 b=PmwKC0teEUJi3BmhDbd4gW9lHDLsh2AOxVeZ7YJsxojPypD3MzlcW6TkvmCGNZYIM0v5Qw
 sTkejV9cHM8mnH9q7xpQ660pfN8BJNuPeLycgHVTfQkuI0fLPgGXhF4khGmaoV3sPmc3vM
 W1BbCgkmiIX00gYX6eBoJCdP8/uCUV4=
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, Daniel Vetter <daniel.vetter@ffwll.ch>,
 linux-kernel@vger.kernel.org, Harry Wentland <hwentlan@amd.com>,
 Juston Li <juston.li@intel.com>, Sean Paul <sean@poorly.run>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2Ugd2UncmUgZ29pbmcgdG8gYmUgaW1wbGVtZW50aW5nIHN1c3BlbmQvcmVzdW1lIHJlcHJv
YmluZyB2ZXJ5IHNvb24sCndlIG5lZWQgdG8gbWFrZSBzdXJlIHdlIGFyZSBleHRyYSBjYXJlZnVs
IHRvIGVuc3VyZSB0aGF0IG91ciBsb2NraW5nCmFjdHVhbGx5IHByb3RlY3RzIHRoZSB0b3BvbG9n
eSBzdGF0ZSB3aGVyZSB3ZSBleHBlY3QgaXQgdG8uIFR1cm5zIG91dAp0aGlzIGlzbid0IHRoZSBj
YXNlIHdpdGggZHJtX2RwX3BvcnRfc2V0dXBfcGR0KCkgYW5kCmRybV9kcF9wb3J0X3RlYXJkb3du
X3BkdCgpLCBib3RoIG9mIHdoaWNoIGNoYW5nZSBwb3J0LT5tc3RiIHdpdGhvdXQKZ3JhYmJpbmcg
Jm1nci0+bG9jay4KCkFkZGl0aW9uYWxseSwgc2luY2UgbW9zdCBjYWxsZXJzIG9mIHRoZXNlIGZ1
bmN0aW9ucyBhcmUganVzdCB1c2luZyBpdCB0bwp0ZWFyZG93biB0aGUgcG9ydCdzIHByZXZpb3Vz
IFBEVCBhbmQgc2V0dXAgYSBuZXcgb25lIHdlIGNhbiBzaW1wbGlmeQp0aGluZ3MgYSBiaXQgYW5k
IGNvbWJpbmUgZHJtX2RwX3BvcnRfc2V0dXBfcGR0KCkgYW5kCmRybV9kcF9wb3J0X3RlYXJkb3du
X3BkdCgpIGludG8gYSBzaW5nbGUgZnVuY3Rpb246CmRybV9kcF9wb3J0X3NldF9wZHQoKS4gVGhp
cyBmdW5jdGlvbiBhbHNvIGhhbmRsZXMgYWN0dWFsbHkgZW5zdXJpbmcgdGhhdAp3ZSBncmFiIHRo
ZSBjb3JyZWN0IGxvY2tzIHdoZW4gd2UgbmVlZCB0byBtb2RpZnkgcG9ydC0+bXN0Yi4KCkNjOiBK
dXN0b24gTGkgPGp1c3Rvbi5saUBpbnRlbC5jb20+CkNjOiBJbXJlIERlYWsgPGltcmUuZGVha0Bp
bnRlbC5jb20+CkNjOiBWaWxsZSBTeXJqw6Rsw6QgPHZpbGxlLnN5cmphbGFAbGludXguaW50ZWwu
Y29tPgpDYzogSGFycnkgV2VudGxhbmQgPGh3ZW50bGFuQGFtZC5jb20+CkNjOiBEYW5pZWwgVmV0
dGVyIDxkYW5pZWwudmV0dGVyQGZmd2xsLmNoPgpTaWduZWQtb2ZmLWJ5OiBMeXVkZSBQYXVsIDxs
eXVkZUByZWRoYXQuY29tPgpSZXZpZXdlZC1ieTogU2VhbiBQYXVsIDxzZWFuQHBvb3JseS5ydW4+
Ci0tLQogZHJpdmVycy9ncHUvZHJtL2RybV9kcF9tc3RfdG9wb2xvZ3kuYyB8IDE4MSArKysrKysr
KysrKysrKystLS0tLS0tLS0tLQogaW5jbHVkZS9kcm0vZHJtX2RwX21zdF9oZWxwZXIuaCAgICAg
ICB8ICAgNiArLQogMiBmaWxlcyBjaGFuZ2VkLCAxMTAgaW5zZXJ0aW9ucygrKSwgNzcgZGVsZXRp
b25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2RybV9kcF9tc3RfdG9wb2xvZ3ku
YyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZHBfbXN0X3RvcG9sb2d5LmMKaW5kZXggMjA0ZDBjODMy
YzY1Li4zZjE2YzBjYjA5NGIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9kcm1fZHBfbXN0
X3RvcG9sb2d5LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2RybV9kcF9tc3RfdG9wb2xvZ3kuYwpA
QCAtMTQ4NiwyNCArMTQ4Niw2IEBAIGRybV9kcF9tc3RfdG9wb2xvZ3lfcHV0X21zdGIoc3RydWN0
IGRybV9kcF9tc3RfYnJhbmNoICptc3RiKQogCWtyZWZfcHV0KCZtc3RiLT50b3BvbG9neV9rcmVm
LCBkcm1fZHBfZGVzdHJveV9tc3RfYnJhbmNoX2RldmljZSk7CiB9CiAKLXN0YXRpYyB2b2lkIGRy
bV9kcF9wb3J0X3RlYXJkb3duX3BkdChzdHJ1Y3QgZHJtX2RwX21zdF9wb3J0ICpwb3J0LCBpbnQg
b2xkX3BkdCkKLXsKLQlzdHJ1Y3QgZHJtX2RwX21zdF9icmFuY2ggKm1zdGI7Ci0KLQlzd2l0Y2gg
KG9sZF9wZHQpIHsKLQljYXNlIERQX1BFRVJfREVWSUNFX0RQX0xFR0FDWV9DT05WOgotCWNhc2Ug
RFBfUEVFUl9ERVZJQ0VfU1NUX1NJTks6Ci0JCS8qIHJlbW92ZSBpMmMgb3ZlciBzaWRlYmFuZCAq
LwotCQlkcm1fZHBfbXN0X3VucmVnaXN0ZXJfaTJjX2J1cygmcG9ydC0+YXV4KTsKLQkJYnJlYWs7
Ci0JY2FzZSBEUF9QRUVSX0RFVklDRV9NU1RfQlJBTkNISU5HOgotCQltc3RiID0gcG9ydC0+bXN0
YjsKLQkJcG9ydC0+bXN0YiA9IE5VTEw7Ci0JCWRybV9kcF9tc3RfdG9wb2xvZ3lfcHV0X21zdGIo
bXN0Yik7Ci0JCWJyZWFrOwotCX0KLX0KLQogc3RhdGljIHZvaWQgZHJtX2RwX2Rlc3Ryb3lfcG9y
dChzdHJ1Y3Qga3JlZiAqa3JlZikKIHsKIAlzdHJ1Y3QgZHJtX2RwX21zdF9wb3J0ICpwb3J0ID0K
QEAgLTE3MTMsMzggKzE2OTUsNzkgQEAgc3RhdGljIHU4IGRybV9kcF9jYWxjdWxhdGVfcmFkKHN0
cnVjdCBkcm1fZHBfbXN0X3BvcnQgKnBvcnQsCiAJcmV0dXJuIHBhcmVudF9sY3QgKyAxOwogfQog
Ci0vKgotICogcmV0dXJuIHNlbmRzIGxpbmsgYWRkcmVzcyBmb3IgbmV3IG1zdGIKLSAqLwotc3Rh
dGljIGJvb2wgZHJtX2RwX3BvcnRfc2V0dXBfcGR0KHN0cnVjdCBkcm1fZHBfbXN0X3BvcnQgKnBv
cnQpCitzdGF0aWMgaW50IGRybV9kcF9wb3J0X3NldF9wZHQoc3RydWN0IGRybV9kcF9tc3RfcG9y
dCAqcG9ydCwgdTggbmV3X3BkdCkKIHsKLQlpbnQgcmV0OwotCXU4IHJhZFs2XSwgbGN0OwotCWJv
b2wgc2VuZF9saW5rID0gZmFsc2U7CisJc3RydWN0IGRybV9kcF9tc3RfdG9wb2xvZ3lfbWdyICpt
Z3IgPSBwb3J0LT5tZ3I7CisJc3RydWN0IGRybV9kcF9tc3RfYnJhbmNoICptc3RiOworCXU4IHJh
ZFs4XSwgbGN0OworCWludCByZXQgPSAwOworCisJaWYgKHBvcnQtPnBkdCA9PSBuZXdfcGR0KQor
CQlyZXR1cm4gMDsKKworCS8qIFRlYXJkb3duIHRoZSBvbGQgcGR0LCBpZiB0aGVyZSBpcyBvbmUg
Ki8KKwlzd2l0Y2ggKHBvcnQtPnBkdCkgeworCWNhc2UgRFBfUEVFUl9ERVZJQ0VfRFBfTEVHQUNZ
X0NPTlY6CisJY2FzZSBEUF9QRUVSX0RFVklDRV9TU1RfU0lOSzoKKwkJLyoKKwkJICogSWYgdGhl
IG5ldyBQRFQgd291bGQgYWxzbyBoYXZlIGFuIGkyYyBidXMsIGRvbid0IGJvdGhlcgorCQkgKiB3
aXRoIHJlcmVnaXN0ZXJpbmcgaXQKKwkJICovCisJCWlmIChuZXdfcGR0ID09IERQX1BFRVJfREVW
SUNFX0RQX0xFR0FDWV9DT05WIHx8CisJCSAgICBuZXdfcGR0ID09IERQX1BFRVJfREVWSUNFX1NT
VF9TSU5LKSB7CisJCQlwb3J0LT5wZHQgPSBuZXdfcGR0OworCQkJcmV0dXJuIDA7CisJCX0KKwor
CQkvKiByZW1vdmUgaTJjIG92ZXIgc2lkZWJhbmQgKi8KKwkJZHJtX2RwX21zdF91bnJlZ2lzdGVy
X2kyY19idXMoJnBvcnQtPmF1eCk7CisJCWJyZWFrOworCWNhc2UgRFBfUEVFUl9ERVZJQ0VfTVNU
X0JSQU5DSElORzoKKwkJbXV0ZXhfbG9jaygmbWdyLT5sb2NrKTsKKwkJZHJtX2RwX21zdF90b3Bv
bG9neV9wdXRfbXN0Yihwb3J0LT5tc3RiKTsKKwkJcG9ydC0+bXN0YiA9IE5VTEw7CisJCW11dGV4
X3VubG9jaygmbWdyLT5sb2NrKTsKKwkJYnJlYWs7CisJfQorCisJcG9ydC0+cGR0ID0gbmV3X3Bk
dDsKIAlzd2l0Y2ggKHBvcnQtPnBkdCkgewogCWNhc2UgRFBfUEVFUl9ERVZJQ0VfRFBfTEVHQUNZ
X0NPTlY6CiAJY2FzZSBEUF9QRUVSX0RFVklDRV9TU1RfU0lOSzoKIAkJLyogYWRkIGkyYyBvdmVy
IHNpZGViYW5kICovCiAJCXJldCA9IGRybV9kcF9tc3RfcmVnaXN0ZXJfaTJjX2J1cygmcG9ydC0+
YXV4KTsKIAkJYnJlYWs7CisKIAljYXNlIERQX1BFRVJfREVWSUNFX01TVF9CUkFOQ0hJTkc6CiAJ
CWxjdCA9IGRybV9kcF9jYWxjdWxhdGVfcmFkKHBvcnQsIHJhZCk7CisJCW1zdGIgPSBkcm1fZHBf
YWRkX21zdF9icmFuY2hfZGV2aWNlKGxjdCwgcmFkKTsKKwkJaWYgKCFtc3RiKSB7CisJCQlyZXQg
PSAtRU5PTUVNOworCQkJRFJNX0VSUk9SKCJGYWlsZWQgdG8gY3JlYXRlIE1TVEIgZm9yIHBvcnQg
JXAiLCBwb3J0KTsKKwkJCWdvdG8gb3V0OworCQl9CiAKLQkJcG9ydC0+bXN0YiA9IGRybV9kcF9h
ZGRfbXN0X2JyYW5jaF9kZXZpY2UobGN0LCByYWQpOwotCQlpZiAocG9ydC0+bXN0YikgewotCQkJ
cG9ydC0+bXN0Yi0+bWdyID0gcG9ydC0+bWdyOwotCQkJcG9ydC0+bXN0Yi0+cG9ydF9wYXJlbnQg
PSBwb3J0OwotCQkJLyoKLQkJCSAqIE1ha2Ugc3VyZSB0aGlzIHBvcnQncyBtZW1vcnkgYWxsb2Nh
dGlvbiBzdGF5cwotCQkJICogYXJvdW5kIHVudGlsIGl0cyBjaGlsZCBNU1RCIHJlbGVhc2VzIGl0
Ci0JCQkgKi8KLQkJCWRybV9kcF9tc3RfZ2V0X3BvcnRfbWFsbG9jKHBvcnQpOworCQltdXRleF9s
b2NrKCZtZ3ItPmxvY2spOworCQlwb3J0LT5tc3RiID0gbXN0YjsKKwkJbXN0Yi0+bWdyID0gcG9y
dC0+bWdyOworCQltc3RiLT5wb3J0X3BhcmVudCA9IHBvcnQ7CiAKLQkJCXNlbmRfbGluayA9IHRy
dWU7Ci0JCX0KKwkJLyoKKwkJICogTWFrZSBzdXJlIHRoaXMgcG9ydCdzIG1lbW9yeSBhbGxvY2F0
aW9uIHN0YXlzCisJCSAqIGFyb3VuZCB1bnRpbCBpdHMgY2hpbGQgTVNUQiByZWxlYXNlcyBpdAor
CQkgKi8KKwkJZHJtX2RwX21zdF9nZXRfcG9ydF9tYWxsb2MocG9ydCk7CisJCW11dGV4X3VubG9j
aygmbWdyLT5sb2NrKTsKKworCQkvKiBBbmQgbWFrZSBzdXJlIHdlIHNlbmQgYSBsaW5rIGFkZHJl
c3MgZm9yIHRoaXMgKi8KKwkJcmV0ID0gMTsKIAkJYnJlYWs7CiAJfQotCXJldHVybiBzZW5kX2xp
bms7CisKK291dDoKKwlpZiAocmV0IDwgMCkKKwkJcG9ydC0+cGR0ID0gRFBfUEVFUl9ERVZJQ0Vf
Tk9ORTsKKwlyZXR1cm4gcmV0OwogfQogCiAvKioKQEAgLTE4ODEsMTAgKzE5MDQsOSBAQCBkcm1f
ZHBfbXN0X2hhbmRsZV9saW5rX2FkZHJlc3NfcG9ydChzdHJ1Y3QgZHJtX2RwX21zdF9icmFuY2gg
Km1zdGIsCiAJCQkJICAgIHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJCQkJICAgIHN0cnVjdCBk
cm1fZHBfbGlua19hZGRyX3JlcGx5X3BvcnQgKnBvcnRfbXNnKQogeworCXN0cnVjdCBkcm1fZHBf
bXN0X3RvcG9sb2d5X21nciAqbWdyID0gbXN0Yi0+bWdyOwogCXN0cnVjdCBkcm1fZHBfbXN0X3Bv
cnQgKnBvcnQ7Ci0JYm9vbCByZXQ7CiAJYm9vbCBjcmVhdGVkID0gZmFsc2U7Ci0JaW50IG9sZF9w
ZHQgPSAwOwogCWludCBvbGRfZGRwcyA9IDA7CiAKIAlwb3J0ID0gZHJtX2RwX2dldF9wb3J0KG1z
dGIsIHBvcnRfbXNnLT5wb3J0X251bWJlcik7CkBAIC0xODk2LDcgKzE5MTgsNyBAQCBkcm1fZHBf
bXN0X2hhbmRsZV9saW5rX2FkZHJlc3NfcG9ydChzdHJ1Y3QgZHJtX2RwX21zdF9icmFuY2ggKm1z
dGIsCiAJCWtyZWZfaW5pdCgmcG9ydC0+bWFsbG9jX2tyZWYpOwogCQlwb3J0LT5wYXJlbnQgPSBt
c3RiOwogCQlwb3J0LT5wb3J0X251bSA9IHBvcnRfbXNnLT5wb3J0X251bWJlcjsKLQkJcG9ydC0+
bWdyID0gbXN0Yi0+bWdyOworCQlwb3J0LT5tZ3IgPSBtZ3I7CiAJCXBvcnQtPmF1eC5uYW1lID0g
IkRQTVNUIjsKIAkJcG9ydC0+YXV4LmRldiA9IGRldi0+ZGV2OwogCQlwb3J0LT5hdXguaXNfcmVt
b3RlID0gdHJ1ZTsKQEAgLTE5MDksMTEgKzE5MzEsOSBAQCBkcm1fZHBfbXN0X2hhbmRsZV9saW5r
X2FkZHJlc3NfcG9ydChzdHJ1Y3QgZHJtX2RwX21zdF9icmFuY2ggKm1zdGIsCiAKIAkJY3JlYXRl
ZCA9IHRydWU7CiAJfSBlbHNlIHsKLQkJb2xkX3BkdCA9IHBvcnQtPnBkdDsKIAkJb2xkX2RkcHMg
PSBwb3J0LT5kZHBzOwogCX0KIAotCXBvcnQtPnBkdCA9IHBvcnRfbXNnLT5wZWVyX2RldmljZV90
eXBlOwogCXBvcnQtPmlucHV0ID0gcG9ydF9tc2ctPmlucHV0X3BvcnQ7CiAJcG9ydC0+bWNzID0g
cG9ydF9tc2ctPm1jczsKIAlwb3J0LT5kZHBzID0gcG9ydF9tc2ctPmRkcHM7CkBAIC0xOTI1LDI5
ICsxOTQ1LDMzIEBAIGRybV9kcF9tc3RfaGFuZGxlX2xpbmtfYWRkcmVzc19wb3J0KHN0cnVjdCBk
cm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKIAkvKiBtYW5hZ2UgbXN0YiBwb3J0IGxpc3RzIHdpdGgg
bWdyIGxvY2sgLSB0YWtlIGEgcmVmZXJlbmNlCiAJICAgZm9yIHRoaXMgbGlzdCAqLwogCWlmIChj
cmVhdGVkKSB7Ci0JCW11dGV4X2xvY2soJm1zdGItPm1nci0+bG9jayk7CisJCW11dGV4X2xvY2so
Jm1nci0+bG9jayk7CiAJCWRybV9kcF9tc3RfdG9wb2xvZ3lfZ2V0X3BvcnQocG9ydCk7CiAJCWxp
c3RfYWRkKCZwb3J0LT5uZXh0LCAmbXN0Yi0+cG9ydHMpOwotCQltdXRleF91bmxvY2soJm1zdGIt
Pm1nci0+bG9jayk7CisJCW11dGV4X3VubG9jaygmbWdyLT5sb2NrKTsKIAl9CiAKIAlpZiAob2xk
X2RkcHMgIT0gcG9ydC0+ZGRwcykgewogCQlpZiAocG9ydC0+ZGRwcykgewogCQkJaWYgKCFwb3J0
LT5pbnB1dCkgewotCQkJCWRybV9kcF9zZW5kX2VudW1fcGF0aF9yZXNvdXJjZXMobXN0Yi0+bWdy
LAotCQkJCQkJCQltc3RiLCBwb3J0KTsKKwkJCQlkcm1fZHBfc2VuZF9lbnVtX3BhdGhfcmVzb3Vy
Y2VzKG1nciwgbXN0YiwKKwkJCQkJCQkJcG9ydCk7CiAJCQl9CiAJCX0gZWxzZSB7CiAJCQlwb3J0
LT5hdmFpbGFibGVfcGJuID0gMDsKIAkJfQogCX0KIAotCWlmIChvbGRfcGR0ICE9IHBvcnQtPnBk
dCAmJiAhcG9ydC0+aW5wdXQpIHsKLQkJZHJtX2RwX3BvcnRfdGVhcmRvd25fcGR0KHBvcnQsIG9s
ZF9wZHQpOwotCi0JCXJldCA9IGRybV9kcF9wb3J0X3NldHVwX3BkdChwb3J0KTsKLQkJaWYgKHJl
dCA9PSB0cnVlKQotCQkJZHJtX2RwX3NlbmRfbGlua19hZGRyZXNzKG1zdGItPm1nciwgcG9ydC0+
bXN0Yik7CisJaWYgKCFwb3J0LT5pbnB1dCkgeworCQlpbnQgcmV0ID0gZHJtX2RwX3BvcnRfc2V0
X3BkdChwb3J0LAorCQkJCQkgICAgICBwb3J0X21zZy0+cGVlcl9kZXZpY2VfdHlwZSk7CisJCWlm
IChyZXQgPT0gMSkgeworCQkJZHJtX2RwX3NlbmRfbGlua19hZGRyZXNzKG1nciwgcG9ydC0+bXN0
Yik7CisJCX0gZWxzZSBpZiAocmV0IDwgMCkgeworCQkJRFJNX0VSUk9SKCJGYWlsZWQgdG8gY2hh
bmdlIFBEVCBvbiBwb3J0ICVwOiAlZFxuIiwKKwkJCQkgIHBvcnQsIHJldCk7CisJCQlnb3RvIGZh
aWw7CisJCX0KIAl9CiAKIAlpZiAoY3JlYXRlZCAmJiAhcG9ydC0+aW5wdXQpIHsKQEAgLTE5NTUs
MTggKzE5NzksMTEgQEAgZHJtX2RwX21zdF9oYW5kbGVfbGlua19hZGRyZXNzX3BvcnQoc3RydWN0
IGRybV9kcF9tc3RfYnJhbmNoICptc3RiLAogCiAJCWJ1aWxkX21zdF9wcm9wX3BhdGgobXN0Yiwg
cG9ydC0+cG9ydF9udW0sIHByb3BwYXRoLAogCQkJCSAgICBzaXplb2YocHJvcHBhdGgpKTsKLQkJ
cG9ydC0+Y29ubmVjdG9yID0gKCptc3RiLT5tZ3ItPmNicy0+YWRkX2Nvbm5lY3RvcikobXN0Yi0+
bWdyLAotCQkJCQkJCQkgICBwb3J0LAotCQkJCQkJCQkgICBwcm9wcGF0aCk7Ci0JCWlmICghcG9y
dC0+Y29ubmVjdG9yKSB7Ci0JCQkvKiByZW1vdmUgaXQgZnJvbSB0aGUgcG9ydCBsaXN0ICovCi0J
CQltdXRleF9sb2NrKCZtc3RiLT5tZ3ItPmxvY2spOwotCQkJbGlzdF9kZWwoJnBvcnQtPm5leHQp
OwotCQkJbXV0ZXhfdW5sb2NrKCZtc3RiLT5tZ3ItPmxvY2spOwotCQkJLyogZHJvcCBwb3J0IGxp
c3QgcmVmZXJlbmNlICovCi0JCQlkcm1fZHBfbXN0X3RvcG9sb2d5X3B1dF9wb3J0KHBvcnQpOwot
CQkJZ290byBvdXQ7Ci0JCX0KKwkJcG9ydC0+Y29ubmVjdG9yID0gKCptZ3ItPmNicy0+YWRkX2Nv
bm5lY3RvcikobWdyLCBwb3J0LAorCQkJCQkJCSAgICAgcHJvcHBhdGgpOworCQlpZiAoIXBvcnQt
PmNvbm5lY3RvcikKKwkJCWdvdG8gZmFpbDsKKwogCQlpZiAoKHBvcnQtPnBkdCA9PSBEUF9QRUVS
X0RFVklDRV9EUF9MRUdBQ1lfQ09OViB8fAogCQkgICAgIHBvcnQtPnBkdCA9PSBEUF9QRUVSX0RF
VklDRV9TU1RfU0lOSykgJiYKIAkJICAgIHBvcnQtPnBvcnRfbnVtID49IERQX01TVF9MT0dJQ0FM
X1BPUlRfMCkgewpAQCAtMTk3NCwxMiArMTk5MSwyNCBAQCBkcm1fZHBfbXN0X2hhbmRsZV9saW5r
X2FkZHJlc3NfcG9ydChzdHJ1Y3QgZHJtX2RwX21zdF9icmFuY2ggKm1zdGIsCiAJCQkJCQkJICZw
b3J0LT5hdXguZGRjKTsKIAkJCWRybV9jb25uZWN0b3Jfc2V0X3RpbGVfcHJvcGVydHkocG9ydC0+
Y29ubmVjdG9yKTsKIAkJfQotCQkoKm1zdGItPm1nci0+Y2JzLT5yZWdpc3Rlcl9jb25uZWN0b3Ip
KHBvcnQtPmNvbm5lY3Rvcik7CisKKwkJKCptZ3ItPmNicy0+cmVnaXN0ZXJfY29ubmVjdG9yKShw
b3J0LT5jb25uZWN0b3IpOwogCX0KIAotb3V0OgogCS8qIHB1dCByZWZlcmVuY2UgdG8gdGhpcyBw
b3J0ICovCiAJZHJtX2RwX21zdF90b3BvbG9neV9wdXRfcG9ydChwb3J0KTsKKwlyZXR1cm47CisK
K2ZhaWw6CisJLyogUmVtb3ZlIGl0IGZyb20gdGhlIHBvcnQgbGlzdCAqLworCW11dGV4X2xvY2so
Jm1nci0+bG9jayk7CisJbGlzdF9kZWwoJnBvcnQtPm5leHQpOworCW11dGV4X3VubG9jaygmbWdy
LT5sb2NrKTsKKworCS8qIERyb3AgdGhlIHBvcnQgbGlzdCByZWZlcmVuY2UgKi8KKwlkcm1fZHBf
bXN0X3RvcG9sb2d5X3B1dF9wb3J0KHBvcnQpOworCS8qIEFuZCBub3cgZHJvcCBvdXIgcmVmZXJl
bmNlICovCisJZHJtX2RwX21zdF90b3BvbG9neV9wdXRfcG9ydChwb3J0KTsKIH0KIAogc3RhdGlj
IHZvaWQKQEAgLTE5ODcsMTYgKzIwMTYsMTQgQEAgZHJtX2RwX21zdF9oYW5kbGVfY29ubl9zdGF0
KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKIAkJCSAgICBzdHJ1Y3QgZHJtX2RwX2Nv
bm5lY3Rpb25fc3RhdHVzX25vdGlmeSAqY29ubl9zdGF0KQogewogCXN0cnVjdCBkcm1fZHBfbXN0
X3BvcnQgKnBvcnQ7Ci0JaW50IG9sZF9wZHQ7CiAJaW50IG9sZF9kZHBzOwogCWJvb2wgZG93b3Jr
ID0gZmFsc2U7CisKIAlwb3J0ID0gZHJtX2RwX2dldF9wb3J0KG1zdGIsIGNvbm5fc3RhdC0+cG9y
dF9udW1iZXIpOwogCWlmICghcG9ydCkKIAkJcmV0dXJuOwogCiAJb2xkX2RkcHMgPSBwb3J0LT5k
ZHBzOwotCW9sZF9wZHQgPSBwb3J0LT5wZHQ7Ci0JcG9ydC0+cGR0ID0gY29ubl9zdGF0LT5wZWVy
X2RldmljZV90eXBlOwogCXBvcnQtPm1jcyA9IGNvbm5fc3RhdC0+bWVzc2FnZV9jYXBhYmlsaXR5
X3N0YXR1czsKIAlwb3J0LT5sZHBzID0gY29ubl9zdGF0LT5sZWdhY3lfZGV2aWNlX3BsdWdfc3Rh
dHVzOwogCXBvcnQtPmRkcHMgPSBjb25uX3N0YXQtPmRpc3BsYXlwb3J0X2RldmljZV9wbHVnX3N0
YXR1czsKQEAgLTIwMDgsMTEgKzIwMzUsMTcgQEAgZHJtX2RwX21zdF9oYW5kbGVfY29ubl9zdGF0
KHN0cnVjdCBkcm1fZHBfbXN0X2JyYW5jaCAqbXN0YiwKIAkJCXBvcnQtPmF2YWlsYWJsZV9wYm4g
PSAwOwogCQl9CiAJfQotCWlmIChvbGRfcGR0ICE9IHBvcnQtPnBkdCAmJiAhcG9ydC0+aW5wdXQp
IHsKLQkJZHJtX2RwX3BvcnRfdGVhcmRvd25fcGR0KHBvcnQsIG9sZF9wZHQpOwogCi0JCWlmIChk
cm1fZHBfcG9ydF9zZXR1cF9wZHQocG9ydCkpCisJaWYgKCFwb3J0LT5pbnB1dCkgeworCQlpbnQg
cmV0ID0gZHJtX2RwX3BvcnRfc2V0X3BkdChwb3J0LAorCQkJCQkgICAgICBjb25uX3N0YXQtPnBl
ZXJfZGV2aWNlX3R5cGUpOworCQlpZiAocmV0ID09IDEpIHsKIAkJCWRvd29yayA9IHRydWU7CisJ
CX0gZWxzZSBpZiAocmV0IDwgMCkgeworCQkJRFJNX0VSUk9SKCJGYWlsZWQgdG8gY2hhbmdlIFBE
VCBmb3IgcG9ydCAlcDogJWRcbiIsCisJCQkJICBwb3J0LCByZXQpOworCQkJZG93b3JrID0gZmFs
c2U7CisJCX0KIAl9CiAKIAlkcm1fZHBfbXN0X3RvcG9sb2d5X3B1dF9wb3J0KHBvcnQpOwpAQCAt
Mzk3NSw5ICs0MDA4LDcgQEAgZHJtX2RwX2RlbGF5ZWRfZGVzdHJveV9wb3J0KHN0cnVjdCBkcm1f
ZHBfbXN0X3BvcnQgKnBvcnQpCiAJaWYgKHBvcnQtPmNvbm5lY3RvcikKIAkJcG9ydC0+bWdyLT5j
YnMtPmRlc3Ryb3lfY29ubmVjdG9yKHBvcnQtPm1nciwgcG9ydC0+Y29ubmVjdG9yKTsKIAotCWRy
bV9kcF9wb3J0X3RlYXJkb3duX3BkdChwb3J0LCBwb3J0LT5wZHQpOwotCXBvcnQtPnBkdCA9IERQ
X1BFRVJfREVWSUNFX05PTkU7Ci0KKwlkcm1fZHBfcG9ydF9zZXRfcGR0KHBvcnQsIERQX1BFRVJf
REVWSUNFX05PTkUpOwogCWRybV9kcF9tc3RfcHV0X3BvcnRfbWFsbG9jKHBvcnQpOwogfQogCmRp
ZmYgLS1naXQgYS9pbmNsdWRlL2RybS9kcm1fZHBfbXN0X2hlbHBlci5oIGIvaW5jbHVkZS9kcm0v
ZHJtX2RwX21zdF9oZWxwZXIuaAppbmRleCBiMjE2MGMzNjZmYjcuLjhiYTJhMDEzMjRiYiAxMDA2
NDQKLS0tIGEvaW5jbHVkZS9kcm0vZHJtX2RwX21zdF9oZWxwZXIuaAorKysgYi9pbmNsdWRlL2Ry
bS9kcm1fZHBfbXN0X2hlbHBlci5oCkBAIC01NSw4ICs1NSwxMCBAQCBzdHJ1Y3QgZHJtX2RwX3Zj
cGkgewogICogQG51bV9zZHBfc3RyZWFtX3NpbmtzOiBOdW1iZXIgb2Ygc3RyZWFtIHNpbmtzCiAg
KiBAYXZhaWxhYmxlX3BibjogQXZhaWxhYmxlIGJhbmR3aWR0aCBmb3IgdGhpcyBwb3J0LgogICog
QG5leHQ6IGxpbmsgdG8gbmV4dCBwb3J0IG9uIHRoaXMgYnJhbmNoIGRldmljZQotICogQG1zdGI6
IGJyYW5jaCBkZXZpY2UgYXR0YWNoIGJlbG93IHRoaXMgcG9ydAotICogQGF1eDogaTJjIGF1eCB0
cmFuc3BvcnQgdG8gdGFsayB0byBkZXZpY2UgY29ubmVjdGVkIHRvIHRoaXMgcG9ydC4KKyAqIEBt
c3RiOiBicmFuY2ggZGV2aWNlIG9uIHRoaXMgcG9ydCwgcHJvdGVjdGVkIGJ5CisgKiAmZHJtX2Rw
X21zdF90b3BvbG9neV9tZ3IubG9jaworICogQGF1eDogaTJjIGF1eCB0cmFuc3BvcnQgdG8gdGFs
ayB0byBkZXZpY2UgY29ubmVjdGVkIHRvIHRoaXMgcG9ydCwgcHJvdGVjdGVkCisgKiBieSAmZHJt
X2RwX21zdF90b3BvbG9neV9tZ3IubG9jawogICogQHBhcmVudDogYnJhbmNoIGRldmljZSBwYXJl
bnQgb2YgdGhpcyBwb3J0CiAgKiBAdmNwaTogVmlydHVhbCBDaGFubmVsIFBheWxvYWQgaW5mbyBm
b3IgdGhpcyBwb3J0LgogICogQGNvbm5lY3RvcjogRFJNIGNvbm5lY3RvciB0aGlzIHBvcnQgaXMg
Y29ubmVjdGVkIHRvLgotLSAKMi4yMS4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9kcmktZGV2ZWw=
