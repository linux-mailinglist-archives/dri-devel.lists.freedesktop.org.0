Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C487CD2634
	for <lists+dri-devel@lfdr.de>; Thu, 10 Oct 2019 11:25:43 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2677C6EAD5;
	Thu, 10 Oct 2019 09:25:38 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x443.google.com (mail-wr1-x443.google.com
 [IPv6:2a00:1450:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 569896EAD4
 for <dri-devel@lists.freedesktop.org>; Thu, 10 Oct 2019 09:25:34 +0000 (UTC)
Received: by mail-wr1-x443.google.com with SMTP id y19so6958474wrd.3
 for <dri-devel@lists.freedesktop.org>; Thu, 10 Oct 2019 02:25:34 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=Q796W5lCrOlBeYw4MY5ZW1Ge769i9KDbYUuSGZdulMc=;
 b=qZ6jtqJ9U0GxnzoD/wz4O3FWVXJ+0GrxKiDeT5UiqLbKlQFc25BKr8i/qCjAOLCwVD
 nv8uUK5thejbVV6Ay7rWRidJ/HspWCmJ+I+QeYbK7jA2QNFiJagCZdmbmUuSHemHKCGv
 C7B4pkNZk7HZOb1Qx17fyDQDH7Vw0DPBviShO/U9NKIs1bMosmkRvBrh1h7qMfQg24BS
 8x6YVZVGzK/FAOuQaMMU/9bZh8m3qKFyFbD3ob1Ll/AI958EY/1hcBG8lbL4Km/vhKMK
 72Jcu6LDNxGIhtz5dWW+eT0/sKlgNXcEdBNQ0GwzTT+hcBVg2CT2GE4zdLguDieixrwM
 2jNA==
X-Gm-Message-State: APjAAAWrPQH4HT3nKFxKUljzRsLRCWvB7cybpxOUSBZgn2Z5+XRS2axJ
 TyMZ+0LFulHPvpfgLdo9vinqt2ExL36MLg==
X-Google-Smtp-Source: APXvYqwKubvI163AjKpiWm3WxXkLHlCbwuriy7YXgaNg6/Vwf651tSLXofk+sFz4DWKWKPXgi0p98A==
X-Received: by 2002:a5d:6383:: with SMTP id p3mr7656213wru.117.1570699532446; 
 Thu, 10 Oct 2019 02:25:32 -0700 (PDT)
Received: from bender.baylibre.local
 (lmontsouris-657-1-212-31.w90-63.abo.wanadoo.fr. [90.63.244.31])
 by smtp.gmail.com with ESMTPSA id s10sm8373770wmf.48.2019.10.10.02.25.31
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Thu, 10 Oct 2019 02:25:32 -0700 (PDT)
From: Neil Armstrong <narmstrong@baylibre.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH 4/7] drm/meson: plane: add support for AFBC mode for OSD1 plane
Date: Thu, 10 Oct 2019 11:25:23 +0200
Message-Id: <20191010092526.10419-5-narmstrong@baylibre.com>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20191010092526.10419-1-narmstrong@baylibre.com>
References: <20191010092526.10419-1-narmstrong@baylibre.com>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=baylibre-com.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=Q796W5lCrOlBeYw4MY5ZW1Ge769i9KDbYUuSGZdulMc=;
 b=nkPve5nUP0qCs+2VrEq4+ztP8zqixsrvOOATLUbGRseF6bGtiHtWimb/YlbLRBvae8
 IUOrNO0kNEgxovb6snQwtX0EZ8ptsglWsD4EbJYUANkY886mp2GGfcPo3r+yRrxY/G0/
 EXmvfSLxtMDWrVSPyElzjUteUnvjnNVWwdp6n2TTHmL8z0x3Kq/r0OoUxEPZYRTYxfYV
 Wp+k0u3NjFkkCD9uU09reSXr188siiA/559sRf0VC2KnhQIr7vnhD03f3OdLJ7qYrczV
 LaWftBVuzAx36I0ZqIa7QYGNNrjd/U+wyMJ/x/utfLwSQJMGiCHMSpvKH6/2vepUyi9D
 osDw==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: khilman@baylibre.com, linux-amlogic@lists.infradead.org,
 ayan.halder@arm.com, linux-arm-kernel@lists.infradead.org,
 Neil Armstrong <narmstrong@baylibre.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBhZGRzIGFsbCB0aGUgT1NEIGNvbmZpZ3VyYXRpb24gcGx1bWJpbmcgdG8gc3VwcG9ydCB0
aGUgQUZCQyBkZWNvZGVycwpwYXRoIHRvIGRpc3BsYXkgb2YgdGhlIE9TRDEgcGxhbmUuCgpUaGUg
QW1sb2dpYyBHWE0gYW5kIEcxMkEgQUZCQyBkZWNvZGVycyBhcmUgaW50ZWdyYXRlZCB2ZXJ5IGRp
ZmZlcmVudGx5LgoKVGhlIEFtbG9naWMgR1hNIGhhcyBhIGRpcmVjdCBvdXRwdXQgcGF0aCB0byB0
aGUgT1NEMSBWSVUgcGl4ZWwgaW5wdXQsCmJlY2F1c2UgdGhlIEdYTSBBRkJDIGRlY29kZXIgc2Vl
bSB0byBiZSBhIGN1c3RvbSBJUCBkZXZlbG9wZWQgYnkgQW1sb2dpYy4KCk9uIHRoZSBvdGhlciBz
aWRlLCB0aGUgQW1sb2dpYyBHMTJBIEFGQkMgZGVjb2RlciBzZWVtcyB0byBiZSBhbiBleHRlcm5h
bApJUCB0aGF0IGVtaXQgcGl4ZWxzIG9uIGFuIEFYSSBtYXN0ZXIgaG9va2VkIHRvIGEgIk1hbGkg
VW5wYWNrIiBibG9jawpmZWVkaW5nIHRoZSBPU0QxIFZJVSBwaXhlbCBpbnB1dC4KVGhpcyB1c2Vz
IGEgd2VpcmQgIjB4MTAwMDAwMCIgaW50ZXJuYWwgSFcgcGh5c2ljYWwgYWRkcmVzcyBvbiBib3Ro
CnNpZGVzIHRvIHRyYW5zZmVyIHRoZSBwaXhlbHMuCgpGb3IgQW1sb2dpYyBHWE0sIHRoZSBzdXBw
b3J0ZWQgcGl4ZWwgZm9ybWF0cyBhcmUgdGhlIHNhbWUgYXMgdGhlIG5vcm1hbApsaW5lYXIgT1NE
MSBtb2RlLgoKT24gdGhlIG90aGVyIHNpZGUsIEFtbG9naWMgYWRkZWQgc3VwcG9ydCBmb3IgYWxs
IEFGQkMgdjEuMiBmb3JtYXRzIGZvcgp0aGUgRzEyQSBBRkJDIGludGVncmF0aW9uLgoKRm9yIHNp
bXBsaWNpdHksIHdlIHN0aWNrIHRvIHRoZSBhbHJlYWR5IHN1cHBvcnRlZCBmb3JtYXRzIGZvciBu
b3cuCgpTaWduZWQtb2ZmLWJ5OiBOZWlsIEFybXN0cm9uZyA8bmFybXN0cm9uZ0BiYXlsaWJyZS5j
b20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL21lc29uL21lc29uX2NydGMuYyAgfCAgIDIgKwogZHJp
dmVycy9ncHUvZHJtL21lc29uL21lc29uX2Rydi5oICAgfCAgIDQgKwogZHJpdmVycy9ncHUvZHJt
L21lc29uL21lc29uX3BsYW5lLmMgfCAyMTUgKysrKysrKysrKysrKysrKysrKysrKysrLS0tLQog
MyBmaWxlcyBjaGFuZ2VkLCAxOTAgaW5zZXJ0aW9ucygrKSwgMzEgZGVsZXRpb25zKC0pCgpkaWZm
IC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL21lc29uL21lc29uX2NydGMuYyBiL2RyaXZlcnMvZ3B1
L2RybS9tZXNvbi9tZXNvbl9jcnRjLmMKaW5kZXggNTdhZTFjMTNkMWU2Li5kNDc4ZmEyMzI5NTEg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9tZXNvbi9tZXNvbl9jcnRjLmMKKysrIGIvZHJp
dmVycy9ncHUvZHJtL21lc29uL21lc29uX2NydGMuYwpAQCAtMjgxLDYgKzI4MSw4IEBAIHZvaWQg
bWVzb25fY3J0Y19pcnEoc3RydWN0IG1lc29uX2RybSAqcHJpdikKIAlpZiAocHJpdi0+dml1Lm9z
ZDFfZW5hYmxlZCAmJiBwcml2LT52aXUub3NkMV9jb21taXQpIHsKIAkJd3JpdGVsX3JlbGF4ZWQo
cHJpdi0+dml1Lm9zZDFfY3RybF9zdGF0LAogCQkJCXByaXYtPmlvX2Jhc2UgKyBfUkVHKFZJVV9P
U0QxX0NUUkxfU1RBVCkpOworCQl3cml0ZWxfcmVsYXhlZChwcml2LT52aXUub3NkMV9jdHJsX3N0
YXQyLAorCQkJCXByaXYtPmlvX2Jhc2UgKyBfUkVHKFZJVV9PU0QxX0NUUkxfU1RBVDIpKTsKIAkJ
d3JpdGVsX3JlbGF4ZWQocHJpdi0+dml1Lm9zZDFfYmxrMF9jZmdbMF0sCiAJCQkJcHJpdi0+aW9f
YmFzZSArIF9SRUcoVklVX09TRDFfQkxLMF9DRkdfVzApKTsKIAkJd3JpdGVsX3JlbGF4ZWQocHJp
di0+dml1Lm9zZDFfYmxrMF9jZmdbMV0sCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbWVz
b24vbWVzb25fZHJ2LmggYi9kcml2ZXJzL2dwdS9kcm0vbWVzb24vbWVzb25fZHJ2LmgKaW5kZXgg
NjBmMTNjNmYzNGU1Li5kZTI1MzQ5YmU4YWEgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9t
ZXNvbi9tZXNvbl9kcnYuaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vbWVzb24vbWVzb25fZHJ2LmgK
QEAgLTUzLDggKzUzLDEyIEBAIHN0cnVjdCBtZXNvbl9kcm0gewogCQlib29sIG9zZDFfZW5hYmxl
ZDsKIAkJYm9vbCBvc2QxX2ludGVybGFjZTsKIAkJYm9vbCBvc2QxX2NvbW1pdDsKKwkJYm9vbCBv
c2QxX2FmYmNkOwogCQl1aW50MzJfdCBvc2QxX2N0cmxfc3RhdDsKKwkJdWludDMyX3Qgb3NkMV9j
dHJsX3N0YXQyOwogCQl1aW50MzJfdCBvc2QxX2JsazBfY2ZnWzVdOworCQl1aW50MzJfdCBvc2Qx
X2JsazFfY2ZnNDsKKwkJdWludDMyX3Qgb3NkMV9ibGsyX2NmZzQ7CiAJCXVpbnQzMl90IG9zZDFf
YWRkcjsKIAkJdWludDMyX3Qgb3NkMV9zdHJpZGU7CiAJCXVpbnQzMl90IG9zZDFfaGVpZ2h0Owpk
aWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL21lc29uL21lc29uX3BsYW5lLmMgYi9kcml2ZXJz
L2dwdS9kcm0vbWVzb24vbWVzb25fcGxhbmUuYwppbmRleCA1ZTc5OGMyNzYwMzcuLjQxMjk0MWFh
ODQwMiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL21lc29uL21lc29uX3BsYW5lLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL21lc29uL21lc29uX3BsYW5lLmMKQEAgLTIzLDYgKzIzLDcgQEAK
ICNpbmNsdWRlICJtZXNvbl9wbGFuZS5oIgogI2luY2x1ZGUgIm1lc29uX3JlZ2lzdGVycy5oIgog
I2luY2x1ZGUgIm1lc29uX3ZpdS5oIgorI2luY2x1ZGUgIm1lc29uX29zZF9hZmJjZC5oIgogCiAv
KiBPU0RfU0NJX1dIX00xICovCiAjZGVmaW5lIFNDSV9XSF9NMV9XKHcpCQkJRklFTERfUFJFUChH
RU5NQVNLKDI4LCAxNiksIHcpCkBAIC05MiwxMiArOTMsMzggQEAgc3RhdGljIGludCBtZXNvbl9w
bGFuZV9hdG9taWNfY2hlY2soc3RydWN0IGRybV9wbGFuZSAqcGxhbmUsCiAJCQkJCQkgICBmYWxz
ZSwgdHJ1ZSk7CiB9CiAKKyNkZWZpbmUgTUVTT05fTU9EX0FGQkNfVkFMSURfQklUUyAoQUZCQ19G
T1JNQVRfTU9EX0JMT0NLX1NJWkVfMTZ4MTYgfAlcCisJCQkJICAgQUZCQ19GT1JNQVRfTU9EX0JM
T0NLX1NJWkVfMzJ4OCB8CVwKKwkJCQkgICBBRkJDX0ZPUk1BVF9NT0RfWVRSIHwJCVwKKwkJCQkg
ICBBRkJDX0ZPUk1BVF9NT0RfU1BBUlNFIHwJCVwKKwkJCQkgICBBRkJDX0ZPUk1BVF9NT0RfU1BM
SVQpCisKIC8qIFRha2VzIGEgZml4ZWQgMTYuMTYgbnVtYmVyIGFuZCBjb252ZXJ0cyBpdCB0byBp
bnRlZ2VyLiAqLwogc3RhdGljIGlubGluZSBpbnQ2NF90IGZpeGVkMTZfdG9faW50KGludDY0X3Qg
dmFsdWUpCiB7CiAJcmV0dXJuIHZhbHVlID4+IDE2OwogfQogCitzdGF0aWMgdTMyIG1lc29uX2cx
MmFfYWZiY2RfbGluZV9zdHJpZGUoc3RydWN0IG1lc29uX2RybSAqcHJpdikKK3sKKwl1MzIgbGlu
ZV9zdHJpZGUgPSAwOworCisJc3dpdGNoIChwcml2LT5hZmJjZC5mb3JtYXQpIHsKKwljYXNlIERS
TV9GT1JNQVRfUkdCNTY1OgorCQlsaW5lX3N0cmlkZSA9ICgocHJpdi0+dml1Lm9zZDFfd2lkdGgg
PDwgNCkgKyAxMjcpID4+IDc7CisJCWJyZWFrOworCWNhc2UgRFJNX0ZPUk1BVF9SR0I4ODg6CisJ
Y2FzZSBEUk1fRk9STUFUX1hSR0I4ODg4OgorCWNhc2UgRFJNX0ZPUk1BVF9BUkdCODg4ODoKKwlj
YXNlIERSTV9GT1JNQVRfWEJHUjg4ODg6CisJY2FzZSBEUk1fRk9STUFUX0FCR1I4ODg4OgorCQls
aW5lX3N0cmlkZSA9ICgocHJpdi0+dml1Lm9zZDFfd2lkdGggPDwgNSkgKyAxMjcpID4+IDc7CisJ
CWJyZWFrOworCX0KKworCXJldHVybiAoKGxpbmVfc3RyaWRlICsgMSkgPj4gMSkgPDwgMTsKK30K
Kwogc3RhdGljIHZvaWQgbWVzb25fcGxhbmVfYXRvbWljX3VwZGF0ZShzdHJ1Y3QgZHJtX3BsYW5l
ICpwbGFuZSwKIAkJCQkgICAgICBzdHJ1Y3QgZHJtX3BsYW5lX3N0YXRlICpvbGRfc3RhdGUpCiB7
CkBAIC0xMjYsNTcgKzE1Myw4OCBAQCBzdGF0aWMgdm9pZCBtZXNvbl9wbGFuZV9hdG9taWNfdXBk
YXRlKHN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lLAogCSAqLwogCXNwaW5fbG9ja19pcnFzYXZlKCZw
cml2LT5kcm0tPmV2ZW50X2xvY2ssIGZsYWdzKTsKIAorCS8qIENoZWNrIGlmIEFGQkMgZGVjb2Rl
ciBpcyByZXF1aXJlZCBmb3IgdGhpcyBidWZmZXIgKi8KKwlpZiAoKG1lc29uX3ZwdV9pc19jb21w
YXRpYmxlKHByaXYsIFZQVV9DT01QQVRJQkxFX0dYTSkgfHwKKwkgICAgIG1lc29uX3ZwdV9pc19j
b21wYXRpYmxlKHByaXYsIFZQVV9DT01QQVRJQkxFX0cxMkEpKSAmJgorCSAgICBmYi0+bW9kaWZp
ZXIgJiBEUk1fRk9STUFUX01PRF9BUk1fQUZCQyhNRVNPTl9NT0RfQUZCQ19WQUxJRF9CSVRTKSkK
KwkJcHJpdi0+dml1Lm9zZDFfYWZiY2QgPSB0cnVlOworCWVsc2UKKwkJcHJpdi0+dml1Lm9zZDFf
YWZiY2QgPSBmYWxzZTsKKwogCS8qIEVuYWJsZSBPU0QgYW5kIEJMSzAsIHNldCBtYXggZ2xvYmFs
IGFscGhhICovCiAJcHJpdi0+dml1Lm9zZDFfY3RybF9zdGF0ID0gT1NEX0VOQUJMRSB8CiAJCQkJ
ICAgKDB4RkYgPDwgT1NEX0dMT0JBTF9BTFBIQV9TSElGVCkgfAogCQkJCSAgIE9TRF9CTEswX0VO
QUJMRTsKIAorCXByaXYtPnZpdS5vc2QxX2N0cmxfc3RhdDIgPSByZWFkbChwcml2LT5pb19iYXNl
ICsKKwkJCQkJICBfUkVHKFZJVV9PU0QxX0NUUkxfU1RBVDIpKTsKKwogCWNhbnZhc19pZF9vc2Qx
ID0gcHJpdi0+Y2FudmFzX2lkX29zZDE7CiAKIAkvKiBTZXQgdXAgQkxLMCB0byBwb2ludCB0byB0
aGUgcmlnaHQgY2FudmFzICovCi0JcHJpdi0+dml1Lm9zZDFfYmxrMF9jZmdbMF0gPSAoKGNhbnZh
c19pZF9vc2QxIDw8IE9TRF9DQU5WQVNfU0VMKSB8Ci0JCQkJICAgICAgT1NEX0VORElBTk5FU1Nf
TEUpOworCXByaXYtPnZpdS5vc2QxX2JsazBfY2ZnWzBdID0gY2FudmFzX2lkX29zZDEgPDwgT1NE
X0NBTlZBU19TRUw7CisKKwlpZiAocHJpdi0+dml1Lm9zZDFfYWZiY2QpIHsKKwkJaWYgKG1lc29u
X3ZwdV9pc19jb21wYXRpYmxlKHByaXYsIFZQVV9DT01QQVRJQkxFX0cxMkEpKSB7CisJCQkvKiBU
aGlzIGlzIHRoZSBpbnRlcm5hbCBkZWNvZGluZyBtZW1vcnkgYWRkcmVzcyAqLworCQkJcHJpdi0+
dml1Lm9zZDFfYmxrMV9jZmc0ID0gTUVTT05fRzEyQV9BRkJDRF9PVVRfQUREUjsKKwkJCXByaXYt
PnZpdS5vc2QxX2JsazBfY2ZnWzBdIHw9IE9TRF9FTkRJQU5ORVNTX0JFOworCQkJcHJpdi0+dml1
Lm9zZDFfY3RybF9zdGF0MiB8PSBPU0RfUEVORElOR19TVEFUX0NMRUFOOworCQl9CisKKwkJaWYg
KG1lc29uX3ZwdV9pc19jb21wYXRpYmxlKHByaXYsIFZQVV9DT01QQVRJQkxFX0dYTSkpIHsKKwkJ
CXByaXYtPnZpdS5vc2QxX2JsazBfY2ZnWzBdIHw9IE9TRF9FTkRJQU5ORVNTX0xFOworCQkJcHJp
di0+dml1Lm9zZDFfY3RybF9zdGF0MiB8PSBPU0RfRFBBVEhfTUFMSV9BRkJDRDsKKwkJfQorCX0g
ZWxzZSB7CisJCXByaXYtPnZpdS5vc2QxX2JsazBfY2ZnWzBdIHw9IE9TRF9FTkRJQU5ORVNTX0xF
OworCisJCWlmIChtZXNvbl92cHVfaXNfY29tcGF0aWJsZShwcml2LCBWUFVfQ09NUEFUSUJMRV9H
WE0pKQorCQkJcHJpdi0+dml1Lm9zZDFfY3RybF9zdGF0MiAmPSB+T1NEX0RQQVRIX01BTElfQUZC
Q0Q7CisJfQogCiAJLyogT24gR1hCQiwgVXNlIHRoZSBvbGQgbm9uLUhEUiBSR0IyWVVWIGNvbnZl
cnRlciAqLwogCWlmIChtZXNvbl92cHVfaXNfY29tcGF0aWJsZShwcml2LCBWUFVfQ09NUEFUSUJM
RV9HWEJCKSkKIAkJcHJpdi0+dml1Lm9zZDFfYmxrMF9jZmdbMF0gfD0gT1NEX09VVFBVVF9DT0xP
Ul9SR0I7CiAKKwlpZiAocHJpdi0+dml1Lm9zZDFfYWZiY2QgJiYKKwkgICAgbWVzb25fdnB1X2lz
X2NvbXBhdGlibGUocHJpdiwgVlBVX0NPTVBBVElCTEVfRzEyQSkpIHsKKwkJcHJpdi0+dml1Lm9z
ZDFfYmxrMF9jZmdbMF0gfD0gT1NEX01BTElfU1JDX0VOIHwKKwkJCXByaXYtPmFmYmNkLm9wcy0+
Zm10X3RvX2Jsa19tb2RlKGZiLT5tb2RpZmllciwKKwkJCQkJCQkgIGZiLT5mb3JtYXQtPmZvcm1h
dCk7CisJfSBlbHNlIHsKKwkJc3dpdGNoIChmYi0+Zm9ybWF0LT5mb3JtYXQpIHsKKwkJY2FzZSBE
Uk1fRk9STUFUX1hSR0I4ODg4OgorCQljYXNlIERSTV9GT1JNQVRfQVJHQjg4ODg6CisJCQlwcml2
LT52aXUub3NkMV9ibGswX2NmZ1swXSB8PSBPU0RfQkxLX01PREVfMzIgfAorCQkJCQkJT1NEX0NP
TE9SX01BVFJJWF8zMl9BUkdCOworCQkJYnJlYWs7CisJCWNhc2UgRFJNX0ZPUk1BVF9YQkdSODg4
ODoKKwkJY2FzZSBEUk1fRk9STUFUX0FCR1I4ODg4OgorCQkJcHJpdi0+dml1Lm9zZDFfYmxrMF9j
ZmdbMF0gfD0gT1NEX0JMS19NT0RFXzMyIHwKKwkJCQkJCU9TRF9DT0xPUl9NQVRSSVhfMzJfQUJH
UjsKKwkJCWJyZWFrOworCQljYXNlIERSTV9GT1JNQVRfUkdCODg4OgorCQkJcHJpdi0+dml1Lm9z
ZDFfYmxrMF9jZmdbMF0gfD0gT1NEX0JMS19NT0RFXzI0IHwKKwkJCQkJCU9TRF9DT0xPUl9NQVRS
SVhfMjRfUkdCOworCQkJYnJlYWs7CisJCWNhc2UgRFJNX0ZPUk1BVF9SR0I1NjU6CisJCQlwcml2
LT52aXUub3NkMV9ibGswX2NmZ1swXSB8PSBPU0RfQkxLX01PREVfMTYgfAorCQkJCQkJT1NEX0NP
TE9SX01BVFJJWF8xNl9SR0I1NjU7CisJCQlicmVhazsKKwkJfTsKKwl9CisKIAlzd2l0Y2ggKGZi
LT5mb3JtYXQtPmZvcm1hdCkgewogCWNhc2UgRFJNX0ZPUk1BVF9YUkdCODg4ODoKLQkJLyogRm9y
IFhSR0IsIHJlcGxhY2UgdGhlIHBpeGVsJ3MgYWxwaGEgYnkgMHhGRiAqLwotCQl3cml0ZWxfYml0
c19yZWxheGVkKE9TRF9SRVBMQUNFX0VOLCBPU0RfUkVQTEFDRV9FTiwKLQkJCQkgICAgcHJpdi0+
aW9fYmFzZSArIF9SRUcoVklVX09TRDFfQ1RSTF9TVEFUMikpOwotCQlwcml2LT52aXUub3NkMV9i
bGswX2NmZ1swXSB8PSBPU0RfQkxLX01PREVfMzIgfAotCQkJCQkgICAgICBPU0RfQ09MT1JfTUFU
UklYXzMyX0FSR0I7Ci0JCWJyZWFrOwogCWNhc2UgRFJNX0ZPUk1BVF9YQkdSODg4ODoKIAkJLyog
Rm9yIFhSR0IsIHJlcGxhY2UgdGhlIHBpeGVsJ3MgYWxwaGEgYnkgMHhGRiAqLwotCQl3cml0ZWxf
Yml0c19yZWxheGVkKE9TRF9SRVBMQUNFX0VOLCBPU0RfUkVQTEFDRV9FTiwKLQkJCQkgICAgcHJp
di0+aW9fYmFzZSArIF9SRUcoVklVX09TRDFfQ1RSTF9TVEFUMikpOwotCQlwcml2LT52aXUub3Nk
MV9ibGswX2NmZ1swXSB8PSBPU0RfQkxLX01PREVfMzIgfAotCQkJCQkgICAgICBPU0RfQ09MT1Jf
TUFUUklYXzMyX0FCR1I7CisJCXByaXYtPnZpdS5vc2QxX2N0cmxfc3RhdDIgfD0gT1NEX1JFUExB
Q0VfRU47CiAJCWJyZWFrOwogCWNhc2UgRFJNX0ZPUk1BVF9BUkdCODg4ODoKLQkJLyogRm9yIEFS
R0IsIHVzZSB0aGUgcGl4ZWwncyBhbHBoYSAqLwotCQl3cml0ZWxfYml0c19yZWxheGVkKE9TRF9S
RVBMQUNFX0VOLCAwLAotCQkJCSAgICBwcml2LT5pb19iYXNlICsgX1JFRyhWSVVfT1NEMV9DVFJM
X1NUQVQyKSk7Ci0JCXByaXYtPnZpdS5vc2QxX2JsazBfY2ZnWzBdIHw9IE9TRF9CTEtfTU9ERV8z
MiB8Ci0JCQkJCSAgICAgIE9TRF9DT0xPUl9NQVRSSVhfMzJfQVJHQjsKLQkJYnJlYWs7CiAJY2Fz
ZSBEUk1fRk9STUFUX0FCR1I4ODg4OgogCQkvKiBGb3IgQVJHQiwgdXNlIHRoZSBwaXhlbCdzIGFs
cGhhICovCi0JCXdyaXRlbF9iaXRzX3JlbGF4ZWQoT1NEX1JFUExBQ0VfRU4sIDAsCi0JCQkJICAg
IHByaXYtPmlvX2Jhc2UgKyBfUkVHKFZJVV9PU0QxX0NUUkxfU1RBVDIpKTsKLQkJcHJpdi0+dml1
Lm9zZDFfYmxrMF9jZmdbMF0gfD0gT1NEX0JMS19NT0RFXzMyIHwKLQkJCQkJICAgICAgT1NEX0NP
TE9SX01BVFJJWF8zMl9BQkdSOwotCQlicmVhazsKLQljYXNlIERSTV9GT1JNQVRfUkdCODg4Ogot
CQlwcml2LT52aXUub3NkMV9ibGswX2NmZ1swXSB8PSBPU0RfQkxLX01PREVfMjQgfAotCQkJCQkg
ICAgICBPU0RfQ09MT1JfTUFUUklYXzI0X1JHQjsKLQkJYnJlYWs7Ci0JY2FzZSBEUk1fRk9STUFU
X1JHQjU2NToKLQkJcHJpdi0+dml1Lm9zZDFfYmxrMF9jZmdbMF0gfD0gT1NEX0JMS19NT0RFXzE2
IHwKLQkJCQkJICAgICAgT1NEX0NPTE9SX01BVFJJWF8xNl9SR0I1NjU7CisJCXByaXYtPnZpdS5v
c2QxX2N0cmxfc3RhdDIgJj0gfk9TRF9SRVBMQUNFX0VOOwogCQlicmVhazsKIAl9OwogCkBAIC0z
MDcsNiArMzY1LDE2IEBAIHN0YXRpYyB2b2lkIG1lc29uX3BsYW5lX2F0b21pY191cGRhdGUoc3Ry
dWN0IGRybV9wbGFuZSAqcGxhbmUsCiAJcHJpdi0+dml1Lm9zZDFfaGVpZ2h0ID0gZmItPmhlaWdo
dDsKIAlwcml2LT52aXUub3NkMV93aWR0aCA9IGZiLT53aWR0aDsKIAorCWlmIChwcml2LT52aXUu
b3NkMV9hZmJjZCkgeworCQlwcml2LT5hZmJjZC5tb2RpZmllciA9IGZiLT5tb2RpZmllcjsKKwkJ
cHJpdi0+YWZiY2QuZm9ybWF0ID0gZmItPmZvcm1hdC0+Zm9ybWF0OworCisJCS8qIENhbGN1bGF0
ZSBkZWNvZGVyIHdyaXRlIHN0cmlkZSAqLworCQlpZiAobWVzb25fdnB1X2lzX2NvbXBhdGlibGUo
cHJpdiwgVlBVX0NPTVBBVElCTEVfRzEyQSkpCisJCQlwcml2LT52aXUub3NkMV9ibGsyX2NmZzQg
PQorCQkJCW1lc29uX2cxMmFfYWZiY2RfbGluZV9zdHJpZGUocHJpdik7CisJfQorCiAJaWYgKCFt
ZXNvbl9wbGFuZS0+ZW5hYmxlZCkgewogCQkvKiBSZXNldCBPU0QxIGJlZm9yZSBlbmFibGluZyBp
dCBvbiBHWEwrIFNvQ3MgKi8KIAkJaWYgKG1lc29uX3ZwdV9pc19jb21wYXRpYmxlKHByaXYsIFZQ
VV9DT01QQVRJQkxFX0dYTSkgfHwKQEAgLTM0Niw2ICs0MTQsNDIgQEAgc3RhdGljIGNvbnN0IHN0
cnVjdCBkcm1fcGxhbmVfaGVscGVyX2Z1bmNzIG1lc29uX3BsYW5lX2hlbHBlcl9mdW5jcyA9IHsK
IAkucHJlcGFyZV9mYgk9IGRybV9nZW1fZmJfcHJlcGFyZV9mYiwKIH07CiAKK3N0YXRpYyBib29s
IG1lc29uX3BsYW5lX2Zvcm1hdF9tb2Rfc3VwcG9ydGVkKHN0cnVjdCBkcm1fcGxhbmUgKnBsYW5l
LAorCQkJCQkgICAgIHUzMiBmb3JtYXQsIHU2NCBtb2RpZmllcikKK3sKKwlzdHJ1Y3QgbWVzb25f
cGxhbmUgKm1lc29uX3BsYW5lID0gdG9fbWVzb25fcGxhbmUocGxhbmUpOworCXN0cnVjdCBtZXNv
bl9kcm0gKnByaXYgPSBtZXNvbl9wbGFuZS0+cHJpdjsKKwlpbnQgaTsKKworCWlmIChtb2RpZmll
ciA9PSBEUk1fRk9STUFUX01PRF9JTlZBTElEKQorCQlyZXR1cm4gZmFsc2U7CisKKwlpZiAobW9k
aWZpZXIgPT0gRFJNX0ZPUk1BVF9NT0RfTElORUFSKQorCQlyZXR1cm4gdHJ1ZTsKKworCWlmICgh
bWVzb25fdnB1X2lzX2NvbXBhdGlibGUocHJpdiwgVlBVX0NPTVBBVElCTEVfR1hNKSAmJgorCSAg
ICAhbWVzb25fdnB1X2lzX2NvbXBhdGlibGUocHJpdiwgVlBVX0NPTVBBVElCTEVfRzEyQSkpCisJ
CXJldHVybiBmYWxzZTsKKworCWlmIChtb2RpZmllciAmIH5EUk1fRk9STUFUX01PRF9BUk1fQUZC
QyhNRVNPTl9NT0RfQUZCQ19WQUxJRF9CSVRTKSkKKwkJcmV0dXJuIGZhbHNlOworCisJZm9yIChp
ID0gMCA7IGkgPCBwbGFuZS0+bW9kaWZpZXJfY291bnQgOyArK2kpCisJCWlmIChwbGFuZS0+bW9k
aWZpZXJzW2ldID09IG1vZGlmaWVyKQorCQkJYnJlYWs7CisKKwlpZiAoaSA9PSBwbGFuZS0+bW9k
aWZpZXJfY291bnQpIHsKKwkJRFJNX0RFQlVHX0tNUygiVW5zdXBwb3J0ZWQgbW9kaWZpZXJcbiIp
OworCQlyZXR1cm4gZmFsc2U7CisJfQorCisJaWYgKHByaXYtPmFmYmNkLm9wcyAmJiBwcml2LT5h
ZmJjZC5vcHMtPnN1cHBvcnRlZF9mbXQpCisJCXJldHVybiBwcml2LT5hZmJjZC5vcHMtPnN1cHBv
cnRlZF9mbXQobW9kaWZpZXIsIGZvcm1hdCk7CisKKwlEUk1fREVCVUdfS01TKCJBRkJDIFVuc3Vw
cG9ydGVkXG4iKTsKKwlyZXR1cm4gZmFsc2U7Cit9CisKIHN0YXRpYyBjb25zdCBzdHJ1Y3QgZHJt
X3BsYW5lX2Z1bmNzIG1lc29uX3BsYW5lX2Z1bmNzID0gewogCS51cGRhdGVfcGxhbmUJCT0gZHJt
X2F0b21pY19oZWxwZXJfdXBkYXRlX3BsYW5lLAogCS5kaXNhYmxlX3BsYW5lCQk9IGRybV9hdG9t
aWNfaGVscGVyX2Rpc2FibGVfcGxhbmUsCkBAIC0zNTMsNiArNDU3LDcgQEAgc3RhdGljIGNvbnN0
IHN0cnVjdCBkcm1fcGxhbmVfZnVuY3MgbWVzb25fcGxhbmVfZnVuY3MgPSB7CiAJLnJlc2V0CQkJ
PSBkcm1fYXRvbWljX2hlbHBlcl9wbGFuZV9yZXNldCwKIAkuYXRvbWljX2R1cGxpY2F0ZV9zdGF0
ZSA9IGRybV9hdG9taWNfaGVscGVyX3BsYW5lX2R1cGxpY2F0ZV9zdGF0ZSwKIAkuYXRvbWljX2Rl
c3Ryb3lfc3RhdGUJPSBkcm1fYXRvbWljX2hlbHBlcl9wbGFuZV9kZXN0cm95X3N0YXRlLAorCS5m
b3JtYXRfbW9kX3N1cHBvcnRlZCAgID0gbWVzb25fcGxhbmVfZm9ybWF0X21vZF9zdXBwb3J0ZWQs
CiB9OwogCiBzdGF0aWMgY29uc3QgdWludDMyX3Qgc3VwcG9ydGVkX2RybV9mb3JtYXRzW10gPSB7
CkBAIC0zNjQsMTAgKzQ2OSw1MyBAQCBzdGF0aWMgY29uc3QgdWludDMyX3Qgc3VwcG9ydGVkX2Ry
bV9mb3JtYXRzW10gPSB7CiAJRFJNX0ZPUk1BVF9SR0I1NjUsCiB9OwogCitzdGF0aWMgY29uc3Qg
dWludDY0X3QgZm9ybWF0X21vZGlmaWVyc19hZmJjX2d4bVtdID0geworCURSTV9GT1JNQVRfTU9E
X0FSTV9BRkJDKEFGQkNfRk9STUFUX01PRF9CTE9DS19TSVpFXzE2eDE2IHwKKwkJCQlBRkJDX0ZP
Uk1BVF9NT0RfU1BBUlNFIHwKKwkJCQlBRkJDX0ZPUk1BVF9NT0RfWVRSKSwKKwkvKiBTUExJVCBt
YW5kYXRlcyBTUEFSU0UsIFJHQiBtb2RlcyBtYW5kYXRlcyBZVFIgKi8KKwlEUk1fRk9STUFUX01P
RF9BUk1fQUZCQyhBRkJDX0ZPUk1BVF9NT0RfQkxPQ0tfU0laRV8xNngxNiB8CisJCQkJQUZCQ19G
T1JNQVRfTU9EX1lUUiB8CisJCQkJQUZCQ19GT1JNQVRfTU9EX1NQQVJTRSB8CisJCQkJQUZCQ19G
T1JNQVRfTU9EX1NQTElUKSwKKwlEUk1fRk9STUFUX01PRF9MSU5FQVIsCisJRFJNX0ZPUk1BVF9N
T0RfSU5WQUxJRCwKK307CisKK3N0YXRpYyBjb25zdCB1aW50NjRfdCBmb3JtYXRfbW9kaWZpZXJz
X2FmYmNfZzEyYVtdID0geworCS8qCisJICogLSBUT0ZJWCBTdXBwb3J0IEFGQkMgbW9kaWZpZXJz
IGZvciBZVVYgZm9ybWF0cyAoMTZ4MTYgKyBUSUxFRCkKKwkgKiAtIEFGQkNfRk9STUFUX01PRF9Z
VFIgaXMgbWFuZGF0b3J5IHNpbmNlIHdlIG9ubHkgc3VwcG9ydCBSR0IKKwkgKiAtIFNQTElUIGlz
IG1hbmRhdG9yeSBmb3IgcGVyZm9ybWFuY2VzIHJlYXNvbnMgd2hlbiBpbiAxNngxNgorCSAqICAg
YmxvY2sgc2l6ZQorCSAqIC0gMzJ4OCBibG9jayBzaXplICsgU1BMSVQgaXMgbWFuZGF0b3J5IHdp
dGggNEsgZnJhbWUgc2l6ZQorCSAqICAgZm9yIHBlcmZvcm1hbmNlcyByZWFzb25zCisJICovCisJ
RFJNX0ZPUk1BVF9NT0RfQVJNX0FGQkMoQUZCQ19GT1JNQVRfTU9EX0JMT0NLX1NJWkVfMTZ4MTYg
fAorCQkJCUFGQkNfRk9STUFUX01PRF9ZVFIgfAorCQkJCUFGQkNfRk9STUFUX01PRF9TUEFSU0Ug
fAorCQkJCUFGQkNfRk9STUFUX01PRF9TUExJVCksCisJRFJNX0ZPUk1BVF9NT0RfQVJNX0FGQkMo
QUZCQ19GT1JNQVRfTU9EX0JMT0NLX1NJWkVfMzJ4OCB8CisJCQkJQUZCQ19GT1JNQVRfTU9EX1lU
UiB8CisJCQkJQUZCQ19GT1JNQVRfTU9EX1NQQVJTRSksCisJRFJNX0ZPUk1BVF9NT0RfQVJNX0FG
QkMoQUZCQ19GT1JNQVRfTU9EX0JMT0NLX1NJWkVfMzJ4OCB8CisJCQkJQUZCQ19GT1JNQVRfTU9E
X1lUUiB8CisJCQkJQUZCQ19GT1JNQVRfTU9EX1NQQVJTRSB8CisJCQkJQUZCQ19GT1JNQVRfTU9E
X1NQTElUKSwKKwlEUk1fRk9STUFUX01PRF9MSU5FQVIsCisJRFJNX0ZPUk1BVF9NT0RfSU5WQUxJ
RCwKK307CisKK3N0YXRpYyBjb25zdCB1aW50NjRfdCBmb3JtYXRfbW9kaWZpZXJzX2RlZmF1bHRb
XSA9IHsKKwlEUk1fRk9STUFUX01PRF9MSU5FQVIsCisJRFJNX0ZPUk1BVF9NT0RfSU5WQUxJRCwK
K307CisKIGludCBtZXNvbl9wbGFuZV9jcmVhdGUoc3RydWN0IG1lc29uX2RybSAqcHJpdikKIHsK
IAlzdHJ1Y3QgbWVzb25fcGxhbmUgKm1lc29uX3BsYW5lOwogCXN0cnVjdCBkcm1fcGxhbmUgKnBs
YW5lOworCWNvbnN0IHVpbnQ2NF90ICpmb3JtYXRfbW9kaWZpZXJzID0gZm9ybWF0X21vZGlmaWVy
c19kZWZhdWx0OwogCiAJbWVzb25fcGxhbmUgPSBkZXZtX2t6YWxsb2MocHJpdi0+ZHJtLT5kZXYs
IHNpemVvZigqbWVzb25fcGxhbmUpLAogCQkJCSAgIEdGUF9LRVJORUwpOwpAQCAtMzc3LDExICs1
MjUsMTYgQEAgaW50IG1lc29uX3BsYW5lX2NyZWF0ZShzdHJ1Y3QgbWVzb25fZHJtICpwcml2KQog
CW1lc29uX3BsYW5lLT5wcml2ID0gcHJpdjsKIAlwbGFuZSA9ICZtZXNvbl9wbGFuZS0+YmFzZTsK
IAorCWlmIChtZXNvbl92cHVfaXNfY29tcGF0aWJsZShwcml2LCBWUFVfQ09NUEFUSUJMRV9HWE0p
KQorCQlmb3JtYXRfbW9kaWZpZXJzID0gZm9ybWF0X21vZGlmaWVyc19hZmJjX2d4bTsKKwllbHNl
IGlmIChtZXNvbl92cHVfaXNfY29tcGF0aWJsZShwcml2LCBWUFVfQ09NUEFUSUJMRV9HMTJBKSkK
KwkJZm9ybWF0X21vZGlmaWVycyA9IGZvcm1hdF9tb2RpZmllcnNfYWZiY19nMTJhOworCiAJZHJt
X3VuaXZlcnNhbF9wbGFuZV9pbml0KHByaXYtPmRybSwgcGxhbmUsIDB4RkYsCiAJCQkJICZtZXNv
bl9wbGFuZV9mdW5jcywKIAkJCQkgc3VwcG9ydGVkX2RybV9mb3JtYXRzLAogCQkJCSBBUlJBWV9T
SVpFKHN1cHBvcnRlZF9kcm1fZm9ybWF0cyksCi0JCQkJIE5VTEwsCisJCQkJIGZvcm1hdF9tb2Rp
ZmllcnMsCiAJCQkJIERSTV9QTEFORV9UWVBFX1BSSU1BUlksICJtZXNvbl9wcmltYXJ5X3BsYW5l
Iik7CiAKIAlkcm1fcGxhbmVfaGVscGVyX2FkZChwbGFuZSwgJm1lc29uX3BsYW5lX2hlbHBlcl9m
dW5jcyk7Ci0tIAoyLjIyLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNr
dG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2Ry
aS1kZXZlbA==
