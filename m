Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 1C12536B18B
	for <lists+dri-devel@lfdr.de>; Mon, 26 Apr 2021 12:20:46 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BC7886E81E;
	Mon, 26 Apr 2021 10:20:36 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga03.intel.com (mga03.intel.com [134.134.136.65])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 444B26E81E;
 Mon, 26 Apr 2021 10:20:34 +0000 (UTC)
IronPort-SDR: Z4mEhqDfPolPquVo1ztw1sI6WMNeN+M9rtfTff8H1wqMCrK9Dz5v0R/vtBwUKfPWPcinWqIrJU
 FSepMxaXE1Xg==
X-IronPort-AV: E=McAfee;i="6200,9189,9965"; a="196370962"
X-IronPort-AV: E=Sophos;i="5.82,252,1613462400"; d="scan'208";a="196370962"
Received: from fmsmga008.fm.intel.com ([10.253.24.58])
 by orsmga103.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 26 Apr 2021 03:20:33 -0700
IronPort-SDR: /3hReN6g5hgxS4RAw64R+971D/oR7UtecBgVvGzZHXZspoatTTQcZJ63IDWtRzVjD5dXhnvSLG
 X7JPYZ6qvfHA==
X-IronPort-AV: E=Sophos;i="5.82,252,1613462400"; d="scan'208";a="422613764"
Received: from rgunnin1-mobl.ger.corp.intel.com (HELO
 mwauld-desk1.ger.corp.intel.com) ([10.252.12.201])
 by fmsmga008-auth.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 26 Apr 2021 03:20:31 -0700
From: Matthew Auld <matthew.auld@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [PATCH 6/7] drm/i915/lmem: Bypass aperture when lmem is available
Date: Mon, 26 Apr 2021 11:18:20 +0100
Message-Id: <20210426101821.42147-6-matthew.auld@intel.com>
X-Mailer: git-send-email 2.26.3
In-Reply-To: <20210426101821.42147-1-matthew.auld@intel.com>
References: <20210426101821.42147-1-matthew.auld@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Anusha Srivatsa <anusha.srivatsa@intel.com>,
 Tvrtko Ursulin <tvrtko.ursulin@intel.com>,
 Chris P Wilson <chris.p.wilson@intel.com>, CQ Tang <cq.tang@intel.com>,
 Daniele Ceraolo Spurio <daniele.ceraolospurio@intel.com>,
 dri-devel@lists.freedesktop.org, Daniel Vetter <daniel.vetter@intel.com>,
 Dhinakaran Pandiyan <dhinakaran.pandiyan@intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogQW51c2hhIFNyaXZhdHNhIDxhbnVzaGEuc3JpdmF0c2FAaW50ZWwuY29tPgoKSW4gdGhl
IHNjZW5hcmlvIHdoZXJlIGxvY2FsIG1lbW9yeSBpcyBhdmFpbGFibGUsIHdlIGhhdmUKcmVseSBv
biBDUFUgYWNjZXNzIHZpYSBsbWVtIGRpcmVjdGx5IGluc3RlYWQgb2YgYXBlcnR1cmUuCgp2MjoK
Z21jaCBpcyBvbmx5IHJlbGV2YW50IGZvciBtdWNoIG9sZGVyIGh3LCB0aGVyZWZvcmUgd2UgY2Fu
IGRyb3AgdGhlCmhhc19hcGVydHVyZSBjaGVjayBzaW5jZSBpdCBzaG91bGQgYWx3YXlzIGJlIHBy
ZXNlbnQgb24gc3VjaCBwbGF0Zm9ybXMuCihDaHJpcykKCkNjOiBWaWxsZSBTeXJqw6Rsw6QgPHZp
bGxlLnN5cmphbGFAbGludXguaW50ZWwuY29tPgpDYzogRGhpbmFrYXJhbiBQYW5kaXlhbiA8ZGhp
bmFrYXJhbi5wYW5kaXlhbkBpbnRlbC5jb20+CkNjOiBNYWFydGVuIExhbmtob3JzdCA8bWFhcnRl
bi5sYW5raG9yc3RAbGludXguaW50ZWwuY29tPgpDYzogQ2hyaXMgUCBXaWxzb24gPGNocmlzLnAu
d2lsc29uQGludGVsLmNvbT4KQ2M6IERhbmllbCBWZXR0ZXIgPGRhbmllbC52ZXR0ZXJAaW50ZWwu
Y29tPgpDYzogSm9vbmFzIExhaHRpbmVuIDxqb29uYXMubGFodGluZW5AbGludXguaW50ZWwuY29t
PgpDYzogRGFuaWVsZSBDZXJhb2xvIFNwdXJpbyA8ZGFuaWVsZS5jZXJhb2xvc3B1cmlvQGludGVs
LmNvbT4KQ2M6IENRIFRhbmcgPGNxLnRhbmdAaW50ZWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBBbnVz
aGEgU3JpdmF0c2EgPGFudXNoYS5zcml2YXRzYUBpbnRlbC5jb20+ClNpZ25lZC1vZmYtYnk6IE1h
dHRoZXcgQXVsZCA8bWF0dGhldy5hdWxkQGludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFR2cnRrbyBV
cnN1bGluIDx0dnJ0a28udXJzdWxpbkBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5
MTUvZGlzcGxheS9pbnRlbF9mYmRldi5jIHwgMjIgKysrKysrKysrKysrKy0tLS0tLQogZHJpdmVy
cy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2xtZW0uYyAgIHwgMTUgKysrKysrKysrKysrKwog
ZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2xtZW0uaCAgIHwgIDUgKysrKysKIGRy
aXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmMgICAgICAgICAgICB8IDI1ICsrKysrKysrKysr
KysrKystLS0tLS0KIDQgZmlsZXMgY2hhbmdlZCwgNTQgaW5zZXJ0aW9ucygrKSwgMTMgZGVsZXRp
b25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9m
YmRldi5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlzcGxheS9pbnRlbF9mYmRldi5jCmluZGV4
IDJiMzc5NTlkYTc0Ny4uNGFmNDAyMjlmNWVjIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9kaXNwbGF5L2ludGVsX2ZiZGV2LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZGlz
cGxheS9pbnRlbF9mYmRldi5jCkBAIC0xMzksMTQgKzEzOSwyMiBAQCBzdGF0aWMgaW50IGludGVs
ZmJfYWxsb2Moc3RydWN0IGRybV9mYl9oZWxwZXIgKmhlbHBlciwKIAlzaXplID0gbW9kZV9jbWQu
cGl0Y2hlc1swXSAqIG1vZGVfY21kLmhlaWdodDsKIAlzaXplID0gUEFHRV9BTElHTihzaXplKTsK
IAotCS8qIElmIHRoZSBGQiBpcyB0b28gYmlnLCBqdXN0IGRvbid0IHVzZSBpdCBzaW5jZSBmYmRl
diBpcyBub3QgdmVyeQotCSAqIGltcG9ydGFudCBhbmQgd2Ugc2hvdWxkIHByb2JhYmx5IHVzZSB0
aGF0IHNwYWNlIHdpdGggRkJDIG9yIG90aGVyCi0JICogZmVhdHVyZXMuICovCiAJb2JqID0gRVJS
X1BUUigtRU5PREVWKTsKLQlpZiAoc2l6ZSAqIDIgPCBkZXZfcHJpdi0+c3RvbGVuX3VzYWJsZV9z
aXplKQotCQlvYmogPSBpOTE1X2dlbV9vYmplY3RfY3JlYXRlX3N0b2xlbihkZXZfcHJpdiwgc2l6
ZSk7Ci0JaWYgKElTX0VSUihvYmopKQotCQlvYmogPSBpOTE1X2dlbV9vYmplY3RfY3JlYXRlX3No
bWVtKGRldl9wcml2LCBzaXplKTsKKwlpZiAoSEFTX0xNRU0oZGV2X3ByaXYpKSB7CisJCW9iaiA9
IGk5MTVfZ2VtX29iamVjdF9jcmVhdGVfbG1lbShkZXZfcHJpdiwgc2l6ZSwKKwkJCQkJCSAgSTkx
NV9CT19BTExPQ19DT05USUdVT1VTKTsKKwl9IGVsc2UgeworCQkvKgorCQkgKiBJZiB0aGUgRkIg
aXMgdG9vIGJpZywganVzdCBkb24ndCB1c2UgaXQgc2luY2UgZmJkZXYgaXMgbm90IHZlcnkKKwkJ
ICogaW1wb3J0YW50IGFuZCB3ZSBzaG91bGQgcHJvYmFibHkgdXNlIHRoYXQgc3BhY2Ugd2l0aCBG
QkMgb3Igb3RoZXIKKwkJICogZmVhdHVyZXMuCisJCSAqLworCQlpZiAoc2l6ZSAqIDIgPCBkZXZf
cHJpdi0+c3RvbGVuX3VzYWJsZV9zaXplKQorCQkJb2JqID0gaTkxNV9nZW1fb2JqZWN0X2NyZWF0
ZV9zdG9sZW4oZGV2X3ByaXYsIHNpemUpOworCQlpZiAoSVNfRVJSKG9iaikpCisJCQlvYmogPSBp
OTE1X2dlbV9vYmplY3RfY3JlYXRlX3NobWVtKGRldl9wcml2LCBzaXplKTsKKwl9CisKIAlpZiAo
SVNfRVJSKG9iaikpIHsKIAkJZHJtX2VycigmZGV2X3ByaXYtPmRybSwgImZhaWxlZCB0byBhbGxv
Y2F0ZSBmcmFtZWJ1ZmZlclxuIik7CiAJCXJldHVybiBQVFJfRVJSKG9iaik7CmRpZmYgLS1naXQg
YS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fbG1lbS5jIGIvZHJpdmVycy9ncHUv
ZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2xtZW0uYwppbmRleCAwMTdkYjhmNzExMzAuLmY0NGJkZDA4
ZjdjYiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2xtZW0u
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fbG1lbS5jCkBAIC0xNyw2
ICsxNywyMSBAQCBjb25zdCBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdF9vcHMgaTkxNV9nZW1f
bG1lbV9vYmpfb3BzID0gewogCS5yZWxlYXNlID0gaTkxNV9nZW1fb2JqZWN0X3JlbGVhc2VfbWVt
b3J5X3JlZ2lvbiwKIH07CiAKK3ZvaWQgX19pb21lbSAqCitpOTE1X2dlbV9vYmplY3RfbG1lbV9p
b19tYXAoc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCSAgICB1bnNpZ25lZCBs
b25nIG4sCisJCQkgICAgdW5zaWduZWQgbG9uZyBzaXplKQoreworCXJlc291cmNlX3NpemVfdCBv
ZmZzZXQ7CisKKwlHRU1fQlVHX09OKCFpOTE1X2dlbV9vYmplY3RfaXNfY29udGlndW91cyhvYmop
KTsKKworCW9mZnNldCA9IGk5MTVfZ2VtX29iamVjdF9nZXRfZG1hX2FkZHJlc3Mob2JqLCBuKTsK
KwlvZmZzZXQgLT0gb2JqLT5tbS5yZWdpb24tPnJlZ2lvbi5zdGFydDsKKworCXJldHVybiBpb19t
YXBwaW5nX21hcF93Yygmb2JqLT5tbS5yZWdpb24tPmlvbWFwLCBvZmZzZXQsIHNpemUpOworfQor
CiBib29sIGk5MTVfZ2VtX29iamVjdF9pc19sbWVtKHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0
ICpvYmopCiB7CiAJc3RydWN0IGludGVsX21lbW9yeV9yZWdpb24gKm1yID0gb2JqLT5tbS5yZWdp
b247CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fbG1lbS5o
IGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX2xtZW0uaAppbmRleCAwMzZkNTNj
MDFkZTkuLmZhYzZiYzVhNWViYiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX2xtZW0uaAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1f
bG1lbS5oCkBAIC0xNCw2ICsxNCwxMSBAQCBzdHJ1Y3QgaW50ZWxfbWVtb3J5X3JlZ2lvbjsKIAog
ZXh0ZXJuIGNvbnN0IHN0cnVjdCBkcm1faTkxNV9nZW1fb2JqZWN0X29wcyBpOTE1X2dlbV9sbWVt
X29ial9vcHM7CiAKK3ZvaWQgX19pb21lbSAqCitpOTE1X2dlbV9vYmplY3RfbG1lbV9pb19tYXAo
c3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCSAgICB1bnNpZ25lZCBsb25nIG4s
CisJCQkgICAgdW5zaWduZWQgbG9uZyBzaXplKTsKKwogYm9vbCBpOTE1X2dlbV9vYmplY3RfaXNf
bG1lbShzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKTsKIAogc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEu
YyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmMKaW5kZXggZWIwMTg5OWFjNmI3Li40
NjgzMTdlM2I0NzcgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2k5MTVfdm1hLmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaTkxNV92bWEuYwpAQCAtMjcsNiArMjcsNyBAQAog
CiAjaW5jbHVkZSAiZGlzcGxheS9pbnRlbF9mcm9udGJ1ZmZlci5oIgogCisjaW5jbHVkZSAiZ2Vt
L2k5MTVfZ2VtX2xtZW0uaCIKICNpbmNsdWRlICJndC9pbnRlbF9lbmdpbmUuaCIKICNpbmNsdWRl
ICJndC9pbnRlbF9lbmdpbmVfaGVhcnRiZWF0LmgiCiAjaW5jbHVkZSAiZ3QvaW50ZWxfZ3QuaCIK
QEAgLTQ0OCw5ICs0NDksMTEgQEAgdm9pZCBfX2lvbWVtICppOTE1X3ZtYV9waW5faW9tYXAoc3Ry
dWN0IGk5MTVfdm1hICp2bWEpCiAJdm9pZCBfX2lvbWVtICpwdHI7CiAJaW50IGVycjsKIAotCWlm
IChHRU1fV0FSTl9PTighaTkxNV92bWFfaXNfbWFwX2FuZF9mZW5jZWFibGUodm1hKSkpIHsKLQkJ
ZXJyID0gLUVOT0RFVjsKLQkJZ290byBlcnI7CisJaWYgKCFpOTE1X2dlbV9vYmplY3RfaXNfbG1l
bSh2bWEtPm9iaikpIHsKKwkJaWYgKEdFTV9XQVJOX09OKCFpOTE1X3ZtYV9pc19tYXBfYW5kX2Zl
bmNlYWJsZSh2bWEpKSkgeworCQkJZXJyID0gLUVOT0RFVjsKKwkJCWdvdG8gZXJyOworCQl9CiAJ
fQogCiAJR0VNX0JVR19PTighaTkxNV92bWFfaXNfZ2d0dCh2bWEpKTsKQEAgLTQ1OCw5ICs0NjEs
MTkgQEAgdm9pZCBfX2lvbWVtICppOTE1X3ZtYV9waW5faW9tYXAoc3RydWN0IGk5MTVfdm1hICp2
bWEpCiAKIAlwdHIgPSBSRUFEX09OQ0Uodm1hLT5pb21hcCk7CiAJaWYgKHB0ciA9PSBOVUxMKSB7
Ci0JCXB0ciA9IGlvX21hcHBpbmdfbWFwX3djKCZpOTE1X3ZtX3RvX2dndHQodm1hLT52bSktPmlv
bWFwLAotCQkJCQl2bWEtPm5vZGUuc3RhcnQsCi0JCQkJCXZtYS0+bm9kZS5zaXplKTsKKwkJLyoK
KwkJICogVE9ETzogY29uc2lkZXIganVzdCB1c2luZyBpOTE1X2dlbV9vYmplY3RfcGluX21hcCgp
IGZvciBsbWVtCisJCSAqIGluc3RlYWQsIHdoaWNoIGFscmVhZHkgc3VwcG9ydHMgbWFwcGluZyBu
b24tY29udGlndW91cyBjaHVua3MKKwkJICogb2YgcGFnZXMsIHRoYXQgd2F5IHdlIGNhbiBhbHNv
IGRyb3AgdGhlCisJCSAqIEk5MTVfQk9fQUxMT0NfQ09OVElHVU9VUyB3aGVuIGFsbG9jYXRpbmcg
dGhlIG9iamVjdC4KKwkJICovCisJCWlmIChpOTE1X2dlbV9vYmplY3RfaXNfbG1lbSh2bWEtPm9i
aikpCisJCQlwdHIgPSBpOTE1X2dlbV9vYmplY3RfbG1lbV9pb19tYXAodm1hLT5vYmosIDAsCisJ
CQkJCQkJICB2bWEtPm9iai0+YmFzZS5zaXplKTsKKwkJZWxzZQorCQkJcHRyID0gaW9fbWFwcGlu
Z19tYXBfd2MoJmk5MTVfdm1fdG9fZ2d0dCh2bWEtPnZtKS0+aW9tYXAsCisJCQkJCQl2bWEtPm5v
ZGUuc3RhcnQsCisJCQkJCQl2bWEtPm5vZGUuc2l6ZSk7CiAJCWlmIChwdHIgPT0gTlVMTCkgewog
CQkJZXJyID0gLUVOT01FTTsKIAkJCWdvdG8gZXJyOwotLSAKMi4yNi4zCgpfX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0
CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3Rv
cC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
