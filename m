Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 6FA45B359F
	for <lists+dri-devel@lfdr.de>; Mon, 16 Sep 2019 09:28:48 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 769C16E861;
	Mon, 16 Sep 2019 07:28:33 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
X-Greylist: delayed 336 seconds by postgrey-1.36 at gabe;
 Sat, 14 Sep 2019 22:09:21 UTC
Received: from vps.xff.cz (vps.xff.cz [195.181.215.36])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 10A706F561
 for <dri-devel@lists.freedesktop.org>; Sat, 14 Sep 2019 22:09:21 +0000 (UTC)
From: megous@megous.com
To: Maxime Ripard <mripard@kernel.org>, David Airlie <airlied@linux.ie>,
 Daniel Vetter <daniel@ffwll.ch>, Chen-Yu Tsai <wens@csie.org>
Subject: [PATCH] drm: sun8i-ui/vi: Fix layer zpos change/atomic modesetting
Date: Sun, 15 Sep 2019 00:03:37 +0200
Message-Id: <20190914220337.646719-1-megous@megous.com>
MIME-Version: 1.0
X-Mailman-Approved-At: Mon, 16 Sep 2019 07:28:04 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
 d=megous.com; s=mail; 
 t=1568498623; bh=AbF8sfpZSp7CQ29ALLr+Qijb3QvQtsAkWUYeZO6ZrI4=;
 h=From:To:Cc:Subject:Date:From;
 b=luZPH5cbHdQzGY7dGzdNhefpNh4xvQff5b2ivGTwUg50FEmlO3DPSdzZyjKG5sQH6
 OsGBLW4rs++1WWZ5OgfYyDtJY4WwvnCxn80aJKfYNuRypkVKD11Bq9bqv7HbcbrV2l
 j/AO/ge5Y+fwQGOTeUyRCpu2voV2dad0VbsvxZUg=
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Ondrej Jirman <megous@megous.com>, linux-arm-kernel@lists.infradead.org,
 dri-devel@lists.freedesktop.org, linux-kernel@vger.kernel.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogT25kcmVqIEppcm1hbiA8bWVnb3VzQG1lZ291cy5jb20+CgpUaGVyZSBhcmUgdmFyaW91
cyBpc3N1ZXMgdGhhdCB0aGlzIHJlLXdvcmsgb2Ygc3VuOGlfW3V2XWlfbGF5ZXJfZW5hYmxlCmZ1
bmN0aW9uIGZpeGVzOgoKLSBNYWtlIHN1cmUgdGhhdCB3ZSByZS1pbml0aWFsaXplIHpwb3Mgb24g
cmVzZXQKLSBNaW5pbWl6ZSByZWdpc3RlciB1cGRhdGVzIGJ5IGRvaW5nIHRoZW0gb25seSB3aGVu
IHN0YXRlIGNoYW5nZXMKLSBGaXggaXNzdWUgd2hlcmUgREUgcGlwZSBtaWdodCBnZXQgZGlzYWJs
ZWQgZXZlbiBpZiBpdCBpcyBubyBsb25nZXIKICB1c2VkIGJ5IHRoZSBsYXllciB0aGF0J3MgY3Vy
cmVudGx5IGNhbGxpbmcgc3VuOGlfdWlfbGF5ZXJfZW5hYmxlCi0gLmF0b21pY19kaXNhYmxlIGNh
bGxiYWNrIGlzIG5vdCByZWFsbHkgbmVlZGVkIGJlY2F1c2UgLmF0b21pY191cGRhdGUKICBjYW4g
ZG8gdGhlIGRpc2FibGUgdG9vLCBzbyBkcm9wIHRoZSBkdXBsaWNhdGUgY29kZQoKU2lnbmVkLW9m
Zi1ieTogT25kcmVqIEppcm1hbiA8bWVnb3VzQG1lZ291cy5jb20+Ci0tLQogZHJpdmVycy9ncHUv
ZHJtL3N1bjRpL3N1bjhpX3VpX2xheWVyLmMgfCAxMTIgKysrKysrKysrKysrKysrKy0tLS0tLS0t
LQogZHJpdmVycy9ncHUvZHJtL3N1bjRpL3N1bjhpX3ZpX2xheWVyLmMgfCAxMTIgKysrKysrKysr
KysrKysrKy0tLS0tLS0tLQogMiBmaWxlcyBjaGFuZ2VkLCAxNDIgaW5zZXJ0aW9ucygrKSwgODIg
ZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL3N1bjRpL3N1bjhpX3Vp
X2xheWVyLmMgYi9kcml2ZXJzL2dwdS9kcm0vc3VuNGkvc3VuOGlfdWlfbGF5ZXIuYwppbmRleCBk
ZDJhMWM4NTE5MzkuLmI4OGU4YWM1YWQxYyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3N1
bjRpL3N1bjhpX3VpX2xheWVyLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3N1bjRpL3N1bjhpX3Vp
X2xheWVyLmMKQEAgLTI0LDEwICsyNCwxMSBAQAogI2luY2x1ZGUgInN1bjhpX3VpX3NjYWxlci5o
IgogCiBzdGF0aWMgdm9pZCBzdW44aV91aV9sYXllcl9lbmFibGUoc3RydWN0IHN1bjhpX21peGVy
ICptaXhlciwgaW50IGNoYW5uZWwsCi0JCQkJICBpbnQgb3ZlcmxheSwgYm9vbCBlbmFibGUsIHVu
c2lnbmVkIGludCB6cG9zLAotCQkJCSAgdW5zaWduZWQgaW50IG9sZF96cG9zKQorCQkJCSAgaW50
IG92ZXJsYXksIGJvb2wgd2FzX2VuYWJsZWQsIGJvb2wgZW5hYmxlLAorCQkJCSAgdW5zaWduZWQg
aW50IHpwb3MsIHVuc2lnbmVkIGludCBvbGRfenBvcykKIHsKIAl1MzIgdmFsLCBibGRfYmFzZSwg
Y2hfYmFzZTsKKwl1bnNpZ25lZCBpbnQgb2xkX3BpcGVfY2g7CiAKIAlibGRfYmFzZSA9IHN1bjhp
X2JsZW5kZXJfYmFzZShtaXhlcik7CiAJY2hfYmFzZSA9IHN1bjhpX2NoYW5uZWxfYmFzZShtaXhl
ciwgY2hhbm5lbCk7CkBAIC0zNSwyOCArMzYsNTcgQEAgc3RhdGljIHZvaWQgc3VuOGlfdWlfbGF5
ZXJfZW5hYmxlKHN0cnVjdCBzdW44aV9taXhlciAqbWl4ZXIsIGludCBjaGFubmVsLAogCURSTV9E
RUJVR19EUklWRVIoIiVzYWJsaW5nIGNoYW5uZWwgJWQgb3ZlcmxheSAlZFxuIiwKIAkJCSBlbmFi
bGUgPyAiRW4iIDogIkRpcyIsIGNoYW5uZWwsIG92ZXJsYXkpOwogCi0JaWYgKGVuYWJsZSkKLQkJ
dmFsID0gU1VOOElfTUlYRVJfQ0hBTl9VSV9MQVlFUl9BVFRSX0VOOwotCWVsc2UKLQkJdmFsID0g
MDsKKwlpZiAoIXdhc19lbmFibGVkICE9ICFlbmFibGUpIHsKKwkJdmFsID0gZW5hYmxlID8gU1VO
OElfTUlYRVJfQ0hBTl9VSV9MQVlFUl9BVFRSX0VOIDogMDsKIAotCXJlZ21hcF91cGRhdGVfYml0
cyhtaXhlci0+ZW5naW5lLnJlZ3MsCi0JCQkgICBTVU44SV9NSVhFUl9DSEFOX1VJX0xBWUVSX0FU
VFIoY2hfYmFzZSwgb3ZlcmxheSksCi0JCQkgICBTVU44SV9NSVhFUl9DSEFOX1VJX0xBWUVSX0FU
VFJfRU4sIHZhbCk7Ci0KLQlpZiAoIWVuYWJsZSB8fCB6cG9zICE9IG9sZF96cG9zKSB7CiAJCXJl
Z21hcF91cGRhdGVfYml0cyhtaXhlci0+ZW5naW5lLnJlZ3MsCi0JCQkJICAgU1VOOElfTUlYRVJf
QkxFTkRfUElQRV9DVEwoYmxkX2Jhc2UpLAotCQkJCSAgIFNVTjhJX01JWEVSX0JMRU5EX1BJUEVf
Q1RMX0VOKG9sZF96cG9zKSwKLQkJCQkgICAwKTsKKwkJCQkgICBTVU44SV9NSVhFUl9DSEFOX1VJ
X0xBWUVSX0FUVFIoY2hfYmFzZSwgb3ZlcmxheSksCisJCQkJICAgU1VOOElfTUlYRVJfQ0hBTl9V
SV9MQVlFUl9BVFRSX0VOLCB2YWwpOworCX0KIAotCQlyZWdtYXBfdXBkYXRlX2JpdHMobWl4ZXIt
PmVuZ2luZS5yZWdzLAorCS8qCisJICogSWYgdGhpcyBsYXllciB3YXMgZW5hYmxlZCBhbmQgaXMg
YmVpbmcgZGlzYWJsZWQgb3IgaWYgaXQgaXMKKwkgKiBlbmFibGVkIGFuZCBqdXN0IGNoYW5naW5n
IHpwb3MsIGNsZWFyIHRoZSBvbGQgcm91dGUsIGlmIGl0IGlzCisJICogc3RpbGwgY29uZmlndXJl
ZCB0byB0aGlzIGxheWVyIGluIEhXLgorCSAqLworCWlmICgod2FzX2VuYWJsZWQgJiYgIWVuYWJs
ZSkgfHwgKGVuYWJsZSAmJiB6cG9zICE9IG9sZF96cG9zKSkgeworCQkvKiBnZXQgY2hhbm5lbCB0
aGUgcGlwZSBmb3Igb2xkX3pwb3MgaXMgcm91dGVkIHRvIGZyb20gdGhlIEhXICovCisJCXJlZ21h
cF9yZWFkKG1peGVyLT5lbmdpbmUucmVncywKIAkJCQkgICBTVU44SV9NSVhFUl9CTEVORF9ST1VU
RShibGRfYmFzZSksCi0JCQkJICAgU1VOOElfTUlYRVJfQkxFTkRfUk9VVEVfUElQRV9NU0sob2xk
X3pwb3MpLAotCQkJCSAgIDApOworCQkJCSAgICZvbGRfcGlwZV9jaCk7CisJCW9sZF9waXBlX2No
ICY9IFNVTjhJX01JWEVSX0JMRU5EX1JPVVRFX1BJUEVfTVNLKG9sZF96cG9zKTsKKwkJb2xkX3Bp
cGVfY2ggPj49IFNVTjhJX01JWEVSX0JMRU5EX1JPVVRFX1BJUEVfU0hJRlQob2xkX3pwb3MpOwor
CisJCS8qCisJCSAqIENoZWNrIHRoYXQgcGlwZSBmb3Igb2xkX3pwb3MgaXMgc3RpbGwgcm91dGVk
IHRvIG91ciBsYXllciwKKwkJICogYW5kIGNsZWFyL2Rpc2FibGUgaXQgaWYgaXQgaXMuCisJCSAq
LworCisJCWlmIChvbGRfcGlwZV9jaCA9PSBjaGFubmVsKSB7CisJCQlEUk1fREVCVUdfRFJJVkVS
KCJjaGFuPSVkIGVuPSVkLT4lZCB6cG9zPSVkLT4lZFxuIiwKKwkJCSAgICAgICBjaGFubmVsLCB3
YXNfZW5hYmxlZCwgZW5hYmxlLCBvbGRfenBvcywgenBvcyk7CisKKwkJCURSTV9ERUJVR19EUklW
RVIoIiAgZGlzYWJsZSBwaXBlICVkXG4iLCBvbGRfenBvcyk7CisKKwkJCXJlZ21hcF91cGRhdGVf
Yml0cyhtaXhlci0+ZW5naW5lLnJlZ3MsCisJCQkJCSAgIFNVTjhJX01JWEVSX0JMRU5EX1JPVVRF
KGJsZF9iYXNlKSwKKwkJCQkJICAgU1VOOElfTUlYRVJfQkxFTkRfUk9VVEVfUElQRV9NU0sob2xk
X3pwb3MpLAorCQkJCQkgICAwKTsKKworCQkJcmVnbWFwX3VwZGF0ZV9iaXRzKG1peGVyLT5lbmdp
bmUucmVncywKKwkJCQkJICAgU1VOOElfTUlYRVJfQkxFTkRfUElQRV9DVEwoYmxkX2Jhc2UpLAor
CQkJCQkgICBTVU44SV9NSVhFUl9CTEVORF9QSVBFX0NUTF9FTihvbGRfenBvcyksCisJCQkJCSAg
IDApOworCQl9CiAJfQogCi0JaWYgKGVuYWJsZSkgeworCS8qCisJICogSWYgZW5hYmxpbmcgdGhp
cyBsYXllciBvciBjaGFuZ2luIHpwb3MsIHNldCByb3V0ZSB0byB0aGlzIGxheWVyLgorCSAqLwor
CWlmICgoZW5hYmxlICYmICF3YXNfZW5hYmxlZCkgfHwgKGVuYWJsZSAmJiB6cG9zICE9IG9sZF96
cG9zKSkgeworCQlEUk1fREVCVUdfRFJJVkVSKCJjaGFuPSVkIGVuPSVkLT4lZCB6cG9zPSVkLT4l
ZFxuIiwKKwkJICAgICAgIGNoYW5uZWwsIHdhc19lbmFibGVkLCBlbmFibGUsIG9sZF96cG9zLCB6
cG9zKTsKKwogCQl2YWwgPSBTVU44SV9NSVhFUl9CTEVORF9QSVBFX0NUTF9FTih6cG9zKTsKIAog
CQlyZWdtYXBfdXBkYXRlX2JpdHMobWl4ZXItPmVuZ2luZS5yZWdzLApAQCAtNjksNiArOTksOCBA
QCBzdGF0aWMgdm9pZCBzdW44aV91aV9sYXllcl9lbmFibGUoc3RydWN0IHN1bjhpX21peGVyICpt
aXhlciwgaW50IGNoYW5uZWwsCiAJCQkJICAgU1VOOElfTUlYRVJfQkxFTkRfUk9VVEUoYmxkX2Jh
c2UpLAogCQkJCSAgIFNVTjhJX01JWEVSX0JMRU5EX1JPVVRFX1BJUEVfTVNLKHpwb3MpLAogCQkJ
CSAgIHZhbCk7CisKKwkJRFJNX0RFQlVHX0RSSVZFUigiICBlbmFibGUgcGlwZSAlZCA8LSBjaCAl
ZFxuIiwgenBvcywgY2hhbm5lbCk7CiAJfQogfQogCkBAIC0yNjEsNDUgKzI5Myw0MyBAQCBzdGF0
aWMgaW50IHN1bjhpX3VpX2xheWVyX2F0b21pY19jaGVjayhzdHJ1Y3QgZHJtX3BsYW5lICpwbGFu
ZSwKIAkJCQkJCSAgIHRydWUsIHRydWUpOwogfQogCi1zdGF0aWMgdm9pZCBzdW44aV91aV9sYXll
cl9hdG9taWNfZGlzYWJsZShzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZSwKLQkJCQkJICBzdHJ1Y3Qg
ZHJtX3BsYW5lX3N0YXRlICpvbGRfc3RhdGUpCitzdGF0aWMgdm9pZCBzdW44aV91aV9sYXllcl9h
dG9taWNfdXBkYXRlKHN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lLAorCQkJCQkgc3RydWN0IGRybV9w
bGFuZV9zdGF0ZSAqb2xkX3N0YXRlKQogewogCXN0cnVjdCBzdW44aV91aV9sYXllciAqbGF5ZXIg
PSBwbGFuZV90b19zdW44aV91aV9sYXllcihwbGFuZSk7CisJdW5zaWduZWQgaW50IHpwb3MgPSBw
bGFuZS0+c3RhdGUtPm5vcm1hbGl6ZWRfenBvczsKIAl1bnNpZ25lZCBpbnQgb2xkX3pwb3MgPSBv
bGRfc3RhdGUtPm5vcm1hbGl6ZWRfenBvczsKIAlzdHJ1Y3Qgc3VuOGlfbWl4ZXIgKm1peGVyID0g
bGF5ZXItPm1peGVyOworCWJvb2wgd2FzX2VuYWJsZWQgPSBvbGRfc3RhdGUtPmNydGMgJiYgb2xk
X3N0YXRlLT52aXNpYmxlOworCWJvb2wgZW5hYmxlID0gcGxhbmUtPnN0YXRlLT5jcnRjICYmIHBs
YW5lLT5zdGF0ZS0+dmlzaWJsZTsKIAotCXN1bjhpX3VpX2xheWVyX2VuYWJsZShtaXhlciwgbGF5
ZXItPmNoYW5uZWwsIGxheWVyLT5vdmVybGF5LCBmYWxzZSwgMCwKLQkJCSAgICAgIG9sZF96cG9z
KTsKKwlpZiAoZW5hYmxlKSB7CisJCXN1bjhpX3VpX2xheWVyX3VwZGF0ZV9jb29yZChtaXhlciwg
bGF5ZXItPmNoYW5uZWwsCisJCQkJCSAgICBsYXllci0+b3ZlcmxheSwgcGxhbmUsIHpwb3MpOwor
CQlzdW44aV91aV9sYXllcl91cGRhdGVfZm9ybWF0cyhtaXhlciwgbGF5ZXItPmNoYW5uZWwsCisJ
CQkJCSAgICAgIGxheWVyLT5vdmVybGF5LCBwbGFuZSk7CisJCXN1bjhpX3VpX2xheWVyX3VwZGF0
ZV9idWZmZXIobWl4ZXIsIGxheWVyLT5jaGFubmVsLAorCQkJCQkgICAgIGxheWVyLT5vdmVybGF5
LCBwbGFuZSk7CisJfQorCisJc3VuOGlfdWlfbGF5ZXJfZW5hYmxlKG1peGVyLCBsYXllci0+Y2hh
bm5lbCwgbGF5ZXItPm92ZXJsYXksCisJCQkgICAgICB3YXNfZW5hYmxlZCwgZW5hYmxlLCB6cG9z
LCBvbGRfenBvcyk7CiB9CiAKLXN0YXRpYyB2b2lkIHN1bjhpX3VpX2xheWVyX2F0b21pY191cGRh
dGUoc3RydWN0IGRybV9wbGFuZSAqcGxhbmUsCi0JCQkJCSBzdHJ1Y3QgZHJtX3BsYW5lX3N0YXRl
ICpvbGRfc3RhdGUpCit2b2lkIHN1bjhpX3VpX2xheWVyX3BsYW5lX3Jlc2V0KHN0cnVjdCBkcm1f
cGxhbmUgKnBsYW5lKQogewogCXN0cnVjdCBzdW44aV91aV9sYXllciAqbGF5ZXIgPSBwbGFuZV90
b19zdW44aV91aV9sYXllcihwbGFuZSk7Ci0JdW5zaWduZWQgaW50IHpwb3MgPSBwbGFuZS0+c3Rh
dGUtPm5vcm1hbGl6ZWRfenBvczsKLQl1bnNpZ25lZCBpbnQgb2xkX3pwb3MgPSBvbGRfc3RhdGUt
Pm5vcm1hbGl6ZWRfenBvczsKLQlzdHJ1Y3Qgc3VuOGlfbWl4ZXIgKm1peGVyID0gbGF5ZXItPm1p
eGVyOwogCi0JaWYgKCFwbGFuZS0+c3RhdGUtPnZpc2libGUpIHsKLQkJc3VuOGlfdWlfbGF5ZXJf
ZW5hYmxlKG1peGVyLCBsYXllci0+Y2hhbm5lbCwKLQkJCQkgICAgICBsYXllci0+b3ZlcmxheSwg
ZmFsc2UsIDAsIG9sZF96cG9zKTsKKwlkcm1fYXRvbWljX2hlbHBlcl9wbGFuZV9yZXNldChwbGFu
ZSk7CisJaWYgKCFwbGFuZS0+c3RhdGUpCiAJCXJldHVybjsKLQl9CiAKLQlzdW44aV91aV9sYXll
cl91cGRhdGVfY29vcmQobWl4ZXIsIGxheWVyLT5jaGFubmVsLAotCQkJCSAgICBsYXllci0+b3Zl
cmxheSwgcGxhbmUsIHpwb3MpOwotCXN1bjhpX3VpX2xheWVyX3VwZGF0ZV9mb3JtYXRzKG1peGVy
LCBsYXllci0+Y2hhbm5lbCwKLQkJCQkgICAgICBsYXllci0+b3ZlcmxheSwgcGxhbmUpOwotCXN1
bjhpX3VpX2xheWVyX3VwZGF0ZV9idWZmZXIobWl4ZXIsIGxheWVyLT5jaGFubmVsLAotCQkJCSAg
ICAgbGF5ZXItPm92ZXJsYXksIHBsYW5lKTsKLQlzdW44aV91aV9sYXllcl9lbmFibGUobWl4ZXIs
IGxheWVyLT5jaGFubmVsLCBsYXllci0+b3ZlcmxheSwKLQkJCSAgICAgIHRydWUsIHpwb3MsIG9s
ZF96cG9zKTsKKwlwbGFuZS0+c3RhdGUtPnpwb3MgPSBsYXllci0+Y2hhbm5lbDsKIH0KIAogc3Rh
dGljIHN0cnVjdCBkcm1fcGxhbmVfaGVscGVyX2Z1bmNzIHN1bjhpX3VpX2xheWVyX2hlbHBlcl9m
dW5jcyA9IHsKIAkucHJlcGFyZV9mYgk9IGRybV9nZW1fZmJfcHJlcGFyZV9mYiwKIAkuYXRvbWlj
X2NoZWNrCT0gc3VuOGlfdWlfbGF5ZXJfYXRvbWljX2NoZWNrLAotCS5hdG9taWNfZGlzYWJsZQk9
IHN1bjhpX3VpX2xheWVyX2F0b21pY19kaXNhYmxlLAogCS5hdG9taWNfdXBkYXRlCT0gc3VuOGlf
dWlfbGF5ZXJfYXRvbWljX3VwZGF0ZSwKIH07CiAKQEAgLTMwOCw3ICszMzgsNyBAQCBzdGF0aWMg
Y29uc3Qgc3RydWN0IGRybV9wbGFuZV9mdW5jcyBzdW44aV91aV9sYXllcl9mdW5jcyA9IHsKIAku
YXRvbWljX2R1cGxpY2F0ZV9zdGF0ZQk9IGRybV9hdG9taWNfaGVscGVyX3BsYW5lX2R1cGxpY2F0
ZV9zdGF0ZSwKIAkuZGVzdHJveQkJPSBkcm1fcGxhbmVfY2xlYW51cCwKIAkuZGlzYWJsZV9wbGFu
ZQkJPSBkcm1fYXRvbWljX2hlbHBlcl9kaXNhYmxlX3BsYW5lLAotCS5yZXNldAkJCT0gZHJtX2F0
b21pY19oZWxwZXJfcGxhbmVfcmVzZXQsCisJLnJlc2V0CQkJPSBzdW44aV91aV9sYXllcl9wbGFu
ZV9yZXNldCwKIAkudXBkYXRlX3BsYW5lCQk9IGRybV9hdG9taWNfaGVscGVyX3VwZGF0ZV9wbGFu
ZSwKIH07CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9zdW40aS9zdW44aV92aV9sYXll
ci5jIGIvZHJpdmVycy9ncHUvZHJtL3N1bjRpL3N1bjhpX3ZpX2xheWVyLmMKaW5kZXggYmQwZTZh
NTJkMWQ4Li42NzVlYmNkYWMwMGIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9zdW40aS9z
dW44aV92aV9sYXllci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9zdW40aS9zdW44aV92aV9sYXll
ci5jCkBAIC0xOCwxMCArMTgsMTEgQEAKICNpbmNsdWRlICJzdW44aV92aV9zY2FsZXIuaCIKIAog
c3RhdGljIHZvaWQgc3VuOGlfdmlfbGF5ZXJfZW5hYmxlKHN0cnVjdCBzdW44aV9taXhlciAqbWl4
ZXIsIGludCBjaGFubmVsLAotCQkJCSAgaW50IG92ZXJsYXksIGJvb2wgZW5hYmxlLCB1bnNpZ25l
ZCBpbnQgenBvcywKLQkJCQkgIHVuc2lnbmVkIGludCBvbGRfenBvcykKKwkJCQkgIGludCBvdmVy
bGF5LCBib29sIHdhc19lbmFibGVkLCBib29sIGVuYWJsZSwKKwkJCQkgIHVuc2lnbmVkIGludCB6
cG9zLCB1bnNpZ25lZCBpbnQgb2xkX3pwb3MpCiB7CiAJdTMyIHZhbCwgYmxkX2Jhc2UsIGNoX2Jh
c2U7CisJdW5zaWduZWQgaW50IG9sZF9waXBlX2NoOwogCiAJYmxkX2Jhc2UgPSBzdW44aV9ibGVu
ZGVyX2Jhc2UobWl4ZXIpOwogCWNoX2Jhc2UgPSBzdW44aV9jaGFubmVsX2Jhc2UobWl4ZXIsIGNo
YW5uZWwpOwpAQCAtMjksMjggKzMwLDU3IEBAIHN0YXRpYyB2b2lkIHN1bjhpX3ZpX2xheWVyX2Vu
YWJsZShzdHJ1Y3Qgc3VuOGlfbWl4ZXIgKm1peGVyLCBpbnQgY2hhbm5lbCwKIAlEUk1fREVCVUdf
RFJJVkVSKCIlc2FibGluZyBWSSBjaGFubmVsICVkIG92ZXJsYXkgJWRcbiIsCiAJCQkgZW5hYmxl
ID8gIkVuIiA6ICJEaXMiLCBjaGFubmVsLCBvdmVybGF5KTsKIAotCWlmIChlbmFibGUpCi0JCXZh
bCA9IFNVTjhJX01JWEVSX0NIQU5fVklfTEFZRVJfQVRUUl9FTjsKLQllbHNlCi0JCXZhbCA9IDA7
Ci0KLQlyZWdtYXBfdXBkYXRlX2JpdHMobWl4ZXItPmVuZ2luZS5yZWdzLAotCQkJICAgU1VOOElf
TUlYRVJfQ0hBTl9WSV9MQVlFUl9BVFRSKGNoX2Jhc2UsIG92ZXJsYXkpLAotCQkJICAgU1VOOElf
TUlYRVJfQ0hBTl9WSV9MQVlFUl9BVFRSX0VOLCB2YWwpOworCWlmICghd2FzX2VuYWJsZWQgIT0g
IWVuYWJsZSkgeworCQl2YWwgPSBlbmFibGUgPyBTVU44SV9NSVhFUl9DSEFOX1ZJX0xBWUVSX0FU
VFJfRU4gOiAwOwogCi0JaWYgKCFlbmFibGUgfHwgenBvcyAhPSBvbGRfenBvcykgewogCQlyZWdt
YXBfdXBkYXRlX2JpdHMobWl4ZXItPmVuZ2luZS5yZWdzLAotCQkJCSAgIFNVTjhJX01JWEVSX0JM
RU5EX1BJUEVfQ1RMKGJsZF9iYXNlKSwKLQkJCQkgICBTVU44SV9NSVhFUl9CTEVORF9QSVBFX0NU
TF9FTihvbGRfenBvcyksCi0JCQkJICAgMCk7CisJCQkJICAgU1VOOElfTUlYRVJfQ0hBTl9WSV9M
QVlFUl9BVFRSKGNoX2Jhc2UsIG92ZXJsYXkpLAorCQkJCSAgIFNVTjhJX01JWEVSX0NIQU5fVklf
TEFZRVJfQVRUUl9FTiwgdmFsKTsKKwl9CiAKLQkJcmVnbWFwX3VwZGF0ZV9iaXRzKG1peGVyLT5l
bmdpbmUucmVncywKKwkvKgorCSAqIElmIHRoaXMgbGF5ZXIgd2FzIGVuYWJsZWQgYW5kIGlzIGJl
aW5nIGRpc2FibGVkIG9yIGlmIGl0IGlzCisJICogZW5hYmxlZCBhbmQganVzdCBjaGFuZ2luZyB6
cG9zLCBjbGVhciB0aGUgb2xkIHJvdXRlLCBpZiBpdCBpcworCSAqIHN0aWxsIGNvbmZpZ3VyZWQg
dG8gdGhpcyBsYXllciBpbiBIVy4KKwkgKi8KKwlpZiAoKHdhc19lbmFibGVkICYmICFlbmFibGUp
IHx8IChlbmFibGUgJiYgenBvcyAhPSBvbGRfenBvcykpIHsKKwkJLyogZ2V0IGNoYW5uZWwgdGhl
IHBpcGUgZm9yIG9sZF96cG9zIGlzIHJvdXRlZCB0byBmcm9tIHRoZSBIVyAqLworCQlyZWdtYXBf
cmVhZChtaXhlci0+ZW5naW5lLnJlZ3MsCiAJCQkJICAgU1VOOElfTUlYRVJfQkxFTkRfUk9VVEUo
YmxkX2Jhc2UpLAotCQkJCSAgIFNVTjhJX01JWEVSX0JMRU5EX1JPVVRFX1BJUEVfTVNLKG9sZF96
cG9zKSwKLQkJCQkgICAwKTsKKwkJCQkgICAmb2xkX3BpcGVfY2gpOworCQlvbGRfcGlwZV9jaCAm
PSBTVU44SV9NSVhFUl9CTEVORF9ST1VURV9QSVBFX01TSyhvbGRfenBvcyk7CisJCW9sZF9waXBl
X2NoID4+PSBTVU44SV9NSVhFUl9CTEVORF9ST1VURV9QSVBFX1NISUZUKG9sZF96cG9zKTsKKwor
CQkvKgorCQkgKiBDaGVjayB0aGF0IHBpcGUgZm9yIG9sZF96cG9zIGlzIHN0aWxsIHJvdXRlZCB0
byBvdXIgbGF5ZXIsCisJCSAqIGFuZCBjbGVhci9kaXNhYmxlIGl0IGlmIGl0IGlzLgorCQkgKi8K
KworCQlpZiAob2xkX3BpcGVfY2ggPT0gY2hhbm5lbCkgeworCQkJRFJNX0RFQlVHX0RSSVZFUigi
Y2hhbj0lZCBlbj0lZC0+JWQgenBvcz0lZC0+JWRcbiIsCisJCQkgICAgICAgY2hhbm5lbCwgd2Fz
X2VuYWJsZWQsIGVuYWJsZSwgb2xkX3pwb3MsIHpwb3MpOworCisJCQlEUk1fREVCVUdfRFJJVkVS
KCIgIGRpc2FibGUgcGlwZSAlZFxuIiwgb2xkX3pwb3MpOworCisJCQlyZWdtYXBfdXBkYXRlX2Jp
dHMobWl4ZXItPmVuZ2luZS5yZWdzLAorCQkJCQkgICBTVU44SV9NSVhFUl9CTEVORF9ST1VURShi
bGRfYmFzZSksCisJCQkJCSAgIFNVTjhJX01JWEVSX0JMRU5EX1JPVVRFX1BJUEVfTVNLKG9sZF96
cG9zKSwKKwkJCQkJICAgMCk7CisKKwkJCXJlZ21hcF91cGRhdGVfYml0cyhtaXhlci0+ZW5naW5l
LnJlZ3MsCisJCQkJCSAgIFNVTjhJX01JWEVSX0JMRU5EX1BJUEVfQ1RMKGJsZF9iYXNlKSwKKwkJ
CQkJICAgU1VOOElfTUlYRVJfQkxFTkRfUElQRV9DVExfRU4ob2xkX3pwb3MpLAorCQkJCQkgICAw
KTsKKwkJfQogCX0KIAotCWlmIChlbmFibGUpIHsKKwkvKgorCSAqIElmIGVuYWJsaW5nIHRoaXMg
bGF5ZXIgb3IgY2hhbmdpbiB6cG9zLCBzZXQgcm91dGUgdG8gdGhpcyBsYXllci4KKwkgKi8KKwlp
ZiAoKGVuYWJsZSAmJiAhd2FzX2VuYWJsZWQpIHx8IChlbmFibGUgJiYgenBvcyAhPSBvbGRfenBv
cykpIHsKKwkJRFJNX0RFQlVHX0RSSVZFUigiY2hhbj0lZCBlbj0lZC0+JWQgenBvcz0lZC0+JWRc
biIsCisJCSAgICAgICBjaGFubmVsLCB3YXNfZW5hYmxlZCwgZW5hYmxlLCBvbGRfenBvcywgenBv
cyk7CisKIAkJdmFsID0gU1VOOElfTUlYRVJfQkxFTkRfUElQRV9DVExfRU4oenBvcyk7CiAKIAkJ
cmVnbWFwX3VwZGF0ZV9iaXRzKG1peGVyLT5lbmdpbmUucmVncywKQEAgLTYzLDYgKzkzLDggQEAg
c3RhdGljIHZvaWQgc3VuOGlfdmlfbGF5ZXJfZW5hYmxlKHN0cnVjdCBzdW44aV9taXhlciAqbWl4
ZXIsIGludCBjaGFubmVsLAogCQkJCSAgIFNVTjhJX01JWEVSX0JMRU5EX1JPVVRFKGJsZF9iYXNl
KSwKIAkJCQkgICBTVU44SV9NSVhFUl9CTEVORF9ST1VURV9QSVBFX01TSyh6cG9zKSwKIAkJCQkg
ICB2YWwpOworCisJCURSTV9ERUJVR19EUklWRVIoIiAgZW5hYmxlIHBpcGUgJWQgPC0gY2ggJWRc
biIsIHpwb3MsIGNoYW5uZWwpOwogCX0KIH0KIApAQCAtMzQ1LDQ1ICszNzcsNDMgQEAgc3RhdGlj
IGludCBzdW44aV92aV9sYXllcl9hdG9taWNfY2hlY2soc3RydWN0IGRybV9wbGFuZSAqcGxhbmUs
CiAJCQkJCQkgICB0cnVlLCB0cnVlKTsKIH0KIAotc3RhdGljIHZvaWQgc3VuOGlfdmlfbGF5ZXJf
YXRvbWljX2Rpc2FibGUoc3RydWN0IGRybV9wbGFuZSAqcGxhbmUsCi0JCQkJCSAgc3RydWN0IGRy
bV9wbGFuZV9zdGF0ZSAqb2xkX3N0YXRlKQorc3RhdGljIHZvaWQgc3VuOGlfdmlfbGF5ZXJfYXRv
bWljX3VwZGF0ZShzdHJ1Y3QgZHJtX3BsYW5lICpwbGFuZSwKKwkJCQkJIHN0cnVjdCBkcm1fcGxh
bmVfc3RhdGUgKm9sZF9zdGF0ZSkKIHsKIAlzdHJ1Y3Qgc3VuOGlfdmlfbGF5ZXIgKmxheWVyID0g
cGxhbmVfdG9fc3VuOGlfdmlfbGF5ZXIocGxhbmUpOworCXVuc2lnbmVkIGludCB6cG9zID0gcGxh
bmUtPnN0YXRlLT5ub3JtYWxpemVkX3pwb3M7CiAJdW5zaWduZWQgaW50IG9sZF96cG9zID0gb2xk
X3N0YXRlLT5ub3JtYWxpemVkX3pwb3M7CiAJc3RydWN0IHN1bjhpX21peGVyICptaXhlciA9IGxh
eWVyLT5taXhlcjsKKwlib29sIHdhc19lbmFibGVkID0gb2xkX3N0YXRlLT5jcnRjICYmIG9sZF9z
dGF0ZS0+dmlzaWJsZTsKKwlib29sIGVuYWJsZSA9IHBsYW5lLT5zdGF0ZS0+Y3J0YyAmJiBwbGFu
ZS0+c3RhdGUtPnZpc2libGU7CiAKLQlzdW44aV92aV9sYXllcl9lbmFibGUobWl4ZXIsIGxheWVy
LT5jaGFubmVsLCBsYXllci0+b3ZlcmxheSwgZmFsc2UsIDAsCi0JCQkgICAgICBvbGRfenBvcyk7
CisJaWYgKGVuYWJsZSkgeworCQlzdW44aV92aV9sYXllcl91cGRhdGVfY29vcmQobWl4ZXIsIGxh
eWVyLT5jaGFubmVsLAorCQkJCQkgICAgbGF5ZXItPm92ZXJsYXksIHBsYW5lLCB6cG9zKTsKKwkJ
c3VuOGlfdmlfbGF5ZXJfdXBkYXRlX2Zvcm1hdHMobWl4ZXIsIGxheWVyLT5jaGFubmVsLAorCQkJ
CQkgICAgICBsYXllci0+b3ZlcmxheSwgcGxhbmUpOworCQlzdW44aV92aV9sYXllcl91cGRhdGVf
YnVmZmVyKG1peGVyLCBsYXllci0+Y2hhbm5lbCwKKwkJCQkJICAgICBsYXllci0+b3ZlcmxheSwg
cGxhbmUpOworCX0KKworCXN1bjhpX3ZpX2xheWVyX2VuYWJsZShtaXhlciwgbGF5ZXItPmNoYW5u
ZWwsIGxheWVyLT5vdmVybGF5LAorCQkJICAgICAgd2FzX2VuYWJsZWQsIGVuYWJsZSwgenBvcywg
b2xkX3pwb3MpOwogfQogCi1zdGF0aWMgdm9pZCBzdW44aV92aV9sYXllcl9hdG9taWNfdXBkYXRl
KHN0cnVjdCBkcm1fcGxhbmUgKnBsYW5lLAotCQkJCQkgc3RydWN0IGRybV9wbGFuZV9zdGF0ZSAq
b2xkX3N0YXRlKQordm9pZCBzdW44aV92aV9sYXllcl9wbGFuZV9yZXNldChzdHJ1Y3QgZHJtX3Bs
YW5lICpwbGFuZSkKIHsKIAlzdHJ1Y3Qgc3VuOGlfdmlfbGF5ZXIgKmxheWVyID0gcGxhbmVfdG9f
c3VuOGlfdmlfbGF5ZXIocGxhbmUpOwotCXVuc2lnbmVkIGludCB6cG9zID0gcGxhbmUtPnN0YXRl
LT5ub3JtYWxpemVkX3pwb3M7Ci0JdW5zaWduZWQgaW50IG9sZF96cG9zID0gb2xkX3N0YXRlLT5u
b3JtYWxpemVkX3pwb3M7Ci0Jc3RydWN0IHN1bjhpX21peGVyICptaXhlciA9IGxheWVyLT5taXhl
cjsKIAotCWlmICghcGxhbmUtPnN0YXRlLT52aXNpYmxlKSB7Ci0JCXN1bjhpX3ZpX2xheWVyX2Vu
YWJsZShtaXhlciwgbGF5ZXItPmNoYW5uZWwsCi0JCQkJICAgICAgbGF5ZXItPm92ZXJsYXksIGZh
bHNlLCAwLCBvbGRfenBvcyk7CisJZHJtX2F0b21pY19oZWxwZXJfcGxhbmVfcmVzZXQocGxhbmUp
OworCWlmICghcGxhbmUtPnN0YXRlKQogCQlyZXR1cm47Ci0JfQogCi0Jc3VuOGlfdmlfbGF5ZXJf
dXBkYXRlX2Nvb3JkKG1peGVyLCBsYXllci0+Y2hhbm5lbCwKLQkJCQkgICAgbGF5ZXItPm92ZXJs
YXksIHBsYW5lLCB6cG9zKTsKLQlzdW44aV92aV9sYXllcl91cGRhdGVfZm9ybWF0cyhtaXhlciwg
bGF5ZXItPmNoYW5uZWwsCi0JCQkJICAgICAgbGF5ZXItPm92ZXJsYXksIHBsYW5lKTsKLQlzdW44
aV92aV9sYXllcl91cGRhdGVfYnVmZmVyKG1peGVyLCBsYXllci0+Y2hhbm5lbCwKLQkJCQkgICAg
IGxheWVyLT5vdmVybGF5LCBwbGFuZSk7Ci0Jc3VuOGlfdmlfbGF5ZXJfZW5hYmxlKG1peGVyLCBs
YXllci0+Y2hhbm5lbCwgbGF5ZXItPm92ZXJsYXksCi0JCQkgICAgICB0cnVlLCB6cG9zLCBvbGRf
enBvcyk7CisJcGxhbmUtPnN0YXRlLT56cG9zID0gbGF5ZXItPmNoYW5uZWw7CiB9CiAKIHN0YXRp
YyBzdHJ1Y3QgZHJtX3BsYW5lX2hlbHBlcl9mdW5jcyBzdW44aV92aV9sYXllcl9oZWxwZXJfZnVu
Y3MgPSB7CiAJLnByZXBhcmVfZmIJPSBkcm1fZ2VtX2ZiX3ByZXBhcmVfZmIsCiAJLmF0b21pY19j
aGVjawk9IHN1bjhpX3ZpX2xheWVyX2F0b21pY19jaGVjaywKLQkuYXRvbWljX2Rpc2FibGUJPSBz
dW44aV92aV9sYXllcl9hdG9taWNfZGlzYWJsZSwKIAkuYXRvbWljX3VwZGF0ZQk9IHN1bjhpX3Zp
X2xheWVyX2F0b21pY191cGRhdGUsCiB9OwogCkBAIC0zOTIsNyArNDIyLDcgQEAgc3RhdGljIGNv
bnN0IHN0cnVjdCBkcm1fcGxhbmVfZnVuY3Mgc3VuOGlfdmlfbGF5ZXJfZnVuY3MgPSB7CiAJLmF0
b21pY19kdXBsaWNhdGVfc3RhdGUJPSBkcm1fYXRvbWljX2hlbHBlcl9wbGFuZV9kdXBsaWNhdGVf
c3RhdGUsCiAJLmRlc3Ryb3kJCT0gZHJtX3BsYW5lX2NsZWFudXAsCiAJLmRpc2FibGVfcGxhbmUJ
CT0gZHJtX2F0b21pY19oZWxwZXJfZGlzYWJsZV9wbGFuZSwKLQkucmVzZXQJCQk9IGRybV9hdG9t
aWNfaGVscGVyX3BsYW5lX3Jlc2V0LAorCS5yZXNldAkJCT0gc3VuOGlfdmlfbGF5ZXJfcGxhbmVf
cmVzZXQsCiAJLnVwZGF0ZV9wbGFuZQkJPSBkcm1fYXRvbWljX2hlbHBlcl91cGRhdGVfcGxhbmUs
CiB9OwogCi0tIAoyLjIzLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNr
dG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2Ry
aS1kZXZlbA==
