Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 5F0067F817
	for <lists+dri-devel@lfdr.de>; Fri,  2 Aug 2019 15:12:56 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 55AC06EE1E;
	Fri,  2 Aug 2019 13:12:40 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 49D116EE1B
 for <dri-devel@lists.freedesktop.org>; Fri,  2 Aug 2019 13:12:37 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx02.intmail.prod.int.phx2.redhat.com
 [10.5.11.12])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 8C899308449C;
 Fri,  2 Aug 2019 13:12:36 +0000 (UTC)
Received: from sirius.home.kraxel.org (ovpn-116-81.ams2.redhat.com
 [10.36.116.81])
 by smtp.corp.redhat.com (Postfix) with ESMTP id D176160C4C;
 Fri,  2 Aug 2019 13:12:30 +0000 (UTC)
Received: by sirius.home.kraxel.org (Postfix, from userid 1000)
 id 487A59D12; Fri,  2 Aug 2019 15:12:27 +0200 (CEST)
From: Gerd Hoffmann <kraxel@redhat.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v7 10/18] drm/virtio: rework
 virtio_gpu_transfer_from_host_ioctl fencing
Date: Fri,  2 Aug 2019 15:12:17 +0200
Message-Id: <20190802131225.17760-11-kraxel@redhat.com>
In-Reply-To: <20190802131225.17760-1-kraxel@redhat.com>
References: <20190802131225.17760-1-kraxel@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.12
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.40]); Fri, 02 Aug 2019 13:12:36 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: David Airlie <airlied@linux.ie>, open list <linux-kernel@vger.kernel.org>,
 "open list:VIRTIO GPU DRIVER" <virtualization@lists.linux-foundation.org>,
 Gerd Hoffmann <kraxel@redhat.com>, gurchetansingh@chromium.org
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U3dpdGNoIHRvIHRoZSB2aXJ0aW9fZ3B1X2FycmF5XyogaGVscGVyIHdvcmtmbG93LgoKU2lnbmVk
LW9mZi1ieTogR2VyZCBIb2ZmbWFubiA8a3JheGVsQHJlZGhhdC5jb20+Ci0tLQogZHJpdmVycy9n
cHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2Rydi5oICAgfCAgMyArLQogZHJpdmVycy9ncHUvZHJtL3Zp
cnRpby92aXJ0Z3B1X2lvY3RsLmMgfCA0MCArKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLQogZHJp
dmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X3ZxLmMgICAgfCAgOCArKysrLS0KIDMgZmlsZXMg
Y2hhbmdlZCwgMjMgaW5zZXJ0aW9ucygrKSwgMjggZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2Rydi5oIGIvZHJpdmVycy9ncHUvZHJtL3Zp
cnRpby92aXJ0Z3B1X2Rydi5oCmluZGV4IGU1ZDg1YzEwNGJkMS4uMDZiZTkyMDFjMjRkIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfZHJ2LmgKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X2Rydi5oCkBAIC0zMjMsOSArMzIzLDEwIEBAIHZvaWQg
dmlydGlvX2dwdV9jbWRfc3VibWl0KHN0cnVjdCB2aXJ0aW9fZ3B1X2RldmljZSAqdmdkZXYsCiAJ
CQkgICBzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3RfYXJyYXkgKm9ianMsCiAJCQkgICBzdHJ1Y3Qg
dmlydGlvX2dwdV9mZW5jZSAqZmVuY2UpOwogdm9pZCB2aXJ0aW9fZ3B1X2NtZF90cmFuc2Zlcl9m
cm9tX2hvc3RfM2Qoc3RydWN0IHZpcnRpb19ncHVfZGV2aWNlICp2Z2RldiwKLQkJCQkJICB1aW50
MzJfdCByZXNvdXJjZV9pZCwgdWludDMyX3QgY3R4X2lkLAorCQkJCQkgIHVpbnQzMl90IGN0eF9p
ZCwKIAkJCQkJICB1aW50NjRfdCBvZmZzZXQsIHVpbnQzMl90IGxldmVsLAogCQkJCQkgIHN0cnVj
dCB2aXJ0aW9fZ3B1X2JveCAqYm94LAorCQkJCQkgIHN0cnVjdCB2aXJ0aW9fZ3B1X29iamVjdF9h
cnJheSAqb2JqcywKIAkJCQkJICBzdHJ1Y3QgdmlydGlvX2dwdV9mZW5jZSAqZmVuY2UpOwogdm9p
ZCB2aXJ0aW9fZ3B1X2NtZF90cmFuc2Zlcl90b19ob3N0XzNkKHN0cnVjdCB2aXJ0aW9fZ3B1X2Rl
dmljZSAqdmdkZXYsCiAJCQkJCXN0cnVjdCB2aXJ0aW9fZ3B1X29iamVjdCAqYm8sCmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfaW9jdGwuYyBiL2RyaXZlcnMvZ3B1
L2RybS92aXJ0aW8vdmlydGdwdV9pb2N0bC5jCmluZGV4IGEzZTM1N2Y3NTA5OS4uZWZjYTdmODMx
ODM0IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfaW9jdGwuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVfaW9jdGwuYwpAQCAtMzQwLDkgKzM0
MCw3IEBAIHN0YXRpYyBpbnQgdmlydGlvX2dwdV90cmFuc2Zlcl9mcm9tX2hvc3RfaW9jdGwoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldiwKIAlzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2ID0g
ZGV2LT5kZXZfcHJpdmF0ZTsKIAlzdHJ1Y3QgdmlydGlvX2dwdV9mcHJpdiAqdmZwcml2ID0gZmls
ZS0+ZHJpdmVyX3ByaXY7CiAJc3RydWN0IGRybV92aXJ0Z3B1XzNkX3RyYW5zZmVyX2Zyb21faG9z
dCAqYXJncyA9IGRhdGE7Ci0Jc3RydWN0IHR0bV9vcGVyYXRpb25fY3R4IGN0eCA9IHsgdHJ1ZSwg
ZmFsc2UgfTsKLQlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKmdvYmogPSBOVUxMOwotCXN0cnVjdCB2
aXJ0aW9fZ3B1X29iamVjdCAqcW9iaiA9IE5VTEw7CisJc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0
X2FycmF5ICpvYmpzOwogCXN0cnVjdCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZTsKIAlpbnQgcmV0
OwogCXUzMiBvZmZzZXQgPSBhcmdzLT5vZmZzZXQ7CkBAIC0zNTEsMzkgKzM0OSwzMSBAQCBzdGF0
aWMgaW50IHZpcnRpb19ncHVfdHJhbnNmZXJfZnJvbV9ob3N0X2lvY3RsKHN0cnVjdCBkcm1fZGV2
aWNlICpkZXYsCiAJaWYgKHZnZGV2LT5oYXNfdmlyZ2xfM2QgPT0gZmFsc2UpCiAJCXJldHVybiAt
RU5PU1lTOwogCi0JZ29iaiA9IGRybV9nZW1fb2JqZWN0X2xvb2t1cChmaWxlLCBhcmdzLT5ib19o
YW5kbGUpOwotCWlmIChnb2JqID09IE5VTEwpCisJb2JqcyA9IHZpcnRpb19ncHVfYXJyYXlfZnJv
bV9oYW5kbGVzKGZpbGUsICZhcmdzLT5ib19oYW5kbGUsIDEpOworCWlmIChvYmpzID09IE5VTEwp
CiAJCXJldHVybiAtRU5PRU5UOwogCi0JcW9iaiA9IGdlbV90b192aXJ0aW9fZ3B1X29iaihnb2Jq
KTsKLQotCXJldCA9IHZpcnRpb19ncHVfb2JqZWN0X3Jlc2VydmUocW9iaik7Ci0JaWYgKHJldCkK
LQkJZ290byBvdXQ7Ci0KLQlyZXQgPSB0dG1fYm9fdmFsaWRhdGUoJnFvYmotPnRibywgJnFvYmot
PnBsYWNlbWVudCwgJmN0eCk7Ci0JaWYgKHVubGlrZWx5KHJldCkpCi0JCWdvdG8gb3V0X3VucmVz
OworCXJldCA9IHZpcnRpb19ncHVfYXJyYXlfbG9ja19yZXN2KG9ianMpOworCWlmIChyZXQgIT0g
MCkKKwkJZ290byBlcnJfcHV0X2ZyZWU7CiAKIAljb252ZXJ0X3RvX2h3X2JveCgmYm94LCAmYXJn
cy0+Ym94KTsKIAogCWZlbmNlID0gdmlydGlvX2dwdV9mZW5jZV9hbGxvYyh2Z2Rldik7CiAJaWYg
KCFmZW5jZSkgewogCQlyZXQgPSAtRU5PTUVNOwotCQlnb3RvIG91dF91bnJlczsKKwkJZ290byBl
cnJfdW5sb2NrOwogCX0KIAl2aXJ0aW9fZ3B1X2NtZF90cmFuc2Zlcl9mcm9tX2hvc3RfM2QKLQkJ
KHZnZGV2LCBxb2JqLT5od19yZXNfaGFuZGxlLAotCQkgdmZwcml2LT5jdHhfaWQsIG9mZnNldCwg
YXJncy0+bGV2ZWwsCi0JCSAmYm94LCBmZW5jZSk7Ci0JcmVzZXJ2YXRpb25fb2JqZWN0X2FkZF9l
eGNsX2ZlbmNlKHFvYmotPnRiby5yZXN2LAotCQkJCQkgICZmZW5jZS0+Zik7Ci0KKwkJKHZnZGV2
LCB2ZnByaXYtPmN0eF9pZCwgb2Zmc2V0LCBhcmdzLT5sZXZlbCwKKwkJICZib3gsIG9ianMsIGZl
bmNlKTsKIAlkbWFfZmVuY2VfcHV0KCZmZW5jZS0+Zik7Ci1vdXRfdW5yZXM6Ci0JdmlydGlvX2dw
dV9vYmplY3RfdW5yZXNlcnZlKHFvYmopOwotb3V0OgotCWRybV9nZW1fb2JqZWN0X3B1dF91bmxv
Y2tlZChnb2JqKTsKKwlyZXR1cm4gMDsKKworZXJyX3VubG9jazoKKwl2aXJ0aW9fZ3B1X2FycmF5
X3VubG9ja19yZXN2KG9ianMpOworZXJyX3B1dF9mcmVlOgorCXZpcnRpb19ncHVfYXJyYXlfcHV0
X2ZyZWUob2Jqcyk7CiAJcmV0dXJuIHJldDsKIH0KIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL3ZpcnRpby92aXJ0Z3B1X3ZxLmMgYi9kcml2ZXJzL2dwdS9kcm0vdmlydGlvL3ZpcnRncHVf
dnEuYwppbmRleCAwNzk5MDdlOGE1OTYuLjU5ZDMyNzg3OTQ0ZCAxMDA2NDQKLS0tIGEvZHJpdmVy
cy9ncHUvZHJtL3ZpcnRpby92aXJ0Z3B1X3ZxLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3ZpcnRp
by92aXJ0Z3B1X3ZxLmMKQEAgLTkyOSwyMCArOTI5LDI0IEBAIHZvaWQgdmlydGlvX2dwdV9jbWRf
dHJhbnNmZXJfdG9faG9zdF8zZChzdHJ1Y3QgdmlydGlvX2dwdV9kZXZpY2UgKnZnZGV2LAogfQog
CiB2b2lkIHZpcnRpb19ncHVfY21kX3RyYW5zZmVyX2Zyb21faG9zdF8zZChzdHJ1Y3QgdmlydGlv
X2dwdV9kZXZpY2UgKnZnZGV2LAotCQkJCQkgIHVpbnQzMl90IHJlc291cmNlX2lkLCB1aW50MzJf
dCBjdHhfaWQsCisJCQkJCSAgdWludDMyX3QgY3R4X2lkLAogCQkJCQkgIHVpbnQ2NF90IG9mZnNl
dCwgdWludDMyX3QgbGV2ZWwsCiAJCQkJCSAgc3RydWN0IHZpcnRpb19ncHVfYm94ICpib3gsCisJ
CQkJCSAgc3RydWN0IHZpcnRpb19ncHVfb2JqZWN0X2FycmF5ICpvYmpzLAogCQkJCQkgIHN0cnVj
dCB2aXJ0aW9fZ3B1X2ZlbmNlICpmZW5jZSkKIHsKKwlzdHJ1Y3QgdmlydGlvX2dwdV9vYmplY3Qg
KmJvID0gZ2VtX3RvX3ZpcnRpb19ncHVfb2JqKG9ianMtPm9ianNbMF0pOwogCXN0cnVjdCB2aXJ0
aW9fZ3B1X3RyYW5zZmVyX2hvc3RfM2QgKmNtZF9wOwogCXN0cnVjdCB2aXJ0aW9fZ3B1X3ZidWZm
ZXIgKnZidWY7CiAKIAljbWRfcCA9IHZpcnRpb19ncHVfYWxsb2NfY21kKHZnZGV2LCAmdmJ1Ziwg
c2l6ZW9mKCpjbWRfcCkpOwogCW1lbXNldChjbWRfcCwgMCwgc2l6ZW9mKCpjbWRfcCkpOwogCisJ
dmJ1Zi0+b2JqcyA9IG9ianM7CisKIAljbWRfcC0+aGRyLnR5cGUgPSBjcHVfdG9fbGUzMihWSVJU
SU9fR1BVX0NNRF9UUkFOU0ZFUl9GUk9NX0hPU1RfM0QpOwogCWNtZF9wLT5oZHIuY3R4X2lkID0g
Y3B1X3RvX2xlMzIoY3R4X2lkKTsKLQljbWRfcC0+cmVzb3VyY2VfaWQgPSBjcHVfdG9fbGUzMihy
ZXNvdXJjZV9pZCk7CisJY21kX3AtPnJlc291cmNlX2lkID0gY3B1X3RvX2xlMzIoYm8tPmh3X3Jl
c19oYW5kbGUpOwogCWNtZF9wLT5ib3ggPSAqYm94OwogCWNtZF9wLT5vZmZzZXQgPSBjcHVfdG9f
bGU2NChvZmZzZXQpOwogCWNtZF9wLT5sZXZlbCA9IGNwdV90b19sZTMyKGxldmVsKTsKLS0gCjIu
MTguMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJp
LWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBz
Oi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
