Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 198259D2AB
	for <lists+dri-devel@lfdr.de>; Mon, 26 Aug 2019 17:27:19 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E2B736E233;
	Mon, 26 Aug 2019 15:27:12 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from bhuna.collabora.co.uk (bhuna.collabora.co.uk [46.235.227.227])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 29ABC6E235
 for <dri-devel@lists.freedesktop.org>; Mon, 26 Aug 2019 15:27:02 +0000 (UTC)
Received: from localhost.localdomain (unknown
 [IPv6:2a01:e0a:2c:6930:5cf4:84a1:2763:fe0d])
 (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
 (No client certificate requested) (Authenticated sender: bbrezillon)
 by bhuna.collabora.co.uk (Postfix) with ESMTPSA id 688C628BF39;
 Mon, 26 Aug 2019 16:27:00 +0100 (BST)
From: Boris Brezillon <boris.brezillon@collabora.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v2 10/21] drm/bridge: Make the bridge chain a double-linked
 list
Date: Mon, 26 Aug 2019 17:26:38 +0200
Message-Id: <20190826152649.13820-11-boris.brezillon@collabora.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190826152649.13820-1-boris.brezillon@collabora.com>
References: <20190826152649.13820-1-boris.brezillon@collabora.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Nikita Yushchenko <nikita.yoush@cogentembedded.com>,
 Jernej Skrabec <jernej.skrabec@siol.net>,
 Laurent Pinchart <Laurent.pinchart@ideasonboard.com>,
 Neil Armstrong <narmstrong@baylibre.com>,
 Andrey Smirnov <andrew.smirnov@gmail.com>, Jonas Karlman <jonas@kwiboo.se>,
 Seung-Woo Kim <sw0312.kim@samsung.com>,
 Kyungmin Park <kyungmin.park@samsung.com>,
 Thierry Reding <thierry.reding@gmail.com>, Chris Healy <Chris.Healy@zii.aero>,
 Boris Brezillon <boris.brezillon@collabora.com>, kernel@collabora.com,
 Sam Ravnborg <sam@ravnborg.org>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U28gdGhhdCBlYWNoIGVsZW1lbnQgaW4gdGhlIGNoYWluIGNhbiBlYXNpbHkgYWNjZXNzIGl0cyBw
cmVkZWNlc3Nvci4KVGhpcyB3aWxsIGJlIG5lZWRlZCB0byBzdXBwb3J0IGJ1cyBmb3JtYXQgbmVn
b3RpYXRpb24gYmV0d2VlbiBlbGVtZW50cwpvZiB0aGUgYnJpZGdlIGNoYWluLgoKU2lnbmVkLW9m
Zi1ieTogQm9yaXMgQnJlemlsbG9uIDxib3Jpcy5icmV6aWxsb25AY29sbGFib3JhLmNvbT4KLS0t
CkNoYW5nZXMgaW4gdjI6CiogQWRqdXN0IHRoaW5ncyB0byB0aGUgImR1bW15IGVuY29kZXIgYnJp
ZGdlIiBjaGFuZ2UgKHBhdGNoIDIgaW4gdGhpcwogIHNlcmllcykKLS0tCiBkcml2ZXJzL2dwdS9k
cm0vZHJtX2JyaWRnZS5jICB8IDE3NyArKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0t
CiBkcml2ZXJzL2dwdS9kcm0vZHJtX2VuY29kZXIuYyB8ICAgNiArLQogaW5jbHVkZS9kcm0vZHJt
X2JyaWRnZS5oICAgICAgfCAgIDQgKy0KIGluY2x1ZGUvZHJtL2RybV9lbmNvZGVyLmggICAgIHwg
ICA3ICsrCiA0IGZpbGVzIGNoYW5nZWQsIDEwNyBpbnNlcnRpb25zKCspLCA4NyBkZWxldGlvbnMo
LSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2JyaWRnZS5jIGIvZHJpdmVycy9n
cHUvZHJtL2RybV9icmlkZ2UuYwppbmRleCAzZDlhNmM2YTdkNGUuLjY5NWFkNjdkMzNhNSAxMDA2
NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2RybV9icmlkZ2UuYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vZHJtX2JyaWRnZS5jCkBAIC01NSw3ICs1NSw3IEBACiAgKiBqdXN0IHByb3ZpZGUgYWRkaXRp
b25hbCBob29rcyB0byBnZXQgdGhlIGRlc2lyZWQgb3V0cHV0IGF0IHRoZSBlbmQgb2YgdGhlCiAg
KiBlbmNvZGVyIGNoYWluLgogICoKLSAqIEJyaWRnZXMgY2FuIGFsc28gYmUgY2hhaW5lZCB1cCB1
c2luZyB0aGUgJmRybV9icmlkZ2UubmV4dCBwb2ludGVyLgorICogQnJpZGdlcyBjYW4gYWxzbyBi
ZSBjaGFpbmVkIHVwIHVzaW5nIHRoZSAmZHJtX2JyaWRnZS5jaGFpbl9ub2RlIGZpZWxkLgogICoK
ICAqIEJvdGggbGVnYWN5IENSVEMgaGVscGVycyBhbmQgdGhlIG5ldyBhdG9taWMgbW9kZXNldCBo
ZWxwZXJzIHN1cHBvcnQgYnJpZGdlcy4KICAqLwpAQCAtMTE0LDYgKzExNCw3IEBAIEVYUE9SVF9T
WU1CT0woZHJtX2JyaWRnZV9yZW1vdmUpOwogaW50IGRybV9icmlkZ2VfYXR0YWNoKHN0cnVjdCBk
cm1fZW5jb2RlciAqZW5jb2Rlciwgc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKIAkJICAgICAg
c3RydWN0IGRybV9icmlkZ2UgKnByZXZpb3VzKQogeworCUxJU1RfSEVBRCh0bXBfbGlzdCk7CiAJ
aW50IHJldDsKIAogCWlmICghZW5jb2RlciB8fCAhYnJpZGdlKQpAQCAtMTI3LDYgKzEyOCw3IEBA
IGludCBkcm1fYnJpZGdlX2F0dGFjaChzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29kZXIsIHN0cnVj
dCBkcm1fYnJpZGdlICpicmlkZ2UsCiAKIAlicmlkZ2UtPmRldiA9IGVuY29kZXItPmRldjsKIAli
cmlkZ2UtPmVuY29kZXIgPSBlbmNvZGVyOworCWxpc3RfYWRkX3RhaWwoJmJyaWRnZS0+Y2hhaW5f
bm9kZSwgJnRtcF9saXN0KTsKIAogCWlmIChicmlkZ2UtPmZ1bmNzLT5hdHRhY2gpIHsKIAkJcmV0
ID0gYnJpZGdlLT5mdW5jcy0+YXR0YWNoKGJyaWRnZSk7CkBAIC0xMzcsMTAgKzEzOSwxMiBAQCBp
bnQgZHJtX2JyaWRnZV9hdHRhY2goc3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVyLCBzdHJ1Y3Qg
ZHJtX2JyaWRnZSAqYnJpZGdlLAogCQl9CiAJfQogCi0JaWYgKHByZXZpb3VzKQotCQlwcmV2aW91
cy0+bmV4dCA9IGJyaWRnZTsKLQllbHNlIGlmIChicmlkZ2UgIT0gJmVuY29kZXItPmJyaWRnZSkK
LQkJZW5jb2Rlci0+YnJpZGdlLm5leHQgPSBicmlkZ2U7CisJaWYgKGJyaWRnZSA9PSAmZW5jb2Rl
ci0+YnJpZGdlKQorCQlsaXN0X3NwbGljZSgmdG1wX2xpc3QsICZlbmNvZGVyLT5icmlkZ2VfY2hh
aW4pOworCWVsc2UgaWYgKCFwcmV2aW91cykKKwkJbGlzdF9zcGxpY2UoJnRtcF9saXN0LCAmZW5j
b2Rlci0+YnJpZGdlLmNoYWluX25vZGUpOworCWVsc2UKKwkJbGlzdF9zcGxpY2UoJnRtcF9saXN0
LCAmcHJldmlvdXMtPmNoYWluX25vZGUpOwogCiAJcmV0dXJuIDA7CiB9CkBAIC0xNTcsNiArMTYx
LDcgQEAgdm9pZCBkcm1fYnJpZGdlX2RldGFjaChzdHJ1Y3QgZHJtX2JyaWRnZSAqYnJpZGdlKQog
CWlmIChicmlkZ2UtPmZ1bmNzLT5kZXRhY2gpCiAJCWJyaWRnZS0+ZnVuY3MtPmRldGFjaChicmlk
Z2UpOwogCisJbGlzdF9kZWwoJmJyaWRnZS0+Y2hhaW5fbm9kZSk7CiAJYnJpZGdlLT5kZXYgPSBO
VUxMOwogfQogCkBAIC0xNzAsNyArMTc1LDEwIEBAIHZvaWQgZHJtX2JyaWRnZV9kZXRhY2goc3Ry
dWN0IGRybV9icmlkZ2UgKmJyaWRnZSkKIHN0cnVjdCBkcm1fYnJpZGdlICoKIGRybV9icmlkZ2Vf
Y2hhaW5fZ2V0X25leHRfYnJpZGdlKHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UpCiB7Ci0JcmV0
dXJuIGJyaWRnZS0+bmV4dDsKKwlpZiAobGlzdF9pc19sYXN0KCZicmlkZ2UtPmNoYWluX25vZGUs
ICZicmlkZ2UtPmVuY29kZXItPmJyaWRnZV9jaGFpbikpCisJCXJldHVybiBOVUxMOworCisJcmV0
dXJuIGxpc3RfbmV4dF9lbnRyeShicmlkZ2UsIGNoYWluX25vZGUpOwogfQogRVhQT1JUX1NZTUJP
TChkcm1fYnJpZGdlX2NoYWluX2dldF9uZXh0X2JyaWRnZSk7CiAKQEAgLTIwNCwxOCArMjEyLDE3
IEBAIGJvb2wgZHJtX2JyaWRnZV9jaGFpbl9tb2RlX2ZpeHVwKHN0cnVjdCBkcm1fYnJpZGdlICpi
cmlkZ2UsCiAJCQkJIGNvbnN0IHN0cnVjdCBkcm1fZGlzcGxheV9tb2RlICptb2RlLAogCQkJCSBz
dHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqYWRqdXN0ZWRfbW9kZSkKIHsKLQlib29sIHJldCA9IHRy
dWU7CisJc3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVyID0gYnJpZGdlLT5lbmNvZGVyOwogCi0J
aWYgKCFicmlkZ2UpCi0JCXJldHVybiB0cnVlOworCWxpc3RfZm9yX2VhY2hfZW50cnlfZnJvbShi
cmlkZ2UsICZlbmNvZGVyLT5icmlkZ2VfY2hhaW4sIGNoYWluX25vZGUpIHsKKwkJaWYgKCFicmlk
Z2UtPmZ1bmNzLT5tb2RlX2ZpeHVwKQorCQkJY29udGludWU7CiAKLQlpZiAoYnJpZGdlLT5mdW5j
cy0+bW9kZV9maXh1cCkKLQkJcmV0ID0gYnJpZGdlLT5mdW5jcy0+bW9kZV9maXh1cChicmlkZ2Us
IG1vZGUsIGFkanVzdGVkX21vZGUpOworCQlpZiAoIWJyaWRnZS0+ZnVuY3MtPm1vZGVfZml4dXAo
YnJpZGdlLCBtb2RlLCBhZGp1c3RlZF9tb2RlKSkKKwkJCXJldHVybiBmYWxzZTsKKwl9CiAKLQly
ZXQgPSByZXQgJiYgZHJtX2JyaWRnZV9jaGFpbl9tb2RlX2ZpeHVwKGJyaWRnZS0+bmV4dCwgbW9k
ZSwKLQkJCQkJCSBhZGp1c3RlZF9tb2RlKTsKLQotCXJldHVybiByZXQ7CisJcmV0dXJuIHRydWU7
CiB9CiBFWFBPUlRfU1lNQk9MKGRybV9icmlkZ2VfY2hhaW5fbW9kZV9maXh1cCk7CiAKQEAgLTIz
OCwxOCArMjQ1LDIwIEBAIGVudW0gZHJtX21vZGVfc3RhdHVzCiBkcm1fYnJpZGdlX2NoYWluX21v
ZGVfdmFsaWQoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKIAkJCSAgICBjb25zdCBzdHJ1Y3Qg
ZHJtX2Rpc3BsYXlfbW9kZSAqbW9kZSkKIHsKLQllbnVtIGRybV9tb2RlX3N0YXR1cyByZXQgPSBN
T0RFX09LOworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlciA9IGJyaWRnZS0+ZW5jb2RlcjsK
IAotCWlmICghYnJpZGdlKQotCQlyZXR1cm4gcmV0OworCWxpc3RfZm9yX2VhY2hfZW50cnlfZnJv
bShicmlkZ2UsICZlbmNvZGVyLT5icmlkZ2VfY2hhaW4sIGNoYWluX25vZGUpIHsKKwkJZW51bSBk
cm1fbW9kZV9zdGF0dXMgcmV0OworCisJCWlmICghYnJpZGdlLT5mdW5jcy0+bW9kZV92YWxpZCkK
KwkJCWNvbnRpbnVlOwogCi0JaWYgKGJyaWRnZS0+ZnVuY3MtPm1vZGVfdmFsaWQpCiAJCXJldCA9
IGJyaWRnZS0+ZnVuY3MtPm1vZGVfdmFsaWQoYnJpZGdlLCBtb2RlKTsKKwkJaWYgKHJldCAhPSBN
T0RFX09LKQorCQkJcmV0dXJuIHJldDsKKwl9CiAKLQlpZiAocmV0ICE9IE1PREVfT0spCi0JCXJl
dHVybiByZXQ7Ci0KLQlyZXR1cm4gZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3ZhbGlkKGJyaWRnZS0+
bmV4dCwgbW9kZSk7CisJcmV0dXJuIE1PREVfT0s7CiB9CiBFWFBPUlRfU1lNQk9MKGRybV9icmlk
Z2VfY2hhaW5fbW9kZV92YWxpZCk7CiAKQEAgLTI2NSwxMyArMjc0LDE2IEBAIEVYUE9SVF9TWU1C
T0woZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3ZhbGlkKTsKICAqLwogdm9pZCBkcm1fYnJpZGdlX2No
YWluX2Rpc2FibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSkKIHsKLQlpZiAoIWJyaWRnZSkK
LQkJcmV0dXJuOworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlciA9IGJyaWRnZS0+ZW5jb2Rl
cjsKKwlzdHJ1Y3QgZHJtX2JyaWRnZSAqaXRlcjsKIAotCWRybV9icmlkZ2VfY2hhaW5fZGlzYWJs
ZShicmlkZ2UtPm5leHQpOworCWxpc3RfZm9yX2VhY2hfZW50cnlfcmV2ZXJzZShpdGVyLCAmZW5j
b2Rlci0+YnJpZGdlX2NoYWluLCBjaGFpbl9ub2RlKSB7CisJCWlmIChpdGVyLT5mdW5jcy0+ZGlz
YWJsZSkKKwkJCWl0ZXItPmZ1bmNzLT5kaXNhYmxlKGl0ZXIpOwogCi0JaWYgKGJyaWRnZS0+ZnVu
Y3MtPmRpc2FibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPmRpc2FibGUoYnJpZGdlKTsKKwkJaWYgKGl0
ZXIgPT0gYnJpZGdlKQorCQkJYnJlYWs7CisJfQogfQogRVhQT1JUX1NZTUJPTChkcm1fYnJpZGdl
X2NoYWluX2Rpc2FibGUpOwogCkBAIC0yODgsMTMgKzMwMCwxMiBAQCBFWFBPUlRfU1lNQk9MKGRy
bV9icmlkZ2VfY2hhaW5fZGlzYWJsZSk7CiAgKi8KIHZvaWQgZHJtX2JyaWRnZV9jaGFpbl9wb3N0
X2Rpc2FibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSkKIHsKLQlpZiAoIWJyaWRnZSkKLQkJ
cmV0dXJuOworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlciA9IGJyaWRnZS0+ZW5jb2RlcjsK
IAotCWlmIChicmlkZ2UtPmZ1bmNzLT5wb3N0X2Rpc2FibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPnBv
c3RfZGlzYWJsZShicmlkZ2UpOwotCi0JZHJtX2JyaWRnZV9jaGFpbl9wb3N0X2Rpc2FibGUoYnJp
ZGdlLT5uZXh0KTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X2Zyb20oYnJpZGdlLCAmZW5jb2Rlci0+
YnJpZGdlX2NoYWluLCBjaGFpbl9ub2RlKSB7CisJCWlmIChicmlkZ2UtPmZ1bmNzLT5wb3N0X2Rp
c2FibGUpCisJCQlicmlkZ2UtPmZ1bmNzLT5wb3N0X2Rpc2FibGUoYnJpZGdlKTsKKwl9CiB9CiBF
WFBPUlRfU1lNQk9MKGRybV9icmlkZ2VfY2hhaW5fcG9zdF9kaXNhYmxlKTsKIApAQCAtMzE0LDEz
ICszMjUsMTIgQEAgdm9pZCBkcm1fYnJpZGdlX2NoYWluX21vZGVfc2V0KHN0cnVjdCBkcm1fYnJp
ZGdlICpicmlkZ2UsCiAJCQkgICAgICAgY29uc3Qgc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKm1v
ZGUsCiAJCQkgICAgICAgY29uc3Qgc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKmFkanVzdGVkX21v
ZGUpCiB7Ci0JaWYgKCFicmlkZ2UpCi0JCXJldHVybjsKKwlzdHJ1Y3QgZHJtX2VuY29kZXIgKmVu
Y29kZXIgPSBicmlkZ2UtPmVuY29kZXI7CiAKLQlpZiAoYnJpZGdlLT5mdW5jcy0+bW9kZV9zZXQp
Ci0JCWJyaWRnZS0+ZnVuY3MtPm1vZGVfc2V0KGJyaWRnZSwgbW9kZSwgYWRqdXN0ZWRfbW9kZSk7
Ci0KLQlkcm1fYnJpZGdlX2NoYWluX21vZGVfc2V0KGJyaWRnZS0+bmV4dCwgbW9kZSwgYWRqdXN0
ZWRfbW9kZSk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9mcm9tKGJyaWRnZSwgJmVuY29kZXItPmJy
aWRnZV9jaGFpbiwgY2hhaW5fbm9kZSkgeworCQlpZiAoYnJpZGdlLT5mdW5jcy0+bW9kZV9zZXQp
CisJCQlicmlkZ2UtPmZ1bmNzLT5tb2RlX3NldChicmlkZ2UsIG1vZGUsIGFkanVzdGVkX21vZGUp
OworCX0KIH0KIEVYUE9SVF9TWU1CT0woZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3NldCk7CiAKQEAg
LTMzNywxMyArMzQ3LDEzIEBAIEVYUE9SVF9TWU1CT0woZHJtX2JyaWRnZV9jaGFpbl9tb2RlX3Nl
dCk7CiAgKi8KIHZvaWQgZHJtX2JyaWRnZV9jaGFpbl9wcmVfZW5hYmxlKHN0cnVjdCBkcm1fYnJp
ZGdlICpicmlkZ2UpCiB7Ci0JaWYgKCFicmlkZ2UpCi0JCXJldHVybjsKKwlzdHJ1Y3QgZHJtX2Vu
Y29kZXIgKmVuY29kZXIgPSBicmlkZ2UtPmVuY29kZXI7CisJc3RydWN0IGRybV9icmlkZ2UgKml0
ZXI7CiAKLQlkcm1fYnJpZGdlX2NoYWluX3ByZV9lbmFibGUoYnJpZGdlLT5uZXh0KTsKLQotCWlm
IChicmlkZ2UtPmZ1bmNzLT5wcmVfZW5hYmxlKQotCQlicmlkZ2UtPmZ1bmNzLT5wcmVfZW5hYmxl
KGJyaWRnZSk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9yZXZlcnNlKGl0ZXIsICZlbmNvZGVyLT5i
cmlkZ2VfY2hhaW4sIGNoYWluX25vZGUpIHsKKwkJaWYgKGl0ZXItPmZ1bmNzLT5wcmVfZW5hYmxl
KQorCQkJaXRlci0+ZnVuY3MtPnByZV9lbmFibGUoaXRlcik7CisJfQogfQogRVhQT1JUX1NZTUJP
TChkcm1fYnJpZGdlX2NoYWluX3ByZV9lbmFibGUpOwogCkBAIC0zNTksMTMgKzM2OSwxMiBAQCBF
WFBPUlRfU1lNQk9MKGRybV9icmlkZ2VfY2hhaW5fcHJlX2VuYWJsZSk7CiAgKi8KIHZvaWQgZHJt
X2JyaWRnZV9jaGFpbl9lbmFibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSkKIHsKLQlpZiAo
IWJyaWRnZSkKLQkJcmV0dXJuOworCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlciA9IGJyaWRn
ZS0+ZW5jb2RlcjsKIAotCWlmIChicmlkZ2UtPmZ1bmNzLT5lbmFibGUpCi0JCWJyaWRnZS0+ZnVu
Y3MtPmVuYWJsZShicmlkZ2UpOwotCi0JZHJtX2JyaWRnZV9jaGFpbl9lbmFibGUoYnJpZGdlLT5u
ZXh0KTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X2Zyb20oYnJpZGdlLCAmZW5jb2Rlci0+YnJpZGdl
X2NoYWluLCBjaGFpbl9ub2RlKSB7CisJCWlmIChicmlkZ2UtPmZ1bmNzLT5lbmFibGUpCisJCQli
cmlkZ2UtPmZ1bmNzLT5lbmFibGUoYnJpZGdlKTsKKwl9CiB9CiBFWFBPUlRfU1lNQk9MKGRybV9i
cmlkZ2VfY2hhaW5fZW5hYmxlKTsKIApAQCAtMzg0LDE1ICszOTMsMTggQEAgRVhQT1JUX1NZTUJP
TChkcm1fYnJpZGdlX2NoYWluX2VuYWJsZSk7CiB2b2lkIGRybV9hdG9taWNfYnJpZGdlX2NoYWlu
X2Rpc2FibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRnZSwKIAkJCQkgICAgIHN0cnVjdCBkcm1f
YXRvbWljX3N0YXRlICpzdGF0ZSkKIHsKLQlpZiAoIWJyaWRnZSkKLQkJcmV0dXJuOworCXN0cnVj
dCBkcm1fZW5jb2RlciAqZW5jb2RlciA9IGJyaWRnZS0+ZW5jb2RlcjsKKwlzdHJ1Y3QgZHJtX2Jy
aWRnZSAqaXRlcjsKIAotCWRybV9hdG9taWNfYnJpZGdlX2NoYWluX2Rpc2FibGUoYnJpZGdlLT5u
ZXh0LCBzdGF0ZSk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeV9yZXZlcnNlKGl0ZXIsICZlbmNvZGVy
LT5icmlkZ2VfY2hhaW4sIGNoYWluX25vZGUpIHsKKwkJaWYgKGl0ZXItPmZ1bmNzLT5hdG9taWNf
ZGlzYWJsZSkKKwkJCWl0ZXItPmZ1bmNzLT5hdG9taWNfZGlzYWJsZShpdGVyLCBzdGF0ZSk7CisJ
CWVsc2UgaWYgKGl0ZXItPmZ1bmNzLT5kaXNhYmxlKQorCQkJaXRlci0+ZnVuY3MtPmRpc2FibGUo
aXRlcik7CiAKLQlpZiAoYnJpZGdlLT5mdW5jcy0+YXRvbWljX2Rpc2FibGUpCi0JCWJyaWRnZS0+
ZnVuY3MtPmF0b21pY19kaXNhYmxlKGJyaWRnZSwgc3RhdGUpOwotCWVsc2UgaWYgKGJyaWRnZS0+
ZnVuY3MtPmRpc2FibGUpCi0JCWJyaWRnZS0+ZnVuY3MtPmRpc2FibGUoYnJpZGdlKTsKKwkJaWYg
KGl0ZXIgPT0gYnJpZGdlKQorCQkJYnJlYWs7CisJfQogfQogRVhQT1JUX1NZTUJPTChkcm1fYXRv
bWljX2JyaWRnZV9jaGFpbl9kaXNhYmxlKTsKIApAQCAtNDEyLDE1ICs0MjQsMTQgQEAgRVhQT1JU
X1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9kaXNhYmxlKTsKIHZvaWQgZHJtX2F0b21p
Y19icmlkZ2VfY2hhaW5fcG9zdF9kaXNhYmxlKHN0cnVjdCBkcm1fYnJpZGdlICpicmlkZ2UsCiAJ
CQkJCSAgc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQogewotCWlmICghYnJpZGdlKQot
CQlyZXR1cm47CisJc3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVyID0gYnJpZGdlLT5lbmNvZGVy
OwogCi0JaWYgKGJyaWRnZS0+ZnVuY3MtPmF0b21pY19wb3N0X2Rpc2FibGUpCi0JCWJyaWRnZS0+
ZnVuY3MtPmF0b21pY19wb3N0X2Rpc2FibGUoYnJpZGdlLCBzdGF0ZSk7Ci0JZWxzZSBpZiAoYnJp
ZGdlLT5mdW5jcy0+cG9zdF9kaXNhYmxlKQotCQlicmlkZ2UtPmZ1bmNzLT5wb3N0X2Rpc2FibGUo
YnJpZGdlKTsKLQotCWRybV9hdG9taWNfYnJpZGdlX2NoYWluX3Bvc3RfZGlzYWJsZShicmlkZ2Ut
Pm5leHQsIHN0YXRlKTsKKwlsaXN0X2Zvcl9lYWNoX2VudHJ5X2Zyb20oYnJpZGdlLCAmZW5jb2Rl
ci0+YnJpZGdlX2NoYWluLCBjaGFpbl9ub2RlKSB7CisJCWlmIChicmlkZ2UtPmZ1bmNzLT5hdG9t
aWNfcG9zdF9kaXNhYmxlKQorCQkJYnJpZGdlLT5mdW5jcy0+YXRvbWljX3Bvc3RfZGlzYWJsZShi
cmlkZ2UsIHN0YXRlKTsKKwkJZWxzZSBpZiAoYnJpZGdlLT5mdW5jcy0+cG9zdF9kaXNhYmxlKQor
CQkJYnJpZGdlLT5mdW5jcy0+cG9zdF9kaXNhYmxlKGJyaWRnZSk7CisJfQogfQogRVhQT1JUX1NZ
TUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9wb3N0X2Rpc2FibGUpOwogCkBAIC00NDAsMTUg
KzQ1MSwxOCBAQCBFWFBPUlRfU1lNQk9MKGRybV9hdG9taWNfYnJpZGdlX2NoYWluX3Bvc3RfZGlz
YWJsZSk7CiB2b2lkIGRybV9hdG9taWNfYnJpZGdlX2NoYWluX3ByZV9lbmFibGUoc3RydWN0IGRy
bV9icmlkZ2UgKmJyaWRnZSwKIAkJCQkJc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQog
ewotCWlmICghYnJpZGdlKQotCQlyZXR1cm47CisJc3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVy
ID0gYnJpZGdlLT5lbmNvZGVyOworCXN0cnVjdCBkcm1fYnJpZGdlICppdGVyOwogCi0JZHJtX2F0
b21pY19icmlkZ2VfY2hhaW5fcHJlX2VuYWJsZShicmlkZ2UtPm5leHQsIHN0YXRlKTsKKwlsaXN0
X2Zvcl9lYWNoX2VudHJ5X3JldmVyc2UoaXRlciwgJmVuY29kZXItPmJyaWRnZV9jaGFpbiwgY2hh
aW5fbm9kZSkgeworCQlpZiAoaXRlci0+ZnVuY3MtPmF0b21pY19wcmVfZW5hYmxlKQorCQkJaXRl
ci0+ZnVuY3MtPmF0b21pY19wcmVfZW5hYmxlKGl0ZXIsIHN0YXRlKTsKKwkJZWxzZSBpZiAoaXRl
ci0+ZnVuY3MtPnByZV9lbmFibGUpCisJCQlpdGVyLT5mdW5jcy0+cHJlX2VuYWJsZShpdGVyKTsK
IAotCWlmIChicmlkZ2UtPmZ1bmNzLT5hdG9taWNfcHJlX2VuYWJsZSkKLQkJYnJpZGdlLT5mdW5j
cy0+YXRvbWljX3ByZV9lbmFibGUoYnJpZGdlLCBzdGF0ZSk7Ci0JZWxzZSBpZiAoYnJpZGdlLT5m
dW5jcy0+cHJlX2VuYWJsZSkKLQkJYnJpZGdlLT5mdW5jcy0+cHJlX2VuYWJsZShicmlkZ2UpOwor
CQlpZiAoaXRlciA9PSBicmlkZ2UpCisJCQlicmVhazsKKwl9CiB9CiBFWFBPUlRfU1lNQk9MKGRy
bV9hdG9taWNfYnJpZGdlX2NoYWluX3ByZV9lbmFibGUpOwogCkBAIC00NjcsMTUgKzQ4MSwxNCBA
QCBFWFBPUlRfU1lNQk9MKGRybV9hdG9taWNfYnJpZGdlX2NoYWluX3ByZV9lbmFibGUpOwogdm9p
ZCBkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9lbmFibGUoc3RydWN0IGRybV9icmlkZ2UgKmJyaWRn
ZSwKIAkJCQkgICAgc3RydWN0IGRybV9hdG9taWNfc3RhdGUgKnN0YXRlKQogewotCWlmICghYnJp
ZGdlKQotCQlyZXR1cm47CisJc3RydWN0IGRybV9lbmNvZGVyICplbmNvZGVyID0gYnJpZGdlLT5l
bmNvZGVyOwogCi0JaWYgKGJyaWRnZS0+ZnVuY3MtPmF0b21pY19lbmFibGUpCi0JCWJyaWRnZS0+
ZnVuY3MtPmF0b21pY19lbmFibGUoYnJpZGdlLCBzdGF0ZSk7Ci0JZWxzZSBpZiAoYnJpZGdlLT5m
dW5jcy0+ZW5hYmxlKQotCQlicmlkZ2UtPmZ1bmNzLT5lbmFibGUoYnJpZGdlKTsKLQotCWRybV9h
dG9taWNfYnJpZGdlX2NoYWluX2VuYWJsZShicmlkZ2UtPm5leHQsIHN0YXRlKTsKKwlsaXN0X2Zv
cl9lYWNoX2VudHJ5X2Zyb20oYnJpZGdlLCAmZW5jb2Rlci0+YnJpZGdlX2NoYWluLCBjaGFpbl9u
b2RlKSB7CisJCWlmIChicmlkZ2UtPmZ1bmNzLT5hdG9taWNfZW5hYmxlKQorCQkJYnJpZGdlLT5m
dW5jcy0+YXRvbWljX2VuYWJsZShicmlkZ2UsIHN0YXRlKTsKKwkJZWxzZSBpZiAoYnJpZGdlLT5m
dW5jcy0+ZW5hYmxlKQorCQkJYnJpZGdlLT5mdW5jcy0+ZW5hYmxlKGJyaWRnZSk7CisJfQogfQog
RVhQT1JUX1NZTUJPTChkcm1fYXRvbWljX2JyaWRnZV9jaGFpbl9lbmFibGUpOwogCmRpZmYgLS1n
aXQgYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2VuY29kZXIuYyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1f
ZW5jb2Rlci5jCmluZGV4IDY4NjA1M2JmNDFiOS4uOWJmNjQyYzA5YzU1IDEwMDY0NAotLS0gYS9k
cml2ZXJzL2dwdS9kcm0vZHJtX2VuY29kZXIuYworKysgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2Vu
Y29kZXIuYwpAQCAtMTQzLDYgKzE0Myw3IEBAIGludCBkcm1fZW5jb2Rlcl9pbml0KHN0cnVjdCBk
cm1fZGV2aWNlICpkZXYsCiAJCWdvdG8gb3V0X3B1dDsKIAl9CiAKKwlJTklUX0xJU1RfSEVBRCgm
ZW5jb2Rlci0+YnJpZGdlX2NoYWluKTsKIAlpZiAoIWVuY29kZXItPmJyaWRnZS5mdW5jcykKIAkJ
ZW5jb2Rlci0+YnJpZGdlLmZ1bmNzID0gJmR1bW15X2JyaWRnZV9mdW5jczsKIApAQCAtMTc3LDEw
ICsxNzgsOSBAQCB2b2lkIGRybV9lbmNvZGVyX2NsZWFudXAoc3RydWN0IGRybV9lbmNvZGVyICpl
bmNvZGVyKQogCSAqIHRoZSBpbmRpY2VzIG9uIHRoZSBkcm1fZW5jb2RlciBhZnRlciB1cyBpbiB0
aGUgZW5jb2Rlcl9saXN0LgogCSAqLwogCi0JZm9yIChicmlkZ2UgPSAmZW5jb2Rlci0+YnJpZGdl
OyBicmlkZ2U7IGJyaWRnZSA9IG5leHQpIHsKLQkJbmV4dCA9IGJyaWRnZS0+bmV4dDsKKwlsaXN0
X2Zvcl9lYWNoX2VudHJ5X3NhZmUoYnJpZGdlLCBuZXh0LCAmZW5jb2Rlci0+YnJpZGdlX2NoYWlu
LAorCQkJCSBjaGFpbl9ub2RlKQogCQlkcm1fYnJpZGdlX2RldGFjaChicmlkZ2UpOwotCX0KIAog
CWRybV9tb2RlX29iamVjdF91bnJlZ2lzdGVyKGRldiwgJmVuY29kZXItPmJhc2UpOwogCWtmcmVl
KGVuY29kZXItPm5hbWUpOwpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9kcm0vZHJtX2JyaWRnZS5oIGIv
aW5jbHVkZS9kcm0vZHJtX2JyaWRnZS5oCmluZGV4IDc4MDlmY2E5OWIyZC4uOGFmOTJmMGE5NTQx
IDEwMDY0NAotLS0gYS9pbmNsdWRlL2RybS9kcm1fYnJpZGdlLmgKKysrIGIvaW5jbHVkZS9kcm0v
ZHJtX2JyaWRnZS5oCkBAIC0zODMsOCArMzgzLDggQEAgc3RydWN0IGRybV9icmlkZ2UgewogCXN0
cnVjdCBkcm1fZGV2aWNlICpkZXY7CiAJLyoqIEBlbmNvZGVyOiBlbmNvZGVyIHRvIHdoaWNoIHRo
aXMgYnJpZGdlIGlzIGNvbm5lY3RlZCAqLwogCXN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcjsK
LQkvKiogQG5leHQ6IHRoZSBuZXh0IGJyaWRnZSBpbiB0aGUgZW5jb2RlciBjaGFpbiAqLwotCXN0
cnVjdCBkcm1fYnJpZGdlICpuZXh0OworCS8qKiBAY2hhaW5fbm9kZTogdXNlZCB0byBmb3JtIGEg
YnJpZGdlIGNoYWluICovCisJc3RydWN0IGxpc3RfaGVhZCBjaGFpbl9ub2RlOwogI2lmZGVmIENP
TkZJR19PRgogCS8qKiBAb2Zfbm9kZTogZGV2aWNlIG5vZGUgcG9pbnRlciB0byB0aGUgYnJpZGdl
ICovCiAJc3RydWN0IGRldmljZV9ub2RlICpvZl9ub2RlOwpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9k
cm0vZHJtX2VuY29kZXIuaCBiL2luY2x1ZGUvZHJtL2RybV9lbmNvZGVyLmgKaW5kZXggMzBkMzQ3
YzM3NDAyLi5iMzM3NGQwNDU4MDEgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvZHJtL2RybV9lbmNvZGVy
LmgKKysrIGIvaW5jbHVkZS9kcm0vZHJtX2VuY29kZXIuaApAQCAtMTczLDYgKzE3MywxMyBAQCBz
dHJ1Y3QgZHJtX2VuY29kZXIgewogCSAqLwogCXN0cnVjdCBkcm1fY3J0YyAqY3J0YzsKIAorCS8q
KgorCSAqIEBicmlkZ2VfY2hhaW46IEJyaWRnZXMgYXR0YWNoZWQgdG8gdGhpcyBlbmNvZGVyLiBU
aGUgZmlyc3QgZW50cnkgb2YKKwkgKiB0aGlzIGxpc3QgaXMgYWx3YXlzICZkcm1fZW5jb2Rlci5i
cmlkZ2UuIEl0IG1heSBiZSBmb2xsb3dlZCBieSBvdGhlcgorCSAqIGJyaWRnZSBlbnRpdGllcy4K
KwkgKi8KKwlzdHJ1Y3QgbGlzdF9oZWFkIGJyaWRnZV9jaGFpbjsKKwogCS8qKgogCSAqIEBicmlk
Z2U6IEJyaWRnZSByZXByZXNlbnRpbmcgb3VyIGVuY29kZXIuIE90aGVyIGJyaWRnZXMgbWlnaHQg
YmUKIAkgKiBsaW5rZWQgdG8gdGhpcyBkdW1teSBicmlkZ2UgZWxlbWVudCB0byBmb3JtIGFuIGVu
Y29kZXIgY2hhaW4uCi0tIAoyLjIxLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZy
ZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3Rp
bmZvL2RyaS1kZXZlbA==
