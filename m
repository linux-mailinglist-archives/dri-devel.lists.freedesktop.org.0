Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 65B5C29DBDB
	for <lists+dri-devel@lfdr.de>; Thu, 29 Oct 2020 01:16:39 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 7B1E06E81E;
	Thu, 29 Oct 2020 00:16:36 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pf1-x443.google.com (mail-pf1-x443.google.com
 [IPv6:2607:f8b0:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5E0FB6E81C
 for <dri-devel@lists.freedesktop.org>; Thu, 29 Oct 2020 00:16:32 +0000 (UTC)
Received: by mail-pf1-x443.google.com with SMTP id 13so851515pfy.4
 for <dri-devel@lists.freedesktop.org>; Wed, 28 Oct 2020 17:16:32 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=OmsT0T4sZQ5qfYwtasILv6pAOqrhf0OxNN9/C1pO7z0=;
 b=FUVXIxFwW0Gs0haP2Psj5wybq4MLimu+X1TnrRarMJTaku5x7T7h3FooEAvrXeVT/G
 xdm1/G4zF4raGudZm31JrAu9kKqmUgjhdd/ZfRI1v2Sfif69DY0QH1ywsKAfSBxFas7Y
 HsSVeTe+DcA6pvAWqXaU6vIOJQB6DchU7egF7WsDCzvc5ddfJVVkbMX2aTuoGaRxd13C
 PzCY4SCK0DMNlOLyClivWONhi7GnDoIAsz0J1X0rJ4eh88I3XOzH3vUPKz0e3xKUKvxS
 DnRMIowWabGOke/zXglA5NrD68wu5vOEYLRkgT0EMNuevfwHfdZbf9Bdl2lQYP5q22lb
 YBKw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=OmsT0T4sZQ5qfYwtasILv6pAOqrhf0OxNN9/C1pO7z0=;
 b=MTVHJ7gsM3mqVBTD1PrV8U2mtw3O9Gr8RXBM0dNx6j+axF/3/18vQyhqt0ycCU2Oa3
 tXLiLTX9DAkQdJZEkKpmiVH94fZvy3jMvJz3OFidtfv3RXFJoBSlfbDlAVx/6xYGCVOk
 UyKz7STjOsOvivYCcoVkNXkf+M3ILbHHjd49sWwH09L8k1g9hGNdR3q0mbUIjVf8mqer
 p/QEwsG4lvf+3HwTsybEC/GPArm9fBzXLbVEINfy/rRmHGEj6Hc7XeCex3C3htqQap/B
 WnZDiflmkaOWprObL5MbvbdP5PIkr9kIGEn9F/UMJe+A+id2eN/Ml8lD2Bs4sAHYUvnu
 jYrw==
X-Gm-Message-State: AOAM533pnuQ9fq5jqas1acsp0ALoZv03KYNMXtCO5dbXPp/zDLy6QSOb
 ey+Lk8k3H0yPJR7SnqOiDG+Z+Q==
X-Google-Smtp-Source: ABdhPJwqGXXYhPirPwAot66c+MusgE5mwgUuBC1aftt11iPmHMdL0HIknAhHv506i39bIJUfrhlHRg==
X-Received: by 2002:a65:4144:: with SMTP id x4mr1628982pgp.432.1603930591925; 
 Wed, 28 Oct 2020 17:16:31 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 u13sm727407pfl.162.2020.10.28.17.16.30
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Wed, 28 Oct 2020 17:16:31 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v4 2/7] dma-buf: heaps: Move heap-helper logic into the
 cma_heap implementation
Date: Thu, 29 Oct 2020 00:16:19 +0000
Message-Id: <20201029001624.17513-3-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20201029001624.17513-1-john.stultz@linaro.org>
References: <20201029001624.17513-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sandeep Patil <sspatil@google.com>, dri-devel@lists.freedesktop.org,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Chris Goldsworthy <cgoldswo@codeaurora.org>,
 Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 linux-media@vger.kernel.org, Suren Baghdasaryan <surenb@google.com>,
 Daniel Mentz <danielmentz@google.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

U2luY2UgdGhlIGhlYXAtaGVscGVycyBsb2dpYyBlbmRlZCB1cCBub3QgYmVpbmcgYXMgZ2VuZXJp
YyBhcwpob3BlZCwgbW92ZSB0aGUgaGVhcC1oZWxwZXJzIGRtYV9idWZfb3BzIGltcGxlbWVudGF0
aW9ucyBpbnRvCnRoZSBjbWFfaGVhcCBkaXJlY3RseS4KClRoaXMgd2lsbCBhbGxvdyB1cyB0byBy
ZW1vdmUgdGhlIGhlYXBfaGVscGVycyBjb2RlIGluIGEgZm9sbG93aW5nCnBhdGNoLgoKQ2M6IFN1
bWl0IFNlbXdhbCA8c3VtaXQuc2Vtd2FsQGxpbmFyby5vcmc+CkNjOiBMaWFtIE1hcmsgPGxtYXJr
QGNvZGVhdXJvcmEub3JnPgpDYzogTGF1cmEgQWJib3R0IDxsYWJib3R0QGtlcm5lbC5vcmc+CkNj
OiBCcmlhbiBTdGFya2V5IDxCcmlhbi5TdGFya2V5QGFybS5jb20+CkNjOiBIcmlkeWEgVmFsc2Fy
YWp1IDxocmlkeWFAZ29vZ2xlLmNvbT4KQ2M6IFN1cmVuIEJhZ2hkYXNhcnlhbiA8c3VyZW5iQGdv
b2dsZS5jb20+CkNjOiBTYW5kZWVwIFBhdGlsIDxzc3BhdGlsQGdvb2dsZS5jb20+CkNjOiBEYW5p
ZWwgTWVudHogPGRhbmllbG1lbnR6QGdvb2dsZS5jb20+CkNjOiBDaHJpcyBHb2xkc3dvcnRoeSA8
Y2dvbGRzd29AY29kZWF1cm9yYS5vcmc+CkNjOiDDmHJqYW4gRWlkZSA8b3JqYW4uZWlkZUBhcm0u
Y29tPgpDYzogUm9iaW4gTXVycGh5IDxyb2Jpbi5tdXJwaHlAYXJtLmNvbT4KQ2M6IEV6ZXF1aWVs
IEdhcmNpYSA8ZXplcXVpZWxAY29sbGFib3JhLmNvbT4KQ2M6IFNpbW9uIFNlciA8Y29udGFjdEBl
bWVyc2lvbi5mcj4KQ2M6IEphbWVzIEpvbmVzIDxqYWpvbmVzQG52aWRpYS5jb20+CkNjOiBsaW51
eC1tZWRpYUB2Z2VyLmtlcm5lbC5vcmcKQ2M6IGRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5v
cmcKUmV2aWV3ZWQtYnk6IEJyaWFuIFN0YXJrZXkgPGJyaWFuLnN0YXJrZXlAYXJtLmNvbT4KU2ln
bmVkLW9mZi1ieTogSm9obiBTdHVsdHogPGpvaG4uc3R1bHR6QGxpbmFyby5vcmc+Ci0tLQp2MjoK
KiBGaXggdW51c2VkIHJldHVybiB2YWx1ZSBhbmQgbG9ja2luZyBpc3N1ZSBSZXBvcnRlZC1ieToK
ICAgIGtlcm5lbCB0ZXN0IHJvYm90IDxsa3BAaW50ZWwuY29tPgogICAgSnVsaWEgTGF3YWxsIDxq
dWxpYS5sYXdhbGxAaW5yaWEuZnI+CiogTWFrZSBjbWFfaGVhcF9idWZfb3BzIHN0YXRpYyBzdWdn
ZXN0ZWQgYnkKICAgIGtlcm5lbCB0ZXN0IHJvYm90IDxsa3BAaW50ZWwuY29tPgoqIEZpeCB1bmlu
aXRpYWxpemVkIHJldHVybiBpbiBjbWEgUmVwb3J0ZWQtYnk6CiAgICBrZXJuZWwgdGVzdCByb2Jv
dCA8bGtwQGludGVsLmNvbT4KKiBNaW5vciBjbGVhbnVwcwp2MzoKKiBVc2UgdGhlIG5ldyBzZ3Rh
YmxlIG1hcHBpbmcgZnVuY3Rpb25zLCBhcyBTdWdnZXN0ZWQtYnk6CiAgICAgRGFuaWVsIE1lbnR6
IDxkYW5pZWxtZW50ekBnb29nbGUuY29tPgp2NDoKKiBTcGVsbGluZyBmaXggc3VnZ2VzdGVkIGJ5
IEJyaWFuUwotLS0KIGRyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9jbWFfaGVhcC5jIHwgMzE0ICsrKysr
KysrKysrKysrKysrKysrKysrKysrLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCAyNjUgaW5zZXJ0aW9u
cygrKSwgNDkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9kbWEtYnVmL2hlYXBz
L2NtYV9oZWFwLmMgYi9kcml2ZXJzL2RtYS1idWYvaGVhcHMvY21hX2hlYXAuYwppbmRleCBlNTUz
ODRkYzExNWIuLjUzNDFlNWUyMjZkNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9kbWEtYnVmL2hlYXBz
L2NtYV9oZWFwLmMKKysrIGIvZHJpdmVycy9kbWEtYnVmL2hlYXBzL2NtYV9oZWFwLmMKQEAgLTIs
NzYgKzIsMjkwIEBACiAvKgogICogRE1BQlVGIENNQSBoZWFwIGV4cG9ydGVyCiAgKgotICogQ29w
eXJpZ2h0IChDKSAyMDEyLCAyMDE5IExpbmFybyBMdGQuCisgKiBDb3B5cmlnaHQgKEMpIDIwMTIs
IDIwMTksIDIwMjAgTGluYXJvIEx0ZC4KICAqIEF1dGhvcjogPGJlbmphbWluLmdhaWduYXJkQGxp
bmFyby5vcmc+IGZvciBTVC1Fcmljc3Nvbi4KKyAqCisgKiBBbHNvIHV0aWxpemluZyBwYXJ0cyBv
ZiBBbmRyZXcgRGF2aXMnIFNSQU0gaGVhcDoKKyAqIENvcHlyaWdodCAoQykgMjAxOSBUZXhhcyBJ
bnN0cnVtZW50cyBJbmNvcnBvcmF0ZWQgLSBodHRwOi8vd3d3LnRpLmNvbS8KKyAqCUFuZHJldyBG
LiBEYXZpcyA8YWZkQHRpLmNvbT4KICAqLwotCiAjaW5jbHVkZSA8bGludXgvY21hLmg+Ci0jaW5j
bHVkZSA8bGludXgvZGV2aWNlLmg+CiAjaW5jbHVkZSA8bGludXgvZG1hLWJ1Zi5oPgogI2luY2x1
ZGUgPGxpbnV4L2RtYS1oZWFwLmg+CiAjaW5jbHVkZSA8bGludXgvZG1hLW1hcC1vcHMuaD4KICNp
bmNsdWRlIDxsaW51eC9lcnIuaD4KLSNpbmNsdWRlIDxsaW51eC9lcnJuby5oPgogI2luY2x1ZGUg
PGxpbnV4L2hpZ2htZW0uaD4KKyNpbmNsdWRlIDxsaW51eC9pby5oPgorI2luY2x1ZGUgPGxpbnV4
L21tLmg+CiAjaW5jbHVkZSA8bGludXgvbW9kdWxlLmg+Ci0jaW5jbHVkZSA8bGludXgvc2xhYi5o
PgogI2luY2x1ZGUgPGxpbnV4L3NjYXR0ZXJsaXN0Lmg+Ci0jaW5jbHVkZSA8bGludXgvc2NoZWQv
c2lnbmFsLmg+CisjaW5jbHVkZSA8bGludXgvc2xhYi5oPgogCi0jaW5jbHVkZSAiaGVhcC1oZWxw
ZXJzLmgiCiAKIHN0cnVjdCBjbWFfaGVhcCB7CiAJc3RydWN0IGRtYV9oZWFwICpoZWFwOwogCXN0
cnVjdCBjbWEgKmNtYTsKIH07CiAKLXN0YXRpYyB2b2lkIGNtYV9oZWFwX2ZyZWUoc3RydWN0IGhl
YXBfaGVscGVyX2J1ZmZlciAqYnVmZmVyKQorc3RydWN0IGNtYV9oZWFwX2J1ZmZlciB7CisJc3Ry
dWN0IGNtYV9oZWFwICpoZWFwOworCXN0cnVjdCBsaXN0X2hlYWQgYXR0YWNobWVudHM7CisJc3Ry
dWN0IG11dGV4IGxvY2s7CisJdW5zaWduZWQgbG9uZyBsZW47CisJc3RydWN0IHBhZ2UgKmNtYV9w
YWdlczsKKwlzdHJ1Y3QgcGFnZSAqKnBhZ2VzOworCXBnb2ZmX3QgcGFnZWNvdW50OworCWludCB2
bWFwX2NudDsKKwl2b2lkICp2YWRkcjsKK307CisKK3N0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50
IHsKKwlzdHJ1Y3QgZGV2aWNlICpkZXY7CisJc3RydWN0IHNnX3RhYmxlIHRhYmxlOworCXN0cnVj
dCBsaXN0X2hlYWQgbGlzdDsKK307CisKK3N0YXRpYyBpbnQgY21hX2hlYXBfYXR0YWNoKHN0cnVj
dCBkbWFfYnVmICpkbWFidWYsCisJCQkgICBzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRh
Y2htZW50KQogewotCXN0cnVjdCBjbWFfaGVhcCAqY21hX2hlYXAgPSBkbWFfaGVhcF9nZXRfZHJ2
ZGF0YShidWZmZXItPmhlYXApOwotCXVuc2lnbmVkIGxvbmcgbnJfcGFnZXMgPSBidWZmZXItPnBh
Z2Vjb3VudDsKLQlzdHJ1Y3QgcGFnZSAqY21hX3BhZ2VzID0gYnVmZmVyLT5wcml2X3ZpcnQ7CisJ
c3RydWN0IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyID0gZG1hYnVmLT5wcml2OworCXN0cnVjdCBk
bWFfaGVhcF9hdHRhY2htZW50ICphOworCWludCByZXQ7CiAKLQkvKiBmcmVlIHBhZ2UgbGlzdCAq
LwotCWtmcmVlKGJ1ZmZlci0+cGFnZXMpOwotCS8qIHJlbGVhc2UgbWVtb3J5ICovCi0JY21hX3Jl
bGVhc2UoY21hX2hlYXAtPmNtYSwgY21hX3BhZ2VzLCBucl9wYWdlcyk7CisJYSA9IGt6YWxsb2Mo
c2l6ZW9mKCphKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFhKQorCQlyZXR1cm4gLUVOT01FTTsKKwor
CXJldCA9IHNnX2FsbG9jX3RhYmxlX2Zyb21fcGFnZXMoJmEtPnRhYmxlLCBidWZmZXItPnBhZ2Vz
LAorCQkJCQlidWZmZXItPnBhZ2Vjb3VudCwgMCwKKwkJCQkJYnVmZmVyLT5wYWdlY291bnQgPDwg
UEFHRV9TSElGVCwKKwkJCQkJR0ZQX0tFUk5FTCk7CisJaWYgKHJldCkgeworCQlrZnJlZShhKTsK
KwkJcmV0dXJuIHJldDsKKwl9CisKKwlhLT5kZXYgPSBhdHRhY2htZW50LT5kZXY7CisJSU5JVF9M
SVNUX0hFQUQoJmEtPmxpc3QpOworCisJYXR0YWNobWVudC0+cHJpdiA9IGE7CisKKwltdXRleF9s
b2NrKCZidWZmZXItPmxvY2spOworCWxpc3RfYWRkKCZhLT5saXN0LCAmYnVmZmVyLT5hdHRhY2ht
ZW50cyk7CisJbXV0ZXhfdW5sb2NrKCZidWZmZXItPmxvY2spOworCisJcmV0dXJuIDA7Cit9CisK
K3N0YXRpYyB2b2lkIGNtYV9oZWFwX2RldGFjaChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAorCQkJ
ICAgIHN0cnVjdCBkbWFfYnVmX2F0dGFjaG1lbnQgKmF0dGFjaG1lbnQpCit7CisJc3RydWN0IGNt
YV9oZWFwX2J1ZmZlciAqYnVmZmVyID0gZG1hYnVmLT5wcml2OworCXN0cnVjdCBkbWFfaGVhcF9h
dHRhY2htZW50ICphID0gYXR0YWNobWVudC0+cHJpdjsKKworCW11dGV4X2xvY2soJmJ1ZmZlci0+
bG9jayk7CisJbGlzdF9kZWwoJmEtPmxpc3QpOworCW11dGV4X3VubG9jaygmYnVmZmVyLT5sb2Nr
KTsKKworCXNnX2ZyZWVfdGFibGUoJmEtPnRhYmxlKTsKKwlrZnJlZShhKTsKK30KKworc3RhdGlj
IHN0cnVjdCBzZ190YWJsZSAqY21hX2hlYXBfbWFwX2RtYV9idWYoc3RydWN0IGRtYV9idWZfYXR0
YWNobWVudCAqYXR0YWNobWVudCwKKwkJCQkJICAgICBlbnVtIGRtYV9kYXRhX2RpcmVjdGlvbiBk
aXJlY3Rpb24pCit7CisJc3RydWN0IGRtYV9oZWFwX2F0dGFjaG1lbnQgKmEgPSBhdHRhY2htZW50
LT5wcml2OworCXN0cnVjdCBzZ190YWJsZSAqdGFibGUgPSAmYS0+dGFibGU7CisJaW50IHJldDsK
KworCXJldCA9IGRtYV9tYXBfc2d0YWJsZShhdHRhY2htZW50LT5kZXYsIHRhYmxlLCBkaXJlY3Rp
b24sIDApOworCWlmIChyZXQpCisJCXJldHVybiBFUlJfUFRSKC1FTk9NRU0pOworCXJldHVybiB0
YWJsZTsKK30KKworc3RhdGljIHZvaWQgY21hX2hlYXBfdW5tYXBfZG1hX2J1ZihzdHJ1Y3QgZG1h
X2J1Zl9hdHRhY2htZW50ICphdHRhY2htZW50LAorCQkJCSAgIHN0cnVjdCBzZ190YWJsZSAqdGFi
bGUsCisJCQkJICAgZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24gZGlyZWN0aW9uKQoreworCWRtYV91
bm1hcF9zZ3RhYmxlKGF0dGFjaG1lbnQtPmRldiwgdGFibGUsIGRpcmVjdGlvbiwgMCk7Cit9CisK
K3N0YXRpYyBpbnQgY21hX2hlYXBfZG1hX2J1Zl9iZWdpbl9jcHVfYWNjZXNzKHN0cnVjdCBkbWFf
YnVmICpkbWFidWYsCisJCQkJCSAgICAgZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24gZGlyZWN0aW9u
KQoreworCXN0cnVjdCBjbWFfaGVhcF9idWZmZXIgKmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKKwlz
dHJ1Y3QgZG1hX2hlYXBfYXR0YWNobWVudCAqYTsKKworCWlmIChidWZmZXItPnZtYXBfY250KQor
CQlpbnZhbGlkYXRlX2tlcm5lbF92bWFwX3JhbmdlKGJ1ZmZlci0+dmFkZHIsIGJ1ZmZlci0+bGVu
KTsKKworCW11dGV4X2xvY2soJmJ1ZmZlci0+bG9jayk7CisJbGlzdF9mb3JfZWFjaF9lbnRyeShh
LCAmYnVmZmVyLT5hdHRhY2htZW50cywgbGlzdCkgeworCQlkbWFfc3luY19zZ3RhYmxlX2Zvcl9j
cHUoYS0+ZGV2LCAmYS0+dGFibGUsIGRpcmVjdGlvbik7CisJfQorCW11dGV4X3VubG9jaygmYnVm
ZmVyLT5sb2NrKTsKKworCXJldHVybiAwOworfQorCitzdGF0aWMgaW50IGNtYV9oZWFwX2RtYV9i
dWZfZW5kX2NwdV9hY2Nlc3Moc3RydWN0IGRtYV9idWYgKmRtYWJ1ZiwKKwkJCQkJICAgZW51bSBk
bWFfZGF0YV9kaXJlY3Rpb24gZGlyZWN0aW9uKQoreworCXN0cnVjdCBjbWFfaGVhcF9idWZmZXIg
KmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKKwlzdHJ1Y3QgZG1hX2hlYXBfYXR0YWNobWVudCAqYTsK
KworCWlmIChidWZmZXItPnZtYXBfY250KQorCQlmbHVzaF9rZXJuZWxfdm1hcF9yYW5nZShidWZm
ZXItPnZhZGRyLCBidWZmZXItPmxlbik7CisKKwltdXRleF9sb2NrKCZidWZmZXItPmxvY2spOwor
CWxpc3RfZm9yX2VhY2hfZW50cnkoYSwgJmJ1ZmZlci0+YXR0YWNobWVudHMsIGxpc3QpIHsKKwkJ
ZG1hX3N5bmNfc2d0YWJsZV9mb3JfZGV2aWNlKGEtPmRldiwgJmEtPnRhYmxlLCBkaXJlY3Rpb24p
OworCX0KKwltdXRleF91bmxvY2soJmJ1ZmZlci0+bG9jayk7CisKKwlyZXR1cm4gMDsKK30KKwor
c3RhdGljIHZtX2ZhdWx0X3QgY21hX2hlYXBfdm1fZmF1bHQoc3RydWN0IHZtX2ZhdWx0ICp2bWYp
Cit7CisJc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEgPSB2bWYtPnZtYTsKKwlzdHJ1Y3QgY21h
X2hlYXBfYnVmZmVyICpidWZmZXIgPSB2bWEtPnZtX3ByaXZhdGVfZGF0YTsKKworCWlmICh2bWYt
PnBnb2ZmID4gYnVmZmVyLT5wYWdlY291bnQpCisJCXJldHVybiBWTV9GQVVMVF9TSUdCVVM7CisK
Kwl2bWYtPnBhZ2UgPSBidWZmZXItPnBhZ2VzW3ZtZi0+cGdvZmZdOworCWdldF9wYWdlKHZtZi0+
cGFnZSk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGNvbnN0IHN0cnVjdCB2bV9vcGVyYXRp
b25zX3N0cnVjdCBkbWFfaGVhcF92bV9vcHMgPSB7CisJLmZhdWx0ID0gY21hX2hlYXBfdm1fZmF1
bHQsCit9OworCitzdGF0aWMgaW50IGNtYV9oZWFwX21tYXAoc3RydWN0IGRtYV9idWYgKmRtYWJ1
Ziwgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpCit7CisJc3RydWN0IGNtYV9oZWFwX2J1ZmZl
ciAqYnVmZmVyID0gZG1hYnVmLT5wcml2OworCisJaWYgKCh2bWEtPnZtX2ZsYWdzICYgKFZNX1NI
QVJFRCB8IFZNX01BWVNIQVJFKSkgPT0gMCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwl2bWEtPnZt
X29wcyA9ICZkbWFfaGVhcF92bV9vcHM7CisJdm1hLT52bV9wcml2YXRlX2RhdGEgPSBidWZmZXI7
CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIHZvaWQgKmNtYV9oZWFwX2RvX3ZtYXAoc3RydWN0
IGNtYV9oZWFwX2J1ZmZlciAqYnVmZmVyKQoreworCXZvaWQgKnZhZGRyOworCisJdmFkZHIgPSB2
bWFwKGJ1ZmZlci0+cGFnZXMsIGJ1ZmZlci0+cGFnZWNvdW50LCBWTV9NQVAsIFBBR0VfS0VSTkVM
KTsKKwlpZiAoIXZhZGRyKQorCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKKworCXJldHVybiB2
YWRkcjsKK30KKworc3RhdGljIHZvaWQgKmNtYV9oZWFwX3ZtYXAoc3RydWN0IGRtYV9idWYgKmRt
YWJ1ZikKK3sKKwlzdHJ1Y3QgY21hX2hlYXBfYnVmZmVyICpidWZmZXIgPSBkbWFidWYtPnByaXY7
CisJdm9pZCAqdmFkZHI7CisKKwltdXRleF9sb2NrKCZidWZmZXItPmxvY2spOworCWlmIChidWZm
ZXItPnZtYXBfY250KSB7CisJCWJ1ZmZlci0+dm1hcF9jbnQrKzsKKwkJdmFkZHIgPSBidWZmZXIt
PnZhZGRyOworCQlnb3RvIG91dDsKKwl9CisKKwl2YWRkciA9IGNtYV9oZWFwX2RvX3ZtYXAoYnVm
ZmVyKTsKKwlpZiAoSVNfRVJSKHZhZGRyKSkKKwkJZ290byBvdXQ7CisKKwlidWZmZXItPnZhZGRy
ID0gdmFkZHI7CisJYnVmZmVyLT52bWFwX2NudCsrOworb3V0OgorCW11dGV4X3VubG9jaygmYnVm
ZmVyLT5sb2NrKTsKKworCXJldHVybiB2YWRkcjsKK30KKworc3RhdGljIHZvaWQgY21hX2hlYXBf
dnVubWFwKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsIHZvaWQgKnZhZGRyKQoreworCXN0cnVjdCBj
bWFfaGVhcF9idWZmZXIgKmJ1ZmZlciA9IGRtYWJ1Zi0+cHJpdjsKKworCW11dGV4X2xvY2soJmJ1
ZmZlci0+bG9jayk7CisJaWYgKCEtLWJ1ZmZlci0+dm1hcF9jbnQpIHsKKwkJdnVubWFwKGJ1ZmZl
ci0+dmFkZHIpOworCQlidWZmZXItPnZhZGRyID0gTlVMTDsKKwl9CisJbXV0ZXhfdW5sb2NrKCZi
dWZmZXItPmxvY2spOworfQorCitzdGF0aWMgdm9pZCBjbWFfaGVhcF9kbWFfYnVmX3JlbGVhc2Uo
c3RydWN0IGRtYV9idWYgKmRtYWJ1ZikKK3sKKwlzdHJ1Y3QgY21hX2hlYXBfYnVmZmVyICpidWZm
ZXIgPSBkbWFidWYtPnByaXY7CisJc3RydWN0IGNtYV9oZWFwICpjbWFfaGVhcCA9IGJ1ZmZlci0+
aGVhcDsKKworCWlmIChidWZmZXItPnZtYXBfY250ID4gMCkgeworCQlXQVJOKDEsICIlczogYnVm
ZmVyIHN0aWxsIG1hcHBlZCBpbiB0aGUga2VybmVsXG4iLCBfX2Z1bmNfXyk7CisJCXZ1bm1hcChi
dWZmZXItPnZhZGRyKTsKKwl9CisKKwljbWFfcmVsZWFzZShjbWFfaGVhcC0+Y21hLCBidWZmZXIt
PmNtYV9wYWdlcywgYnVmZmVyLT5wYWdlY291bnQpOwogCWtmcmVlKGJ1ZmZlcik7CiB9CiAKLS8q
IGRtYWJ1ZiBoZWFwIENNQSBvcGVyYXRpb25zIGZ1bmN0aW9ucyAqLworc3RhdGljIGNvbnN0IHN0
cnVjdCBkbWFfYnVmX29wcyBjbWFfaGVhcF9idWZfb3BzID0geworCS5hdHRhY2ggPSBjbWFfaGVh
cF9hdHRhY2gsCisJLmRldGFjaCA9IGNtYV9oZWFwX2RldGFjaCwKKwkubWFwX2RtYV9idWYgPSBj
bWFfaGVhcF9tYXBfZG1hX2J1ZiwKKwkudW5tYXBfZG1hX2J1ZiA9IGNtYV9oZWFwX3VubWFwX2Rt
YV9idWYsCisJLmJlZ2luX2NwdV9hY2Nlc3MgPSBjbWFfaGVhcF9kbWFfYnVmX2JlZ2luX2NwdV9h
Y2Nlc3MsCisJLmVuZF9jcHVfYWNjZXNzID0gY21hX2hlYXBfZG1hX2J1Zl9lbmRfY3B1X2FjY2Vz
cywKKwkubW1hcCA9IGNtYV9oZWFwX21tYXAsCisJLnZtYXAgPSBjbWFfaGVhcF92bWFwLAorCS52
dW5tYXAgPSBjbWFfaGVhcF92dW5tYXAsCisJLnJlbGVhc2UgPSBjbWFfaGVhcF9kbWFfYnVmX3Jl
bGVhc2UsCit9OworCiBzdGF0aWMgaW50IGNtYV9oZWFwX2FsbG9jYXRlKHN0cnVjdCBkbWFfaGVh
cCAqaGVhcCwKLQkJCSAgICAgdW5zaWduZWQgbG9uZyBsZW4sCi0JCQkgICAgIHVuc2lnbmVkIGxv
bmcgZmRfZmxhZ3MsCi0JCQkgICAgIHVuc2lnbmVkIGxvbmcgaGVhcF9mbGFncykKKwkJCQkgIHVu
c2lnbmVkIGxvbmcgbGVuLAorCQkJCSAgdW5zaWduZWQgbG9uZyBmZF9mbGFncywKKwkJCQkgIHVu
c2lnbmVkIGxvbmcgaGVhcF9mbGFncykKIHsKIAlzdHJ1Y3QgY21hX2hlYXAgKmNtYV9oZWFwID0g
ZG1hX2hlYXBfZ2V0X2RydmRhdGEoaGVhcCk7Ci0Jc3RydWN0IGhlYXBfaGVscGVyX2J1ZmZlciAq
aGVscGVyX2J1ZmZlcjsKLQlzdHJ1Y3QgcGFnZSAqY21hX3BhZ2VzOworCXN0cnVjdCBjbWFfaGVh
cF9idWZmZXIgKmJ1ZmZlcjsKKwlERUZJTkVfRE1BX0JVRl9FWFBPUlRfSU5GTyhleHBfaW5mbyk7
CiAJc2l6ZV90IHNpemUgPSBQQUdFX0FMSUdOKGxlbik7Ci0JdW5zaWduZWQgbG9uZyBucl9wYWdl
cyA9IHNpemUgPj4gUEFHRV9TSElGVDsKKwlwZ29mZl90IHBhZ2Vjb3VudCA9IHNpemUgPj4gUEFH
RV9TSElGVDsKIAl1bnNpZ25lZCBsb25nIGFsaWduID0gZ2V0X29yZGVyKHNpemUpOworCXN0cnVj
dCBwYWdlICpjbWFfcGFnZXM7CiAJc3RydWN0IGRtYV9idWYgKmRtYWJ1ZjsKIAlpbnQgcmV0ID0g
LUVOT01FTTsKIAlwZ29mZl90IHBnOwogCi0JaWYgKGFsaWduID4gQ09ORklHX0NNQV9BTElHTk1F
TlQpCi0JCWFsaWduID0gQ09ORklHX0NNQV9BTElHTk1FTlQ7Ci0KLQloZWxwZXJfYnVmZmVyID0g
a3phbGxvYyhzaXplb2YoKmhlbHBlcl9idWZmZXIpLCBHRlBfS0VSTkVMKTsKLQlpZiAoIWhlbHBl
cl9idWZmZXIpCisJYnVmZmVyID0ga3phbGxvYyhzaXplb2YoKmJ1ZmZlciksIEdGUF9LRVJORUwp
OworCWlmICghYnVmZmVyKQogCQlyZXR1cm4gLUVOT01FTTsKIAotCWluaXRfaGVhcF9oZWxwZXJf
YnVmZmVyKGhlbHBlcl9idWZmZXIsIGNtYV9oZWFwX2ZyZWUpOwotCWhlbHBlcl9idWZmZXItPmhl
YXAgPSBoZWFwOwotCWhlbHBlcl9idWZmZXItPnNpemUgPSBsZW47CisJSU5JVF9MSVNUX0hFQUQo
JmJ1ZmZlci0+YXR0YWNobWVudHMpOworCW11dGV4X2luaXQoJmJ1ZmZlci0+bG9jayk7CisJYnVm
ZmVyLT5sZW4gPSBzaXplOworCisJaWYgKGFsaWduID4gQ09ORklHX0NNQV9BTElHTk1FTlQpCisJ
CWFsaWduID0gQ09ORklHX0NNQV9BTElHTk1FTlQ7CiAKLQljbWFfcGFnZXMgPSBjbWFfYWxsb2Mo
Y21hX2hlYXAtPmNtYSwgbnJfcGFnZXMsIGFsaWduLCBmYWxzZSk7CisJY21hX3BhZ2VzID0gY21h
X2FsbG9jKGNtYV9oZWFwLT5jbWEsIHBhZ2Vjb3VudCwgYWxpZ24sIGZhbHNlKTsKIAlpZiAoIWNt
YV9wYWdlcykKLQkJZ290byBmcmVlX2J1ZjsKKwkJZ290byBmcmVlX2J1ZmZlcjsKIAorCS8qIENs
ZWFyIHRoZSBjbWEgcGFnZXMgKi8KIAlpZiAoUGFnZUhpZ2hNZW0oY21hX3BhZ2VzKSkgewotCQl1
bnNpZ25lZCBsb25nIG5yX2NsZWFyX3BhZ2VzID0gbnJfcGFnZXM7CisJCXVuc2lnbmVkIGxvbmcg
bnJfY2xlYXJfcGFnZXMgPSBwYWdlY291bnQ7CiAJCXN0cnVjdCBwYWdlICpwYWdlID0gY21hX3Bh
Z2VzOwogCiAJCXdoaWxlIChucl9jbGVhcl9wYWdlcyA+IDApIHsKQEAgLTg1LDcgKzI5OSw2IEBA
IHN0YXRpYyBpbnQgY21hX2hlYXBfYWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAogCQkJ
ICovCiAJCQlpZiAoZmF0YWxfc2lnbmFsX3BlbmRpbmcoY3VycmVudCkpCiAJCQkJZ290byBmcmVl
X2NtYTsKLQogCQkJcGFnZSsrOwogCQkJbnJfY2xlYXJfcGFnZXMtLTsKIAkJfQpAQCAtOTMsMjgg
KzMwNiwzMCBAQCBzdGF0aWMgaW50IGNtYV9oZWFwX2FsbG9jYXRlKHN0cnVjdCBkbWFfaGVhcCAq
aGVhcCwKIAkJbWVtc2V0KHBhZ2VfYWRkcmVzcyhjbWFfcGFnZXMpLCAwLCBzaXplKTsKIAl9CiAK
LQloZWxwZXJfYnVmZmVyLT5wYWdlY291bnQgPSBucl9wYWdlczsKLQloZWxwZXJfYnVmZmVyLT5w
YWdlcyA9IGttYWxsb2NfYXJyYXkoaGVscGVyX2J1ZmZlci0+cGFnZWNvdW50LAotCQkJCQkgICAg
IHNpemVvZigqaGVscGVyX2J1ZmZlci0+cGFnZXMpLAotCQkJCQkgICAgIEdGUF9LRVJORUwpOwot
CWlmICghaGVscGVyX2J1ZmZlci0+cGFnZXMpIHsKKwlidWZmZXItPnBhZ2VzID0ga21hbGxvY19h
cnJheShwYWdlY291bnQsIHNpemVvZigqYnVmZmVyLT5wYWdlcyksIEdGUF9LRVJORUwpOworCWlm
ICghYnVmZmVyLT5wYWdlcykgewogCQlyZXQgPSAtRU5PTUVNOwogCQlnb3RvIGZyZWVfY21hOwog
CX0KIAotCWZvciAocGcgPSAwOyBwZyA8IGhlbHBlcl9idWZmZXItPnBhZ2Vjb3VudDsgcGcrKykK
LQkJaGVscGVyX2J1ZmZlci0+cGFnZXNbcGddID0gJmNtYV9wYWdlc1twZ107CisJZm9yIChwZyA9
IDA7IHBnIDwgcGFnZWNvdW50OyBwZysrKQorCQlidWZmZXItPnBhZ2VzW3BnXSA9ICZjbWFfcGFn
ZXNbcGddOworCisJYnVmZmVyLT5jbWFfcGFnZXMgPSBjbWFfcGFnZXM7CisJYnVmZmVyLT5oZWFw
ID0gY21hX2hlYXA7CisJYnVmZmVyLT5wYWdlY291bnQgPSBwYWdlY291bnQ7CiAKIAkvKiBjcmVh
dGUgdGhlIGRtYWJ1ZiAqLwotCWRtYWJ1ZiA9IGhlYXBfaGVscGVyX2V4cG9ydF9kbWFidWYoaGVs
cGVyX2J1ZmZlciwgZmRfZmxhZ3MpOworCWV4cF9pbmZvLm9wcyA9ICZjbWFfaGVhcF9idWZfb3Bz
OworCWV4cF9pbmZvLnNpemUgPSBidWZmZXItPmxlbjsKKwlleHBfaW5mby5mbGFncyA9IGZkX2Zs
YWdzOworCWV4cF9pbmZvLnByaXYgPSBidWZmZXI7CisJZG1hYnVmID0gZG1hX2J1Zl9leHBvcnQo
JmV4cF9pbmZvKTsKIAlpZiAoSVNfRVJSKGRtYWJ1ZikpIHsKIAkJcmV0ID0gUFRSX0VSUihkbWFi
dWYpOwogCQlnb3RvIGZyZWVfcGFnZXM7CiAJfQogCi0JaGVscGVyX2J1ZmZlci0+ZG1hYnVmID0g
ZG1hYnVmOwotCWhlbHBlcl9idWZmZXItPnByaXZfdmlydCA9IGNtYV9wYWdlczsKLQogCXJldCA9
IGRtYV9idWZfZmQoZG1hYnVmLCBmZF9mbGFncyk7CiAJaWYgKHJldCA8IDApIHsKIAkJZG1hX2J1
Zl9wdXQoZG1hYnVmKTsKQEAgLTEyNSwxMSArMzQwLDEyIEBAIHN0YXRpYyBpbnQgY21hX2hlYXBf
YWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAogCXJldHVybiByZXQ7CiAKIGZyZWVfcGFn
ZXM6Ci0Ja2ZyZWUoaGVscGVyX2J1ZmZlci0+cGFnZXMpOworCWtmcmVlKGJ1ZmZlci0+cGFnZXMp
OwogZnJlZV9jbWE6Ci0JY21hX3JlbGVhc2UoY21hX2hlYXAtPmNtYSwgY21hX3BhZ2VzLCBucl9w
YWdlcyk7Ci1mcmVlX2J1ZjoKLQlrZnJlZShoZWxwZXJfYnVmZmVyKTsKKwljbWFfcmVsZWFzZShj
bWFfaGVhcC0+Y21hLCBjbWFfcGFnZXMsIHBhZ2Vjb3VudCk7CitmcmVlX2J1ZmZlcjoKKwlrZnJl
ZShidWZmZXIpOworCiAJcmV0dXJuIHJldDsKIH0KIAotLSAKMi4xNy4xCgpfX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0
CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3Rv
cC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2ZWwK
