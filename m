Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B5DBEF177D
	for <lists+dri-devel@lfdr.de>; Wed,  6 Nov 2019 14:41:45 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8B6286ED57;
	Wed,  6 Nov 2019 13:41:42 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from us-smtp-delivery-1.mimecast.com (us-smtp-2.mimecast.com
 [207.211.31.81])
 by gabe.freedesktop.org (Postfix) with ESMTPS id DBB866ED53
 for <dri-devel@lists.freedesktop.org>; Wed,  6 Nov 2019 13:41:40 +0000 (UTC)
Received: from mimecast-mx01.redhat.com (mimecast-mx01.redhat.com
 [209.132.183.4]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-37-ekA3G6WPOvC5qgCYmwwjcw-1; Wed, 06 Nov 2019 08:41:36 -0500
Received: from smtp.corp.redhat.com (int-mx08.intmail.prod.int.phx2.redhat.com
 [10.5.11.23])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mimecast-mx01.redhat.com (Postfix) with ESMTPS id C23CB1800DFB;
 Wed,  6 Nov 2019 13:41:32 +0000 (UTC)
Received: from jason-ThinkPad-X1-Carbon-6th.redhat.com
 (ovpn-12-193.pek2.redhat.com [10.72.12.193])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 6C7B219756;
 Wed,  6 Nov 2019 13:41:04 +0000 (UTC)
From: Jason Wang <jasowang@redhat.com>
To: kvm@vger.kernel.org, linux-s390@vger.kernel.org,
 linux-kernel@vger.kernel.org, dri-devel@lists.freedesktop.org,
 intel-gfx@lists.freedesktop.org, intel-gvt-dev@lists.freedesktop.org,
 kwankhede@nvidia.com, alex.williamson@redhat.com, mst@redhat.com,
 tiwei.bie@intel.com
Subject: [PATCH V10 5/6] virtio: introduce a mdev based transport
Date: Wed,  6 Nov 2019 21:35:30 +0800
Message-Id: <20191106133531.693-6-jasowang@redhat.com>
In-Reply-To: <20191106133531.693-1-jasowang@redhat.com>
References: <20191106133531.693-1-jasowang@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.23
X-MC-Unique: ekA3G6WPOvC5qgCYmwwjcw-1
X-Mimecast-Spam-Score: 0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=redhat.com; 
 s=mimecast20190719; t=1573047699;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=JGqg8qP39vMXnP+EB/M2jo3uCi2AD9tZlxsLNrs4jIY=;
 b=chmMjimA8DDpv+n1Qg8fF4UN+M5kRSVz5yMaefLPbjSA9/J6Vhom4qlFuriCbZFJXPiIA8
 cldunI9DVoHKioSruFi5EG1WIKs1ZlaLhtvtJHQuWoqO6tVPAc3Scd21p+K1JyzL7ROqTT
 nusDO0Tyc75ZaKjuXzMwCKjOdpV0qwU=
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: christophe.de.dinechin@gmail.com, sebott@linux.ibm.com, airlied@linux.ie,
 Jason Wang <jasowang@redhat.com>, heiko.carstens@de.ibm.com,
 kevin.tian@intel.com, virtualization@lists.linux-foundation.org,
 rob.miller@broadcom.com, lulu@redhat.com, eperezma@redhat.com,
 pasic@linux.ibm.com, borntraeger@de.ibm.com, haotian.wang@sifive.com,
 zhi.a.wang@intel.com, farman@linux.ibm.com, idos@mellanox.com,
 gor@linux.ibm.com, cunming.liang@intel.com, rodrigo.vivi@intel.com,
 xiao.w.wang@intel.com, freude@linux.ibm.com, parav@mellanox.com,
 zhihong.wang@intel.com, stefanha@redhat.com, akrowiak@linux.ibm.com,
 netdev@vger.kernel.org, cohuck@redhat.com, oberpar@linux.ibm.com,
 maxime.coquelin@redhat.com, lingshan.zhu@intel.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBpbnRyb2R1Y2VzIGEgbmV3IG1kZXYgdHJhbnNwb3J0IGZvciB2aXJ0aW8uIFRo
aXMgaXMgdXNlZCB0bwp1c2Uga2VybmVsIHZpcnRpbyBkcml2ZXIgdG8gZHJpdmUgdGhlIG1lZGlh
dGVkIGRldmljZSB0aGF0IGlzIGNhcGFibGUKb2YgcG9wdWxhdGluZyB2aXJ0cXVldWUgZGlyZWN0
bHkuCgpBIG5ldyB2aXJ0aW8tbWRldiBkcml2ZXIgd2lsbCBiZSByZWdpc3RlcmVkIHRvIHRoZSBt
ZGV2IGJ1cywgd2hlbiBhCm5ldyB2aXJ0aW8tbWRldiBkZXZpY2UgaXMgcHJvYmVkLCBpdCB3aWxs
IHJlZ2lzdGVyIHRoZSBkZXZpY2Ugd2l0aAptZGV2IGJhc2VkIGNvbmZpZyBvcHMuIFRoaXMgbWVh
bnMgaXQgaXMgYSBzb2Z0d2FyZSB0cmFuc3BvcnQgYmV0d2VlbgptZGV2IGRyaXZlciBhbmQgbWRl
diBkZXZpY2UuIFRoZSB0cmFuc3BvcnQgd2FzIGltcGxlbWVudGVkIHRocm91Z2gKdmlydGlvIGRl
dmljZSBzcGVjaWZpYyBvcHMuCgpSZXZpZXdlZC1ieTogQ29ybmVsaWEgSHVjayA8Y29odWNrQHJl
ZGhhdC5jb20+ClNpZ25lZC1vZmYtYnk6IEphc29uIFdhbmcgPGphc293YW5nQHJlZGhhdC5jb20+
Ci0tLQogZHJpdmVycy92aXJ0aW8vS2NvbmZpZyAgICAgICB8ICAxMyArKwogZHJpdmVycy92aXJ0
aW8vTWFrZWZpbGUgICAgICB8ICAgMSArCiBkcml2ZXJzL3ZpcnRpby92aXJ0aW9fbWRldi5jIHwg
NDA2ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQs
IDQyMCBpbnNlcnRpb25zKCspCiBjcmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy92aXJ0aW8vdmly
dGlvX21kZXYuYwoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmlydGlvL0tjb25maWcgYi9kcml2ZXJz
L3ZpcnRpby9LY29uZmlnCmluZGV4IDA3ODYxNWNmMmFmYy4uYmY1MjZjZTBmYWNjIDEwMDY0NAot
LS0gYS9kcml2ZXJzL3ZpcnRpby9LY29uZmlnCisrKyBiL2RyaXZlcnMvdmlydGlvL0tjb25maWcK
QEAgLTQzLDYgKzQzLDE5IEBAIGNvbmZpZyBWSVJUSU9fUENJX0xFR0FDWQogCiAJICBJZiB1bnN1
cmUsIHNheSBZLgogCitjb25maWcgVklSVElPX01ERVYKKwl0cmlzdGF0ZSAiTURFViBkcml2ZXIg
Zm9yIHZpcnRpbyBkZXZpY2VzIgorCWRlcGVuZHMgb24gVkZJT19NREVWICYmIFZJUlRJTworCWRl
ZmF1bHQgbgorCWhlbHAKKwkgIFRoaXMgZHJpdmVyIHByb3ZpZGVzIHN1cHBvcnQgZm9yIHZpcnRp
byBiYXNlZCBwYXJhdmlydHVhbAorCSAgZGV2aWNlIGRyaXZlciBvdmVyIE1ERVYgYnVzLiBGb3Ig
dGhpcyB0byBiZSB1c2VmdWwsIHlvdSBuZWVkCisJICBhbiBhcHByb3ByaWF0ZSB2aXJ0aW8gbWRl
diBkZXZpY2UgaW1wbGVtZW50YXRpb24gdGhhdAorCSAgb3BlcmF0ZXMgb24gYSBwaHlzaWNhbCBk
ZXZpY2UgdG8gYWxsb3cgdGhlIGRhdGFwYXRoIG9mIHZpcnRpbworCSAgdG8gYmUgb2ZmbG9hZGVk
IHRvIGhhcmR3YXJlLgorCisJICBJZiB1bnN1cmUsIHNheSBNLgorCiBjb25maWcgVklSVElPX1BN
RU0KIAl0cmlzdGF0ZSAiU3VwcG9ydCBmb3IgdmlydGlvIHBtZW0gZHJpdmVyIgogCWRlcGVuZHMg
b24gVklSVElPCmRpZmYgLS1naXQgYS9kcml2ZXJzL3ZpcnRpby9NYWtlZmlsZSBiL2RyaXZlcnMv
dmlydGlvL01ha2VmaWxlCmluZGV4IDNhMmI1YzVkY2Y0Ni4uZjI5OTdiNmM4MTJmIDEwMDY0NAot
LS0gYS9kcml2ZXJzL3ZpcnRpby9NYWtlZmlsZQorKysgYi9kcml2ZXJzL3ZpcnRpby9NYWtlZmls
ZQpAQCAtNiwzICs2LDQgQEAgdmlydGlvX3BjaS15IDo9IHZpcnRpb19wY2lfbW9kZXJuLm8gdmly
dGlvX3BjaV9jb21tb24ubwogdmlydGlvX3BjaS0kKENPTkZJR19WSVJUSU9fUENJX0xFR0FDWSkg
Kz0gdmlydGlvX3BjaV9sZWdhY3kubwogb2JqLSQoQ09ORklHX1ZJUlRJT19CQUxMT09OKSArPSB2
aXJ0aW9fYmFsbG9vbi5vCiBvYmotJChDT05GSUdfVklSVElPX0lOUFVUKSArPSB2aXJ0aW9faW5w
dXQubworb2JqLSQoQ09ORklHX1ZJUlRJT19NREVWKSArPSB2aXJ0aW9fbWRldi5vCmRpZmYgLS1n
aXQgYS9kcml2ZXJzL3ZpcnRpby92aXJ0aW9fbWRldi5jIGIvZHJpdmVycy92aXJ0aW8vdmlydGlv
X21kZXYuYwpuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMDAwMDAuLjllMTJlZjI0
MDQ5MwotLS0gL2Rldi9udWxsCisrKyBiL2RyaXZlcnMvdmlydGlvL3ZpcnRpb19tZGV2LmMKQEAg
LTAsMCArMSw0MDYgQEAKKy8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBHUEwtMi4wLW9ubHkK
Ky8qCisgKiBWSVJUSU8gYmFzZWQgZHJpdmVyIGZvciBNZWRpYXRlZCBkZXZpY2UKKyAqCisgKiBD
b3B5cmlnaHQgKGMpIDIwMTksIFJlZCBIYXQuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCisgKiAgICAg
QXV0aG9yOiBKYXNvbiBXYW5nIDxqYXNvd2FuZ0ByZWRoYXQuY29tPgorICoKKyAqLworCisjaW5j
bHVkZSA8bGludXgvaW5pdC5oPgorI2luY2x1ZGUgPGxpbnV4L21vZHVsZS5oPgorI2luY2x1ZGUg
PGxpbnV4L2RldmljZS5oPgorI2luY2x1ZGUgPGxpbnV4L2tlcm5lbC5oPgorI2luY2x1ZGUgPGxp
bnV4L3NsYWIuaD4KKyNpbmNsdWRlIDxsaW51eC91dWlkLmg+CisjaW5jbHVkZSA8bGludXgvbWRl
di5oPgorI2luY2x1ZGUgPGxpbnV4L21kZXZfdmlydGlvX29wcy5oPgorI2luY2x1ZGUgPGxpbnV4
L3ZpcnRpby5oPgorI2luY2x1ZGUgPGxpbnV4L3ZpcnRpb19jb25maWcuaD4KKyNpbmNsdWRlIDxs
aW51eC92aXJ0aW9fcmluZy5oPgorCisjZGVmaW5lIERSSVZFUl9WRVJTSU9OICAiMC4xIgorI2Rl
ZmluZSBEUklWRVJfQVVUSE9SICAgIlJlZCBIYXQgQ29ycG9yYXRpb24iCisjZGVmaW5lIERSSVZF
Ul9ERVNDICAgICAiVklSVElPIGJhc2VkIGRyaXZlciBmb3IgTWVkaWF0ZWQgZGV2aWNlIgorCisj
ZGVmaW5lIHRvX3ZpcnRpb19tZGV2X2RldmljZShkZXYpIFwKKwljb250YWluZXJfb2YoZGV2LCBz
dHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlLCB2ZGV2KQorCitzdHJ1Y3QgdmlydGlvX21kZXZfZGV2
aWNlIHsKKwlzdHJ1Y3QgdmlydGlvX2RldmljZSB2ZGV2OworCXN0cnVjdCBtZGV2X2RldmljZSAq
bWRldjsKKwl1NjQgZmVhdHVyZXM7CisKKwkvKiBUaGUgbG9jayB0byBwcm90ZWN0IHZpcnRxdWV1
ZSBsaXN0ICovCisJc3BpbmxvY2tfdCBsb2NrOworCS8qIExpc3Qgb2YgdmlydGlvX21kZXZfdnFf
aW5mbyAqLworCXN0cnVjdCBsaXN0X2hlYWQgdmlydHF1ZXVlczsKK307CisKK3N0cnVjdCB2aXJ0
aW9fbWRldl92cV9pbmZvIHsKKwkvKiB0aGUgYWN0dWFsIHZpcnRxdWV1ZSAqLworCXN0cnVjdCB2
aXJ0cXVldWUgKnZxOworCisJLyogdGhlIGxpc3Qgbm9kZSBmb3IgdGhlIHZpcnRxdWV1ZXMgbGlz
dCAqLworCXN0cnVjdCBsaXN0X2hlYWQgbm9kZTsKK307CisKK3N0YXRpYyBzdHJ1Y3QgbWRldl9k
ZXZpY2UgKnZtX2dldF9tZGV2KHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2KQoreworCXN0cnVj
dCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2RldiA9IHRvX3ZpcnRpb19tZGV2X2RldmljZSh2ZGV2
KTsKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9kZXYtPm1kZXY7CisKKwlyZXR1cm4g
bWRldjsKK30KKworc3RhdGljIHZvaWQgdmlydGlvX21kZXZfZ2V0KHN0cnVjdCB2aXJ0aW9fZGV2
aWNlICp2ZGV2LCB1bnNpZ25lZCBvZmZzZXQsCisJCQkgICAgdm9pZCAqYnVmLCB1bnNpZ25lZCBs
ZW4pCit7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJ
Y29uc3Qgc3RydWN0IG1kZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRp
b19vcHMobWRldik7CisKKwlvcHMtPmdldF9jb25maWcobWRldiwgb2Zmc2V0LCBidWYsIGxlbik7
Cit9CisKK3N0YXRpYyB2b2lkIHZpcnRpb19tZGV2X3NldChzdHJ1Y3QgdmlydGlvX2RldmljZSAq
dmRldiwgdW5zaWduZWQgb2Zmc2V0LAorCQkJICAgIGNvbnN0IHZvaWQgKmJ1ZiwgdW5zaWduZWQg
bGVuKQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYpOwor
CWNvbnN0IHN0cnVjdCBtZGV2X3ZpcnRpb19kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92aXJ0
aW9fb3BzKG1kZXYpOworCisJb3BzLT5zZXRfY29uZmlnKG1kZXYsIG9mZnNldCwgYnVmLCBsZW4p
OworfQorCitzdGF0aWMgdTMyIHZpcnRpb19tZGV2X2dlbmVyYXRpb24oc3RydWN0IHZpcnRpb19k
ZXZpY2UgKnZkZXYpCit7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYo
dmRldik7CisJY29uc3Qgc3RydWN0IG1kZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZf
Z2V0X3ZpcnRpb19vcHMobWRldik7CisKKwlpZiAob3BzLT5nZXRfZ2VuZXJhdGlvbikKKwkJcmV0
dXJuIG9wcy0+Z2V0X2dlbmVyYXRpb24obWRldik7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGlj
IHU4IHZpcnRpb19tZGV2X2dldF9zdGF0dXMoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7
CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qg
c3RydWN0IG1kZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRpb19vcHMo
bWRldik7CisKKwlyZXR1cm4gb3BzLT5nZXRfc3RhdHVzKG1kZXYpOworfQorCitzdGF0aWMgdm9p
ZCB2aXJ0aW9fbWRldl9zZXRfc3RhdHVzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2LCB1OCBz
dGF0dXMpCit7CisJc3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7
CisJY29uc3Qgc3RydWN0IG1kZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3Zp
cnRpb19vcHMobWRldik7CisKKwlyZXR1cm4gb3BzLT5zZXRfc3RhdHVzKG1kZXYsIHN0YXR1cyk7
Cit9CisKK3N0YXRpYyB2b2lkIHZpcnRpb19tZGV2X3Jlc2V0KHN0cnVjdCB2aXJ0aW9fZGV2aWNl
ICp2ZGV2KQoreworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZkZXYp
OworCWNvbnN0IHN0cnVjdCBtZGV2X3ZpcnRpb19kZXZpY2Vfb3BzICpvcHMgPSBtZGV2X2dldF92
aXJ0aW9fb3BzKG1kZXYpOworCisJcmV0dXJuIG9wcy0+c2V0X3N0YXR1cyhtZGV2LCAwKTsKK30K
Kworc3RhdGljIGJvb2wgdmlydGlvX21kZXZfbm90aWZ5KHN0cnVjdCB2aXJ0cXVldWUgKnZxKQor
eworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2dldF9tZGV2KHZxLT52ZGV2KTsKKwlj
b25zdCBzdHJ1Y3QgbWRldl92aXJ0aW9fZGV2aWNlX29wcyAqb3BzID0gbWRldl9nZXRfdmlydGlv
X29wcyhtZGV2KTsKKworCW9wcy0+a2lja192cShtZGV2LCB2cS0+aW5kZXgpOworCisJcmV0dXJu
IHRydWU7Cit9CisKK3N0YXRpYyBpcnFyZXR1cm5fdCB2aXJ0aW9fbWRldl9jb25maWdfY2Iodm9p
ZCAqcHJpdmF0ZSkKK3sKKwlzdHJ1Y3QgdmlydGlvX21kZXZfZGV2aWNlICp2bV9kZXYgPSBwcml2
YXRlOworCisJdmlydGlvX2NvbmZpZ19jaGFuZ2VkKCZ2bV9kZXYtPnZkZXYpOworCisJcmV0dXJu
IElSUV9IQU5ETEVEOworfQorCitzdGF0aWMgaXJxcmV0dXJuX3QgdmlydGlvX21kZXZfdmlydHF1
ZXVlX2NiKHZvaWQgKnByaXZhdGUpCit7CisJc3RydWN0IHZpcnRpb19tZGV2X3ZxX2luZm8gKmlu
Zm8gPSBwcml2YXRlOworCisJcmV0dXJuIHZyaW5nX2ludGVycnVwdCgwLCBpbmZvLT52cSk7Cit9
CisKK3N0YXRpYyBzdHJ1Y3QgdmlydHF1ZXVlICoKK3ZpcnRpb19tZGV2X3NldHVwX3ZxKHN0cnVj
dCB2aXJ0aW9fZGV2aWNlICp2ZGV2LCB1bnNpZ25lZCBpbnQgaW5kZXgsCisJCSAgICAgdm9pZCAo
KmNhbGxiYWNrKShzdHJ1Y3QgdmlydHF1ZXVlICp2cSksCisJCSAgICAgY29uc3QgY2hhciAqbmFt
ZSwgYm9vbCBjdHgpCit7CisJc3RydWN0IHZpcnRpb19tZGV2X2RldmljZSAqdm1fZGV2ID0gdG9f
dmlydGlvX21kZXZfZGV2aWNlKHZkZXYpOworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZt
X2dldF9tZGV2KHZkZXYpOworCWNvbnN0IHN0cnVjdCBtZGV2X3ZpcnRpb19kZXZpY2Vfb3BzICpv
cHMgPSBtZGV2X2dldF92aXJ0aW9fb3BzKG1kZXYpOworCXN0cnVjdCB2aXJ0aW9fbWRldl92cV9p
bmZvICppbmZvOworCXN0cnVjdCB2aXJ0aW9fbWRldl9jYWxsYmFjayBjYjsKKwlzdHJ1Y3Qgdmly
dHF1ZXVlICp2cTsKKwl1NjQgZGVzY19hZGRyLCBkcml2ZXJfYWRkciwgZGV2aWNlX2FkZHI7CisJ
dW5zaWduZWQgbG9uZyBmbGFnczsKKwl1MzIgYWxpZ24sIG51bTsKKwlpbnQgZXJyOworCisJaWYg
KCFuYW1lKQorCQlyZXR1cm4gTlVMTDsKKworCS8qIFF1ZXVlIHNob3VsZG4ndCBhbHJlYWR5IGJl
IHNldCB1cC4gKi8KKwlpZiAob3BzLT5nZXRfdnFfcmVhZHkobWRldiwgaW5kZXgpKQorCQlyZXR1
cm4gRVJSX1BUUigtRU5PRU5UKTsKKworCS8qIEFsbG9jYXRlIGFuZCBmaWxsIG91dCBvdXIgYWN0
aXZlIHF1ZXVlIGRlc2NyaXB0aW9uICovCisJaW5mbyA9IGttYWxsb2Moc2l6ZW9mKCppbmZvKSwg
R0ZQX0tFUk5FTCk7CisJaWYgKCFpbmZvKQorCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKKwor
CW51bSA9IG9wcy0+Z2V0X3ZxX251bV9tYXgobWRldik7CisJaWYgKG51bSA9PSAwKSB7CisJCWVy
ciA9IC1FTk9FTlQ7CisJCWdvdG8gZXJyb3JfbmV3X3ZpcnRxdWV1ZTsKKwl9CisKKwkvKiBDcmVh
dGUgdGhlIHZyaW5nICovCisJYWxpZ24gPSBvcHMtPmdldF92cV9hbGlnbihtZGV2KTsKKwl2cSA9
IHZyaW5nX2NyZWF0ZV92aXJ0cXVldWUoaW5kZXgsIG51bSwgYWxpZ24sIHZkZXYsCisJCQkJICAg
IHRydWUsIHRydWUsIGN0eCwKKwkJCQkgICAgdmlydGlvX21kZXZfbm90aWZ5LCBjYWxsYmFjaywg
bmFtZSk7CisJaWYgKCF2cSkgeworCQllcnIgPSAtRU5PTUVNOworCQlnb3RvIGVycm9yX25ld192
aXJ0cXVldWU7CisJfQorCisJLyogU2V0dXAgdmlydHF1ZXVlIGNhbGxiYWNrICovCisJY2IuY2Fs
bGJhY2sgPSB2aXJ0aW9fbWRldl92aXJ0cXVldWVfY2I7CisJY2IucHJpdmF0ZSA9IGluZm87CisJ
b3BzLT5zZXRfdnFfY2IobWRldiwgaW5kZXgsICZjYik7CisJb3BzLT5zZXRfdnFfbnVtKG1kZXYs
IGluZGV4LCB2aXJ0cXVldWVfZ2V0X3ZyaW5nX3NpemUodnEpKTsKKworCWRlc2NfYWRkciA9IHZp
cnRxdWV1ZV9nZXRfZGVzY19hZGRyKHZxKTsKKwlkcml2ZXJfYWRkciA9IHZpcnRxdWV1ZV9nZXRf
YXZhaWxfYWRkcih2cSk7CisJZGV2aWNlX2FkZHIgPSB2aXJ0cXVldWVfZ2V0X3VzZWRfYWRkcih2
cSk7CisKKwlpZiAob3BzLT5zZXRfdnFfYWRkcmVzcyhtZGV2LCBpbmRleCwKKwkJCQlkZXNjX2Fk
ZHIsIGRyaXZlcl9hZGRyLAorCQkJCWRldmljZV9hZGRyKSkgeworCQllcnIgPSAtRUlOVkFMOwor
CQlnb3RvIGVycl92cTsKKwl9CisKKwlvcHMtPnNldF92cV9yZWFkeShtZGV2LCBpbmRleCwgMSk7
CisKKwl2cS0+cHJpdiA9IGluZm87CisJaW5mby0+dnEgPSB2cTsKKworCXNwaW5fbG9ja19pcnFz
YXZlKCZ2bV9kZXYtPmxvY2ssIGZsYWdzKTsKKwlsaXN0X2FkZCgmaW5mby0+bm9kZSwgJnZtX2Rl
di0+dmlydHF1ZXVlcyk7CisJc3Bpbl91bmxvY2tfaXJxcmVzdG9yZSgmdm1fZGV2LT5sb2NrLCBm
bGFncyk7CisKKwlyZXR1cm4gdnE7CisKK2Vycl92cToKKwl2cmluZ19kZWxfdmlydHF1ZXVlKHZx
KTsKK2Vycm9yX25ld192aXJ0cXVldWU6CisJb3BzLT5zZXRfdnFfcmVhZHkobWRldiwgaW5kZXgs
IDApOworCVdBUk5fT04ob3BzLT5nZXRfdnFfcmVhZHkobWRldiwgaW5kZXgpKTsKKwlrZnJlZShp
bmZvKTsKKwlyZXR1cm4gRVJSX1BUUihlcnIpOworfQorCitzdGF0aWMgdm9pZCB2aXJ0aW9fbWRl
dl9kZWxfdnEoc3RydWN0IHZpcnRxdWV1ZSAqdnEpCit7CisJc3RydWN0IHZpcnRpb19tZGV2X2Rl
dmljZSAqdm1fZGV2ID0gdG9fdmlydGlvX21kZXZfZGV2aWNlKHZxLT52ZGV2KTsKKwlzdHJ1Y3Qg
bWRldl9kZXZpY2UgKm1kZXYgPSB2bV9kZXYtPm1kZXY7CisJY29uc3Qgc3RydWN0IG1kZXZfdmly
dGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRpb19vcHMobWRldik7CisJc3RydWN0
IHZpcnRpb19tZGV2X3ZxX2luZm8gKmluZm8gPSB2cS0+cHJpdjsKKwl1bnNpZ25lZCBpbnQgaW5k
ZXggPSB2cS0+aW5kZXg7CisJdW5zaWduZWQgbG9uZyBmbGFnczsKKworCXNwaW5fbG9ja19pcnFz
YXZlKCZ2bV9kZXYtPmxvY2ssIGZsYWdzKTsKKwlsaXN0X2RlbCgmaW5mby0+bm9kZSk7CisJc3Bp
bl91bmxvY2tfaXJxcmVzdG9yZSgmdm1fZGV2LT5sb2NrLCBmbGFncyk7CisKKwkvKiBTZWxlY3Qg
YW5kIGRlYWN0aXZhdGUgdGhlIHF1ZXVlICovCisJb3BzLT5zZXRfdnFfcmVhZHkobWRldiwgaW5k
ZXgsIDApOworCVdBUk5fT04ob3BzLT5nZXRfdnFfcmVhZHkobWRldiwgaW5kZXgpKTsKKworCXZy
aW5nX2RlbF92aXJ0cXVldWUodnEpOworCisJa2ZyZWUoaW5mbyk7Cit9CisKK3N0YXRpYyB2b2lk
IHZpcnRpb19tZGV2X2RlbF92cXMoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7CisJc3Ry
dWN0IHZpcnRxdWV1ZSAqdnEsICpuOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKHZxLCBu
LCAmdmRldi0+dnFzLCBsaXN0KQorCQl2aXJ0aW9fbWRldl9kZWxfdnEodnEpOworfQorCitzdGF0
aWMgaW50IHZpcnRpb19tZGV2X2ZpbmRfdnFzKHN0cnVjdCB2aXJ0aW9fZGV2aWNlICp2ZGV2LCB1
bnNpZ25lZCBudnFzLAorCQkJCXN0cnVjdCB2aXJ0cXVldWUgKnZxc1tdLAorCQkJCXZxX2NhbGxi
YWNrX3QgKmNhbGxiYWNrc1tdLAorCQkJCWNvbnN0IGNoYXIgKiBjb25zdCBuYW1lc1tdLAorCQkJ
CWNvbnN0IGJvb2wgKmN0eCwKKwkJCQlzdHJ1Y3QgaXJxX2FmZmluaXR5ICpkZXNjKQoreworCXN0
cnVjdCB2aXJ0aW9fbWRldl9kZXZpY2UgKnZtX2RldiA9IHRvX3ZpcnRpb19tZGV2X2RldmljZSh2
ZGV2KTsKKwlzdHJ1Y3QgbWRldl9kZXZpY2UgKm1kZXYgPSB2bV9nZXRfbWRldih2ZGV2KTsKKwlj
b25zdCBzdHJ1Y3QgbWRldl92aXJ0aW9fZGV2aWNlX29wcyAqb3BzID0gbWRldl9nZXRfdmlydGlv
X29wcyhtZGV2KTsKKwlzdHJ1Y3QgdmlydGlvX21kZXZfY2FsbGJhY2sgY2I7CisJaW50IGksIGVy
ciwgcXVldWVfaWR4ID0gMDsKKworCWZvciAoaSA9IDA7IGkgPCBudnFzOyArK2kpIHsKKwkJaWYg
KCFuYW1lc1tpXSkgeworCQkJdnFzW2ldID0gTlVMTDsKKwkJCWNvbnRpbnVlOworCQl9CisKKwkJ
dnFzW2ldID0gdmlydGlvX21kZXZfc2V0dXBfdnEodmRldiwgcXVldWVfaWR4KyssCisJCQkJCSAg
ICAgIGNhbGxiYWNrc1tpXSwgbmFtZXNbaV0sIGN0eCA/CisJCQkJCSAgICAgIGN0eFtpXSA6IGZh
bHNlKTsKKwkJaWYgKElTX0VSUih2cXNbaV0pKSB7CisJCQllcnIgPSBQVFJfRVJSKHZxc1tpXSk7
CisJCQlnb3RvIGVycl9zZXR1cF92cTsKKwkJfQorCX0KKworCWNiLmNhbGxiYWNrID0gdmlydGlv
X21kZXZfY29uZmlnX2NiOworCWNiLnByaXZhdGUgPSB2bV9kZXY7CisJb3BzLT5zZXRfY29uZmln
X2NiKG1kZXYsICZjYik7CisKKwlyZXR1cm4gMDsKKworZXJyX3NldHVwX3ZxOgorCXZpcnRpb19t
ZGV2X2RlbF92cXModmRldik7CisJcmV0dXJuIGVycjsKK30KKworc3RhdGljIHU2NCB2aXJ0aW9f
bWRldl9nZXRfZmVhdHVyZXMoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7CisJc3RydWN0
IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3RydWN0IG1k
ZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRpb19vcHMobWRldik7CisK
KwlyZXR1cm4gb3BzLT5nZXRfZmVhdHVyZXMobWRldik7Cit9CisKK3N0YXRpYyBpbnQgdmlydGlv
X21kZXZfZmluYWxpemVfZmVhdHVyZXMoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7CisJ
c3RydWN0IG1kZXZfZGV2aWNlICptZGV2ID0gdm1fZ2V0X21kZXYodmRldik7CisJY29uc3Qgc3Ry
dWN0IG1kZXZfdmlydGlvX2RldmljZV9vcHMgKm9wcyA9IG1kZXZfZ2V0X3ZpcnRpb19vcHMobWRl
dik7CisKKwkvKiBHaXZlIHZpcnRpb19yaW5nIGEgY2hhbmNlIHRvIGFjY2VwdCBmZWF0dXJlcy4g
Ki8KKwl2cmluZ190cmFuc3BvcnRfZmVhdHVyZXModmRldik7CisKKwlyZXR1cm4gb3BzLT5zZXRf
ZmVhdHVyZXMobWRldiwgdmRldi0+ZmVhdHVyZXMpOworfQorCitzdGF0aWMgY29uc3QgY2hhciAq
dmlydGlvX21kZXZfYnVzX25hbWUoc3RydWN0IHZpcnRpb19kZXZpY2UgKnZkZXYpCit7CisJc3Ry
dWN0IHZpcnRpb19tZGV2X2RldmljZSAqdm1fZGV2ID0gdG9fdmlydGlvX21kZXZfZGV2aWNlKHZk
ZXYpOworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2Rldi0+bWRldjsKKworCXJldHVy
biBkZXZfbmFtZShtZGV2X2RldihtZGV2KSk7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3Qgdmly
dGlvX2NvbmZpZ19vcHMgdmlydGlvX21kZXZfY29uZmlnX29wcyA9IHsKKwkuZ2V0CQk9IHZpcnRp
b19tZGV2X2dldCwKKwkuc2V0CQk9IHZpcnRpb19tZGV2X3NldCwKKwkuZ2VuZXJhdGlvbgk9IHZp
cnRpb19tZGV2X2dlbmVyYXRpb24sCisJLmdldF9zdGF0dXMJPSB2aXJ0aW9fbWRldl9nZXRfc3Rh
dHVzLAorCS5zZXRfc3RhdHVzCT0gdmlydGlvX21kZXZfc2V0X3N0YXR1cywKKwkucmVzZXQJCT0g
dmlydGlvX21kZXZfcmVzZXQsCisJLmZpbmRfdnFzCT0gdmlydGlvX21kZXZfZmluZF92cXMsCisJ
LmRlbF92cXMJPSB2aXJ0aW9fbWRldl9kZWxfdnFzLAorCS5nZXRfZmVhdHVyZXMJPSB2aXJ0aW9f
bWRldl9nZXRfZmVhdHVyZXMsCisJLmZpbmFsaXplX2ZlYXR1cmVzID0gdmlydGlvX21kZXZfZmlu
YWxpemVfZmVhdHVyZXMsCisJLmJ1c19uYW1lCT0gdmlydGlvX21kZXZfYnVzX25hbWUsCit9Owor
CitzdGF0aWMgdm9pZCB2aXJ0aW9fbWRldl9yZWxlYXNlX2RldihzdHJ1Y3QgZGV2aWNlICpfZCkK
K3sKKwlzdHJ1Y3QgdmlydGlvX2RldmljZSAqdmRldiA9CisJICAgICAgIGNvbnRhaW5lcl9vZihf
ZCwgc3RydWN0IHZpcnRpb19kZXZpY2UsIGRldik7CisJc3RydWN0IHZpcnRpb19tZGV2X2Rldmlj
ZSAqdm1fZGV2ID0KKwkgICAgICAgY29udGFpbmVyX29mKHZkZXYsIHN0cnVjdCB2aXJ0aW9fbWRl
dl9kZXZpY2UsIHZkZXYpOworCXN0cnVjdCBtZGV2X2RldmljZSAqbWRldiA9IHZtX2Rldi0+bWRl
djsKKworCWRldm1fa2ZyZWUobWRldl9kZXYobWRldiksIHZtX2Rldik7Cit9CisKK3N0YXRpYyBp
bnQgdmlydGlvX21kZXZfcHJvYmUoc3RydWN0IGRldmljZSAqZGV2KQoreworCXN0cnVjdCBtZGV2
X2RldmljZSAqbWRldiA9IG1kZXZfZnJvbV9kZXYoZGV2KTsKKwljb25zdCBzdHJ1Y3QgbWRldl92
aXJ0aW9fZGV2aWNlX29wcyAqb3BzID0gbWRldl9nZXRfdmlydGlvX29wcyhtZGV2KTsKKwlzdHJ1
Y3QgdmlydGlvX21kZXZfZGV2aWNlICp2bV9kZXY7CisJaW50IHJjOworCisJdm1fZGV2ID0gZGV2
bV9remFsbG9jKGRldiwgc2l6ZW9mKCp2bV9kZXYpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIXZtX2Rl
dikKKwkJcmV0dXJuIC1FTk9NRU07CisKKwl2bV9kZXYtPnZkZXYuZGV2LnBhcmVudCA9IGRldjsK
Kwl2bV9kZXYtPnZkZXYuZGV2LnJlbGVhc2UgPSB2aXJ0aW9fbWRldl9yZWxlYXNlX2RldjsKKwl2
bV9kZXYtPnZkZXYuY29uZmlnID0gJnZpcnRpb19tZGV2X2NvbmZpZ19vcHM7CisJdm1fZGV2LT5t
ZGV2ID0gbWRldjsKKwlJTklUX0xJU1RfSEVBRCgmdm1fZGV2LT52aXJ0cXVldWVzKTsKKwlzcGlu
X2xvY2tfaW5pdCgmdm1fZGV2LT5sb2NrKTsKKworCXZtX2Rldi0+dmRldi5pZC5kZXZpY2UgPSBv
cHMtPmdldF9kZXZpY2VfaWQobWRldik7CisJaWYgKHZtX2Rldi0+dmRldi5pZC5kZXZpY2UgPT0g
MCkKKwkJcmV0dXJuIC1FTk9ERVY7CisKKwl2bV9kZXYtPnZkZXYuaWQudmVuZG9yID0gb3BzLT5n
ZXRfdmVuZG9yX2lkKG1kZXYpOworCXJjID0gcmVnaXN0ZXJfdmlydGlvX2RldmljZSgmdm1fZGV2
LT52ZGV2KTsKKwlpZiAocmMpCisJCXB1dF9kZXZpY2UoZGV2KTsKKwllbHNlCisJCWRldl9zZXRf
ZHJ2ZGF0YShkZXYsIHZtX2Rldik7CisKKwlyZXR1cm4gcmM7Cit9CisKK3N0YXRpYyB2b2lkIHZp
cnRpb19tZGV2X3JlbW92ZShzdHJ1Y3QgZGV2aWNlICpkZXYpCit7CisJc3RydWN0IHZpcnRpb19t
ZGV2X2RldmljZSAqdm1fZGV2ID0gZGV2X2dldF9kcnZkYXRhKGRldik7CisKKwl1bnJlZ2lzdGVy
X3ZpcnRpb19kZXZpY2UoJnZtX2Rldi0+dmRldik7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3Qg
bWRldl9jbGFzc19pZCB2aXJ0aW9faWRfdGFibGVbXSA9IHsKKwl7IE1ERVZfQ0xBU1NfSURfVklS
VElPIH0sCisJeyAwIH0sCit9OworCitNT0RVTEVfREVWSUNFX1RBQkxFKG1kZXYsIHZpcnRpb19p
ZF90YWJsZSk7CisKK3N0YXRpYyBzdHJ1Y3QgbWRldl9kcml2ZXIgdmlydGlvX21kZXZfZHJpdmVy
ID0geworCS5uYW1lCT0gInZpcnRpb19tZGV2IiwKKwkucHJvYmUJPSB2aXJ0aW9fbWRldl9wcm9i
ZSwKKwkucmVtb3ZlID0gdmlydGlvX21kZXZfcmVtb3ZlLAorCS5pZF90YWJsZSA9IHZpcnRpb19p
ZF90YWJsZSwKK307CisKK3N0YXRpYyBpbnQgX19pbml0IHZpcnRpb19tZGV2X2luaXQodm9pZCkK
K3sKKwlyZXR1cm4gbWRldl9yZWdpc3Rlcl9kcml2ZXIoJnZpcnRpb19tZGV2X2RyaXZlciwgVEhJ
U19NT0RVTEUpOworfQorCitzdGF0aWMgdm9pZCBfX2V4aXQgdmlydGlvX21kZXZfZXhpdCh2b2lk
KQoreworCW1kZXZfdW5yZWdpc3Rlcl9kcml2ZXIoJnZpcnRpb19tZGV2X2RyaXZlcik7Cit9CisK
K21vZHVsZV9pbml0KHZpcnRpb19tZGV2X2luaXQpCittb2R1bGVfZXhpdCh2aXJ0aW9fbWRldl9l
eGl0KQorCitNT0RVTEVfVkVSU0lPTihEUklWRVJfVkVSU0lPTik7CitNT0RVTEVfTElDRU5TRSgi
R1BMIHYyIik7CitNT0RVTEVfQVVUSE9SKERSSVZFUl9BVVRIT1IpOworTU9EVUxFX0RFU0NSSVBU
SU9OKERSSVZFUl9ERVNDKTsKLS0gCjIuMTkuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4v
bGlzdGluZm8vZHJpLWRldmVs
