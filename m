Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 4F97D6030E
	for <lists+dri-devel@lfdr.de>; Fri,  5 Jul 2019 11:26:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 1DCD56E029;
	Fri,  5 Jul 2019 09:26:20 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 by gabe.freedesktop.org (Postfix) with ESMTPS id EA3176E457
 for <dri-devel@lists.freedesktop.org>; Fri,  5 Jul 2019 09:26:18 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 4986BAE15;
 Fri,  5 Jul 2019 09:26:17 +0000 (UTC)
From: Thomas Zimmermann <tzimmermann@suse.de>
To: airlied@redhat.com, daniel@ffwll.ch, kraxel@redhat.com,
 maarten.lankhorst@linux.intel.com, maxime.ripard@bootlin.com,
 sean@poorly.run, noralf@tronnes.org, sam@ravnborg.org,
 yc_chen@aspeedtech.com
Subject: [PATCH v2 2/6] drm/fb-helper: Map DRM client buffer only when required
Date: Fri,  5 Jul 2019 11:26:09 +0200
Message-Id: <20190705092613.7621-3-tzimmermann@suse.de>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190705092613.7621-1-tzimmermann@suse.de>
References: <20190705092613.7621-1-tzimmermann@suse.de>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Thomas Zimmermann <tzimmermann@suse.de>, dri-devel@lists.freedesktop.org,
 virtualization@lists.linux-foundation.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBjaGFuZ2VzIERSTSBjbGllbnRzIHRvIG5vdCBtYXAgdGhlIGJ1ZmZlciBieSBk
ZWZhdWx0LiBUaGUKYnVmZmVyLCBsaWtlIGFueSBidWZmZXIgb2JqZWN0LCBzaG91bGQgYmUgbWFw
cGVkIGFuZCB1bm1hcHBlZCB3aGVuCm5lZWRlZC4KCkFuIHVubWFwcGVkIGJ1ZmZlciBvYmplY3Qg
Y2FuIGJlIGV2aWN0ZWQgdG8gc3lzdGVtIG1lbW9yeSBhbmQgZG9lcwpub3QgY29uc3VtZSB2aWRl
byByYW0gdW50aWwgZGlzcGxheWVkLiBUaGlzIGFsbG93cyB0byB1c2UgZ2VuZXJpYyBmYmRldgpl
bXVsYXRpb24gd2l0aCBkcml2ZXJzIGZvciBsb3ctbWVtb3J5IGRldmljZXMsIHN1Y2ggYXMgYXN0
IGFuZCBtZ2FnMjAwLgoKVGhpcyBjaGFuZ2UgYWZmZWN0cyB0aGUgZ2VuZXJpYyBmcmFtZWJ1ZmZl
ciBjb25zb2xlLiBIVy1iYXNlZCBjb25zb2xlcwptYXAgdGhlaXIgY29uc29sZSBidWZmZXIgb25j
ZSBhbmQga2VlcCBpdCBtYXBwZWQuIFVzZXJzcGFjZSBjYW4gbW1hcCB0aGlzCmJ1ZmZlciBpbnRv
IGl0cyBhZGRyZXNzIHNwYWNlLiBUaGUgc2hhZG93LWJ1ZmZlcmVkIGZyYW1lYnVmZmVyIGNvbnNv
bGUKb25seSBuZWVkcyB0aGUgYnVmZmVyIG9iamVjdCB0byBiZSBtYXBwZWQgZHVyaW5nIHVwZGF0
ZXMuIFdoaWxlIG5vdCBiZWluZwp1cGRhdGVkIGZyb20gdGhlIHNoYWRvdyBidWZmZXIsIHRoZSBi
dWZmZXIgb2JqZWN0IGNhbiByZW1haW4gdW5tYXBwZWQuClVzZXJzcGFjZSB3aWxsIGFsd2F5cyBt
bWFwIHRoZSBzaGFkb3cgYnVmZmVyLgoKdjI6CgkqIGNoYW5nZSBEUk0gY2xpZW50IHRvIG5vdCBt
YXAgYnVmZmVyIGJ5IGRlZmF1bHQKCSogbWFudWFsbHkgbWFwIGNsaWVudCBidWZmZXIgZm9yIGZi
ZGV2IHdpdGggSFcgZnJhbWVidWZmZXIKClNpZ25lZC1vZmYtYnk6IFRob21hcyBaaW1tZXJtYW5u
IDx0emltbWVybWFubkBzdXNlLmRlPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9kcm1fY2xpZW50LmMg
ICAgfCAxNiArKysrLS0tLS0tLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vZHJtX2ZiX2hlbHBlci5j
IHwgMzMgKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQs
IDI5IGluc2VydGlvbnMoKyksIDIwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9kcm1fY2xpZW50LmMgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2NsaWVudC5jCmluZGV4
IDY2ZDhkNjQ1YWM3OS4uN2QyM2M4MzRmNTAzIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
ZHJtX2NsaWVudC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fY2xpZW50LmMKQEAgLTI1NCw3
ICsyNTQsNiBAQCBkcm1fY2xpZW50X2J1ZmZlcl9jcmVhdGUoc3RydWN0IGRybV9jbGllbnRfZGV2
ICpjbGllbnQsIHUzMiB3aWR0aCwgdTMyIGhlaWdodCwgdQogCXN0cnVjdCBkcm1fZGV2aWNlICpk
ZXYgPSBjbGllbnQtPmRldjsKIAlzdHJ1Y3QgZHJtX2NsaWVudF9idWZmZXIgKmJ1ZmZlcjsKIAlz
dHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iajsKLQl2b2lkICp2YWRkcjsKIAlpbnQgcmV0OwogCiAJ
YnVmZmVyID0ga3phbGxvYyhzaXplb2YoKmJ1ZmZlciksIEdGUF9LRVJORUwpOwpAQCAtMjgxLDEy
ICsyODAsNiBAQCBkcm1fY2xpZW50X2J1ZmZlcl9jcmVhdGUoc3RydWN0IGRybV9jbGllbnRfZGV2
ICpjbGllbnQsIHUzMiB3aWR0aCwgdTMyIGhlaWdodCwgdQogCiAJYnVmZmVyLT5nZW0gPSBvYmo7
CiAKLQl2YWRkciA9IGRybV9jbGllbnRfYnVmZmVyX3ZtYXAoYnVmZmVyKTsKLQlpZiAoSVNfRVJS
KHZhZGRyKSkgewotCQlyZXQgPSBQVFJfRVJSKHZhZGRyKTsKLQkJZ290byBlcnJfZGVsZXRlOwot
CX0KLQogCXJldHVybiBidWZmZXI7CiAKIGVycl9kZWxldGU6CkBAIC0zMDUsNyArMjk4LDcgQEAg
ZHJtX2NsaWVudF9idWZmZXJfY3JlYXRlKHN0cnVjdCBkcm1fY2xpZW50X2RldiAqY2xpZW50LCB1
MzIgd2lkdGgsIHUzMiBoZWlnaHQsIHUKICAqIENsaWVudCBidWZmZXIgbWFwcGluZ3MgYXJlIG5v
dCByZWYnY291bnRlZC4gRWFjaCBjYWxsIHRvCiAgKiBkcm1fY2xpZW50X2J1ZmZlcl92bWFwKCkg
c2hvdWxkIGJlIGZvbGxvd2VkIGJ5IGEgY2FsbCB0bwogICogZHJtX2NsaWVudF9idWZmZXJfdnVu
bWFwKCk7IG9yIHRoZSBjbGllbnQgYnVmZmVyIHNob3VsZCBiZSBtYXBwZWQKLSAqIHRocm91Z2hv
dXQgaXRzIGxpZmV0aW1lLiBUaGUgbGF0dGVyIGlzIHRoZSBkZWZhdWx0LgorICogdGhyb3VnaG91
dCBpdHMgbGlmZXRpbWUuCiAgKgogICogUmV0dXJuczoKICAqCVRoZSBtYXBwZWQgbWVtb3J5J3Mg
YWRkcmVzcwpAQCAtMzQwLDEwICszMzMsOSBAQCBFWFBPUlRfU1lNQk9MKGRybV9jbGllbnRfYnVm
ZmVyX3ZtYXApOwogICogZHJtX2NsaWVudF9idWZmZXJfdnVubWFwIC0gVW5tYXAgRFJNIGNsaWVu
dCBidWZmZXIKICAqIEBidWZmZXI6IERSTSBjbGllbnQgYnVmZmVyCiAgKgotICogVGhpcyBmdW5j
dGlvbiByZW1vdmVzIGEgY2xpZW50IGJ1ZmZlcidzIG1lbW9yeSBtbWFwcGluZy4gVGhpcwotICog
ZnVuY3Rpb24gaXMgb25seSByZXF1aXJlZCBieSBjbGllbnRzIHRoYXQgbWFuYWdlIHRoZWlyIGJ1
ZmZlcnMKLSAqIGJ5IHRoZW1zZWx2ZXMuIEJ5IGRlZmF1bHQsIERSTSBjbGllbnQgYnVmZmVycyBh
cmUgbWFwcGVkIHRocm91Z2hvdXQKLSAqIHRoZWlyIGVudGlyZSBsaWZldGltZS4KKyAqIFRoaXMg
ZnVuY3Rpb24gcmVtb3ZlcyBhIGNsaWVudCBidWZmZXIncyBtZW1vcnkgbW1hcHBpbmcuIENhbGxp
bmcgdGhpcworICogZnVuY3Rpb24gaXMgb25seSByZXF1aXJlZCBieSBjbGllbnRzIHRoYXQgbWFu
YWdlIHRoZWlyIGJ1ZmZlciBtYXBwaW5ncworICogYnkgdGhlbXNlbHZlcy4KICAqLwogdm9pZCBk
cm1fY2xpZW50X2J1ZmZlcl92dW5tYXAoc3RydWN0IGRybV9jbGllbnRfYnVmZmVyICpidWZmZXIp
CiB7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2ZiX2hlbHBlci5jIGIvZHJpdmVy
cy9ncHUvZHJtL2RybV9mYl9oZWxwZXIuYwppbmRleCAxOTg0ZTVjNTRkNTguLjdiYTZhMDI1NTgy
MSAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2RybV9mYl9oZWxwZXIuYworKysgYi9kcml2
ZXJzL2dwdS9kcm0vZHJtX2ZiX2hlbHBlci5jCkBAIC00MDMsNiArNDAzLDcgQEAgc3RhdGljIHZv
aWQgZHJtX2ZiX2hlbHBlcl9kaXJ0eV93b3JrKHN0cnVjdCB3b3JrX3N0cnVjdCAqd29yaykKIAlz
dHJ1Y3QgZHJtX2NsaXBfcmVjdCAqY2xpcCA9ICZoZWxwZXItPmRpcnR5X2NsaXA7CiAJc3RydWN0
IGRybV9jbGlwX3JlY3QgY2xpcF9jb3B5OwogCXVuc2lnbmVkIGxvbmcgZmxhZ3M7CisJdm9pZCAq
dmFkZHI7CiAKIAlzcGluX2xvY2tfaXJxc2F2ZSgmaGVscGVyLT5kaXJ0eV9sb2NrLCBmbGFncyk7
CiAJY2xpcF9jb3B5ID0gKmNsaXA7CkBAIC00MTIsMTAgKzQxMywxOCBAQCBzdGF0aWMgdm9pZCBk
cm1fZmJfaGVscGVyX2RpcnR5X3dvcmsoc3RydWN0IHdvcmtfc3RydWN0ICp3b3JrKQogCiAJLyog
Y2FsbCBkaXJ0eSBjYWxsYmFjayBvbmx5IHdoZW4gaXQgaGFzIGJlZW4gcmVhbGx5IHRvdWNoZWQg
Ki8KIAlpZiAoY2xpcF9jb3B5LngxIDwgY2xpcF9jb3B5LngyICYmIGNsaXBfY29weS55MSA8IGNs
aXBfY29weS55MikgeworCiAJCS8qIEdlbmVyaWMgZmJkZXYgdXNlcyBhIHNoYWRvdyBidWZmZXIg
Ki8KLQkJaWYgKGhlbHBlci0+YnVmZmVyKQorCQlpZiAoaGVscGVyLT5idWZmZXIpIHsKKwkJCXZh
ZGRyID0gZHJtX2NsaWVudF9idWZmZXJfdm1hcChoZWxwZXItPmJ1ZmZlcik7CisJCQlpZiAoSVNf
RVJSKHZhZGRyKSkKKwkJCQlyZXR1cm47CiAJCQlkcm1fZmJfaGVscGVyX2RpcnR5X2JsaXRfcmVh
bChoZWxwZXIsICZjbGlwX2NvcHkpOworCQl9CiAJCWhlbHBlci0+ZmItPmZ1bmNzLT5kaXJ0eSho
ZWxwZXItPmZiLCBOVUxMLCAwLCAwLCAmY2xpcF9jb3B5LCAxKTsKKworCQlpZiAoaGVscGVyLT5i
dWZmZXIpCisJCQlkcm1fY2xpZW50X2J1ZmZlcl92dW5tYXAoaGVscGVyLT5idWZmZXIpOwogCX0K
IH0KIApAQCAtMjE3OCw2ICsyMTg3LDcgQEAgaW50IGRybV9mYl9oZWxwZXJfZ2VuZXJpY19wcm9i
ZShzdHJ1Y3QgZHJtX2ZiX2hlbHBlciAqZmJfaGVscGVyLAogCXN0cnVjdCBkcm1fZnJhbWVidWZm
ZXIgKmZiOwogCXN0cnVjdCBmYl9pbmZvICpmYmk7CiAJdTMyIGZvcm1hdDsKKwl2b2lkICp2YWRk
cjsKIAogCURSTV9ERUJVR19LTVMoInN1cmZhY2Ugd2lkdGgoJWQpLCBoZWlnaHQoJWQpIGFuZCBi
cHAoJWQpXG4iLAogCQkgICAgICBzaXplcy0+c3VyZmFjZV93aWR0aCwgc2l6ZXMtPnN1cmZhY2Vf
aGVpZ2h0LApAQCAtMjIwMCwxMyArMjIxMCw3IEBAIGludCBkcm1fZmJfaGVscGVyX2dlbmVyaWNf
cHJvYmUoc3RydWN0IGRybV9mYl9oZWxwZXIgKmZiX2hlbHBlciwKIAlmYmktPmZib3BzID0gJmRy
bV9mYmRldl9mYl9vcHM7CiAJZmJpLT5zY3JlZW5fc2l6ZSA9IGZiLT5oZWlnaHQgKiBmYi0+cGl0
Y2hlc1swXTsKIAlmYmktPmZpeC5zbWVtX2xlbiA9IGZiaS0+c2NyZWVuX3NpemU7Ci0JZmJpLT5z
Y3JlZW5fYnVmZmVyID0gYnVmZmVyLT52YWRkcjsKLQkvKiBTaGFtZWxlc3NseSBsZWFrIHRoZSBw
aHlzaWNhbCBhZGRyZXNzIHRvIHVzZXItc3BhY2UgKi8KLSNpZiBJU19FTkFCTEVEKENPTkZJR19E
Uk1fRkJERVZfTEVBS19QSFlTX1NNRU0pCi0JaWYgKGRybV9sZWFrX2ZiZGV2X3NtZW0gJiYgZmJp
LT5maXguc21lbV9zdGFydCA9PSAwKQotCQlmYmktPmZpeC5zbWVtX3N0YXJ0ID0KLQkJCXBhZ2Vf
dG9fcGh5cyh2aXJ0X3RvX3BhZ2UoZmJpLT5zY3JlZW5fYnVmZmVyKSk7Ci0jZW5kaWYKKwogCWRy
bV9mYl9oZWxwZXJfZmlsbF9pbmZvKGZiaSwgZmJfaGVscGVyLCBzaXplcyk7CiAKIAlpZiAoZmIt
PmZ1bmNzLT5kaXJ0eSkgewpAQCAtMjIzMSw2ICsyMjM1LDE5IEBAIGludCBkcm1fZmJfaGVscGVy
X2dlbmVyaWNfcHJvYmUoc3RydWN0IGRybV9mYl9oZWxwZXIgKmZiX2hlbHBlciwKIAkJZmJpLT5m
YmRlZmlvID0gJmRybV9mYmRldl9kZWZpbzsKIAogCQlmYl9kZWZlcnJlZF9pb19pbml0KGZiaSk7
CisJfSBlbHNlIHsKKwkJLyogYnVmZmVyIGlzIG1hcHBlZCBmb3IgSFcgZnJhbWVidWZmZXIgKi8K
KwkJdmFkZHIgPSBkcm1fY2xpZW50X2J1ZmZlcl92bWFwKGZiX2hlbHBlci0+YnVmZmVyKTsKKwkJ
aWYgKElTX0VSUih2YWRkcikpCisJCQlyZXR1cm4gUFRSX0VSUih2YWRkcik7CisKKwkJZmJpLT5z
Y3JlZW5fYnVmZmVyID0gdmFkZHI7CisJCS8qIFNoYW1lbGVzc2x5IGxlYWsgdGhlIHBoeXNpY2Fs
IGFkZHJlc3MgdG8gdXNlci1zcGFjZSAqLworI2lmIElTX0VOQUJMRUQoQ09ORklHX0RSTV9GQkRF
Vl9MRUFLX1BIWVNfU01FTSkKKwkJaWYgKGRybV9sZWFrX2ZiZGV2X3NtZW0gJiYgZmJpLT5maXgu
c21lbV9zdGFydCA9PSAwKQorCQkJZmJpLT5maXguc21lbV9zdGFydCA9CisJCQkJcGFnZV90b19w
aHlzKHZpcnRfdG9fcGFnZShmYmktPnNjcmVlbl9idWZmZXIpKTsKKyNlbmRpZgogCX0KIAogCXJl
dHVybiAwOwotLSAKMi4yMS4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVz
a3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9k
cmktZGV2ZWw=
