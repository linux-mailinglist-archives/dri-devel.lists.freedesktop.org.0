Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 9DB1C1079C8
	for <lists+dri-devel@lfdr.de>; Fri, 22 Nov 2019 22:09:26 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 188DE6F587;
	Fri, 22 Nov 2019 21:09:07 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga07.intel.com (mga07.intel.com [134.134.136.100])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6B7696F573;
 Fri, 22 Nov 2019 21:09:01 +0000 (UTC)
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from fmsmga007.fm.intel.com ([10.253.24.52])
 by orsmga105.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384;
 22 Nov 2019 13:09:00 -0800
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.69,231,1571727600"; d="scan'208";a="205575850"
Received: from nvishwa1-desk.sc.intel.com ([10.3.160.185])
 by fmsmga007.fm.intel.com with ESMTP; 22 Nov 2019 13:08:59 -0800
From: Niranjana Vishwanathapura <niranjana.vishwanathapura@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [RFC 04/13] drm/i915/svm: Implicitly migrate BOs upon CPU access
Date: Fri, 22 Nov 2019 12:57:25 -0800
Message-Id: <20191122205734.15925-5-niranjana.vishwanathapura@intel.com>
X-Mailer: git-send-email 2.21.0.rc0.32.g243a4c7e27
In-Reply-To: <20191122205734.15925-1-niranjana.vishwanathapura@intel.com>
References: <20191122205734.15925-1-niranjana.vishwanathapura@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: sanjay.k.kumar@intel.com, sudeep.dutt@intel.com,
 dri-devel@lists.freedesktop.org, dave.hansen@intel.com, jglisse@redhat.com,
 jon.bloomfield@intel.com, daniel.vetter@intel.com, dan.j.williams@intel.com,
 ira.weiny@intel.com, jgg@mellanox.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogVmVua2F0YSBTYW5kZWVwIERoYW5hbGFrb3RhIDx2ZW5rYXRhLnMuZGhhbmFsYWtvdGFA
aW50ZWwuY29tPgoKQXMgUENJZSBpcyBub24tY29oZXJlbnQgbGluaywgZG8gbm90IGFsbG93IGRp
cmVjdCBhY2Nlc3MgdG8gYnVmZmVyCm9iamVjdHMgYWNyb3NzIHRoZSBQQ0llIGxpbmsgZm9yIFNW
TSBjYXNlLiBVcG9uIENQVSBhY2Nlc3NlcyAobW1hcCwgcHJlYWQpLAptaWdyYXRlIGJ1ZmZlciBv
YmplY3QgdG8gaG9zdCBtZW1vcnkuCgpDYzogSm9vbmFzIExhaHRpbmVuIDxqb29uYXMubGFodGlu
ZW5AbGludXguaW50ZWwuY29tPgpDYzogSm9uIEJsb29tZmllbGQgPGpvbi5ibG9vbWZpZWxkQGlu
dGVsLmNvbT4KQ2M6IERhbmllbCBWZXR0ZXIgPGRhbmllbC52ZXR0ZXJAaW50ZWwuY29tPgpDYzog
U3VkZWVwIER1dHQgPHN1ZGVlcC5kdXR0QGludGVsLmNvbT4KQ2M6IE5pcmFuamFuYSBWaXNod2Fu
YXRoYXB1cmEgPG5pcmFuamFuYS52aXNod2FuYXRoYXB1cmFAaW50ZWwuY29tPgpTaWduZWQtb2Zm
LWJ5OiBWZW5rYXRhIFNhbmRlZXAgRGhhbmFsYWtvdGEgPHZlbmthdGEucy5kaGFuYWxha290YUBp
bnRlbC5jb20+Ci0tLQogZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVfZ2VtX21tYW4uYyAg
IHwgMTAgKysrKysrKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3Qu
YyB8IDI5ICsrKysrKysrKysrKysrKysrLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9vYmplY3QuaCB8ICAzICsrKwogZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfbWVt
b3J5X3JlZ2lvbi5jIHwgIDQgLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9tZW1vcnlf
cmVnaW9uLmggfCAgNCArKysKIDUgZmlsZXMgY2hhbmdlZCwgNDAgaW5zZXJ0aW9ucygrKSwgMTAg
ZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2VtL2k5MTVf
Z2VtX21tYW4uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9tbWFuLmMKaW5k
ZXggZDYwOTczNjAzY2MxLi4wYjQxZTJmMzA5OGMgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9pOTE1L2dlbS9pOTE1X2dlbV9tbWFuLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ2Vt
L2k5MTVfZ2VtX21tYW4uYwpAQCAtMTMsNiArMTMsNyBAQAogI2luY2x1ZGUgImk5MTVfZHJ2Lmgi
CiAjaW5jbHVkZSAiaTkxNV9nZW1fZ3R0LmgiCiAjaW5jbHVkZSAiaTkxNV9nZW1faW9jdGxzLmgi
CisjaW5jbHVkZSAiaTkxNV9nZW1fbG1lbS5oIgogI2luY2x1ZGUgImk5MTVfZ2VtX29iamVjdC5o
IgogI2luY2x1ZGUgImk5MTVfdHJhY2UuaCIKICNpbmNsdWRlICJpOTE1X3ZtYS5oIgpAQCAtMjM1
LDYgKzIzNiwxNSBAQCB2bV9mYXVsdF90IGk5MTVfZ2VtX2ZhdWx0KHN0cnVjdCB2bV9mYXVsdCAq
dm1mKQogCWlmIChpOTE1X2dlbV9vYmplY3RfaXNfcmVhZG9ubHkob2JqKSAmJiB3cml0ZSkKIAkJ
cmV0dXJuIFZNX0ZBVUxUX1NJR0JVUzsKIAorCS8qIEltcGxpY2l0bHkgbWlncmF0ZSBCTyB0byBT
TUVNIGlmIGl0IGlzIFNWTSBtYXBwZWQgKi8KKwlpZiAoaTkxNV9nZW1fb2JqZWN0X3N2bV9tYXBw
ZWQob2JqKSAmJiBpOTE1X2dlbV9vYmplY3RfaXNfbG1lbShvYmopKSB7CisJCXUzMiByZWdpb25z
W10gPSB7IFJFR0lPTl9NQVAoSU5URUxfTUVNT1JZX1NZU1RFTSwgMCkgfTsKKworCQlyZXQgPSBp
OTE1X2dlbV9vYmplY3RfbWlncmF0ZV9yZWdpb24ob2JqLCByZWdpb25zLCAxKTsKKwkJaWYgKHJl
dCkKKwkJCWdvdG8gZXJyOworCX0KKwogCS8qIFdlIGRvbid0IHVzZSB2bWYtPnBnb2ZmIHNpbmNl
IHRoYXQgaGFzIHRoZSBmYWtlIG9mZnNldCAqLwogCXBhZ2Vfb2Zmc2V0ID0gKHZtZi0+YWRkcmVz
cyAtIGFyZWEtPnZtX3N0YXJ0KSA+PiBQQUdFX1NISUZUOwogCmRpZmYgLS1naXQgYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMKaW5kZXggMTBkZWZhNzIzYmM5Li5hN2RlZTFiNzQ5Y2Ig
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmMKQEAgLTQ5Mywx
MiArNDkzLDE3IEBAIF9fcmVnaW9uX2lkKHUzMiByZWdpb24pCiAJcmV0dXJuIElOVEVMX1JFR0lP
Tl9VTktOT1dOOwogfQogCitib29sCitpOTE1X2dlbV9vYmplY3Rfc3ZtX21hcHBlZChzdHJ1Y3Qg
ZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKQoreworCXJldHVybiBmYWxzZTsKK30KKwogc3RhdGlj
IGludCBpOTE1X2dlbV9vYmplY3RfcmVnaW9uX3NlbGVjdChzdHJ1Y3QgZHJtX2k5MTVfcHJpdmF0
ZSAqZGV2X3ByaXYsCiAJCQkJCSBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdF9wYXJhbSAqYXJn
cywKIAkJCQkJIHN0cnVjdCBkcm1fZmlsZSAqZmlsZSwKIAkJCQkJIHN0cnVjdCBkcm1faTkxNV9n
ZW1fb2JqZWN0ICpvYmopCiB7Ci0Jc3RydWN0IGludGVsX2NvbnRleHQgKmNlID0gZGV2X3ByaXYt
PmVuZ2luZVtCQ1MwXS0+a2VybmVsX2NvbnRleHQ7CiAJdTMyIF9fdXNlciAqdXJlZ2lvbnMgPSB1
NjRfdG9fdXNlcl9wdHIoYXJncy0+ZGF0YSk7CiAJdTMyIHVyZWdpb25zX2NvcHlbSU5URUxfUkVH
SU9OX1VOS05PV05dOwogCWludCBpLCByZXQ7CkBAIC01MTgsMTYgKzUyMywyOCBAQCBzdGF0aWMg
aW50IGk5MTVfZ2VtX29iamVjdF9yZWdpb25fc2VsZWN0KHN0cnVjdCBkcm1faTkxNV9wcml2YXRl
ICpkZXZfcHJpdiwKIAkJKyt1cmVnaW9uczsKIAl9CiAKKwlyZXQgPSBpOTE1X2dlbV9vYmplY3Rf
bWlncmF0ZV9yZWdpb24ob2JqLCB1cmVnaW9uc19jb3B5LAorCQkJCQkgICAgIGFyZ3MtPnNpemUp
OworCisJcmV0dXJuIHJldDsKK30KKworaW50IGk5MTVfZ2VtX29iamVjdF9taWdyYXRlX3JlZ2lv
bihzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqLAorCQkJCSAgIHUzMiAqcmVnaW9ucywg
aW50IHNpemUpCit7CisJc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmRldl9wcml2ID0gdG9faTkx
NShvYmotPmJhc2UuZGV2KTsKKwlzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UgPSBkZXZfcHJpdi0+
ZW5naW5lW0JDUzBdLT5rZXJuZWxfY29udGV4dDsKKwlpbnQgaSwgcmV0OworCiAJbXV0ZXhfbG9j
aygmZGV2X3ByaXYtPmRybS5zdHJ1Y3RfbXV0ZXgpOwogCXJldCA9IGk5MTVfZ2VtX29iamVjdF9w
cmVwYXJlX21vdmUob2JqKTsKIAlpZiAocmV0KSB7CiAJCURSTV9FUlJPUigiQ2Fubm90IHNldCBt
ZW1vcnkgcmVnaW9uLCBvYmplY3QgaW4gdXNlXG4iKTsKLQkgICAgICAgIGdvdG8gZXJyOworCQln
b3RvIGVycjsKIAl9CiAKLQlmb3IgKGkgPSAwOyBpIDwgYXJncy0+c2l6ZTsgaSsrKSB7Ci0JCXUz
MiByZWdpb24gPSB1cmVnaW9uc19jb3B5W2ldOwotCQllbnVtIGludGVsX3JlZ2lvbl9pZCBpZCA9
IF9fcmVnaW9uX2lkKHJlZ2lvbik7CisJZm9yIChpID0gMDsgaSA8IHNpemU7IGkrKykgeworCQll
bnVtIGludGVsX3JlZ2lvbl9pZCBpZCA9IF9fcmVnaW9uX2lkKHJlZ2lvbnNbaV0pOwogCiAJCWlm
IChpZCA9PSBJTlRFTF9SRUdJT05fVU5LTk9XTikgewogCQkJcmV0ID0gLUVJTlZBTDsKQEAgLTUz
Nyw3ICs1NTQsNyBAQCBzdGF0aWMgaW50IGk5MTVfZ2VtX29iamVjdF9yZWdpb25fc2VsZWN0KHN0
cnVjdCBkcm1faTkxNV9wcml2YXRlICpkZXZfcHJpdiwKIAkJcmV0ID0gaTkxNV9nZW1fb2JqZWN0
X21pZ3JhdGUob2JqLCBjZSwgaWQpOwogCQlpZiAoIXJldCkgewogCQkJaWYgKCFpOTE1X2dlbV9v
YmplY3RfaGFzX3BhZ2VzKG9iaikgJiYKLQkJCSAgICBNRU1PUllfVFlQRV9GUk9NX1JFR0lPTihy
ZWdpb24pID09CisJCQkgICAgTUVNT1JZX1RZUEVfRlJPTV9SRUdJT04ocmVnaW9uc1tpXSkgPT0K
IAkJCSAgICBJTlRFTF9NRU1PUllfTE9DQUwpIHsKIAkJCQkvKgogCQkJCSAqIFRPRE86IHRoaXMg
c2hvdWxkIGJlIHBhcnQgb2YgZ2V0X3BhZ2VzKCksCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0v
aTkxNV9nZW1fb2JqZWN0LmgKaW5kZXggNGQ2ZGE5MWJlYWZmLi5lZWMzMWQ5YTRmYTIgMTAwNjQ0
Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3QuaAorKysgYi9k
cml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0LmgKQEAgLTQ3LDYgKzQ3LDkg
QEAgaW50IGk5MTVfZ2VtX29iamVjdF9wcmVwYXJlX21vdmUoc3RydWN0IGRybV9pOTE1X2dlbV9v
YmplY3QgKm9iaik7CiBpbnQgaTkxNV9nZW1fb2JqZWN0X21pZ3JhdGUoc3RydWN0IGRybV9pOTE1
X2dlbV9vYmplY3QgKm9iaiwKIAkJCSAgICBzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCiAJCQkg
ICAgZW51bSBpbnRlbF9yZWdpb25faWQgaWQpOworYm9vbCBpOTE1X2dlbV9vYmplY3Rfc3ZtX21h
cHBlZChzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqKTsKK2ludCBpOTE1X2dlbV9vYmpl
Y3RfbWlncmF0ZV9yZWdpb24oc3RydWN0IGRybV9pOTE1X2dlbV9vYmplY3QgKm9iaiwKKwkJCQkg
ICB1MzIgKnVyZWdpb25zLCBpbnQgc2l6ZSk7CiAKIHZvaWQgaTkxNV9nZW1fZmx1c2hfZnJlZV9v
YmplY3RzKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1KTsKIApkaWZmIC0tZ2l0IGEvZHJp
dmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfbWVtb3J5X3JlZ2lvbi5jIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvaW50ZWxfbWVtb3J5X3JlZ2lvbi5jCmluZGV4IGJhYWVhZWNjNjRhZi4uMDQ5YTFiNDgy
ZDlkIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9pbnRlbF9tZW1vcnlfcmVnaW9u
LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfbWVtb3J5X3JlZ2lvbi5jCkBAIC02
LDEwICs2LDYgQEAKICNpbmNsdWRlICJpbnRlbF9tZW1vcnlfcmVnaW9uLmgiCiAjaW5jbHVkZSAi
aTkxNV9kcnYuaCIKIAotLyogWFhYOiBIeXN0ZXJpY2FsIHJhaXNpbnMuIEJJVChpbnN0KSBuZWVk
cyB0byBqdXN0IGJlIChpbnN0KSBhdCBzb21lIHBvaW50LiAqLwotI2RlZmluZSBSRUdJT05fTUFQ
KHR5cGUsIGluc3QpIFwKLQlCSVQoKHR5cGUpICsgSU5URUxfTUVNT1JZX1RZUEVfU0hJRlQpIHwg
QklUKGluc3QpCi0KIGNvbnN0IHUzMiBpbnRlbF9yZWdpb25fbWFwW10gPSB7CiAJW0lOVEVMX1JF
R0lPTl9TTUVNXSA9IFJFR0lPTl9NQVAoSU5URUxfTUVNT1JZX1NZU1RFTSwgMCksCiAJW0lOVEVM
X1JFR0lPTl9MTUVNXSA9IFJFR0lPTl9NQVAoSU5URUxfTUVNT1JZX0xPQ0FMLCAwKSwKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX21lbW9yeV9yZWdpb24uaCBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2ludGVsX21lbW9yeV9yZWdpb24uaAppbmRleCAyMzg3MjIwMDk2Nzcu
LjQ2MjJjMDg2YzA2ZCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvaW50ZWxfbWVt
b3J5X3JlZ2lvbi5oCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2ludGVsX21lbW9yeV9yZWdp
b24uaApAQCAtNDEsNiArNDEsMTAgQEAgZW51bSBpbnRlbF9yZWdpb25faWQgewogCiAjZGVmaW5l
IElOVEVMX01FTU9SWV9UWVBFX1NISUZUIDE2CiAKKy8qIFhYWDogSHlzdGVyaWNhbCByYWlzaW5z
LiBCSVQoaW5zdCkgbmVlZHMgdG8ganVzdCBiZSAoaW5zdCkgYXQgc29tZSBwb2ludC4gKi8KKyNk
ZWZpbmUgUkVHSU9OX01BUCh0eXBlLCBpbnN0KSBcCisJKEJJVCgodHlwZSkgKyBJTlRFTF9NRU1P
UllfVFlQRV9TSElGVCkgfCBCSVQoaW5zdCkpCisKICNkZWZpbmUgTUVNT1JZX1RZUEVfRlJPTV9S
RUdJT04ocikgKGlsb2cyKChyKSA+PiBJTlRFTF9NRU1PUllfVFlQRV9TSElGVCkpCiAjZGVmaW5l
IE1FTU9SWV9JTlNUQU5DRV9GUk9NX1JFR0lPTihyKSAoaWxvZzIoKHIpICYgMHhmZmZmKSkKIAot
LSAKMi4yMS4wLnJjMC4zMi5nMjQzYTRjN2UyNwoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4v
bGlzdGluZm8vZHJpLWRldmVs
