Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 1F73FF2B04
	for <lists+dri-devel@lfdr.de>; Thu,  7 Nov 2019 10:43:22 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 749016F3D9;
	Thu,  7 Nov 2019 09:43:16 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9679A6F3D2
 for <dri-devel@lists.freedesktop.org>; Thu,  7 Nov 2019 09:43:12 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id 11CA3B1EC;
 Thu,  7 Nov 2019 09:43:11 +0000 (UTC)
From: Thomas Zimmermann <tzimmermann@suse.de>
To: airlied@redhat.com, sean@poorly.run, daniel@ffwll.ch, noralf@tronnes.org,
 sam@ravnborg.org, emil.velikov@collabora.com, kraxel@redhat.com
Subject: [PATCH v3 3/4] drm/udl: Switch to SHMEM
Date: Thu,  7 Nov 2019 10:43:06 +0100
Message-Id: <20191107094307.19870-4-tzimmermann@suse.de>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191107094307.19870-1-tzimmermann@suse.de>
References: <20191107094307.19870-1-tzimmermann@suse.de>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Thomas Zimmermann <tzimmermann@suse.de>, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VWRsJ3MgR0VNIGNvZGUgYW5kIHRoZSBnZW5lcmljIFNITUVNIGFyZSBhbG1vc3QgaWRlbnRpY2Fs
LiBSZXBsYWNlCnRoZSBmb3JtZXIgd2l0aCBTSE1FTS4gVGhlIGRtYWJ1ZiBzdXBwb3J0IGluIHVk
bCBpcyBiZWluZyByZXBsYWNlZAp3aXRoIGdlbmVyaWMgR0VNIFBSSU1FIGZ1bmN0aW9ucy4KClRo
ZSBtYWluIGRpZmZlcmVuY2UgaXMgaW4gdGhlIGNhY2hpbmcgZmxhZ3MgZm9yIG1tYXAgcGFnZXMu
IEJ5CmRlZmF1bHQsIFNITUVNIGFsd2F5cyBzZXRzICh1bmNhY2hlZCkgd3JpdGUgY29tYmluaW5n
LiBJbiB1ZGwncwptZW1vcnkgbWFuYWdlbWVudCBjb2RlLCBvbmx5IGltcG9ydGVkIGJ1ZmZlcnMg
dXNlIHdyaXRlIGNvbWJpbmluZy4KTWVtb3J5IHBhZ2VzIG9mIGxvY2FsbHkgY3JlYXRlZCBidWZm
ZXIgb2JqZWN0cyBhcmUgbW1hcCdlZCB3aXRoCmNhY2hpbmcgZW5hYmxlZC4gVG8ga2VlcCB0aGUg
b3B0aW1pemF0aW9uLCB1ZGwgcHJvdmlkZXMgaXRzIG93bgptbWFwIGZ1bmN0aW9uIGZvciBHRU0g
b2JqZWN0cyB3aGVyZSBpdCBmaXhlcyB1cCB0aGUgbWFwcGluZyBmbGFncy4KCnYzOgoJLSByZXN0
b3JlIHVkbCB2bWFwIHRoYXQgZW5hYmxlcyBjYWNoaW5nCnYyOgoJLSByZW1vdmUgb2Jzb2xldGUg
Y29kZSBpbiBhIHNlcGFyYXRlIHBhdGNoCgpTaWduZWQtb2ZmLWJ5OiBUaG9tYXMgWmltbWVybWFu
biA8dHppbW1lcm1hbm5Ac3VzZS5kZT4KQWNrZWQtYnk6IEdlcmQgSG9mZm1hbm4gPGtyYXhlbEBy
ZWRoYXQuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS91ZGwvS2NvbmZpZyAgIHwgICAxICsKIGRy
aXZlcnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5jIHwgIDI5ICstLS0tLS0tLS0KIGRyaXZlcnMvZ3B1
L2RybS91ZGwvdWRsX2Rydi5oIHwgICAxICsKIGRyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2ZiLmMg
IHwgIDY2ICsrKysrKysrKysrKy0tLS0tLS0tLS0KIGRyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2dl
bS5jIHwgMTAxICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0KIDUgZmlsZXMgY2hh
bmdlZCwgMTM4IGluc2VydGlvbnMoKyksIDYwIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2Ry
aXZlcnMvZ3B1L2RybS91ZGwvS2NvbmZpZyBiL2RyaXZlcnMvZ3B1L2RybS91ZGwvS2NvbmZpZwpp
bmRleCBiNGQxNzliODdmMDEuLjE0NWIyYTk1Y2U1OCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUv
ZHJtL3VkbC9LY29uZmlnCisrKyBiL2RyaXZlcnMvZ3B1L2RybS91ZGwvS2NvbmZpZwpAQCAtNSw2
ICs1LDcgQEAgY29uZmlnIERSTV9VREwKIAlkZXBlbmRzIG9uIFVTQl9TVVBQT1JUCiAJZGVwZW5k
cyBvbiBVU0JfQVJDSF9IQVNfSENECiAJc2VsZWN0IFVTQgorCXNlbGVjdCBEUk1fR0VNX1NITUVN
X0hFTFBFUgogCXNlbGVjdCBEUk1fS01TX0hFTFBFUgogCWhlbHAKIAkgIFRoaXMgaXMgYSBLTVMg
ZHJpdmVyIGZvciB0aGUgVVNCIGRpc3BsYXlsaW5rIHZpZGVvIGFkYXB0ZXJzLgpkaWZmIC0tZ2l0
IGEvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfZHJ2LmMgYi9kcml2ZXJzL2dwdS9kcm0vdWRsL3Vk
bF9kcnYuYwppbmRleCA3NzhhMGI2NTJmNjQuLjU2M2NjNTgwOWU1NiAxMDA2NDQKLS0tIGEvZHJp
dmVycy9ncHUvZHJtL3VkbC91ZGxfZHJ2LmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxf
ZHJ2LmMKQEAgLTgsNiArOCw3IEBACiAjaW5jbHVkZSA8ZHJtL2RybV9jcnRjX2hlbHBlci5oPgog
I2luY2x1ZGUgPGRybS9kcm1fZHJ2Lmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9maWxlLmg+CisjaW5j
bHVkZSA8ZHJtL2RybV9nZW1fc2htZW1faGVscGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9pb2N0
bC5oPgogI2luY2x1ZGUgPGRybS9kcm1fcHJvYmVfaGVscGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2Ry
bV9wcmludC5oPgpAQCAtMzIsMjMgKzMzLDcgQEAgc3RhdGljIGludCB1ZGxfdXNiX3Jlc3VtZShz
dHJ1Y3QgdXNiX2ludGVyZmFjZSAqaW50ZXJmYWNlKQogCXJldHVybiAwOwogfQogCi1zdGF0aWMg
Y29uc3Qgc3RydWN0IHZtX29wZXJhdGlvbnNfc3RydWN0IHVkbF9nZW1fdm1fb3BzID0gewotCS5m
YXVsdCA9IHVkbF9nZW1fZmF1bHQsCi0JLm9wZW4gPSBkcm1fZ2VtX3ZtX29wZW4sCi0JLmNsb3Nl
ID0gZHJtX2dlbV92bV9jbG9zZSwKLX07Ci0KLXN0YXRpYyBjb25zdCBzdHJ1Y3QgZmlsZV9vcGVy
YXRpb25zIHVkbF9kcml2ZXJfZm9wcyA9IHsKLQkub3duZXIgPSBUSElTX01PRFVMRSwKLQkub3Bl
biA9IGRybV9vcGVuLAotCS5tbWFwID0gdWRsX2RybV9nZW1fbW1hcCwKLQkucG9sbCA9IGRybV9w
b2xsLAotCS5yZWFkID0gZHJtX3JlYWQsCi0JLnVubG9ja2VkX2lvY3RsCT0gZHJtX2lvY3RsLAot
CS5yZWxlYXNlID0gZHJtX3JlbGVhc2UsCi0JLmNvbXBhdF9pb2N0bCA9IGRybV9jb21wYXRfaW9j
dGwsCi0JLmxsc2VlayA9IG5vb3BfbGxzZWVrLAotfTsKK0RFRklORV9EUk1fR0VNX0ZPUFModWRs
X2RyaXZlcl9mb3BzKTsKIAogc3RhdGljIHZvaWQgdWRsX2RyaXZlcl9yZWxlYXNlKHN0cnVjdCBk
cm1fZGV2aWNlICpkZXYpCiB7CkBAIC02MywxOCArNDgsMTAgQEAgc3RhdGljIHN0cnVjdCBkcm1f
ZHJpdmVyIGRyaXZlciA9IHsKIAkucmVsZWFzZSA9IHVkbF9kcml2ZXJfcmVsZWFzZSwKIAogCS8q
IGdlbSBob29rcyAqLwotCS5nZW1fZnJlZV9vYmplY3RfdW5sb2NrZWQgPSB1ZGxfZ2VtX2ZyZWVf
b2JqZWN0LAogCS5nZW1fY3JlYXRlX29iamVjdCA9IHVkbF9kcml2ZXJfZ2VtX2NyZWF0ZV9vYmpl
Y3QsCi0JLmdlbV92bV9vcHMgPSAmdWRsX2dlbV92bV9vcHMsCiAKLQkuZHVtYl9jcmVhdGUgPSB1
ZGxfZHVtYl9jcmVhdGUsCi0JLmR1bWJfbWFwX29mZnNldCA9IHVkbF9nZW1fbW1hcCwKIAkuZm9w
cyA9ICZ1ZGxfZHJpdmVyX2ZvcHMsCi0KLQkucHJpbWVfaGFuZGxlX3RvX2ZkID0gZHJtX2dlbV9w
cmltZV9oYW5kbGVfdG9fZmQsCi0JLnByaW1lX2ZkX3RvX2hhbmRsZSA9IGRybV9nZW1fcHJpbWVf
ZmRfdG9faGFuZGxlLAotCS5nZW1fcHJpbWVfZXhwb3J0ID0gdWRsX2dlbV9wcmltZV9leHBvcnQs
Ci0JLmdlbV9wcmltZV9pbXBvcnQgPSB1ZGxfZ2VtX3ByaW1lX2ltcG9ydCwKKwlEUk1fR0VNX1NI
TUVNX0RSSVZFUl9PUFMsCiAKIAkubmFtZSA9IERSSVZFUl9OQU1FLAogCS5kZXNjID0gRFJJVkVS
X0RFU0MsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9kcnYuaCBiL2RyaXZl
cnMvZ3B1L2RybS91ZGwvdWRsX2Rydi5oCmluZGV4IGZjMzEyZTc5MWQxOC4uNjMwZTY0YWJjOTg2
IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9kcnYuaAorKysgYi9kcml2ZXJz
L2dwdS9kcm0vdWRsL3VkbF9kcnYuaApAQCAtODUsNiArODUsNyBAQCBzdHJ1Y3QgdWRsX2dlbV9v
YmplY3Qgewogc3RydWN0IHVkbF9mcmFtZWJ1ZmZlciB7CiAJc3RydWN0IGRybV9mcmFtZWJ1ZmZl
ciBiYXNlOwogCXN0cnVjdCB1ZGxfZ2VtX29iamVjdCAqb2JqOworCXN0cnVjdCBkcm1fZ2VtX3No
bWVtX29iamVjdCAqc2htZW07CiAJYm9vbCBhY3RpdmVfMTY7IC8qIGFjdGl2ZSBvbiB0aGUgMTYt
Yml0IGNoYW5uZWwgKi8KIH07CiAKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRs
X2ZiLmMgYi9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9mYi5jCmluZGV4IGVmMzUwNGQwNjM0My4u
ZjgxNTNiNzI2MzQzIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9mYi5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS91ZGwvdWRsX2ZiLmMKQEAgLTE1LDYgKzE1LDcgQEAKICNpbmNs
dWRlIDxkcm0vZHJtX2Rydi5oPgogI2luY2x1ZGUgPGRybS9kcm1fZmJfaGVscGVyLmg+CiAjaW5j
bHVkZSA8ZHJtL2RybV9mb3VyY2MuaD4KKyNpbmNsdWRlIDxkcm0vZHJtX2dlbV9zaG1lbV9oZWxw
ZXIuaD4KICNpbmNsdWRlIDxkcm0vZHJtX21vZGVzZXRfaGVscGVyLmg+CiAKICNpbmNsdWRlICJ1
ZGxfZHJ2LmgiCkBAIC05NCwxNiArOTUsMTQgQEAgaW50IHVkbF9oYW5kbGVfZGFtYWdlKHN0cnVj
dCB1ZGxfZnJhbWVidWZmZXIgKmZiLCBpbnQgeCwgaW50IHksCiAJaWYgKCFmYi0+YWN0aXZlXzE2
KQogCQlyZXR1cm4gMDsKIAotCWlmICghZmItPm9iai0+dm1hcHBpbmcpIHsKLQkJcmV0ID0gdWRs
X2dlbV92bWFwKGZiLT5vYmopOwotCQlpZiAocmV0ID09IC1FTk9NRU0pIHsKKwlpZiAoIWZiLT5z
aG1lbS0+dmFkZHIpIHsKKwkJdm9pZCAqdmFkZHI7CisKKwkJdmFkZHIgPSBkcm1fZ2VtX3NobWVt
X3ZtYXAoJmZiLT5zaG1lbS0+YmFzZSk7CisJCWlmIChJU19FUlIodmFkZHIpKSB7CiAJCQlEUk1f
RVJST1IoImZhaWxlZCB0byB2bWFwIGZiXG4iKTsKIAkJCXJldHVybiAwOwogCQl9Ci0JCWlmICgh
ZmItPm9iai0+dm1hcHBpbmcpIHsKLQkJCURSTV9FUlJPUigiZmFpbGVkIHRvIHZtYXBwaW5nXG4i
KTsKLQkJCXJldHVybiAwOwotCQl9CiAJfQogCiAJYWxpZ25lZF94ID0gRExfQUxJR05fRE9XTih4
LCBzaXplb2YodW5zaWduZWQgbG9uZykpOwpAQCAtMTI3LDcgKzEyNiw3IEBAIGludCB1ZGxfaGFu
ZGxlX2RhbWFnZShzdHJ1Y3QgdWRsX2ZyYW1lYnVmZmVyICpmYiwgaW50IHgsIGludCB5LAogCQlj
b25zdCBpbnQgYnl0ZV9vZmZzZXQgPSBsaW5lX29mZnNldCArICh4IDw8IGxvZ19icHApOwogCQlj
b25zdCBpbnQgZGV2X2J5dGVfb2Zmc2V0ID0gKGZiLT5iYXNlLndpZHRoICogaSArIHgpIDw8IGxv
Z19icHA7CiAJCWlmICh1ZGxfcmVuZGVyX2hsaW5lKGRldiwgbG9nX2JwcCwgJnVyYiwKLQkJCQkg
ICAgIChjaGFyICopIGZiLT5vYmotPnZtYXBwaW5nLAorCQkJCSAgICAgKGNoYXIgKikgZmItPnNo
bWVtLT52YWRkciwKIAkJCQkgICAgICZjbWQsIGJ5dGVfb2Zmc2V0LCBkZXZfYnl0ZV9vZmZzZXQs
CiAJCQkJICAgICB3aWR0aCA8PCBsb2dfYnBwLAogCQkJCSAgICAgJmJ5dGVzX2lkZW50aWNhbCwg
JmJ5dGVzX3NlbnQpKQpAQCAtMjgxLDYgKzI4MCw3IEBAIHN0YXRpYyBpbnQgdWRsX3VzZXJfZnJh
bWVidWZmZXJfZGlydHkoc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIsCiAJCQkJICAgICAgdW5z
aWduZWQgbnVtX2NsaXBzKQogewogCXN0cnVjdCB1ZGxfZnJhbWVidWZmZXIgKnVmYiA9IHRvX3Vk
bF9mYihmYik7CisJc3RydWN0IGRtYV9idWZfYXR0YWNobWVudCAqaW1wb3J0X2F0dGFjaDsKIAlp
bnQgaTsKIAlpbnQgcmV0ID0gMDsKIApAQCAtMjg5LDggKzI4OSwxMCBAQCBzdGF0aWMgaW50IHVk
bF91c2VyX2ZyYW1lYnVmZmVyX2RpcnR5KHN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiLAogCWlm
ICghdWZiLT5hY3RpdmVfMTYpCiAJCWdvdG8gdW5sb2NrOwogCi0JaWYgKHVmYi0+b2JqLT5iYXNl
LmltcG9ydF9hdHRhY2gpIHsKLQkJcmV0ID0gZG1hX2J1Zl9iZWdpbl9jcHVfYWNjZXNzKHVmYi0+
b2JqLT5iYXNlLmltcG9ydF9hdHRhY2gtPmRtYWJ1ZiwKKwlpbXBvcnRfYXR0YWNoID0gdWZiLT5z
aG1lbS0+YmFzZS5pbXBvcnRfYXR0YWNoOworCisJaWYgKGltcG9ydF9hdHRhY2gpIHsKKwkJcmV0
ID0gZG1hX2J1Zl9iZWdpbl9jcHVfYWNjZXNzKGltcG9ydF9hdHRhY2gtPmRtYWJ1ZiwKIAkJCQkJ
ICAgICAgIERNQV9GUk9NX0RFVklDRSk7CiAJCWlmIChyZXQpCiAJCQlnb3RvIHVubG9jazsKQEAg
LTMwNCwxMCArMzA2LDkgQEAgc3RhdGljIGludCB1ZGxfdXNlcl9mcmFtZWJ1ZmZlcl9kaXJ0eShz
dHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYiwKIAkJCWJyZWFrOwogCX0KIAotCWlmICh1ZmItPm9i
ai0+YmFzZS5pbXBvcnRfYXR0YWNoKSB7Ci0JCXJldCA9IGRtYV9idWZfZW5kX2NwdV9hY2Nlc3Mo
dWZiLT5vYmotPmJhc2UuaW1wb3J0X2F0dGFjaC0+ZG1hYnVmLAorCWlmIChpbXBvcnRfYXR0YWNo
KQorCQlyZXQgPSBkbWFfYnVmX2VuZF9jcHVfYWNjZXNzKGltcG9ydF9hdHRhY2gtPmRtYWJ1ZiwK
IAkJCQkJICAgICBETUFfRlJPTV9ERVZJQ0UpOwotCX0KIAogIHVubG9jazoKIAlkcm1fbW9kZXNl
dF91bmxvY2tfYWxsKGZiLT5kZXYpOwpAQCAtMzE5LDggKzMyMCw4IEBAIHN0YXRpYyB2b2lkIHVk
bF91c2VyX2ZyYW1lYnVmZmVyX2Rlc3Ryb3koc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmIpCiB7
CiAJc3RydWN0IHVkbF9mcmFtZWJ1ZmZlciAqdWZiID0gdG9fdWRsX2ZiKGZiKTsKIAotCWlmICh1
ZmItPm9iaikKLQkJZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKCZ1ZmItPm9iai0+YmFzZSk7
CisJaWYgKHVmYi0+c2htZW0pCisJCWRybV9nZW1fb2JqZWN0X3B1dF91bmxvY2tlZCgmdWZiLT5z
aG1lbS0+YmFzZSk7CiAKIAlkcm1fZnJhbWVidWZmZXJfY2xlYW51cChmYik7CiAJa2ZyZWUodWZi
KTsKQEAgLTMzNiwxMSArMzM3LDExIEBAIHN0YXRpYyBpbnQKIHVkbF9mcmFtZWJ1ZmZlcl9pbml0
KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJCSAgICAgc3RydWN0IHVkbF9mcmFtZWJ1ZmZlciAq
dWZiLAogCQkgICAgIGNvbnN0IHN0cnVjdCBkcm1fbW9kZV9mYl9jbWQyICptb2RlX2NtZCwKLQkJ
ICAgICBzdHJ1Y3QgdWRsX2dlbV9vYmplY3QgKm9iaikKKwkJICAgICBzdHJ1Y3QgZHJtX2dlbV9z
aG1lbV9vYmplY3QgKnNobWVtKQogewogCWludCByZXQ7CiAKLQl1ZmItPm9iaiA9IG9iajsKKwl1
ZmItPnNobWVtID0gc2htZW07CiAJZHJtX2hlbHBlcl9tb2RlX2ZpbGxfZmJfc3RydWN0KGRldiwg
JnVmYi0+YmFzZSwgbW9kZV9jbWQpOwogCXJldCA9IGRybV9mcmFtZWJ1ZmZlcl9pbml0KGRldiwg
JnVmYi0+YmFzZSwgJnVkbGZiX2Z1bmNzKTsKIAlyZXR1cm4gcmV0OwpAQCAtMzU2LDcgKzM1Nyw4
IEBAIHN0YXRpYyBpbnQgdWRsZmJfY3JlYXRlKHN0cnVjdCBkcm1fZmJfaGVscGVyICpoZWxwZXIs
CiAJc3RydWN0IGZiX2luZm8gKmluZm87CiAJc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqZmI7CiAJ
c3RydWN0IGRybV9tb2RlX2ZiX2NtZDIgbW9kZV9jbWQ7Ci0Jc3RydWN0IHVkbF9nZW1fb2JqZWN0
ICpvYmo7CisJc3RydWN0IGRybV9nZW1fc2htZW1fb2JqZWN0ICpzaG1lbTsKKwl2b2lkICp2YWRk
cjsKIAl1aW50MzJfdCBzaXplOwogCWludCByZXQgPSAwOwogCkBAIC0zNzMsMTIgKzM3NSwxNSBA
QCBzdGF0aWMgaW50IHVkbGZiX2NyZWF0ZShzdHJ1Y3QgZHJtX2ZiX2hlbHBlciAqaGVscGVyLAog
CXNpemUgPSBtb2RlX2NtZC5waXRjaGVzWzBdICogbW9kZV9jbWQuaGVpZ2h0OwogCXNpemUgPSBB
TElHTihzaXplLCBQQUdFX1NJWkUpOwogCi0Jb2JqID0gdWRsX2dlbV9hbGxvY19vYmplY3QoZGV2
LCBzaXplKTsKLQlpZiAoIW9iaikKKwlzaG1lbSA9IGRybV9nZW1fc2htZW1fY3JlYXRlKGRldiwg
c2l6ZSk7CisJaWYgKElTX0VSUihzaG1lbSkpIHsKKwkJcmV0ID0gUFRSX0VSUihzaG1lbSk7CiAJ
CWdvdG8gb3V0OworCX0KIAotCXJldCA9IHVkbF9nZW1fdm1hcChvYmopOwotCWlmIChyZXQpIHsK
Kwl2YWRkciA9IGRybV9nZW1fc2htZW1fdm1hcCgmc2htZW0tPmJhc2UpOworCWlmIChJU19FUlIo
dmFkZHIpKSB7CisJCXJldCA9IFBUUl9FUlIodmFkZHIpOwogCQlEUk1fRVJST1IoImZhaWxlZCB0
byB2bWFwIGZiXG4iKTsKIAkJZ290byBvdXRfZ2ZyZWU7CiAJfQpAQCAtMzg5LDcgKzM5NCw3IEBA
IHN0YXRpYyBpbnQgdWRsZmJfY3JlYXRlKHN0cnVjdCBkcm1fZmJfaGVscGVyICpoZWxwZXIsCiAJ
CWdvdG8gb3V0X2dmcmVlOwogCX0KIAotCXJldCA9IHVkbF9mcmFtZWJ1ZmZlcl9pbml0KGRldiwg
JnVmYmRldi0+dWZiLCAmbW9kZV9jbWQsIG9iaik7CisJcmV0ID0gdWRsX2ZyYW1lYnVmZmVyX2lu
aXQoZGV2LCAmdWZiZGV2LT51ZmIsICZtb2RlX2NtZCwgc2htZW0pOwogCWlmIChyZXQpCiAJCWdv
dG8gb3V0X2dmcmVlOwogCkBAIC0zOTcsMjAgKzQwMiwyMCBAQCBzdGF0aWMgaW50IHVkbGZiX2Ny
ZWF0ZShzdHJ1Y3QgZHJtX2ZiX2hlbHBlciAqaGVscGVyLAogCiAJdWZiZGV2LT5oZWxwZXIuZmIg
PSBmYjsKIAotCWluZm8tPnNjcmVlbl9iYXNlID0gdWZiZGV2LT51ZmIub2JqLT52bWFwcGluZzsK
KwlpbmZvLT5zY3JlZW5fYmFzZSA9IHZhZGRyOwogCWluZm8tPmZpeC5zbWVtX2xlbiA9IHNpemU7
Ci0JaW5mby0+Zml4LnNtZW1fc3RhcnQgPSAodW5zaWduZWQgbG9uZyl1ZmJkZXYtPnVmYi5vYmot
PnZtYXBwaW5nOworCWluZm8tPmZpeC5zbWVtX3N0YXJ0ID0gKHVuc2lnbmVkIGxvbmcpdmFkZHI7
CiAKIAlpbmZvLT5mYm9wcyA9ICZ1ZGxmYl9vcHM7CiAJZHJtX2ZiX2hlbHBlcl9maWxsX2luZm8o
aW5mbywgJnVmYmRldi0+aGVscGVyLCBzaXplcyk7CiAKIAlEUk1fREVCVUdfS01TKCJhbGxvY2F0
ZWQgJWR4JWQgdm1hbCAlcFxuIiwKIAkJICAgICAgZmItPndpZHRoLCBmYi0+aGVpZ2h0LAotCQkg
ICAgICB1ZmJkZXYtPnVmYi5vYmotPnZtYXBwaW5nKTsKKwkJICAgICAgdWZiZGV2LT51ZmIuc2ht
ZW0tPnZhZGRyKTsKIAogCXJldHVybiByZXQ7CiBvdXRfZ2ZyZWU6Ci0JZHJtX2dlbV9vYmplY3Rf
cHV0X3VubG9ja2VkKCZ1ZmJkZXYtPnVmYi5vYmotPmJhc2UpOworCWRybV9nZW1fb2JqZWN0X3B1
dF91bmxvY2tlZCgmdWZiZGV2LT51ZmIuc2htZW0tPmJhc2UpOwogb3V0OgogCXJldHVybiByZXQ7
CiB9CkBAIC00MjQsMTAgKzQyOSwxMCBAQCBzdGF0aWMgdm9pZCB1ZGxfZmJkZXZfZGVzdHJveShz
dHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogewogCWRybV9mYl9oZWxwZXJfdW5yZWdpc3Rlcl9mYmko
JnVmYmRldi0+aGVscGVyKTsKIAlkcm1fZmJfaGVscGVyX2ZpbmkoJnVmYmRldi0+aGVscGVyKTsK
LQlpZiAodWZiZGV2LT51ZmIub2JqKSB7CisJaWYgKHVmYmRldi0+dWZiLnNobWVtKSB7CiAJCWRy
bV9mcmFtZWJ1ZmZlcl91bnJlZ2lzdGVyX3ByaXZhdGUoJnVmYmRldi0+dWZiLmJhc2UpOwogCQlk
cm1fZnJhbWVidWZmZXJfY2xlYW51cCgmdWZiZGV2LT51ZmIuYmFzZSk7Ci0JCWRybV9nZW1fb2Jq
ZWN0X3B1dF91bmxvY2tlZCgmdWZiZGV2LT51ZmIub2JqLT5iYXNlKTsKKwkJZHJtX2dlbV9vYmpl
Y3RfcHV0X3VubG9ja2VkKCZ1ZmJkZXYtPnVmYi5zaG1lbS0+YmFzZSk7CiAJfQogfQogCkBAIC01
MTgsNyArNTIzLDggQEAgdWRsX2ZiX3VzZXJfZmJfY3JlYXRlKHN0cnVjdCBkcm1fZGV2aWNlICpk
ZXYsCiAJaWYgKHVmYiA9PSBOVUxMKQogCQlyZXR1cm4gRVJSX1BUUigtRU5PTUVNKTsKIAotCXJl
dCA9IHVkbF9mcmFtZWJ1ZmZlcl9pbml0KGRldiwgdWZiLCBtb2RlX2NtZCwgdG9fdWRsX2JvKG9i
aikpOworCXJldCA9IHVkbF9mcmFtZWJ1ZmZlcl9pbml0KGRldiwgdWZiLCBtb2RlX2NtZCwKKwkJ
CQkgICB0b19kcm1fZ2VtX3NobWVtX29iaihvYmopKTsKIAlpZiAocmV0KSB7CiAJCWtmcmVlKHVm
Yik7CiAJCXJldHVybiBFUlJfUFRSKC1FSU5WQUwpOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUv
ZHJtL3VkbC91ZGxfZ2VtLmMgYi9kcml2ZXJzL2dwdS9kcm0vdWRsL3VkbF9nZW0uYwppbmRleCA2
Mjg3NDljYzExNDMuLjk3NjIyNjVlZGZjZiAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL3Vk
bC91ZGxfZ2VtLmMKKysrIGIvZHJpdmVycy9ncHUvZHJtL3VkbC91ZGxfZ2VtLmMKQEAgLTcsMTEg
KzcsMTAwIEBACiAjaW5jbHVkZSA8bGludXgvdm1hbGxvYy5oPgogCiAjaW5jbHVkZSA8ZHJtL2Ry
bV9kcnYuaD4KKyNpbmNsdWRlIDxkcm0vZHJtX2dlbV9zaG1lbV9oZWxwZXIuaD4KICNpbmNsdWRl
IDxkcm0vZHJtX21vZGUuaD4KICNpbmNsdWRlIDxkcm0vZHJtX3ByaW1lLmg+CiAKICNpbmNsdWRl
ICJ1ZGxfZHJ2LmgiCiAKKy8qCisgKiBHRU0gb2JqZWN0IGZ1bmNzCisgKi8KKworc3RhdGljIHZv
aWQgdWRsX2dlbV9vYmplY3RfZnJlZV9vYmplY3Qoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmop
Cit7CisJc3RydWN0IGRybV9nZW1fc2htZW1fb2JqZWN0ICpzaG1lbSA9IHRvX2RybV9nZW1fc2ht
ZW1fb2JqKG9iaik7CisKKwkvKiBGYmRldiBlbXVsYXRpb24gdm1hcHMgdGhlIGJ1ZmZlci4gVW5t
YXAgaXQgaGVyZSBmb3IgY29uc2lzdGVuY3kKKwkgKiB3aXRoIHRoZSBvcmlnaW5hbCB1ZGwgR0VN
IGNvZGUuCisJICoKKwkgKiBUT0RPOiBTd2l0Y2ggdG8gZ2VuZXJpYyBmYmRldiBlbXVsYXRpb24g
YW5kIHJlbGVhc2UgdGhlCisJICogICAgICAgR0VNIG9iamVjdCB3aXRoIGRybV9nZW1fc2htZW1f
ZnJlZV9vYmplY3QoKS4KKwkgKi8KKwlpZiAoc2htZW0tPnZhZGRyKQorCQlkcm1fZ2VtX3NobWVt
X3Z1bm1hcChvYmosIHNobWVtLT52YWRkcik7CisKKwlkcm1fZ2VtX3NobWVtX2ZyZWVfb2JqZWN0
KG9iaik7Cit9CisKK3N0YXRpYyBpbnQgdWRsX2dlbV9vYmplY3RfbW1hcChzdHJ1Y3QgZHJtX2dl
bV9vYmplY3QgKm9iaiwKKwkJCSAgICAgICBzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSkKK3sK
KwlpbnQgcmV0OworCisJcmV0ID0gZHJtX2dlbV9zaG1lbV9tbWFwKG9iaiwgdm1hKTsKKwlpZiAo
cmV0KQorCQlyZXR1cm4gcmV0OworCisJdm1hLT52bV9wYWdlX3Byb3QgPSB2bV9nZXRfcGFnZV9w
cm90KHZtYS0+dm1fZmxhZ3MpOworCWlmIChvYmotPmltcG9ydF9hdHRhY2gpCisJCXZtYS0+dm1f
cGFnZV9wcm90ID0gcGdwcm90X3dyaXRlY29tYmluZSh2bWEtPnZtX3BhZ2VfcHJvdCk7CisJdm1h
LT52bV9wYWdlX3Byb3QgPSBwZ3Byb3RfZGVjcnlwdGVkKHZtYS0+dm1fcGFnZV9wcm90KTsKKwor
CXJldHVybiAwOworfQorCitzdGF0aWMgdm9pZCAqdWRsX2dlbV9vYmplY3Rfdm1hcChzdHJ1Y3Qg
ZHJtX2dlbV9vYmplY3QgKm9iaikKK3sKKwlzdHJ1Y3QgZHJtX2dlbV9zaG1lbV9vYmplY3QgKnNo
bWVtID0gdG9fZHJtX2dlbV9zaG1lbV9vYmoob2JqKTsKKwlpbnQgcmV0OworCisJcmV0ID0gbXV0
ZXhfbG9ja19pbnRlcnJ1cHRpYmxlKCZzaG1lbS0+dm1hcF9sb2NrKTsKKwlpZiAocmV0KQorCQly
ZXR1cm4gRVJSX1BUUihyZXQpOworCisJaWYgKHNobWVtLT52bWFwX3VzZV9jb3VudCsrID4gMCkK
KwkJZ290byBvdXQ7CisKKwlyZXQgPSBkcm1fZ2VtX3NobWVtX2dldF9wYWdlcyhzaG1lbSk7CisJ
aWYgKHJldCkKKwkJZ290byBlcnJfemVyb191c2U7CisKKwlpZiAob2JqLT5pbXBvcnRfYXR0YWNo
KQorCQlzaG1lbS0+dmFkZHIgPSBkbWFfYnVmX3ZtYXAob2JqLT5pbXBvcnRfYXR0YWNoLT5kbWFi
dWYpOworCWVsc2UKKwkJc2htZW0tPnZhZGRyID0gdm1hcChzaG1lbS0+cGFnZXMsIG9iai0+c2l6
ZSA+PiBQQUdFX1NISUZULAorCQkJCSAgICBWTV9NQVAsIFBBR0VfS0VSTkVMKTsKKworCWlmICgh
c2htZW0tPnZhZGRyKSB7CisJCURSTV9ERUJVR19LTVMoIkZhaWxlZCB0byB2bWFwIHBhZ2VzXG4i
KTsKKwkJcmV0ID0gLUVOT01FTTsKKwkJZ290byBlcnJfcHV0X3BhZ2VzOworCX0KKworb3V0Ogor
CW11dGV4X3VubG9jaygmc2htZW0tPnZtYXBfbG9jayk7CisJcmV0dXJuIHNobWVtLT52YWRkcjsK
KworZXJyX3B1dF9wYWdlczoKKwlkcm1fZ2VtX3NobWVtX3B1dF9wYWdlcyhzaG1lbSk7CitlcnJf
emVyb191c2U6CisJc2htZW0tPnZtYXBfdXNlX2NvdW50ID0gMDsKKwltdXRleF91bmxvY2soJnNo
bWVtLT52bWFwX2xvY2spOworCXJldHVybiBFUlJfUFRSKHJldCk7Cit9CisKK3N0YXRpYyBjb25z
dCBzdHJ1Y3QgZHJtX2dlbV9vYmplY3RfZnVuY3MgdWRsX2dlbV9vYmplY3RfZnVuY3MgPSB7CisJ
LmZyZWUgPSB1ZGxfZ2VtX29iamVjdF9mcmVlX29iamVjdCwKKwkucHJpbnRfaW5mbyA9IGRybV9n
ZW1fc2htZW1fcHJpbnRfaW5mbywKKwkucGluID0gZHJtX2dlbV9zaG1lbV9waW4sCisJLnVucGlu
ID0gZHJtX2dlbV9zaG1lbV91bnBpbiwKKwkuZ2V0X3NnX3RhYmxlID0gZHJtX2dlbV9zaG1lbV9n
ZXRfc2dfdGFibGUsCisJLnZtYXAgPSB1ZGxfZ2VtX29iamVjdF92bWFwLAorCS52dW5tYXAgPSBk
cm1fZ2VtX3NobWVtX3Z1bm1hcCwKKwkubW1hcCA9IHVkbF9nZW1fb2JqZWN0X21tYXAsCit9Owor
CiAvKgogICogSGVscGVycyBmb3Igc3RydWN0IGRybV9kcml2ZXIKICAqLwpAQCAtMTksMTMgKzEw
OCwxNyBAQAogc3RydWN0IGRybV9nZW1fb2JqZWN0ICp1ZGxfZHJpdmVyX2dlbV9jcmVhdGVfb2Jq
ZWN0KHN0cnVjdCBkcm1fZGV2aWNlICpkZXYsCiAJCQkJCQkgICAgc2l6ZV90IHNpemUpCiB7Ci0J
c3RydWN0IHVkbF9nZW1fb2JqZWN0ICpvYmo7CisJc3RydWN0IGRybV9nZW1fc2htZW1fb2JqZWN0
ICpzaG1lbTsKKwlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKm9iajsKIAotCW9iaiA9IGt6YWxsb2Mo
c2l6ZW9mKCpvYmopLCBHRlBfS0VSTkVMKTsKLQlpZiAoIW9iaikKKwlzaG1lbSA9IGt6YWxsb2Mo
c2l6ZW9mKCpzaG1lbSksIEdGUF9LRVJORUwpOworCWlmICghc2htZW0pCiAJCXJldHVybiBOVUxM
OwogCi0JcmV0dXJuICZvYmotPmJhc2U7CisJb2JqID0gJnNobWVtLT5iYXNlOworCW9iai0+ZnVu
Y3MgPSAmdWRsX2dlbV9vYmplY3RfZnVuY3M7CisKKwlyZXR1cm4gb2JqOwogfQogCiBzdHJ1Y3Qg
dWRsX2dlbV9vYmplY3QgKnVkbF9nZW1fYWxsb2Nfb2JqZWN0KHN0cnVjdCBkcm1fZGV2aWNlICpk
ZXYsCi0tIAoyLjIzLjAKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fCmRyaS1kZXZlbCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9w
Lm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1k
ZXZlbA==
