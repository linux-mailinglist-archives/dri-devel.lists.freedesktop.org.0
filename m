Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 25EADA755A
	for <lists+dri-devel@lfdr.de>; Tue,  3 Sep 2019 22:48:36 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 6C41689B9F;
	Tue,  3 Sep 2019 20:48:28 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6AC9089B4D;
 Tue,  3 Sep 2019 20:48:26 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id E9AAA2A09B5;
 Tue,  3 Sep 2019 20:48:25 +0000 (UTC)
Received: from malachite.bss.redhat.com (dhcp-10-20-1-34.bss.redhat.com
 [10.20.1.34])
 by smtp.corp.redhat.com (Postfix) with ESMTP id ABE061001B08;
 Tue,  3 Sep 2019 20:48:24 +0000 (UTC)
From: Lyude Paul <lyude@redhat.com>
To: dri-devel@lists.freedesktop.org, nouveau@lists.freedesktop.org,
 amd-gfx@lists.freedesktop.org
Subject: [PATCH v2 13/27] drm/dp_mst: Refactor drm_dp_mst_handle_down_rep()
Date: Tue,  3 Sep 2019 16:45:51 -0400
Message-Id: <20190903204645.25487-14-lyude@redhat.com>
In-Reply-To: <20190903204645.25487-1-lyude@redhat.com>
References: <20190903204645.25487-1-lyude@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.38]); Tue, 03 Sep 2019 20:48:26 +0000 (UTC)
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sean Paul <sean@poorly.run>, David Airlie <airlied@linux.ie>,
 Daniel Vetter <daniel.vetter@ffwll.ch>, linux-kernel@vger.kernel.org,
 Maxime Ripard <mripard@kernel.org>, Juston Li <juston.li@intel.com>,
 Harry Wentland <hwentlan@amd.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

KiBSZW1vdmUgdGhlIGJpZyB1Z2x5IGhhdmVfZW9tdCBjb25kaXRpb25hbAoqIFN0b3JlICZtZ3It
PmRvd25fcmVwX3JlY3YuaW5pdGlhbF9oZHIgaW4gYSB2YXIgdG8gbWFrZSBsaW5lIHdyYXBwaW5n
CiAgZWFzaWVyCiogUmVtb3ZlIGR1cGxpY2F0ZSBtZW1zZXQoKSBjYWxscwoqIEFjdHVhbGx5IHdy
YXAgbGluZXMKCkNjOiBKdXN0b24gTGkgPGp1c3Rvbi5saUBpbnRlbC5jb20+CkNjOiBJbXJlIERl
YWsgPGltcmUuZGVha0BpbnRlbC5jb20+CkNjOiBWaWxsZSBTeXJqw6Rsw6QgPHZpbGxlLnN5cmph
bGFAbGludXguaW50ZWwuY29tPgpDYzogSGFycnkgV2VudGxhbmQgPGh3ZW50bGFuQGFtZC5jb20+
ClJldmlld2VkLWJ5OiBEYW5pZWwgVmV0dGVyIDxkYW5pZWwudmV0dGVyQGZmd2xsLmNoPgpTaWdu
ZWQtb2ZmLWJ5OiBMeXVkZSBQYXVsIDxseXVkZUByZWRoYXQuY29tPgotLS0KIGRyaXZlcnMvZ3B1
L2RybS9kcm1fZHBfbXN0X3RvcG9sb2d5LmMgfCAxMDIgKysrKysrKysrKysrKy0tLS0tLS0tLS0t
LS0KIDEgZmlsZSBjaGFuZ2VkLCA1MCBpbnNlcnRpb25zKCspLCA1MiBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5jIGIvZHJpdmVy
cy9ncHUvZHJtL2RybV9kcF9tc3RfdG9wb2xvZ3kuYwppbmRleCA2NDQ4NzA5ODE1OGEuLjc0MTYx
ZjQ0MjU4NCAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL2RybV9kcF9tc3RfdG9wb2xvZ3ku
YworKysgYi9kcml2ZXJzL2dwdS9kcm0vZHJtX2RwX21zdF90b3BvbG9neS5jCkBAIC0zMTc5LDY4
ICszMTc5LDY2IEBAIHN0YXRpYyBib29sIGRybV9kcF9nZXRfb25lX3NiX21zZyhzdHJ1Y3QgZHJt
X2RwX21zdF90b3BvbG9neV9tZ3IgKm1nciwgYm9vbCB1cCkKIAogc3RhdGljIGludCBkcm1fZHBf
bXN0X2hhbmRsZV9kb3duX3JlcChzdHJ1Y3QgZHJtX2RwX21zdF90b3BvbG9neV9tZ3IgKm1ncikK
IHsKLQlpbnQgcmV0ID0gMDsKKwlzdHJ1Y3QgZHJtX2RwX3NpZGViYW5kX21zZ190eCAqdHhtc2c7
CisJc3RydWN0IGRybV9kcF9tc3RfYnJhbmNoICptc3RiOworCXN0cnVjdCBkcm1fZHBfc2lkZWJh
bmRfbXNnX2hkciAqaGRyID0gJm1nci0+ZG93bl9yZXBfcmVjdi5pbml0aWFsX2hkcjsKKwlpbnQg
c2xvdCA9IC0xOworCisJaWYgKCFkcm1fZHBfZ2V0X29uZV9zYl9tc2cobWdyLCBmYWxzZSkpCisJ
CWdvdG8gY2xlYXJfZG93bl9yZXBfcmVjdjsKIAotCWlmICghZHJtX2RwX2dldF9vbmVfc2JfbXNn
KG1nciwgZmFsc2UpKSB7Ci0JCW1lbXNldCgmbWdyLT5kb3duX3JlcF9yZWN2LCAwLAotCQkgICAg
ICAgc2l6ZW9mKHN0cnVjdCBkcm1fZHBfc2lkZWJhbmRfbXNnX3J4KSk7CisJaWYgKCFtZ3ItPmRv
d25fcmVwX3JlY3YuaGF2ZV9lb210KQogCQlyZXR1cm4gMDsKKworCW1zdGIgPSBkcm1fZHBfZ2V0
X21zdF9icmFuY2hfZGV2aWNlKG1nciwgaGRyLT5sY3QsIGhkci0+cmFkKTsKKwlpZiAoIW1zdGIp
IHsKKwkJRFJNX0RFQlVHX0tNUygiR290IE1TVCByZXBseSBmcm9tIHVua25vd24gZGV2aWNlICVk
XG4iLAorCQkJICAgICAgaGRyLT5sY3QpOworCQlnb3RvIGNsZWFyX2Rvd25fcmVwX3JlY3Y7CiAJ
fQogCi0JaWYgKG1nci0+ZG93bl9yZXBfcmVjdi5oYXZlX2VvbXQpIHsKLQkJc3RydWN0IGRybV9k
cF9zaWRlYmFuZF9tc2dfdHggKnR4bXNnOwotCQlzdHJ1Y3QgZHJtX2RwX21zdF9icmFuY2ggKm1z
dGI7Ci0JCWludCBzbG90ID0gLTE7Ci0JCW1zdGIgPSBkcm1fZHBfZ2V0X21zdF9icmFuY2hfZGV2
aWNlKG1nciwKLQkJCQkJCSAgICBtZ3ItPmRvd25fcmVwX3JlY3YuaW5pdGlhbF9oZHIubGN0LAot
CQkJCQkJICAgIG1nci0+ZG93bl9yZXBfcmVjdi5pbml0aWFsX2hkci5yYWQpOworCS8qIGZpbmQg
dGhlIG1lc3NhZ2UgKi8KKwlzbG90ID0gaGRyLT5zZXFubzsKKwltdXRleF9sb2NrKCZtZ3ItPnFs
b2NrKTsKKwl0eG1zZyA9IG1zdGItPnR4X3Nsb3RzW3Nsb3RdOworCS8qIHJlbW92ZSBmcm9tIHNs
b3RzICovCisJbXV0ZXhfdW5sb2NrKCZtZ3ItPnFsb2NrKTsKIAotCQlpZiAoIW1zdGIpIHsKLQkJ
CURSTV9ERUJVR19LTVMoIkdvdCBNU1QgcmVwbHkgZnJvbSB1bmtub3duIGRldmljZSAlZFxuIiwg
bWdyLT5kb3duX3JlcF9yZWN2LmluaXRpYWxfaGRyLmxjdCk7Ci0JCQltZW1zZXQoJm1nci0+ZG93
bl9yZXBfcmVjdiwgMCwgc2l6ZW9mKHN0cnVjdCBkcm1fZHBfc2lkZWJhbmRfbXNnX3J4KSk7Ci0J
CQlyZXR1cm4gMDsKLQkJfQorCWlmICghdHhtc2cpIHsKKwkJRFJNX0RFQlVHX0tNUygiR290IE1T
VCByZXBseSB3aXRoIG5vIG1zZyAlcCAlZCAlZCAlMDJ4ICUwMnhcbiIsCisJCQkgICAgICBtc3Ri
LCBoZHItPnNlcW5vLCBoZHItPmxjdCwgaGRyLT5yYWRbMF0sCisJCQkgICAgICBtZ3ItPmRvd25f
cmVwX3JlY3YubXNnWzBdKTsKKwkJZ290byBub19tc2c7CisJfQogCi0JCS8qIGZpbmQgdGhlIG1l
c3NhZ2UgKi8KLQkJc2xvdCA9IG1nci0+ZG93bl9yZXBfcmVjdi5pbml0aWFsX2hkci5zZXFubzsK
LQkJbXV0ZXhfbG9jaygmbWdyLT5xbG9jayk7Ci0JCXR4bXNnID0gbXN0Yi0+dHhfc2xvdHNbc2xv
dF07Ci0JCS8qIHJlbW92ZSBmcm9tIHNsb3RzICovCi0JCW11dGV4X3VubG9jaygmbWdyLT5xbG9j
ayk7Ci0KLQkJaWYgKCF0eG1zZykgewotCQkJRFJNX0RFQlVHX0tNUygiR290IE1TVCByZXBseSB3
aXRoIG5vIG1zZyAlcCAlZCAlZCAlMDJ4ICUwMnhcbiIsCi0JCQkgICAgICAgbXN0YiwKLQkJCSAg
ICAgICBtZ3ItPmRvd25fcmVwX3JlY3YuaW5pdGlhbF9oZHIuc2Vxbm8sCi0JCQkgICAgICAgbWdy
LT5kb3duX3JlcF9yZWN2LmluaXRpYWxfaGRyLmxjdCwKLQkJCQkgICAgICBtZ3ItPmRvd25fcmVw
X3JlY3YuaW5pdGlhbF9oZHIucmFkWzBdLAotCQkJCSAgICAgIG1nci0+ZG93bl9yZXBfcmVjdi5t
c2dbMF0pOwotCQkJZHJtX2RwX21zdF90b3BvbG9neV9wdXRfbXN0Yihtc3RiKTsKLQkJCW1lbXNl
dCgmbWdyLT5kb3duX3JlcF9yZWN2LCAwLCBzaXplb2Yoc3RydWN0IGRybV9kcF9zaWRlYmFuZF9t
c2dfcngpKTsKLQkJCXJldHVybiAwOwotCQl9CisJZHJtX2RwX3NpZGViYW5kX3BhcnNlX3JlcGx5
KCZtZ3ItPmRvd25fcmVwX3JlY3YsICZ0eG1zZy0+cmVwbHkpOwogCi0JCWRybV9kcF9zaWRlYmFu
ZF9wYXJzZV9yZXBseSgmbWdyLT5kb3duX3JlcF9yZWN2LCAmdHhtc2ctPnJlcGx5KTsKKwlpZiAo
dHhtc2ctPnJlcGx5LnJlcGx5X3R5cGUgPT0gRFBfU0lERUJBTkRfUkVQTFlfTkFLKQorCQlEUk1f
REVCVUdfS01TKCJHb3QgTkFLIHJlcGx5OiByZXEgMHglMDJ4ICglcyksIHJlYXNvbiAweCUwMngg
KCVzKSwgbmFrIGRhdGEgMHglMDJ4XG4iLAorCQkJICAgICAgdHhtc2ctPnJlcGx5LnJlcV90eXBl
LAorCQkJICAgICAgZHJtX2RwX21zdF9yZXFfdHlwZV9zdHIodHhtc2ctPnJlcGx5LnJlcV90eXBl
KSwKKwkJCSAgICAgIHR4bXNnLT5yZXBseS51Lm5hay5yZWFzb24sCisJCQkgICAgICBkcm1fZHBf
bXN0X25ha19yZWFzb25fc3RyKHR4bXNnLT5yZXBseS51Lm5hay5yZWFzb24pLAorCQkJICAgICAg
dHhtc2ctPnJlcGx5LnUubmFrLm5ha19kYXRhKTsKIAotCQlpZiAodHhtc2ctPnJlcGx5LnJlcGx5
X3R5cGUgPT0gRFBfU0lERUJBTkRfUkVQTFlfTkFLKQotCQkJRFJNX0RFQlVHX0tNUygiR290IE5B
SyByZXBseTogcmVxIDB4JTAyeCAoJXMpLCByZWFzb24gMHglMDJ4ICglcyksIG5hayBkYXRhIDB4
JTAyeFxuIiwKLQkJCQkgICAgICB0eG1zZy0+cmVwbHkucmVxX3R5cGUsCi0JCQkJICAgICAgZHJt
X2RwX21zdF9yZXFfdHlwZV9zdHIodHhtc2ctPnJlcGx5LnJlcV90eXBlKSwKLQkJCQkgICAgICB0
eG1zZy0+cmVwbHkudS5uYWsucmVhc29uLAotCQkJCSAgICAgIGRybV9kcF9tc3RfbmFrX3JlYXNv
bl9zdHIodHhtc2ctPnJlcGx5LnUubmFrLnJlYXNvbiksCi0JCQkJICAgICAgdHhtc2ctPnJlcGx5
LnUubmFrLm5ha19kYXRhKTsKLQotCQltZW1zZXQoJm1nci0+ZG93bl9yZXBfcmVjdiwgMCwgc2l6
ZW9mKHN0cnVjdCBkcm1fZHBfc2lkZWJhbmRfbXNnX3J4KSk7Ci0JCWRybV9kcF9tc3RfdG9wb2xv
Z3lfcHV0X21zdGIobXN0Yik7CisJbWVtc2V0KCZtZ3ItPmRvd25fcmVwX3JlY3YsIDAsIHNpemVv
ZihzdHJ1Y3QgZHJtX2RwX3NpZGViYW5kX21zZ19yeCkpOworCWRybV9kcF9tc3RfdG9wb2xvZ3lf
cHV0X21zdGIobXN0Yik7CiAKLQkJbXV0ZXhfbG9jaygmbWdyLT5xbG9jayk7Ci0JCXR4bXNnLT5z
dGF0ZSA9IERSTV9EUF9TSURFQkFORF9UWF9SWDsKLQkJbXN0Yi0+dHhfc2xvdHNbc2xvdF0gPSBO
VUxMOwotCQltdXRleF91bmxvY2soJm1nci0+cWxvY2spOworCW11dGV4X2xvY2soJm1nci0+cWxv
Y2spOworCXR4bXNnLT5zdGF0ZSA9IERSTV9EUF9TSURFQkFORF9UWF9SWDsKKwltc3RiLT50eF9z
bG90c1tzbG90XSA9IE5VTEw7CisJbXV0ZXhfdW5sb2NrKCZtZ3ItPnFsb2NrKTsKIAotCQl3YWtl
X3VwX2FsbCgmbWdyLT50eF93YWl0cSk7Ci0JfQotCXJldHVybiByZXQ7CisJd2FrZV91cF9hbGwo
Jm1nci0+dHhfd2FpdHEpOworCisJcmV0dXJuIDA7CisKK25vX21zZzoKKwlkcm1fZHBfbXN0X3Rv
cG9sb2d5X3B1dF9tc3RiKG1zdGIpOworY2xlYXJfZG93bl9yZXBfcmVjdjoKKwltZW1zZXQoJm1n
ci0+ZG93bl9yZXBfcmVjdiwgMCwgc2l6ZW9mKHN0cnVjdCBkcm1fZHBfc2lkZWJhbmRfbXNnX3J4
KSk7CisKKwlyZXR1cm4gMDsKIH0KIAogc3RhdGljIGludCBkcm1fZHBfbXN0X2hhbmRsZV91cF9y
ZXEoc3RydWN0IGRybV9kcF9tc3RfdG9wb2xvZ3lfbWdyICptZ3IpCi0tIAoyLjIxLjAKCl9fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBtYWls
aW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZy
ZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
