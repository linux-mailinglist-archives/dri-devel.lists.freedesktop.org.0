Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 934847D3D4
	for <lists+dri-devel@lfdr.de>; Thu,  1 Aug 2019 05:45:09 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 155AF6E342;
	Thu,  1 Aug 2019 03:45:01 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pf1-x443.google.com (mail-pf1-x443.google.com
 [IPv6:2607:f8b0:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id EC9D16E342
 for <dri-devel@lists.freedesktop.org>; Thu,  1 Aug 2019 03:44:59 +0000 (UTC)
Received: by mail-pf1-x443.google.com with SMTP id t16so33122132pfe.11
 for <dri-devel@lists.freedesktop.org>; Wed, 31 Jul 2019 20:44:59 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=i9tvfzQD5GYsRh7YNElgPmwFI+U0VLLDkgmIyzror5U=;
 b=MPzQsgkJwVqven0HbmICibN42LmqykzQ5k/GasLSDB8DoSNF4EB4eaqfDHxr4C3Jgi
 G0pJHkEkOkoD9TrAbcpjEMTlMTC5Kb1WYqL6GzCsS/Qj8NSFiO8+YohN7ny/tQRZc+oT
 2NsXipUOH7QV6VmmjcledZSW/+KPvVnY1wQMZHB2OYQcwrcP5q2JFuljGCZyemfYUpsz
 eMU9kN1qCxKYg2OlwNixs0Uqr5P8gTSt22G/jcQES/tGnQhn/5ZjJkbfjWZRGP0i3sVv
 XXKAFlWHRdD5bBU0uNk52BOzcoQyMElmtBMbchSVSujbQixagFdZoiHqzsdFPQ5E0Gpe
 IedQ==
X-Gm-Message-State: APjAAAVjBnf3+BF/5HUgq+poq+S4KUL6BPxjVxnjcAJNEsg4Y4GdmPWQ
 MgAkZLPT/FuH08wiqEBulGv7BQ==
X-Google-Smtp-Source: APXvYqxXS0ixA/6BUpAhCw+3McQUY7SwDb3Y/AY61ODIUsKrYf+q0YrtOTqzm7TiGwQHRTO2l+8TKA==
X-Received: by 2002:a62:2784:: with SMTP id n126mr51725593pfn.61.1564631099327; 
 Wed, 31 Jul 2019 20:44:59 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 h70sm64775674pgc.36.2019.07.31.20.44.57
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Wed, 31 Jul 2019 20:44:58 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v3 09/26] drm: kirin: Dynamically allocate the hw_ctx
Date: Thu,  1 Aug 2019 03:44:22 +0000
Message-Id: <20190801034439.98227-10-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190801034439.98227-1-john.stultz@linaro.org>
References: <20190801034439.98227-1-john.stultz@linaro.org>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=i9tvfzQD5GYsRh7YNElgPmwFI+U0VLLDkgmIyzror5U=;
 b=NvAaPqg/OKsgDwROr9SrTE84PizBpsBU2U6mbQoJNWffNUlem5m/Yh7dANZyMKA/FI
 dfdr4M5TLfEFnhUXw4uq8WRJAbF9MeSvijqNkjkw62arF3uXeLXWYhs33bgjkzXxE1N7
 pQAxj7FU+i1sHx4m4ZAy4WVt9aKd5psi7BPbkWLPXGWknTwdMdpY9k2Q8OPiNfs1uQ2H
 2X8MkgwM6uzTIcwh6hDYuWjSWHmgTsvBR76DBYxB91GJUx8cCG4hjKFV/rxAlbCbojQF
 bUOJ0qr0m2QVYfSWs39hfsCR97POLh4BjA9fLNcRzhsZXH8NxJSvkabw6pFJl4Xo5kEE
 LOAA==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Xu YiPing <xuyiping@hisilicon.com>, David Airlie <airlied@linux.ie>,
 dri-devel <dri-devel@lists.freedesktop.org>,
 Rongrong Zou <zourongrong@gmail.com>, Sam Ravnborg <sam@ravnborg.org>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogWHUgWWlQaW5nIDx4dXlpcGluZ0BoaXNpbGljb24uY29tPgoKQXMgcGFydCBvZiByZWZh
Y3RvcmluZyB0aGUga2lyaW4gZHJpdmVyIHRvIGJldHRlciBzdXBwb3J0CmRpZmZlcmVudCBoYXJk
d2FyZSByZXZpc2lvbnMsIHRoaXMgcGF0Y2ggbW9kaWZpZXMgdGhlCmluaXRpYWxpemF0aW9uIGZ1
bmN0aW9uIHRvIGR5bmFtaWNhbGx5IGFsbG9jYXRlIHRoZSBhZGVfaHdfY3R4CnN0cnVjdHVyZSBw
cmV2aW91c2x5IGtlcHQgYXMgcGFydCBvZiBzdHJ1Y3QgYWRlX2RhdGEuCgpUaGlzIGlzIGRvbmUg
c28gdGhhdCBsYXRlciB3ZSBjYW4gaGF2ZSB0aGUgaHdfY3R4IHBvaW50IHRvCmhhcmR3YXJlIHJl
dmlzaW9uIHNwZWNpZmljIGN0eCBzdHJ1Y3R1cmVzLgoKQ2M6IFJvbmdyb25nIFpvdSA8em91cm9u
Z3JvbmdAZ21haWwuY29tPgpDYzogRGF2aWQgQWlybGllIDxhaXJsaWVkQGxpbnV4LmllPgpDYzog
RGFuaWVsIFZldHRlciA8ZGFuaWVsQGZmd2xsLmNoPgpDYzogZHJpLWRldmVsIDxkcmktZGV2ZWxA
bGlzdHMuZnJlZWRlc2t0b3Aub3JnPgpDYzogU2FtIFJhdm5ib3JnIDxzYW1AcmF2bmJvcmcub3Jn
PgpSZXZpZXdlZC1ieTogU2FtIFJhdm5ib3JnIDxzYW1AcmF2bmJvcmcub3JnPgpTaWduZWQtb2Zm
LWJ5OiBYdSBZaVBpbmcgPHh1eWlwaW5nQGhpc2lsaWNvbi5jb20+Cltqc3R1bHR6OiByZXdvcmRl
ZCBjb21taXQgbWVzc2FnZV0KU2lnbmVkLW9mZi1ieTogSm9obiBTdHVsdHogPGpvaG4uc3R1bHR6
QGxpbmFyby5vcmc+Ci0tLQogLi4uL2dwdS9kcm0vaGlzaWxpY29uL2tpcmluL2tpcmluX2RybV9h
ZGUuYyAgIHwgMzkgKysrKysrKysrKysrLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDI0IGluc2Vy
dGlvbnMoKyksIDE1IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9o
aXNpbGljb24va2lyaW4va2lyaW5fZHJtX2FkZS5jIGIvZHJpdmVycy9ncHUvZHJtL2hpc2lsaWNv
bi9raXJpbi9raXJpbl9kcm1fYWRlLmMKaW5kZXggZWUzZGMzZDBmNzM4Li5kZGNmZTBjNDJkN2Mg
MTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9oaXNpbGljb24va2lyaW4va2lyaW5fZHJtX2Fk
ZS5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9oaXNpbGljb24va2lyaW4va2lyaW5fZHJtX2FkZS5j
CkBAIC03Miw3ICs3Miw3IEBAIHN0cnVjdCBraXJpbl9wbGFuZSB7CiBzdHJ1Y3QgYWRlX2RhdGEg
ewogCXN0cnVjdCBraXJpbl9jcnRjIGNydGM7CiAJc3RydWN0IGtpcmluX3BsYW5lIHBsYW5lc1tB
REVfQ0hfTlVNXTsKLQlzdHJ1Y3QgYWRlX2h3X2N0eCBjdHg7CisJc3RydWN0IGFkZV9od19jdHgg
Kmh3X2N0eDsKIH07CiAKIC8qIGFkZS1mb3JtYXQgaW5mbzogKi8KQEAgLTk1MSw1NSArOTUxLDYy
IEBAIHN0YXRpYyBpbnQgYWRlX3BsYW5lX2luaXQoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3Ry
dWN0IGtpcmluX3BsYW5lICprcGxhbmUsCiAJcmV0dXJuIDA7CiB9CiAKLXN0YXRpYyBpbnQgYWRl
X2R0c19wYXJzZShzdHJ1Y3QgcGxhdGZvcm1fZGV2aWNlICpwZGV2LCBzdHJ1Y3QgYWRlX2h3X2N0
eCAqY3R4KQorc3RhdGljIHZvaWQgKmFkZV9od19jdHhfYWxsb2Moc3RydWN0IHBsYXRmb3JtX2Rl
dmljZSAqcGRldikKIHsKIAlzdHJ1Y3QgcmVzb3VyY2UgKnJlczsKIAlzdHJ1Y3QgZGV2aWNlICpk
ZXYgPSAmcGRldi0+ZGV2OwogCXN0cnVjdCBkZXZpY2Vfbm9kZSAqbnAgPSBwZGV2LT5kZXYub2Zf
bm9kZTsKKwlzdHJ1Y3QgYWRlX2h3X2N0eCAqY3R4ID0gTlVMTDsKKworCWN0eCA9IGRldm1fa3ph
bGxvYyhkZXYsIHNpemVvZigqY3R4KSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFjdHgpIHsKKwkJRFJN
X0VSUk9SKCJmYWlsZWQgdG8gYWxsb2MgYWRlX2h3X2N0eFxuIik7CisJCXJldHVybiBFUlJfUFRS
KC1FTk9NRU0pOworCX0KIAogCXJlcyA9IHBsYXRmb3JtX2dldF9yZXNvdXJjZShwZGV2LCBJT1JF
U09VUkNFX01FTSwgMCk7CiAJY3R4LT5iYXNlID0gZGV2bV9pb3JlbWFwX3Jlc291cmNlKGRldiwg
cmVzKTsKIAlpZiAoSVNfRVJSKGN0eC0+YmFzZSkpIHsKIAkJRFJNX0VSUk9SKCJmYWlsZWQgdG8g
cmVtYXAgYWRlIGlvIGJhc2VcbiIpOwotCQlyZXR1cm4gIFBUUl9FUlIoY3R4LT5iYXNlKTsKKwkJ
cmV0dXJuIEVSUl9QVFIoLUVJTyk7CiAJfQogCiAJY3R4LT5yZXNldCA9IGRldm1fcmVzZXRfY29u
dHJvbF9nZXQoZGV2LCBOVUxMKTsKIAlpZiAoSVNfRVJSKGN0eC0+cmVzZXQpKQotCQlyZXR1cm4g
UFRSX0VSUihjdHgtPnJlc2V0KTsKKwkJcmV0dXJuIEVSUl9QVFIoLUVOT0RFVik7CiAKIAljdHgt
Pm5vY19yZWdtYXAgPQogCQlzeXNjb25fcmVnbWFwX2xvb2t1cF9ieV9waGFuZGxlKG5wLCAiaGlz
aWxpY29uLG5vYy1zeXNjb24iKTsKIAlpZiAoSVNfRVJSKGN0eC0+bm9jX3JlZ21hcCkpIHsKIAkJ
RFJNX0VSUk9SKCJmYWlsZWQgdG8gZ2V0IG5vYyByZWdtYXBcbiIpOwotCQlyZXR1cm4gUFRSX0VS
UihjdHgtPm5vY19yZWdtYXApOworCQlyZXR1cm4gRVJSX1BUUigtRU5PREVWKTsKIAl9CiAKIAlj
dHgtPmlycSA9IHBsYXRmb3JtX2dldF9pcnEocGRldiwgMCk7CiAJaWYgKGN0eC0+aXJxIDwgMCkg
ewogCQlEUk1fRVJST1IoImZhaWxlZCB0byBnZXQgaXJxXG4iKTsKLQkJcmV0dXJuIC1FTk9ERVY7
CisJCXJldHVybiBFUlJfUFRSKC1FTk9ERVYpOwogCX0KIAogCWN0eC0+YWRlX2NvcmVfY2xrID0g
ZGV2bV9jbGtfZ2V0KGRldiwgImNsa19hZGVfY29yZSIpOwogCWlmIChJU19FUlIoY3R4LT5hZGVf
Y29yZV9jbGspKSB7CiAJCURSTV9FUlJPUigiZmFpbGVkIHRvIHBhcnNlIGNsayBBREVfQ09SRVxu
Iik7Ci0JCXJldHVybiBQVFJfRVJSKGN0eC0+YWRlX2NvcmVfY2xrKTsKKwkJcmV0dXJuIEVSUl9Q
VFIoLUVOT0RFVik7CiAJfQogCiAJY3R4LT5tZWRpYV9ub2NfY2xrID0gZGV2bV9jbGtfZ2V0KGRl
diwgImNsa19jb2RlY19qcGVnIik7CiAJaWYgKElTX0VSUihjdHgtPm1lZGlhX25vY19jbGspKSB7
CiAJCURSTV9FUlJPUigiZmFpbGVkIHRvIHBhcnNlIGNsayBDT0RFQ19KUEVHXG4iKTsKLQkJcmV0
dXJuIFBUUl9FUlIoY3R4LT5tZWRpYV9ub2NfY2xrKTsKKwkJcmV0dXJuIEVSUl9QVFIoLUVOT0RF
Vik7CiAJfQogCiAJY3R4LT5hZGVfcGl4X2NsayA9IGRldm1fY2xrX2dldChkZXYsICJjbGtfYWRl
X3BpeCIpOwogCWlmIChJU19FUlIoY3R4LT5hZGVfcGl4X2NsaykpIHsKIAkJRFJNX0VSUk9SKCJm
YWlsZWQgdG8gcGFyc2UgY2xrIEFERV9QSVhcbiIpOwotCQlyZXR1cm4gUFRSX0VSUihjdHgtPmFk
ZV9waXhfY2xrKTsKKwkJcmV0dXJuIEVSUl9QVFIoLUVOT0RFVik7CiAJfQogCi0JcmV0dXJuIDA7
CisJcmV0dXJuIGN0eDsKIH0KIAogc3RhdGljIGludCBhZGVfZHJtX2luaXQoc3RydWN0IHBsYXRm
b3JtX2RldmljZSAqcGRldikKQEAgLTEwMjAsMTQgKzEwMjcsMTYgQEAgc3RhdGljIGludCBhZGVf
ZHJtX2luaXQoc3RydWN0IHBsYXRmb3JtX2RldmljZSAqcGRldikKIAl9CiAJcGxhdGZvcm1fc2V0
X2RydmRhdGEocGRldiwgYWRlKTsKIAotCWN0eCA9ICZhZGUtPmN0eDsKKwljdHggPSBhZGVfaHdf
Y3R4X2FsbG9jKHBkZXYpOworCWlmIChJU19FUlIoY3R4KSkgeworCQlEUk1fRVJST1IoImZhaWxl
ZCB0byBpbml0aWFsaXplIGtpcmluX3ByaXYgaHcgY3R4XG4iKTsKKwkJcmV0dXJuIC1FSU5WQUw7
CisJfQorCWFkZS0+aHdfY3R4ID0gY3R4OworCiAJa2NydGMgPSAmYWRlLT5jcnRjOwogCWtjcnRj
LT5od19jdHggPSBjdHg7CiAKLQlyZXQgPSBhZGVfZHRzX3BhcnNlKHBkZXYsIGN0eCk7Ci0JaWYg
KHJldCkKLQkJcmV0dXJuIHJldDsKLQogCS8qCiAJICogcGxhbmUgaW5pdAogCSAqIFRPRE86IE5v
dyBvbmx5IHN1cHBvcnQgcHJpbWFyeSBwbGFuZSwgb3ZlcmxheSBwbGFuZXMKLS0gCjIuMTcuMQoK
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVs
IG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlz
dHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
