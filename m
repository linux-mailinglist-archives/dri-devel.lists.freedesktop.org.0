Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 20BBAE7583
	for <lists+dri-devel@lfdr.de>; Mon, 28 Oct 2019 16:49:58 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 689746E95D;
	Mon, 28 Oct 2019 15:49:50 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mx1.suse.de (mx2.suse.de [195.135.220.15])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 7E7C16E95D
 for <dri-devel@lists.freedesktop.org>; Mon, 28 Oct 2019 15:49:34 +0000 (UTC)
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
 by mx1.suse.de (Postfix) with ESMTP id D7271B5AE;
 Mon, 28 Oct 2019 15:49:32 +0000 (UTC)
From: Thomas Zimmermann <tzimmermann@suse.de>
To: airlied@redhat.com, daniel@ffwll.ch, kraxel@redhat.com, sam@ravnborg.org,
 chen@aspeedtech.com
Subject: [PATCH 9/9] drm/ast: Enable atomic modesetting
Date: Mon, 28 Oct 2019 16:49:28 +0100
Message-Id: <20191028154928.4058-10-tzimmermann@suse.de>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191028154928.4058-1-tzimmermann@suse.de>
References: <20191028154928.4058-1-tzimmermann@suse.de>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Thomas Zimmermann <tzimmermann@suse.de>, dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBjb21taXQgc2V0cyB0aGUgcmVtYWluaW5nIGF0b21pYy1tb2Rlc2V0dGluZyBoZWxwZXJz
IGFuZCB0aGUgZmxhZwpEUklWRVJfQVRPTUlDLiBMZWdhY3kgY3Vyc29yIGZ1bmN0aW9ucyBhcmUg
cmVtb3ZlZCBpbiBmYXZvciBvZiB0aGUgY3Vyc29yCnBsYW5lLiBGb3IgcG93ZXIgbWFuYWdlbWVu
dCwgYXRvbWljIGhlbHBlcnMgcmVwbGFjZSB0aGUgaW5kdmlkdWFsCm9wZXJhdGlvbnMgdGhhdCB0
aGUgZHJpdmVyIGN1cnJlbnRseSBydW5zLgoKQXRvbWljIG1vZGVzZXR0aW5nIGlzIGVuYWJsZWQg
d2l0aCB0aGlzIGNvbW1pdC4KClNpZ25lZC1vZmYtYnk6IFRob21hcyBaaW1tZXJtYW5uIDx0emlt
bWVybWFubkBzdXNlLmRlPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9hc3QvYXN0X2Rydi5jICB8ICAy
NCArKy0KIGRyaXZlcnMvZ3B1L2RybS9hc3QvYXN0X21haW4uYyB8ICAgNSArCiBkcml2ZXJzL2dw
dS9kcm0vYXN0L2FzdF9tb2RlLmMgfCAyOTAgKystLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tCiAzIGZpbGVzIGNoYW5nZWQsIDMzIGluc2VydGlvbnMoKyksIDI4NiBkZWxldGlvbnMoLSkK
CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYXN0L2FzdF9kcnYuYyBiL2RyaXZlcnMvZ3B1
L2RybS9hc3QvYXN0X2Rydi5jCmluZGV4IDFmMTc3OTRiMDg5MC4uZDc2M2RhNmYwODM0IDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYXN0L2FzdF9kcnYuYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vYXN0L2FzdF9kcnYuYwpAQCAtOTksMTQgKzk5LDE0IEBAIGFzdF9wY2lfcmVtb3ZlKHN0cnVj
dCBwY2lfZGV2ICpwZGV2KQogCWRybV9wdXRfZGV2KGRldik7CiB9CiAKLQotCiBzdGF0aWMgaW50
IGFzdF9kcm1fZnJlZXplKHN0cnVjdCBkcm1fZGV2aWNlICpkZXYpCiB7Ci0JZHJtX2ttc19oZWxw
ZXJfcG9sbF9kaXNhYmxlKGRldik7Ci0JcGNpX3NhdmVfc3RhdGUoZGV2LT5wZGV2KTsKLQlkcm1f
ZmJfaGVscGVyX3NldF9zdXNwZW5kX3VubG9ja2VkKGRldi0+ZmJfaGVscGVyLCB0cnVlKTsKKwlp
bnQgZXJyb3I7CiAKKwllcnJvciA9IGRybV9tb2RlX2NvbmZpZ19oZWxwZXJfc3VzcGVuZChkZXYp
OworCWlmIChlcnJvcikKKwkJcmV0dXJuIGVycm9yOworCXBjaV9zYXZlX3N0YXRlKGRldi0+cGRl
dik7CiAJcmV0dXJuIDA7CiB9CiAKQEAgLTExNCwxMSArMTE0LDcgQEAgc3RhdGljIGludCBhc3Rf
ZHJtX3RoYXcoc3RydWN0IGRybV9kZXZpY2UgKmRldikKIHsKIAlhc3RfcG9zdF9ncHUoZGV2KTsK
IAotCWRybV9tb2RlX2NvbmZpZ19yZXNldChkZXYpOwotCWRybV9oZWxwZXJfcmVzdW1lX2ZvcmNl
X21vZGUoZGV2KTsKLQlkcm1fZmJfaGVscGVyX3NldF9zdXNwZW5kX3VubG9ja2VkKGRldi0+ZmJf
aGVscGVyLCBmYWxzZSk7Ci0KLQlyZXR1cm4gMDsKKwlyZXR1cm4gZHJtX21vZGVfY29uZmlnX2hl
bHBlcl9yZXN1bWUoZGV2KTsKIH0KIAogc3RhdGljIGludCBhc3RfZHJtX3Jlc3VtZShzdHJ1Y3Qg
ZHJtX2RldmljZSAqZGV2KQpAQCAtMTMxLDggKzEyNyw2IEBAIHN0YXRpYyBpbnQgYXN0X2RybV9y
ZXN1bWUoc3RydWN0IGRybV9kZXZpY2UgKmRldikKIAlyZXQgPSBhc3RfZHJtX3RoYXcoZGV2KTsK
IAlpZiAocmV0KQogCQlyZXR1cm4gcmV0OwotCi0JZHJtX2ttc19oZWxwZXJfcG9sbF9lbmFibGUo
ZGV2KTsKIAlyZXR1cm4gMDsKIH0KIApAQCAtMTUwLDYgKzE0NCw3IEBAIHN0YXRpYyBpbnQgYXN0
X3BtX3N1c3BlbmQoc3RydWN0IGRldmljZSAqZGV2KQogCXBjaV9zZXRfcG93ZXJfc3RhdGUocGRl
diwgUENJX0QzaG90KTsKIAlyZXR1cm4gMDsKIH0KKwogc3RhdGljIGludCBhc3RfcG1fcmVzdW1l
KHN0cnVjdCBkZXZpY2UgKmRldikKIHsKIAlzdHJ1Y3QgcGNpX2RldiAqcGRldiA9IHRvX3BjaV9k
ZXYoZGV2KTsKQEAgLTE2NSw3ICsxNjAsNiBAQCBzdGF0aWMgaW50IGFzdF9wbV9mcmVlemUoc3Ry
dWN0IGRldmljZSAqZGV2KQogCWlmICghZGRldiB8fCAhZGRldi0+ZGV2X3ByaXZhdGUpCiAJCXJl
dHVybiAtRU5PREVWOwogCXJldHVybiBhc3RfZHJtX2ZyZWV6ZShkZGV2KTsKLQogfQogCiBzdGF0
aWMgaW50IGFzdF9wbV90aGF3KHN0cnVjdCBkZXZpY2UgKmRldikKQEAgLTIwMyw3ICsxOTcsOSBA
QCBzdGF0aWMgc3RydWN0IHBjaV9kcml2ZXIgYXN0X3BjaV9kcml2ZXIgPSB7CiBERUZJTkVfRFJN
X0dFTV9GT1BTKGFzdF9mb3BzKTsKIAogc3RhdGljIHN0cnVjdCBkcm1fZHJpdmVyIGRyaXZlciA9
IHsKLQkuZHJpdmVyX2ZlYXR1cmVzID0gRFJJVkVSX01PREVTRVQgfCBEUklWRVJfR0VNLAorCS5k
cml2ZXJfZmVhdHVyZXMgPSBEUklWRVJfQVRPTUlDIHwKKwkJCSAgIERSSVZFUl9HRU0gfAorCQkJ
ICAgRFJJVkVSX01PREVTRVQsCiAKIAkubG9hZCA9IGFzdF9kcml2ZXJfbG9hZCwKIAkudW5sb2Fk
ID0gYXN0X2RyaXZlcl91bmxvYWQsCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vYXN0L2Fz
dF9tYWluLmMgYi9kcml2ZXJzL2dwdS9kcm0vYXN0L2FzdF9tYWluLmMKaW5kZXggNDhkNTdhYjQy
OTU1Li5iNzlmNDg0ZTliZDIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9hc3QvYXN0X21h
aW4uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vYXN0L2FzdF9tYWluLmMKQEAgLTI4LDYgKzI4LDcg
QEAKIAogI2luY2x1ZGUgPGxpbnV4L3BjaS5oPgogCisjaW5jbHVkZSA8ZHJtL2RybV9hdG9taWNf
aGVscGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9jcnRjX2hlbHBlci5oPgogI2luY2x1ZGUgPGRy
bS9kcm1fZmJfaGVscGVyLmg+CiAjaW5jbHVkZSA8ZHJtL2RybV9nZW0uaD4KQEAgLTQxMiw2ICs0
MTMsOCBAQCBlbnVtIGRybV9tb2RlX3N0YXR1cyBhc3RfbW9kZV9jb25maWdfbW9kZV92YWxpZChz
dHJ1Y3QgZHJtX2RldmljZSAqZGV2LAogc3RhdGljIGNvbnN0IHN0cnVjdCBkcm1fbW9kZV9jb25m
aWdfZnVuY3MgYXN0X21vZGVfZnVuY3MgPSB7CiAJLmZiX2NyZWF0ZSA9IGRybV9nZW1fZmJfY3Jl
YXRlLAogCS5tb2RlX3ZhbGlkID0gYXN0X21vZGVfY29uZmlnX21vZGVfdmFsaWQsCisJLmF0b21p
Y19jaGVjayA9IGRybV9hdG9taWNfaGVscGVyX2NoZWNrLAorCS5hdG9taWNfY29tbWl0ID0gZHJt
X2F0b21pY19oZWxwZXJfY29tbWl0LAogfTsKIAogc3RhdGljIHUzMiBhc3RfZ2V0X3ZyYW1faW5m
byhzdHJ1Y3QgZHJtX2RldmljZSAqZGV2KQpAQCAtNTI5LDYgKzUzMiw4IEBAIGludCBhc3RfZHJp
dmVyX2xvYWQoc3RydWN0IGRybV9kZXZpY2UgKmRldiwgdW5zaWduZWQgbG9uZyBmbGFncykKIAlp
ZiAocmV0KQogCQlnb3RvIG91dF9mcmVlOwogCisJZHJtX21vZGVfY29uZmlnX3Jlc2V0KGRldik7
CisKIAlyZXQgPSBkcm1fZmJkZXZfZ2VuZXJpY19zZXR1cChkZXYsIDMyKTsKIAlpZiAocmV0KQog
CQlnb3RvIG91dF9mcmVlOwpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2FzdC9hc3RfbW9k
ZS5jIGIvZHJpdmVycy9ncHUvZHJtL2FzdC9hc3RfbW9kZS5jCmluZGV4IGY1ZjczMjAwZThlNC4u
NWVjY2I2YWUyZWRlIDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vYXN0L2FzdF9tb2RlLmMK
KysrIGIvZHJpdmVycy9ncHUvZHJtL2FzdC9hc3RfbW9kZS5jCkBAIC00NSwxMSArNDUsNiBAQAog
CiBzdGF0aWMgc3RydWN0IGFzdF9pMmNfY2hhbiAqYXN0X2kyY19jcmVhdGUoc3RydWN0IGRybV9k
ZXZpY2UgKmRldik7CiBzdGF0aWMgdm9pZCBhc3RfaTJjX2Rlc3Ryb3koc3RydWN0IGFzdF9pMmNf
Y2hhbiAqaTJjKTsKLXN0YXRpYyBpbnQgYXN0X2N1cnNvcl9zZXQoc3RydWN0IGRybV9jcnRjICpj
cnRjLAotCQkJICBzdHJ1Y3QgZHJtX2ZpbGUgKmZpbGVfcHJpdiwKLQkJCSAgdWludDMyX3QgaGFu
ZGxlLAotCQkJICB1aW50MzJfdCB3aWR0aCwKLQkJCSAgdWludDMyX3QgaGVpZ2h0KTsKIHN0YXRp
YyBpbnQgYXN0X2N1cnNvcl9tb3ZlKHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKIAkJCSAgIGludCB4
LCBpbnQgeSk7CiAKQEAgLTU4LDkgKzUzLDYgQEAgc3RhdGljIHUzMiBjb3B5X2N1cnNvcl9pbWFn
ZSh1OCAqc3JjLCB1OCAqZHN0LCBpbnQgd2lkdGgsIGludCBoZWlnaHQpOwogc3RhdGljIGludCBh
c3RfY3Vyc29yX3VwZGF0ZSh2b2lkICpkc3QsIHZvaWQgKnNyYywgdW5zaWduZWQgaW50IHdpZHRo
LAogCQkJICAgICB1bnNpZ25lZCBpbnQgaGVpZ2h0KTsKIHN0YXRpYyB2b2lkIGFzdF9jdXJzb3Jf
c2V0X2Jhc2Uoc3RydWN0IGFzdF9wcml2YXRlICphc3QsIHU2NCBhZGRyZXNzKTsKLXN0YXRpYyBp
bnQgYXN0X3Nob3dfY3Vyc29yKHN0cnVjdCBkcm1fY3J0YyAqY3J0Yywgdm9pZCAqc3JjLAotCQkJ
ICAgdW5zaWduZWQgaW50IHdpZHRoLCB1bnNpZ25lZCBpbnQgaGVpZ2h0KTsKLXN0YXRpYyB2b2lk
IGFzdF9oaWRlX2N1cnNvcihzdHJ1Y3QgZHJtX2NydGMgKmNydGMpOwogc3RhdGljIGludCBhc3Rf
Y3Vyc29yX21vdmUoc3RydWN0IGRybV9jcnRjICpjcnRjLAogCQkJICAgaW50IHgsIGludCB5KTsK
IApAQCAtNDM0LDcgKzQyNiw3IEBAIHN0YXRpYyB2b2lkIGFzdF9zZXRfY3J0Y19yZWcoc3RydWN0
IGRybV9jcnRjICpjcnRjLCBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqbW9kCiBzdGF0aWMgdm9p
ZCBhc3Rfc2V0X29mZnNldF9yZWcoc3RydWN0IGRybV9jcnRjICpjcnRjKQogewogCXN0cnVjdCBh
c3RfcHJpdmF0ZSAqYXN0ID0gY3J0Yy0+ZGV2LT5kZXZfcHJpdmF0ZTsKLQljb25zdCBzdHJ1Y3Qg
ZHJtX2ZyYW1lYnVmZmVyICpmYiA9IGNydGMtPnByaW1hcnktPmZiOworCWNvbnN0IHN0cnVjdCBk
cm1fZnJhbWVidWZmZXIgKmZiID0gY3J0Yy0+cHJpbWFyeS0+c3RhdGUtPmZiOwogCiAJdTE2IG9m
ZnNldDsKIApAQCAtNTI4LDcgKzUyMCw3IEBAIHN0YXRpYyB2b2lkIGFzdF9zZXRfc3luY19yZWco
c3RydWN0IGRybV9kZXZpY2UgKmRldiwgc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKm1vCiBzdGF0
aWMgYm9vbCBhc3Rfc2V0X2RhY19yZWcoc3RydWN0IGRybV9jcnRjICpjcnRjLCBzdHJ1Y3QgZHJt
X2Rpc3BsYXlfbW9kZSAqbW9kZSwKIAkJICAgICBzdHJ1Y3QgYXN0X3ZiaW9zX21vZGVfaW5mbyAq
dmJpb3NfbW9kZSkKIHsKLQljb25zdCBzdHJ1Y3QgZHJtX2ZyYW1lYnVmZmVyICpmYiA9IGNydGMt
PnByaW1hcnktPmZiOworCWNvbnN0IHN0cnVjdCBkcm1fZnJhbWVidWZmZXIgKmZiID0gY3J0Yy0+
cHJpbWFyeS0+c3RhdGUtPmZiOwogCiAJc3dpdGNoIChmYi0+Zm9ybWF0LT5jcHBbMF0gKiA4KSB7
CiAJY2FzZSA4OgpAQCAtNzY1LDExMiArNzU3LDYgQEAgc3RhdGljIHZvaWQgYXN0X2NydGNfZHBt
cyhzdHJ1Y3QgZHJtX2NydGMgKmNydGMsIGludCBtb2RlKQogCX0KIH0KIAotc3RhdGljIGludCBh
c3RfY3J0Y19kb19zZXRfYmFzZShzdHJ1Y3QgZHJtX2NydGMgKmNydGMsCi0JCQkJc3RydWN0IGRy
bV9mcmFtZWJ1ZmZlciAqZmIsCi0JCQkJaW50IHgsIGludCB5LCBpbnQgYXRvbWljKQotewotCXN0
cnVjdCBkcm1fZ2VtX3ZyYW1fb2JqZWN0ICpnYm87Ci0JaW50IHJldDsKLQlzNjQgZ3B1X2FkZHI7
Ci0KLQlpZiAoIWF0b21pYyAmJiBmYikgewotCQlnYm8gPSBkcm1fZ2VtX3ZyYW1fb2ZfZ2VtKGZi
LT5vYmpbMF0pOwotCQlkcm1fZ2VtX3ZyYW1fdW5waW4oZ2JvKTsKLQl9Ci0KLQlnYm8gPSBkcm1f
Z2VtX3ZyYW1fb2ZfZ2VtKGNydGMtPnByaW1hcnktPmZiLT5vYmpbMF0pOwotCi0JcmV0ID0gZHJt
X2dlbV92cmFtX3BpbihnYm8sIERSTV9HRU1fVlJBTV9QTF9GTEFHX1ZSQU0pOwotCWlmIChyZXQp
Ci0JCXJldHVybiByZXQ7Ci0JZ3B1X2FkZHIgPSBkcm1fZ2VtX3ZyYW1fb2Zmc2V0KGdibyk7Ci0J
aWYgKGdwdV9hZGRyIDwgMCkgewotCQlyZXQgPSAoaW50KWdwdV9hZGRyOwotCQlnb3RvIGVycl9k
cm1fZ2VtX3ZyYW1fdW5waW47Ci0JfQotCi0JYXN0X3NldF9vZmZzZXRfcmVnKGNydGMpOwotCWFz
dF9zZXRfc3RhcnRfYWRkcmVzc19jcnQxKGNydGMsICh1MzIpZ3B1X2FkZHIpOwotCi0JcmV0dXJu
IDA7Ci0KLWVycl9kcm1fZ2VtX3ZyYW1fdW5waW46Ci0JZHJtX2dlbV92cmFtX3VucGluKGdibyk7
Ci0JcmV0dXJuIHJldDsKLX0KLQotc3RhdGljIGludCBhc3RfY3J0Y19tb2RlX3NldF9iYXNlKHN0
cnVjdCBkcm1fY3J0YyAqY3J0YywgaW50IHgsIGludCB5LAotCQkJICAgICBzdHJ1Y3QgZHJtX2Zy
YW1lYnVmZmVyICpvbGRfZmIpCi17Ci0JcmV0dXJuIGFzdF9jcnRjX2RvX3NldF9iYXNlKGNydGMs
IG9sZF9mYiwgeCwgeSwgMCk7Ci19Ci0KLXN0YXRpYyBpbnQgYXN0X2NydGNfbW9kZV9zZXQoc3Ry
dWN0IGRybV9jcnRjICpjcnRjLAotCQkJICAgICBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqbW9k
ZSwKLQkJCSAgICAgc3RydWN0IGRybV9kaXNwbGF5X21vZGUgKmFkanVzdGVkX21vZGUsCi0JCQkg
ICAgIGludCB4LCBpbnQgeSwKLQkJCSAgICAgc3RydWN0IGRybV9mcmFtZWJ1ZmZlciAqb2xkX2Zi
KQotewotCXN0cnVjdCBkcm1fZGV2aWNlICpkZXYgPSBjcnRjLT5kZXY7Ci0Jc3RydWN0IGFzdF9w
cml2YXRlICphc3QgPSBjcnRjLT5kZXYtPmRldl9wcml2YXRlOwotCWNvbnN0IHN0cnVjdCBkcm1f
ZnJhbWVidWZmZXIgKmZiID0gY3J0Yy0+cHJpbWFyeS0+ZmI7Ci0Jc3RydWN0IGFzdF92Ymlvc19t
b2RlX2luZm8gdmJpb3NfbW9kZTsKLQlib29sIHN1Y2M7Ci0KLQlpZiAoYXN0LT5jaGlwID09IEFT
VDExODApIHsKLQkJRFJNX0VSUk9SKCJBU1QgMTE4MCBtb2Rlc2V0dGluZyBub3Qgc3VwcG9ydGVk
XG4iKTsKLQkJcmV0dXJuIC1FSU5WQUw7Ci0JfQotCi0Jc3VjYyA9IGFzdF9nZXRfdmJpb3NfbW9k
ZV9pbmZvKGZiLCBtb2RlLCBhZGp1c3RlZF9tb2RlLCAmdmJpb3NfbW9kZSk7Ci0JaWYgKCFzdWNj
KQotCQlyZXR1cm4gLUVJTlZBTDsKLQotCWFzdF9vcGVuX2tleShhc3QpOwotCi0JYXN0X3NldF92
Ymlvc19jb2xvcl9yZWcoY3J0YywgZmIsICZ2Ymlvc19tb2RlKTsKLQlhc3Rfc2V0X3ZiaW9zX21v
ZGVfcmVnKGNydGMsIGFkanVzdGVkX21vZGUsICZ2Ymlvc19tb2RlKTsKLQlhc3Rfc2V0X2luZGV4
X3JlZyhhc3QsIEFTVF9JT19DUlRDX1BPUlQsIDB4YTEsIDB4MDYpOwotCWFzdF9zZXRfc3RkX3Jl
ZyhjcnRjLCBhZGp1c3RlZF9tb2RlLCAmdmJpb3NfbW9kZSk7Ci0JYXN0X3NldF9jcnRjX3JlZyhj
cnRjLCBhZGp1c3RlZF9tb2RlLCAmdmJpb3NfbW9kZSk7Ci0JYXN0X3NldF9vZmZzZXRfcmVnKGNy
dGMpOwotCWFzdF9zZXRfZGNsa19yZWcoZGV2LCBhZGp1c3RlZF9tb2RlLCAmdmJpb3NfbW9kZSk7
Ci0JYXN0X3NldF9jb2xvcl9yZWcoY3J0YywgZmIpOwotCWFzdF9zZXRfY3J0dGhkX3JlZyhjcnRj
KTsKLQlhc3Rfc2V0X3N5bmNfcmVnKGRldiwgYWRqdXN0ZWRfbW9kZSwgJnZiaW9zX21vZGUpOwot
CWFzdF9zZXRfZGFjX3JlZyhjcnRjLCBhZGp1c3RlZF9tb2RlLCAmdmJpb3NfbW9kZSk7Ci0KLQlh
c3RfY3J0Y19tb2RlX3NldF9iYXNlKGNydGMsIHgsIHksIG9sZF9mYik7Ci0KLQlyZXR1cm4gMDsK
LX0KLQotc3RhdGljIHZvaWQgYXN0X2NydGNfZGlzYWJsZShzdHJ1Y3QgZHJtX2NydGMgKmNydGMp
Ci17Ci0JRFJNX0RFQlVHX0tNUygiXG4iKTsKLQlhc3RfY3J0Y19kcG1zKGNydGMsIERSTV9NT0RF
X0RQTVNfT0ZGKTsKLQlpZiAoY3J0Yy0+cHJpbWFyeS0+ZmIpIHsKLQkJc3RydWN0IGRybV9mcmFt
ZWJ1ZmZlciAqZmIgPSBjcnRjLT5wcmltYXJ5LT5mYjsKLQkJc3RydWN0IGRybV9nZW1fdnJhbV9v
YmplY3QgKmdibyA9Ci0JCQlkcm1fZ2VtX3ZyYW1fb2ZfZ2VtKGZiLT5vYmpbMF0pOwotCi0JCWRy
bV9nZW1fdnJhbV91bnBpbihnYm8pOwotCX0KLQljcnRjLT5wcmltYXJ5LT5mYiA9IE5VTEw7Ci19
Ci0KLXN0YXRpYyB2b2lkIGFzdF9jcnRjX3ByZXBhcmUoc3RydWN0IGRybV9jcnRjICpjcnRjKQot
ewotCi19Ci0KLXN0YXRpYyB2b2lkIGFzdF9jcnRjX2NvbW1pdChzdHJ1Y3QgZHJtX2NydGMgKmNy
dGMpCi17Ci0Jc3RydWN0IGFzdF9wcml2YXRlICphc3QgPSBjcnRjLT5kZXYtPmRldl9wcml2YXRl
OwotCWFzdF9zZXRfaW5kZXhfcmVnX21hc2soYXN0LCBBU1RfSU9fU0VRX1BPUlQsIDB4MSwgMHhk
ZiwgMCk7Ci0JYXN0X2NydGNfbG9hZF9sdXQoY3J0Yyk7Ci19Ci0KIHN0YXRpYyBpbnQgYXN0X2Ny
dGNfaGVscGVyX2F0b21pY19jaGVjayhzdHJ1Y3QgZHJtX2NydGMgKmNydGMsCiAJCQkJCXN0cnVj
dCBkcm1fY3J0Y19zdGF0ZSAqc3RhdGUpCiB7CkBAIC05NzAsMTIgKzg1Niw2IEBAIGFzdF9jcnRj
X2hlbHBlcl9hdG9taWNfZGlzYWJsZShzdHJ1Y3QgZHJtX2NydGMgKmNydGMsCiB9CiAKIHN0YXRp
YyBjb25zdCBzdHJ1Y3QgZHJtX2NydGNfaGVscGVyX2Z1bmNzIGFzdF9jcnRjX2hlbHBlcl9mdW5j
cyA9IHsKLQkuZHBtcyA9IGFzdF9jcnRjX2RwbXMsCi0JLm1vZGVfc2V0ID0gYXN0X2NydGNfbW9k
ZV9zZXQsCi0JLm1vZGVfc2V0X2Jhc2UgPSBhc3RfY3J0Y19tb2RlX3NldF9iYXNlLAotCS5kaXNh
YmxlID0gYXN0X2NydGNfZGlzYWJsZSwKLQkucHJlcGFyZSA9IGFzdF9jcnRjX3ByZXBhcmUsCi0J
LmNvbW1pdCA9IGFzdF9jcnRjX2NvbW1pdCwKIAkuYXRvbWljX2NoZWNrID0gYXN0X2NydGNfaGVs
cGVyX2F0b21pY19jaGVjaywKIAkuYXRvbWljX2JlZ2luID0gYXN0X2NydGNfaGVscGVyX2F0b21p
Y19iZWdpbiwKIAkuYXRvbWljX2ZsdXNoID0gYXN0X2NydGNfaGVscGVyX2F0b21pY19mbHVzaCwK
QEAgLTk4MywyMSArODYzLDYgQEAgc3RhdGljIGNvbnN0IHN0cnVjdCBkcm1fY3J0Y19oZWxwZXJf
ZnVuY3MgYXN0X2NydGNfaGVscGVyX2Z1bmNzID0gewogCS5hdG9taWNfZGlzYWJsZSA9IGFzdF9j
cnRjX2hlbHBlcl9hdG9taWNfZGlzYWJsZSwKIH07CiAKLXN0YXRpYyB2b2lkIGFzdF9jcnRjX3Jl
c2V0KHN0cnVjdCBkcm1fY3J0YyAqY3J0YykKLXsKLQotfQotCi1zdGF0aWMgaW50IGFzdF9jcnRj
X2dhbW1hX3NldChzdHJ1Y3QgZHJtX2NydGMgKmNydGMsIHUxNiAqcmVkLCB1MTYgKmdyZWVuLAot
CQkJICAgICAgdTE2ICpibHVlLCB1aW50MzJfdCBzaXplLAotCQkJICAgICAgc3RydWN0IGRybV9t
b2Rlc2V0X2FjcXVpcmVfY3R4ICpjdHgpCi17Ci0JYXN0X2NydGNfbG9hZF9sdXQoY3J0Yyk7Ci0K
LQlyZXR1cm4gMDsKLX0KLQotCiBzdGF0aWMgdm9pZCBhc3RfY3J0Y19kZXN0cm95KHN0cnVjdCBk
cm1fY3J0YyAqY3J0YykKIHsKIAlkcm1fY3J0Y19jbGVhbnVwKGNydGMpOwpAQCAtMTAwNSwxMiAr
ODcwLDEyIEBAIHN0YXRpYyB2b2lkIGFzdF9jcnRjX2Rlc3Ryb3koc3RydWN0IGRybV9jcnRjICpj
cnRjKQogfQogCiBzdGF0aWMgY29uc3Qgc3RydWN0IGRybV9jcnRjX2Z1bmNzIGFzdF9jcnRjX2Z1
bmNzID0gewotCS5jdXJzb3Jfc2V0ID0gYXN0X2N1cnNvcl9zZXQsCi0JLmN1cnNvcl9tb3ZlID0g
YXN0X2N1cnNvcl9tb3ZlLAotCS5yZXNldCA9IGFzdF9jcnRjX3Jlc2V0LAorCS5yZXNldCA9IGRy
bV9hdG9taWNfaGVscGVyX2NydGNfcmVzZXQsCiAJLnNldF9jb25maWcgPSBkcm1fY3J0Y19oZWxw
ZXJfc2V0X2NvbmZpZywKLQkuZ2FtbWFfc2V0ID0gYXN0X2NydGNfZ2FtbWFfc2V0LAorCS5nYW1t
YV9zZXQgPSBkcm1fYXRvbWljX2hlbHBlcl9sZWdhY3lfZ2FtbWFfc2V0LAogCS5kZXN0cm95ID0g
YXN0X2NydGNfZGVzdHJveSwKKwkuc2V0X2NvbmZpZyA9IGRybV9hdG9taWNfaGVscGVyX3NldF9j
b25maWcsCisJLnBhZ2VfZmxpcCA9IGRybV9hdG9taWNfaGVscGVyX3BhZ2VfZmxpcCwKIAkuYXRv
bWljX2R1cGxpY2F0ZV9zdGF0ZSA9IGRybV9hdG9taWNfaGVscGVyX2NydGNfZHVwbGljYXRlX3N0
YXRlLAogCS5hdG9taWNfZGVzdHJveV9zdGF0ZSA9IGRybV9hdG9taWNfaGVscGVyX2NydGNfZGVz
dHJveV9zdGF0ZSwKIH07CkBAIC0xMDQwLDYgKzkwNSwxMCBAQCBzdGF0aWMgaW50IGFzdF9jcnRj
X2luaXQoc3RydWN0IGRybV9kZXZpY2UgKmRldikKIAlyZXR1cm4gcmV0OwogfQogCisvKgorICog
RW5jb2RlcgorICovCisKIHN0YXRpYyB2b2lkIGFzdF9lbmNvZGVyX2Rlc3Ryb3koc3RydWN0IGRy
bV9lbmNvZGVyICplbmNvZGVyKQogewogCWRybV9lbmNvZGVyX2NsZWFudXAoZW5jb2Rlcik7CkBA
IC0xMDUwLDM0ICs5MTksNiBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IGRybV9lbmNvZGVyX2Z1bmNz
IGFzdF9lbmNfZnVuY3MgPSB7CiAJLmRlc3Ryb3kgPSBhc3RfZW5jb2Rlcl9kZXN0cm95LAogfTsK
IAotc3RhdGljIHZvaWQgYXN0X2VuY29kZXJfZHBtcyhzdHJ1Y3QgZHJtX2VuY29kZXIgKmVuY29k
ZXIsIGludCBtb2RlKQotewotCi19Ci0KLXN0YXRpYyB2b2lkIGFzdF9lbmNvZGVyX21vZGVfc2V0
KHN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlciwKLQkJCSAgICAgICBzdHJ1Y3QgZHJtX2Rpc3Bs
YXlfbW9kZSAqbW9kZSwKLQkJCSAgICAgICBzdHJ1Y3QgZHJtX2Rpc3BsYXlfbW9kZSAqYWRqdXN0
ZWRfbW9kZSkKLXsKLX0KLQotc3RhdGljIHZvaWQgYXN0X2VuY29kZXJfcHJlcGFyZShzdHJ1Y3Qg
ZHJtX2VuY29kZXIgKmVuY29kZXIpCi17Ci0KLX0KLQotc3RhdGljIHZvaWQgYXN0X2VuY29kZXJf
Y29tbWl0KHN0cnVjdCBkcm1fZW5jb2RlciAqZW5jb2RlcikKLXsKLQotfQotCi1zdGF0aWMgY29u
c3Qgc3RydWN0IGRybV9lbmNvZGVyX2hlbHBlcl9mdW5jcyBhc3RfZW5jX2hlbHBlcl9mdW5jcyA9
IHsKLQkuZHBtcyA9IGFzdF9lbmNvZGVyX2RwbXMsCi0JLnByZXBhcmUgPSBhc3RfZW5jb2Rlcl9w
cmVwYXJlLAotCS5jb21taXQgPSBhc3RfZW5jb2Rlcl9jb21taXQsCi0JLm1vZGVfc2V0ID0gYXN0
X2VuY29kZXJfbW9kZV9zZXQsCi19OwotCiBzdGF0aWMgaW50IGFzdF9lbmNvZGVyX2luaXQoc3Ry
dWN0IGRybV9kZXZpY2UgKmRldikKIHsKIAlzdHJ1Y3QgYXN0X2VuY29kZXIgKmFzdF9lbmNvZGVy
OwpAQCAtMTA4OCwxMiArOTI5LDE1IEBAIHN0YXRpYyBpbnQgYXN0X2VuY29kZXJfaW5pdChzdHJ1
Y3QgZHJtX2RldmljZSAqZGV2KQogCiAJZHJtX2VuY29kZXJfaW5pdChkZXYsICZhc3RfZW5jb2Rl
ci0+YmFzZSwgJmFzdF9lbmNfZnVuY3MsCiAJCQkgRFJNX01PREVfRU5DT0RFUl9EQUMsIE5VTEwp
OwotCWRybV9lbmNvZGVyX2hlbHBlcl9hZGQoJmFzdF9lbmNvZGVyLT5iYXNlLCAmYXN0X2VuY19o
ZWxwZXJfZnVuY3MpOwogCiAJYXN0X2VuY29kZXItPmJhc2UucG9zc2libGVfY3J0Y3MgPSAxOwog
CXJldHVybiAwOwogfQogCisvKgorICogQ29ubmVjdG9yCisgKi8KKwogc3RhdGljIGludCBhc3Rf
Z2V0X21vZGVzKHN0cnVjdCBkcm1fY29ubmVjdG9yICpjb25uZWN0b3IpCiB7CiAJc3RydWN0IGFz
dF9jb25uZWN0b3IgKmFzdF9jb25uZWN0b3IgPSB0b19hc3RfY29ubmVjdG9yKGNvbm5lY3Rvcik7
CkBAIC0xMTkyLDE0ICsxMDM2LDE2IEBAIHN0YXRpYyB2b2lkIGFzdF9jb25uZWN0b3JfZGVzdHJv
eShzdHJ1Y3QgZHJtX2Nvbm5lY3RvciAqY29ubmVjdG9yKQogfQogCiBzdGF0aWMgY29uc3Qgc3Ry
dWN0IGRybV9jb25uZWN0b3JfaGVscGVyX2Z1bmNzIGFzdF9jb25uZWN0b3JfaGVscGVyX2Z1bmNz
ID0gewotCS5tb2RlX3ZhbGlkID0gYXN0X21vZGVfdmFsaWQsCiAJLmdldF9tb2RlcyA9IGFzdF9n
ZXRfbW9kZXMsCisJLm1vZGVfdmFsaWQgPSBhc3RfbW9kZV92YWxpZCwKIH07CiAKIHN0YXRpYyBj
b25zdCBzdHJ1Y3QgZHJtX2Nvbm5lY3Rvcl9mdW5jcyBhc3RfY29ubmVjdG9yX2Z1bmNzID0gewot
CS5kcG1zID0gZHJtX2hlbHBlcl9jb25uZWN0b3JfZHBtcywKKwkucmVzZXQgPSBkcm1fYXRvbWlj
X2hlbHBlcl9jb25uZWN0b3JfcmVzZXQsCiAJLmZpbGxfbW9kZXMgPSBkcm1faGVscGVyX3Byb2Jl
X3NpbmdsZV9jb25uZWN0b3JfbW9kZXMsCiAJLmRlc3Ryb3kgPSBhc3RfY29ubmVjdG9yX2Rlc3Ry
b3ksCisJLmF0b21pY19kdXBsaWNhdGVfc3RhdGUgPSBkcm1fYXRvbWljX2hlbHBlcl9jb25uZWN0
b3JfZHVwbGljYXRlX3N0YXRlLAorCS5hdG9taWNfZGVzdHJveV9zdGF0ZSA9IGRybV9hdG9taWNf
aGVscGVyX2Nvbm5lY3Rvcl9kZXN0cm95X3N0YXRlLAogfTsKIAogc3RhdGljIGludCBhc3RfY29u
bmVjdG9yX2luaXQoc3RydWN0IGRybV9kZXZpY2UgKmRldikKQEAgLTE1NDksMTA2ICsxMzk1LDYg
QEAgc3RhdGljIHZvaWQgYXN0X2N1cnNvcl9zZXRfYmFzZShzdHJ1Y3QgYXN0X3ByaXZhdGUgKmFz
dCwgdTY0IGFkZHJlc3MpCiAJYXN0X3NldF9pbmRleF9yZWcoYXN0LCBBU1RfSU9fQ1JUQ19QT1JU
LCAweGNhLCBhZGRyMik7CiB9CiAKLXN0YXRpYyBpbnQgYXN0X3Nob3dfY3Vyc29yKHN0cnVjdCBk
cm1fY3J0YyAqY3J0Yywgdm9pZCAqc3JjLAotCQkJICAgdW5zaWduZWQgaW50IHdpZHRoLCB1bnNp
Z25lZCBpbnQgaGVpZ2h0KQotewotCXN0cnVjdCBhc3RfcHJpdmF0ZSAqYXN0ID0gY3J0Yy0+ZGV2
LT5kZXZfcHJpdmF0ZTsKLQlzdHJ1Y3QgYXN0X2NydGMgKmFzdF9jcnRjID0gdG9fYXN0X2NydGMo
Y3J0Yyk7Ci0Jc3RydWN0IGRybV9nZW1fdnJhbV9vYmplY3QgKmdibzsKLQl2b2lkICpkc3Q7Ci0J
czY0IG9mZjsKLQlpbnQgcmV0OwotCXU4IGpyZWc7Ci0KLQlnYm8gPSBhc3QtPmN1cnNvci5nYm9b
YXN0LT5jdXJzb3IubmV4dF9pbmRleF07Ci0JZHN0ID0gZHJtX2dlbV92cmFtX3ZtYXAoZ2JvKTsK
LQlpZiAoSVNfRVJSKGRzdCkpCi0JCXJldHVybiBQVFJfRVJSKGRzdCk7Ci0Jb2ZmID0gZHJtX2dl
bV92cmFtX29mZnNldChnYm8pOwotCWlmIChvZmYgPCAwKSB7Ci0JCXJldCA9IChpbnQpb2ZmOwot
CQlnb3RvIGVycl9kcm1fZ2VtX3ZyYW1fdnVubWFwOwotCX0KLQotCXJldCA9IGFzdF9jdXJzb3Jf
dXBkYXRlKGRzdCwgc3JjLCB3aWR0aCwgaGVpZ2h0KTsKLQlpZiAocmV0KQotCQlnb3RvIGVycl9k
cm1fZ2VtX3ZyYW1fdnVubWFwOwotCWFzdF9jdXJzb3Jfc2V0X2Jhc2UoYXN0LCBvZmYpOwotCi0J
YXN0X2NydGMtPm9mZnNldF94ID0gQVNUX01BWF9IV0NfV0lEVEggLSB3aWR0aDsKLQlhc3RfY3J0
Yy0+b2Zmc2V0X3kgPSBBU1RfTUFYX0hXQ19XSURUSCAtIGhlaWdodDsKLQotCWpyZWcgPSAweDI7
Ci0JLyogZW5hYmxlIEFSR0IgY3Vyc29yICovCi0JanJlZyB8PSAxOwotCWFzdF9zZXRfaW5kZXhf
cmVnX21hc2soYXN0LCBBU1RfSU9fQ1JUQ19QT1JULCAweGNiLCAweGZjLCBqcmVnKTsKLQotCSsr
YXN0LT5jdXJzb3IubmV4dF9pbmRleDsKLQlhc3QtPmN1cnNvci5uZXh0X2luZGV4ICU9IEFSUkFZ
X1NJWkUoYXN0LT5jdXJzb3IuZ2JvKTsKLQotCWRybV9nZW1fdnJhbV92dW5tYXAoZ2JvLCBkc3Qp
OwotCi0JcmV0dXJuIDA7Ci0KLWVycl9kcm1fZ2VtX3ZyYW1fdnVubWFwOgotCWRybV9nZW1fdnJh
bV92dW5tYXAoZ2JvLCBkc3QpOwotCXJldHVybiByZXQ7Ci19Ci0KLXN0YXRpYyB2b2lkIGFzdF9o
aWRlX2N1cnNvcihzdHJ1Y3QgZHJtX2NydGMgKmNydGMpCi17Ci0Jc3RydWN0IGFzdF9wcml2YXRl
ICphc3QgPSBjcnRjLT5kZXYtPmRldl9wcml2YXRlOwotCi0JYXN0X3NldF9pbmRleF9yZWdfbWFz
ayhhc3QsIEFTVF9JT19DUlRDX1BPUlQsIDB4Y2IsIDB4ZmMsIDB4MDApOwotfQotCi1zdGF0aWMg
aW50IGFzdF9jdXJzb3Jfc2V0KHN0cnVjdCBkcm1fY3J0YyAqY3J0YywKLQkJCSAgc3RydWN0IGRy
bV9maWxlICpmaWxlX3ByaXYsCi0JCQkgIHVpbnQzMl90IGhhbmRsZSwKLQkJCSAgdWludDMyX3Qg
d2lkdGgsCi0JCQkgIHVpbnQzMl90IGhlaWdodCkKLXsKLQlzdHJ1Y3QgZHJtX2dlbV9vYmplY3Qg
Km9iajsKLQlzdHJ1Y3QgZHJtX2dlbV92cmFtX29iamVjdCAqZ2JvOwotCXU4ICpzcmM7Ci0JaW50
IHJldDsKLQotCWlmICghaGFuZGxlKSB7Ci0JCWFzdF9oaWRlX2N1cnNvcihjcnRjKTsKLQkJcmV0
dXJuIDA7Ci0JfQotCi0JaWYgKHdpZHRoID4gQVNUX01BWF9IV0NfV0lEVEggfHwgaGVpZ2h0ID4g
QVNUX01BWF9IV0NfSEVJR0hUKQotCQlyZXR1cm4gLUVJTlZBTDsKLQotCW9iaiA9IGRybV9nZW1f
b2JqZWN0X2xvb2t1cChmaWxlX3ByaXYsIGhhbmRsZSk7Ci0JaWYgKCFvYmopIHsKLQkJRFJNX0VS
Uk9SKCJDYW5ub3QgZmluZCBjdXJzb3Igb2JqZWN0ICV4IGZvciBjcnRjXG4iLCBoYW5kbGUpOwot
CQlyZXR1cm4gLUVOT0VOVDsKLQl9Ci0JZ2JvID0gZHJtX2dlbV92cmFtX29mX2dlbShvYmopOwot
CXNyYyA9IGRybV9nZW1fdnJhbV92bWFwKGdibyk7Ci0JaWYgKElTX0VSUihzcmMpKSB7Ci0JCXJl
dCA9IFBUUl9FUlIoc3JjKTsKLQkJZ290byBlcnJfZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2Vk
OwotCX0KLQotCXJldCA9IGFzdF9zaG93X2N1cnNvcihjcnRjLCBzcmMsIHdpZHRoLCBoZWlnaHQp
OwotCWlmIChyZXQpCi0JCWdvdG8gZXJyX2RybV9nZW1fdnJhbV92dW5tYXA7Ci0KLQlkcm1fZ2Vt
X3ZyYW1fdnVubWFwKGdibywgc3JjKTsKLQlkcm1fZ2VtX29iamVjdF9wdXRfdW5sb2NrZWQob2Jq
KTsKLQotCXJldHVybiAwOwotCi1lcnJfZHJtX2dlbV92cmFtX3Z1bm1hcDoKLQlkcm1fZ2VtX3Zy
YW1fdnVubWFwKGdibywgc3JjKTsKLWVycl9kcm1fZ2VtX29iamVjdF9wdXRfdW5sb2NrZWQ6Ci0J
ZHJtX2dlbV9vYmplY3RfcHV0X3VubG9ja2VkKG9iaik7Ci0JcmV0dXJuIHJldDsKLX0KLQogc3Rh
dGljIGludCBhc3RfY3Vyc29yX21vdmUoc3RydWN0IGRybV9jcnRjICpjcnRjLAogCQkJICAgaW50
IHgsIGludCB5KQogewotLSAKMi4yMy4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5m
cmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0
aW5mby9kcmktZGV2ZWw=
