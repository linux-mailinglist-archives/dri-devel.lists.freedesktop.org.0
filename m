Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 83E9724D943
	for <lists+dri-devel@lfdr.de>; Fri, 21 Aug 2020 18:01:12 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 8DEFB6EAE1;
	Fri, 21 Aug 2020 16:01:04 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x441.google.com (mail-wr1-x441.google.com
 [IPv6:2a00:1450:4864:20::441])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 8E4F06EAD9;
 Fri, 21 Aug 2020 16:01:03 +0000 (UTC)
Received: by mail-wr1-x441.google.com with SMTP id 88so2424351wrh.3;
 Fri, 21 Aug 2020 09:01:03 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:subject:date:message-id:in-reply-to:references:mime-version
 :content-transfer-encoding;
 bh=VG6lgthdlBr5064pyRMNCs0P8AZVMEYmcUMNTlj0RHY=;
 b=PKRpiAP1b5h9q2J9R78wbT0F+qqUG7LAuKfLeuO/8OUW3CGz/TpFPKzfmU/6qFKQF0
 J0GRp5/d+Ssm94kT/CO+qGZRnM9ozlqNPaoYch0LlAkqKAkfxyd9ZMtq3U/+WI3wV1tN
 141WWcEs3YOoX25pJF/iRoh3UtdmfcJRht3PmWstDeoLf+XPzLcqAQxSCMrTJK7QFVqc
 Cxi8E3jd5YnypqXn6buwt+YYYSsn73HyLwysrjEHKreO5BW780Bbub7pVB+GrjAcBIVF
 dEgpnvPb9tqlAhXuMZbMV788qwnY5q0L5TmCFHD491TrZMGfAnJ/FGFbhMJIABJxRWCp
 ktLg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=VG6lgthdlBr5064pyRMNCs0P8AZVMEYmcUMNTlj0RHY=;
 b=kBBVmC/RV3QoUsubryPtX3R6sxM9Y3oXgoUVlJyN0JwxwbkfA01KMpjMgE6xsTZRIt
 6A32AvuYkkQxy7Hv7n1n89SjMgCrNcxZqK3QEjukLPz2JisZWu+QF1efq71JQGNA4Hc6
 818Tll/CUGsDJuz1XrwBGUKpq2cUhlgcjcGYdbVK0DvIwnMw25oKiAcbSFMjPZXeADxG
 x6hgnxPtu6GRD2Ey/aWKrSHjivQs/kHKY+Zk14BS8s9mpV5W+NPA5rc/jo9hHtvux51W
 t9nOC9b//CC5GORrzOP1Dl2P2NY4QpF6TbVdvIIW0exIIWxetC5oDwPFf0Od03KkeQn8
 v6lg==
X-Gm-Message-State: AOAM5304ynqm3hxQEUTbGLUoCozp2EuaJeiiQT1f++QPWDhSX4YcIBNi
 C/Mm6UrFsxLeUUqPkqRDQsQ/pXRKKW8=
X-Google-Smtp-Source: ABdhPJwa1AzwxuZJPDrcfOv+5RG4JKgkWPNyPBmMP7yrjlgSGa+ttVlqphHzPapj1oby2/v1DSUqTQ==
X-Received: by 2002:a5d:49ce:: with SMTP id t14mr1245372wrs.266.1598025662018; 
 Fri, 21 Aug 2020 09:01:02 -0700 (PDT)
Received: from abel.fritz.box ([2a02:908:1252:fb60:f174:75c9:ca38:873f])
 by smtp.gmail.com with ESMTPSA id l81sm6554993wmf.4.2020.08.21.09.00.59
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 21 Aug 2020 09:01:00 -0700 (PDT)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: airlied@gmail.com, skeggsb@gmail.com, dri-devel@lists.freedesktop.org,
 Nouveau@lists.freedesktop.org
Subject: [PATCH 2/3] drm/nouveau: move io_reserve_lru handling into the driver
 v4
Date: Fri, 21 Aug 2020 18:00:49 +0200
Message-Id: <20200821160050.1368-3-christian.koenig@amd.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20200821160050.1368-1-christian.koenig@amd.com>
References: <20200821160050.1368-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2hpbGUgd29ya2luZyBvbiBUVE0gY2xlYW51cHMgSSd2ZSBmb3VuZCB0aGF0IHRoZSBpb19yZXNl
cnZlX2xydSB1c2VkIGJ5Ck5vdXZlYXUgaXMgYWN0dWFsbHkgbm90IHdvcmtpbmcgYXQgYWxsLgoK
SW4gZ2VuZXJhbCB3ZSBzaG91bGQgcmVtb3ZlIGRyaXZlciBzcGVjaWZpYyBoYW5kbGluZyBmcm9t
IHRoZSBtZW1vcnkKbWFuYWdlbWVudCwgc28gdGhpcyBwYXRjaCBtb3ZlcyB0aGUgaW9fcmVzZXJ2
ZV9scnUgaGFuZGxpbmcgaW50byBOb3V2ZWF1Cmluc3RlYWQuCgp2MjogZG9uJ3QgY2FsbCB0dG1f
Ym9fdW5tYXBfdmlydHVhbCBpbiBub3V2ZWF1X3R0bV9pb19tZW1fcmVzZXJ2ZQp2MzogcmViYXNl
ZCBhbmQgdXNlIGJvdGggYmFzZSBhbmQgb2Zmc2V0IGluIHRoZSBjaGVjawp2NDogZml4IHNtYWxs
IHR5cG9zIGFuZCB0ZXN0IHRoZSBwYXRjaAoKU2lnbmVkLW9mZi1ieTogQ2hyaXN0aWFuIEvDtm5p
ZyA8Y2hyaXN0aWFuLmtvZW5pZ0BhbWQuY29tPgpBY2tlZC1ieTogRGFuaWVsIFZldHRlciA8ZGFu
aWVsLnZldHRlckBmZndsbC5jaD4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1
X2JvLmMgIHwgMTExICsrKysrKysrKysrKysrKysrKysrLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0v
bm91dmVhdS9ub3V2ZWF1X2JvLmggIHwgICAzICsKIGRyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25v
dXZlYXVfZHJ2LmggfCAgIDIgKwogZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVhdV90dG0u
YyB8ICA0NCArKysrKysrKystCiA0IGZpbGVzIGNoYW5nZWQsIDEzNSBpbnNlcnRpb25zKCspLCAy
NSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2
ZWF1X2JvLmMgYi9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X2JvLmMKaW5kZXggNTM5
MmU1ZmVhNWQ0Li5lZTBlMTM1ZGRjYmIgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9ub3V2
ZWF1L25vdXZlYXVfYm8uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X2Jv
LmMKQEAgLTEzNyw2ICsxMzcsNyBAQCBub3V2ZWF1X2JvX2RlbF90dG0oc3RydWN0IHR0bV9idWZm
ZXJfb2JqZWN0ICpibykKIAlzdHJ1Y3Qgbm91dmVhdV9ibyAqbnZibyA9IG5vdXZlYXVfYm8oYm8p
OwogCiAJV0FSTl9PTihudmJvLT5waW5fcmVmY250ID4gMCk7CisJbm91dmVhdV9ib19kZWxfaW9f
cmVzZXJ2ZV9scnUoYm8pOwogCW52MTBfYm9fcHV0X3RpbGVfcmVnaW9uKGRldiwgbnZiby0+dGls
ZSwgTlVMTCk7CiAKIAkvKgpAQCAtMzA0LDYgKzMwNSw3IEBAIG5vdXZlYXVfYm9faW5pdChzdHJ1
Y3Qgbm91dmVhdV9ibyAqbnZibywgdTY0IHNpemUsIGludCBhbGlnbiwgdTMyIGZsYWdzLAogCiAJ
bnZiby0+Ym8ubWVtLm51bV9wYWdlcyA9IHNpemUgPj4gUEFHRV9TSElGVDsKIAlub3V2ZWF1X2Jv
X3BsYWNlbWVudF9zZXQobnZibywgZmxhZ3MsIDApOworCUlOSVRfTElTVF9IRUFEKCZudmJvLT5p
b19yZXNlcnZlX2xydSk7CiAKIAlyZXQgPSB0dG1fYm9faW5pdChudmJvLT5iby5iZGV2LCAmbnZi
by0+Ym8sIHNpemUsIHR5cGUsCiAJCQkgICZudmJvLT5wbGFjZW1lbnQsIGFsaWduID4+IFBBR0Vf
U0hJRlQsIGZhbHNlLApAQCAtNTc0LDYgKzU3NiwyNiBAQCBub3V2ZWF1X2JvX3N5bmNfZm9yX2Nw
dShzdHJ1Y3Qgbm91dmVhdV9ibyAqbnZibykKIAkJCQkJUEFHRV9TSVpFLCBETUFfRlJPTV9ERVZJ
Q0UpOwogfQogCit2b2lkIG5vdXZlYXVfYm9fYWRkX2lvX3Jlc2VydmVfbHJ1KHN0cnVjdCB0dG1f
YnVmZmVyX29iamVjdCAqYm8pCit7CisJc3RydWN0IG5vdXZlYXVfZHJtICpkcm0gPSBub3V2ZWF1
X2JkZXYoYm8tPmJkZXYpOworCXN0cnVjdCBub3V2ZWF1X2JvICpudmJvID0gbm91dmVhdV9ibyhi
byk7CisKKwltdXRleF9sb2NrKCZkcm0tPnR0bS5pb19yZXNlcnZlX211dGV4KTsKKwlsaXN0X21v
dmVfdGFpbCgmbnZiby0+aW9fcmVzZXJ2ZV9scnUsICZkcm0tPnR0bS5pb19yZXNlcnZlX2xydSk7
CisJbXV0ZXhfdW5sb2NrKCZkcm0tPnR0bS5pb19yZXNlcnZlX211dGV4KTsKK30KKwordm9pZCBu
b3V2ZWF1X2JvX2RlbF9pb19yZXNlcnZlX2xydShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJv
KQoreworCXN0cnVjdCBub3V2ZWF1X2RybSAqZHJtID0gbm91dmVhdV9iZGV2KGJvLT5iZGV2KTsK
KwlzdHJ1Y3Qgbm91dmVhdV9ibyAqbnZibyA9IG5vdXZlYXVfYm8oYm8pOworCisJbXV0ZXhfbG9j
aygmZHJtLT50dG0uaW9fcmVzZXJ2ZV9tdXRleCk7CisJbGlzdF9kZWxfaW5pdCgmbnZiby0+aW9f
cmVzZXJ2ZV9scnUpOworCW11dGV4X3VubG9jaygmZHJtLT50dG0uaW9fcmVzZXJ2ZV9tdXRleCk7
Cit9CisKIGludAogbm91dmVhdV9ib192YWxpZGF0ZShzdHJ1Y3Qgbm91dmVhdV9ibyAqbnZibywg
Ym9vbCBpbnRlcnJ1cHRpYmxlLAogCQkgICAgYm9vbCBub193YWl0X2dwdSkKQEAgLTg4OCw2ICs5
MTAsOCBAQCBub3V2ZWF1X2JvX21vdmVfbnRmeShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJv
LCBib29sIGV2aWN0LAogCWlmIChiby0+ZGVzdHJveSAhPSBub3V2ZWF1X2JvX2RlbF90dG0pCiAJ
CXJldHVybjsKIAorCW5vdXZlYXVfYm9fZGVsX2lvX3Jlc2VydmVfbHJ1KGJvKTsKKwogCWlmICht
ZW0gJiYgbmV3X3JlZy0+bWVtX3R5cGUgIT0gVFRNX1BMX1NZU1RFTSAmJgogCSAgICBtZW0tPm1l
bS5wYWdlID09IG52Ym8tPnBhZ2UpIHsKIAkJbGlzdF9mb3JfZWFjaF9lbnRyeSh2bWEsICZudmJv
LT52bWFfbGlzdCwgaGVhZCkgewpAQCAtMTAxOCwyMyArMTA0Miw1NCBAQCBub3V2ZWF1X2JvX3Zl
cmlmeV9hY2Nlc3Moc3RydWN0IHR0bV9idWZmZXJfb2JqZWN0ICpibywgc3RydWN0IGZpbGUgKmZp
bHApCiAJCQkJCSAgZmlscC0+cHJpdmF0ZV9kYXRhKTsKIH0KIAorc3RhdGljIHZvaWQKK25vdXZl
YXVfdHRtX2lvX21lbV9mcmVlX2xvY2tlZChzdHJ1Y3Qgbm91dmVhdV9kcm0gKmRybSwKKwkJCSAg
ICAgICBzdHJ1Y3QgdHRtX3Jlc291cmNlICpyZWcpCit7CisJc3RydWN0IG5vdXZlYXVfbWVtICpt
ZW0gPSBub3V2ZWF1X21lbShyZWcpOworCisJaWYgKCFyZWctPmJ1cy5iYXNlICYmICFyZWctPmJ1
cy5vZmZzZXQpCisJCXJldHVybjsgLyogYWxyZWFkeSBmcmVlZCAqLworCisJaWYgKGRybS0+Y2xp
ZW50Lm1lbS0+b2NsYXNzID49IE5WSUZfQ0xBU1NfTUVNX05WNTApIHsKKwkJc3dpdGNoIChyZWct
Pm1lbV90eXBlKSB7CisJCWNhc2UgVFRNX1BMX1RUOgorCQkJaWYgKG1lbS0+a2luZCkKKwkJCQlu
dmlmX29iamVjdF91bm1hcF9oYW5kbGUoJm1lbS0+bWVtLm9iamVjdCk7CisJCQlicmVhazsKKwkJ
Y2FzZSBUVE1fUExfVlJBTToKKwkJCW52aWZfb2JqZWN0X3VubWFwX2hhbmRsZSgmbWVtLT5tZW0u
b2JqZWN0KTsKKwkJCWJyZWFrOworCQlkZWZhdWx0OgorCQkJYnJlYWs7CisJCX0KKwl9CisJcmVn
LT5idXMuYmFzZSA9IDA7CisJcmVnLT5idXMub2Zmc2V0ID0gMDsKK30KKwogc3RhdGljIGludAog
bm91dmVhdV90dG1faW9fbWVtX3Jlc2VydmUoc3RydWN0IHR0bV9ib19kZXZpY2UgKmJkZXYsIHN0
cnVjdCB0dG1fcmVzb3VyY2UgKnJlZykKIHsKIAlzdHJ1Y3Qgbm91dmVhdV9kcm0gKmRybSA9IG5v
dXZlYXVfYmRldihiZGV2KTsKIAlzdHJ1Y3QgbnZrbV9kZXZpY2UgKmRldmljZSA9IG52eHhfZGV2
aWNlKCZkcm0tPmNsaWVudC5kZXZpY2UpOwogCXN0cnVjdCBub3V2ZWF1X21lbSAqbWVtID0gbm91
dmVhdV9tZW0ocmVnKTsKKwlpbnQgcmV0OworCisJaWYgKHJlZy0+YnVzLmJhc2UgfHwgcmVnLT5i
dXMub2Zmc2V0KQorCQlyZXR1cm4gMDsgLyogYWxyZWFkeSBtYXBwZWQgKi8KIAogCXJlZy0+YnVz
LmFkZHIgPSBOVUxMOwotCXJlZy0+YnVzLm9mZnNldCA9IDA7CiAJcmVnLT5idXMuc2l6ZSA9IHJl
Zy0+bnVtX3BhZ2VzIDw8IFBBR0VfU0hJRlQ7Ci0JcmVnLT5idXMuYmFzZSA9IDA7CiAJcmVnLT5i
dXMuaXNfaW9tZW0gPSBmYWxzZTsKIAorCW11dGV4X2xvY2soJmRybS0+dHRtLmlvX3Jlc2VydmVf
bXV0ZXgpOworcmV0cnk6CiAJc3dpdGNoIChyZWctPm1lbV90eXBlKSB7CiAJY2FzZSBUVE1fUExf
U1lTVEVNOgogCQkvKiBTeXN0ZW0gbWVtb3J5ICovCi0JCXJldHVybiAwOworCQlyZXQgPSAwOwor
CQlnb3RvIG91dDsKIAljYXNlIFRUTV9QTF9UVDoKICNpZiBJU19FTkFCTEVEKENPTkZJR19BR1Ap
CiAJCWlmIChkcm0tPmFncC5icmlkZ2UpIHsKQEAgLTEwNDMsOSArMTA5OCwxMiBAQCBub3V2ZWF1
X3R0bV9pb19tZW1fcmVzZXJ2ZShzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiwgc3RydWN0IHR0
bV9yZXNvdXJjZSAqcmVnKQogCQkJcmVnLT5idXMuaXNfaW9tZW0gPSAhZHJtLT5hZ3AuY21hOwog
CQl9CiAjZW5kaWYKLQkJaWYgKGRybS0+Y2xpZW50Lm1lbS0+b2NsYXNzIDwgTlZJRl9DTEFTU19N
RU1fTlY1MCB8fCAhbWVtLT5raW5kKQorCQlpZiAoZHJtLT5jbGllbnQubWVtLT5vY2xhc3MgPCBO
VklGX0NMQVNTX01FTV9OVjUwIHx8CisJCSAgICAhbWVtLT5raW5kKSB7CiAJCQkvKiB1bnRpbGVk
ICovCisJCQlyZXQgPSAwOwogCQkJYnJlYWs7CisJCX0KIAkJZmFsbHRocm91Z2g7CS8qIHRpbGVk
IG1lbW9yeSAqLwogCWNhc2UgVFRNX1BMX1ZSQU06CiAJCXJlZy0+YnVzLm9mZnNldCA9IHJlZy0+
c3RhcnQgPDwgUEFHRV9TSElGVDsKQEAgLTEwNTgsNyArMTExNiw2IEBAIG5vdXZlYXVfdHRtX2lv
X21lbV9yZXNlcnZlKHN0cnVjdCB0dG1fYm9fZGV2aWNlICpiZGV2LCBzdHJ1Y3QgdHRtX3Jlc291
cmNlICpyZWcpCiAJCQl9IGFyZ3M7CiAJCQl1NjQgaGFuZGxlLCBsZW5ndGg7CiAJCQl1MzIgYXJn
YyA9IDA7Ci0JCQlpbnQgcmV0OwogCiAJCQlzd2l0Y2ggKG1lbS0+bWVtLm9iamVjdC5vY2xhc3Mp
IHsKIAkJCWNhc2UgTlZJRl9DTEFTU19NRU1fTlY1MDoKQEAgLTEwODQsMzkgKzExNDEsNDcgQEAg
bm91dmVhdV90dG1faW9fbWVtX3Jlc2VydmUoc3RydWN0IHR0bV9ib19kZXZpY2UgKmJkZXYsIHN0
cnVjdCB0dG1fcmVzb3VyY2UgKnJlZykKIAkJCQkJCSAgICAgJmhhbmRsZSwgJmxlbmd0aCk7CiAJ
CQlpZiAocmV0ICE9IDEpIHsKIAkJCQlpZiAoV0FSTl9PTihyZXQgPT0gMCkpCi0JCQkJCXJldHVy
biAtRUlOVkFMOwotCQkJCXJldHVybiByZXQ7CisJCQkJCXJldCA9IC1FSU5WQUw7CisJCQkJZ290
byBvdXQ7CiAJCQl9CiAKIAkJCXJlZy0+YnVzLmJhc2UgPSAwOwogCQkJcmVnLT5idXMub2Zmc2V0
ID0gaGFuZGxlOworCQkJcmV0ID0gMDsKIAkJfQogCQlicmVhazsKIAlkZWZhdWx0OgotCQlyZXR1
cm4gLUVJTlZBTDsKKwkJcmV0ID0gLUVJTlZBTDsKIAl9Ci0JcmV0dXJuIDA7CisKK291dDoKKwlp
ZiAocmV0ID09IC1FTk9TUEMpIHsKKwkJc3RydWN0IG5vdXZlYXVfYm8gKm52Ym87CisKKwkJbnZi
byA9IGxpc3RfZmlyc3RfZW50cnlfb3JfbnVsbCgmZHJtLT50dG0uaW9fcmVzZXJ2ZV9scnUsCisJ
CQkJCQl0eXBlb2YoKm52Ym8pLAorCQkJCQkJaW9fcmVzZXJ2ZV9scnUpOworCQlpZiAobnZibykg
eworCQkJbGlzdF9kZWxfaW5pdCgmbnZiby0+aW9fcmVzZXJ2ZV9scnUpOworCQkJZHJtX3ZtYV9u
b2RlX3VubWFwKCZudmJvLT5iby5iYXNlLnZtYV9ub2RlLAorCQkJCQkgICBiZGV2LT5kZXZfbWFw
cGluZyk7CisJCQlub3V2ZWF1X3R0bV9pb19tZW1fZnJlZV9sb2NrZWQoZHJtLCAmbnZiby0+Ym8u
bWVtKTsKKwkJCWdvdG8gcmV0cnk7CisJCX0KKworCX0KKwltdXRleF91bmxvY2soJmRybS0+dHRt
LmlvX3Jlc2VydmVfbXV0ZXgpOworCXJldHVybiByZXQ7CiB9CiAKIHN0YXRpYyB2b2lkCiBub3V2
ZWF1X3R0bV9pb19tZW1fZnJlZShzdHJ1Y3QgdHRtX2JvX2RldmljZSAqYmRldiwgc3RydWN0IHR0
bV9yZXNvdXJjZSAqcmVnKQogewogCXN0cnVjdCBub3V2ZWF1X2RybSAqZHJtID0gbm91dmVhdV9i
ZGV2KGJkZXYpOwotCXN0cnVjdCBub3V2ZWF1X21lbSAqbWVtID0gbm91dmVhdV9tZW0ocmVnKTsK
IAotCWlmIChkcm0tPmNsaWVudC5tZW0tPm9jbGFzcyA+PSBOVklGX0NMQVNTX01FTV9OVjUwKSB7
Ci0JCXN3aXRjaCAocmVnLT5tZW1fdHlwZSkgewotCQljYXNlIFRUTV9QTF9UVDoKLQkJCWlmICht
ZW0tPmtpbmQpCi0JCQkJbnZpZl9vYmplY3RfdW5tYXBfaGFuZGxlKCZtZW0tPm1lbS5vYmplY3Qp
OwotCQkJYnJlYWs7Ci0JCWNhc2UgVFRNX1BMX1ZSQU06Ci0JCQludmlmX29iamVjdF91bm1hcF9o
YW5kbGUoJm1lbS0+bWVtLm9iamVjdCk7Ci0JCQlicmVhazsKLQkJZGVmYXVsdDoKLQkJCWJyZWFr
OwotCQl9Ci0JfQorCW11dGV4X2xvY2soJmRybS0+dHRtLmlvX3Jlc2VydmVfbXV0ZXgpOworCW5v
dXZlYXVfdHRtX2lvX21lbV9mcmVlX2xvY2tlZChkcm0sIHJlZyk7CisJbXV0ZXhfdW5sb2NrKCZk
cm0tPnR0bS5pb19yZXNlcnZlX211dGV4KTsKIH0KIAogc3RhdGljIGludApkaWZmIC0tZ2l0IGEv
ZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVhdV9iby5oIGIvZHJpdmVycy9ncHUvZHJtL25v
dXZlYXUvbm91dmVhdV9iby5oCmluZGV4IGFlY2I3NDgxZGYwZC4uYWU5MGFjYTMzZmVmIDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X2JvLmgKKysrIGIvZHJpdmVy
cy9ncHUvZHJtL25vdXZlYXUvbm91dmVhdV9iby5oCkBAIC0xOCw2ICsxOCw3IEBAIHN0cnVjdCBu
b3V2ZWF1X2JvIHsKIAlib29sIGZvcmNlX2NvaGVyZW50OwogCXN0cnVjdCB0dG1fYm9fa21hcF9v
Ymoga21hcDsKIAlzdHJ1Y3QgbGlzdF9oZWFkIGhlYWQ7CisJc3RydWN0IGxpc3RfaGVhZCBpb19y
ZXNlcnZlX2xydTsKIAogCS8qIHByb3RlY3RlZCBieSB0dG1fYm9fcmVzZXJ2ZSgpICovCiAJc3Ry
dWN0IGRybV9maWxlICpyZXNlcnZlZF9ieTsKQEAgLTk2LDYgKzk3LDggQEAgaW50ICBub3V2ZWF1
X2JvX3ZhbGlkYXRlKHN0cnVjdCBub3V2ZWF1X2JvICosIGJvb2wgaW50ZXJydXB0aWJsZSwKIAkJ
CSBib29sIG5vX3dhaXRfZ3B1KTsKIHZvaWQgbm91dmVhdV9ib19zeW5jX2Zvcl9kZXZpY2Uoc3Ry
dWN0IG5vdXZlYXVfYm8gKm52Ym8pOwogdm9pZCBub3V2ZWF1X2JvX3N5bmNfZm9yX2NwdShzdHJ1
Y3Qgbm91dmVhdV9ibyAqbnZibyk7Cit2b2lkIG5vdXZlYXVfYm9fYWRkX2lvX3Jlc2VydmVfbHJ1
KHN0cnVjdCB0dG1fYnVmZmVyX29iamVjdCAqYm8pOwordm9pZCBub3V2ZWF1X2JvX2RlbF9pb19y
ZXNlcnZlX2xydShzdHJ1Y3QgdHRtX2J1ZmZlcl9vYmplY3QgKmJvKTsKIAogLyogVE9ETzogc3Vi
bWl0IGVxdWl2YWxlbnQgdG8gVFRNIGdlbmVyaWMgQVBJIHVwc3RyZWFtPyAqLwogc3RhdGljIGlu
bGluZSB2b2lkIF9faW9tZW0gKgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUv
bm91dmVhdV9kcnYuaCBiL2RyaXZlcnMvZ3B1L2RybS9ub3V2ZWF1L25vdXZlYXVfZHJ2LmgKaW5k
ZXggZjYzYWM3MmFhNTU2Li4yNmEyYzEwOTAwNDUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2Ry
bS9ub3V2ZWF1L25vdXZlYXVfZHJ2LmgKKysrIGIvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91
dmVhdV9kcnYuaApAQCAtMTY0LDYgKzE2NCw4IEBAIHN0cnVjdCBub3V2ZWF1X2RybSB7CiAJCWlu
dCB0eXBlX3ZyYW07CiAJCWludCB0eXBlX2hvc3RbMl07CiAJCWludCB0eXBlX25jb2hbMl07CisJ
CXN0cnVjdCBtdXRleCBpb19yZXNlcnZlX211dGV4OworCQlzdHJ1Y3QgbGlzdF9oZWFkIGlvX3Jl
c2VydmVfbHJ1OwogCX0gdHRtOwogCiAJLyogR0VNIGludGVyZmFjZSBzdXBwb3J0ICovCmRpZmYg
LS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X3R0bS5jIGIvZHJpdmVycy9n
cHUvZHJtL25vdXZlYXUvbm91dmVhdV90dG0uYwppbmRleCA1M2M2Zjg4MjczMjIuLmE2MmYzN2Ix
MTMxYyAxMDA2NDQKLS0tIGEvZHJpdmVycy9ncHUvZHJtL25vdXZlYXUvbm91dmVhdV90dG0uYwor
KysgYi9kcml2ZXJzL2dwdS9kcm0vbm91dmVhdS9ub3V2ZWF1X3R0bS5jCkBAIC0xMjMsMTMgKzEy
Myw1MSBAQCBjb25zdCBzdHJ1Y3QgdHRtX3Jlc291cmNlX21hbmFnZXJfZnVuYyBudjA0X2dhcnRf
bWFuYWdlciA9IHsKIAkuZnJlZSA9IG5vdXZlYXVfbWFuYWdlcl9kZWwsCiB9OwogCitzdGF0aWMg
dm1fZmF1bHRfdCBub3V2ZWF1X3R0bV9mYXVsdChzdHJ1Y3Qgdm1fZmF1bHQgKnZtZikKK3sKKwlz
dHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSA9IHZtZi0+dm1hOworCXN0cnVjdCB0dG1fYnVmZmVy
X29iamVjdCAqYm8gPSB2bWEtPnZtX3ByaXZhdGVfZGF0YTsKKwlwZ3Byb3RfdCBwcm90OworCXZt
X2ZhdWx0X3QgcmV0OworCisJcmV0ID0gdHRtX2JvX3ZtX3Jlc2VydmUoYm8sIHZtZik7CisJaWYg
KHJldCkKKwkJcmV0dXJuIHJldDsKKworCW5vdXZlYXVfYm9fZGVsX2lvX3Jlc2VydmVfbHJ1KGJv
KTsKKworCXByb3QgPSB2bV9nZXRfcGFnZV9wcm90KHZtYS0+dm1fZmxhZ3MpOworCXJldCA9IHR0
bV9ib192bV9mYXVsdF9yZXNlcnZlZCh2bWYsIHByb3QsIFRUTV9CT19WTV9OVU1fUFJFRkFVTFQs
IDEpOworCWlmIChyZXQgPT0gVk1fRkFVTFRfUkVUUlkgJiYgISh2bWYtPmZsYWdzICYgRkFVTFRf
RkxBR19SRVRSWV9OT1dBSVQpKQorCQlyZXR1cm4gcmV0OworCisJbm91dmVhdV9ib19hZGRfaW9f
cmVzZXJ2ZV9scnUoYm8pOworCisJZG1hX3Jlc3ZfdW5sb2NrKGJvLT5iYXNlLnJlc3YpOworCisJ
cmV0dXJuIHJldDsKK30KKworc3RhdGljIHN0cnVjdCB2bV9vcGVyYXRpb25zX3N0cnVjdCBub3V2
ZWF1X3R0bV92bV9vcHMgPSB7CisJLmZhdWx0ID0gbm91dmVhdV90dG1fZmF1bHQsCisJLm9wZW4g
PSB0dG1fYm9fdm1fb3BlbiwKKwkuY2xvc2UgPSB0dG1fYm9fdm1fY2xvc2UsCisJLmFjY2VzcyA9
IHR0bV9ib192bV9hY2Nlc3MKK307CisKIGludAogbm91dmVhdV90dG1fbW1hcChzdHJ1Y3QgZmls
ZSAqZmlscCwgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpCiB7CiAJc3RydWN0IGRybV9maWxl
ICpmaWxlX3ByaXYgPSBmaWxwLT5wcml2YXRlX2RhdGE7CiAJc3RydWN0IG5vdXZlYXVfZHJtICpk
cm0gPSBub3V2ZWF1X2RybShmaWxlX3ByaXYtPm1pbm9yLT5kZXYpOworCWludCByZXQ7CiAKLQly
ZXR1cm4gdHRtX2JvX21tYXAoZmlscCwgdm1hLCAmZHJtLT50dG0uYmRldik7CisJcmV0ID0gdHRt
X2JvX21tYXAoZmlscCwgdm1hLCAmZHJtLT50dG0uYmRldik7CisJaWYgKHJldCkKKwkJcmV0dXJu
IHJldDsKKworCXZtYS0+dm1fb3BzID0gJm5vdXZlYXVfdHRtX3ZtX29wczsKKwlyZXR1cm4gMDsK
IH0KIAogc3RhdGljIGludApAQCAtMTczLDcgKzIxMSw2IEBAIG5vdXZlYXVfdHRtX2luaXRfdnJh
bShzdHJ1Y3Qgbm91dmVhdV9kcm0gKmRybSkKIAkJfQogCiAJCW1hbi0+ZnVuYyA9ICZub3V2ZWF1
X3ZyYW1fbWFuYWdlcjsKLQkJbWFuLT51c2VfaW9fcmVzZXJ2ZV9scnUgPSB0cnVlOwogCiAJCXR0
bV9yZXNvdXJjZV9tYW5hZ2VyX2luaXQobWFuLAogCQkJCQkgIGRybS0+Z2VtLnZyYW1fYXZhaWxh
YmxlID4+IFBBR0VfU0hJRlQpOwpAQCAtMzM5LDYgKzM3Niw5IEBAIG5vdXZlYXVfdHRtX2luaXQo
c3RydWN0IG5vdXZlYXVfZHJtICpkcm0pCiAJCXJldHVybiByZXQ7CiAJfQogCisJbXV0ZXhfaW5p
dCgmZHJtLT50dG0uaW9fcmVzZXJ2ZV9tdXRleCk7CisJSU5JVF9MSVNUX0hFQUQoJmRybS0+dHRt
LmlvX3Jlc2VydmVfbHJ1KTsKKwogCU5WX0lORk8oZHJtLCAiVlJBTTogJWQgTWlCXG4iLCAodTMy
KShkcm0tPmdlbS52cmFtX2F2YWlsYWJsZSA+PiAyMCkpOwogCU5WX0lORk8oZHJtLCAiR0FSVDog
JWQgTWlCXG4iLCAodTMyKShkcm0tPmdlbS5nYXJ0X2F2YWlsYWJsZSA+PiAyMCkpOwogCXJldHVy
biAwOwotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3Rv
cC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmkt
ZGV2ZWwK
