Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 715C2F1357
	for <lists+dri-devel@lfdr.de>; Wed,  6 Nov 2019 11:07:35 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 88D4E6ECA3;
	Wed,  6 Nov 2019 10:07:31 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from fireflyinternet.com (mail.fireflyinternet.com [109.228.58.192])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A12C66ECA3;
 Wed,  6 Nov 2019 10:07:29 +0000 (UTC)
X-Default-Received-SPF: pass (skip=forwardok (res=PASS))
 x-ip-name=78.156.65.138; 
Received: from haswell.alporthouse.com (unverified [78.156.65.138]) 
 by fireflyinternet.com (Firefly Internet (M1)) with ESMTP id 19099360-1500050 
 for multiple; Wed, 06 Nov 2019 10:07:18 +0000
From: Chris Wilson <chris@chris-wilson.co.uk>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH 2/3] drm/i915/selftests: Wrap vm_mmap() around GEM objects
Date: Wed,  6 Nov 2019 10:07:15 +0000
Message-Id: <20191106100716.18181-2-chris@chris-wilson.co.uk>
X-Mailer: git-send-email 2.24.0
In-Reply-To: <20191106100716.18181-1-chris@chris-wilson.co.uk>
References: <20191106100716.18181-1-chris@chris-wilson.co.uk>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Abdiel Janulgue <abdiel.janulgue@linux.intel.com>,
 intel-gfx@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

UHJvdmlkZSBhIHV0aWxpdHkgZnVuY3Rpb24gdG8gY3JlYXRlIGEgdm1hIGNvcnJlc3BvbmRpbmcg
dG8gYW4gbW1hcCgpIG9mCm91ciBkZXZpY2UuIEFuZCB1c2UgaXQgdG8gZXhlcmNpc2UgdGhlIGVx
dWl2YWxlbnQgb2YgdXNlcnNwYWNlCnBlcmZvcm1pbmcgYSBHVFQgbW1hcCBvZiBvdXIgb2JqZWN0
cy4KClNpZ25lZC1vZmYtYnk6IENocmlzIFdpbHNvbiA8Y2hyaXNAY2hyaXMtd2lsc29uLmNvLnVr
PgpDYzogQWJkaWVsIEphbnVsZ3VlIDxhYmRpZWwuamFudWxndWVAbGludXguaW50ZWwuY29tPgot
LS0KIGRyaXZlcnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlICAgICAgICAgICAgICAgICB8ICAxICsK
IC4uLi9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX21tYW4uYyAgICB8IDk3ICsrKysr
KysrKysrKysrKysrKysKIGRyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9pZ3RfbW1hcC5j
ICAgICB8IDM5ICsrKysrKysrCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaWd0X21t
YXAuaCAgICAgfCAxOSArKysrCiA0IGZpbGVzIGNoYW5nZWQsIDE1NiBpbnNlcnRpb25zKCspCiBj
cmVhdGUgbW9kZSAxMDA2NDQgZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2lndF9tbWFw
LmMKIGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaWd0
X21tYXAuaAoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlIGIvZHJp
dmVycy9ncHUvZHJtL2k5MTUvTWFrZWZpbGUKaW5kZXggOTBkY2YwOWY1MmNjLi5lMGZkMTBjMGNm
YjggMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L01ha2VmaWxlCkBAIC0yNTksNiArMjU5LDcgQEAgaTkxNS0kKENPTkZJ
R19EUk1fSTkxNV9TRUxGVEVTVCkgKz0gXAogCXNlbGZ0ZXN0cy9pOTE1X3NlbGZ0ZXN0Lm8gXAog
CXNlbGZ0ZXN0cy9pZ3RfZmx1c2hfdGVzdC5vIFwKIAlzZWxmdGVzdHMvaWd0X2xpdmVfdGVzdC5v
IFwKKwlzZWxmdGVzdHMvaWd0X21tYXAubyBcCiAJc2VsZnRlc3RzL2lndF9yZXNldC5vIFwKIAlz
ZWxmdGVzdHMvaWd0X3NwaW5uZXIubwogCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9nZW0vc2VsZnRlc3RzL2k5MTVfZ2VtX21tYW4uYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dl
bS9zZWxmdGVzdHMvaTkxNV9nZW1fbW1hbi5jCmluZGV4IDI5YjIwNzdiNzNkMi4uMTFhOTlkNWQy
ZmY4IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVf
Z2VtX21tYW4uYworKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vc2VsZnRlc3RzL2k5MTVf
Z2VtX21tYW4uYwpAQCAtMTIsNiArMTIsNyBAQAogI2luY2x1ZGUgImk5MTVfc2VsZnRlc3QuaCIK
ICNpbmNsdWRlICJzZWxmdGVzdHMvaTkxNV9yYW5kb20uaCIKICNpbmNsdWRlICJzZWxmdGVzdHMv
aWd0X2ZsdXNoX3Rlc3QuaCIKKyNpbmNsdWRlICJzZWxmdGVzdHMvaWd0X21tYXAuaCIKIAogc3Ry
dWN0IHRpbGUgewogCXVuc2lnbmVkIGludCB3aWR0aDsKQEAgLTY5NCwxMiArNjk1LDEwOCBAQCBz
dGF0aWMgaW50IGlndF9tbWFwX29mZnNldF9leGhhdXN0aW9uKHZvaWQgKmFyZykKIAlnb3RvIG91
dDsKIH0KIAorI2RlZmluZSBleHBhbmQzMih4KSAoKCh4KSA8PCAwKSB8ICgoeCkgPDwgOCkgfCAo
KHgpIDw8IDE2KSB8ICgoeCkgPDwgMjQpKQorc3RhdGljIGludCBpZ3RfbW1hcF9ndHQodm9pZCAq
YXJnKQoreworCXN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1ID0gYXJnOworCXN0cnVjdCBk
cm1faTkxNV9nZW1fb2JqZWN0ICpvYmo7CisJc3RydWN0IHZtX2FyZWFfc3RydWN0ICphcmVhOwor
CXVuc2lnbmVkIGxvbmcgYWRkcjsKKwl2b2lkICp2YWRkcjsKKwlpbnQgZXJyLCBpOworCisJb2Jq
ID0gaTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9pbnRlcm5hbChpOTE1LCBQQUdFX1NJWkUpOworCWlm
IChJU19FUlIob2JqKSkKKwkJcmV0dXJuIFBUUl9FUlIob2JqKTsKKworCXZhZGRyID0gaTkxNV9n
ZW1fb2JqZWN0X3Bpbl9tYXAob2JqLCBJOTE1X01BUF9XQik7CisJaWYgKElTX0VSUih2YWRkcikp
IHsKKwkJZXJyID0gUFRSX0VSUih2YWRkcik7CisJCWdvdG8gb3V0OworCX0KKwltZW1zZXQodmFk
ZHIsIFBPSVNPTl9JTlVTRSwgUEFHRV9TSVpFKTsKKwlpOTE1X2dlbV9vYmplY3RfZmx1c2hfbWFw
KG9iaik7CisJaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChvYmopOworCisJZXJyID0gY3JlYXRl
X21tYXBfb2Zmc2V0KG9iaik7CisJaWYgKGVycikKKwkJZ290byBvdXQ7CisKKwlhZGRyID0gaWd0
X21tYXBfbm9kZShpOTE1LCAmb2JqLT5iYXNlLnZtYV9ub2RlLAorCQkJICAgICAwLCBQUk9UX1dS
SVRFLCBNQVBfU0hBUkVEKTsKKwlpZiAoSVNfRVJSX1ZBTFVFKGFkZHIpKSB7CisJCWVyciA9IGFk
ZHI7CisJCWdvdG8gb3V0OworCX0KKworCXByX2luZm8oImlndF9tbWFwKG9iajpndHQpIEAgJWx4
XG4iLCBhZGRyKTsKKworCWFyZWEgPSBmaW5kX3ZtYShjdXJyZW50LT5tbSwgYWRkcik7CisJaWYg
KCFhcmVhKSB7CisJCXByX2VycigiRGlkIG5vdCBjcmVhdGUgYSB2bV9hcmVhX3N0cnVjdCBmb3Ig
dGhlIG1tYXBcbiIpOworCQllcnIgPSAtRUlOVkFMOworCQlnb3RvIG91dF91bm1hcDsKKwl9CisK
KwlpZiAoYXJlYS0+dm1fcHJpdmF0ZV9kYXRhICE9IG9iaikgeworCQlwcl9lcnIoInZtX2FyZWFf
c3RydWN0IGRpZCBub3QgcG9pbnQgYmFjayB0byBvdXIgb2JqZWN0IVxuIik7CisJCWVyciA9IC1F
SU5WQUw7CisJCWdvdG8gb3V0X3VubWFwOworCX0KKworCWZvciAoaSA9IDA7IGkgPCBQQUdFX1NJ
WkUgLyBzaXplb2YodTMyKTsgaSsrKSB7CisJCXUzMiBfX3VzZXIgKnV4ID0gdTY0X3RvX3VzZXJf
cHRyKCh1NjQpKGFkZHIgKyBpICogc2l6ZW9mKih1eCkpKTsKKwkJdTMyIHg7CisKKwkJaWYgKGdl
dF91c2VyKHgsIHV4KSkgeworCQkJcHJfZXJyKCJVbmFibGUgdG8gcmVhZCBmcm9tIEdUVCBtbWFw
LCBvZmZzZXQ6JXpkXG4iLAorCQkJICAgICAgIGkgKiBzaXplb2YoeCkpOworCQkJZXJyID0gLUVG
QVVMVDsKKwkJCWJyZWFrOworCQl9CisKKwkJaWYgKHggIT0gZXhwYW5kMzIoUE9JU09OX0lOVVNF
KSkgeworCQkJcHJfZXJyKCJSZWFkIGluY29ycmVjdCB2YWx1ZSBmcm9tIEdUVCBtbWFwLCBvZmZz
ZXQ6JXpkLCBmb3VuZDoleCwgZXhwZWN0ZWQ6JXhcbiIsCisJCQkgICAgICAgaSAqIHNpemVvZih4
KSwgeCwgZXhwYW5kMzIoUE9JU09OX0lOVVNFKSk7CisJCQllcnIgPSAtRUlOVkFMOworCQkJYnJl
YWs7CisJCX0KKworCQl4ID0gZXhwYW5kMzIoUE9JU09OX0ZSRUUpOworCQlpZiAocHV0X3VzZXIo
eCwgdXgpKSB7CisJCQlwcl9lcnIoIlVuYWJsZSB0byB3cml0ZSB0byBHVFQgbW1hcCwgb2Zmc2V0
OiV6ZFxuIiwKKwkJCSAgICAgICBpICogc2l6ZW9mKHgpKTsKKwkJCWVyciA9IC1FRkFVTFQ7CisJ
CQlicmVhazsKKwkJfQorCX0KKworb3V0X3VubWFwOgorCXZtX211bm1hcChhZGRyLCBQQUdFX1NJ
WkUpOworCisJdmFkZHIgPSBpOTE1X2dlbV9vYmplY3RfcGluX21hcChvYmosIEk5MTVfTUFQX0ZP
UkNFX1dDKTsKKwlpZiAoSVNfRVJSKHZhZGRyKSkgeworCQllcnIgPSBQVFJfRVJSKHZhZGRyKTsK
KwkJZ290byBvdXQ7CisJfQorCWlmIChlcnIgPT0gMCAmJiBtZW1jaHJfaW52KHZhZGRyLCBQT0lT
T05fRlJFRSwgUEFHRV9TSVpFKSkgeworCQlwcl9lcnIoIldyaXRlIHZpYSBHR1RUIG1tYXAgZGlk
IG5vdCBsYW5kIGluIGJhY2tpbmcgc3RvcmVcbiIpOworCQllcnIgPSAtRUlOVkFMOworCX0KKwlp
OTE1X2dlbV9vYmplY3RfdW5waW5fbWFwKG9iaik7CisKK291dDoKKwlpOTE1X2dlbV9vYmplY3Rf
cHV0KG9iaik7CisJcmV0dXJuIGVycjsKK30KKwogaW50IGk5MTVfZ2VtX21tYW5fbGl2ZV9zZWxm
dGVzdHMoc3RydWN0IGRybV9pOTE1X3ByaXZhdGUgKmk5MTUpCiB7CiAJc3RhdGljIGNvbnN0IHN0
cnVjdCBpOTE1X3N1YnRlc3QgdGVzdHNbXSA9IHsKIAkJU1VCVEVTVChpZ3RfcGFydGlhbF90aWxp
bmcpLAogCQlTVUJURVNUKGlndF9zbW9rZV90aWxpbmcpLAogCQlTVUJURVNUKGlndF9tbWFwX29m
ZnNldF9leGhhdXN0aW9uKSwKKwkJU1VCVEVTVChpZ3RfbW1hcF9ndHQpLAogCX07CiAKIAlyZXR1
cm4gaTkxNV9zdWJ0ZXN0cyh0ZXN0cywgaTkxNSk7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9zZWxmdGVzdHMvaWd0X21tYXAuYyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0
ZXN0cy9pZ3RfbW1hcC5jCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAwMDAwMC4u
ZjViYzgwZTkyNTczCi0tLSAvZGV2L251bGwKKysrIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2Vs
ZnRlc3RzL2lndF9tbWFwLmMKQEAgLTAsMCArMSwzOSBAQAorLyoKKyAqIFNQRFgtTGljZW5zZS1J
ZGVudGlmaWVyOiBNSVQKKyAqCisgKiBDb3B5cmlnaHQgwqkgMjAxOSBJbnRlbCBDb3Jwb3JhdGlv
bgorICovCisKKyNpbmNsdWRlIDxkcm0vZHJtX2ZpbGUuaD4KKworI2luY2x1ZGUgImk5MTVfZHJ2
LmgiCisjaW5jbHVkZSAiaWd0X21tYXAuaCIKKwordW5zaWduZWQgbG9uZyBpZ3RfbW1hcF9ub2Rl
KHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1LAorCQkJICAgIHN0cnVjdCBkcm1fdm1hX29m
ZnNldF9ub2RlICpub2RlLAorCQkJICAgIHVuc2lnbmVkIGxvbmcgYWRkciwKKwkJCSAgICB1bnNp
Z25lZCBsb25nIHByb3QsCisJCQkgICAgdW5zaWduZWQgbG9uZyBmbGFncykKK3sKKwlzdHJ1Y3Qg
ZmlsZSAqZmlsZTsKKwlpbnQgZXJyOworCisJLyogUHJldGVuZCB0byBvcGVuKCIvZGV2L2RyaS9j
YXJkMCIpICovCisJZmlsZSA9IGFub25fZHJtX2dldGZpbGUoaTkxNS0+ZHJtLnByaW1hcnksIE9f
UkRXUik7CisJaWYgKElTX0VSUihmaWxlKSkKKwkJcmV0dXJuIFBUUl9FUlIoZmlsZSk7CisKKwll
cnIgPSBkcm1fdm1hX25vZGVfYWxsb3cobm9kZSwgZmlsZS0+cHJpdmF0ZV9kYXRhKTsKKwlpZiAo
ZXJyKSB7CisJCWFkZHIgPSBlcnI7CisJCWdvdG8gb3V0X2ZpbGU7CisJfQorCisJYWRkciA9IHZt
X21tYXAoZmlsZSwgYWRkciwgZHJtX3ZtYV9ub2RlX3NpemUobm9kZSkgPDwgUEFHRV9TSElGVCwK
KwkJICAgICAgIHByb3QsIGZsYWdzLCBkcm1fdm1hX25vZGVfb2Zmc2V0X2FkZHIobm9kZSkpOwor
CisJZHJtX3ZtYV9ub2RlX3Jldm9rZShub2RlLCBmaWxlLT5wcml2YXRlX2RhdGEpOworb3V0X2Zp
bGU6CisJZnB1dChmaWxlKTsKKwlyZXR1cm4gYWRkcjsKK30KZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9pZ3RfbW1hcC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUv
c2VsZnRlc3RzL2lndF9tbWFwLmgKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMDAw
MDAwLi42ZTcxNmNiNTlkN2UKLS0tIC9kZXYvbnVsbAorKysgYi9kcml2ZXJzL2dwdS9kcm0vaTkx
NS9zZWxmdGVzdHMvaWd0X21tYXAuaApAQCAtMCwwICsxLDE5IEBACisvKgorICogU1BEWC1MaWNl
bnNlLUlkZW50aWZpZXI6IE1JVAorICoKKyAqIENvcHlyaWdodCDCqSAyMDE5IEludGVsIENvcnBv
cmF0aW9uCisgKi8KKworI2lmbmRlZiBJR1RfTU1BUF9ICisjZGVmaW5lIElHVF9NTUFQX0gKKwor
c3RydWN0IGRybV9pOTE1X3ByaXZhdGU7CitzdHJ1Y3QgZHJtX3ZtYV9vZmZzZXRfbm9kZTsKKwor
dW5zaWduZWQgbG9uZyBpZ3RfbW1hcF9ub2RlKHN0cnVjdCBkcm1faTkxNV9wcml2YXRlICppOTE1
LAorCQkJICAgIHN0cnVjdCBkcm1fdm1hX29mZnNldF9ub2RlICpub2RlLAorCQkJICAgIHVuc2ln
bmVkIGxvbmcgYWRkciwKKwkJCSAgICB1bnNpZ25lZCBsb25nIHByb3QsCisJCQkgICAgdW5zaWdu
ZWQgbG9uZyBmbGFncyk7CisKKyNlbmRpZiAvKiBJR1RfTU1BUF9IICovCi0tIAoyLjI0LjAKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBt
YWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3Rz
LmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
