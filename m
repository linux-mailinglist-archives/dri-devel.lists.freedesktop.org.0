Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 893DFD89A1
	for <lists+dri-devel@lfdr.de>; Wed, 16 Oct 2019 09:34:40 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 180646E8E7;
	Wed, 16 Oct 2019 07:34:25 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-io1-xd44.google.com (mail-io1-xd44.google.com
 [IPv6:2607:f8b0:4864:20::d44])
 by gabe.freedesktop.org (Postfix) with ESMTPS id BB76B6E392
 for <dri-devel@lists.freedesktop.org>; Tue, 15 Oct 2019 18:16:10 +0000 (UTC)
Received: by mail-io1-xd44.google.com with SMTP id u8so48162345iom.5
 for <dri-devel@lists.freedesktop.org>; Tue, 15 Oct 2019 11:16:10 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=98vHKVBEM0hEBK2KPs+I58gQveSostE1DslOfyfeJEU=;
 b=H9jP32w9OC7gyFWPjDtENDQyhVeObjNWlKzwJ+E5FR3n0+NV9+wD43yEZzRAdkJ2Hy
 qjH3ozpF4N3XTTP/3Xx7sF5hC1rwBDk/rvOBDpFF7NYsGBHdvVPOjFpkcz/iWf4W/15w
 xcVcL+g8s6LmOmyDLKHKpTqv1N/HcPw1bi7JGQB6y4GJkg/wUTuF3zxMcycnF9VMl3Vz
 K8iIP6od8L2NJuP3B1wmlhpQngQJVGKkvguodtQFyQOs/bw5RwgU4xALcX54R+WVb3HJ
 bdatA+zZeD1DL1MP4KLPLRUc00TA9eccLqVgMTGOXRxUPf5tmtAzy1Ef0zEjUkWJezYM
 zm0w==
X-Gm-Message-State: APjAAAW2pI7Fw8szeuldrUOAC3QRJBC2p9ZPb2S6SajRGuMIBar/QZep
 NUMK5bNUDx7bP1pPj9x80AGjGg==
X-Google-Smtp-Source: APXvYqzEGMTGXIdGw9Kq7dhMQJVot12wGm4H93GQCM84MUNp6unnufR3VgRi65NkWzp0Mkni5LfD3g==
X-Received: by 2002:a92:ba0a:: with SMTP id o10mr7335324ili.150.1571163369703; 
 Tue, 15 Oct 2019 11:16:09 -0700 (PDT)
Received: from ziepe.ca ([24.114.26.129])
 by smtp.gmail.com with ESMTPSA id u204sm21426020iod.50.2019.10.15.11.16.08
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Tue, 15 Oct 2019 11:16:09 -0700 (PDT)
Received: from jgg by jggl.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1iKRJT-0002CQ-JR; Tue, 15 Oct 2019 15:12:51 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH hmm 09/15] xen/gntdev: use mmu_range_notifier_insert
Date: Tue, 15 Oct 2019 15:12:36 -0300
Message-Id: <20191015181242.8343-10-jgg@ziepe.ca>
X-Mailer: git-send-email 2.23.0
In-Reply-To: <20191015181242.8343-1-jgg@ziepe.ca>
References: <20191015181242.8343-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Wed, 16 Oct 2019 07:33:45 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=98vHKVBEM0hEBK2KPs+I58gQveSostE1DslOfyfeJEU=;
 b=dV2Dye+25NP3t0c1fbIUgbOGBNbXYc3nsQEzHcJE5Yf16XOsk94QpIcf+Vi+zAkzDi
 KMpTRTTlh4Td/GoOS+XmBibAcdSyQBHrqm9wXu4D/Ub3h2MmXJE3GDShf9Ii1oIMV0GQ
 8hBKNBsj9DWNCSF+BIX4JmT2RLaTT/yYmHpXBaHgHSpvXzup11BuqujtlNWytceRqh45
 usTvbEt4RNRh+4mpCwIfZHqbG30obKko3SLXU2XQ3Q785hBXkUFrfvPI6jSk4aj2bla3
 tIOpuIxP6ApZKhPJU/sioDlEsXHtrZrYoBL4ezArzZ/IkVPt/8kb4z+RUV2k82EhqoFp
 vKUQ==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, Juergen Gross <jgross@suse.com>,
 Stefano Stabellini <sstabellini@kernel.org>,
 Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>,
 linux-rdma@vger.kernel.org, amd-gfx@lists.freedesktop.org, linux-mm@kvack.org,
 Jason Gunthorpe <jgg@mellanox.com>, dri-devel@lists.freedesktop.org,
 xen-devel@lists.xenproject.org, Boris Ostrovsky <boris.ostrovsky@oracle.com>,
 Ben Skeggs <bskeggs@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKZ250ZGV2IHNpbXBseSB3
YW50cyB0byBtb25pdG9yIGEgc3BlY2lmaWMgVk1BIGZvciBhbnkgbm90aWZpZXIgZXZlbnRzLAp0
aGlzIGNhbiBiZSBkb25lIHN0cmFpZ2h0Zm9yd2FyZGx5IHVzaW5nIG1tdV9yYW5nZV9ub3RpZmll
cl9pbnNlcnQoKSBvdmVyCnRoZSBWTUEncyBWQSByYW5nZS4KClRoZSBub3RpZmllciBzaG91bGQg
YmUgYXR0YWNoZWQgdW50aWwgdGhlIG9yaWdpbmFsIFZNQSBpcyBkZXN0cm95ZWQuCgpJdCBpcyB1
bmNsZWFyIGlmIGFueSBvZiB0aGlzIGlzIGV2ZW4gc2FuZSwgYnV0IGF0IGxlYXN0IGEgbG90IG9m
IGR1cGxpY2F0ZQpjb2RlIGlzIHJlbW92ZWQuCgpDYzogT2xla3NhbmRyIEFuZHJ1c2hjaGVua28g
PG9sZWtzYW5kcl9hbmRydXNoY2hlbmtvQGVwYW0uY29tPgpDYzogQm9yaXMgT3N0cm92c2t5IDxi
b3Jpcy5vc3Ryb3Zza3lAb3JhY2xlLmNvbT4KQ2M6IHhlbi1kZXZlbEBsaXN0cy54ZW5wcm9qZWN0
Lm9yZwpDYzogSnVlcmdlbiBHcm9zcyA8amdyb3NzQHN1c2UuY29tPgpDYzogU3RlZmFubyBTdGFi
ZWxsaW5pIDxzc3RhYmVsbGluaUBrZXJuZWwub3JnPgpTaWduZWQtb2ZmLWJ5OiBKYXNvbiBHdW50
aG9ycGUgPGpnZ0BtZWxsYW5veC5jb20+Ci0tLQogZHJpdmVycy94ZW4vZ250ZGV2LWNvbW1vbi5o
IHwgICA4ICstCiBkcml2ZXJzL3hlbi9nbnRkZXYuYyAgICAgICAgfCAxNzkgKysrKysrKysrKy0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDQ4IGluc2VydGlvbnMo
KyksIDEzOSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL3hlbi9nbnRkZXYtY29t
bW9uLmggYi9kcml2ZXJzL3hlbi9nbnRkZXYtY29tbW9uLmgKaW5kZXggMmY4Yjk0OWMzZWViMTQu
LmIyMDFmZGQyMGI2NjdiIDEwMDY0NAotLS0gYS9kcml2ZXJzL3hlbi9nbnRkZXYtY29tbW9uLmgK
KysrIGIvZHJpdmVycy94ZW4vZ250ZGV2LWNvbW1vbi5oCkBAIC0yMSwxNSArMjEsOCBAQCBzdHJ1
Y3QgZ250ZGV2X2RtYWJ1Zl9wcml2Owogc3RydWN0IGdudGRldl9wcml2IHsKIAkvKiBNYXBzIHdp
dGggdmlzaWJsZSBvZmZzZXRzIGluIHRoZSBmaWxlIGRlc2NyaXB0b3IuICovCiAJc3RydWN0IGxp
c3RfaGVhZCBtYXBzOwotCS8qCi0JICogTWFwcyB0aGF0IGFyZSBub3QgdmlzaWJsZTsgd2lsbCBi
ZSBmcmVlZCBvbiBtdW5tYXAuCi0JICogT25seSBwb3B1bGF0ZWQgaWYgcG9wdWxhdGVfZnJlZWFi
bGVfbWFwcyA9PSAxCi0JICovCi0Jc3RydWN0IGxpc3RfaGVhZCBmcmVlYWJsZV9tYXBzOwogCS8q
IGxvY2sgcHJvdGVjdHMgbWFwcyBhbmQgZnJlZWFibGVfbWFwcy4gKi8KIAlzdHJ1Y3QgbXV0ZXgg
bG9jazsKLQlzdHJ1Y3QgbW1fc3RydWN0ICptbTsKLQlzdHJ1Y3QgbW11X25vdGlmaWVyIG1uOwog
CiAjaWZkZWYgQ09ORklHX1hFTl9HUkFOVF9ETUFfQUxMT0MKIAkvKiBEZXZpY2UgZm9yIHdoaWNo
IERNQSBtZW1vcnkgaXMgYWxsb2NhdGVkLiAqLwpAQCAtNDksNiArNDIsNyBAQCBzdHJ1Y3QgZ250
ZGV2X3VubWFwX25vdGlmeSB7CiB9OwogCiBzdHJ1Y3QgZ250ZGV2X2dyYW50X21hcCB7CisJc3Ry
dWN0IG1tdV9yYW5nZV9ub3RpZmllciBub3RpZmllcjsKIAlzdHJ1Y3QgbGlzdF9oZWFkIG5leHQ7
CiAJc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWE7CiAJaW50IGluZGV4OwpkaWZmIC0tZ2l0IGEv
ZHJpdmVycy94ZW4vZ250ZGV2LmMgYi9kcml2ZXJzL3hlbi9nbnRkZXYuYwppbmRleCBhNDQ2YTcy
MjFlMTNlOS4uMjM0MTUzZjU1NmFmZDYgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMveGVuL2dudGRldi5j
CisrKyBiL2RyaXZlcnMveGVuL2dudGRldi5jCkBAIC02NSw3ICs2NSw2IEBAIE1PRFVMRV9QQVJN
X0RFU0MobGltaXQsICJNYXhpbXVtIG51bWJlciBvZiBncmFudHMgdGhhdCBtYXkgYmUgbWFwcGVk
IGJ5ICIKIHN0YXRpYyBhdG9taWNfdCBwYWdlc19tYXBwZWQgPSBBVE9NSUNfSU5JVCgwKTsKIAog
c3RhdGljIGludCB1c2VfcHRlbW9kOwotI2RlZmluZSBwb3B1bGF0ZV9mcmVlYWJsZV9tYXBzIHVz
ZV9wdGVtb2QKIAogc3RhdGljIGludCB1bm1hcF9ncmFudF9wYWdlcyhzdHJ1Y3QgZ250ZGV2X2dy
YW50X21hcCAqbWFwLAogCQkJICAgICBpbnQgb2Zmc2V0LCBpbnQgcGFnZXMpOwpAQCAtMjUxLDEy
ICsyNTAsNiBAQCB2b2lkIGdudGRldl9wdXRfbWFwKHN0cnVjdCBnbnRkZXZfcHJpdiAqcHJpdiwg
c3RydWN0IGdudGRldl9ncmFudF9tYXAgKm1hcCkKIAkJZXZ0Y2huX3B1dChtYXAtPm5vdGlmeS5l
dmVudCk7CiAJfQogCi0JaWYgKHBvcHVsYXRlX2ZyZWVhYmxlX21hcHMgJiYgcHJpdikgewotCQlt
dXRleF9sb2NrKCZwcml2LT5sb2NrKTsKLQkJbGlzdF9kZWwoJm1hcC0+bmV4dCk7Ci0JCW11dGV4
X3VubG9jaygmcHJpdi0+bG9jayk7Ci0JfQotCiAJaWYgKG1hcC0+cGFnZXMgJiYgIXVzZV9wdGVt
b2QpCiAJCXVubWFwX2dyYW50X3BhZ2VzKG1hcCwgMCwgbWFwLT5jb3VudCk7CiAJZ250ZGV2X2Zy
ZWVfbWFwKG1hcCk7CkBAIC00NDUsMTcgKzQzOCw5IEBAIHN0YXRpYyB2b2lkIGdudGRldl92bWFf
Y2xvc2Uoc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEpCiAJc3RydWN0IGdudGRldl9wcml2ICpw
cml2ID0gZmlsZS0+cHJpdmF0ZV9kYXRhOwogCiAJcHJfZGVidWcoImdudGRldl92bWFfY2xvc2Ug
JXBcbiIsIHZtYSk7Ci0JaWYgKHVzZV9wdGVtb2QpIHsKLQkJLyogSXQgaXMgcG9zc2libGUgdGhh
dCBhbiBtbXUgbm90aWZpZXIgY291bGQgYmUgcnVubmluZwotCQkgKiBjb25jdXJyZW50bHksIHNv
IHRha2UgcHJpdi0+bG9jayB0byBlbnN1cmUgdGhhdCB0aGUgdm1hIHdvbid0Ci0JCSAqIHZhbmlz
aGluZyBkdXJpbmcgdGhlIHVubWFwX2dyYW50X3BhZ2VzIGNhbGwsIHNpbmNlIHdlIHdpbGwKLQkJ
ICogc3BpbiBoZXJlIHVudGlsIHRoYXQgY29tcGxldGVzLiBTdWNoIGEgY29uY3VycmVudCBjYWxs
IHdpbGwKLQkJICogbm90IGRvIGFueSB1bm1hcHBpbmcsIHNpbmNlIHRoYXQgaGFzIGJlZW4gZG9u
ZSBwcmlvciB0bwotCQkgKiBjbG9zaW5nIHRoZSB2bWEsIGJ1dCBpdCBtYXkgc3RpbGwgaXRlcmF0
ZSB0aGUgdW5tYXBfb3BzIGxpc3QuCi0JCSAqLwotCQltdXRleF9sb2NrKCZwcml2LT5sb2NrKTsK
KwlpZiAodXNlX3B0ZW1vZCAmJiBtYXAtPnZtYSA9PSB2bWEpIHsKKwkJbW11X3JhbmdlX25vdGlm
aWVyX3JlbW92ZSgmbWFwLT5ub3RpZmllcik7CiAJCW1hcC0+dm1hID0gTlVMTDsKLQkJbXV0ZXhf
dW5sb2NrKCZwcml2LT5sb2NrKTsKIAl9CiAJdm1hLT52bV9wcml2YXRlX2RhdGEgPSBOVUxMOwog
CWdudGRldl9wdXRfbWFwKHByaXYsIG1hcCk7CkBAIC00NzcsMTA5ICs0NjIsNDMgQEAgc3RhdGlj
IGNvbnN0IHN0cnVjdCB2bV9vcGVyYXRpb25zX3N0cnVjdCBnbnRkZXZfdm1vcHMgPSB7CiAKIC8q
IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLSAqLwogCi1zdGF0aWMgYm9vbCBpbl9yYW5nZShzdHJ1Y3QgZ250ZGV2X2dyYW50
X21hcCAqbWFwLAotCQkJICAgICAgdW5zaWduZWQgbG9uZyBzdGFydCwgdW5zaWduZWQgbG9uZyBl
bmQpCi17Ci0JaWYgKCFtYXAtPnZtYSkKLQkJcmV0dXJuIGZhbHNlOwotCWlmIChtYXAtPnZtYS0+
dm1fc3RhcnQgPj0gZW5kKQotCQlyZXR1cm4gZmFsc2U7Ci0JaWYgKG1hcC0+dm1hLT52bV9lbmQg
PD0gc3RhcnQpCi0JCXJldHVybiBmYWxzZTsKLQotCXJldHVybiB0cnVlOwotfQotCi1zdGF0aWMg
aW50IHVubWFwX2lmX2luX3JhbmdlKHN0cnVjdCBnbnRkZXZfZ3JhbnRfbWFwICptYXAsCi0JCQkg
ICAgICB1bnNpZ25lZCBsb25nIHN0YXJ0LCB1bnNpZ25lZCBsb25nIGVuZCwKLQkJCSAgICAgIGJv
b2wgYmxvY2thYmxlKQorc3RhdGljIGJvb2wgZ250ZGV2X2ludmFsaWRhdGUoc3RydWN0IG1tdV9y
YW5nZV9ub3RpZmllciAqbW4sCisJCQkgICAgICBjb25zdCBzdHJ1Y3QgbW11X25vdGlmaWVyX3Jh
bmdlICpyYW5nZSkKIHsKKwlzdHJ1Y3QgZ250ZGV2X2dyYW50X21hcCAqbWFwID0KKwkJY29udGFp
bmVyX29mKG1uLCBzdHJ1Y3QgZ250ZGV2X2dyYW50X21hcCwgbm90aWZpZXIpOwogCXVuc2lnbmVk
IGxvbmcgbXN0YXJ0LCBtZW5kOwogCWludCBlcnI7CiAKLQlpZiAoIWluX3JhbmdlKG1hcCwgc3Rh
cnQsIGVuZCkpCi0JCXJldHVybiAwOworCWlmICghbW11X25vdGlmaWVyX3JhbmdlX2Jsb2NrYWJs
ZShyYW5nZSkpCisJCXJldHVybiBmYWxzZTsKIAotCWlmICghYmxvY2thYmxlKQotCQlyZXR1cm4g
LUVBR0FJTjsKKwkvKgorCSAqIElmIHRoZSBWTUEgaXMgc3BsaXQgb3Igb3RoZXJ3aXNlIGNoYW5n
ZWQgdGhlIG5vdGlmaWVyIGlzIG5vdAorCSAqIHVwZGF0ZWQsIGJ1dCB3ZSBkb24ndCB3YW50IHRv
IHByb2Nlc3MgVkEncyBvdXRzaWRlIHRoZSBtb2RpZmllZAorCSAqIFZNQS4gRklYTUU6IEl0IHdv
dWxkIGJlIG11Y2ggbW9yZSB1bmRlcnN0YW5kYWJsZSB0byBqdXN0IHByZXZlbnQKKwkgKiBtb2Rp
ZnlpbmcgdGhlIFZNQSBpbiB0aGUgZmlyc3QgcGxhY2UuCisJICovCisJaWYgKG1hcC0+dm1hLT52
bV9zdGFydCA+PSByYW5nZS0+ZW5kIHx8CisJICAgIG1hcC0+dm1hLT52bV9lbmQgPD0gcmFuZ2Ut
PnN0YXJ0KQorCQlyZXR1cm4gdHJ1ZTsKIAotCW1zdGFydCA9IG1heChzdGFydCwgbWFwLT52bWEt
PnZtX3N0YXJ0KTsKLQltZW5kICAgPSBtaW4oZW5kLCAgIG1hcC0+dm1hLT52bV9lbmQpOworCW1z
dGFydCA9IG1heChyYW5nZS0+c3RhcnQsIG1hcC0+dm1hLT52bV9zdGFydCk7CisJbWVuZCA9IG1p
bihyYW5nZS0+ZW5kLCBtYXAtPnZtYS0+dm1fZW5kKTsKIAlwcl9kZWJ1ZygibWFwICVkKyVkICgl
bHggJWx4KSwgcmFuZ2UgJWx4ICVseCwgbXJhbmdlICVseCAlbHhcbiIsCiAJCQltYXAtPmluZGV4
LCBtYXAtPmNvdW50LAogCQkJbWFwLT52bWEtPnZtX3N0YXJ0LCBtYXAtPnZtYS0+dm1fZW5kLAot
CQkJc3RhcnQsIGVuZCwgbXN0YXJ0LCBtZW5kKTsKKwkJCXJhbmdlLT5zdGFydCwgcmFuZ2UtPmVu
ZCwgbXN0YXJ0LCBtZW5kKTsKIAllcnIgPSB1bm1hcF9ncmFudF9wYWdlcyhtYXAsCiAJCQkJKG1z
dGFydCAtIG1hcC0+dm1hLT52bV9zdGFydCkgPj4gUEFHRV9TSElGVCwKIAkJCQkobWVuZCAtIG1z
dGFydCkgPj4gUEFHRV9TSElGVCk7CiAJV0FSTl9PTihlcnIpOwogCi0JcmV0dXJuIDA7Ci19Ci0K
LXN0YXRpYyBpbnQgbW5faW52bF9yYW5nZV9zdGFydChzdHJ1Y3QgbW11X25vdGlmaWVyICptbiwK
LQkJCSAgICAgICBjb25zdCBzdHJ1Y3QgbW11X25vdGlmaWVyX3JhbmdlICpyYW5nZSkKLXsKLQlz
dHJ1Y3QgZ250ZGV2X3ByaXYgKnByaXYgPSBjb250YWluZXJfb2YobW4sIHN0cnVjdCBnbnRkZXZf
cHJpdiwgbW4pOwotCXN0cnVjdCBnbnRkZXZfZ3JhbnRfbWFwICptYXA7Ci0JaW50IHJldCA9IDA7
Ci0KLQlpZiAobW11X25vdGlmaWVyX3JhbmdlX2Jsb2NrYWJsZShyYW5nZSkpCi0JCW11dGV4X2xv
Y2soJnByaXYtPmxvY2spOwotCWVsc2UgaWYgKCFtdXRleF90cnlsb2NrKCZwcml2LT5sb2NrKSkK
LQkJcmV0dXJuIC1FQUdBSU47Ci0KLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KG1hcCwgJnByaXYtPm1h
cHMsIG5leHQpIHsKLQkJcmV0ID0gdW5tYXBfaWZfaW5fcmFuZ2UobWFwLCByYW5nZS0+c3RhcnQs
IHJhbmdlLT5lbmQsCi0JCQkJCW1tdV9ub3RpZmllcl9yYW5nZV9ibG9ja2FibGUocmFuZ2UpKTsK
LQkJaWYgKHJldCkKLQkJCWdvdG8gb3V0X3VubG9jazsKLQl9Ci0JbGlzdF9mb3JfZWFjaF9lbnRy
eShtYXAsICZwcml2LT5mcmVlYWJsZV9tYXBzLCBuZXh0KSB7Ci0JCXJldCA9IHVubWFwX2lmX2lu
X3JhbmdlKG1hcCwgcmFuZ2UtPnN0YXJ0LCByYW5nZS0+ZW5kLAotCQkJCQltbXVfbm90aWZpZXJf
cmFuZ2VfYmxvY2thYmxlKHJhbmdlKSk7Ci0JCWlmIChyZXQpCi0JCQlnb3RvIG91dF91bmxvY2s7
Ci0JfQotCi1vdXRfdW5sb2NrOgotCW11dGV4X3VubG9jaygmcHJpdi0+bG9jayk7Ci0KLQlyZXR1
cm4gcmV0OwotfQotCi1zdGF0aWMgdm9pZCBtbl9yZWxlYXNlKHN0cnVjdCBtbXVfbm90aWZpZXIg
Km1uLAotCQkgICAgICAgc3RydWN0IG1tX3N0cnVjdCAqbW0pCi17Ci0Jc3RydWN0IGdudGRldl9w
cml2ICpwcml2ID0gY29udGFpbmVyX29mKG1uLCBzdHJ1Y3QgZ250ZGV2X3ByaXYsIG1uKTsKLQlz
dHJ1Y3QgZ250ZGV2X2dyYW50X21hcCAqbWFwOwotCWludCBlcnI7Ci0KLQltdXRleF9sb2NrKCZw
cml2LT5sb2NrKTsKLQlsaXN0X2Zvcl9lYWNoX2VudHJ5KG1hcCwgJnByaXYtPm1hcHMsIG5leHQp
IHsKLQkJaWYgKCFtYXAtPnZtYSkKLQkJCWNvbnRpbnVlOwotCQlwcl9kZWJ1ZygibWFwICVkKyVk
ICglbHggJWx4KVxuIiwKLQkJCQltYXAtPmluZGV4LCBtYXAtPmNvdW50LAotCQkJCW1hcC0+dm1h
LT52bV9zdGFydCwgbWFwLT52bWEtPnZtX2VuZCk7Ci0JCWVyciA9IHVubWFwX2dyYW50X3BhZ2Vz
KG1hcCwgLyogb2Zmc2V0ICovIDAsIG1hcC0+Y291bnQpOwotCQlXQVJOX09OKGVycik7Ci0JfQot
CWxpc3RfZm9yX2VhY2hfZW50cnkobWFwLCAmcHJpdi0+ZnJlZWFibGVfbWFwcywgbmV4dCkgewot
CQlpZiAoIW1hcC0+dm1hKQotCQkJY29udGludWU7Ci0JCXByX2RlYnVnKCJtYXAgJWQrJWQgKCVs
eCAlbHgpXG4iLAotCQkJCW1hcC0+aW5kZXgsIG1hcC0+Y291bnQsCi0JCQkJbWFwLT52bWEtPnZt
X3N0YXJ0LCBtYXAtPnZtYS0+dm1fZW5kKTsKLQkJZXJyID0gdW5tYXBfZ3JhbnRfcGFnZXMobWFw
LCAvKiBvZmZzZXQgKi8gMCwgbWFwLT5jb3VudCk7Ci0JCVdBUk5fT04oZXJyKTsKLQl9Ci0JbXV0
ZXhfdW5sb2NrKCZwcml2LT5sb2NrKTsKKwlyZXR1cm4gdHJ1ZTsKIH0KIAotc3RhdGljIGNvbnN0
IHN0cnVjdCBtbXVfbm90aWZpZXJfb3BzIGdudGRldl9tbXVfb3BzID0gewotCS5yZWxlYXNlICAg
ICAgICAgICAgICAgID0gbW5fcmVsZWFzZSwKLQkuaW52YWxpZGF0ZV9yYW5nZV9zdGFydCA9IG1u
X2ludmxfcmFuZ2Vfc3RhcnQsCitzdGF0aWMgY29uc3Qgc3RydWN0IG1tdV9yYW5nZV9ub3RpZmll
cl9vcHMgZ250ZGV2X21tdV9vcHMgPSB7CisJLmludmFsaWRhdGUgPSBnbnRkZXZfaW52YWxpZGF0
ZSwKIH07CiAKIC8qIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwpAQCAtNTk0LDcgKzUxMyw2IEBAIHN0YXRpYyBpbnQg
Z250ZGV2X29wZW4oc3RydWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUgKmZsaXApCiAJCXJl
dHVybiAtRU5PTUVNOwogCiAJSU5JVF9MSVNUX0hFQUQoJnByaXYtPm1hcHMpOwotCUlOSVRfTElT
VF9IRUFEKCZwcml2LT5mcmVlYWJsZV9tYXBzKTsKIAltdXRleF9pbml0KCZwcml2LT5sb2NrKTsK
IAogI2lmZGVmIENPTkZJR19YRU5fR05UREVWX0RNQUJVRgpAQCAtNjA2LDE3ICs1MjQsNiBAQCBz
dGF0aWMgaW50IGdudGRldl9vcGVuKHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpm
bGlwKQogCX0KICNlbmRpZgogCi0JaWYgKHVzZV9wdGVtb2QpIHsKLQkJcHJpdi0+bW0gPSBnZXRf
dGFza19tbShjdXJyZW50KTsKLQkJaWYgKCFwcml2LT5tbSkgewotCQkJa2ZyZWUocHJpdik7Ci0J
CQlyZXR1cm4gLUVOT01FTTsKLQkJfQotCQlwcml2LT5tbi5vcHMgPSAmZ250ZGV2X21tdV9vcHM7
Ci0JCXJldCA9IG1tdV9ub3RpZmllcl9yZWdpc3RlcigmcHJpdi0+bW4sIHByaXYtPm1tKTsKLQkJ
bW1wdXQocHJpdi0+bW0pOwotCX0KLQogCWlmIChyZXQpIHsKIAkJa2ZyZWUocHJpdik7CiAJCXJl
dHVybiByZXQ7CkBAIC02NTMsMTYgKzU2MCwxMiBAQCBzdGF0aWMgaW50IGdudGRldl9yZWxlYXNl
KHN0cnVjdCBpbm9kZSAqaW5vZGUsIHN0cnVjdCBmaWxlICpmbGlwKQogCQlsaXN0X2RlbCgmbWFw
LT5uZXh0KTsKIAkJZ250ZGV2X3B1dF9tYXAoTlVMTCAvKiBhbHJlYWR5IHJlbW92ZWQgKi8sIG1h
cCk7CiAJfQotCVdBUk5fT04oIWxpc3RfZW1wdHkoJnByaXYtPmZyZWVhYmxlX21hcHMpKTsKIAlt
dXRleF91bmxvY2soJnByaXYtPmxvY2spOwogCiAjaWZkZWYgQ09ORklHX1hFTl9HTlRERVZfRE1B
QlVGCiAJZ250ZGV2X2RtYWJ1Zl9maW5pKHByaXYtPmRtYWJ1Zl9wcml2KTsKICNlbmRpZgogCi0J
aWYgKHVzZV9wdGVtb2QpCi0JCW1tdV9ub3RpZmllcl91bnJlZ2lzdGVyKCZwcml2LT5tbiwgcHJp
di0+bW0pOwotCiAJa2ZyZWUocHJpdik7CiAJcmV0dXJuIDA7CiB9CkBAIC03MjMsOCArNjI2LDYg
QEAgc3RhdGljIGxvbmcgZ250ZGV2X2lvY3RsX3VubWFwX2dyYW50X3JlZihzdHJ1Y3QgZ250ZGV2
X3ByaXYgKnByaXYsCiAJbWFwID0gZ250ZGV2X2ZpbmRfbWFwX2luZGV4KHByaXYsIG9wLmluZGV4
ID4+IFBBR0VfU0hJRlQsIG9wLmNvdW50KTsKIAlpZiAobWFwKSB7CiAJCWxpc3RfZGVsKCZtYXAt
Pm5leHQpOwotCQlpZiAocG9wdWxhdGVfZnJlZWFibGVfbWFwcykKLQkJCWxpc3RfYWRkX3RhaWwo
Jm1hcC0+bmV4dCwgJnByaXYtPmZyZWVhYmxlX21hcHMpOwogCQllcnIgPSAwOwogCX0KIAltdXRl
eF91bmxvY2soJnByaXYtPmxvY2spOwpAQCAtMTA5NiwxMSArOTk3LDYgQEAgc3RhdGljIGludCBn
bnRkZXZfbW1hcChzdHJ1Y3QgZmlsZSAqZmxpcCwgc3RydWN0IHZtX2FyZWFfc3RydWN0ICp2bWEp
CiAJCWdvdG8gdW5sb2NrX291dDsKIAlpZiAodXNlX3B0ZW1vZCAmJiBtYXAtPnZtYSkKIAkJZ290
byB1bmxvY2tfb3V0OwotCWlmICh1c2VfcHRlbW9kICYmIHByaXYtPm1tICE9IHZtYS0+dm1fbW0p
IHsKLQkJcHJfd2FybigiSHVoPyBPdGhlciBtbT9cbiIpOwotCQlnb3RvIHVubG9ja19vdXQ7Ci0J
fQotCiAJcmVmY291bnRfaW5jKCZtYXAtPnVzZXJzKTsKIAogCXZtYS0+dm1fb3BzID0gJmdudGRl
dl92bW9wczsKQEAgLTExMTEsMTAgKzEwMDcsNiBAQCBzdGF0aWMgaW50IGdudGRldl9tbWFwKHN0
cnVjdCBmaWxlICpmbGlwLCBzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3QgKnZtYSkKIAkJdm1hLT52bV9m
bGFncyB8PSBWTV9ET05UQ09QWTsKIAogCXZtYS0+dm1fcHJpdmF0ZV9kYXRhID0gbWFwOwotCi0J
aWYgKHVzZV9wdGVtb2QpCi0JCW1hcC0+dm1hID0gdm1hOwotCiAJaWYgKG1hcC0+ZmxhZ3MpIHsK
IAkJaWYgKCh2bWEtPnZtX2ZsYWdzICYgVk1fV1JJVEUpICYmCiAJCQkJKG1hcC0+ZmxhZ3MgJiBH
TlRNQVBfcmVhZG9ubHkpKQpAQCAtMTEyNSw4ICsxMDE3LDI4IEBAIHN0YXRpYyBpbnQgZ250ZGV2
X21tYXAoc3RydWN0IGZpbGUgKmZsaXAsIHN0cnVjdCB2bV9hcmVhX3N0cnVjdCAqdm1hKQogCQkJ
bWFwLT5mbGFncyB8PSBHTlRNQVBfcmVhZG9ubHk7CiAJfQogCisJaWYgKHVzZV9wdGVtb2QpIHsK
KwkJbWFwLT52bWEgPSB2bWE7CisJCWVyciA9IG1tdV9yYW5nZV9ub3RpZmllcl9pbnNlcnRfbG9j
a2VkKAorCQkJJm1hcC0+bm90aWZpZXIsIHZtYS0+dm1fc3RhcnQsCisJCQl2bWEtPnZtX2VuZCAt
IHZtYS0+dm1fc3RhcnQsIHZtYS0+dm1fbW0pOworCQlpZiAoZXJyKQorCQkJZ290byBvdXRfdW5s
b2NrX3B1dDsKKwl9CiAJbXV0ZXhfdW5sb2NrKCZwcml2LT5sb2NrKTsKIAorCS8qCisJICogZ250
ZGV2IHRha2VzIHRoZSBhZGRyZXNzIG9mIHRoZSBQVEUgaW4gZmluZF9ncmFudF9wdGVzKCkgYW5k
IHBhc3NlcworCSAqIGl0IHRvIHRoZSBoeXBlcnZpc29yIGluIGdudGRldl9tYXBfZ3JhbnRfcGFn
ZXMoKS4gVGhlIHB1cnBvc2Ugb2YKKwkgKiB0aGUgbm90aWZpZXIgaXMgdG8gcHJldmVudCB0aGUg
aHlwZXJ2aXNvciBwb2ludGVyIHRvIHRoZSBQVEUgZnJvbQorCSAqIGdvaW5nIHN0YWxlLgorCSAq
CisJICogU2luY2UgdGhpcyB2bWEncyBtYXBwaW5ncyBjYW4ndCBiZSB0b3VjaGVkIHdpdGhvdXQg
dGhlIG1tYXBfc2VtLAorCSAqIGFuZCB3ZSBhcmUgaG9sZGluZyBpdCBub3csIHRoZXJlIGlzIG5v
IG5lZWQgZm9yIHRoZSBub3RpZmllcl9yYW5nZQorCSAqIGxvY2tpbmcgcGF0dGVybi4KKwkgKi8K
KwltbXVfcmFuZ2VfcmVhZF9iZWdpbigmbWFwLT5ub3RpZmllcik7CisKIAlpZiAodXNlX3B0ZW1v
ZCkgewogCQltYXAtPnBhZ2VzX3ZtX3N0YXJ0ID0gdm1hLT52bV9zdGFydDsKIAkJZXJyID0gYXBw
bHlfdG9fcGFnZV9yYW5nZSh2bWEtPnZtX21tLCB2bWEtPnZtX3N0YXJ0LApAQCAtMTE3NSw4ICsx
MDg3LDExIEBAIHN0YXRpYyBpbnQgZ250ZGV2X21tYXAoc3RydWN0IGZpbGUgKmZsaXAsIHN0cnVj
dCB2bV9hcmVhX3N0cnVjdCAqdm1hKQogCW11dGV4X3VubG9jaygmcHJpdi0+bG9jayk7CiBvdXRf
cHV0X21hcDoKIAlpZiAodXNlX3B0ZW1vZCkgewotCQltYXAtPnZtYSA9IE5VTEw7CiAJCXVubWFw
X2dyYW50X3BhZ2VzKG1hcCwgMCwgbWFwLT5jb3VudCk7CisJCWlmIChtYXAtPnZtYSkgeworCQkJ
bW11X3JhbmdlX25vdGlmaWVyX3JlbW92ZSgmbWFwLT5ub3RpZmllcik7CisJCQltYXAtPnZtYSA9
IE5VTEw7CisJCX0KIAl9CiAJZ250ZGV2X3B1dF9tYXAocHJpdiwgbWFwKTsKIAlyZXR1cm4gZXJy
OwotLSAKMi4yMy4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fXwpkcmktZGV2ZWwgbWFpbGluZyBsaXN0CmRyaS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5v
cmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9kcmktZGV2
ZWw=
