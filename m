Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id C0F5FCDA53
	for <lists+dri-devel@lfdr.de>; Mon,  7 Oct 2019 03:57:27 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C2B386E443;
	Mon,  7 Oct 2019 01:57:25 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pg1-x542.google.com (mail-pg1-x542.google.com
 [IPv6:2607:f8b0:4864:20::542])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9B1066E442;
 Mon,  7 Oct 2019 01:57:24 +0000 (UTC)
Received: by mail-pg1-x542.google.com with SMTP id p1so5442051pgi.4;
 Sun, 06 Oct 2019 18:57:24 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=dNm/7mewWpLjZU/+CTtHFe/1es29jZY16+A8GAg9LHU=;
 b=AeD5kJiqGYtIdBPtxudk/Swk1IPLoEzhqeWEjjpMEr9Zx4Ha7+Xihd2NTQ4dWTpWrc
 dQuxDAm5Nd0Ct6rvWtUJSxYAf8EVXRk3frcHYIufNOJXzljMJM0+p0RgRJbKDfQzM6gf
 arwtVTvDr0A9O3LgCDwZ//CsYE68kaAR5MYOwHRXo2UVAmGk7wuukNZw1yUpmeiAz0zE
 CPYTV4n4/+Zd3ezZ0XwUtAn4/VYYoCkb6YGkUdEGpImRc2vqYcDcKPdOS+o7+IcMmjwK
 Hbv934Ys0kU6lsaN7bPBbGYFx9NY+8N00R8PrdfA4voSgz+TcOftv+HTankZ3/JFR1m7
 2oyQ==
X-Gm-Message-State: APjAAAXpemlWK2z2u1h6+5vR4HNGxjPLy46tYpvQvnoDCeNdlJ0ueyVi
 8NseBQuHUArd/QFpRlsFMPz1hXuD/BWIaw==
X-Google-Smtp-Source: APXvYqyxERvEFhb7Q8Q77nbpeSf/sTH2wpog9N9HLLdsg99k8ryQtlcdFSH4sgSyHeNb53Ppc9+HFw==
X-Received: by 2002:a65:6285:: with SMTP id f5mr14674217pgv.238.1570413443969; 
 Sun, 06 Oct 2019 18:57:23 -0700 (PDT)
Received: from yuq-Aspire-4738G.lan (ah.ptr230.ptrcloud.net. [153.122.161.8])
 by smtp.gmail.com with ESMTPSA id
 b123sm18328536pgc.72.2019.10.06.18.57.20
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Sun, 06 Oct 2019 18:57:23 -0700 (PDT)
From: Qiang Yu <yuq825@gmail.com>
To: dri-devel@lists.freedesktop.org
Subject: [PATCH v3 1/6] drm/gem: refine drm_gem_objects_lookup
Date: Mon,  7 Oct 2019 09:54:25 +0800
Message-Id: <20191007015430.20829-2-yuq825@gmail.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20191007015430.20829-1-yuq825@gmail.com>
References: <20191007015430.20829-1-yuq825@gmail.com>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=dNm/7mewWpLjZU/+CTtHFe/1es29jZY16+A8GAg9LHU=;
 b=WaQqgEgRD91ulkU/jp/BaEubq/bV7Ziwt5n7ikSkK5htllLm/pq5J12mGMKp9o/9mn
 rQ0WpOJkxA5J2nHGluLwLyyTGM5usnuhkqSoby+uhbnDiaBIeLj0Ui6CxGIKr8rpADSo
 Y+W9lr6RnOu3ayd0sm7UnP7GFYllJM2bgP5v0xOG48t5Gf1EhTW96EtyvsDM6HgMCDY4
 zsvqw/OFnoPIANN2aGvHOLXnnvoA6XLxv3LtnNC2VXj1Csv7unwcRvAOQ9YfAREhPltn
 n+9+5Gc/ThoFdEIN7qVUzWI6EihRmcRc1CpgTd4al995Snm4TZ817UHuYSt+VyjdV03H
 7rrA==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Tomeu Vizoso <tomeu.vizoso@collabora.com>, lima@lists.freedesktop.org,
 David Airlie <airlied@linux.ie>, Maxime Ripard <mripard@kernel.org>,
 Qiang Yu <yuq825@gmail.com>, Sean Paul <sean@poorly.run>,
 Alyssa Rosenzweig <alyssa.rosenzweig@collabora.com>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

Q2hhbmdlIGRybV9nZW1fb2JqZWN0c19sb29rdXAoKSB0byBub3QgdXNlIHVzZXIgc3BhY2UgYm8g
aGFuZGxlcwpkaXJlY3RseSBhbmQgYWRkIGEgbmV3IGludGVyZmFjZSBkcm1fZ2VtX29iamVjdHNf
bG9va3VwX3VzZXIoKQpmb3IgZG9pbmcgdGhlIG9yaWdpbmFsIHdvcmsuCgpUaGlzIGlzIGZvciBk
cml2ZXIgbGlrZSBsaW1hIHdoaWNoIGRvZXMgbm90IHBhc3MgZ2VtIGJvCmhhbmRsZXMgY29udGlu
b3VzbHkgaW4gYW4gYXJyYXkgaW4gaW9jdGwgYXJndW1lbnQuCgp2MjoKMS4gYWRkIGRybV9nZW1f
b2JqZWN0c19sb29rdXBfdXNlcgoyLiByZW1vdmUgbm9uZS16ZXJvIGNoZWNrIGFzIGFsbCBjYWxs
ZXIgd2lsbCBjaGVjayBiZWZvcmUKICAgY2FsbGluZyB0aGlzIGZ1bmN0aW9uCgp2MzoKaW1wcm92
ZSBjb21taXQgY29tbWVudC4KCkNjOiBUb21ldSBWaXpvc28gPHRvbWV1LnZpem9zb0Bjb2xsYWJv
cmEuY29tPgpDYzogQWx5c3NhIFJvc2VuendlaWcgPGFseXNzYS5yb3Nlbnp3ZWlnQGNvbGxhYm9y
YS5jb20+ClN1Z2dlc3RlZC1ieTogUm9iIEhlcnJpbmcgPHJvYmhAa2VybmVsLm9yZz4KUmV2aWV3
ZWQtYnk6IFN0ZXZlbiBQcmljZSA8c3RldmVuLnByaWNlQGFybS5jb20+ClNpZ25lZC1vZmYtYnk6
IFFpYW5nIFl1IDx5dXE4MjVAZ21haWwuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9kcm1fZ2Vt
LmMgICAgICAgICAgICAgICB8IDU3ICsrKysrKysrKysrKysrKysrKystLS0tLS0KIGRyaXZlcnMv
Z3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9kcnYuYyB8ICA2ICstLQogaW5jbHVkZS9kcm0vZHJt
X2dlbS5oICAgICAgICAgICAgICAgICAgIHwgIDQgKy0KIDMgZmlsZXMgY2hhbmdlZCwgNDkgaW5z
ZXJ0aW9ucygrKSwgMTggZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJt
L2RybV9nZW0uYyBiL2RyaXZlcnMvZ3B1L2RybS9kcm1fZ2VtLmMKaW5kZXggNjg1NGY1ODY3ZDUx
Li5hNWU4OGMzZTZkMjUgMTAwNjQ0Ci0tLSBhL2RyaXZlcnMvZ3B1L2RybS9kcm1fZ2VtLmMKKysr
IGIvZHJpdmVycy9ncHUvZHJtL2RybV9nZW0uYwpAQCAtNjc5LDExICs2NzksMTEgQEAgc3RhdGlj
IGludCBvYmplY3RzX2xvb2t1cChzdHJ1Y3QgZHJtX2ZpbGUgKmZpbHAsIHUzMiAqaGFuZGxlLCBp
bnQgY291bnQsCiAvKioKICAqIGRybV9nZW1fb2JqZWN0c19sb29rdXAgLSBsb29rIHVwIEdFTSBv
YmplY3RzIGZyb20gYW4gYXJyYXkgb2YgaGFuZGxlcwogICogQGZpbHA6IERSTSBmaWxlIHByaXZh
dGUgZGF0ZQotICogQGJvX2hhbmRsZXM6IHVzZXIgcG9pbnRlciB0byBhcnJheSBvZiB1c2Vyc3Bh
Y2UgaGFuZGxlCisgKiBAYm9faGFuZGxlczogYXJyYXkgb2YgR0VNIG9iamVjdCBoYW5kbGVzCiAg
KiBAY291bnQ6IHNpemUgb2YgaGFuZGxlIGFycmF5CiAgKiBAb2Jqc19vdXQ6IHJldHVybmVkIHBv
aW50ZXIgdG8gYXJyYXkgb2YgZHJtX2dlbV9vYmplY3QgcG9pbnRlcnMKICAqCi0gKiBUYWtlcyBh
biBhcnJheSBvZiB1c2Vyc3BhY2UgaGFuZGxlcyBhbmQgcmV0dXJucyBhIG5ld2x5IGFsbG9jYXRl
ZCBhcnJheSBvZgorICogVGFrZXMgYW4gYXJyYXkgb2YgR0VNIG9iamVjdCBoYW5kbGVzIGFuZCBy
ZXR1cm5zIGEgbmV3bHkgYWxsb2NhdGVkIGFycmF5IG9mCiAgKiBHRU0gb2JqZWN0cy4KICAqCiAg
KiBGb3IgYSBzaW5nbGUgaGFuZGxlIGxvb2t1cCwgdXNlIGRybV9nZW1fb2JqZWN0X2xvb2t1cCgp
LgpAQCAtNjk1LDI2ICs2OTUsNTYgQEAgc3RhdGljIGludCBvYmplY3RzX2xvb2t1cChzdHJ1Y3Qg
ZHJtX2ZpbGUgKmZpbHAsIHUzMiAqaGFuZGxlLCBpbnQgY291bnQsCiAgKiBmYWlsdXJlLiAwIGlz
IHJldHVybmVkIG9uIHN1Y2Nlc3MuCiAgKgogICovCi1pbnQgZHJtX2dlbV9vYmplY3RzX2xvb2t1
cChzdHJ1Y3QgZHJtX2ZpbGUgKmZpbHAsIHZvaWQgX191c2VyICpib19oYW5kbGVzLAoraW50IGRy
bV9nZW1fb2JqZWN0c19sb29rdXAoc3RydWN0IGRybV9maWxlICpmaWxwLCB1MzIgKmJvX2hhbmRs
ZXMsCiAJCQkgICBpbnQgY291bnQsIHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqKipvYmpzX291dCkK
IHsKIAlpbnQgcmV0OwotCXUzMiAqaGFuZGxlczsKIAlzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKipv
YmpzOwogCi0JaWYgKCFjb3VudCkKLQkJcmV0dXJuIDA7Ci0KIAlvYmpzID0ga3ZtYWxsb2NfYXJy
YXkoY291bnQsIHNpemVvZihzdHJ1Y3QgZHJtX2dlbV9vYmplY3QgKiksCiAJCQkgICAgIEdGUF9L
RVJORUwgfCBfX0dGUF9aRVJPKTsKIAlpZiAoIW9ianMpCiAJCXJldHVybiAtRU5PTUVNOwogCisJ
cmV0ID0gb2JqZWN0c19sb29rdXAoZmlscCwgYm9faGFuZGxlcywgY291bnQsIG9ianMpOworCWlm
IChyZXQpCisJCWt2ZnJlZShvYmpzKTsKKwllbHNlCisJCSpvYmpzX291dCA9IG9ianM7CisKKwly
ZXR1cm4gcmV0OworCit9CitFWFBPUlRfU1lNQk9MKGRybV9nZW1fb2JqZWN0c19sb29rdXApOwor
CisvKioKKyAqIGRybV9nZW1fb2JqZWN0c19sb29rdXBfdXNlciAtIGxvb2sgdXAgR0VNIG9iamVj
dHMgZnJvbSBhbiBhcnJheSBvZiBoYW5kbGVzCisgKiBAZmlscDogRFJNIGZpbGUgcHJpdmF0ZSBk
YXRlCisgKiBAYm9faGFuZGxlczogdXNlciBwb2ludGVyIHRvIGFycmF5IG9mIHVzZXJzcGFjZSBo
YW5kbGUKKyAqIEBjb3VudDogc2l6ZSBvZiBoYW5kbGUgYXJyYXkKKyAqIEBvYmpzX291dDogcmV0
dXJuZWQgcG9pbnRlciB0byBhcnJheSBvZiBkcm1fZ2VtX29iamVjdCBwb2ludGVycworICoKKyAq
IFRha2VzIGFuIGFycmF5IG9mIHVzZXJzcGFjZSBoYW5kbGVzIGFuZCByZXR1cm5zIGEgbmV3bHkg
YWxsb2NhdGVkIGFycmF5IG9mCisgKiBHRU0gb2JqZWN0cy4KKyAqCisgKiBGb3IgYSBzaW5nbGUg
aGFuZGxlIGxvb2t1cCwgdXNlIGRybV9nZW1fb2JqZWN0X2xvb2t1cCgpLgorICoKKyAqIFJldHVy
bnM6CisgKgorICogQG9ianMgZmlsbGVkIGluIHdpdGggR0VNIG9iamVjdCBwb2ludGVycy4gUmV0
dXJuZWQgR0VNIG9iamVjdHMgbmVlZCB0byBiZQorICogcmVsZWFzZWQgd2l0aCBkcm1fZ2VtX29i
amVjdF9wdXQoKS4gLUVOT0VOVCBpcyByZXR1cm5lZCBvbiBhIGxvb2t1cAorICogZmFpbHVyZS4g
MCBpcyByZXR1cm5lZCBvbiBzdWNjZXNzLgorICoKKyAqLworaW50IGRybV9nZW1fb2JqZWN0c19s
b29rdXBfdXNlcihzdHJ1Y3QgZHJtX2ZpbGUgKmZpbHAsIHZvaWQgX191c2VyICpib19oYW5kbGVz
LAorCQkJCWludCBjb3VudCwgc3RydWN0IGRybV9nZW1fb2JqZWN0ICoqKm9ianNfb3V0KQorewor
CWludCByZXQ7CisJdTMyICpoYW5kbGVzOworCiAJaGFuZGxlcyA9IGt2bWFsbG9jX2FycmF5KGNv
dW50LCBzaXplb2YodTMyKSwgR0ZQX0tFUk5FTCk7Ci0JaWYgKCFoYW5kbGVzKSB7Ci0JCXJldCA9
IC1FTk9NRU07Ci0JCWdvdG8gb3V0OwotCX0KKwlpZiAoIWhhbmRsZXMpCisJCXJldHVybiAtRU5P
TUVNOwogCiAJaWYgKGNvcHlfZnJvbV91c2VyKGhhbmRsZXMsIGJvX2hhbmRsZXMsIGNvdW50ICog
c2l6ZW9mKHUzMikpKSB7CiAJCXJldCA9IC1FRkFVTFQ7CkBAIC03MjIsMTUgKzc1MiwxNCBAQCBp
bnQgZHJtX2dlbV9vYmplY3RzX2xvb2t1cChzdHJ1Y3QgZHJtX2ZpbGUgKmZpbHAsIHZvaWQgX191
c2VyICpib19oYW5kbGVzLAogCQlnb3RvIG91dDsKIAl9CiAKLQlyZXQgPSBvYmplY3RzX2xvb2t1
cChmaWxwLCBoYW5kbGVzLCBjb3VudCwgb2Jqcyk7Ci0JKm9ianNfb3V0ID0gb2JqczsKKwlyZXQg
PSBkcm1fZ2VtX29iamVjdHNfbG9va3VwKGZpbHAsIGhhbmRsZXMsIGNvdW50LCBvYmpzX291dCk7
CiAKIG91dDoKIAlrdmZyZWUoaGFuZGxlcyk7CiAJcmV0dXJuIHJldDsKIAogfQotRVhQT1JUX1NZ
TUJPTChkcm1fZ2VtX29iamVjdHNfbG9va3VwKTsKK0VYUE9SVF9TWU1CT0woZHJtX2dlbV9vYmpl
Y3RzX2xvb2t1cF91c2VyKTsKIAogLyoqCiAgKiBkcm1fZ2VtX29iamVjdF9sb29rdXAgLSBsb29r
IHVwIGEgR0VNIG9iamVjdCBmcm9tIGl0cyBoYW5kbGUKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1
L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9kcnYuYyBiL2RyaXZlcnMvZ3B1L2RybS9wYW5mcm9zdC9w
YW5mcm9zdF9kcnYuYwppbmRleCBkNzQ0NDJkNzEwNDguLjQ4NmNhNTFkNTY2MiAxMDA2NDQKLS0t
IGEvZHJpdmVycy9ncHUvZHJtL3BhbmZyb3N0L3BhbmZyb3N0X2Rydi5jCisrKyBiL2RyaXZlcnMv
Z3B1L2RybS9wYW5mcm9zdC9wYW5mcm9zdF9kcnYuYwpAQCAtMTMwLDkgKzEzMCw5IEBAIHBhbmZy
b3N0X2xvb2t1cF9ib3Moc3RydWN0IGRybV9kZXZpY2UgKmRldiwKIAlpZiAoIWpvYi0+aW1wbGlj
aXRfZmVuY2VzKQogCQlyZXR1cm4gLUVOT01FTTsKIAotCXJldHVybiBkcm1fZ2VtX29iamVjdHNf
bG9va3VwKGZpbGVfcHJpdiwKLQkJCQkgICAgICAodm9pZCBfX3VzZXIgKikodWludHB0cl90KWFy
Z3MtPmJvX2hhbmRsZXMsCi0JCQkJICAgICAgam9iLT5ib19jb3VudCwgJmpvYi0+Ym9zKTsKKwly
ZXR1cm4gZHJtX2dlbV9vYmplY3RzX2xvb2t1cF91c2VyKGZpbGVfcHJpdiwKKwkJCQkJICAgKHZv
aWQgX191c2VyICopKHVpbnRwdHJfdClhcmdzLT5ib19oYW5kbGVzLAorCQkJCQkgICBqb2ItPmJv
X2NvdW50LCAmam9iLT5ib3MpOwogfQogCiAvKioKZGlmZiAtLWdpdCBhL2luY2x1ZGUvZHJtL2Ry
bV9nZW0uaCBiL2luY2x1ZGUvZHJtL2RybV9nZW0uaAppbmRleCA2YWFiYTE0ZjU5NzIuLjM1NGZj
OGQyNDBlNCAxMDA2NDQKLS0tIGEvaW5jbHVkZS9kcm0vZHJtX2dlbS5oCisrKyBiL2luY2x1ZGUv
ZHJtL2RybV9nZW0uaApAQCAtMzg3LDggKzM4NywxMCBAQCBzdHJ1Y3QgcGFnZSAqKmRybV9nZW1f
Z2V0X3BhZ2VzKHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqb2JqKTsKIHZvaWQgZHJtX2dlbV9wdXRf
cGFnZXMoc3RydWN0IGRybV9nZW1fb2JqZWN0ICpvYmosIHN0cnVjdCBwYWdlICoqcGFnZXMsCiAJ
CWJvb2wgZGlydHksIGJvb2wgYWNjZXNzZWQpOwogCi1pbnQgZHJtX2dlbV9vYmplY3RzX2xvb2t1
cChzdHJ1Y3QgZHJtX2ZpbGUgKmZpbHAsIHZvaWQgX191c2VyICpib19oYW5kbGVzLAoraW50IGRy
bV9nZW1fb2JqZWN0c19sb29rdXAoc3RydWN0IGRybV9maWxlICpmaWxwLCB1MzIgKmJvX2hhbmRs
ZXMsCiAJCQkgICBpbnQgY291bnQsIHN0cnVjdCBkcm1fZ2VtX29iamVjdCAqKipvYmpzX291dCk7
CitpbnQgZHJtX2dlbV9vYmplY3RzX2xvb2t1cF91c2VyKHN0cnVjdCBkcm1fZmlsZSAqZmlscCwg
dm9pZCBfX3VzZXIgKmJvX2hhbmRsZXMsCisJCQkJaW50IGNvdW50LCBzdHJ1Y3QgZHJtX2dlbV9v
YmplY3QgKioqb2Jqc19vdXQpOwogc3RydWN0IGRybV9nZW1fb2JqZWN0ICpkcm1fZ2VtX29iamVj
dF9sb29rdXAoc3RydWN0IGRybV9maWxlICpmaWxwLCB1MzIgaGFuZGxlKTsKIGxvbmcgZHJtX2dl
bV9kbWFfcmVzdl93YWl0KHN0cnVjdCBkcm1fZmlsZSAqZmlsZXAsIHUzMiBoYW5kbGUsCiAJCQkJ
ICAgIGJvb2wgd2FpdF9hbGwsIHVuc2lnbmVkIGxvbmcgdGltZW91dCk7Ci0tIAoyLjE3LjEKCl9f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZlbCBt
YWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3Rz
LmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbA==
