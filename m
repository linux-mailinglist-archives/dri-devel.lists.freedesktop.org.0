Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id DD15C34642E
	for <lists+dri-devel@lfdr.de>; Tue, 23 Mar 2021 16:59:32 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 37F086EC36;
	Tue, 23 Mar 2021 15:58:43 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mblankhorst.nl (mblankhorst.nl [141.105.120.124])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 3EC376EC14
 for <dri-devel@lists.freedesktop.org>; Tue, 23 Mar 2021 15:57:47 +0000 (UTC)
From: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [PATCH v9 29/70] drm/i915: Defer pin calls in buffer pool until first
 use by caller.
Date: Tue, 23 Mar 2021 16:50:18 +0100
Message-Id: <20210323155059.628690-30-maarten.lankhorst@linux.intel.com>
X-Mailer: git-send-email 2.31.0
In-Reply-To: <20210323155059.628690-1-maarten.lankhorst@linux.intel.com>
References: <20210323155059.628690-1-maarten.lankhorst@linux.intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>,
 dri-devel@lists.freedesktop.org
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

V2UgbmVlZCB0byB0YWtlIHRoZSBvYmogbG9jayB0byBwaW4gcGFnZXMsIHNvIHdhaXQgdW50aWwg
dGhlIGNhbGxlcnMKaGF2ZSBkb25lIHNvLCBiZWZvcmUgbWFraW5nIHRoZSBvYmplY3QgdW5zaHJp
bmthYmxlLgoKU2lnbmVkLW9mZi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hv
cnN0QGxpbnV4LmludGVsLmNvbT4KUmV2aWV3ZWQtYnk6IFRob21hcyBIZWxsc3Ryw7ZtIDx0aG9t
YXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNvbT4KLS0tCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9p
OTE1X2dlbV9leGVjYnVmZmVyLmMgICAgfCAgMiArCiAuLi4vZ3B1L2RybS9pOTE1L2dlbS9pOTE1
X2dlbV9vYmplY3RfYmx0LmMgICAgfCAgNiArKysKIC4uLi9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxf
Z3RfYnVmZmVyX3Bvb2wuYyAgICB8IDQ3ICsrKysrKysrKy0tLS0tLS0tLS0KIC4uLi9ncHUvZHJt
L2k5MTUvZ3QvaW50ZWxfZ3RfYnVmZmVyX3Bvb2wuaCAgICB8ICA1ICsrCiAuLi4vZHJtL2k5MTUv
Z3QvaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfdHlwZXMuaCAgfCAgMSArCiA1IGZpbGVzIGNoYW5nZWQs
IDM1IGluc2VydGlvbnMoKyksIDI2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMv
Z3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVmZmVyLmMgYi9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fZXhlY2J1ZmZlci5jCmluZGV4IGI1Y2E5ZWI1MzU2NS4uMzdmZWNk
Mjk1ZWI2IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fZXhl
Y2J1ZmZlci5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9leGVjYnVm
ZmVyLmMKQEAgLTEzNDIsNiArMTM0Miw3IEBAIHN0YXRpYyBpbnQgX19yZWxvY19ncHVfYWxsb2Mo
c3RydWN0IGk5MTVfZXhlY2J1ZmZlciAqZWIsCiAJCWVyciA9IFBUUl9FUlIoY21kKTsKIAkJZ290
byBlcnJfcG9vbDsKIAl9CisJaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfbWFya191c2VkKHBvb2wpOwog
CiAJbWVtc2V0MzIoY21kLCAwLCBwb29sLT5vYmotPmJhc2Uuc2l6ZSAvIHNpemVvZih1MzIpKTsK
IApAQCAtMjYzNyw2ICsyNjM4LDcgQEAgc3RhdGljIGludCBlYl9wYXJzZShzdHJ1Y3QgaTkxNV9l
eGVjYnVmZmVyICplYikKIAkJZXJyID0gUFRSX0VSUihzaGFkb3cpOwogCQlnb3RvIGVycjsKIAl9
CisJaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfbWFya191c2VkKHBvb2wpOwogCWk5MTVfZ2VtX29iamVj
dF9zZXRfcmVhZG9ubHkoc2hhZG93LT5vYmopOwogCXNoYWRvdy0+cHJpdmF0ZSA9IHBvb2w7CiAK
ZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2dlbS9pOTE1X2dlbV9vYmplY3RfYmx0
LmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0X2JsdC5jCmluZGV4
IGQ2ZGFjMjFmY2UwYi4uZGY4ZThjMThjNmM5IDEwMDY0NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0v
aTkxNS9nZW0vaTkxNV9nZW1fb2JqZWN0X2JsdC5jCisrKyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2dlbS9pOTE1X2dlbV9vYmplY3RfYmx0LmMKQEAgLTU1LDYgKzU1LDkgQEAgc3RydWN0IGk5MTVf
dm1hICppbnRlbF9lbWl0X3ZtYV9maWxsX2JsdChzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCiAJ
aWYgKHVubGlrZWx5KGVycikpCiAJCWdvdG8gb3V0X3B1dDsKIAorCS8qIHdlIHBpbm5lZCB0aGUg
cG9vbCwgbWFyayBpdCBhcyBzdWNoICovCisJaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfbWFya191c2Vk
KHBvb2wpOworCiAJY21kID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9tYXAocG9vbC0+b2JqLCBwb29s
LT50eXBlKTsKIAlpZiAoSVNfRVJSKGNtZCkpIHsKIAkJZXJyID0gUFRSX0VSUihjbWQpOwpAQCAt
Mjc3LDYgKzI4MCw5IEBAIHN0cnVjdCBpOTE1X3ZtYSAqaW50ZWxfZW1pdF92bWFfY29weV9ibHQo
c3RydWN0IGludGVsX2NvbnRleHQgKmNlLAogCWlmICh1bmxpa2VseShlcnIpKQogCQlnb3RvIG91
dF9wdXQ7CiAKKwkvKiB3ZSBwaW5uZWQgdGhlIHBvb2wsIG1hcmsgaXQgYXMgc3VjaCAqLworCWlu
dGVsX2d0X2J1ZmZlcl9wb29sX21hcmtfdXNlZChwb29sKTsKKwogCWNtZCA9IGk5MTVfZ2VtX29i
amVjdF9waW5fbWFwKHBvb2wtPm9iaiwgcG9vbC0+dHlwZSk7CiAJaWYgKElTX0VSUihjbWQpKSB7
CiAJCWVyciA9IFBUUl9FUlIoY21kKTsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1
L2d0L2ludGVsX2d0X2J1ZmZlcl9wb29sLmMgYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRl
bF9ndF9idWZmZXJfcG9vbC5jCmluZGV4IDA2ZDg0Y2YwOTU3MC4uYzU5NDY4MTA3NTk4IDEwMDY0
NAotLS0gYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF9idWZmZXJfcG9vbC5jCisr
KyBiL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X2J1ZmZlcl9wb29sLmMKQEAgLTk4
LDI4ICs5OCw2IEBAIHN0YXRpYyB2b2lkIHBvb2xfZnJlZV93b3JrKHN0cnVjdCB3b3JrX3N0cnVj
dCAqd3JrKQogCQkJCSAgICAgIHJvdW5kX2ppZmZpZXNfdXBfcmVsYXRpdmUoSFopKTsKIH0KIAot
c3RhdGljIGludCBwb29sX2FjdGl2ZShzdHJ1Y3QgaTkxNV9hY3RpdmUgKnJlZikKLXsKLQlzdHJ1
Y3QgaW50ZWxfZ3RfYnVmZmVyX3Bvb2xfbm9kZSAqbm9kZSA9Ci0JCWNvbnRhaW5lcl9vZihyZWYs
IHR5cGVvZigqbm9kZSksIGFjdGl2ZSk7Ci0Jc3RydWN0IGRtYV9yZXN2ICpyZXN2ID0gbm9kZS0+
b2JqLT5iYXNlLnJlc3Y7Ci0JaW50IGVycjsKLQotCWlmIChkbWFfcmVzdl90cnlsb2NrKHJlc3Yp
KSB7Ci0JCWRtYV9yZXN2X2FkZF9leGNsX2ZlbmNlKHJlc3YsIE5VTEwpOwotCQlkbWFfcmVzdl91
bmxvY2socmVzdik7Ci0JfQotCi0JZXJyID0gaTkxNV9nZW1fb2JqZWN0X3Bpbl9wYWdlcyhub2Rl
LT5vYmopOwotCWlmIChlcnIpCi0JCXJldHVybiBlcnI7Ci0KLQkvKiBIaWRlIHRoaXMgcGlubmVk
IG9iamVjdCBmcm9tIHRoZSBzaHJpbmtlciB1bnRpbCByZXRpcmVkICovCi0JaTkxNV9nZW1fb2Jq
ZWN0X21ha2VfdW5zaHJpbmthYmxlKG5vZGUtPm9iaik7Ci0KLQlyZXR1cm4gMDsKLX0KLQogX19p
OTE1X2FjdGl2ZV9jYWxsCiBzdGF0aWMgdm9pZCBwb29sX3JldGlyZShzdHJ1Y3QgaTkxNV9hY3Rp
dmUgKnJlZikKIHsKQEAgLTEyOSwxMCArMTA3LDEzIEBAIHN0YXRpYyB2b2lkIHBvb2xfcmV0aXJl
KHN0cnVjdCBpOTE1X2FjdGl2ZSAqcmVmKQogCXN0cnVjdCBsaXN0X2hlYWQgKmxpc3QgPSBidWNr
ZXRfZm9yX3NpemUocG9vbCwgbm9kZS0+b2JqLT5iYXNlLnNpemUpOwogCXVuc2lnbmVkIGxvbmcg
ZmxhZ3M7CiAKLQlpOTE1X2dlbV9vYmplY3RfdW5waW5fcGFnZXMobm9kZS0+b2JqKTsKKwlpZiAo
bm9kZS0+cGlubmVkKSB7CisJCWk5MTVfZ2VtX29iamVjdF91bnBpbl9wYWdlcyhub2RlLT5vYmop
OwogCi0JLyogUmV0dXJuIHRoaXMgb2JqZWN0IHRvIHRoZSBzaHJpbmtlciBwb29sICovCi0JaTkx
NV9nZW1fb2JqZWN0X21ha2VfcHVyZ2VhYmxlKG5vZGUtPm9iaik7CisJCS8qIFJldHVybiB0aGlz
IG9iamVjdCB0byB0aGUgc2hyaW5rZXIgcG9vbCAqLworCQlpOTE1X2dlbV9vYmplY3RfbWFrZV9w
dXJnZWFibGUobm9kZS0+b2JqKTsKKwkJbm9kZS0+cGlubmVkID0gZmFsc2U7CisJfQogCiAJR0VN
X0JVR19PTihub2RlLT5hZ2UpOwogCXNwaW5fbG9ja19pcnFzYXZlKCZwb29sLT5sb2NrLCBmbGFn
cyk7CkBAIC0xNDQsNiArMTI1LDE5IEBAIHN0YXRpYyB2b2lkIHBvb2xfcmV0aXJlKHN0cnVjdCBp
OTE1X2FjdGl2ZSAqcmVmKQogCQkJICAgICAgcm91bmRfamlmZmllc191cF9yZWxhdGl2ZShIWikp
OwogfQogCit2b2lkIGludGVsX2d0X2J1ZmZlcl9wb29sX21hcmtfdXNlZChzdHJ1Y3QgaW50ZWxf
Z3RfYnVmZmVyX3Bvb2xfbm9kZSAqbm9kZSkKK3sKKwlhc3NlcnRfb2JqZWN0X2hlbGQobm9kZS0+
b2JqKTsKKworCWlmIChub2RlLT5waW5uZWQpCisJCXJldHVybjsKKworCV9faTkxNV9nZW1fb2Jq
ZWN0X3Bpbl9wYWdlcyhub2RlLT5vYmopOworCS8qIEhpZGUgdGhpcyBwaW5uZWQgb2JqZWN0IGZy
b20gdGhlIHNocmlua2VyIHVudGlsIHJldGlyZWQgKi8KKwlpOTE1X2dlbV9vYmplY3RfbWFrZV91
bnNocmlua2FibGUobm9kZS0+b2JqKTsKKwlub2RlLT5waW5uZWQgPSB0cnVlOworfQorCiBzdGF0
aWMgc3RydWN0IGludGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgKgogbm9kZV9jcmVhdGUoc3RydWN0
IGludGVsX2d0X2J1ZmZlcl9wb29sICpwb29sLCBzaXplX3Qgc3osCiAJICAgIGVudW0gaTkxNV9t
YXBfdHlwZSB0eXBlKQpAQCAtMTU5LDcgKzE1Myw4IEBAIG5vZGVfY3JlYXRlKHN0cnVjdCBpbnRl
bF9ndF9idWZmZXJfcG9vbCAqcG9vbCwgc2l6ZV90IHN6LAogCiAJbm9kZS0+YWdlID0gMDsKIAlu
b2RlLT5wb29sID0gcG9vbDsKLQlpOTE1X2FjdGl2ZV9pbml0KCZub2RlLT5hY3RpdmUsIHBvb2xf
YWN0aXZlLCBwb29sX3JldGlyZSk7CisJbm9kZS0+cGlubmVkID0gZmFsc2U7CisJaTkxNV9hY3Rp
dmVfaW5pdCgmbm9kZS0+YWN0aXZlLCBOVUxMLCBwb29sX3JldGlyZSk7CiAKIAlvYmogPSBpOTE1
X2dlbV9vYmplY3RfY3JlYXRlX2ludGVybmFsKGd0LT5pOTE1LCBzeik7CiAJaWYgKElTX0VSUihv
YmopKSB7CmRpZmYgLS1naXQgYS9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF9idWZm
ZXJfcG9vbC5oIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfYnVmZmVyX3Bvb2wu
aAppbmRleCA2MDY4ZjhmMTc2MmUuLjQ4N2I4YTU1MjBmMSAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvZ3QvaW50ZWxfZ3RfYnVmZmVyX3Bvb2wuaAorKysgYi9kcml2ZXJzL2dwdS9k
cm0vaTkxNS9ndC9pbnRlbF9ndF9idWZmZXJfcG9vbC5oCkBAIC0xOCwxMCArMTgsMTUgQEAgc3Ry
dWN0IGludGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgKgogaW50ZWxfZ3RfZ2V0X2J1ZmZlcl9wb29s
KHN0cnVjdCBpbnRlbF9ndCAqZ3QsIHNpemVfdCBzaXplLAogCQkJIGVudW0gaTkxNV9tYXBfdHlw
ZSB0eXBlKTsKIAordm9pZCBpbnRlbF9ndF9idWZmZXJfcG9vbF9tYXJrX3VzZWQoc3RydWN0IGlu
dGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgKm5vZGUpOworCiBzdGF0aWMgaW5saW5lIGludAogaW50
ZWxfZ3RfYnVmZmVyX3Bvb2xfbWFya19hY3RpdmUoc3RydWN0IGludGVsX2d0X2J1ZmZlcl9wb29s
X25vZGUgKm5vZGUsCiAJCQkJIHN0cnVjdCBpOTE1X3JlcXVlc3QgKnJxKQogeworCS8qIGRpZCB3
ZSBjYWxsIG1hcmtfdXNlZD8gKi8KKwlHRU1fV0FSTl9PTighbm9kZS0+cGlubmVkKTsKKwogCXJl
dHVybiBpOTE1X2FjdGl2ZV9hZGRfcmVxdWVzdCgmbm9kZS0+YWN0aXZlLCBycSk7CiB9CiAKZGlm
ZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X2J1ZmZlcl9wb29sX3R5
cGVzLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF9idWZmZXJfcG9vbF90eXBl
cy5oCmluZGV4IGM0OWI4NGZlNTE2NC4uZGYxZDc1ZDA4Y2QyIDEwMDY0NAotLS0gYS9kcml2ZXJz
L2dwdS9kcm0vaTkxNS9ndC9pbnRlbF9ndF9idWZmZXJfcG9vbF90eXBlcy5oCisrKyBiL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L2d0L2ludGVsX2d0X2J1ZmZlcl9wb29sX3R5cGVzLmgKQEAgLTMwLDYg
KzMwLDcgQEAgc3RydWN0IGludGVsX2d0X2J1ZmZlcl9wb29sX25vZGUgewogCX07CiAJdW5zaWdu
ZWQgbG9uZyBhZ2U7CiAJZW51bSBpOTE1X21hcF90eXBlIHR5cGU7CisJdTMyIHBpbm5lZDsKIH07
CiAKICNlbmRpZiAvKiBJTlRFTF9HVF9CVUZGRVJfUE9PTF9UWVBFU19IICovCi0tIAoyLjMxLjAK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fCmRyaS1kZXZl
bCBtYWlsaW5nIGxpc3QKZHJpLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL2RyaS1kZXZlbAo=
