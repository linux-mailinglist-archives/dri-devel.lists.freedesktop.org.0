Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E337532EBA1
	for <lists+dri-devel@lfdr.de>; Fri,  5 Mar 2021 13:52:07 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 622E86EB76;
	Fri,  5 Mar 2021 12:52:02 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-ej1-x631.google.com (mail-ej1-x631.google.com
 [IPv6:2a00:1450:4864:20::631])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C3DD16EB6C;
 Fri,  5 Mar 2021 12:51:59 +0000 (UTC)
Received: by mail-ej1-x631.google.com with SMTP id e19so3239599ejt.3;
 Fri, 05 Mar 2021 04:51:59 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=YbxWMCub35lJuigji4hDa0QZerqrtCBsl4eu4UexiKg=;
 b=XM8SpMdOfyrC4+C/J8X6JPZLYA0P+kjMzQMyTkKWLAJty3I9JreDqtBh+5WDTK1+si
 arTDfnTEzz7ln9EixXLqwGMw2fUeqy1WZyOs+0pxobvpDpP9qu8dNPZ3KI0UZup/eucH
 Z9be80ZuIAuXvqft7zTJ6H1S1AFvO8B7booJSjbNaycc5G1axsIKOQ5hl5bL+/GdSY8n
 MphVKaE2w0G5hXi2Dzg+hRInldi96o2fPrD48+W3/pLffPdCTA8Azq0MiRF1Ze20oC6z
 Ny3iAq6MwTTzSVvjcxewxWbBg90kWcbq9YZlAdgP4f/fdge+5fxfSOvSY/1MT4r8q3pU
 k4sw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=YbxWMCub35lJuigji4hDa0QZerqrtCBsl4eu4UexiKg=;
 b=NRPwrAVekKBASEvj4rsSqh/lkZu+E9Yx+gGXdREc13+k6ViNvHRlTUqcX9Kz3xOtGL
 5zzhbXQ7buXL29EoD+K62C6gci4dBK/SA83guDMCP8eGbNdZiDqSel1R/GMmb1YHB9xo
 ND/TP5vmEh14+xiXT9kywxV/QwzuOGfSS8RxlqJFSz8VENXbdphWGlTxapKdcl9JC1Cb
 AAeV5F3MHm76uvPkjC2zX6YgIuW6gllJPwhDMxD9qSImHKy0x5iR9LJ7hLCd5Ye5qWnf
 RX+AWzFbeZGHZTTH/jzGw75ZkCWQo+RTbUvSJsGU3pU9kxB92l+JjG7sAgph9XBl+g+c
 U5Cw==
X-Gm-Message-State: AOAM530yobQkwVWa4DzB7dYruE/Q7pRlztPWUu8DsYDXLY4SpI8vPek0
 bb9vpnz4aTWubpoZ3tzcvN60gzyGJnuW9Q==
X-Google-Smtp-Source: ABdhPJwwUpYtJjtV6TY2V+Kq0r/RVAAuo/+b2xdwP8u0pzG3yi+30mGzvIM0zhsMdY9fneez4Pl2RQ==
X-Received: by 2002:a17:906:a248:: with SMTP id
 bi8mr1807927ejb.260.1614948718508; 
 Fri, 05 Mar 2021 04:51:58 -0800 (PST)
Received: from abel.fritz.box ([2a02:908:1252:fb60:d4b7:8d5:a72a:f704])
 by smtp.gmail.com with ESMTPSA id si7sm1433909ejb.84.2021.03.05.04.51.57
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 05 Mar 2021 04:51:58 -0800 (PST)
From: "=?UTF-8?q?Christian=20K=C3=B6nig?=" <ckoenig.leichtzumerken@gmail.com>
X-Google-Original-From: =?UTF-8?q?Christian=20K=C3=B6nig?=
 <christian.koenig@amd.com>
To: dri-devel@lists.freedesktop.org,
	amd-gfx@lists.freedesktop.org
Subject: [PATCH 2/2] drm/amdgpu: load balance VCN3 decode as well v8
Date: Fri,  5 Mar 2021 13:51:55 +0100
Message-Id: <20210305125155.2312-2-christian.koenig@amd.com>
X-Mailer: git-send-email 2.25.1
In-Reply-To: <20210305125155.2312-1-christian.koenig@amd.com>
References: <20210305125155.2312-1-christian.koenig@amd.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: sonny.jiang@amd.com, Leo.Liu@amd.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

QWRkIFZDTjMgSUIgcGFyc2luZyB0byBmaWd1cmUgb3V0IHRvIHdoaWNoIGluc3RhbmNlIHdlIGNh
biBzZW5kIHRoZQpzdHJlYW0gZm9yIGRlY29kZS4KCnYyOiByZW1vdmUgVkNOIGluc3RhbmNlIGxp
bWl0IGFzIHdlbGwsIGZpeCBhbWRncHVfY3NfZmluZF9tYXBwaW5nLAogICAgY2hlY2sgc3VwcG9y
dGVkIGZvcm1hdHMgaW5zdGVhZCBvZiB1bnN1cHBvcnRlZC4KdjM6IGZpeCB0eXBvIGFuZCBlcnJv
ciBoYW5kbGluZwp2NDogbWFrZSBzdXJlIHRoZSBtZXNzYWdlIEJPIGlzIENQVSBhY2Nlc3NpYmxl
CnY1OiBmaXggYWRkciBjYWxjdWxhdGlvbiBvbmNlIG1vcmUKdjY6IG9ubHkgY2hlY2sgbWVzc2Fn
ZSBidWZmZXJzCnY3OiBmaXggY29uc3RhbnQgYW5kIHVzZSBkZWZpbmVzCnY4OiBmaXggY3JlYXRl
IG1zZyBjYWxjdWxhdGlvbgoKU2lnbmVkLW9mZi1ieTogQ2hyaXN0aWFuIEvDtm5pZyA8Y2hyaXN0
aWFuLmtvZW5pZ0BhbWQuY29tPgotLS0KIGRyaXZlcnMvZ3B1L2RybS9hbWQvYW1kZ3B1L3Zjbl92
M18wLmMgfCAxMzIgKysrKysrKysrKysrKysrKysrKysrKysrKy0KIDEgZmlsZSBjaGFuZ2VkLCAx
MzAgaW5zZXJ0aW9ucygrKSwgMiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2dw
dS9kcm0vYW1kL2FtZGdwdS92Y25fdjNfMC5jIGIvZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUv
dmNuX3YzXzAuYwppbmRleCBiMzNmNTEzZmQyYWMuLjc3OTMyMDAzYjRjMSAxMDA2NDQKLS0tIGEv
ZHJpdmVycy9ncHUvZHJtL2FtZC9hbWRncHUvdmNuX3YzXzAuYworKysgYi9kcml2ZXJzL2dwdS9k
cm0vYW1kL2FtZGdwdS92Y25fdjNfMC5jCkBAIC01MCw2ICs1MCw5IEBACiAjZGVmaW5lIFZDTl9J
TlNUQU5DRVNfU0lFTk5BX0NJQ0hMSUQJCQkJMgogI2RlZmluZSBERUNfU1dfUklOR19FTkFCTEVE
CQkJCQlGQUxTRQogCisjZGVmaW5lIFJERUNPREVfTVNHX0NSRUFURQkJCQkJMHgwMDAwMDAwMAor
I2RlZmluZSBSREVDT0RFX01FU1NBR0VfQ1JFQVRFCQkJCQkweDAwMDAwMDAxCisKIHN0YXRpYyBp
bnQgYW1kZ3B1X2loX2NsaWVudGlkX3ZjbnNbXSA9IHsKIAlTT0MxNV9JSF9DTElFTlRJRF9WQ04s
CiAJU09DMTVfSUhfQ0xJRU5USURfVkNOMQpAQCAtMjA4LDggKzIxMSw2IEBAIHN0YXRpYyBpbnQg
dmNuX3YzXzBfc3dfaW5pdCh2b2lkICpoYW5kbGUpCiAJCX0gZWxzZSB7CiAJCQlyaW5nLT5kb29y
YmVsbF9pbmRleCA9IChhZGV2LT5kb29yYmVsbF9pbmRleC52Y24udmNuX3JpbmcwXzEgPDwgMSkg
KyA4ICogaTsKIAkJfQotCQlpZiAoYWRldi0+YXNpY190eXBlID09IENISVBfU0lFTk5BX0NJQ0hM
SUQgJiYgaSAhPSAwKQotCQkJcmluZy0+bm9fc2NoZWR1bGVyID0gdHJ1ZTsKIAkJc3ByaW50Zihy
aW5nLT5uYW1lLCAidmNuX2RlY18lZCIsIGkpOwogCQlyID0gYW1kZ3B1X3JpbmdfaW5pdChhZGV2
LCByaW5nLCA1MTIsICZhZGV2LT52Y24uaW5zdFtpXS5pcnEsIDAsCiAJCQkJICAgICBBTURHUFVf
UklOR19QUklPX0RFRkFVTFQsCkBAIC0xODI1LDYgKzE4MjYsMTMyIEBAIHN0YXRpYyBjb25zdCBz
dHJ1Y3QgYW1kZ3B1X3JpbmdfZnVuY3MgdmNuX3YzXzBfZGVjX3N3X3Jpbmdfdm1fZnVuY3MgPSB7
CiAJLmVtaXRfcmVnX3dyaXRlX3JlZ193YWl0ID0gYW1kZ3B1X3JpbmdfZW1pdF9yZWdfd3JpdGVf
cmVnX3dhaXRfaGVscGVyLAogfTsKIAorc3RhdGljIGludCB2Y25fdjNfMF9saW1pdF9zY2hlZChz
dHJ1Y3QgYW1kZ3B1X2NzX3BhcnNlciAqcCkKK3sKKwlzdHJ1Y3QgZHJtX2dwdV9zY2hlZHVsZXIg
KipzY2hlZHM7CisKKwkvKiBUaGUgY3JlYXRlIG1zZyBtdXN0IGJlIGluIHRoZSBmaXJzdCBJQiBz
dWJtaXR0ZWQgKi8KKwlpZiAoYXRvbWljX3JlYWQoJnAtPmVudGl0eS0+ZmVuY2Vfc2VxKSkKKwkJ
cmV0dXJuIC1FSU5WQUw7CisKKwlzY2hlZHMgPSBwLT5hZGV2LT5ncHVfc2NoZWRbQU1ER1BVX0hX
X0lQX1ZDTl9ERUNdCisJCVtBTURHUFVfUklOR19QUklPX0RFRkFVTFRdLnNjaGVkOworCWRybV9z
Y2hlZF9lbnRpdHlfbW9kaWZ5X3NjaGVkKHAtPmVudGl0eSwgc2NoZWRzLCAxKTsKKwlyZXR1cm4g
MDsKK30KKworc3RhdGljIGludCB2Y25fdjNfMF9kZWNfbXNnKHN0cnVjdCBhbWRncHVfY3NfcGFy
c2VyICpwLCB1aW50NjRfdCBhZGRyKQoreworCXN0cnVjdCB0dG1fb3BlcmF0aW9uX2N0eCBjdHgg
PSB7IGZhbHNlLCBmYWxzZSB9OworCXN0cnVjdCBhbWRncHVfYm9fdmFfbWFwcGluZyAqbWFwOwor
CXVpbnQzMl90ICptc2csIG51bV9idWZmZXJzOworCXN0cnVjdCBhbWRncHVfYm8gKmJvOworCXVp
bnQ2NF90IHN0YXJ0LCBlbmQ7CisJdW5zaWduZWQgaW50IGk7CisJdm9pZCAqIHB0cjsKKwlpbnQg
cjsKKworCWFkZHIgJj0gQU1ER1BVX0dNQ19IT0xFX01BU0s7CisJciA9IGFtZGdwdV9jc19maW5k
X21hcHBpbmcocCwgYWRkciwgJmJvLCAmbWFwKTsKKwlpZiAocikgeworCQlEUk1fRVJST1IoIkNh
bid0IGZpbmQgQk8gZm9yIGFkZHIgMHglMDhMeFxuIiwgYWRkcik7CisJCXJldHVybiByOworCX0K
KworCXN0YXJ0ID0gbWFwLT5zdGFydCAqIEFNREdQVV9HUFVfUEFHRV9TSVpFOworCWVuZCA9ICht
YXAtPmxhc3QgKyAxKSAqIEFNREdQVV9HUFVfUEFHRV9TSVpFOworCWlmIChhZGRyICYgMHg3KSB7
CisJCURSTV9FUlJPUigiVkNOIG1lc3NhZ2VzIG11c3QgYmUgOCBieXRlIGFsaWduZWQhXG4iKTsK
KwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJYm8tPmZsYWdzIHw9IEFNREdQVV9HRU1fQ1JFQVRF
X0NQVV9BQ0NFU1NfUkVRVUlSRUQ7CisJYW1kZ3B1X2JvX3BsYWNlbWVudF9mcm9tX2RvbWFpbihi
bywgYm8tPmFsbG93ZWRfZG9tYWlucyk7CisJciA9IHR0bV9ib192YWxpZGF0ZSgmYm8tPnRibywg
JmJvLT5wbGFjZW1lbnQsICZjdHgpOworCWlmIChyKSB7CisJCURSTV9FUlJPUigiRmFpbGVkIHZh
bGlkYXRpbmcgdGhlIFZDTiBtZXNzYWdlIEJPICglZCkhXG4iLCByKTsKKwkJcmV0dXJuIHI7CisJ
fQorCisJciA9IGFtZGdwdV9ib19rbWFwKGJvLCAmcHRyKTsKKwlpZiAocikgeworCQlEUk1fRVJS
T1IoIkZhaWxlZCBtYXBwaW5nIHRoZSBWQ04gbWVzc2FnZSAoJWQpIVxuIiwgcik7CisJCXJldHVy
biByOworCX0KKworCW1zZyA9IHB0ciArIGFkZHIgLSBzdGFydDsKKworCS8qIENoZWNrIGxlbmd0
aCAqLworCWlmIChtc2dbMV0gPiBlbmQgLSBhZGRyKSB7CisJCXIgPSAtRUlOVkFMOworCQlnb3Rv
IG91dDsKKwl9CisKKwlpZiAobXNnWzNdICE9IFJERUNPREVfTVNHX0NSRUFURSkKKwkJZ290byBv
dXQ7CisKKwludW1fYnVmZmVycyA9IG1zZ1syXTsKKwlmb3IgKGkgPSAwLCBtc2cgPSAmbXNnWzZd
OyBpIDwgbnVtX2J1ZmZlcnM7ICsraSwgbXNnICs9IDQpIHsKKwkJdWludDMyX3Qgb2Zmc2V0LCBz
aXplLCAqY3JlYXRlOworCisJCWlmIChtc2dbMF0gIT0gUkRFQ09ERV9NRVNTQUdFX0NSRUFURSkK
KwkJCWNvbnRpbnVlOworCisJCW9mZnNldCA9IG1zZ1sxXTsKKwkJc2l6ZSA9IG1zZ1syXTsKKwor
CQlpZiAob2Zmc2V0ICsgc2l6ZSA+IGVuZCkgeworCQkJciA9IC1FSU5WQUw7CisJCQlnb3RvIG91
dDsKKwkJfQorCisJCWNyZWF0ZSA9IHB0ciArIGFkZHIgKyBvZmZzZXQgLSBzdGFydDsKKworCQkv
KiBIMjQ2LCBIRVZDIGFuZCBWUDkgY2FuIHJ1biBvbiBhbnkgaW5zdGFuY2UgKi8KKwkJaWYgKGNy
ZWF0ZVswXSA9PSAweDcgfHwgY3JlYXRlWzBdID09IDB4MTAgfHwgY3JlYXRlWzBdID09IDB4MTEp
CisJCQljb250aW51ZTsKKworCQlyID0gdmNuX3YzXzBfbGltaXRfc2NoZWQocCk7CisJCWlmIChy
KQorCQkJZ290byBvdXQ7CisJfQorCitvdXQ6CisJYW1kZ3B1X2JvX2t1bm1hcChibyk7CisJcmV0
dXJuIHI7Cit9CisKK3N0YXRpYyBpbnQgdmNuX3YzXzBfcmluZ19wYXRjaF9jc19pbl9wbGFjZShz
dHJ1Y3QgYW1kZ3B1X2NzX3BhcnNlciAqcCwKKwkJCQkJICAgdWludDMyX3QgaWJfaWR4KQorewor
CXN0cnVjdCBhbWRncHVfcmluZyAqcmluZyA9IHRvX2FtZGdwdV9yaW5nKHAtPmVudGl0eS0+cnEt
PnNjaGVkKTsKKwlzdHJ1Y3QgYW1kZ3B1X2liICppYiA9ICZwLT5qb2ItPmlic1tpYl9pZHhdOwor
CXVpbnQzMl90IG1zZ19sbyA9IDAsIG1zZ19oaSA9IDA7CisJdW5zaWduZWQgaTsKKwlpbnQgcjsK
KworCS8qIFRoZSBmaXJzdCBpbnN0YW5jZSBjYW4gZGVjb2RlIGFueXRoaW5nICovCisJaWYgKCFy
aW5nLT5tZSkKKwkJcmV0dXJuIDA7CisKKwlmb3IgKGkgPSAwOyBpIDwgaWItPmxlbmd0aF9kdzsg
aSArPSAyKSB7CisJCXVpbnQzMl90IHJlZyA9IGFtZGdwdV9nZXRfaWJfdmFsdWUocCwgaWJfaWR4
LCBpKTsKKwkJdWludDMyX3QgdmFsID0gYW1kZ3B1X2dldF9pYl92YWx1ZShwLCBpYl9pZHgsIGkg
KyAxKTsKKworCQlpZiAocmVnID09IFBBQ0tFVDAocC0+YWRldi0+dmNuLmludGVybmFsLmRhdGEw
LCAwKSkgeworCQkJbXNnX2xvID0gdmFsOworCQl9IGVsc2UgaWYgKHJlZyA9PSBQQUNLRVQwKHAt
PmFkZXYtPnZjbi5pbnRlcm5hbC5kYXRhMSwgMCkpIHsKKwkJCW1zZ19oaSA9IHZhbDsKKwkJfSBl
bHNlIGlmIChyZWcgPT0gUEFDS0VUMChwLT5hZGV2LT52Y24uaW50ZXJuYWwuY21kLCAwKSAmJgor
CQkJICAgdmFsID09IDApIHsKKwkJCXIgPSB2Y25fdjNfMF9kZWNfbXNnKHAsICgodTY0KW1zZ19o
aSkgPDwgMzIgfCBtc2dfbG8pOworCQkJaWYgKHIpCisJCQkJcmV0dXJuIHI7CisJCX0KKwl9CisJ
cmV0dXJuIDA7Cit9CisKIHN0YXRpYyBjb25zdCBzdHJ1Y3QgYW1kZ3B1X3JpbmdfZnVuY3MgdmNu
X3YzXzBfZGVjX3Jpbmdfdm1fZnVuY3MgPSB7CiAJLnR5cGUgPSBBTURHUFVfUklOR19UWVBFX1ZD
Tl9ERUMsCiAJLmFsaWduX21hc2sgPSAweGYsCkBAIC0xODMyLDYgKzE5NTksNyBAQCBzdGF0aWMg
Y29uc3Qgc3RydWN0IGFtZGdwdV9yaW5nX2Z1bmNzIHZjbl92M18wX2RlY19yaW5nX3ZtX2Z1bmNz
ID0gewogCS5nZXRfcnB0ciA9IHZjbl92M18wX2RlY19yaW5nX2dldF9ycHRyLAogCS5nZXRfd3B0
ciA9IHZjbl92M18wX2RlY19yaW5nX2dldF93cHRyLAogCS5zZXRfd3B0ciA9IHZjbl92M18wX2Rl
Y19yaW5nX3NldF93cHRyLAorCS5wYXRjaF9jc19pbl9wbGFjZSA9IHZjbl92M18wX3JpbmdfcGF0
Y2hfY3NfaW5fcGxhY2UsCiAJLmVtaXRfZnJhbWVfc2l6ZSA9CiAJCVNPQzE1X0ZMVVNIX0dQVV9U
TEJfTlVNX1dSRUcgKiA2ICsKIAkJU09DMTVfRkxVU0hfR1BVX1RMQl9OVU1fUkVHX1dBSVQgKiA4
ICsKLS0gCjIuMjUuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Au
b3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRl
dmVsCg==
