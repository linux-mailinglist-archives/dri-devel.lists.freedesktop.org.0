Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id BCBBF2C64A1
	for <lists+dri-devel@lfdr.de>; Fri, 27 Nov 2020 13:10:12 +0100 (CET)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A54BD6EC6C;
	Fri, 27 Nov 2020 12:09:02 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mga01.intel.com (mga01.intel.com [192.55.52.88])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A35566EC4E;
 Fri, 27 Nov 2020 12:08:43 +0000 (UTC)
IronPort-SDR: OaD6TQoWYVZsXHJuOaSfgNba3SlXWVF6AO7O5l/6D31QrkwoZBRGh8sO7eSTFLmDEJ67nw5dXV
 LEXUJblSD8Pg==
X-IronPort-AV: E=McAfee;i="6000,8403,9817"; a="190544005"
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="190544005"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from orsmga005.jf.intel.com ([10.7.209.41])
 by fmsmga101.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:08:43 -0800
IronPort-SDR: iXHaqWeXLshoMtI239MtvjP+WVcJTJvW1Fb0A7+7jpKx8790tEkWRQTnUY5t/u42oNLOT/DBUh
 WIGcczhg7XqQ==
X-IronPort-AV: E=Sophos;i="5.78,374,1599548400"; d="scan'208";a="548028787"
Received: from mjgleeso-mobl.ger.corp.intel.com (HELO
 mwauld-desk1.ger.corp.intel.com) ([10.251.85.2])
 by orsmga005-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 27 Nov 2020 04:08:41 -0800
From: Matthew Auld <matthew.auld@intel.com>
To: intel-gfx@lists.freedesktop.org
Subject: [RFC PATCH 042/162] drm/i915: Add igt_spinner_pin() to allow for ww
 locking around spinner.
Date: Fri, 27 Nov 2020 12:05:18 +0000
Message-Id: <20201127120718.454037-43-matthew.auld@intel.com>
X-Mailer: git-send-email 2.26.2
In-Reply-To: <20201127120718.454037-1-matthew.auld@intel.com>
References: <20201127120718.454037-1-matthew.auld@intel.com>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: dri-devel@lists.freedesktop.org,
 =?UTF-8?q?Thomas=20Hellstr=C3=B6m?= <thomas.hellstrom@linux.intel.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNv
bT4KCkJ5IGRlZmF1bHQsIHdlIGFzc3VtZSB0aGF0IGl0J3MgY2FsbGVkIGluc2lkZSBpZ3RfY3Jl
YXRlX3JlcXVlc3QKdG8ga2VlcCBleGlzdGluZyBzZWxmdGVzdHMgd29ya2luZywgYnV0IGFsbG93
IGZvciBtYW51YWwgcGlubmluZwp3aGVuIHBhc3NpbmcgYSB3dyBjb250ZXh0LgoKU2lnbmVkLW9m
Zi1ieTogTWFhcnRlbiBMYW5raG9yc3QgPG1hYXJ0ZW4ubGFua2hvcnN0QGxpbnV4LmludGVsLmNv
bT4KQ2M6IFRob21hcyBIZWxsc3Ryw7ZtIDx0aG9tYXMuaGVsbHN0cm9tQGxpbnV4LmludGVsLmNv
bT4KLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaWd0X3NwaW5uZXIuYyB8IDEz
NiArKysrKysrKysrKystLS0tLS0tCiBkcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaWd0
X3NwaW5uZXIuaCB8ICAgNSArCiAyIGZpbGVzIGNoYW5nZWQsIDk1IGluc2VydGlvbnMoKyksIDQ2
IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvZ3B1L2RybS9pOTE1L3NlbGZ0ZXN0
cy9pZ3Rfc3Bpbm5lci5jIGIvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2lndF9zcGlu
bmVyLmMKaW5kZXggZWMwZWNiNGU0Y2E2Li45YzQ2MWVkYjBiNzMgMTAwNjQ0Ci0tLSBhL2RyaXZl
cnMvZ3B1L2RybS9pOTE1L3NlbGZ0ZXN0cy9pZ3Rfc3Bpbm5lci5jCisrKyBiL2RyaXZlcnMvZ3B1
L2RybS9pOTE1L3NlbGZ0ZXN0cy9pZ3Rfc3Bpbm5lci5jCkBAIC0xMSw4ICsxMSw2IEBACiAKIGlu
dCBpZ3Rfc3Bpbm5lcl9pbml0KHN0cnVjdCBpZ3Rfc3Bpbm5lciAqc3Bpbiwgc3RydWN0IGludGVs
X2d0ICpndCkKIHsKLQl1bnNpZ25lZCBpbnQgbW9kZTsKLQl2b2lkICp2YWRkcjsKIAlpbnQgZXJy
OwogCiAJbWVtc2V0KHNwaW4sIDAsIHNpemVvZigqc3BpbikpOwpAQCAtMjMsNiArMjEsNyBAQCBp
bnQgaWd0X3NwaW5uZXJfaW5pdChzdHJ1Y3QgaWd0X3NwaW5uZXIgKnNwaW4sIHN0cnVjdCBpbnRl
bF9ndCAqZ3QpCiAJCWVyciA9IFBUUl9FUlIoc3Bpbi0+aHdzKTsKIAkJZ290byBlcnI7CiAJfQor
CWk5MTVfZ2VtX29iamVjdF9zZXRfY2FjaGVfY29oZXJlbmN5KHNwaW4tPmh3cywgSTkxNV9DQUNI
RV9MTEMpOwogCiAJc3Bpbi0+b2JqID0gaTkxNV9nZW1fb2JqZWN0X2NyZWF0ZV9pbnRlcm5hbChn
dC0+aTkxNSwgUEFHRV9TSVpFKTsKIAlpZiAoSVNfRVJSKHNwaW4tPm9iaikpIHsKQEAgLTMwLDM0
ICsyOSw4MyBAQCBpbnQgaWd0X3NwaW5uZXJfaW5pdChzdHJ1Y3QgaWd0X3NwaW5uZXIgKnNwaW4s
IHN0cnVjdCBpbnRlbF9ndCAqZ3QpCiAJCWdvdG8gZXJyX2h3czsKIAl9CiAKLQlpOTE1X2dlbV9v
YmplY3Rfc2V0X2NhY2hlX2NvaGVyZW5jeShzcGluLT5od3MsIEk5MTVfQ0FDSEVfTExDKTsKLQl2
YWRkciA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFwKHNwaW4tPmh3cywgSTkxNV9NQVBfV0IpOwot
CWlmIChJU19FUlIodmFkZHIpKSB7Ci0JCWVyciA9IFBUUl9FUlIodmFkZHIpOwotCQlnb3RvIGVy
cl9vYmo7Ci0JfQotCXNwaW4tPnNlcW5vID0gbWVtc2V0KHZhZGRyLCAweGZmLCBQQUdFX1NJWkUp
OwotCi0JbW9kZSA9IGk5MTVfY29oZXJlbnRfbWFwX3R5cGUoZ3QtPmk5MTUpOwotCXZhZGRyID0g
aTkxNV9nZW1fb2JqZWN0X3Bpbl9tYXAoc3Bpbi0+b2JqLCBtb2RlKTsKLQlpZiAoSVNfRVJSKHZh
ZGRyKSkgewotCQllcnIgPSBQVFJfRVJSKHZhZGRyKTsKLQkJZ290byBlcnJfdW5waW5faHdzOwot
CX0KLQlzcGluLT5iYXRjaCA9IHZhZGRyOwotCiAJcmV0dXJuIDA7CiAKLWVycl91bnBpbl9od3M6
Ci0JaTkxNV9nZW1fb2JqZWN0X3VucGluX21hcChzcGluLT5od3MpOwotZXJyX29iajoKLQlpOTE1
X2dlbV9vYmplY3RfcHV0KHNwaW4tPm9iaik7CiBlcnJfaHdzOgogCWk5MTVfZ2VtX29iamVjdF9w
dXQoc3Bpbi0+aHdzKTsKIGVycjoKIAlyZXR1cm4gZXJyOwogfQogCitzdGF0aWMgdm9pZCAqaWd0
X3NwaW5uZXJfcGluX29iaihzdHJ1Y3QgaW50ZWxfY29udGV4dCAqY2UsCisJCQkJIHN0cnVjdCBp
OTE1X2dlbV93d19jdHggKnd3LAorCQkJCSBzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2Jq
LAorCQkJCSB1bnNpZ25lZCBpbnQgbW9kZSwgc3RydWN0IGk5MTVfdm1hICoqdm1hKQoreworCXZv
aWQgKnZhZGRyOworCWludCByZXQ7CisKKwkqdm1hID0gaTkxNV92bWFfaW5zdGFuY2Uob2JqLCBj
ZS0+dm0sIE5VTEwpOworCWlmIChJU19FUlIoKnZtYSkpCisJCXJldHVybiBFUlJfQ0FTVCgqdm1h
KTsKKworCXJldCA9IGk5MTVfZ2VtX29iamVjdF9sb2NrKG9iaiwgd3cpOworCWlmIChyZXQpCisJ
CXJldHVybiBFUlJfUFRSKHJldCk7CisKKwl2YWRkciA9IGk5MTVfZ2VtX29iamVjdF9waW5fbWFw
KG9iaiwgbW9kZSk7CisKKwlpZiAoIXd3KQorCQlpOTE1X2dlbV9vYmplY3RfdW5sb2NrKG9iaik7
CisKKwlpZiAoSVNfRVJSKHZhZGRyKSkKKwkJcmV0dXJuIHZhZGRyOworCisJaWYgKHd3KQorCQly
ZXQgPSBpOTE1X3ZtYV9waW5fd3coKnZtYSwgd3csIDAsIDAsIFBJTl9VU0VSKTsKKwllbHNlCisJ
CXJldCA9IGk5MTVfdm1hX3Bpbigqdm1hLCAwLCAwLCBQSU5fVVNFUik7CisKKwlpZiAocmV0KSB7
CisJCWk5MTVfZ2VtX29iamVjdF91bnBpbl9tYXAob2JqKTsKKwkJcmV0dXJuIEVSUl9QVFIocmV0
KTsKKwl9CisKKwlyZXR1cm4gdmFkZHI7Cit9CisKK2ludCBpZ3Rfc3Bpbm5lcl9waW4oc3RydWN0
IGlndF9zcGlubmVyICpzcGluLAorCQkgICAgc3RydWN0IGludGVsX2NvbnRleHQgKmNlLAorCQkg
ICAgc3RydWN0IGk5MTVfZ2VtX3d3X2N0eCAqd3cpCit7CisJdm9pZCAqdmFkZHI7CisKKwlpZiAo
c3Bpbi0+Y2UgJiYgV0FSTl9PTihzcGluLT5jZSAhPSBjZSkpCisJCXJldHVybiAtRU5PREVWOwor
CXNwaW4tPmNlID0gY2U7CisKKwlpZiAoIXNwaW4tPnNlcW5vKSB7CisJCXZhZGRyID0gaWd0X3Nw
aW5uZXJfcGluX29iaihjZSwgd3csIHNwaW4tPmh3cywgSTkxNV9NQVBfV0IsICZzcGluLT5od3Nf
dm1hKTsKKwkJaWYgKElTX0VSUih2YWRkcikpCisJCQlyZXR1cm4gUFRSX0VSUih2YWRkcik7CisK
KwkJc3Bpbi0+c2Vxbm8gPSBtZW1zZXQodmFkZHIsIDB4ZmYsIFBBR0VfU0laRSk7CisJfQorCisJ
aWYgKCFzcGluLT5iYXRjaCkgeworCQl1bnNpZ25lZCBpbnQgbW9kZSA9CisJCQlpOTE1X2NvaGVy
ZW50X21hcF90eXBlKHNwaW4tPmd0LT5pOTE1KTsKKworCQl2YWRkciA9IGlndF9zcGlubmVyX3Bp
bl9vYmooY2UsIHd3LCBzcGluLT5vYmosIG1vZGUsICZzcGluLT5iYXRjaF92bWEpOworCQlpZiAo
SVNfRVJSKHZhZGRyKSkKKwkJCXJldHVybiBQVFJfRVJSKHZhZGRyKTsKKworCQlzcGluLT5iYXRj
aCA9IHZhZGRyOworCX0KKworCXJldHVybiAwOworfQorCiBzdGF0aWMgdW5zaWduZWQgaW50IHNl
cW5vX29mZnNldCh1NjQgZmVuY2UpCiB7CiAJcmV0dXJuIG9mZnNldF9pbl9wYWdlKHNpemVvZih1
MzIpICogZmVuY2UpOwpAQCAtMTAyLDI3ICsxNTAsMTggQEAgaWd0X3NwaW5uZXJfY3JlYXRlX3Jl
cXVlc3Qoc3RydWN0IGlndF9zcGlubmVyICpzcGluLAogCWlmICghaW50ZWxfZW5naW5lX2Nhbl9z
dG9yZV9kd29yZChjZS0+ZW5naW5lKSkKIAkJcmV0dXJuIEVSUl9QVFIoLUVOT0RFVik7CiAKLQl2
bWEgPSBpOTE1X3ZtYV9pbnN0YW5jZShzcGluLT5vYmosIGNlLT52bSwgTlVMTCk7Ci0JaWYgKElT
X0VSUih2bWEpKQotCQlyZXR1cm4gRVJSX0NBU1Qodm1hKTsKLQotCWh3cyA9IGk5MTVfdm1hX2lu
c3RhbmNlKHNwaW4tPmh3cywgY2UtPnZtLCBOVUxMKTsKLQlpZiAoSVNfRVJSKGh3cykpCi0JCXJl
dHVybiBFUlJfQ0FTVChod3MpOworCWlmICghc3Bpbi0+YmF0Y2gpIHsKKwkJZXJyID0gaWd0X3Nw
aW5uZXJfcGluKHNwaW4sIGNlLCBOVUxMKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBFUlJfUFRS
KGVycik7CisJfQogCi0JZXJyID0gaTkxNV92bWFfcGluKHZtYSwgMCwgMCwgUElOX1VTRVIpOwot
CWlmIChlcnIpCi0JCXJldHVybiBFUlJfUFRSKGVycik7Ci0KLQllcnIgPSBpOTE1X3ZtYV9waW4o
aHdzLCAwLCAwLCBQSU5fVVNFUik7Ci0JaWYgKGVycikKLQkJZ290byB1bnBpbl92bWE7CisJaHdz
ID0gc3Bpbi0+aHdzX3ZtYTsKKwl2bWEgPSBzcGluLT5iYXRjaF92bWE7CiAKIAlycSA9IGludGVs
X2NvbnRleHRfY3JlYXRlX3JlcXVlc3QoY2UpOwotCWlmIChJU19FUlIocnEpKSB7Ci0JCWVyciA9
IFBUUl9FUlIocnEpOwotCQlnb3RvIHVucGluX2h3czsKLQl9CisJaWYgKElTX0VSUihycSkpCisJ
CXJldHVybiBFUlJfQ0FTVChycSk7CiAKIAllcnIgPSBtb3ZlX3RvX2FjdGl2ZSh2bWEsIHJxLCAw
KTsKIAlpZiAoZXJyKQpAQCAtMTg1LDEwICsyMjQsNiBAQCBpZ3Rfc3Bpbm5lcl9jcmVhdGVfcmVx
dWVzdChzdHJ1Y3QgaWd0X3NwaW5uZXIgKnNwaW4sCiAJCWk5MTVfcmVxdWVzdF9zZXRfZXJyb3Jf
b25jZShycSwgZXJyKTsKIAkJaTkxNV9yZXF1ZXN0X2FkZChycSk7CiAJfQotdW5waW5faHdzOgot
CWk5MTVfdm1hX3VucGluKGh3cyk7Ci11bnBpbl92bWE6Ci0JaTkxNV92bWFfdW5waW4odm1hKTsK
IAlyZXR1cm4gZXJyID8gRVJSX1BUUihlcnIpIDogcnE7CiB9CiAKQEAgLTIwMiw2ICsyMzcsOSBA
QCBod3Nfc2Vxbm8oY29uc3Qgc3RydWN0IGlndF9zcGlubmVyICpzcGluLCBjb25zdCBzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICpycSkKIAogdm9pZCBpZ3Rfc3Bpbm5lcl9lbmQoc3RydWN0IGlndF9zcGlu
bmVyICpzcGluKQogeworCWlmICghc3Bpbi0+YmF0Y2gpCisJCXJldHVybjsKKwogCSpzcGluLT5i
YXRjaCA9IE1JX0JBVENIX0JVRkZFUl9FTkQ7CiAJaW50ZWxfZ3RfY2hpcHNldF9mbHVzaChzcGlu
LT5ndCk7CiB9CkBAIC0yMTAsMTAgKzI0OCwxNiBAQCB2b2lkIGlndF9zcGlubmVyX2Zpbmkoc3Ry
dWN0IGlndF9zcGlubmVyICpzcGluKQogewogCWlndF9zcGlubmVyX2VuZChzcGluKTsKIAotCWk5
MTVfZ2VtX29iamVjdF91bnBpbl9tYXAoc3Bpbi0+b2JqKTsKKwlpZiAoc3Bpbi0+YmF0Y2gpIHsK
KwkJaTkxNV92bWFfdW5waW4oc3Bpbi0+YmF0Y2hfdm1hKTsKKwkJaTkxNV9nZW1fb2JqZWN0X3Vu
cGluX21hcChzcGluLT5vYmopOworCX0KIAlpOTE1X2dlbV9vYmplY3RfcHV0KHNwaW4tPm9iaik7
CiAKLQlpOTE1X2dlbV9vYmplY3RfdW5waW5fbWFwKHNwaW4tPmh3cyk7CisJaWYgKHNwaW4tPnNl
cW5vKSB7CisJCWk5MTVfdm1hX3VucGluKHNwaW4tPmh3c192bWEpOworCQlpOTE1X2dlbV9vYmpl
Y3RfdW5waW5fbWFwKHNwaW4tPmh3cyk7CisJfQogCWk5MTVfZ2VtX29iamVjdF9wdXQoc3Bpbi0+
aHdzKTsKIH0KIApkaWZmIC0tZ2l0IGEvZHJpdmVycy9ncHUvZHJtL2k5MTUvc2VsZnRlc3RzL2ln
dF9zcGlubmVyLmggYi9kcml2ZXJzL2dwdS9kcm0vaTkxNS9zZWxmdGVzdHMvaWd0X3NwaW5uZXIu
aAppbmRleCBlYzYyYzllZjMyMGIuLmZiZTViMTYyNWIwNSAxMDA2NDQKLS0tIGEvZHJpdmVycy9n
cHUvZHJtL2k5MTUvc2VsZnRlc3RzL2lndF9zcGlubmVyLmgKKysrIGIvZHJpdmVycy9ncHUvZHJt
L2k5MTUvc2VsZnRlc3RzL2lndF9zcGlubmVyLmgKQEAgLTIwLDExICsyMCwxNiBAQCBzdHJ1Y3Qg
aWd0X3NwaW5uZXIgewogCXN0cnVjdCBpbnRlbF9ndCAqZ3Q7CiAJc3RydWN0IGRybV9pOTE1X2dl
bV9vYmplY3QgKmh3czsKIAlzdHJ1Y3QgZHJtX2k5MTVfZ2VtX29iamVjdCAqb2JqOworCXN0cnVj
dCBpbnRlbF9jb250ZXh0ICpjZTsKKwlzdHJ1Y3QgaTkxNV92bWEgKmh3c192bWEsICpiYXRjaF92
bWE7CiAJdTMyICpiYXRjaDsKIAl2b2lkICpzZXFubzsKIH07CiAKIGludCBpZ3Rfc3Bpbm5lcl9p
bml0KHN0cnVjdCBpZ3Rfc3Bpbm5lciAqc3Bpbiwgc3RydWN0IGludGVsX2d0ICpndCk7CitpbnQg
aWd0X3NwaW5uZXJfcGluKHN0cnVjdCBpZ3Rfc3Bpbm5lciAqc3BpbiwKKwkJICAgIHN0cnVjdCBp
bnRlbF9jb250ZXh0ICpjZSwKKwkJICAgIHN0cnVjdCBpOTE1X2dlbV93d19jdHggKnd3KTsKIHZv
aWQgaWd0X3NwaW5uZXJfZmluaShzdHJ1Y3QgaWd0X3NwaW5uZXIgKnNwaW4pOwogCiBzdHJ1Y3Qg
aTkxNV9yZXF1ZXN0ICoKLS0gCjIuMjYuMgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vZHJpLWRldmVsCg==
