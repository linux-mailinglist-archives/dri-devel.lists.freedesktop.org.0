Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 1471D290E7D
	for <lists+dri-devel@lfdr.de>; Sat, 17 Oct 2020 03:33:24 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 048F26E30C;
	Sat, 17 Oct 2020 01:33:19 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-pl1-x644.google.com (mail-pl1-x644.google.com
 [IPv6:2607:f8b0:4864:20::644])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 985756E30C
 for <dri-devel@lists.freedesktop.org>; Sat, 17 Oct 2020 01:33:17 +0000 (UTC)
Received: by mail-pl1-x644.google.com with SMTP id y1so2171337plp.6
 for <dri-devel@lists.freedesktop.org>; Fri, 16 Oct 2020 18:33:17 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=6oHXHsrLfgpTNXoI1E5O96yDTjCsZQKa/PUoP1mStQ0=;
 b=cUiPeL3FFnLfOGlkp+FRVgZGoW9QTOselzAKWpxe0hC2UMDNCugE7dcBYBPuq8r80A
 iXE2K4jr7y345HhFFjYSI5NVr8bW0iDtBqvVvsfwdWgwASNxNmxRXzMMHC5axuwAB9G9
 FYsFWP02nI5ns8rTbxaurL7mCxgAlR6fEBzS69L7h3Kvm70d8MVxRLZaL8wophkH21A1
 rUEbPBdOvilpjUCyxMXG4UbvMWmP1Z10tfq5yoOVngbdRnuPkuHJ0V0j2AeHHni7bvtb
 9VBhpHQqZOJCeC6q+b1M1Njkr3Zf78Xf0Z5R9jQeqxNdfGc6JxK5X9YHi8TVoAnZSi4r
 BfaA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=6oHXHsrLfgpTNXoI1E5O96yDTjCsZQKa/PUoP1mStQ0=;
 b=M+HmSy4EWLM/r0lIh/Rw1hTdh0fddYZAQDAC6n7c+zq6jOdBhxsohYtXCoijAXodyS
 +6qrJGKWOcwdUTpflfv37NPYKuPjNpUAV2G5/fi62j0DyjIhE4YeWqpV+DFIR68q6cyg
 TzStrDODbfHMBc4eCJ+hvWizv8+haETidIm3zRe/E1PctE1SBXK71tNuq0xRqRXRXmn5
 Wx3VyvbENXwT/9PzmakNOdxGzbFfakRt2tUeI5K+xKikYMos6rzHZKAOm0nNyZktKyNS
 cGr/VLBjXF7f5lRzq04/rPFNYbU8rEGUW5OcpDXvEyUcZhXe2CznyRt9MtSSngVbrCgb
 xbKA==
X-Gm-Message-State: AOAM5307lGMesJhZspdJGb8Y9o4TVc9V7yzY4TtjItvJx+qMXeShhhGn
 sAxKL99FuQNEjWkJRBrL2k2K7w==
X-Google-Smtp-Source: ABdhPJwXUMDQW5DbNK8+xbjk7S3Noz5N4La1PstaIPJE8mBaqUIjrh3Ki4Q90tk0FCMQx44QPDa2QA==
X-Received: by 2002:a17:90a:d3d5:: with SMTP id
 d21mr6636885pjw.168.1602898397098; 
 Fri, 16 Oct 2020 18:33:17 -0700 (PDT)
Received: from localhost.localdomain ([2601:1c2:680:1319:692:26ff:feda:3a81])
 by smtp.gmail.com with ESMTPSA id
 e186sm4222122pfh.60.2020.10.16.18.33.14
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Fri, 16 Oct 2020 18:33:16 -0700 (PDT)
From: John Stultz <john.stultz@linaro.org>
To: lkml <linux-kernel@vger.kernel.org>
Subject: [PATCH v4 7/7] dma-buf: system_heap: Add a system-uncached heap
 re-using the system heap
Date: Sat, 17 Oct 2020 01:32:55 +0000
Message-Id: <20201017013255.43568-8-john.stultz@linaro.org>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20201017013255.43568-1-john.stultz@linaro.org>
References: <20201017013255.43568-1-john.stultz@linaro.org>
MIME-Version: 1.0
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Sandeep Patil <sspatil@google.com>, dri-devel@lists.freedesktop.org,
 Ezequiel Garcia <ezequiel@collabora.com>, Robin Murphy <robin.murphy@arm.com>,
 James Jones <jajones@nvidia.com>, Liam Mark <lmark@codeaurora.org>,
 Laura Abbott <labbott@kernel.org>, Chris Goldsworthy <cgoldswo@codeaurora.org>,
 Hridya Valsaraju <hridya@google.com>,
 =?UTF-8?q?=C3=98rjan=20Eide?= <orjan.eide@arm.com>,
 linux-media@vger.kernel.org, Suren Baghdasaryan <surenb@google.com>,
 Daniel Mentz <danielmentz@google.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

VGhpcyBhZGRzIGEgaGVhcCB0aGF0IGFsbG9jYXRlcyBub24tY29udGlndW91cyBidWZmZXJzIHRo
YXQgYXJlCm1hcmtlZCBhcyB3cml0ZWNvbWJpbmVkLCBzbyB0aGV5IGFyZSBub3QgY2FjaGVkIGJ5
IHRoZSBDUFUuCgpUaGlzIGlzIHVzZWZ1bCwgYXMgbW9zdCBncmFwaGljcyBidWZmZXJzIGFyZSB1
c3VhbGx5IG5vdCB0b3VjaGVkCmJ5IHRoZSBDUFUgb3Igb25seSB3cml0dGVuIGludG8gb25jZSBi
eSB0aGUgQ1BVLiBTbyB3aGVuIG1hcHBpbmcKdGhlIGJ1ZmZlciBvdmVyIGFuZCBvdmVyIGJldHdl
ZW4gZGV2aWNlcywgd2UgY2FuIHNraXAgdGhlIENQVQpzeW5jaW5nLCB3aGljaCBzYXZlcyBhIGxv
dCBvZiBjYWNoZSBtYW5hZ2VtZW50IG92ZXJoZWFkLCBncmVhdGx5CmltcHJvdmluZyBwZXJmb3Jt
YW5jZS4KCkZvciBmb2xrIHVzaW5nIElPTiwgdGhlcmUgd2FzIGEgSU9OX0ZMQUdfQ0FDSEVEIGZs
YWcsIHdoaWNoCnNpZ25hbGVkIGlmIHRoZSByZXR1cm5lZCBidWZmZXIgc2hvdWxkIGJlIENQVSBj
YWNoZWFibGUgb3Igbm90LgpXaXRoIERNQS1CVUYgaGVhcHMsIHdlIGRvIG5vdCB5ZXQgaGF2ZSBz
dWNoIGEgZmxhZywgYW5kIGJ5IGRlZmF1bHQKdGhlIGN1cnJlbnQgaGVhcHMgKHN5c3RlbSBhbmQg
Y21hKSBwcm9kdWNlIENQVSBjYWNoYWJsZSBidWZmZXJzLgpTbyBmb3IgZm9sa3MgdHJhbnNpdGlv
bmluZyBmcm9tIElPTiB0byBETUEtQlVGIEhlYXBzLCB0aGlzIGZpbGxzCmluIHNvbWUgb2YgdGhh
dCBtaXNzaW5nIGZ1bmN0aW9uYWxpdHkuCgpUaGVyZSBoYXMgYmVlbiBhIHN1Z2dlc3Rpb24gdG8g
bWFrZSB0aGlzIGZ1bmN0aW9uYWxpdHkgYSBmbGFnCihETUFIRUFQX0ZMQUdfVU5DQUNIRUQ/KSBv
biB0aGUgc3lzdGVtIGhlYXAsIHNpbWlsYXIgdG8gaG93CklPTiB1c2VkIHRoZSBJT05fRkxBR19D
QUNIRUQuIEJ1dCBJIHdhbnQgdG8gbWFrZSBzdXJlIGFuCl9VTkNBQ0hFRCBmbGFnIHdvdWxkIHRy
dWVseSBiZSBhIGdlbmVyaWMgYXR0cmlidXRlIGFjcm9zcyBhbGwKaGVhcHMuIFNvIGZhciB0aGF0
IGhhcyBiZWVuIHVuY2xlYXIsIHNvIGhhdmluZyBpdCBhcyBhIHNlcGFyYXRlCmhlYXAgc2VlbWVz
IGJldHRlciBmb3Igbm93LiAoQnV0IEknbSBvcGVuIHRvIGRpc2N1c3Npb24gb24gdGhpcwpwb2lu
dCEpCgpUaGlzIGlzIGEgcmV3b3JrIG9mIGVhcmxpZXIgZWZmb3J0cyB0byBhZGQgYSB1bmNhY2hl
ZCBzeXN0ZW0gaGVhcCwKZG9uZSB1dGlsaXppbmcgdGhlIGV4aXNpdG5nIHN5c3RlbSBoZWFwLCBh
ZGRpbmcganVzdCBhIGJpdCBvZgpsb2dpYyB0byBoYW5kbGUgdGhlIHVuY2FjaGVkIGNhc2UuCgpG
ZWVkYmFjayB3b3VsZCBiZSB2ZXJ5IHdlbGNvbWUhCgpNYW55IHRoYW5rcyB0byBMaWFtIE1hcmsg
Zm9yIGhpcyBoZWxwIHRvIGdldCB0aGlzIHdvcmtpbmcuCgpQZW5kaW5nIG9wZW5zb3VyY2UgdXNl
cnMgb2YgdGhpcyBjb2RlIGluY2x1ZGU6CiogQU9TUCBIaUtleTk2MCBncmFsbG9jOgogIC0gaHR0
cHM6Ly9hbmRyb2lkLXJldmlldy5nb29nbGVzb3VyY2UuY29tL2MvZGV2aWNlL2xpbmFyby9oaWtl
eS8rLzEzOTk1MTkKICAtIFZpc2libHkgaW1wcm92ZXMgcGVyZm9ybWFuY2Ugb3ZlciB0aGUgc3lz
dGVtIGhlYXAKKiBBT1NQIENvZGVjMiAocG9zc2libHksIG5lZWRzIG1vcmUgcmV2aWV3KToKICAt
IGh0dHBzOi8vYW5kcm9pZC1yZXZpZXcuZ29vZ2xlc291cmNlLmNvbS9jL3BsYXRmb3JtL2ZyYW1l
d29ya3MvYXYvKy8xMzYwNjQwLzE3L21lZGlhL2NvZGVjMi92bmRrL0MyRG1hQnVmQWxsb2NhdG9y
LmNwcCMzMjUKCkNjOiBTdW1pdCBTZW13YWwgPHN1bWl0LnNlbXdhbEBsaW5hcm8ub3JnPgpDYzog
TGlhbSBNYXJrIDxsbWFya0Bjb2RlYXVyb3JhLm9yZz4KQ2M6IExhdXJhIEFiYm90dCA8bGFiYm90
dEBrZXJuZWwub3JnPgpDYzogQnJpYW4gU3RhcmtleSA8QnJpYW4uU3RhcmtleUBhcm0uY29tPgpD
YzogSHJpZHlhIFZhbHNhcmFqdSA8aHJpZHlhQGdvb2dsZS5jb20+CkNjOiBTdXJlbiBCYWdoZGFz
YXJ5YW4gPHN1cmVuYkBnb29nbGUuY29tPgpDYzogU2FuZGVlcCBQYXRpbCA8c3NwYXRpbEBnb29n
bGUuY29tPgpDYzogRGFuaWVsIE1lbnR6IDxkYW5pZWxtZW50ekBnb29nbGUuY29tPgpDYzogQ2hy
aXMgR29sZHN3b3J0aHkgPGNnb2xkc3dvQGNvZGVhdXJvcmEub3JnPgpDYzogw5hyamFuIEVpZGUg
PG9yamFuLmVpZGVAYXJtLmNvbT4KQ2M6IFJvYmluIE11cnBoeSA8cm9iaW4ubXVycGh5QGFybS5j
b20+CkNjOiBFemVxdWllbCBHYXJjaWEgPGV6ZXF1aWVsQGNvbGxhYm9yYS5jb20+CkNjOiBTaW1v
biBTZXIgPGNvbnRhY3RAZW1lcnNpb24uZnI+CkNjOiBKYW1lcyBKb25lcyA8amFqb25lc0Budmlk
aWEuY29tPgpDYzogbGludXgtbWVkaWFAdmdlci5rZXJuZWwub3JnCkNjOiBkcmktZGV2ZWxAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnClNpZ25lZC1vZmYtYnk6IEpvaG4gU3R1bHR6IDxqb2huLnN0dWx0
ekBsaW5hcm8ub3JnPgotLS0KdjQ6CiogTWFrZSBzeXNfdW5jYWNoZWRfaGVhcCBzdGF0aWMsIGFz
CiAgICBSZXBvcnRlZC1ieToga2VybmVsIHRlc3Qgcm9ib3QgPGxrcEBpbnRlbC5jb20+CiogRml4
IHdyb25nIHJldHVybiB2YWx1ZSwgY2F1Z2h0IGJ5IHNtYXRjaAogICAgUmVwb3J0ZWQtYnk6IGtl
cm5lbCB0ZXN0IHJvYm90IDxsa3BAaW50ZWwuY29tPgogICAgUmVwb3J0ZWQtYnk6IERhbiBDYXJw
ZW50ZXIgPGRhbi5jYXJwZW50ZXJAb3JhY2xlLmNvbT4KKiBFbnN1cmUgd2UgY2FsbCBmbHVzaC9p
bnZhbGlkYXRlX2tlcm5lbF92bWFwX3JhbmdlKCkgaW4gdGhlCiAgdW5jYWNoZWQgY2FzZXMgdG8g
dHJ5IHRvIGFkZHJlc3MgZmVlZGJhY2sgYWJvdXQgVklWVCBjYWNoZXMKICBmcm9tIENocmlzdG9w
aAoqIFJlb3JkZXIgYSBmZXcgbGluZXMgYXMgc3VnZ2VzdGVkIGJ5IEJyaWFuUwoqIEF2b2lkIGhv
bGRpbmcgdGhlIGluaXRpYWwgbWFwcGluZyBmb3IgdGhlIGxpZmV0aW1lIG9mIHRoZSBidWZmZXIK
ICBhcyBzdWdnZXN0ZWQgYnkgQnJpYW5TCiogRml4IGEgdW5saWtlbHkgcmFjZSBiZXR3ZWVuIGFs
bG9jYXRlIGFuZCB1cGRhdGluZyB0aGUgZG1hX21hc2sKICB0aGF0IEJyaWFuUyBub3RpY2VkLgot
LS0KIGRyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9zeXN0ZW1faGVhcC5jIHwgMTExICsrKysrKysrKysr
KysrKysrKysrKysrKy0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA5NSBpbnNlcnRpb25zKCspLCAxNiBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9kcml2ZXJzL2RtYS1idWYvaGVhcHMvc3lzdGVtX2hl
YXAuYyBiL2RyaXZlcnMvZG1hLWJ1Zi9oZWFwcy9zeXN0ZW1faGVhcC5jCmluZGV4IGVmNGIyYzEw
MzJkZi4uYTMyOGM3NjI0OWQyIDEwMDY0NAotLS0gYS9kcml2ZXJzL2RtYS1idWYvaGVhcHMvc3lz
dGVtX2hlYXAuYworKysgYi9kcml2ZXJzL2RtYS1idWYvaGVhcHMvc3lzdGVtX2hlYXAuYwpAQCAt
MjIsNiArMjIsNyBAQAogI2luY2x1ZGUgPGxpbnV4L3ZtYWxsb2MuaD4KIAogc3RhdGljIHN0cnVj
dCBkbWFfaGVhcCAqc3lzX2hlYXA7CitzdGF0aWMgc3RydWN0IGRtYV9oZWFwICpzeXNfdW5jYWNo
ZWRfaGVhcDsKIAogc3RydWN0IHN5c3RlbV9oZWFwX2J1ZmZlciB7CiAJc3RydWN0IGRtYV9oZWFw
ICpoZWFwOwpAQCAtMzEsNiArMzIsOCBAQCBzdHJ1Y3Qgc3lzdGVtX2hlYXBfYnVmZmVyIHsKIAlz
dHJ1Y3Qgc2dfdGFibGUgc2dfdGFibGU7CiAJaW50IHZtYXBfY250OwogCXZvaWQgKnZhZGRyOwor
CisJYm9vbCB1bmNhY2hlZDsKIH07CiAKIHN0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50IHsKQEAg
LTM4LDYgKzQxLDggQEAgc3RydWN0IGRtYV9oZWFwX2F0dGFjaG1lbnQgewogCXN0cnVjdCBzZ190
YWJsZSAqdGFibGU7CiAJc3RydWN0IGxpc3RfaGVhZCBsaXN0OwogCWJvb2wgbWFwcGVkOworCisJ
Ym9vbCB1bmNhY2hlZDsKIH07CiAKICNkZWZpbmUgSElHSF9PUkRFUl9HRlAgICgoKEdGUF9ISUdI
VVNFUiB8IF9fR0ZQX1pFUk8gfCBfX0dGUF9OT1dBUk4gXApAQCAtOTQsNyArOTksNyBAQCBzdGF0
aWMgaW50IHN5c3RlbV9oZWFwX2F0dGFjaChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAogCWEtPmRl
diA9IGF0dGFjaG1lbnQtPmRldjsKIAlJTklUX0xJU1RfSEVBRCgmYS0+bGlzdCk7CiAJYS0+bWFw
cGVkID0gZmFsc2U7Ci0KKwlhLT51bmNhY2hlZCA9IGJ1ZmZlci0+dW5jYWNoZWQ7CiAJYXR0YWNo
bWVudC0+cHJpdiA9IGE7CiAKIAltdXRleF9sb2NrKCZidWZmZXItPmxvY2spOwpAQCAtMTI0LDkg
KzEyOSwxMyBAQCBzdGF0aWMgc3RydWN0IHNnX3RhYmxlICpzeXN0ZW1faGVhcF9tYXBfZG1hX2J1
ZihzdHJ1Y3QgZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhYwogewogCXN0cnVjdCBkbWFfaGVhcF9h
dHRhY2htZW50ICphID0gYXR0YWNobWVudC0+cHJpdjsKIAlzdHJ1Y3Qgc2dfdGFibGUgKnRhYmxl
ID0gYS0+dGFibGU7CisJaW50IGF0dHIgPSAwOwogCWludCByZXQ7CiAKLQlyZXQgPSBkbWFfbWFw
X3NndGFibGUoYXR0YWNobWVudC0+ZGV2LCB0YWJsZSwgZGlyZWN0aW9uLCAwKTsKKwlpZiAoYS0+
dW5jYWNoZWQpCisJCWF0dHIgPSBETUFfQVRUUl9TS0lQX0NQVV9TWU5DOworCisJcmV0ID0gZG1h
X21hcF9zZ3RhYmxlKGF0dGFjaG1lbnQtPmRldiwgdGFibGUsIGRpcmVjdGlvbiwgYXR0cik7CiAJ
aWYgKHJldCkKIAkJcmV0dXJuIEVSUl9QVFIocmV0KTsKIApAQCAtMTM5LDkgKzE0OCwxMiBAQCBz
dGF0aWMgdm9pZCBzeXN0ZW1faGVhcF91bm1hcF9kbWFfYnVmKHN0cnVjdCBkbWFfYnVmX2F0dGFj
aG1lbnQgKmF0dGFjaG1lbnQsCiAJCQkJICAgICAgZW51bSBkbWFfZGF0YV9kaXJlY3Rpb24gZGly
ZWN0aW9uKQogewogCXN0cnVjdCBkbWFfaGVhcF9hdHRhY2htZW50ICphID0gYXR0YWNobWVudC0+
cHJpdjsKKwlpbnQgYXR0ciA9IDA7CiAKKwlpZiAoYS0+dW5jYWNoZWQpCisJCWF0dHIgPSBETUFf
QVRUUl9TS0lQX0NQVV9TWU5DOwogCWEtPm1hcHBlZCA9IGZhbHNlOwotCWRtYV91bm1hcF9zZ3Rh
YmxlKGF0dGFjaG1lbnQtPmRldiwgdGFibGUsIGRpcmVjdGlvbiwgMCk7CisJZG1hX3VubWFwX3Nn
dGFibGUoYXR0YWNobWVudC0+ZGV2LCB0YWJsZSwgZGlyZWN0aW9uLCBhdHRyKTsKIH0KIAogc3Rh
dGljIGludCBzeXN0ZW1faGVhcF9kbWFfYnVmX2JlZ2luX2NwdV9hY2Nlc3Moc3RydWN0IGRtYV9i
dWYgKmRtYWJ1ZiwKQEAgLTE1NSwxMCArMTY3LDEyIEBAIHN0YXRpYyBpbnQgc3lzdGVtX2hlYXBf
ZG1hX2J1Zl9iZWdpbl9jcHVfYWNjZXNzKHN0cnVjdCBkbWFfYnVmICpkbWFidWYsCiAJaWYgKGJ1
ZmZlci0+dm1hcF9jbnQpCiAJCWludmFsaWRhdGVfa2VybmVsX3ZtYXBfcmFuZ2UoYnVmZmVyLT52
YWRkciwgYnVmZmVyLT5sZW4pOwogCi0JbGlzdF9mb3JfZWFjaF9lbnRyeShhLCAmYnVmZmVyLT5h
dHRhY2htZW50cywgbGlzdCkgewotCQlpZiAoIWEtPm1hcHBlZCkKLQkJCWNvbnRpbnVlOwotCQlk
bWFfc3luY19zZ3RhYmxlX2Zvcl9jcHUoYS0+ZGV2LCBhLT50YWJsZSwgZGlyZWN0aW9uKTsKKwlp
ZiAoIWJ1ZmZlci0+dW5jYWNoZWQpIHsKKwkJbGlzdF9mb3JfZWFjaF9lbnRyeShhLCAmYnVmZmVy
LT5hdHRhY2htZW50cywgbGlzdCkgeworCQkJaWYgKCFhLT5tYXBwZWQpCisJCQkJY29udGludWU7
CisJCQlkbWFfc3luY19zZ3RhYmxlX2Zvcl9jcHUoYS0+ZGV2LCBhLT50YWJsZSwgZGlyZWN0aW9u
KTsKKwkJfQogCX0KIAltdXRleF91bmxvY2soJmJ1ZmZlci0+bG9jayk7CiAKQEAgLTE3NiwxMCAr
MTkwLDEyIEBAIHN0YXRpYyBpbnQgc3lzdGVtX2hlYXBfZG1hX2J1Zl9lbmRfY3B1X2FjY2Vzcyhz
dHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAogCWlmIChidWZmZXItPnZtYXBfY250KQogCQlmbHVzaF9r
ZXJuZWxfdm1hcF9yYW5nZShidWZmZXItPnZhZGRyLCBidWZmZXItPmxlbik7CiAKLQlsaXN0X2Zv
cl9lYWNoX2VudHJ5KGEsICZidWZmZXItPmF0dGFjaG1lbnRzLCBsaXN0KSB7Ci0JCWlmICghYS0+
bWFwcGVkKQotCQkJY29udGludWU7Ci0JCWRtYV9zeW5jX3NndGFibGVfZm9yX2RldmljZShhLT5k
ZXYsIGEtPnRhYmxlLCBkaXJlY3Rpb24pOworCWlmICghYnVmZmVyLT51bmNhY2hlZCkgeworCQls
aXN0X2Zvcl9lYWNoX2VudHJ5KGEsICZidWZmZXItPmF0dGFjaG1lbnRzLCBsaXN0KSB7CisJCQlp
ZiAoIWEtPm1hcHBlZCkKKwkJCQljb250aW51ZTsKKwkJCWRtYV9zeW5jX3NndGFibGVfZm9yX2Rl
dmljZShhLT5kZXYsIGEtPnRhYmxlLCBkaXJlY3Rpb24pOworCQl9CiAJfQogCW11dGV4X3VubG9j
aygmYnVmZmVyLT5sb2NrKTsKIApAQCAtMTk0LDYgKzIxMCw5IEBAIHN0YXRpYyBpbnQgc3lzdGVt
X2hlYXBfbW1hcChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLCBzdHJ1Y3Qgdm1fYXJlYV9zdHJ1Y3Qg
KnZtYSkKIAlzdHJ1Y3Qgc2dfcGFnZV9pdGVyIHBpdGVyOwogCWludCByZXQ7CiAKKwlpZiAoYnVm
ZmVyLT51bmNhY2hlZCkKKwkJdm1hLT52bV9wYWdlX3Byb3QgPSBwZ3Byb3Rfd3JpdGVjb21iaW5l
KHZtYS0+dm1fcGFnZV9wcm90KTsKKwogCWZvcl9lYWNoX3NndGFibGVfcGFnZSh0YWJsZSwgJnBp
dGVyLCB2bWEtPnZtX3Bnb2ZmKSB7CiAJCXN0cnVjdCBwYWdlICpwYWdlID0gc2dfcGFnZV9pdGVy
X3BhZ2UoJnBpdGVyKTsKIApAQCAtMjE1LDE3ICsyMzQsMjEgQEAgc3RhdGljIHZvaWQgKnN5c3Rl
bV9oZWFwX2RvX3ZtYXAoc3RydWN0IHN5c3RlbV9oZWFwX2J1ZmZlciAqYnVmZmVyKQogCXN0cnVj
dCBwYWdlICoqcGFnZXMgPSB2bWFsbG9jKHNpemVvZihzdHJ1Y3QgcGFnZSAqKSAqIG5wYWdlcyk7
CiAJc3RydWN0IHBhZ2UgKip0bXAgPSBwYWdlczsKIAlzdHJ1Y3Qgc2dfcGFnZV9pdGVyIHBpdGVy
OworCXBncHJvdF90IHBncHJvdCA9IFBBR0VfS0VSTkVMOwogCXZvaWQgKnZhZGRyOwogCiAJaWYg
KCFwYWdlcykKIAkJcmV0dXJuIEVSUl9QVFIoLUVOT01FTSk7CiAKKwlpZiAoYnVmZmVyLT51bmNh
Y2hlZCkKKwkJcGdwcm90ID0gcGdwcm90X3dyaXRlY29tYmluZShQQUdFX0tFUk5FTCk7CisKIAlm
b3JfZWFjaF9zZ3RhYmxlX3BhZ2UodGFibGUsICZwaXRlciwgMCkgewogCQlXQVJOX09OKHRtcCAt
IHBhZ2VzID49IG5wYWdlcyk7CiAJCSp0bXArKyA9IHNnX3BhZ2VfaXRlcl9wYWdlKCZwaXRlcik7
CiAJfQogCi0JdmFkZHIgPSB2bWFwKHBhZ2VzLCBucGFnZXMsIFZNX01BUCwgUEFHRV9LRVJORUwp
OworCXZhZGRyID0gdm1hcChwYWdlcywgbnBhZ2VzLCBWTV9NQVAsIHBncHJvdCk7CiAJdmZyZWUo
cGFnZXMpOwogCiAJaWYgKCF2YWRkcikKQEAgLTMyMCwxMCArMzQzLDExIEBAIHN0YXRpYyBzdHJ1
Y3QgcGFnZSAqYWxsb2NfbGFyZ2VzdF9hdmFpbGFibGUodW5zaWduZWQgbG9uZyBzaXplLAogCXJl
dHVybiBOVUxMOwogfQogCi1zdGF0aWMgaW50IHN5c3RlbV9oZWFwX2FsbG9jYXRlKHN0cnVjdCBk
bWFfaGVhcCAqaGVhcCwKLQkJCQl1bnNpZ25lZCBsb25nIGxlbiwKLQkJCQl1bnNpZ25lZCBsb25n
IGZkX2ZsYWdzLAotCQkJCXVuc2lnbmVkIGxvbmcgaGVhcF9mbGFncykKK3N0YXRpYyBpbnQgc3lz
dGVtX2hlYXBfZG9fYWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAorCQkJCSAgIHVuc2ln
bmVkIGxvbmcgbGVuLAorCQkJCSAgIHVuc2lnbmVkIGxvbmcgZmRfZmxhZ3MsCisJCQkJICAgdW5z
aWduZWQgbG9uZyBoZWFwX2ZsYWdzLAorCQkJCSAgIGJvb2wgdW5jYWNoZWQpCiB7CiAJc3RydWN0
IHN5c3RlbV9oZWFwX2J1ZmZlciAqYnVmZmVyOwogCURFRklORV9ETUFfQlVGX0VYUE9SVF9JTkZP
KGV4cF9pbmZvKTsKQEAgLTM0NCw2ICszNjgsNyBAQCBzdGF0aWMgaW50IHN5c3RlbV9oZWFwX2Fs
bG9jYXRlKHN0cnVjdCBkbWFfaGVhcCAqaGVhcCwKIAltdXRleF9pbml0KCZidWZmZXItPmxvY2sp
OwogCWJ1ZmZlci0+aGVhcCA9IGhlYXA7CiAJYnVmZmVyLT5sZW4gPSBsZW47CisJYnVmZmVyLT51
bmNhY2hlZCA9IHVuY2FjaGVkOwogCiAJSU5JVF9MSVNUX0hFQUQoJnBhZ2VzKTsKIAlpID0gMDsK
QEAgLTM5Myw2ICs0MTgsMTggQEAgc3RhdGljIGludCBzeXN0ZW1faGVhcF9hbGxvY2F0ZShzdHJ1
Y3QgZG1hX2hlYXAgKmhlYXAsCiAJCS8qIGp1c3QgcmV0dXJuLCBhcyBwdXQgd2lsbCBjYWxsIHJl
bGVhc2UgYW5kIHRoYXQgd2lsbCBmcmVlICovCiAJCXJldHVybiByZXQ7CiAJfQorCisJLyoKKwkg
KiBGb3IgdW5jYWNoZWQgYnVmZmVycywgd2UgbmVlZCB0byBpbml0aWFsbHkgZmx1c2ggY3B1IGNh
Y2hlLCBzaW5jZQorCSAqIHRoZSBfX0dGUF9aRVJPIG9uIHRoZSBhbGxvY2F0aW9uIG1lYW5zIHRo
ZSB6ZXJvaW5nIHdhcyBkb25lIGJ5IHRoZQorCSAqIGNwdSBhbmQgdGh1cyBpdCBpcyBsaWtlbHkg
Y2FjaGVkLiBNYXAgKGFuZCBpbXBsaWNpdGx5IGZsdXNoKSBhbmQKKwkgKiB1bm1hcCBpdCBub3cg
c28gd2UgZG9uJ3QgZ2V0IGNvcnJ1cHRpb24gbGF0ZXIgb24uCisJICovCisJaWYgKGJ1ZmZlci0+
dW5jYWNoZWQpIHsKKwkJZG1hX21hcF9zZ3RhYmxlKGRtYV9oZWFwX2dldF9kZXYoaGVhcCksIHRh
YmxlLCBETUFfQklESVJFQ1RJT05BTCwgMCk7CisJCWRtYV91bm1hcF9zZ3RhYmxlKGRtYV9oZWFw
X2dldF9kZXYoaGVhcCksIHRhYmxlLCBETUFfQklESVJFQ1RJT05BTCwgMCk7CisJfQorCiAJcmV0
dXJuIHJldDsKIAogZnJlZV9wYWdlczoKQEAgLTQxMCwxMCArNDQ3LDQwIEBAIHN0YXRpYyBpbnQg
c3lzdGVtX2hlYXBfYWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAogCXJldHVybiByZXQ7
CiB9CiAKK3N0YXRpYyBpbnQgc3lzdGVtX2hlYXBfYWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpo
ZWFwLAorCQkJCXVuc2lnbmVkIGxvbmcgbGVuLAorCQkJCXVuc2lnbmVkIGxvbmcgZmRfZmxhZ3Ms
CisJCQkJdW5zaWduZWQgbG9uZyBoZWFwX2ZsYWdzKQoreworCXJldHVybiBzeXN0ZW1faGVhcF9k
b19hbGxvY2F0ZShoZWFwLCBsZW4sIGZkX2ZsYWdzLCBoZWFwX2ZsYWdzLCBmYWxzZSk7Cit9CisK
IHN0YXRpYyBjb25zdCBzdHJ1Y3QgZG1hX2hlYXBfb3BzIHN5c3RlbV9oZWFwX29wcyA9IHsKIAku
YWxsb2NhdGUgPSBzeXN0ZW1faGVhcF9hbGxvY2F0ZSwKIH07CiAKK3N0YXRpYyBpbnQgc3lzdGVt
X3VuY2FjaGVkX2hlYXBfYWxsb2NhdGUoc3RydWN0IGRtYV9oZWFwICpoZWFwLAorCQkJCQkgdW5z
aWduZWQgbG9uZyBsZW4sCisJCQkJCSB1bnNpZ25lZCBsb25nIGZkX2ZsYWdzLAorCQkJCQkgdW5z
aWduZWQgbG9uZyBoZWFwX2ZsYWdzKQoreworCXJldHVybiBzeXN0ZW1faGVhcF9kb19hbGxvY2F0
ZShoZWFwLCBsZW4sIGZkX2ZsYWdzLCBoZWFwX2ZsYWdzLCB0cnVlKTsKK30KKworLyogRHVtbXkg
ZnVuY3Rpb24gdG8gYmUgdXNlZCB1bnRpbCB3ZSBjYW4gY2FsbCBjb2VyY2VfbWFza19hbmRfY29o
ZXJlbnQgKi8KK3N0YXRpYyBpbnQgc3lzdGVtX3VuY2FjaGVkX2hlYXBfbm90X2luaXRpYWxpemVk
KHN0cnVjdCBkbWFfaGVhcCAqaGVhcCwKKwkJCQkJCXVuc2lnbmVkIGxvbmcgbGVuLAorCQkJCQkJ
dW5zaWduZWQgbG9uZyBmZF9mbGFncywKKwkJCQkJCXVuc2lnbmVkIGxvbmcgaGVhcF9mbGFncykK
K3sKKwlyZXR1cm4gLUVCVVNZOworfQorCitzdGF0aWMgc3RydWN0IGRtYV9oZWFwX29wcyBzeXN0
ZW1fdW5jYWNoZWRfaGVhcF9vcHMgPSB7CisJLyogQWZ0ZXIgc3lzdGVtX2hlYXBfY3JlYXRlIGlz
IGNvbXBsZXRlLCB3ZSB3aWxsIHN3YXAgdGhpcyAqLworCS5hbGxvY2F0ZSA9IHN5c3RlbV91bmNh
Y2hlZF9oZWFwX25vdF9pbml0aWFsaXplZCwKK307CisKIHN0YXRpYyBpbnQgc3lzdGVtX2hlYXBf
Y3JlYXRlKHZvaWQpCiB7CiAJc3RydWN0IGRtYV9oZWFwX2V4cG9ydF9pbmZvIGV4cF9pbmZvOwpA
QCAtNDI2LDYgKzQ5MywxOCBAQCBzdGF0aWMgaW50IHN5c3RlbV9oZWFwX2NyZWF0ZSh2b2lkKQog
CWlmIChJU19FUlIoc3lzX2hlYXApKQogCQlyZXR1cm4gUFRSX0VSUihzeXNfaGVhcCk7CiAKKwll
eHBfaW5mby5uYW1lID0gInN5c3RlbS11bmNhY2hlZCI7CisJZXhwX2luZm8ub3BzID0gJnN5c3Rl
bV91bmNhY2hlZF9oZWFwX29wczsKKwlleHBfaW5mby5wcml2ID0gTlVMTDsKKworCXN5c191bmNh
Y2hlZF9oZWFwID0gZG1hX2hlYXBfYWRkKCZleHBfaW5mbyk7CisJaWYgKElTX0VSUihzeXNfdW5j
YWNoZWRfaGVhcCkpCisJCXJldHVybiBQVFJfRVJSKHN5c191bmNhY2hlZF9oZWFwKTsKKworCWRt
YV9jb2VyY2VfbWFza19hbmRfY29oZXJlbnQoZG1hX2hlYXBfZ2V0X2RldihzeXNfdW5jYWNoZWRf
aGVhcCksIERNQV9CSVRfTUFTSyg2NCkpOworCW1iKCk7IC8qIG1ha2Ugc3VyZSB3ZSBvbmx5IHNl
dCBhbGxvY2F0ZSBhZnRlciBkbWFfbWFzayBpcyBzZXQgKi8KKwlzeXN0ZW1fdW5jYWNoZWRfaGVh
cF9vcHMuYWxsb2NhdGUgPSBzeXN0ZW1fdW5jYWNoZWRfaGVhcF9hbGxvY2F0ZTsKKwogCXJldHVy
biAwOwogfQogbW9kdWxlX2luaXQoc3lzdGVtX2hlYXBfY3JlYXRlKTsKLS0gCjIuMTcuMQoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVsIG1h
aWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVsCg==
