Return-Path: <dri-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+dri-devel@lfdr.de
Delivered-To: lists+dri-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 95E21524AF
	for <lists+dri-devel@lfdr.de>; Tue, 25 Jun 2019 09:29:53 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 629746E053;
	Tue, 25 Jun 2019 07:28:05 +0000 (UTC)
X-Original-To: dri-devel@lists.freedesktop.org
Delivered-To: dri-devel@lists.freedesktop.org
Received: from mail-wr1-x443.google.com (mail-wr1-x443.google.com
 [IPv6:2a00:1450:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 83E5E89DE5
 for <dri-devel@lists.freedesktop.org>; Mon, 24 Jun 2019 21:02:07 +0000 (UTC)
Received: by mail-wr1-x443.google.com with SMTP id r16so15343100wrl.11
 for <dri-devel@lists.freedesktop.org>; Mon, 24 Jun 2019 14:02:07 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=hG9eEbhO9ZvVI+JAJ4Kr5jKBUZBlX9y3IyF9CExVuM8=;
 b=h/5XsKSOc9G4jCAyyXS6uEnwO4/skn6DgHcdxTfc4+//j5NvJAhIegh+9DyU4oE2G5
 XMH7LLsIoEn4XCG/5MMFm8aWZLyPuMA3AqcG884+RLitGEZ/Ia7tIYJeYgJ2lvq4+82E
 mlaW9T0njIhNN8uWNxGdhpCnWE7lCd1ls2rwyUgqck2st+DX1/XZXT8Mgtc7FUg/MWS/
 wQI5yzuAnVjGh+DCtbUyUew6Doi4OLqH4ui96fop/jHnlRapWCfn8LV8yW7KRy2UUMDK
 cZ+I0VBGPFAp6KZ87/SvHLOPiy4KLRDOU6aEzGq0arbv/yxp6LYA2vMTEoAXkV4xMEfq
 +7zg==
X-Gm-Message-State: APjAAAUQL1OScjaTvUizvJ+6rTNIXFwjtQ7o6UewTwMIMUwylUVnX2HA
 Kz7Wmwf1sxvCeCTJmb2hA0xCKQ==
X-Google-Smtp-Source: APXvYqxAEk4qQsJeqyqINse+yHJkRouINtL91JL0sEIFqMM29cMWXWeCvzOgl6HwO/QEFlzvN+y93Q==
X-Received: by 2002:adf:f186:: with SMTP id h6mr21080937wro.274.1561410126128; 
 Mon, 24 Jun 2019 14:02:06 -0700 (PDT)
Received: from ziepe.ca ([66.187.232.66])
 by smtp.gmail.com with ESMTPSA id b71sm446129wmb.7.2019.06.24.14.02.02
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Mon, 24 Jun 2019 14:02:02 -0700 (PDT)
Received: from jgg by jggl.ziepe.ca with local (Exim 4.90_1)
 (envelope-from <jgg@ziepe.ca>)
 id 1hfW6C-0001M2-OO; Mon, 24 Jun 2019 18:02:00 -0300
From: Jason Gunthorpe <jgg@ziepe.ca>
To: Jerome Glisse <jglisse@redhat.com>, Ralph Campbell <rcampbell@nvidia.com>,
 John Hubbard <jhubbard@nvidia.com>, Felix.Kuehling@amd.com
Subject: [PATCH v4 hmm 01/12] mm/hmm: fix use after free with struct hmm in
 the mmu notifiers
Date: Mon, 24 Jun 2019 18:00:59 -0300
Message-Id: <20190624210110.5098-2-jgg@ziepe.ca>
X-Mailer: git-send-email 2.22.0
In-Reply-To: <20190624210110.5098-1-jgg@ziepe.ca>
References: <20190624210110.5098-1-jgg@ziepe.ca>
MIME-Version: 1.0
X-Mailman-Approved-At: Tue, 25 Jun 2019 07:27:07 +0000
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ziepe.ca; s=google;
 h=from:to:cc:subject:date:message-id:in-reply-to:references
 :mime-version:content-transfer-encoding;
 bh=hG9eEbhO9ZvVI+JAJ4Kr5jKBUZBlX9y3IyF9CExVuM8=;
 b=Dfnwj7SRwV2PMmn2U0d+WODdclNP+8MKrJJpQxHP3JU1uHDlj7Em+GRbnOVlGf37aZ
 x/iFL81waqsH2R/ZDnogOEsWqssPFpPx6ng2iVzd42Ph8pxRGkGdeHnQFn7WXHxychn7
 qhcCnDDKKA2XJlL0t9jgEmXK5iD+LSA9ISspJalIOTaGOUy2P3iEqUcWHAlRfr10A2Zi
 sVektpaLu8hOSGiRgUg+86mxYZntLzr5JZQnXIkn15UuhOjzFImdCeWJqoAaOquAmGLI
 hpzcweH8Q2CBVObvgPXPT94/km2oYbyVknkNINwL80SwNwAFFuHpdFRRunzkNVq5yivf
 2PaQ==
X-BeenThere: dri-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: Direct Rendering Infrastructure - Development
 <dri-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/dri-devel>
List-Post: <mailto:dri-devel@lists.freedesktop.org>
List-Help: <mailto:dri-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/dri-devel>,
 <mailto:dri-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Andrea Arcangeli <aarcange@redhat.com>, Philip Yang <Philip.Yang@amd.com>,
 linux-rdma@vger.kernel.org, amd-gfx@lists.freedesktop.org, linux-mm@kvack.org,
 Jason Gunthorpe <jgg@mellanox.com>, dri-devel@lists.freedesktop.org,
 Ira Weiny <ira.weiny@intel.com>, Christoph Hellwig <hch@lst.de>,
 Ben Skeggs <bskeggs@redhat.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: dri-devel-bounces@lists.freedesktop.org
Sender: "dri-devel" <dri-devel-bounces@lists.freedesktop.org>

RnJvbTogSmFzb24gR3VudGhvcnBlIDxqZ2dAbWVsbGFub3guY29tPgoKbW11X25vdGlmaWVyX3Vu
cmVnaXN0ZXJfbm9fcmVsZWFzZSgpIGlzIG5vdCBhIGZlbmNlIGFuZCB0aGUgbW11X25vdGlmaWVy
CnN5c3RlbSB3aWxsIGNvbnRpbnVlIHRvIHJlZmVyZW5jZSBobW0tPm1uIHVudGlsIHRoZSBzcmN1
IGdyYWNlIHBlcmlvZApleHBpcmVzLgoKUmVzdWx0aW5nIGluIHVzZSBhZnRlciBmcmVlIHJhY2Vz
IGxpa2UgdGhpczoKCiAgICAgICAgIENQVTAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgQ1BVMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IF9fbW11X25vdGlmaWVyX2ludmFsaWRhdGVfcmFuZ2Vfc3RhcnQoKQogICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjdV9yZWFkX2xvY2sKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsaXN0X2Zvcl9lYWNoICgp
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1u
ID09IGhtbS0+bW4KaG1tX21pcnJvcl91bnJlZ2lzdGVyKCkKICBobW1fcHV0KCkKICAgIGhtbV9m
cmVlKCkKICAgICAgbW11X25vdGlmaWVyX3VucmVnaXN0ZXJfbm9fcmVsZWFzZSgpCiAgICAgICAg
IGhsaXN0X2RlbF9pbml0X3JjdShobW0tbW4tPmxpc3QpCgkJCSAgICAgICAgICAgICAgICAgICAg
ICAgICAgIG1uLT5vcHMtPmludmFsaWRhdGVfcmFuZ2Vfc3RhcnQobW4sIHJhbmdlKTsKCQkJCQkg
ICAgICAgICAgICAgbW1fZ2V0X2htbSgpCiAgICAgIG1tLT5obW0gPSBOVUxMOwogICAgICBrZnJl
ZShobW0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgbXV0ZXhfbG9jaygmaG1tLT5sb2NrKTsKClVzZSBTUkNVIHRvIGtmcmVlIHRoZSBobW0gbWVt
b3J5IHNvIHRoYXQgdGhlIG5vdGlmaWVycyBjYW4gcmVseSBvbiBobW0KZXhpc3RpbmcuIEdldCB0
aGUgbm93LXNhZmUgaG1tIHN0cnVjdCB0aHJvdWdoIGNvbnRhaW5lcl9vZiBhbmQgZGlyZWN0bHkK
Y2hlY2sga3JlZl9nZXRfdW5sZXNzX3plcm8gdG8gbG9jayBpdCBhZ2FpbnN0IGZyZWUuCgpTaWdu
ZWQtb2ZmLWJ5OiBKYXNvbiBHdW50aG9ycGUgPGpnZ0BtZWxsYW5veC5jb20+ClJldmlld2VkLWJ5
OiBJcmEgV2VpbnkgPGlyYS53ZWlueUBpbnRlbC5jb20+ClJldmlld2VkLWJ5OiBKb2huIEh1YmJh
cmQgPGpodWJiYXJkQG52aWRpYS5jb20+ClJldmlld2VkLWJ5OiBSYWxwaCBDYW1wYmVsbCA8cmNh
bXBiZWxsQG52aWRpYS5jb20+ClJldmlld2VkLWJ5OiBDaHJpc3RvcGggSGVsbHdpZyA8aGNoQGxz
dC5kZT4KVGVzdGVkLWJ5OiBQaGlsaXAgWWFuZyA8UGhpbGlwLllhbmdAYW1kLmNvbT4KLS0tCnYy
OgotIFNwZWxsICdmcmVlJyBwcm9wZXJseSAoSmVyb21lL1JhbHBoKQp2MzoKLSBIYXZlIG9ubHkg
b25lIGNsZWFyZXIgY29tbWVudCBhYm91dCBrcmVmX2dldF91bmxlc3NfemVybyAoSm9obikKLS0t
CiBpbmNsdWRlL2xpbnV4L2htbS5oIHwgIDEgKwogbW0vaG1tLmMgICAgICAgICAgICB8IDIzICsr
KysrKysrKysrKysrKysrLS0tLS0tCiAyIGZpbGVzIGNoYW5nZWQsIDE4IGluc2VydGlvbnMoKyks
IDYgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9saW51eC9obW0uaCBiL2luY2x1
ZGUvbGludXgvaG1tLmgKaW5kZXggNzAwNzEyMzg0MmJhNzYuLmNiMDFjZjFmYTNjMDhiIDEwMDY0
NAotLS0gYS9pbmNsdWRlL2xpbnV4L2htbS5oCisrKyBiL2luY2x1ZGUvbGludXgvaG1tLmgKQEAg
LTkzLDYgKzkzLDcgQEAgc3RydWN0IGhtbSB7CiAJc3RydWN0IG1tdV9ub3RpZmllcgltbXVfbm90
aWZpZXI7CiAJc3RydWN0IHJ3X3NlbWFwaG9yZQltaXJyb3JzX3NlbTsKIAl3YWl0X3F1ZXVlX2hl
YWRfdAl3cTsKKwlzdHJ1Y3QgcmN1X2hlYWQJCXJjdTsKIAlsb25nCQkJbm90aWZpZXJzOwogCWJv
b2wJCQlkZWFkOwogfTsKZGlmZiAtLWdpdCBhL21tL2htbS5jIGIvbW0vaG1tLmMKaW5kZXggODI2
ODE2YWIyMzc3OTkuLmY2OTU2ZDc4ZTNjYjI1IDEwMDY0NAotLS0gYS9tbS9obW0uYworKysgYi9t
bS9obW0uYwpAQCAtMTA0LDYgKzEwNCwxMSBAQCBzdGF0aWMgc3RydWN0IGhtbSAqaG1tX2dldF9v
cl9jcmVhdGUoc3RydWN0IG1tX3N0cnVjdCAqbW0pCiAJcmV0dXJuIE5VTEw7CiB9CiAKK3N0YXRp
YyB2b2lkIGhtbV9mcmVlX3JjdShzdHJ1Y3QgcmN1X2hlYWQgKnJjdSkKK3sKKwlrZnJlZShjb250
YWluZXJfb2YocmN1LCBzdHJ1Y3QgaG1tLCByY3UpKTsKK30KKwogc3RhdGljIHZvaWQgaG1tX2Zy
ZWUoc3RydWN0IGtyZWYgKmtyZWYpCiB7CiAJc3RydWN0IGhtbSAqaG1tID0gY29udGFpbmVyX29m
KGtyZWYsIHN0cnVjdCBobW0sIGtyZWYpOwpAQCAtMTE2LDcgKzEyMSw3IEBAIHN0YXRpYyB2b2lk
IGhtbV9mcmVlKHN0cnVjdCBrcmVmICprcmVmKQogCQltbS0+aG1tID0gTlVMTDsKIAlzcGluX3Vu
bG9jaygmbW0tPnBhZ2VfdGFibGVfbG9jayk7CiAKLQlrZnJlZShobW0pOworCW1tdV9ub3RpZmll
cl9jYWxsX3NyY3UoJmhtbS0+cmN1LCBobW1fZnJlZV9yY3UpOwogfQogCiBzdGF0aWMgaW5saW5l
IHZvaWQgaG1tX3B1dChzdHJ1Y3QgaG1tICpobW0pCkBAIC0xNDQsMTAgKzE0OSwxNCBAQCB2b2lk
IGhtbV9tbV9kZXN0cm95KHN0cnVjdCBtbV9zdHJ1Y3QgKm1tKQogCiBzdGF0aWMgdm9pZCBobW1f
cmVsZWFzZShzdHJ1Y3QgbW11X25vdGlmaWVyICptbiwgc3RydWN0IG1tX3N0cnVjdCAqbW0pCiB7
Ci0Jc3RydWN0IGhtbSAqaG1tID0gbW1fZ2V0X2htbShtbSk7CisJc3RydWN0IGhtbSAqaG1tID0g
Y29udGFpbmVyX29mKG1uLCBzdHJ1Y3QgaG1tLCBtbXVfbm90aWZpZXIpOwogCXN0cnVjdCBobW1f
bWlycm9yICptaXJyb3I7CiAJc3RydWN0IGhtbV9yYW5nZSAqcmFuZ2U7CiAKKwkvKiBCYWlsIG91
dCBpZiBobW0gaXMgaW4gdGhlIHByb2Nlc3Mgb2YgYmVpbmcgZnJlZWQgKi8KKwlpZiAoIWtyZWZf
Z2V0X3VubGVzc196ZXJvKCZobW0tPmtyZWYpKQorCQlyZXR1cm47CisKIAkvKiBSZXBvcnQgdGhp
cyBITU0gYXMgZHlpbmcuICovCiAJaG1tLT5kZWFkID0gdHJ1ZTsKIApAQCAtMTg1LDEzICsxOTQs
MTQgQEAgc3RhdGljIHZvaWQgaG1tX3JlbGVhc2Uoc3RydWN0IG1tdV9ub3RpZmllciAqbW4sIHN0
cnVjdCBtbV9zdHJ1Y3QgKm1tKQogc3RhdGljIGludCBobW1faW52YWxpZGF0ZV9yYW5nZV9zdGFy
dChzdHJ1Y3QgbW11X25vdGlmaWVyICptbiwKIAkJCWNvbnN0IHN0cnVjdCBtbXVfbm90aWZpZXJf
cmFuZ2UgKm5yYW5nZSkKIHsKLQlzdHJ1Y3QgaG1tICpobW0gPSBtbV9nZXRfaG1tKG5yYW5nZS0+
bW0pOworCXN0cnVjdCBobW0gKmhtbSA9IGNvbnRhaW5lcl9vZihtbiwgc3RydWN0IGhtbSwgbW11
X25vdGlmaWVyKTsKIAlzdHJ1Y3QgaG1tX21pcnJvciAqbWlycm9yOwogCXN0cnVjdCBobW1fdXBk
YXRlIHVwZGF0ZTsKIAlzdHJ1Y3QgaG1tX3JhbmdlICpyYW5nZTsKIAlpbnQgcmV0ID0gMDsKIAot
CVZNX0JVR19PTighaG1tKTsKKwlpZiAoIWtyZWZfZ2V0X3VubGVzc196ZXJvKCZobW0tPmtyZWYp
KQorCQlyZXR1cm4gMDsKIAogCXVwZGF0ZS5zdGFydCA9IG5yYW5nZS0+c3RhcnQ7CiAJdXBkYXRl
LmVuZCA9IG5yYW5nZS0+ZW5kOwpAQCAtMjM2LDkgKzI0NiwxMCBAQCBzdGF0aWMgaW50IGhtbV9p
bnZhbGlkYXRlX3JhbmdlX3N0YXJ0KHN0cnVjdCBtbXVfbm90aWZpZXIgKm1uLAogc3RhdGljIHZv
aWQgaG1tX2ludmFsaWRhdGVfcmFuZ2VfZW5kKHN0cnVjdCBtbXVfbm90aWZpZXIgKm1uLAogCQkJ
Y29uc3Qgc3RydWN0IG1tdV9ub3RpZmllcl9yYW5nZSAqbnJhbmdlKQogewotCXN0cnVjdCBobW0g
KmhtbSA9IG1tX2dldF9obW0obnJhbmdlLT5tbSk7CisJc3RydWN0IGhtbSAqaG1tID0gY29udGFp
bmVyX29mKG1uLCBzdHJ1Y3QgaG1tLCBtbXVfbm90aWZpZXIpOwogCi0JVk1fQlVHX09OKCFobW0p
OworCWlmICgha3JlZl9nZXRfdW5sZXNzX3plcm8oJmhtbS0+a3JlZikpCisJCXJldHVybjsKIAog
CW11dGV4X2xvY2soJmhtbS0+bG9jayk7CiAJaG1tLT5ub3RpZmllcnMtLTsKLS0gCjIuMjIuMAoK
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KZHJpLWRldmVs
IG1haWxpbmcgbGlzdApkcmktZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlz
dHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vZHJpLWRldmVs
